import "./chunk-ZS7NZCD4.js";

// node_modules/grapesjs/dist/grapes.mjs
var __webpack_modules__ = {
  /***/
  982: (
    /***/
    (module, exports, __webpack_require__2) => {
      var __WEBPACK_AMD_DEFINE_FACTORY__, __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;
      (function(factory) {
        if (true) {
          !(__WEBPACK_AMD_DEFINE_ARRAY__ = [__webpack_require__2(523), __webpack_require__2(391)], __WEBPACK_AMD_DEFINE_FACTORY__ = factory, __WEBPACK_AMD_DEFINE_RESULT__ = typeof __WEBPACK_AMD_DEFINE_FACTORY__ === "function" ? __WEBPACK_AMD_DEFINE_FACTORY__.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__) : __WEBPACK_AMD_DEFINE_FACTORY__, __WEBPACK_AMD_DEFINE_RESULT__ !== void 0 && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));
        } else {
        }
      })(function(_, Backbone) {
        var core_slice = Array.prototype.slice;
        function apply(fn, ctx, args) {
          return args.length <= 4 ? fn.call(ctx, args[0], args[1], args[2], args[3]) : fn.apply(ctx, args);
        }
        function slice(arr, index2) {
          return core_slice.call(arr, index2);
        }
        function hasKeys(obj, keys) {
          if (obj == null)
            return false;
          if (!_.isArray(keys)) {
            keys = slice(arguments, 1);
          }
          return _.all(keys, function(key) {
            return key in obj;
          });
        }
        var getMagicFusionIndex = /* @__PURE__ */ function() {
          var callstackWasIndexed = false, magicFusionIndex = -1;
          function indexCycle() {
            magicFusionIndex++;
            callstackWasIndexed = true;
            _.defer(function() {
              callstackWasIndexed = false;
            });
          }
          return function() {
            if (!callstackWasIndexed) {
              indexCycle();
            }
            return magicFusionIndex;
          };
        }();
        function ObjectRegistry() {
          this.registeredObjects = [];
          this.cidIndexes = [];
        }
        ObjectRegistry.prototype = {
          /**
           * Returns whether the object is already registered in this ObjectRegistry or not.
           * 
           * @this 	{ObjectRegistry}
           * @param  	{Object} 		 obj 	The object to check
           * @return 	{Boolean} True if the object is already registered
           */
          isRegistered: function(obj) {
            return obj && obj.cid ? this.registeredObjects[obj.cid] : _.contains(this.registeredObjects, obj);
          },
          /**
           * Registers an object in this ObjectRegistry.
           * 
           * @this 	{ObjectRegistry}
           * @param  	{Object} 		 obj 	The object to register
           * @return 	{undefined}
           */
          register: function(obj) {
            if (!this.isRegistered(obj)) {
              if (obj && obj.cid) {
                this.registeredObjects[obj.cid] = obj;
                this.cidIndexes.push(obj.cid);
              } else {
                this.registeredObjects.push(obj);
              }
              return true;
            }
            return false;
          },
          /**
           * Unregisters an object from this ObjectRegistry.
           * 
           * @this {ObjectRegistry}
           * @param  {Object} obj The object to unregister
           * @return {undefined}
           */
          unregister: function(obj) {
            if (this.isRegistered(obj)) {
              if (obj && obj.cid) {
                delete this.registeredObjects[obj.cid];
                this.cidIndexes.splice(_.indexOf(this.cidIndexes, obj.cid), 1);
              } else {
                var i = _.indexOf(this.registeredObjects, obj);
                this.registeredObjects.splice(i, 1);
              }
              return true;
            }
            return false;
          },
          /**
           * Returns an array of all objects that are currently in this ObjectRegistry.
           * 
           * @return {Array} An array of all the objects which are currently in the ObjectRegistry
           */
          get: function() {
            return _.map(this.cidIndexes, function(cid) {
              return this.registeredObjects[cid];
            }, this).concat(this.registeredObjects);
          }
        };
        function onoff(which, objects, fn, ctx) {
          for (var i = 0, l = objects.length, obj; i < l; i++) {
            obj = objects[i];
            if (!obj)
              continue;
            if (which === "on") {
              if (!ctx.objectRegistry.register(obj)) {
                continue;
              }
            } else {
              if (!ctx.objectRegistry.unregister(obj)) {
                continue;
              }
            }
            if (_.isFunction(obj[which])) {
              obj[which]("all", fn, ctx);
            }
          }
        }
        function actionUndoRedo(which, action) {
          var type2 = action.type, undoTypes = action.undoTypes, fn = !undoTypes[type2] || undoTypes[type2][which];
          if (_.isFunction(fn)) {
            fn(action.object, action.before, action.after, action.options);
          }
        }
        function managerUndoRedo(which, manager, stack, magic, everything) {
          if (stack.isCurrentlyUndoRedoing || which === "undo" && stack.pointer === -1 || which === "redo" && stack.pointer === stack.length - 1) {
            return;
          }
          stack.isCurrentlyUndoRedoing = true;
          var action, actions, isUndo = which === "undo";
          if (everything) {
            actions = isUndo && stack.pointer === stack.length - 1 || // If at the stack's end calling undo
            !isUndo && stack.pointer === -1 ? (
              // or at the stack's beginning calling redo
              _.clone(stack.models)
            ) : (
              // => Take all the models. Otherwise:
              core_slice.apply(stack.models, isUndo ? [0, stack.pointer] : [stack.pointer, stack.length - 1])
            );
          } else {
            action = stack.at(isUndo ? stack.pointer : stack.pointer + 1);
            actions = magic ? stack.where({ "magicFusionIndex": action.get("magicFusionIndex") }) : [action];
          }
          stack.pointer += (isUndo ? -1 : 1) * actions.length;
          while (action = isUndo ? actions.pop() : actions.shift()) {
            action[which]();
          }
          stack.isCurrentlyUndoRedoing = false;
          manager.trigger(which, manager);
        }
        function validateUndoActionCreation(undoTypesType, args) {
          var condition = undoTypesType.condition, type2 = typeof condition;
          return type2 === "function" ? !!apply(condition, undoTypesType, args) : type2 === "boolean" ? condition : true;
        }
        function addToStack(stack, type2, args, undoTypes) {
          if (stack.track && !stack.isCurrentlyUndoRedoing && type2 in undoTypes && validateUndoActionCreation(undoTypes[type2], args)) {
            var res = apply(undoTypes[type2]["on"], undoTypes[type2], args), diff;
            if (hasKeys(res, "object", "before", "after")) {
              res.type = type2;
              res.magicFusionIndex = getMagicFusionIndex();
              res.undoTypes = undoTypes;
              if (stack.pointer < stack.length - 1) {
                var diff = stack.length - stack.pointer - 1;
                while (diff--) {
                  stack.pop();
                }
              }
              stack.pointer = stack.length;
              stack.add(res);
              if (stack.length > stack.maximumStackLength) {
                stack.shift();
                stack.pointer--;
              }
            }
          }
        }
        var UndoTypes = {
          "add": {
            "undo": function(collection, ignore, model, options) {
              collection.remove(model, options);
            },
            "redo": function(collection, ignore, model, options) {
              if (options.index) {
                options.at = options.index;
              }
              collection.add(model, options);
            },
            "on": function(model, collection, options) {
              return {
                object: collection,
                before: void 0,
                after: model,
                options: _.clone(options)
              };
            }
          },
          "remove": {
            "undo": function(collection, model, ignore, options) {
              if ("index" in options) {
                options.at = options.index;
              }
              collection.add(model, options);
            },
            "redo": function(collection, model, ignore, options) {
              collection.remove(model, options);
            },
            "on": function(model, collection, options) {
              return {
                object: collection,
                before: model,
                after: void 0,
                options: _.clone(options)
              };
            }
          },
          "change": {
            "undo": function(model, before, after, options) {
              if (_.isEmpty(before)) {
                _.each(_.keys(after), model.unset, model);
              } else {
                model.set(before);
                if (options && options.unsetData && options.unsetData.before && options.unsetData.before.length) {
                  _.each(options.unsetData.before, model.unset, model);
                }
              }
            },
            "redo": function(model, before, after, options) {
              if (_.isEmpty(after)) {
                _.each(_.keys(before), model.unset, model);
              } else {
                model.set(after);
                if (options && options.unsetData && options.unsetData.after && options.unsetData.after.length) {
                  _.each(options.unsetData.after, model.unset, model);
                }
              }
            },
            "on": function(model, options) {
              var afterAttributes = model.changedAttributes(), keysAfter = _.keys(afterAttributes), previousAttributes = _.pick(model.previousAttributes(), keysAfter), keysPrevious = _.keys(previousAttributes), unsetData = (options || (options = {})).unsetData = {
                after: [],
                before: []
              };
              if (keysAfter.length != keysPrevious.length) {
                if (keysAfter.length > keysPrevious.length) {
                  _.each(keysAfter, function(val) {
                    if (!(val in previousAttributes)) {
                      unsetData.before.push(val);
                    }
                  }, this);
                } else {
                  _.each(keysPrevious, function(val) {
                    if (!(val in afterAttributes)) {
                      unsetData.after.push(val);
                    }
                  });
                }
              }
              return {
                object: model,
                before: previousAttributes,
                after: afterAttributes,
                options: _.clone(options)
              };
            }
          },
          "reset": {
            "undo": function(collection, before, after) {
              collection.reset(before);
            },
            "redo": function(collection, before, after) {
              collection.reset(after);
            },
            "on": function(collection, options) {
              return {
                object: collection,
                before: options.previousModels,
                after: _.clone(collection.models)
              };
            }
          }
        };
        function OwnedUndoTypes() {
        }
        OwnedUndoTypes.prototype = UndoTypes;
        function manipulateUndoType(manipType, undoType, fns, undoTypesInstance) {
          if (typeof undoType === "object") {
            return _.each(undoType, function(val, key) {
              if (manipType === 2) {
                manipulateUndoType(manipType, val, fns, undoTypesInstance);
              } else {
                manipulateUndoType(manipType, key, val, fns);
              }
            });
          }
          switch (manipType) {
            case 0:
              if (hasKeys(fns, "undo", "redo", "on") && _.all(_.pick(fns, "undo", "redo", "on"), _.isFunction)) {
                undoTypesInstance[undoType] = fns;
              }
              break;
            case 1:
              if (undoTypesInstance[undoType] && _.isObject(fns)) {
                undoTypesInstance[undoType] = _.extend({}, undoTypesInstance[undoType], fns);
              }
              break;
            case 2:
              delete undoTypesInstance[undoType];
              break;
          }
          return this;
        }
        var Action = Backbone.Model.extend({
          defaults: {
            type: null,
            // "add", "change", "reset", etc.
            object: null,
            // The object on which the action occurred
            before: null,
            // The previous values which were changed with this action
            after: null,
            // The values after this action
            magicFusionIndex: null
            // The magicFusionIndex helps to combine 
            // all actions that occurred "at the same time" to undo/redo them altogether
          },
          /**
           * Undoes this action.
           * @param  {OwnedUndoTypes|UndoTypes} undoTypes The undoTypes object which contains the "undo"-handler that should be used
           * @return {undefined}
           */
          undo: function(undoTypes) {
            actionUndoRedo("undo", this.attributes);
          },
          /**
           * Redoes this action.
           * @param  {OwnedUndoTypes|UndoTypes} undoTypes The undoTypes object which contains the "redo"-handler that should be used
           * @return {undefined}
           */
          redo: function(undoTypes) {
            actionUndoRedo("redo", this.attributes);
          }
        }), UndoStack = Backbone.Collection.extend({
          model: Action,
          pointer: -1,
          // The pointer indicates the index where we are located within the stack. We start at -1
          track: false,
          isCurrentlyUndoRedoing: false,
          maximumStackLength: Infinity,
          setMaxLength: function(val) {
            this.maximumStackLength = val;
          }
        }), UndoManager = Backbone.Model.extend({
          defaults: {
            maximumStackLength: Infinity,
            track: false
          },
          /**
           * The constructor function.
           * @param  {attr} 		[attr] Object with parameters. The available parameters are:
           *                         	   - maximumStackLength {number} 	Set the undo-stack's maximum size
           *                             - track 				{boolean}	Start tracking changes right away
           * @return {undefined}
           */
          initialize: function(attr) {
            this.stack = new UndoStack();
            this.objectRegistry = new ObjectRegistry();
            this.undoTypes = new OwnedUndoTypes();
            this.stack.setMaxLength(this.get("maximumStackLength"));
            this.on("change:maximumStackLength", function(model, value) {
              this.stack.setMaxLength(value);
            }, this);
            if (attr && attr.track) {
              this.startTracking();
            }
            if (attr && attr.register) {
              if (_.isArray(attr.register) || _.isArguments(attr.register)) {
                apply(this.register, this, attr.register);
              } else {
                this.register(attr.register);
              }
            }
          },
          /**
           * Starts tracking. Changes of registered objects won't be processed until you've called this function
           * @return {undefined}
           */
          startTracking: function() {
            this.set("track", true);
            this.stack.track = true;
          },
          /**
           * Stops tracking. Afterwards changes of registered objects won't be processed.
           * @return {undefined}
           */
          stopTracking: function() {
            this.set("track", false);
            this.stack.track = false;
          },
          /**
           * Return the state of the tracking
           * @return {boolean}
           */
          isTracking: function() {
            return this.get("track");
          },
          /**
           * This is the "all"-handler which is bound to registered 
           * objects. It creates an UndoAction from the event and adds 
           * it to the stack.
           * 
           * @param  {String} 	type 	The event type
           * @return {undefined}
           */
          _addToStack: function(type2) {
            addToStack(this.stack, type2, slice(arguments, 1), this.undoTypes);
          },
          /**
           * Registers one or more objects to track their changes.
           * @param {...Object} 	obj 	The object or objects of which changes should be tracked
           * @return {undefined}
           */
          register: function() {
            onoff("on", arguments, this._addToStack, this);
          },
          /**
           * Unregisters one or more objects.
           * @param {...Object} 	obj 	The object or objects of which changes shouldn't be tracked any longer
           * @return {undefined}
           */
          unregister: function() {
            onoff("off", arguments, this._addToStack, this);
          },
          /**
           * Unregisters all previously registered objects.
           * @return {undefined}
           */
          unregisterAll: function() {
            apply(this.unregister, this, this.objectRegistry.get());
          },
          /**
           * Undoes the last action or the last set of actions in case 'magic' is true.
           * @param {Boolean} 	[magic] 	If true, all actions that happened basically at the same time are undone together
           * @return {undefined}
           */
          undo: function(magic) {
            managerUndoRedo("undo", this, this.stack, magic);
          },
          /**
           * Undoes all actions ever tracked by the undo manager
           * @return {undefined}
           */
          undoAll: function() {
            managerUndoRedo("undo", this, this.stack, false, true);
          },
          /**
           * Redoes a previously undone action or a set of actions.
           * @param {Boolean} 	[magic] 	If true, all actions that happened basically at the same time are redone together
           * @return {undefined}
           */
          redo: function(magic) {
            managerUndoRedo("redo", this, this.stack, magic);
          },
          /**
           * Redoes all actions ever tracked by the undo manager
           * @return {undefined}
           */
          redoAll: function() {
            managerUndoRedo("redo", this, this.stack, false, true);
          },
          /**
           * Checks if there's an action in the stack that can be undone / redone
           * @param  {String} 	type 	Either "undo" or "redo"
           * @return {Boolean} True if there is a set of actions which can be undone / redone
           */
          isAvailable: function(type2) {
            var s = this.stack, l = s.length;
            switch (type2) {
              case "undo":
                return l > 0 && s.pointer > -1;
              case "redo":
                return l > 0 && s.pointer < l - 1;
              default:
                return false;
            }
          },
          /**
           * Sets the stack-reference to the stack of another undoManager.
           * @param  {UndoManager} 	undoManager 	The undoManager whose stack-reference is set to this stack
           * @return {undefined}
           */
          merge: function(undoManager) {
            var args = _.isArray(undoManager) ? undoManager : slice(arguments), manager;
            while (manager = args.pop()) {
              if (manager instanceof UndoManager && manager.stack instanceof UndoStack) {
                manager.stack = this.stack;
              }
            }
          },
          /**
           * Add an UndoType to this specific UndoManager-instance.
           * @param {String} type The event this UndoType is made for
           * @param {Object} fns  An object of functions that are called to generate the data for an UndoAction or to process it. Must have the properties "undo", "redo" and "on". Can have the property "condition".
           * @return {undefined}
           */
          addUndoType: function(type2, fns) {
            manipulateUndoType(0, type2, fns, this.undoTypes);
          },
          /**
           * Overwrite properties of an existing UndoType for this specific UndoManager-instance.
           * @param  {String} type The event the UndoType is made for
           * @param  {Object} fns  An object of functions that are called to generate the data for an UndoAction or to process it. It extends the existing object.
           * @return {undefined}
           */
          changeUndoType: function(type2, fns) {
            manipulateUndoType(1, type2, fns, this.undoTypes);
          },
          /**
           * Remove one or more UndoTypes of this specific UndoManager-instance to fall back to the global UndoTypes.
           * @param  {String|Array} type The event the UndoType that should be removed is made for. You can also pass an array of events.
           * @return {undefined}
           */
          removeUndoType: function(type2) {
            manipulateUndoType(2, type2, void 0, this.undoTypes);
          },
          /**
           * Removes all actions from the stack.
           * @return {undefined}
           */
          clear: function() {
            this.stack.reset();
            this.stack.pointer = -1;
          }
        });
        _.extend(UndoManager, {
          /**
           * Change the UndoManager's default attributes
           * @param  {Object} defaultAttributes An object with the new default values.
           * @return {undefined}
           */
          defaults: function(defaultAttributes) {
            _.extend(UndoManager.prototype.defaults, defaultAttributes);
          },
          /**
           * Add an UndoType to the global UndoTypes-object.
           * @param  {String} type The event this UndoType is made for
           * @param  {Object} fns  An object of functions that are called to generate the data for an UndoAction or to process it. Must have the properties "undo", "redo" and "on". Can have the property "condition".
           * @return {undefined}
           */
          "addUndoType": function(type2, fns) {
            manipulateUndoType(0, type2, fns, UndoTypes);
          },
          /**
           * Overwrite properties of an existing UndoType in the global UndoTypes-object.
           * @param  {String} type The event the UndoType is made for
           * @param  {Object} fns  An object of functions that are called to generate the data for an UndoAction or to process it. It extends the existing object.
           * @return {undefined}
           */
          "changeUndoType": function(type2, fns) {
            manipulateUndoType(1, type2, fns, UndoTypes);
          },
          /**
           * Remove one or more UndoTypes of this specific UndoManager-instance to fall back to the global UndoTypes.
           * @param  {String|Array} type The event the UndoType that should be removed is made for. You can also pass an array of events.
           * @return {undefined}
           */
          "removeUndoType": function(type2) {
            manipulateUndoType(2, type2, void 0, UndoTypes);
          }
        });
        return Backbone.UndoManager = UndoManager;
      });
    }
  ),
  /***/
  391: (
    /***/
    (module, exports, __webpack_require__2) => {
      var __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;
      (function(factory) {
        var root = typeof self == "object" && self.self === self && self || typeof __webpack_require__2.g == "object" && __webpack_require__2.g.global === __webpack_require__2.g && __webpack_require__2.g;
        if (true) {
          !(__WEBPACK_AMD_DEFINE_ARRAY__ = [__webpack_require__2(523), __webpack_require__2(694), exports], __WEBPACK_AMD_DEFINE_RESULT__ = (function(_2, $2, exports2) {
            root.Backbone = factory(root, exports2, _2, $2);
          }).apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== void 0 && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));
        } else {
          var _, $;
        }
      })(function(root, Backbone, _, $) {
        var previousBackbone = root.Backbone;
        var slice = Array.prototype.slice;
        Backbone.VERSION = "1.4.1";
        Backbone.$ = $;
        Backbone.noConflict = function() {
          root.Backbone = previousBackbone;
          return this;
        };
        Backbone.emulateHTTP = false;
        Backbone.emulateJSON = false;
        var Events = Backbone.Events = {};
        var eventSplitter = /\s+/;
        var _listening;
        var eventsApi = function(iteratee, events2, name, callback, opts) {
          var i = 0, names;
          if (name && typeof name === "object") {
            if (callback !== void 0 && "context" in opts && opts.context === void 0)
              opts.context = callback;
            for (names = _.keys(name); i < names.length; i++) {
              events2 = eventsApi(iteratee, events2, names[i], name[names[i]], opts);
            }
          } else if (name && eventSplitter.test(name)) {
            for (names = name.split(eventSplitter); i < names.length; i++) {
              events2 = iteratee(events2, names[i], callback, opts);
            }
          } else {
            events2 = iteratee(events2, name, callback, opts);
          }
          return events2;
        };
        Events.on = function(name, callback, context) {
          this._events = eventsApi(onApi, this._events || {}, name, callback, {
            context,
            ctx: this,
            listening: _listening
          });
          if (_listening) {
            var listeners = this._listeners || (this._listeners = {});
            listeners[_listening.id] = _listening;
            _listening.interop = false;
          }
          return this;
        };
        Events.listenTo = function(obj, name, callback) {
          if (!obj)
            return this;
          var id = obj._listenId || (obj._listenId = _.uniqueId("l"));
          var listeningTo = this._listeningTo || (this._listeningTo = {});
          var listening = _listening = listeningTo[id];
          if (!listening) {
            this._listenId || (this._listenId = _.uniqueId("l"));
            listening = _listening = listeningTo[id] = new Listening(this, obj);
          }
          var error = tryCatchOn(obj, name, callback, this);
          _listening = void 0;
          if (error)
            throw error;
          if (listening.interop)
            listening.on(name, callback);
          return this;
        };
        var onApi = function(events2, name, callback, options) {
          if (callback) {
            var handlers = events2[name] || (events2[name] = []);
            var context = options.context, ctx = options.ctx, listening = options.listening;
            if (listening)
              listening.count++;
            handlers.push({ callback, context, ctx: context || ctx, listening });
          }
          return events2;
        };
        var tryCatchOn = function(obj, name, callback, context) {
          try {
            obj.on(name, callback, context);
          } catch (e) {
            return e;
          }
        };
        Events.off = function(name, callback, context) {
          if (!this._events)
            return this;
          this._events = eventsApi(offApi, this._events, name, callback, {
            context,
            listeners: this._listeners
          });
          return this;
        };
        Events.stopListening = function(obj, name, callback) {
          var listeningTo = this._listeningTo;
          if (!listeningTo)
            return this;
          var ids = obj ? [obj._listenId] : _.keys(listeningTo);
          for (var i = 0; i < ids.length; i++) {
            var listening = listeningTo[ids[i]];
            if (!listening)
              break;
            listening.obj.off(name, callback, this);
            if (listening.interop)
              listening.off(name, callback);
          }
          if (_.isEmpty(listeningTo))
            this._listeningTo = void 0;
          return this;
        };
        var offApi = function(events2, name, callback, options) {
          if (!events2)
            return;
          var context = options.context, listeners = options.listeners;
          var i = 0, names;
          if (!name && !context && !callback) {
            for (names = _.keys(listeners); i < names.length; i++) {
              listeners[names[i]].cleanup();
            }
            return;
          }
          names = name ? [name] : _.keys(events2);
          for (; i < names.length; i++) {
            name = names[i];
            var handlers = events2[name];
            if (!handlers)
              break;
            var remaining = [];
            for (var j = 0; j < handlers.length; j++) {
              var handler = handlers[j];
              if (callback && callback !== handler.callback && callback !== handler.callback._callback || context && context !== handler.context) {
                remaining.push(handler);
              } else {
                var listening = handler.listening;
                if (listening)
                  listening.off(name, callback);
              }
            }
            if (remaining.length) {
              events2[name] = remaining;
            } else {
              delete events2[name];
            }
          }
          return events2;
        };
        Events.once = function(name, callback, context) {
          var events2 = eventsApi(onceMap, {}, name, callback, this.off.bind(this));
          if (typeof name === "string" && context == null)
            callback = void 0;
          return this.on(events2, callback, context);
        };
        Events.listenToOnce = function(obj, name, callback) {
          var events2 = eventsApi(onceMap, {}, name, callback, this.stopListening.bind(this, obj));
          return this.listenTo(obj, events2);
        };
        var onceMap = function(map, name, callback, offer) {
          if (callback) {
            var once = map[name] = _.once(function() {
              offer(name, once);
              callback.apply(this, arguments);
            });
            once._callback = callback;
          }
          return map;
        };
        Events.trigger = function(name) {
          if (!this._events)
            return this;
          var length = Math.max(0, arguments.length - 1);
          var args = Array(length);
          for (var i = 0; i < length; i++)
            args[i] = arguments[i + 1];
          eventsApi(triggerApi, this._events, name, void 0, args);
          return this;
        };
        var triggerApi = function(objEvents, name, callback, args) {
          if (objEvents) {
            var events2 = objEvents[name];
            var allEvents = objEvents.all;
            if (events2 && allEvents)
              allEvents = allEvents.slice();
            if (events2)
              triggerEvents(events2, args);
            if (allEvents)
              triggerEvents(allEvents, [name].concat(args));
          }
          return objEvents;
        };
        var triggerEvents = function(events2, args) {
          var ev, i = -1, l = events2.length, a1 = args[0], a2 = args[1], a3 = args[2];
          switch (args.length) {
            case 0:
              while (++i < l)
                (ev = events2[i]).callback.call(ev.ctx);
              return;
            case 1:
              while (++i < l)
                (ev = events2[i]).callback.call(ev.ctx, a1);
              return;
            case 2:
              while (++i < l)
                (ev = events2[i]).callback.call(ev.ctx, a1, a2);
              return;
            case 3:
              while (++i < l)
                (ev = events2[i]).callback.call(ev.ctx, a1, a2, a3);
              return;
            default:
              while (++i < l)
                (ev = events2[i]).callback.apply(ev.ctx, args);
              return;
          }
        };
        var Listening = function(listener, obj) {
          this.id = listener._listenId;
          this.listener = listener;
          this.obj = obj;
          this.interop = true;
          this.count = 0;
          this._events = void 0;
        };
        Listening.prototype.on = Events.on;
        Listening.prototype.off = function(name, callback) {
          var cleanup;
          if (this.interop) {
            this._events = eventsApi(offApi, this._events, name, callback, {
              context: void 0,
              listeners: void 0
            });
            cleanup = !this._events;
          } else {
            this.count--;
            cleanup = this.count === 0;
          }
          if (cleanup)
            this.cleanup();
        };
        Listening.prototype.cleanup = function() {
          delete this.listener._listeningTo[this.obj._listenId];
          if (!this.interop)
            delete this.obj._listeners[this.id];
        };
        Events.bind = Events.on;
        Events.unbind = Events.off;
        _.extend(Backbone, Events);
        var Model = Backbone.Model = function(attributes, options) {
          var attrs = attributes || {};
          options || (options = {});
          this.preinitialize.apply(this, arguments);
          this.cid = _.uniqueId(this.cidPrefix);
          this.attributes = {};
          if (options.collection)
            this.collection = options.collection;
          if (options.parse)
            attrs = this.parse(attrs, options) || {};
          var defaults = _.result(this, "defaults");
          attrs = _.defaults(_.extend({}, defaults, attrs), defaults);
          this.set(attrs, options);
          this.changed = {};
          this.initialize.apply(this, arguments);
        };
        _.extend(Model.prototype, Events, {
          // A hash of attributes whose current and previous value differ.
          changed: null,
          // The value returned during the last failed validation.
          validationError: null,
          // The default name for the JSON `id` attribute is `"id"`. MongoDB and
          // CouchDB users may want to set this to `"_id"`.
          idAttribute: "id",
          // The prefix is used to create the client id which is used to identify models locally.
          // You may want to override this if you're experiencing name clashes with model ids.
          cidPrefix: "c",
          // preinitialize is an empty function by default. You can override it with a function
          // or object.  preinitialize will run before any instantiation logic is run in the Model.
          preinitialize: function() {
          },
          // Initialize is an empty function by default. Override it with your own
          // initialization logic.
          initialize: function() {
          },
          // Return a copy of the model's `attributes` object.
          toJSON: function(options) {
            return _.clone(this.attributes);
          },
          // Proxy `Backbone.sync` by default -- but override this if you need
          // custom syncing semantics for *this* particular model.
          sync: function() {
            return Backbone.sync.apply(this, arguments);
          },
          // Get the value of an attribute.
          get: function(attr) {
            return this.attributes[attr];
          },
          // Get the HTML-escaped value of an attribute.
          escape: function(attr) {
            return _.escape(this.get(attr));
          },
          // Returns `true` if the attribute contains a value that is not null
          // or undefined.
          has: function(attr) {
            return this.get(attr) != null;
          },
          // Special-cased proxy to underscore's `_.matches` method.
          matches: function(attrs) {
            return !!_.iteratee(attrs, this)(this.attributes);
          },
          // Set a hash of model attributes on the object, firing `"change"`. This is
          // the core primitive operation of a model, updating the data and notifying
          // anyone who needs to know about the change in state. The heart of the beast.
          set: function(key, val, options) {
            if (key == null)
              return this;
            var attrs;
            if (typeof key === "object") {
              attrs = key;
              options = val;
            } else {
              (attrs = {})[key] = val;
            }
            options || (options = {});
            if (!this._validate(attrs, options))
              return false;
            var unset = options.unset;
            var silent = options.silent;
            var changes = [];
            var changing = this._changing;
            this._changing = true;
            if (!changing) {
              this._previousAttributes = _.clone(this.attributes);
              this.changed = {};
            }
            var current = this.attributes;
            var changed = this.changed;
            var prev = this._previousAttributes;
            for (var attr in attrs) {
              val = attrs[attr];
              if (!_.isEqual(current[attr], val))
                changes.push(attr);
              if (!_.isEqual(prev[attr], val)) {
                changed[attr] = val;
              } else {
                delete changed[attr];
              }
              unset ? delete current[attr] : current[attr] = val;
            }
            if (this.idAttribute in attrs) {
              var prevId = this.id;
              this.id = this.get(this.idAttribute);
              this.trigger("changeId", this, prevId, options);
            }
            if (!silent) {
              if (changes.length)
                this._pending = options;
              for (var i = 0; i < changes.length; i++) {
                this.trigger("change:" + changes[i], this, current[changes[i]], options);
              }
            }
            if (changing)
              return this;
            if (!silent) {
              while (this._pending) {
                options = this._pending;
                this._pending = false;
                this.trigger("change", this, options);
              }
            }
            this._pending = false;
            this._changing = false;
            return this;
          },
          // Remove an attribute from the model, firing `"change"`. `unset` is a noop
          // if the attribute doesn't exist.
          unset: function(attr, options) {
            return this.set(attr, void 0, _.extend({}, options, { unset: true }));
          },
          // Clear all attributes on the model, firing `"change"`.
          clear: function(options) {
            var attrs = {};
            for (var key in this.attributes)
              attrs[key] = void 0;
            return this.set(attrs, _.extend({}, options, { unset: true }));
          },
          // Determine if the model has changed since the last `"change"` event.
          // If you specify an attribute name, determine if that attribute has changed.
          hasChanged: function(attr) {
            if (attr == null)
              return !_.isEmpty(this.changed);
            return _.has(this.changed, attr);
          },
          // Return an object containing all the attributes that have changed, or
          // false if there are no changed attributes. Useful for determining what
          // parts of a view need to be updated and/or what attributes need to be
          // persisted to the server. Unset attributes will be set to undefined.
          // You can also pass an attributes object to diff against the model,
          // determining if there *would be* a change.
          changedAttributes: function(diff) {
            if (!diff)
              return this.hasChanged() ? _.clone(this.changed) : false;
            var old = this._changing ? this._previousAttributes : this.attributes;
            var changed = {};
            var hasChanged;
            for (var attr in diff) {
              var val = diff[attr];
              if (_.isEqual(old[attr], val))
                continue;
              changed[attr] = val;
              hasChanged = true;
            }
            return hasChanged ? changed : false;
          },
          // Get the previous value of an attribute, recorded at the time the last
          // `"change"` event was fired.
          previous: function(attr) {
            if (attr == null || !this._previousAttributes)
              return null;
            return this._previousAttributes[attr];
          },
          // Get all of the attributes of the model at the time of the previous
          // `"change"` event.
          previousAttributes: function() {
            return _.clone(this._previousAttributes);
          },
          // Fetch the model from the server, merging the response with the model's
          // local attributes. Any changed attributes will trigger a "change" event.
          fetch: function(options) {
            options = _.extend({ parse: true }, options);
            var model = this;
            var success = options.success;
            options.success = function(resp) {
              var serverAttrs = options.parse ? model.parse(resp, options) : resp;
              if (!model.set(serverAttrs, options))
                return false;
              if (success)
                success.call(options.context, model, resp, options);
              model.trigger("sync", model, resp, options);
            };
            wrapError(this, options);
            return this.sync("read", this, options);
          },
          // Set a hash of model attributes, and sync the model to the server.
          // If the server returns an attributes hash that differs, the model's
          // state will be `set` again.
          save: function(key, val, options) {
            var attrs;
            if (key == null || typeof key === "object") {
              attrs = key;
              options = val;
            } else {
              (attrs = {})[key] = val;
            }
            options = _.extend({ validate: true, parse: true }, options);
            var wait = options.wait;
            if (attrs && !wait) {
              if (!this.set(attrs, options))
                return false;
            } else if (!this._validate(attrs, options)) {
              return false;
            }
            var model = this;
            var success = options.success;
            var attributes = this.attributes;
            options.success = function(resp) {
              model.attributes = attributes;
              var serverAttrs = options.parse ? model.parse(resp, options) : resp;
              if (wait)
                serverAttrs = _.extend({}, attrs, serverAttrs);
              if (serverAttrs && !model.set(serverAttrs, options))
                return false;
              if (success)
                success.call(options.context, model, resp, options);
              model.trigger("sync", model, resp, options);
            };
            wrapError(this, options);
            if (attrs && wait)
              this.attributes = _.extend({}, attributes, attrs);
            var method = this.isNew() ? "create" : options.patch ? "patch" : "update";
            if (method === "patch" && !options.attrs)
              options.attrs = attrs;
            var xhr = this.sync(method, this, options);
            this.attributes = attributes;
            return xhr;
          },
          // Destroy this model on the server if it was already persisted.
          // Optimistically removes the model from its collection, if it has one.
          // If `wait: true` is passed, waits for the server to respond before removal.
          destroy: function(options) {
            options = options ? _.clone(options) : {};
            var model = this;
            var success = options.success;
            var wait = options.wait;
            var destroy = function() {
              model.stopListening();
              model.trigger("destroy", model, model.collection, options);
            };
            options.success = function(resp) {
              if (wait)
                destroy();
              if (success)
                success.call(options.context, model, resp, options);
              if (!model.isNew())
                model.trigger("sync", model, resp, options);
            };
            var xhr = false;
            if (this.isNew()) {
              _.defer(options.success);
            } else {
              wrapError(this, options);
              xhr = this.sync("delete", this, options);
            }
            if (!wait)
              destroy();
            return xhr;
          },
          // Default URL for the model's representation on the server -- if you're
          // using Backbone's restful methods, override this to change the endpoint
          // that will be called.
          url: function() {
            var base = _.result(this, "urlRoot") || _.result(this.collection, "url") || urlError();
            if (this.isNew())
              return base;
            var id = this.get(this.idAttribute);
            return base.replace(/[^\/]$/, "$&/") + encodeURIComponent(id);
          },
          // **parse** converts a response into the hash of attributes to be `set` on
          // the model. The default implementation is just to pass the response along.
          parse: function(resp, options) {
            return resp;
          },
          // Create a new model with identical attributes to this one.
          clone: function() {
            return new this.constructor(this.attributes);
          },
          // A model is new if it has never been saved to the server, and lacks an id.
          isNew: function() {
            return !this.has(this.idAttribute);
          },
          // Check if the model is currently in a valid state.
          isValid: function(options) {
            return this._validate({}, _.extend({}, options, { validate: true }));
          },
          // Run validation against the next complete set of model attributes,
          // returning `true` if all is well. Otherwise, fire an `"invalid"` event.
          _validate: function(attrs, options) {
            if (!options.validate || !this.validate)
              return true;
            attrs = _.extend({}, this.attributes, attrs);
            var error = this.validationError = this.validate(attrs, options) || null;
            if (!error)
              return true;
            this.trigger("invalid", this, error, _.extend(options, { validationError: error }));
            return false;
          }
        });
        var Collection = Backbone.Collection = function(models, options) {
          options || (options = {});
          this.preinitialize.apply(this, arguments);
          if (options.model)
            this.model = options.model;
          if (options.comparator !== void 0)
            this.comparator = options.comparator;
          this._reset();
          this.initialize.apply(this, arguments);
          if (models)
            this.reset(models, _.extend({ silent: true }, options));
        };
        var setOptions = { add: true, remove: true, merge: true };
        var addOptions = { add: true, remove: false };
        var splice = function(array, insert, at) {
          at = Math.min(Math.max(at, 0), array.length);
          var tail = Array(array.length - at);
          var length = insert.length;
          var i;
          for (i = 0; i < tail.length; i++)
            tail[i] = array[i + at];
          for (i = 0; i < length; i++)
            array[i + at] = insert[i];
          for (i = 0; i < tail.length; i++)
            array[i + length + at] = tail[i];
        };
        _.extend(Collection.prototype, Events, {
          // The default model for a collection is just a **Backbone.Model**.
          // This should be overridden in most cases.
          model: Model,
          // preinitialize is an empty function by default. You can override it with a function
          // or object.  preinitialize will run before any instantiation logic is run in the Collection.
          preinitialize: function() {
          },
          // Initialize is an empty function by default. Override it with your own
          // initialization logic.
          initialize: function() {
          },
          // The JSON representation of a Collection is an array of the
          // models' attributes.
          toJSON: function(options) {
            return this.map(function(model) {
              return model.toJSON(options);
            });
          },
          // Proxy `Backbone.sync` by default.
          sync: function() {
            return Backbone.sync.apply(this, arguments);
          },
          // Add a model, or list of models to the set. `models` may be Backbone
          // Models or raw JavaScript objects to be converted to Models, or any
          // combination of the two.
          add: function(models, options) {
            return this.set(models, _.extend({ merge: false }, options, addOptions));
          },
          // Remove a model, or a list of models from the set.
          remove: function(models, options) {
            options = _.extend({}, options);
            var singular = !_.isArray(models);
            models = singular ? [models] : models.slice();
            var removed = this._removeModels(models, options);
            if (!options.silent && removed.length) {
              options.changes = { added: [], merged: [], removed };
              this.trigger("update", this, options);
            }
            return singular ? removed[0] : removed;
          },
          // Update a collection by `set`-ing a new list of models, adding new ones,
          // removing models that are no longer present, and merging models that
          // already exist in the collection, as necessary. Similar to **Model#set**,
          // the core operation for updating the data contained by the collection.
          set: function(models, options) {
            if (models == null)
              return;
            options = _.extend({}, setOptions, options);
            if (options.parse && !this._isModel(models)) {
              models = this.parse(models, options) || [];
            }
            var singular = !_.isArray(models);
            models = singular ? [models] : models.slice();
            var at = options.at;
            if (at != null)
              at = +at;
            if (at > this.length)
              at = this.length;
            if (at < 0)
              at += this.length + 1;
            var set = [];
            var toAdd = [];
            var toMerge = [];
            var toRemove = [];
            var modelMap = {};
            var add = options.add;
            var merge = options.merge;
            var remove = options.remove;
            var sort = false;
            var sortable = this.comparator && at == null && options.sort !== false;
            var sortAttr = _.isString(this.comparator) ? this.comparator : null;
            var model, i;
            for (i = 0; i < models.length; i++) {
              model = models[i];
              var existing = this.get(model);
              if (existing) {
                if (merge && model !== existing) {
                  var attrs = this._isModel(model) ? model.attributes : model;
                  if (options.parse)
                    attrs = existing.parse(attrs, options);
                  existing.set(attrs, options);
                  toMerge.push(existing);
                  if (sortable && !sort)
                    sort = existing.hasChanged(sortAttr);
                }
                if (!modelMap[existing.cid]) {
                  modelMap[existing.cid] = true;
                  set.push(existing);
                }
                models[i] = existing;
              } else if (add) {
                model = models[i] = this._prepareModel(model, options);
                if (model) {
                  toAdd.push(model);
                  this._addReference(model, options);
                  modelMap[model.cid] = true;
                  set.push(model);
                }
              }
            }
            if (remove) {
              for (i = 0; i < this.length; i++) {
                model = this.models[i];
                if (!modelMap[model.cid])
                  toRemove.push(model);
              }
              if (toRemove.length)
                this._removeModels(toRemove, options);
            }
            var orderChanged = false;
            var replace = !sortable && add && remove;
            if (set.length && replace) {
              orderChanged = this.length !== set.length || _.some(this.models, function(m, index2) {
                return m !== set[index2];
              });
              this.models.length = 0;
              splice(this.models, set, 0);
              this.length = this.models.length;
            } else if (toAdd.length) {
              if (sortable)
                sort = true;
              splice(this.models, toAdd, at == null ? this.length : at);
              this.length = this.models.length;
            }
            if (sort)
              this.sort({ silent: true });
            if (!options.silent) {
              for (i = 0; i < toAdd.length; i++) {
                if (at != null)
                  options.index = at + i;
                model = toAdd[i];
                model.trigger("add", model, this, options);
              }
              if (sort || orderChanged)
                this.trigger("sort", this, options);
              if (toAdd.length || toRemove.length || toMerge.length) {
                options.changes = {
                  added: toAdd,
                  removed: toRemove,
                  merged: toMerge
                };
                this.trigger("update", this, options);
              }
            }
            return singular ? models[0] : models;
          },
          // When you have more items than you want to add or remove individually,
          // you can reset the entire set with a new list of models, without firing
          // any granular `add` or `remove` events. Fires `reset` when finished.
          // Useful for bulk operations and optimizations.
          reset: function(models, options) {
            options = options ? _.clone(options) : {};
            for (var i = 0; i < this.models.length; i++) {
              this._removeReference(this.models[i], options);
            }
            options.previousModels = this.models;
            this._reset();
            models = this.add(models, _.extend({ silent: true }, options));
            if (!options.silent)
              this.trigger("reset", this, options);
            return models;
          },
          // Add a model to the end of the collection.
          push: function(model, options) {
            return this.add(model, _.extend({ at: this.length }, options));
          },
          // Remove a model from the end of the collection.
          pop: function(options) {
            var model = this.at(this.length - 1);
            return this.remove(model, options);
          },
          // Add a model to the beginning of the collection.
          unshift: function(model, options) {
            return this.add(model, _.extend({ at: 0 }, options));
          },
          // Remove a model from the beginning of the collection.
          shift: function(options) {
            var model = this.at(0);
            return this.remove(model, options);
          },
          // Slice out a sub-array of models from the collection.
          slice: function() {
            return slice.apply(this.models, arguments);
          },
          // Get a model from the set by id, cid, model object with id or cid
          // properties, or an attributes object that is transformed through modelId.
          get: function(obj) {
            if (obj == null)
              return void 0;
            return this._byId[obj] || this._byId[this.modelId(this._isModel(obj) ? obj.attributes : obj, obj.idAttribute)] || obj.cid && this._byId[obj.cid];
          },
          // Returns `true` if the model is in the collection.
          has: function(obj) {
            return this.get(obj) != null;
          },
          // Get the model at the given index.
          at: function(index2) {
            if (index2 < 0)
              index2 += this.length;
            return this.models[index2];
          },
          // Return models with matching attributes. Useful for simple cases of
          // `filter`.
          where: function(attrs, first) {
            return this[first ? "find" : "filter"](attrs);
          },
          // Return the first model with matching attributes. Useful for simple cases
          // of `find`.
          findWhere: function(attrs) {
            return this.where(attrs, true);
          },
          // Force the collection to re-sort itself. You don't need to call this under
          // normal circumstances, as the set will maintain sort order as each item
          // is added.
          sort: function(options) {
            var comparator = this.comparator;
            if (!comparator)
              throw new Error("Cannot sort a set without a comparator");
            options || (options = {});
            var length = comparator.length;
            if (_.isFunction(comparator))
              comparator = comparator.bind(this);
            if (length === 1 || _.isString(comparator)) {
              this.models = this.sortBy(comparator);
            } else {
              this.models.sort(comparator);
            }
            if (!options.silent)
              this.trigger("sort", this, options);
            return this;
          },
          // Pluck an attribute from each model in the collection.
          pluck: function(attr) {
            return this.map(attr + "");
          },
          // Fetch the default set of models for this collection, resetting the
          // collection when they arrive. If `reset: true` is passed, the response
          // data will be passed through the `reset` method instead of `set`.
          fetch: function(options) {
            options = _.extend({ parse: true }, options);
            var success = options.success;
            var collection = this;
            options.success = function(resp) {
              var method = options.reset ? "reset" : "set";
              collection[method](resp, options);
              if (success)
                success.call(options.context, collection, resp, options);
              collection.trigger("sync", collection, resp, options);
            };
            wrapError(this, options);
            return this.sync("read", this, options);
          },
          // Create a new instance of a model in this collection. Add the model to the
          // collection immediately, unless `wait: true` is passed, in which case we
          // wait for the server to agree.
          create: function(model, options) {
            options = options ? _.clone(options) : {};
            var wait = options.wait;
            model = this._prepareModel(model, options);
            if (!model)
              return false;
            if (!wait)
              this.add(model, options);
            var collection = this;
            var success = options.success;
            options.success = function(m, resp, callbackOpts) {
              if (wait)
                collection.add(m, callbackOpts);
              if (success)
                success.call(callbackOpts.context, m, resp, callbackOpts);
            };
            model.save(null, options);
            return model;
          },
          // **parse** converts a response into a list of models to be added to the
          // collection. The default implementation is just to pass it through.
          parse: function(resp, options) {
            return resp;
          },
          // Create a new collection with an identical list of models as this one.
          clone: function() {
            return new this.constructor(this.models, {
              model: this.model,
              comparator: this.comparator
            });
          },
          // Define how to uniquely identify models in the collection.
          modelId: function(attrs, idAttribute) {
            return attrs[idAttribute || this.model.prototype.idAttribute || "id"];
          },
          // Get an iterator of all models in this collection.
          values: function() {
            return new CollectionIterator(this, ITERATOR_VALUES);
          },
          // Get an iterator of all model IDs in this collection.
          keys: function() {
            return new CollectionIterator(this, ITERATOR_KEYS);
          },
          // Get an iterator of all [ID, model] tuples in this collection.
          entries: function() {
            return new CollectionIterator(this, ITERATOR_KEYSVALUES);
          },
          // Private method to reset all internal state. Called when the collection
          // is first initialized or reset.
          _reset: function() {
            this.length = 0;
            this.models = [];
            this._byId = {};
          },
          // Prepare a hash of attributes (or other model) to be added to this
          // collection.
          _prepareModel: function(attrs, options) {
            if (this._isModel(attrs)) {
              if (!attrs.collection)
                attrs.collection = this;
              return attrs;
            }
            options = options ? _.clone(options) : {};
            options.collection = this;
            var model;
            if (this.model.prototype) {
              model = new this.model(attrs, options);
            } else {
              model = this.model(attrs, options);
            }
            if (!model.validationError)
              return model;
            this.trigger("invalid", this, model.validationError, options);
            return false;
          },
          // Internal method called by both remove and set.
          _removeModels: function(models, options) {
            var removed = [];
            for (var i = 0; i < models.length; i++) {
              var model = this.get(models[i]);
              if (!model)
                continue;
              var index2 = this.indexOf(model);
              this.models.splice(index2, 1);
              this.length--;
              delete this._byId[model.cid];
              var id = this.modelId(model.attributes, model.idAttribute);
              if (id != null)
                delete this._byId[id];
              if (!options.silent) {
                options.index = index2;
                model.trigger("remove", model, this, options);
              }
              removed.push(model);
              this._removeReference(model, options);
            }
            return removed;
          },
          // Method for checking whether an object should be considered a model for
          // the purposes of adding to the collection.
          _isModel: function(model) {
            return model instanceof Model;
          },
          // Internal method to create a model's ties to a collection.
          _addReference: function(model, options) {
            this._byId[model.cid] = model;
            var id = this.modelId(model.attributes, model.idAttribute);
            if (id != null)
              this._byId[id] = model;
            model.on("all", this._onModelEvent, this);
          },
          // Internal method to sever a model's ties to a collection.
          _removeReference: function(model, options) {
            delete this._byId[model.cid];
            var id = this.modelId(model.attributes, model.idAttribute);
            if (id != null)
              delete this._byId[id];
            if (this === model.collection)
              delete model.collection;
            model.off("all", this._onModelEvent, this);
          },
          // Internal method called every time a model in the set fires an event.
          // Sets need to update their indexes when models change ids. All other
          // events simply proxy through. "add" and "remove" events that originate
          // in other collections are ignored.
          _onModelEvent: function(event, model, collection, options) {
            if (model) {
              if ((event === "add" || event === "remove") && collection !== this)
                return;
              if (event === "destroy")
                this.remove(model, options);
              if (event === "changeId") {
                var prevId = this.modelId(model.previousAttributes(), model.idAttribute);
                var id = this.modelId(model.attributes, model.idAttribute);
                if (prevId != null)
                  delete this._byId[prevId];
                if (id != null)
                  this._byId[id] = model;
              }
            }
            this.trigger.apply(this, arguments);
          }
        });
        var $$iterator = typeof Symbol === "function" && Symbol.iterator;
        if ($$iterator) {
          Collection.prototype[$$iterator] = Collection.prototype.values;
        }
        var CollectionIterator = function(collection, kind) {
          this._collection = collection;
          this._kind = kind;
          this._index = 0;
        };
        var ITERATOR_VALUES = 1;
        var ITERATOR_KEYS = 2;
        var ITERATOR_KEYSVALUES = 3;
        if ($$iterator) {
          CollectionIterator.prototype[$$iterator] = function() {
            return this;
          };
        }
        CollectionIterator.prototype.next = function() {
          if (this._collection) {
            if (this._index < this._collection.length) {
              var model = this._collection.at(this._index);
              this._index++;
              var value;
              if (this._kind === ITERATOR_VALUES) {
                value = model;
              } else {
                var id = this._collection.modelId(model.attributes, model.idAttribute);
                if (this._kind === ITERATOR_KEYS) {
                  value = id;
                } else {
                  value = [id, model];
                }
              }
              return { value, done: false };
            }
            this._collection = void 0;
          }
          return { value: void 0, done: true };
        };
        var View = Backbone.View = function(options) {
          this.cid = _.uniqueId("view");
          this.preinitialize.apply(this, arguments);
          _.extend(this, _.pick(options, viewOptions));
          this._ensureElement();
          this.initialize.apply(this, arguments);
        };
        var delegateEventSplitter = /^(\S+)\s*(.*)$/;
        var viewOptions = ["model", "collection", "el", "id", "attributes", "className", "tagName", "events"];
        _.extend(View.prototype, Events, {
          // The default `tagName` of a View's element is `"div"`.
          tagName: "div",
          // jQuery delegate for element lookup, scoped to DOM elements within the
          // current view. This should be preferred to global lookups where possible.
          $: function(selector) {
            return this.$el.find(selector);
          },
          // preinitialize is an empty function by default. You can override it with a function
          // or object.  preinitialize will run before any instantiation logic is run in the View
          preinitialize: function() {
          },
          // Initialize is an empty function by default. Override it with your own
          // initialization logic.
          initialize: function() {
          },
          // **render** is the core function that your view should override, in order
          // to populate its element (`this.el`), with the appropriate HTML. The
          // convention is for **render** to always return `this`.
          render: function() {
            return this;
          },
          // Remove this view by taking the element out of the DOM, and removing any
          // applicable Backbone.Events listeners.
          remove: function() {
            this._removeElement();
            this.stopListening();
            return this;
          },
          // Remove this view's element from the document and all event listeners
          // attached to it. Exposed for subclasses using an alternative DOM
          // manipulation API.
          _removeElement: function() {
            this.$el.remove();
          },
          // Change the view's element (`this.el` property) and re-delegate the
          // view's events on the new element.
          setElement: function(element) {
            this.undelegateEvents();
            this._setElement(element);
            this.delegateEvents();
            return this;
          },
          // Creates the `this.el` and `this.$el` references for this view using the
          // given `el`. `el` can be a CSS selector or an HTML string, a jQuery
          // context or an element. Subclasses can override this to utilize an
          // alternative DOM manipulation API and are only required to set the
          // `this.el` property.
          _setElement: function(el) {
            this.$el = el instanceof Backbone.$ ? el : Backbone.$(el);
            this.el = this.$el[0];
          },
          // Set callbacks, where `this.events` is a hash of
          //
          // *{"event selector": "callback"}*
          //
          //     {
          //       'mousedown .title':  'edit',
          //       'click .button':     'save',
          //       'click .open':       function(e) { ... }
          //     }
          //
          // pairs. Callbacks will be bound to the view, with `this` set properly.
          // Uses event delegation for efficiency.
          // Omitting the selector binds the event to `this.el`.
          delegateEvents: function(events2) {
            events2 || (events2 = _.result(this, "events"));
            if (!events2)
              return this;
            this.undelegateEvents();
            for (var key in events2) {
              var method = events2[key];
              if (!_.isFunction(method))
                method = this[method];
              if (!method)
                continue;
              var match = key.match(delegateEventSplitter);
              this.delegate(match[1], match[2], method.bind(this));
            }
            return this;
          },
          // Add a single event listener to the view's element (or a child element
          // using `selector`). This only works for delegate-able events: not `focus`,
          // `blur`, and not `change`, `submit`, and `reset` in Internet Explorer.
          delegate: function(eventName, selector, listener) {
            this.$el.on(eventName + ".delegateEvents" + this.cid, selector, listener);
            return this;
          },
          // Clears all callbacks previously bound to the view by `delegateEvents`.
          // You usually don't need to use this, but may wish to if you have multiple
          // Backbone views attached to the same DOM element.
          undelegateEvents: function() {
            if (this.$el)
              this.$el.off(".delegateEvents" + this.cid);
            return this;
          },
          // A finer-grained `undelegateEvents` for removing a single delegated event.
          // `selector` and `listener` are both optional.
          undelegate: function(eventName, selector, listener) {
            this.$el.off(eventName + ".delegateEvents" + this.cid, selector, listener);
            return this;
          },
          // Produces a DOM element to be assigned to your view. Exposed for
          // subclasses using an alternative DOM manipulation API.
          _createElement: function(tagName2) {
            return document.createElement(tagName2);
          },
          // Ensure that the View has a DOM element to render into.
          // If `this.el` is a string, pass it through `$()`, take the first
          // matching element, and re-assign it to `el`. Otherwise, create
          // an element from the `id`, `className` and `tagName` properties.
          _ensureElement: function() {
            if (!this.el) {
              var attrs = _.extend({}, _.result(this, "attributes"));
              if (this.id)
                attrs.id = _.result(this, "id");
              if (this.className)
                attrs["class"] = _.result(this, "className");
              this.setElement(this._createElement(_.result(this, "tagName")));
              this._setAttributes(attrs);
            } else {
              this.setElement(_.result(this, "el"));
            }
          },
          // Set attributes from a hash on this view's element.  Exposed for
          // subclasses using an alternative DOM manipulation API.
          _setAttributes: function(attributes) {
            this.$el.attr(attributes);
          }
        });
        var addMethod = function(base, length, method, attribute) {
          switch (length) {
            case 1:
              return function() {
                return base[method](this[attribute]);
              };
            case 2:
              return function(value) {
                return base[method](this[attribute], value);
              };
            case 3:
              return function(iteratee, context) {
                return base[method](this[attribute], cb(iteratee, this), context);
              };
            case 4:
              return function(iteratee, defaultVal, context) {
                return base[method](this[attribute], cb(iteratee, this), defaultVal, context);
              };
            default:
              return function() {
                var args = slice.call(arguments);
                args.unshift(this[attribute]);
                return base[method].apply(base, args);
              };
          }
        };
        var addUnderscoreMethods = function(Class, base, methods, attribute) {
          _.each(methods, function(length, method) {
            if (base[method])
              Class.prototype[method] = addMethod(base, length, method, attribute);
          });
        };
        var cb = function(iteratee, instance) {
          if (_.isFunction(iteratee))
            return iteratee;
          if (_.isObject(iteratee) && !instance._isModel(iteratee))
            return modelMatcher(iteratee);
          if (_.isString(iteratee))
            return function(model) {
              return model.get(iteratee);
            };
          return iteratee;
        };
        var modelMatcher = function(attrs) {
          var matcher = _.matches(attrs);
          return function(model) {
            return matcher(model.attributes);
          };
        };
        var collectionMethods = {
          forEach: 3,
          each: 3,
          map: 3,
          collect: 3,
          reduce: 0,
          foldl: 0,
          inject: 0,
          reduceRight: 0,
          foldr: 0,
          find: 3,
          detect: 3,
          filter: 3,
          select: 3,
          reject: 3,
          every: 3,
          all: 3,
          some: 3,
          any: 3,
          include: 3,
          includes: 3,
          contains: 3,
          invoke: 0,
          max: 3,
          min: 3,
          toArray: 1,
          size: 1,
          first: 3,
          head: 3,
          take: 3,
          initial: 3,
          rest: 3,
          tail: 3,
          drop: 3,
          last: 3,
          without: 0,
          difference: 0,
          indexOf: 3,
          shuffle: 1,
          lastIndexOf: 3,
          isEmpty: 1,
          chain: 1,
          sample: 3,
          partition: 3,
          groupBy: 3,
          countBy: 3,
          sortBy: 3,
          indexBy: 3,
          findIndex: 3,
          findLastIndex: 3
        };
        var modelMethods = {
          keys: 1,
          values: 1,
          pairs: 1,
          invert: 1,
          pick: 0,
          omit: 0,
          chain: 1,
          isEmpty: 1
        };
        _.each([
          [Collection, collectionMethods, "models"],
          [Model, modelMethods, "attributes"]
        ], function(config2) {
          var Base = config2[0], methods = config2[1], attribute = config2[2];
          Base.mixin = function(obj) {
            var mappings = _.reduce(_.functions(obj), function(memo, name) {
              memo[name] = 0;
              return memo;
            }, {});
            addUnderscoreMethods(Base, obj, mappings, attribute);
          };
          addUnderscoreMethods(Base, _, methods, attribute);
        });
        Backbone.sync = function(method, model, options) {
          var type2 = methodMap[method];
          _.defaults(options || (options = {}), {
            emulateHTTP: Backbone.emulateHTTP,
            emulateJSON: Backbone.emulateJSON
          });
          var params = { type: type2, dataType: "json" };
          if (!options.url) {
            params.url = _.result(model, "url") || urlError();
          }
          if (options.data == null && model && (method === "create" || method === "update" || method === "patch")) {
            params.contentType = "application/json";
            params.data = JSON.stringify(options.attrs || model.toJSON(options));
          }
          if (options.emulateJSON) {
            params.contentType = "application/x-www-form-urlencoded";
            params.data = params.data ? { model: params.data } : {};
          }
          if (options.emulateHTTP && (type2 === "PUT" || type2 === "DELETE" || type2 === "PATCH")) {
            params.type = "POST";
            if (options.emulateJSON)
              params.data._method = type2;
            var beforeSend = options.beforeSend;
            options.beforeSend = function(xhr2) {
              xhr2.setRequestHeader("X-HTTP-Method-Override", type2);
              if (beforeSend)
                return beforeSend.apply(this, arguments);
            };
          }
          if (params.type !== "GET" && !options.emulateJSON) {
            params.processData = false;
          }
          var error = options.error;
          options.error = function(xhr2, textStatus, errorThrown) {
            options.textStatus = textStatus;
            options.errorThrown = errorThrown;
            if (error)
              error.call(options.context, xhr2, textStatus, errorThrown);
          };
          var xhr = options.xhr = Backbone.ajax(_.extend(params, options));
          model.trigger("request", model, xhr, options);
          return xhr;
        };
        var methodMap = {
          "create": "POST",
          "update": "PUT",
          "patch": "PATCH",
          "delete": "DELETE",
          "read": "GET"
        };
        Backbone.ajax = function() {
          return Backbone.$.ajax.apply(Backbone.$, arguments);
        };
        var Router = Backbone.Router = function(options) {
          options || (options = {});
          this.preinitialize.apply(this, arguments);
          if (options.routes)
            this.routes = options.routes;
          this._bindRoutes();
          this.initialize.apply(this, arguments);
        };
        var optionalParam = /\((.*?)\)/g;
        var namedParam = /(\(\?)?:\w+/g;
        var splatParam = /\*\w+/g;
        var escapeRegExp2 = /[\-{}\[\]+?.,\\\^$|#\s]/g;
        _.extend(Router.prototype, Events, {
          // preinitialize is an empty function by default. You can override it with a function
          // or object.  preinitialize will run before any instantiation logic is run in the Router.
          preinitialize: function() {
          },
          // Initialize is an empty function by default. Override it with your own
          // initialization logic.
          initialize: function() {
          },
          // Manually bind a single named route to a callback. For example:
          //
          //     this.route('search/:query/p:num', 'search', function(query, num) {
          //       ...
          //     });
          //
          route: function(route, name, callback) {
            if (!_.isRegExp(route))
              route = this._routeToRegExp(route);
            if (_.isFunction(name)) {
              callback = name;
              name = "";
            }
            if (!callback)
              callback = this[name];
            var router = this;
            Backbone.history.route(route, function(fragment) {
              var args = router._extractParameters(route, fragment);
              if (router.execute(callback, args, name) !== false) {
                router.trigger.apply(router, ["route:" + name].concat(args));
                router.trigger("route", name, args);
                Backbone.history.trigger("route", router, name, args);
              }
            });
            return this;
          },
          // Execute a route handler with the provided parameters.  This is an
          // excellent place to do pre-route setup or post-route cleanup.
          execute: function(callback, args, name) {
            if (callback)
              callback.apply(this, args);
          },
          // Simple proxy to `Backbone.history` to save a fragment into the history.
          navigate: function(fragment, options) {
            Backbone.history.navigate(fragment, options);
            return this;
          },
          // Bind all defined routes to `Backbone.history`. We have to reverse the
          // order of the routes here to support behavior where the most general
          // routes can be defined at the bottom of the route map.
          _bindRoutes: function() {
            if (!this.routes)
              return;
            this.routes = _.result(this, "routes");
            var route, routes = _.keys(this.routes);
            while ((route = routes.pop()) != null) {
              this.route(route, this.routes[route]);
            }
          },
          // Convert a route string into a regular expression, suitable for matching
          // against the current location hash.
          _routeToRegExp: function(route) {
            route = route.replace(escapeRegExp2, "\\$&").replace(optionalParam, "(?:$1)?").replace(namedParam, function(match, optional) {
              return optional ? match : "([^/?]+)";
            }).replace(splatParam, "([^?]*?)");
            return new RegExp("^" + route + "(?:\\?([\\s\\S]*))?$");
          },
          // Given a route, and a URL fragment that it matches, return the array of
          // extracted decoded parameters. Empty or unmatched parameters will be
          // treated as `null` to normalize cross-browser behavior.
          _extractParameters: function(route, fragment) {
            var params = route.exec(fragment).slice(1);
            return _.map(params, function(param, i) {
              if (i === params.length - 1)
                return param || null;
              return param ? decodeURIComponent(param) : null;
            });
          }
        });
        var History = Backbone.History = function() {
          this.handlers = [];
          this.checkUrl = this.checkUrl.bind(this);
          if (typeof window !== "undefined") {
            this.location = window.location;
            this.history = window.history;
          }
        };
        var routeStripper = /^[#\/]|\s+$/g;
        var rootStripper = /^\/+|\/+$/g;
        var pathStripper = /#.*$/;
        History.started = false;
        _.extend(History.prototype, Events, {
          // The default interval to poll for hash changes, if necessary, is
          // twenty times a second.
          interval: 50,
          // Are we at the app root?
          atRoot: function() {
            var path = this.location.pathname.replace(/[^\/]$/, "$&/");
            return path === this.root && !this.getSearch();
          },
          // Does the pathname match the root?
          matchRoot: function() {
            var path = this.decodeFragment(this.location.pathname);
            var rootPath = path.slice(0, this.root.length - 1) + "/";
            return rootPath === this.root;
          },
          // Unicode characters in `location.pathname` are percent encoded so they're
          // decoded for comparison. `%25` should not be decoded since it may be part
          // of an encoded parameter.
          decodeFragment: function(fragment) {
            return decodeURI(fragment.replace(/%25/g, "%2525"));
          },
          // In IE6, the hash fragment and search params are incorrect if the
          // fragment contains `?`.
          getSearch: function() {
            var match = this.location.href.replace(/#.*/, "").match(/\?.+/);
            return match ? match[0] : "";
          },
          // Gets the true hash value. Cannot use location.hash directly due to bug
          // in Firefox where location.hash will always be decoded.
          getHash: function(window2) {
            var match = (window2 || this).location.href.match(/#(.*)$/);
            return match ? match[1] : "";
          },
          // Get the pathname and search params, without the root.
          getPath: function() {
            var path = this.decodeFragment(
              this.location.pathname + this.getSearch()
            ).slice(this.root.length - 1);
            return path.charAt(0) === "/" ? path.slice(1) : path;
          },
          // Get the cross-browser normalized URL fragment from the path or hash.
          getFragment: function(fragment) {
            if (fragment == null) {
              if (this._usePushState || !this._wantsHashChange) {
                fragment = this.getPath();
              } else {
                fragment = this.getHash();
              }
            }
            return fragment.replace(routeStripper, "");
          },
          // Start the hash change handling, returning `true` if the current URL matches
          // an existing route, and `false` otherwise.
          start: function(options) {
            if (History.started)
              throw new Error("Backbone.history has already been started");
            History.started = true;
            this.options = _.extend({ root: "/" }, this.options, options);
            this.root = this.options.root;
            this._wantsHashChange = this.options.hashChange !== false;
            this._hasHashChange = "onhashchange" in window && (document.documentMode === void 0 || document.documentMode > 7);
            this._useHashChange = this._wantsHashChange && this._hasHashChange;
            this._wantsPushState = !!this.options.pushState;
            this._hasPushState = !!(this.history && this.history.pushState);
            this._usePushState = this._wantsPushState && this._hasPushState;
            this.fragment = this.getFragment();
            this.root = ("/" + this.root + "/").replace(rootStripper, "/");
            if (this._wantsHashChange && this._wantsPushState) {
              if (!this._hasPushState && !this.atRoot()) {
                var rootPath = this.root.slice(0, -1) || "/";
                this.location.replace(rootPath + "#" + this.getPath());
                return true;
              } else if (this._hasPushState && this.atRoot()) {
                this.navigate(this.getHash(), { replace: true });
              }
            }
            if (!this._hasHashChange && this._wantsHashChange && !this._usePushState) {
              this.iframe = document.createElement("iframe");
              this.iframe.src = "javascript:0";
              this.iframe.style.display = "none";
              this.iframe.tabIndex = -1;
              var body = document.body;
              var iWindow = body.insertBefore(this.iframe, body.firstChild).contentWindow;
              iWindow.document.open();
              iWindow.document.close();
              iWindow.location.hash = "#" + this.fragment;
            }
            var addEventListener = window.addEventListener || function(eventName, listener) {
              return attachEvent("on" + eventName, listener);
            };
            if (this._usePushState) {
              addEventListener("popstate", this.checkUrl, false);
            } else if (this._useHashChange && !this.iframe) {
              addEventListener("hashchange", this.checkUrl, false);
            } else if (this._wantsHashChange) {
              this._checkUrlInterval = setInterval(this.checkUrl, this.interval);
            }
            if (!this.options.silent)
              return this.loadUrl();
          },
          // Disable Backbone.history, perhaps temporarily. Not useful in a real app,
          // but possibly useful for unit testing Routers.
          stop: function() {
            var removeEventListener = window.removeEventListener || function(eventName, listener) {
              return detachEvent("on" + eventName, listener);
            };
            if (this._usePushState) {
              removeEventListener("popstate", this.checkUrl, false);
            } else if (this._useHashChange && !this.iframe) {
              removeEventListener("hashchange", this.checkUrl, false);
            }
            if (this.iframe) {
              document.body.removeChild(this.iframe);
              this.iframe = null;
            }
            if (this._checkUrlInterval)
              clearInterval(this._checkUrlInterval);
            History.started = false;
          },
          // Add a route to be tested when the fragment changes. Routes added later
          // may override previous routes.
          route: function(route, callback) {
            this.handlers.unshift({ route, callback });
          },
          // Checks the current URL to see if it has changed, and if it has,
          // calls `loadUrl`, normalizing across the hidden iframe.
          checkUrl: function(e) {
            var current = this.getFragment();
            if (current === this.fragment && this.iframe) {
              current = this.getHash(this.iframe.contentWindow);
            }
            if (current === this.fragment)
              return false;
            if (this.iframe)
              this.navigate(current);
            this.loadUrl();
          },
          // Attempt to load the current URL fragment. If a route succeeds with a
          // match, returns `true`. If no defined routes matches the fragment,
          // returns `false`.
          loadUrl: function(fragment) {
            if (!this.matchRoot())
              return false;
            fragment = this.fragment = this.getFragment(fragment);
            return _.some(this.handlers, function(handler) {
              if (handler.route.test(fragment)) {
                handler.callback(fragment);
                return true;
              }
            });
          },
          // Save a fragment into the hash history, or replace the URL state if the
          // 'replace' option is passed. You are responsible for properly URL-encoding
          // the fragment in advance.
          //
          // The options object can contain `trigger: true` if you wish to have the
          // route callback be fired (not usually desirable), or `replace: true`, if
          // you wish to modify the current URL without adding an entry to the history.
          navigate: function(fragment, options) {
            if (!History.started)
              return false;
            if (!options || options === true)
              options = { trigger: !!options };
            fragment = this.getFragment(fragment || "");
            var rootPath = this.root;
            if (fragment === "" || fragment.charAt(0) === "?") {
              rootPath = rootPath.slice(0, -1) || "/";
            }
            var url = rootPath + fragment;
            fragment = fragment.replace(pathStripper, "");
            var decodedFragment = this.decodeFragment(fragment);
            if (this.fragment === decodedFragment)
              return;
            this.fragment = decodedFragment;
            if (this._usePushState) {
              this.history[options.replace ? "replaceState" : "pushState"]({}, document.title, url);
            } else if (this._wantsHashChange) {
              this._updateHash(this.location, fragment, options.replace);
              if (this.iframe && fragment !== this.getHash(this.iframe.contentWindow)) {
                var iWindow = this.iframe.contentWindow;
                if (!options.replace) {
                  iWindow.document.open();
                  iWindow.document.close();
                }
                this._updateHash(iWindow.location, fragment, options.replace);
              }
            } else {
              return this.location.assign(url);
            }
            if (options.trigger)
              return this.loadUrl(fragment);
          },
          // Update the hash location, either replacing the current entry, or adding
          // a new one to the browser history.
          _updateHash: function(location, fragment, replace) {
            if (replace) {
              var href = location.href.replace(/(javascript:|#).*$/, "");
              location.replace(href + "#" + fragment);
            } else {
              location.hash = "#" + fragment;
            }
          }
        });
        Backbone.history = new History();
        var extend = function(protoProps, staticProps) {
          var parent = this;
          var child;
          if (protoProps && _.has(protoProps, "constructor")) {
            child = protoProps.constructor;
          } else {
            child = function() {
              return parent.apply(this, arguments);
            };
          }
          _.extend(child, parent, staticProps);
          child.prototype = _.create(parent.prototype, protoProps);
          child.prototype.constructor = child;
          child.__super__ = parent.prototype;
          return child;
        };
        Model.extend = Collection.extend = Router.extend = View.extend = History.extend = extend;
        var urlError = function() {
          throw new Error('A "url" property or function must be specified');
        };
        var wrapError = function(model, options) {
          var error = options.error;
          options.error = function(resp) {
            if (error)
              error.call(options.context, model, resp, options);
            model.trigger("error", model, resp, options);
          };
        };
        return Backbone;
      });
    }
  ),
  /***/
  862: (
    /***/
    (__unused_webpack_module, __unused_webpack_exports, __webpack_require__2) => {
      (function(mod) {
        if (true)
          mod(__webpack_require__2(237));
        else {
        }
      })(function(CodeMirror2) {
        CodeMirror2.extendMode("css", {
          commentStart: "/*",
          commentEnd: "*/",
          newlineAfterToken: function(_type, content) {
            return /^[;{}]$/.test(content);
          }
        });
        CodeMirror2.extendMode("javascript", {
          commentStart: "/*",
          commentEnd: "*/",
          // FIXME semicolons inside of for
          newlineAfterToken: function(_type, content, textAfter, state) {
            if (this.jsonMode) {
              return /^[\[,{]$/.test(content) || /^}/.test(textAfter);
            } else {
              if (content == ";" && state.lexical && state.lexical.type == ")")
                return false;
              return /^[;{}]$/.test(content) && !/^;/.test(textAfter);
            }
          }
        });
        var inlineElements = /^(a|abbr|acronym|area|base|bdo|big|br|button|caption|cite|code|col|colgroup|dd|del|dfn|em|frame|hr|iframe|img|input|ins|kbd|label|legend|link|map|object|optgroup|option|param|q|samp|script|select|small|span|strong|sub|sup|textarea|tt|var)$/;
        CodeMirror2.extendMode("xml", {
          commentStart: "<!--",
          commentEnd: "-->",
          newlineAfterToken: function(type2, content, textAfter, state) {
            var inline = false;
            if (this.configuration == "html")
              inline = state.context ? inlineElements.test(state.context.tagName) : false;
            return !inline && (type2 == "tag" && />$/.test(content) && state.context || /^</.test(textAfter));
          }
        });
        CodeMirror2.defineExtension("commentRange", function(isComment, from, to) {
          var cm = this, curMode = CodeMirror2.innerMode(cm.getMode(), cm.getTokenAt(from).state).mode;
          cm.operation(function() {
            if (isComment) {
              cm.replaceRange(curMode.commentEnd, to);
              cm.replaceRange(curMode.commentStart, from);
              if (from.line == to.line && from.ch == to.ch)
                cm.setCursor(from.line, from.ch + curMode.commentStart.length);
            } else {
              var selText = cm.getRange(from, to);
              var startIndex = selText.indexOf(curMode.commentStart);
              var endIndex = selText.lastIndexOf(curMode.commentEnd);
              if (startIndex > -1 && endIndex > -1 && endIndex > startIndex) {
                selText = selText.substr(0, startIndex) + // From comment start till comment end
                selText.substring(startIndex + curMode.commentStart.length, endIndex) + // From comment end till string end
                selText.substr(endIndex + curMode.commentEnd.length);
              }
              cm.replaceRange(selText, from, to);
            }
          });
        });
        CodeMirror2.defineExtension("autoIndentRange", function(from, to) {
          var cmInstance = this;
          this.operation(function() {
            for (var i = from.line; i <= to.line; i++) {
              cmInstance.indentLine(i, "smart");
            }
          });
        });
        CodeMirror2.defineExtension("autoFormatRange", function(from, to) {
          var cm = this;
          var outer = cm.getMode(), text = cm.getRange(from, to).split("\n");
          var state = CodeMirror2.copyState(outer, cm.getTokenAt(from).state);
          var tabSize = cm.getOption("tabSize");
          var out = "", lines = 0, atSol = from.ch === 0;
          function newline() {
            out += "\n";
            atSol = true;
            ++lines;
          }
          for (var i = 0; i < text.length; ++i) {
            var stream = new CodeMirror2.StringStream(text[i], tabSize);
            while (!stream.eol()) {
              var inner = CodeMirror2.innerMode(outer, state);
              var style = outer.token(stream, state), cur = stream.current();
              stream.start = stream.pos;
              if (!atSol || /\S/.test(cur)) {
                out += cur;
                atSol = false;
              }
              if (!atSol && inner.mode.newlineAfterToken && inner.mode.newlineAfterToken(style, cur, stream.string.slice(stream.pos) || text[i + 1] || "", inner.state))
                newline();
            }
            if (!stream.pos && outer.blankLine)
              outer.blankLine(state);
            if (!atSol && i < text.length - 1)
              newline();
          }
          cm.operation(function() {
            cm.replaceRange(out, from, to);
            for (var cur2 = from.line + 1, end = from.line + lines; cur2 <= end; ++cur2)
              cm.indentLine(cur2, "smart");
            cm.setSelection(from, cm.getCursor(false));
          });
        });
      });
    }
  ),
  /***/
  237: (
    /***/
    function(module) {
      (function(global2, factory) {
        true ? module.exports = factory() : 0;
      })(this, function() {
        "use strict";
        var userAgent = navigator.userAgent;
        var platform = navigator.platform;
        var gecko = /gecko\/\d/i.test(userAgent);
        var ie_upto10 = /MSIE \d/.test(userAgent);
        var ie_11up = /Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(userAgent);
        var edge = /Edge\/(\d+)/.exec(userAgent);
        var ie = ie_upto10 || ie_11up || edge;
        var ie_version = ie && (ie_upto10 ? document.documentMode || 6 : +(edge || ie_11up)[1]);
        var webkit = !edge && /WebKit\//.test(userAgent);
        var qtwebkit = webkit && /Qt\/\d+\.\d+/.test(userAgent);
        var chrome = !edge && /Chrome\//.test(userAgent);
        var presto = /Opera\//.test(userAgent);
        var safari = /Apple Computer/.test(navigator.vendor);
        var mac_geMountainLion = /Mac OS X 1\d\D([8-9]|\d\d)\D/.test(userAgent);
        var phantom = /PhantomJS/.test(userAgent);
        var ios = safari && (/Mobile\/\w+/.test(userAgent) || navigator.maxTouchPoints > 2);
        var android = /Android/.test(userAgent);
        var mobile = ios || android || /webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(userAgent);
        var mac = ios || /Mac/.test(platform);
        var chromeOS = /\bCrOS\b/.test(userAgent);
        var windows = /win/i.test(platform);
        var presto_version = presto && userAgent.match(/Version\/(\d*\.\d*)/);
        if (presto_version) {
          presto_version = Number(presto_version[1]);
        }
        if (presto_version && presto_version >= 15) {
          presto = false;
          webkit = true;
        }
        var flipCtrlCmd = mac && (qtwebkit || presto && (presto_version == null || presto_version < 12.11));
        var captureRightClick = gecko || ie && ie_version >= 9;
        function classTest(cls) {
          return new RegExp("(^|\\s)" + cls + "(?:$|\\s)\\s*");
        }
        var rmClass = function(node, cls) {
          var current = node.className;
          var match = classTest(cls).exec(current);
          if (match) {
            var after = current.slice(match.index + match[0].length);
            node.className = current.slice(0, match.index) + (after ? match[1] + after : "");
          }
        };
        function removeChildren(e) {
          for (var count = e.childNodes.length; count > 0; --count) {
            e.removeChild(e.firstChild);
          }
          return e;
        }
        function removeChildrenAndAdd(parent, e) {
          return removeChildren(parent).appendChild(e);
        }
        function elt(tag, content, className, style) {
          var e = document.createElement(tag);
          if (className) {
            e.className = className;
          }
          if (style) {
            e.style.cssText = style;
          }
          if (typeof content == "string") {
            e.appendChild(document.createTextNode(content));
          } else if (content) {
            for (var i2 = 0; i2 < content.length; ++i2) {
              e.appendChild(content[i2]);
            }
          }
          return e;
        }
        function eltP(tag, content, className, style) {
          var e = elt(tag, content, className, style);
          e.setAttribute("role", "presentation");
          return e;
        }
        var range;
        if (document.createRange) {
          range = function(node, start, end, endNode) {
            var r = document.createRange();
            r.setEnd(endNode || node, end);
            r.setStart(node, start);
            return r;
          };
        } else {
          range = function(node, start, end) {
            var r = document.body.createTextRange();
            try {
              r.moveToElementText(node.parentNode);
            } catch (e) {
              return r;
            }
            r.collapse(true);
            r.moveEnd("character", end);
            r.moveStart("character", start);
            return r;
          };
        }
        function contains(parent, child) {
          if (child.nodeType == 3) {
            child = child.parentNode;
          }
          if (parent.contains) {
            return parent.contains(child);
          }
          do {
            if (child.nodeType == 11) {
              child = child.host;
            }
            if (child == parent) {
              return true;
            }
          } while (child = child.parentNode);
        }
        function activeElt() {
          var activeElement;
          try {
            activeElement = document.activeElement;
          } catch (e) {
            activeElement = document.body || null;
          }
          while (activeElement && activeElement.shadowRoot && activeElement.shadowRoot.activeElement) {
            activeElement = activeElement.shadowRoot.activeElement;
          }
          return activeElement;
        }
        function addClass(node, cls) {
          var current = node.className;
          if (!classTest(cls).test(current)) {
            node.className += (current ? " " : "") + cls;
          }
        }
        function joinClasses(a, b) {
          var as = a.split(" ");
          for (var i2 = 0; i2 < as.length; i2++) {
            if (as[i2] && !classTest(as[i2]).test(b)) {
              b += " " + as[i2];
            }
          }
          return b;
        }
        var selectInput = function(node) {
          node.select();
        };
        if (ios) {
          selectInput = function(node) {
            node.selectionStart = 0;
            node.selectionEnd = node.value.length;
          };
        } else if (ie) {
          selectInput = function(node) {
            try {
              node.select();
            } catch (_e) {
            }
          };
        }
        function bind2(f) {
          var args = Array.prototype.slice.call(arguments, 1);
          return function() {
            return f.apply(null, args);
          };
        }
        function copyObj(obj, target, overwrite) {
          if (!target) {
            target = {};
          }
          for (var prop2 in obj) {
            if (obj.hasOwnProperty(prop2) && (overwrite !== false || !target.hasOwnProperty(prop2))) {
              target[prop2] = obj[prop2];
            }
          }
          return target;
        }
        function countColumn(string, end, tabSize, startIndex, startValue) {
          if (end == null) {
            end = string.search(/[^\s\u00a0]/);
            if (end == -1) {
              end = string.length;
            }
          }
          for (var i2 = startIndex || 0, n = startValue || 0; ; ) {
            var nextTab = string.indexOf("	", i2);
            if (nextTab < 0 || nextTab >= end) {
              return n + (end - i2);
            }
            n += nextTab - i2;
            n += tabSize - n % tabSize;
            i2 = nextTab + 1;
          }
        }
        var Delayed = function() {
          this.id = null;
          this.f = null;
          this.time = 0;
          this.handler = bind2(this.onTimeout, this);
        };
        Delayed.prototype.onTimeout = function(self2) {
          self2.id = 0;
          if (self2.time <= +/* @__PURE__ */ new Date()) {
            self2.f();
          } else {
            setTimeout(self2.handler, self2.time - +/* @__PURE__ */ new Date());
          }
        };
        Delayed.prototype.set = function(ms, f) {
          this.f = f;
          var time = +/* @__PURE__ */ new Date() + ms;
          if (!this.id || time < this.time) {
            clearTimeout(this.id);
            this.id = setTimeout(this.handler, ms);
            this.time = time;
          }
        };
        function indexOf(array, elt2) {
          for (var i2 = 0; i2 < array.length; ++i2) {
            if (array[i2] == elt2) {
              return i2;
            }
          }
          return -1;
        }
        var scrollerGap = 50;
        var Pass = { toString: function() {
          return "CodeMirror.Pass";
        } };
        var sel_dontScroll = { scroll: false }, sel_mouse = { origin: "*mouse" }, sel_move = { origin: "+move" };
        function findColumn(string, goal, tabSize) {
          for (var pos = 0, col = 0; ; ) {
            var nextTab = string.indexOf("	", pos);
            if (nextTab == -1) {
              nextTab = string.length;
            }
            var skipped = nextTab - pos;
            if (nextTab == string.length || col + skipped >= goal) {
              return pos + Math.min(skipped, goal - col);
            }
            col += nextTab - pos;
            col += tabSize - col % tabSize;
            pos = nextTab + 1;
            if (col >= goal) {
              return pos;
            }
          }
        }
        var spaceStrs = [""];
        function spaceStr(n) {
          while (spaceStrs.length <= n) {
            spaceStrs.push(lst(spaceStrs) + " ");
          }
          return spaceStrs[n];
        }
        function lst(arr) {
          return arr[arr.length - 1];
        }
        function map(array, f) {
          var out = [];
          for (var i2 = 0; i2 < array.length; i2++) {
            out[i2] = f(array[i2], i2);
          }
          return out;
        }
        function insertSorted(array, value, score) {
          var pos = 0, priority = score(value);
          while (pos < array.length && score(array[pos]) <= priority) {
            pos++;
          }
          array.splice(pos, 0, value);
        }
        function nothing() {
        }
        function createObj(base, props) {
          var inst;
          if (Object.create) {
            inst = Object.create(base);
          } else {
            nothing.prototype = base;
            inst = new nothing();
          }
          if (props) {
            copyObj(props, inst);
          }
          return inst;
        }
        var nonASCIISingleCaseWordChar = /[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;
        function isWordCharBasic(ch) {
          return /\w/.test(ch) || ch > "" && (ch.toUpperCase() != ch.toLowerCase() || nonASCIISingleCaseWordChar.test(ch));
        }
        function isWordChar(ch, helper) {
          if (!helper) {
            return isWordCharBasic(ch);
          }
          if (helper.source.indexOf("\\w") > -1 && isWordCharBasic(ch)) {
            return true;
          }
          return helper.test(ch);
        }
        function isEmpty(obj) {
          for (var n in obj) {
            if (obj.hasOwnProperty(n) && obj[n]) {
              return false;
            }
          }
          return true;
        }
        var extendingChars = /[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;
        function isExtendingChar(ch) {
          return ch.charCodeAt(0) >= 768 && extendingChars.test(ch);
        }
        function skipExtendingChars(str, pos, dir) {
          while ((dir < 0 ? pos > 0 : pos < str.length) && isExtendingChar(str.charAt(pos))) {
            pos += dir;
          }
          return pos;
        }
        function findFirst(pred, from, to) {
          var dir = from > to ? -1 : 1;
          for (; ; ) {
            if (from == to) {
              return from;
            }
            var midF = (from + to) / 2, mid = dir < 0 ? Math.ceil(midF) : Math.floor(midF);
            if (mid == from) {
              return pred(mid) ? from : to;
            }
            if (pred(mid)) {
              to = mid;
            } else {
              from = mid + dir;
            }
          }
        }
        function iterateBidiSections(order, from, to, f) {
          if (!order) {
            return f(from, to, "ltr", 0);
          }
          var found = false;
          for (var i2 = 0; i2 < order.length; ++i2) {
            var part = order[i2];
            if (part.from < to && part.to > from || from == to && part.to == from) {
              f(Math.max(part.from, from), Math.min(part.to, to), part.level == 1 ? "rtl" : "ltr", i2);
              found = true;
            }
          }
          if (!found) {
            f(from, to, "ltr");
          }
        }
        var bidiOther = null;
        function getBidiPartAt(order, ch, sticky) {
          var found;
          bidiOther = null;
          for (var i2 = 0; i2 < order.length; ++i2) {
            var cur = order[i2];
            if (cur.from < ch && cur.to > ch) {
              return i2;
            }
            if (cur.to == ch) {
              if (cur.from != cur.to && sticky == "before") {
                found = i2;
              } else {
                bidiOther = i2;
              }
            }
            if (cur.from == ch) {
              if (cur.from != cur.to && sticky != "before") {
                found = i2;
              } else {
                bidiOther = i2;
              }
            }
          }
          return found != null ? found : bidiOther;
        }
        var bidiOrdering = /* @__PURE__ */ function() {
          var lowTypes = "bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN";
          var arabicTypes = "nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";
          function charType(code2) {
            if (code2 <= 247) {
              return lowTypes.charAt(code2);
            } else if (1424 <= code2 && code2 <= 1524) {
              return "R";
            } else if (1536 <= code2 && code2 <= 1785) {
              return arabicTypes.charAt(code2 - 1536);
            } else if (1774 <= code2 && code2 <= 2220) {
              return "r";
            } else if (8192 <= code2 && code2 <= 8203) {
              return "w";
            } else if (code2 == 8204) {
              return "b";
            } else {
              return "L";
            }
          }
          var bidiRE = /[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;
          var isNeutral = /[stwN]/, isStrong = /[LRr]/, countsAsLeft = /[Lb1n]/, countsAsNum = /[1n]/;
          function BidiSpan(level, from, to) {
            this.level = level;
            this.from = from;
            this.to = to;
          }
          return function(str, direction) {
            var outerType = direction == "ltr" ? "L" : "R";
            if (str.length == 0 || direction == "ltr" && !bidiRE.test(str)) {
              return false;
            }
            var len = str.length, types2 = [];
            for (var i2 = 0; i2 < len; ++i2) {
              types2.push(charType(str.charCodeAt(i2)));
            }
            for (var i$12 = 0, prev = outerType; i$12 < len; ++i$12) {
              var type2 = types2[i$12];
              if (type2 == "m") {
                types2[i$12] = prev;
              } else {
                prev = type2;
              }
            }
            for (var i$22 = 0, cur = outerType; i$22 < len; ++i$22) {
              var type$1 = types2[i$22];
              if (type$1 == "1" && cur == "r") {
                types2[i$22] = "n";
              } else if (isStrong.test(type$1)) {
                cur = type$1;
                if (type$1 == "r") {
                  types2[i$22] = "R";
                }
              }
            }
            for (var i$3 = 1, prev$1 = types2[0]; i$3 < len - 1; ++i$3) {
              var type$2 = types2[i$3];
              if (type$2 == "+" && prev$1 == "1" && types2[i$3 + 1] == "1") {
                types2[i$3] = "1";
              } else if (type$2 == "," && prev$1 == types2[i$3 + 1] && (prev$1 == "1" || prev$1 == "n")) {
                types2[i$3] = prev$1;
              }
              prev$1 = type$2;
            }
            for (var i$4 = 0; i$4 < len; ++i$4) {
              var type$3 = types2[i$4];
              if (type$3 == ",") {
                types2[i$4] = "N";
              } else if (type$3 == "%") {
                var end = void 0;
                for (end = i$4 + 1; end < len && types2[end] == "%"; ++end) {
                }
                var replace = i$4 && types2[i$4 - 1] == "!" || end < len && types2[end] == "1" ? "1" : "N";
                for (var j = i$4; j < end; ++j) {
                  types2[j] = replace;
                }
                i$4 = end - 1;
              }
            }
            for (var i$5 = 0, cur$1 = outerType; i$5 < len; ++i$5) {
              var type$4 = types2[i$5];
              if (cur$1 == "L" && type$4 == "1") {
                types2[i$5] = "L";
              } else if (isStrong.test(type$4)) {
                cur$1 = type$4;
              }
            }
            for (var i$6 = 0; i$6 < len; ++i$6) {
              if (isNeutral.test(types2[i$6])) {
                var end$1 = void 0;
                for (end$1 = i$6 + 1; end$1 < len && isNeutral.test(types2[end$1]); ++end$1) {
                }
                var before = (i$6 ? types2[i$6 - 1] : outerType) == "L";
                var after = (end$1 < len ? types2[end$1] : outerType) == "L";
                var replace$1 = before == after ? before ? "L" : "R" : outerType;
                for (var j$1 = i$6; j$1 < end$1; ++j$1) {
                  types2[j$1] = replace$1;
                }
                i$6 = end$1 - 1;
              }
            }
            var order = [], m;
            for (var i$7 = 0; i$7 < len; ) {
              if (countsAsLeft.test(types2[i$7])) {
                var start = i$7;
                for (++i$7; i$7 < len && countsAsLeft.test(types2[i$7]); ++i$7) {
                }
                order.push(new BidiSpan(0, start, i$7));
              } else {
                var pos = i$7, at = order.length, isRTL = direction == "rtl" ? 1 : 0;
                for (++i$7; i$7 < len && types2[i$7] != "L"; ++i$7) {
                }
                for (var j$2 = pos; j$2 < i$7; ) {
                  if (countsAsNum.test(types2[j$2])) {
                    if (pos < j$2) {
                      order.splice(at, 0, new BidiSpan(1, pos, j$2));
                      at += isRTL;
                    }
                    var nstart = j$2;
                    for (++j$2; j$2 < i$7 && countsAsNum.test(types2[j$2]); ++j$2) {
                    }
                    order.splice(at, 0, new BidiSpan(2, nstart, j$2));
                    at += isRTL;
                    pos = j$2;
                  } else {
                    ++j$2;
                  }
                }
                if (pos < i$7) {
                  order.splice(at, 0, new BidiSpan(1, pos, i$7));
                }
              }
            }
            if (direction == "ltr") {
              if (order[0].level == 1 && (m = str.match(/^\s+/))) {
                order[0].from = m[0].length;
                order.unshift(new BidiSpan(0, 0, m[0].length));
              }
              if (lst(order).level == 1 && (m = str.match(/\s+$/))) {
                lst(order).to -= m[0].length;
                order.push(new BidiSpan(0, len - m[0].length, len));
              }
            }
            return direction == "rtl" ? order.reverse() : order;
          };
        }();
        function getOrder(line, direction) {
          var order = line.order;
          if (order == null) {
            order = line.order = bidiOrdering(line.text, direction);
          }
          return order;
        }
        var noHandlers = [];
        var on = function(emitter, type2, f) {
          if (emitter.addEventListener) {
            emitter.addEventListener(type2, f, false);
          } else if (emitter.attachEvent) {
            emitter.attachEvent("on" + type2, f);
          } else {
            var map2 = emitter._handlers || (emitter._handlers = {});
            map2[type2] = (map2[type2] || noHandlers).concat(f);
          }
        };
        function getHandlers(emitter, type2) {
          return emitter._handlers && emitter._handlers[type2] || noHandlers;
        }
        function off(emitter, type2, f) {
          if (emitter.removeEventListener) {
            emitter.removeEventListener(type2, f, false);
          } else if (emitter.detachEvent) {
            emitter.detachEvent("on" + type2, f);
          } else {
            var map2 = emitter._handlers, arr = map2 && map2[type2];
            if (arr) {
              var index2 = indexOf(arr, f);
              if (index2 > -1) {
                map2[type2] = arr.slice(0, index2).concat(arr.slice(index2 + 1));
              }
            }
          }
        }
        function signal(emitter, type2) {
          var handlers = getHandlers(emitter, type2);
          if (!handlers.length) {
            return;
          }
          var args = Array.prototype.slice.call(arguments, 2);
          for (var i2 = 0; i2 < handlers.length; ++i2) {
            handlers[i2].apply(null, args);
          }
        }
        function signalDOMEvent(cm, e, override) {
          if (typeof e == "string") {
            e = { type: e, preventDefault: function() {
              this.defaultPrevented = true;
            } };
          }
          signal(cm, override || e.type, cm, e);
          return e_defaultPrevented(e) || e.codemirrorIgnore;
        }
        function signalCursorActivity(cm) {
          var arr = cm._handlers && cm._handlers.cursorActivity;
          if (!arr) {
            return;
          }
          var set = cm.curOp.cursorActivityHandlers || (cm.curOp.cursorActivityHandlers = []);
          for (var i2 = 0; i2 < arr.length; ++i2) {
            if (indexOf(set, arr[i2]) == -1) {
              set.push(arr[i2]);
            }
          }
        }
        function hasHandler(emitter, type2) {
          return getHandlers(emitter, type2).length > 0;
        }
        function eventMixin(ctor) {
          ctor.prototype.on = function(type2, f) {
            on(this, type2, f);
          };
          ctor.prototype.off = function(type2, f) {
            off(this, type2, f);
          };
        }
        function e_preventDefault(e) {
          if (e.preventDefault) {
            e.preventDefault();
          } else {
            e.returnValue = false;
          }
        }
        function e_stopPropagation(e) {
          if (e.stopPropagation) {
            e.stopPropagation();
          } else {
            e.cancelBubble = true;
          }
        }
        function e_defaultPrevented(e) {
          return e.defaultPrevented != null ? e.defaultPrevented : e.returnValue == false;
        }
        function e_stop(e) {
          e_preventDefault(e);
          e_stopPropagation(e);
        }
        function e_target(e) {
          return e.target || e.srcElement;
        }
        function e_button(e) {
          var b = e.which;
          if (b == null) {
            if (e.button & 1) {
              b = 1;
            } else if (e.button & 2) {
              b = 3;
            } else if (e.button & 4) {
              b = 2;
            }
          }
          if (mac && e.ctrlKey && b == 1) {
            b = 3;
          }
          return b;
        }
        var dragAndDrop = function() {
          if (ie && ie_version < 9) {
            return false;
          }
          var div = elt("div");
          return "draggable" in div || "dragDrop" in div;
        }();
        var zwspSupported;
        function zeroWidthElement(measure) {
          if (zwspSupported == null) {
            var test = elt("span", "​");
            removeChildrenAndAdd(measure, elt("span", [test, document.createTextNode("x")]));
            if (measure.firstChild.offsetHeight != 0) {
              zwspSupported = test.offsetWidth <= 1 && test.offsetHeight > 2 && !(ie && ie_version < 8);
            }
          }
          var node = zwspSupported ? elt("span", "​") : elt("span", " ", null, "display: inline-block; width: 1px; margin-right: -1px");
          node.setAttribute("cm-text", "");
          return node;
        }
        var badBidiRects;
        function hasBadBidiRects(measure) {
          if (badBidiRects != null) {
            return badBidiRects;
          }
          var txt = removeChildrenAndAdd(measure, document.createTextNode("AخA"));
          var r0 = range(txt, 0, 1).getBoundingClientRect();
          var r1 = range(txt, 1, 2).getBoundingClientRect();
          removeChildren(measure);
          if (!r0 || r0.left == r0.right) {
            return false;
          }
          return badBidiRects = r1.right - r0.right < 3;
        }
        var splitLinesAuto = "\n\nb".split(/\n/).length != 3 ? function(string) {
          var pos = 0, result = [], l = string.length;
          while (pos <= l) {
            var nl = string.indexOf("\n", pos);
            if (nl == -1) {
              nl = string.length;
            }
            var line = string.slice(pos, string.charAt(nl - 1) == "\r" ? nl - 1 : nl);
            var rt = line.indexOf("\r");
            if (rt != -1) {
              result.push(line.slice(0, rt));
              pos += rt + 1;
            } else {
              result.push(line);
              pos = nl + 1;
            }
          }
          return result;
        } : function(string) {
          return string.split(/\r\n?|\n/);
        };
        var hasSelection = window.getSelection ? function(te) {
          try {
            return te.selectionStart != te.selectionEnd;
          } catch (e) {
            return false;
          }
        } : function(te) {
          var range2;
          try {
            range2 = te.ownerDocument.selection.createRange();
          } catch (e) {
          }
          if (!range2 || range2.parentElement() != te) {
            return false;
          }
          return range2.compareEndPoints("StartToEnd", range2) != 0;
        };
        var hasCopyEvent = function() {
          var e = elt("div");
          if ("oncopy" in e) {
            return true;
          }
          e.setAttribute("oncopy", "return;");
          return typeof e.oncopy == "function";
        }();
        var badZoomedRects = null;
        function hasBadZoomedRects(measure) {
          if (badZoomedRects != null) {
            return badZoomedRects;
          }
          var node = removeChildrenAndAdd(measure, elt("span", "x"));
          var normal = node.getBoundingClientRect();
          var fromRange = range(node, 0, 1).getBoundingClientRect();
          return badZoomedRects = Math.abs(normal.left - fromRange.left) > 1;
        }
        var modes = {}, mimeModes = {};
        function defineMode(name, mode) {
          if (arguments.length > 2) {
            mode.dependencies = Array.prototype.slice.call(arguments, 2);
          }
          modes[name] = mode;
        }
        function defineMIME(mime, spec) {
          mimeModes[mime] = spec;
        }
        function resolveMode(spec) {
          if (typeof spec == "string" && mimeModes.hasOwnProperty(spec)) {
            spec = mimeModes[spec];
          } else if (spec && typeof spec.name == "string" && mimeModes.hasOwnProperty(spec.name)) {
            var found = mimeModes[spec.name];
            if (typeof found == "string") {
              found = { name: found };
            }
            spec = createObj(found, spec);
            spec.name = found.name;
          } else if (typeof spec == "string" && /^[\w\-]+\/[\w\-]+\+xml$/.test(spec)) {
            return resolveMode("application/xml");
          } else if (typeof spec == "string" && /^[\w\-]+\/[\w\-]+\+json$/.test(spec)) {
            return resolveMode("application/json");
          }
          if (typeof spec == "string") {
            return { name: spec };
          } else {
            return spec || { name: "null" };
          }
        }
        function getMode(options, spec) {
          spec = resolveMode(spec);
          var mfactory = modes[spec.name];
          if (!mfactory) {
            return getMode(options, "text/plain");
          }
          var modeObj = mfactory(options, spec);
          if (modeExtensions.hasOwnProperty(spec.name)) {
            var exts = modeExtensions[spec.name];
            for (var prop2 in exts) {
              if (!exts.hasOwnProperty(prop2)) {
                continue;
              }
              if (modeObj.hasOwnProperty(prop2)) {
                modeObj["_" + prop2] = modeObj[prop2];
              }
              modeObj[prop2] = exts[prop2];
            }
          }
          modeObj.name = spec.name;
          if (spec.helperType) {
            modeObj.helperType = spec.helperType;
          }
          if (spec.modeProps) {
            for (var prop$1 in spec.modeProps) {
              modeObj[prop$1] = spec.modeProps[prop$1];
            }
          }
          return modeObj;
        }
        var modeExtensions = {};
        function extendMode(mode, properties) {
          var exts = modeExtensions.hasOwnProperty(mode) ? modeExtensions[mode] : modeExtensions[mode] = {};
          copyObj(properties, exts);
        }
        function copyState(mode, state) {
          if (state === true) {
            return state;
          }
          if (mode.copyState) {
            return mode.copyState(state);
          }
          var nstate = {};
          for (var n in state) {
            var val = state[n];
            if (val instanceof Array) {
              val = val.concat([]);
            }
            nstate[n] = val;
          }
          return nstate;
        }
        function innerMode(mode, state) {
          var info;
          while (mode.innerMode) {
            info = mode.innerMode(state);
            if (!info || info.mode == mode) {
              break;
            }
            state = info.state;
            mode = info.mode;
          }
          return info || { mode, state };
        }
        function startState(mode, a1, a2) {
          return mode.startState ? mode.startState(a1, a2) : true;
        }
        var StringStream = function(string, tabSize, lineOracle) {
          this.pos = this.start = 0;
          this.string = string;
          this.tabSize = tabSize || 8;
          this.lastColumnPos = this.lastColumnValue = 0;
          this.lineStart = 0;
          this.lineOracle = lineOracle;
        };
        StringStream.prototype.eol = function() {
          return this.pos >= this.string.length;
        };
        StringStream.prototype.sol = function() {
          return this.pos == this.lineStart;
        };
        StringStream.prototype.peek = function() {
          return this.string.charAt(this.pos) || void 0;
        };
        StringStream.prototype.next = function() {
          if (this.pos < this.string.length) {
            return this.string.charAt(this.pos++);
          }
        };
        StringStream.prototype.eat = function(match) {
          var ch = this.string.charAt(this.pos);
          var ok;
          if (typeof match == "string") {
            ok = ch == match;
          } else {
            ok = ch && (match.test ? match.test(ch) : match(ch));
          }
          if (ok) {
            ++this.pos;
            return ch;
          }
        };
        StringStream.prototype.eatWhile = function(match) {
          var start = this.pos;
          while (this.eat(match)) {
          }
          return this.pos > start;
        };
        StringStream.prototype.eatSpace = function() {
          var start = this.pos;
          while (/[\s\u00a0]/.test(this.string.charAt(this.pos))) {
            ++this.pos;
          }
          return this.pos > start;
        };
        StringStream.prototype.skipToEnd = function() {
          this.pos = this.string.length;
        };
        StringStream.prototype.skipTo = function(ch) {
          var found = this.string.indexOf(ch, this.pos);
          if (found > -1) {
            this.pos = found;
            return true;
          }
        };
        StringStream.prototype.backUp = function(n) {
          this.pos -= n;
        };
        StringStream.prototype.column = function() {
          if (this.lastColumnPos < this.start) {
            this.lastColumnValue = countColumn(this.string, this.start, this.tabSize, this.lastColumnPos, this.lastColumnValue);
            this.lastColumnPos = this.start;
          }
          return this.lastColumnValue - (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0);
        };
        StringStream.prototype.indentation = function() {
          return countColumn(this.string, null, this.tabSize) - (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0);
        };
        StringStream.prototype.match = function(pattern, consume, caseInsensitive) {
          if (typeof pattern == "string") {
            var cased = function(str) {
              return caseInsensitive ? str.toLowerCase() : str;
            };
            var substr = this.string.substr(this.pos, pattern.length);
            if (cased(substr) == cased(pattern)) {
              if (consume !== false) {
                this.pos += pattern.length;
              }
              return true;
            }
          } else {
            var match = this.string.slice(this.pos).match(pattern);
            if (match && match.index > 0) {
              return null;
            }
            if (match && consume !== false) {
              this.pos += match[0].length;
            }
            return match;
          }
        };
        StringStream.prototype.current = function() {
          return this.string.slice(this.start, this.pos);
        };
        StringStream.prototype.hideFirstChars = function(n, inner) {
          this.lineStart += n;
          try {
            return inner();
          } finally {
            this.lineStart -= n;
          }
        };
        StringStream.prototype.lookAhead = function(n) {
          var oracle = this.lineOracle;
          return oracle && oracle.lookAhead(n);
        };
        StringStream.prototype.baseToken = function() {
          var oracle = this.lineOracle;
          return oracle && oracle.baseToken(this.pos);
        };
        function getLine(doc, n) {
          n -= doc.first;
          if (n < 0 || n >= doc.size) {
            throw new Error("There is no line " + (n + doc.first) + " in the document.");
          }
          var chunk = doc;
          while (!chunk.lines) {
            for (var i2 = 0; ; ++i2) {
              var child = chunk.children[i2], sz = child.chunkSize();
              if (n < sz) {
                chunk = child;
                break;
              }
              n -= sz;
            }
          }
          return chunk.lines[n];
        }
        function getBetween(doc, start, end) {
          var out = [], n = start.line;
          doc.iter(start.line, end.line + 1, function(line) {
            var text = line.text;
            if (n == end.line) {
              text = text.slice(0, end.ch);
            }
            if (n == start.line) {
              text = text.slice(start.ch);
            }
            out.push(text);
            ++n;
          });
          return out;
        }
        function getLines(doc, from, to) {
          var out = [];
          doc.iter(from, to, function(line) {
            out.push(line.text);
          });
          return out;
        }
        function updateLineHeight(line, height) {
          var diff = height - line.height;
          if (diff) {
            for (var n = line; n; n = n.parent) {
              n.height += diff;
            }
          }
        }
        function lineNo(line) {
          if (line.parent == null) {
            return null;
          }
          var cur = line.parent, no = indexOf(cur.lines, line);
          for (var chunk = cur.parent; chunk; cur = chunk, chunk = chunk.parent) {
            for (var i2 = 0; ; ++i2) {
              if (chunk.children[i2] == cur) {
                break;
              }
              no += chunk.children[i2].chunkSize();
            }
          }
          return no + cur.first;
        }
        function lineAtHeight(chunk, h) {
          var n = chunk.first;
          outer:
            do {
              for (var i$12 = 0; i$12 < chunk.children.length; ++i$12) {
                var child = chunk.children[i$12], ch = child.height;
                if (h < ch) {
                  chunk = child;
                  continue outer;
                }
                h -= ch;
                n += child.chunkSize();
              }
              return n;
            } while (!chunk.lines);
          var i2 = 0;
          for (; i2 < chunk.lines.length; ++i2) {
            var line = chunk.lines[i2], lh = line.height;
            if (h < lh) {
              break;
            }
            h -= lh;
          }
          return n + i2;
        }
        function isLine(doc, l) {
          return l >= doc.first && l < doc.first + doc.size;
        }
        function lineNumberFor(options, i2) {
          return String(options.lineNumberFormatter(i2 + options.firstLineNumber));
        }
        function Pos(line, ch, sticky) {
          if (sticky === void 0)
            sticky = null;
          if (!(this instanceof Pos)) {
            return new Pos(line, ch, sticky);
          }
          this.line = line;
          this.ch = ch;
          this.sticky = sticky;
        }
        function cmp(a, b) {
          return a.line - b.line || a.ch - b.ch;
        }
        function equalCursorPos(a, b) {
          return a.sticky == b.sticky && cmp(a, b) == 0;
        }
        function copyPos(x) {
          return Pos(x.line, x.ch);
        }
        function maxPos(a, b) {
          return cmp(a, b) < 0 ? b : a;
        }
        function minPos(a, b) {
          return cmp(a, b) < 0 ? a : b;
        }
        function clipLine(doc, n) {
          return Math.max(doc.first, Math.min(n, doc.first + doc.size - 1));
        }
        function clipPos(doc, pos) {
          if (pos.line < doc.first) {
            return Pos(doc.first, 0);
          }
          var last = doc.first + doc.size - 1;
          if (pos.line > last) {
            return Pos(last, getLine(doc, last).text.length);
          }
          return clipToLen(pos, getLine(doc, pos.line).text.length);
        }
        function clipToLen(pos, linelen) {
          var ch = pos.ch;
          if (ch == null || ch > linelen) {
            return Pos(pos.line, linelen);
          } else if (ch < 0) {
            return Pos(pos.line, 0);
          } else {
            return pos;
          }
        }
        function clipPosArray(doc, array) {
          var out = [];
          for (var i2 = 0; i2 < array.length; i2++) {
            out[i2] = clipPos(doc, array[i2]);
          }
          return out;
        }
        var SavedContext = function(state, lookAhead) {
          this.state = state;
          this.lookAhead = lookAhead;
        };
        var Context = function(doc, state, line, lookAhead) {
          this.state = state;
          this.doc = doc;
          this.line = line;
          this.maxLookAhead = lookAhead || 0;
          this.baseTokens = null;
          this.baseTokenPos = 1;
        };
        Context.prototype.lookAhead = function(n) {
          var line = this.doc.getLine(this.line + n);
          if (line != null && n > this.maxLookAhead) {
            this.maxLookAhead = n;
          }
          return line;
        };
        Context.prototype.baseToken = function(n) {
          if (!this.baseTokens) {
            return null;
          }
          while (this.baseTokens[this.baseTokenPos] <= n) {
            this.baseTokenPos += 2;
          }
          var type2 = this.baseTokens[this.baseTokenPos + 1];
          return {
            type: type2 && type2.replace(/( |^)overlay .*/, ""),
            size: this.baseTokens[this.baseTokenPos] - n
          };
        };
        Context.prototype.nextLine = function() {
          this.line++;
          if (this.maxLookAhead > 0) {
            this.maxLookAhead--;
          }
        };
        Context.fromSaved = function(doc, saved, line) {
          if (saved instanceof SavedContext) {
            return new Context(doc, copyState(doc.mode, saved.state), line, saved.lookAhead);
          } else {
            return new Context(doc, copyState(doc.mode, saved), line);
          }
        };
        Context.prototype.save = function(copy) {
          var state = copy !== false ? copyState(this.doc.mode, this.state) : this.state;
          return this.maxLookAhead > 0 ? new SavedContext(state, this.maxLookAhead) : state;
        };
        function highlightLine(cm, line, context, forceToEnd) {
          var st = [cm.state.modeGen], lineClasses = {};
          runMode(
            cm,
            line.text,
            cm.doc.mode,
            context,
            function(end, style) {
              return st.push(end, style);
            },
            lineClasses,
            forceToEnd
          );
          var state = context.state;
          var loop = function(o2) {
            context.baseTokens = st;
            var overlay = cm.state.overlays[o2], i2 = 1, at = 0;
            context.state = true;
            runMode(cm, line.text, overlay.mode, context, function(end, style) {
              var start = i2;
              while (at < end) {
                var i_end = st[i2];
                if (i_end > end) {
                  st.splice(i2, 1, end, st[i2 + 1], i_end);
                }
                i2 += 2;
                at = Math.min(end, i_end);
              }
              if (!style) {
                return;
              }
              if (overlay.opaque) {
                st.splice(start, i2 - start, end, "overlay " + style);
                i2 = start + 2;
              } else {
                for (; start < i2; start += 2) {
                  var cur = st[start + 1];
                  st[start + 1] = (cur ? cur + " " : "") + "overlay " + style;
                }
              }
            }, lineClasses);
            context.state = state;
            context.baseTokens = null;
            context.baseTokenPos = 1;
          };
          for (var o = 0; o < cm.state.overlays.length; ++o)
            loop(o);
          return { styles: st, classes: lineClasses.bgClass || lineClasses.textClass ? lineClasses : null };
        }
        function getLineStyles(cm, line, updateFrontier) {
          if (!line.styles || line.styles[0] != cm.state.modeGen) {
            var context = getContextBefore(cm, lineNo(line));
            var resetState = line.text.length > cm.options.maxHighlightLength && copyState(cm.doc.mode, context.state);
            var result = highlightLine(cm, line, context);
            if (resetState) {
              context.state = resetState;
            }
            line.stateAfter = context.save(!resetState);
            line.styles = result.styles;
            if (result.classes) {
              line.styleClasses = result.classes;
            } else if (line.styleClasses) {
              line.styleClasses = null;
            }
            if (updateFrontier === cm.doc.highlightFrontier) {
              cm.doc.modeFrontier = Math.max(cm.doc.modeFrontier, ++cm.doc.highlightFrontier);
            }
          }
          return line.styles;
        }
        function getContextBefore(cm, n, precise) {
          var doc = cm.doc, display = cm.display;
          if (!doc.mode.startState) {
            return new Context(doc, true, n);
          }
          var start = findStartLine(cm, n, precise);
          var saved = start > doc.first && getLine(doc, start - 1).stateAfter;
          var context = saved ? Context.fromSaved(doc, saved, start) : new Context(doc, startState(doc.mode), start);
          doc.iter(start, n, function(line) {
            processLine(cm, line.text, context);
            var pos = context.line;
            line.stateAfter = pos == n - 1 || pos % 5 == 0 || pos >= display.viewFrom && pos < display.viewTo ? context.save() : null;
            context.nextLine();
          });
          if (precise) {
            doc.modeFrontier = context.line;
          }
          return context;
        }
        function processLine(cm, text, context, startAt) {
          var mode = cm.doc.mode;
          var stream = new StringStream(text, cm.options.tabSize, context);
          stream.start = stream.pos = startAt || 0;
          if (text == "") {
            callBlankLine(mode, context.state);
          }
          while (!stream.eol()) {
            readToken(mode, stream, context.state);
            stream.start = stream.pos;
          }
        }
        function callBlankLine(mode, state) {
          if (mode.blankLine) {
            return mode.blankLine(state);
          }
          if (!mode.innerMode) {
            return;
          }
          var inner = innerMode(mode, state);
          if (inner.mode.blankLine) {
            return inner.mode.blankLine(inner.state);
          }
        }
        function readToken(mode, stream, state, inner) {
          for (var i2 = 0; i2 < 10; i2++) {
            if (inner) {
              inner[0] = innerMode(mode, state).mode;
            }
            var style = mode.token(stream, state);
            if (stream.pos > stream.start) {
              return style;
            }
          }
          throw new Error("Mode " + mode.name + " failed to advance stream.");
        }
        var Token = function(stream, type2, state) {
          this.start = stream.start;
          this.end = stream.pos;
          this.string = stream.current();
          this.type = type2 || null;
          this.state = state;
        };
        function takeToken(cm, pos, precise, asArray) {
          var doc = cm.doc, mode = doc.mode, style;
          pos = clipPos(doc, pos);
          var line = getLine(doc, pos.line), context = getContextBefore(cm, pos.line, precise);
          var stream = new StringStream(line.text, cm.options.tabSize, context), tokens;
          if (asArray) {
            tokens = [];
          }
          while ((asArray || stream.pos < pos.ch) && !stream.eol()) {
            stream.start = stream.pos;
            style = readToken(mode, stream, context.state);
            if (asArray) {
              tokens.push(new Token(stream, style, copyState(doc.mode, context.state)));
            }
          }
          return asArray ? tokens : new Token(stream, style, context.state);
        }
        function extractLineClasses(type2, output) {
          if (type2) {
            for (; ; ) {
              var lineClass = type2.match(/(?:^|\s+)line-(background-)?(\S+)/);
              if (!lineClass) {
                break;
              }
              type2 = type2.slice(0, lineClass.index) + type2.slice(lineClass.index + lineClass[0].length);
              var prop2 = lineClass[1] ? "bgClass" : "textClass";
              if (output[prop2] == null) {
                output[prop2] = lineClass[2];
              } else if (!new RegExp("(?:^|\\s)" + lineClass[2] + "(?:$|\\s)").test(output[prop2])) {
                output[prop2] += " " + lineClass[2];
              }
            }
          }
          return type2;
        }
        function runMode(cm, text, mode, context, f, lineClasses, forceToEnd) {
          var flattenSpans = mode.flattenSpans;
          if (flattenSpans == null) {
            flattenSpans = cm.options.flattenSpans;
          }
          var curStart = 0, curStyle = null;
          var stream = new StringStream(text, cm.options.tabSize, context), style;
          var inner = cm.options.addModeClass && [null];
          if (text == "") {
            extractLineClasses(callBlankLine(mode, context.state), lineClasses);
          }
          while (!stream.eol()) {
            if (stream.pos > cm.options.maxHighlightLength) {
              flattenSpans = false;
              if (forceToEnd) {
                processLine(cm, text, context, stream.pos);
              }
              stream.pos = text.length;
              style = null;
            } else {
              style = extractLineClasses(readToken(mode, stream, context.state, inner), lineClasses);
            }
            if (inner) {
              var mName = inner[0].name;
              if (mName) {
                style = "m-" + (style ? mName + " " + style : mName);
              }
            }
            if (!flattenSpans || curStyle != style) {
              while (curStart < stream.start) {
                curStart = Math.min(stream.start, curStart + 5e3);
                f(curStart, curStyle);
              }
              curStyle = style;
            }
            stream.start = stream.pos;
          }
          while (curStart < stream.pos) {
            var pos = Math.min(stream.pos, curStart + 5e3);
            f(pos, curStyle);
            curStart = pos;
          }
        }
        function findStartLine(cm, n, precise) {
          var minindent, minline, doc = cm.doc;
          var lim = precise ? -1 : n - (cm.doc.mode.innerMode ? 1e3 : 100);
          for (var search = n; search > lim; --search) {
            if (search <= doc.first) {
              return doc.first;
            }
            var line = getLine(doc, search - 1), after = line.stateAfter;
            if (after && (!precise || search + (after instanceof SavedContext ? after.lookAhead : 0) <= doc.modeFrontier)) {
              return search;
            }
            var indented = countColumn(line.text, null, cm.options.tabSize);
            if (minline == null || minindent > indented) {
              minline = search - 1;
              minindent = indented;
            }
          }
          return minline;
        }
        function retreatFrontier(doc, n) {
          doc.modeFrontier = Math.min(doc.modeFrontier, n);
          if (doc.highlightFrontier < n - 10) {
            return;
          }
          var start = doc.first;
          for (var line = n - 1; line > start; line--) {
            var saved = getLine(doc, line).stateAfter;
            if (saved && (!(saved instanceof SavedContext) || line + saved.lookAhead < n)) {
              start = line + 1;
              break;
            }
          }
          doc.highlightFrontier = Math.min(doc.highlightFrontier, start);
        }
        var sawReadOnlySpans = false, sawCollapsedSpans = false;
        function seeReadOnlySpans() {
          sawReadOnlySpans = true;
        }
        function seeCollapsedSpans() {
          sawCollapsedSpans = true;
        }
        function MarkedSpan(marker, from, to) {
          this.marker = marker;
          this.from = from;
          this.to = to;
        }
        function getMarkedSpanFor(spans, marker) {
          if (spans) {
            for (var i2 = 0; i2 < spans.length; ++i2) {
              var span = spans[i2];
              if (span.marker == marker) {
                return span;
              }
            }
          }
        }
        function removeMarkedSpan(spans, span) {
          var r;
          for (var i2 = 0; i2 < spans.length; ++i2) {
            if (spans[i2] != span) {
              (r || (r = [])).push(spans[i2]);
            }
          }
          return r;
        }
        function addMarkedSpan(line, span, op) {
          var inThisOp = op && window.WeakSet && (op.markedSpans || (op.markedSpans = /* @__PURE__ */ new WeakSet()));
          if (inThisOp && inThisOp.has(line.markedSpans)) {
            line.markedSpans.push(span);
          } else {
            line.markedSpans = line.markedSpans ? line.markedSpans.concat([span]) : [span];
            if (inThisOp) {
              inThisOp.add(line.markedSpans);
            }
          }
          span.marker.attachLine(line);
        }
        function markedSpansBefore(old, startCh, isInsert) {
          var nw;
          if (old) {
            for (var i2 = 0; i2 < old.length; ++i2) {
              var span = old[i2], marker = span.marker;
              var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= startCh : span.from < startCh);
              if (startsBefore || span.from == startCh && marker.type == "bookmark" && (!isInsert || !span.marker.insertLeft)) {
                var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= startCh : span.to > startCh);
                (nw || (nw = [])).push(new MarkedSpan(marker, span.from, endsAfter ? null : span.to));
              }
            }
          }
          return nw;
        }
        function markedSpansAfter(old, endCh, isInsert) {
          var nw;
          if (old) {
            for (var i2 = 0; i2 < old.length; ++i2) {
              var span = old[i2], marker = span.marker;
              var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= endCh : span.to > endCh);
              if (endsAfter || span.from == endCh && marker.type == "bookmark" && (!isInsert || span.marker.insertLeft)) {
                var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= endCh : span.from < endCh);
                (nw || (nw = [])).push(new MarkedSpan(
                  marker,
                  startsBefore ? null : span.from - endCh,
                  span.to == null ? null : span.to - endCh
                ));
              }
            }
          }
          return nw;
        }
        function stretchSpansOverChange(doc, change) {
          if (change.full) {
            return null;
          }
          var oldFirst = isLine(doc, change.from.line) && getLine(doc, change.from.line).markedSpans;
          var oldLast = isLine(doc, change.to.line) && getLine(doc, change.to.line).markedSpans;
          if (!oldFirst && !oldLast) {
            return null;
          }
          var startCh = change.from.ch, endCh = change.to.ch, isInsert = cmp(change.from, change.to) == 0;
          var first = markedSpansBefore(oldFirst, startCh, isInsert);
          var last = markedSpansAfter(oldLast, endCh, isInsert);
          var sameLine = change.text.length == 1, offset = lst(change.text).length + (sameLine ? startCh : 0);
          if (first) {
            for (var i2 = 0; i2 < first.length; ++i2) {
              var span = first[i2];
              if (span.to == null) {
                var found = getMarkedSpanFor(last, span.marker);
                if (!found) {
                  span.to = startCh;
                } else if (sameLine) {
                  span.to = found.to == null ? null : found.to + offset;
                }
              }
            }
          }
          if (last) {
            for (var i$12 = 0; i$12 < last.length; ++i$12) {
              var span$1 = last[i$12];
              if (span$1.to != null) {
                span$1.to += offset;
              }
              if (span$1.from == null) {
                var found$1 = getMarkedSpanFor(first, span$1.marker);
                if (!found$1) {
                  span$1.from = offset;
                  if (sameLine) {
                    (first || (first = [])).push(span$1);
                  }
                }
              } else {
                span$1.from += offset;
                if (sameLine) {
                  (first || (first = [])).push(span$1);
                }
              }
            }
          }
          if (first) {
            first = clearEmptySpans(first);
          }
          if (last && last != first) {
            last = clearEmptySpans(last);
          }
          var newMarkers = [first];
          if (!sameLine) {
            var gap = change.text.length - 2, gapMarkers;
            if (gap > 0 && first) {
              for (var i$22 = 0; i$22 < first.length; ++i$22) {
                if (first[i$22].to == null) {
                  (gapMarkers || (gapMarkers = [])).push(new MarkedSpan(first[i$22].marker, null, null));
                }
              }
            }
            for (var i$3 = 0; i$3 < gap; ++i$3) {
              newMarkers.push(gapMarkers);
            }
            newMarkers.push(last);
          }
          return newMarkers;
        }
        function clearEmptySpans(spans) {
          for (var i2 = 0; i2 < spans.length; ++i2) {
            var span = spans[i2];
            if (span.from != null && span.from == span.to && span.marker.clearWhenEmpty !== false) {
              spans.splice(i2--, 1);
            }
          }
          if (!spans.length) {
            return null;
          }
          return spans;
        }
        function removeReadOnlyRanges(doc, from, to) {
          var markers = null;
          doc.iter(from.line, to.line + 1, function(line) {
            if (line.markedSpans) {
              for (var i3 = 0; i3 < line.markedSpans.length; ++i3) {
                var mark = line.markedSpans[i3].marker;
                if (mark.readOnly && (!markers || indexOf(markers, mark) == -1)) {
                  (markers || (markers = [])).push(mark);
                }
              }
            }
          });
          if (!markers) {
            return null;
          }
          var parts = [{ from, to }];
          for (var i2 = 0; i2 < markers.length; ++i2) {
            var mk = markers[i2], m = mk.find(0);
            for (var j = 0; j < parts.length; ++j) {
              var p = parts[j];
              if (cmp(p.to, m.from) < 0 || cmp(p.from, m.to) > 0) {
                continue;
              }
              var newParts = [j, 1], dfrom = cmp(p.from, m.from), dto = cmp(p.to, m.to);
              if (dfrom < 0 || !mk.inclusiveLeft && !dfrom) {
                newParts.push({ from: p.from, to: m.from });
              }
              if (dto > 0 || !mk.inclusiveRight && !dto) {
                newParts.push({ from: m.to, to: p.to });
              }
              parts.splice.apply(parts, newParts);
              j += newParts.length - 3;
            }
          }
          return parts;
        }
        function detachMarkedSpans(line) {
          var spans = line.markedSpans;
          if (!spans) {
            return;
          }
          for (var i2 = 0; i2 < spans.length; ++i2) {
            spans[i2].marker.detachLine(line);
          }
          line.markedSpans = null;
        }
        function attachMarkedSpans(line, spans) {
          if (!spans) {
            return;
          }
          for (var i2 = 0; i2 < spans.length; ++i2) {
            spans[i2].marker.attachLine(line);
          }
          line.markedSpans = spans;
        }
        function extraLeft(marker) {
          return marker.inclusiveLeft ? -1 : 0;
        }
        function extraRight(marker) {
          return marker.inclusiveRight ? 1 : 0;
        }
        function compareCollapsedMarkers(a, b) {
          var lenDiff = a.lines.length - b.lines.length;
          if (lenDiff != 0) {
            return lenDiff;
          }
          var aPos = a.find(), bPos = b.find();
          var fromCmp = cmp(aPos.from, bPos.from) || extraLeft(a) - extraLeft(b);
          if (fromCmp) {
            return -fromCmp;
          }
          var toCmp = cmp(aPos.to, bPos.to) || extraRight(a) - extraRight(b);
          if (toCmp) {
            return toCmp;
          }
          return b.id - a.id;
        }
        function collapsedSpanAtSide(line, start) {
          var sps = sawCollapsedSpans && line.markedSpans, found;
          if (sps) {
            for (var sp = void 0, i2 = 0; i2 < sps.length; ++i2) {
              sp = sps[i2];
              if (sp.marker.collapsed && (start ? sp.from : sp.to) == null && (!found || compareCollapsedMarkers(found, sp.marker) < 0)) {
                found = sp.marker;
              }
            }
          }
          return found;
        }
        function collapsedSpanAtStart(line) {
          return collapsedSpanAtSide(line, true);
        }
        function collapsedSpanAtEnd(line) {
          return collapsedSpanAtSide(line, false);
        }
        function collapsedSpanAround(line, ch) {
          var sps = sawCollapsedSpans && line.markedSpans, found;
          if (sps) {
            for (var i2 = 0; i2 < sps.length; ++i2) {
              var sp = sps[i2];
              if (sp.marker.collapsed && (sp.from == null || sp.from < ch) && (sp.to == null || sp.to > ch) && (!found || compareCollapsedMarkers(found, sp.marker) < 0)) {
                found = sp.marker;
              }
            }
          }
          return found;
        }
        function conflictingCollapsedRange(doc, lineNo2, from, to, marker) {
          var line = getLine(doc, lineNo2);
          var sps = sawCollapsedSpans && line.markedSpans;
          if (sps) {
            for (var i2 = 0; i2 < sps.length; ++i2) {
              var sp = sps[i2];
              if (!sp.marker.collapsed) {
                continue;
              }
              var found = sp.marker.find(0);
              var fromCmp = cmp(found.from, from) || extraLeft(sp.marker) - extraLeft(marker);
              var toCmp = cmp(found.to, to) || extraRight(sp.marker) - extraRight(marker);
              if (fromCmp >= 0 && toCmp <= 0 || fromCmp <= 0 && toCmp >= 0) {
                continue;
              }
              if (fromCmp <= 0 && (sp.marker.inclusiveRight && marker.inclusiveLeft ? cmp(found.to, from) >= 0 : cmp(found.to, from) > 0) || fromCmp >= 0 && (sp.marker.inclusiveRight && marker.inclusiveLeft ? cmp(found.from, to) <= 0 : cmp(found.from, to) < 0)) {
                return true;
              }
            }
          }
        }
        function visualLine(line) {
          var merged;
          while (merged = collapsedSpanAtStart(line)) {
            line = merged.find(-1, true).line;
          }
          return line;
        }
        function visualLineEnd(line) {
          var merged;
          while (merged = collapsedSpanAtEnd(line)) {
            line = merged.find(1, true).line;
          }
          return line;
        }
        function visualLineContinued(line) {
          var merged, lines;
          while (merged = collapsedSpanAtEnd(line)) {
            line = merged.find(1, true).line;
            (lines || (lines = [])).push(line);
          }
          return lines;
        }
        function visualLineNo(doc, lineN) {
          var line = getLine(doc, lineN), vis = visualLine(line);
          if (line == vis) {
            return lineN;
          }
          return lineNo(vis);
        }
        function visualLineEndNo(doc, lineN) {
          if (lineN > doc.lastLine()) {
            return lineN;
          }
          var line = getLine(doc, lineN), merged;
          if (!lineIsHidden(doc, line)) {
            return lineN;
          }
          while (merged = collapsedSpanAtEnd(line)) {
            line = merged.find(1, true).line;
          }
          return lineNo(line) + 1;
        }
        function lineIsHidden(doc, line) {
          var sps = sawCollapsedSpans && line.markedSpans;
          if (sps) {
            for (var sp = void 0, i2 = 0; i2 < sps.length; ++i2) {
              sp = sps[i2];
              if (!sp.marker.collapsed) {
                continue;
              }
              if (sp.from == null) {
                return true;
              }
              if (sp.marker.widgetNode) {
                continue;
              }
              if (sp.from == 0 && sp.marker.inclusiveLeft && lineIsHiddenInner(doc, line, sp)) {
                return true;
              }
            }
          }
        }
        function lineIsHiddenInner(doc, line, span) {
          if (span.to == null) {
            var end = span.marker.find(1, true);
            return lineIsHiddenInner(doc, end.line, getMarkedSpanFor(end.line.markedSpans, span.marker));
          }
          if (span.marker.inclusiveRight && span.to == line.text.length) {
            return true;
          }
          for (var sp = void 0, i2 = 0; i2 < line.markedSpans.length; ++i2) {
            sp = line.markedSpans[i2];
            if (sp.marker.collapsed && !sp.marker.widgetNode && sp.from == span.to && (sp.to == null || sp.to != span.from) && (sp.marker.inclusiveLeft || span.marker.inclusiveRight) && lineIsHiddenInner(doc, line, sp)) {
              return true;
            }
          }
        }
        function heightAtLine(lineObj) {
          lineObj = visualLine(lineObj);
          var h = 0, chunk = lineObj.parent;
          for (var i2 = 0; i2 < chunk.lines.length; ++i2) {
            var line = chunk.lines[i2];
            if (line == lineObj) {
              break;
            } else {
              h += line.height;
            }
          }
          for (var p = chunk.parent; p; chunk = p, p = chunk.parent) {
            for (var i$12 = 0; i$12 < p.children.length; ++i$12) {
              var cur = p.children[i$12];
              if (cur == chunk) {
                break;
              } else {
                h += cur.height;
              }
            }
          }
          return h;
        }
        function lineLength(line) {
          if (line.height == 0) {
            return 0;
          }
          var len = line.text.length, merged, cur = line;
          while (merged = collapsedSpanAtStart(cur)) {
            var found = merged.find(0, true);
            cur = found.from.line;
            len += found.from.ch - found.to.ch;
          }
          cur = line;
          while (merged = collapsedSpanAtEnd(cur)) {
            var found$1 = merged.find(0, true);
            len -= cur.text.length - found$1.from.ch;
            cur = found$1.to.line;
            len += cur.text.length - found$1.to.ch;
          }
          return len;
        }
        function findMaxLine(cm) {
          var d = cm.display, doc = cm.doc;
          d.maxLine = getLine(doc, doc.first);
          d.maxLineLength = lineLength(d.maxLine);
          d.maxLineChanged = true;
          doc.iter(function(line) {
            var len = lineLength(line);
            if (len > d.maxLineLength) {
              d.maxLineLength = len;
              d.maxLine = line;
            }
          });
        }
        var Line = function(text, markedSpans, estimateHeight2) {
          this.text = text;
          attachMarkedSpans(this, markedSpans);
          this.height = estimateHeight2 ? estimateHeight2(this) : 1;
        };
        Line.prototype.lineNo = function() {
          return lineNo(this);
        };
        eventMixin(Line);
        function updateLine(line, text, markedSpans, estimateHeight2) {
          line.text = text;
          if (line.stateAfter) {
            line.stateAfter = null;
          }
          if (line.styles) {
            line.styles = null;
          }
          if (line.order != null) {
            line.order = null;
          }
          detachMarkedSpans(line);
          attachMarkedSpans(line, markedSpans);
          var estHeight = estimateHeight2 ? estimateHeight2(line) : 1;
          if (estHeight != line.height) {
            updateLineHeight(line, estHeight);
          }
        }
        function cleanUpLine(line) {
          line.parent = null;
          detachMarkedSpans(line);
        }
        var styleToClassCache = {}, styleToClassCacheWithMode = {};
        function interpretTokenStyle(style, options) {
          if (!style || /^\s*$/.test(style)) {
            return null;
          }
          var cache = options.addModeClass ? styleToClassCacheWithMode : styleToClassCache;
          return cache[style] || (cache[style] = style.replace(/\S+/g, "cm-$&"));
        }
        function buildLineContent(cm, lineView) {
          var content = eltP("span", null, null, webkit ? "padding-right: .1px" : null);
          var builder = {
            pre: eltP("pre", [content], "CodeMirror-line"),
            content,
            col: 0,
            pos: 0,
            cm,
            trailingSpace: false,
            splitSpaces: cm.getOption("lineWrapping")
          };
          lineView.measure = {};
          for (var i2 = 0; i2 <= (lineView.rest ? lineView.rest.length : 0); i2++) {
            var line = i2 ? lineView.rest[i2 - 1] : lineView.line, order = void 0;
            builder.pos = 0;
            builder.addToken = buildToken;
            if (hasBadBidiRects(cm.display.measure) && (order = getOrder(line, cm.doc.direction))) {
              builder.addToken = buildTokenBadBidi(builder.addToken, order);
            }
            builder.map = [];
            var allowFrontierUpdate = lineView != cm.display.externalMeasured && lineNo(line);
            insertLineContent(line, builder, getLineStyles(cm, line, allowFrontierUpdate));
            if (line.styleClasses) {
              if (line.styleClasses.bgClass) {
                builder.bgClass = joinClasses(line.styleClasses.bgClass, builder.bgClass || "");
              }
              if (line.styleClasses.textClass) {
                builder.textClass = joinClasses(line.styleClasses.textClass, builder.textClass || "");
              }
            }
            if (builder.map.length == 0) {
              builder.map.push(0, 0, builder.content.appendChild(zeroWidthElement(cm.display.measure)));
            }
            if (i2 == 0) {
              lineView.measure.map = builder.map;
              lineView.measure.cache = {};
            } else {
              (lineView.measure.maps || (lineView.measure.maps = [])).push(builder.map);
              (lineView.measure.caches || (lineView.measure.caches = [])).push({});
            }
          }
          if (webkit) {
            var last = builder.content.lastChild;
            if (/\bcm-tab\b/.test(last.className) || last.querySelector && last.querySelector(".cm-tab")) {
              builder.content.className = "cm-tab-wrap-hack";
            }
          }
          signal(cm, "renderLine", cm, lineView.line, builder.pre);
          if (builder.pre.className) {
            builder.textClass = joinClasses(builder.pre.className, builder.textClass || "");
          }
          return builder;
        }
        function defaultSpecialCharPlaceholder(ch) {
          var token = elt("span", "•", "cm-invalidchar");
          token.title = "\\u" + ch.charCodeAt(0).toString(16);
          token.setAttribute("aria-label", token.title);
          return token;
        }
        function buildToken(builder, text, style, startStyle, endStyle, css, attributes) {
          if (!text) {
            return;
          }
          var displayText = builder.splitSpaces ? splitSpaces(text, builder.trailingSpace) : text;
          var special = builder.cm.state.specialChars, mustWrap = false;
          var content;
          if (!special.test(text)) {
            builder.col += text.length;
            content = document.createTextNode(displayText);
            builder.map.push(builder.pos, builder.pos + text.length, content);
            if (ie && ie_version < 9) {
              mustWrap = true;
            }
            builder.pos += text.length;
          } else {
            content = document.createDocumentFragment();
            var pos = 0;
            while (true) {
              special.lastIndex = pos;
              var m = special.exec(text);
              var skipped = m ? m.index - pos : text.length - pos;
              if (skipped) {
                var txt = document.createTextNode(displayText.slice(pos, pos + skipped));
                if (ie && ie_version < 9) {
                  content.appendChild(elt("span", [txt]));
                } else {
                  content.appendChild(txt);
                }
                builder.map.push(builder.pos, builder.pos + skipped, txt);
                builder.col += skipped;
                builder.pos += skipped;
              }
              if (!m) {
                break;
              }
              pos += skipped + 1;
              var txt$1 = void 0;
              if (m[0] == "	") {
                var tabSize = builder.cm.options.tabSize, tabWidth = tabSize - builder.col % tabSize;
                txt$1 = content.appendChild(elt("span", spaceStr(tabWidth), "cm-tab"));
                txt$1.setAttribute("role", "presentation");
                txt$1.setAttribute("cm-text", "	");
                builder.col += tabWidth;
              } else if (m[0] == "\r" || m[0] == "\n") {
                txt$1 = content.appendChild(elt("span", m[0] == "\r" ? "␍" : "␤", "cm-invalidchar"));
                txt$1.setAttribute("cm-text", m[0]);
                builder.col += 1;
              } else {
                txt$1 = builder.cm.options.specialCharPlaceholder(m[0]);
                txt$1.setAttribute("cm-text", m[0]);
                if (ie && ie_version < 9) {
                  content.appendChild(elt("span", [txt$1]));
                } else {
                  content.appendChild(txt$1);
                }
                builder.col += 1;
              }
              builder.map.push(builder.pos, builder.pos + 1, txt$1);
              builder.pos++;
            }
          }
          builder.trailingSpace = displayText.charCodeAt(text.length - 1) == 32;
          if (style || startStyle || endStyle || mustWrap || css || attributes) {
            var fullStyle = style || "";
            if (startStyle) {
              fullStyle += startStyle;
            }
            if (endStyle) {
              fullStyle += endStyle;
            }
            var token = elt("span", [content], fullStyle, css);
            if (attributes) {
              for (var attr in attributes) {
                if (attributes.hasOwnProperty(attr) && attr != "style" && attr != "class") {
                  token.setAttribute(attr, attributes[attr]);
                }
              }
            }
            return builder.content.appendChild(token);
          }
          builder.content.appendChild(content);
        }
        function splitSpaces(text, trailingBefore) {
          if (text.length > 1 && !/  /.test(text)) {
            return text;
          }
          var spaceBefore = trailingBefore, result = "";
          for (var i2 = 0; i2 < text.length; i2++) {
            var ch = text.charAt(i2);
            if (ch == " " && spaceBefore && (i2 == text.length - 1 || text.charCodeAt(i2 + 1) == 32)) {
              ch = " ";
            }
            result += ch;
            spaceBefore = ch == " ";
          }
          return result;
        }
        function buildTokenBadBidi(inner, order) {
          return function(builder, text, style, startStyle, endStyle, css, attributes) {
            style = style ? style + " cm-force-border" : "cm-force-border";
            var start = builder.pos, end = start + text.length;
            for (; ; ) {
              var part = void 0;
              for (var i2 = 0; i2 < order.length; i2++) {
                part = order[i2];
                if (part.to > start && part.from <= start) {
                  break;
                }
              }
              if (part.to >= end) {
                return inner(builder, text, style, startStyle, endStyle, css, attributes);
              }
              inner(builder, text.slice(0, part.to - start), style, startStyle, null, css, attributes);
              startStyle = null;
              text = text.slice(part.to - start);
              start = part.to;
            }
          };
        }
        function buildCollapsedSpan(builder, size, marker, ignoreWidget) {
          var widget = !ignoreWidget && marker.widgetNode;
          if (widget) {
            builder.map.push(builder.pos, builder.pos + size, widget);
          }
          if (!ignoreWidget && builder.cm.display.input.needsContentAttribute) {
            if (!widget) {
              widget = builder.content.appendChild(document.createElement("span"));
            }
            widget.setAttribute("cm-marker", marker.id);
          }
          if (widget) {
            builder.cm.display.input.setUneditable(widget);
            builder.content.appendChild(widget);
          }
          builder.pos += size;
          builder.trailingSpace = false;
        }
        function insertLineContent(line, builder, styles) {
          var spans = line.markedSpans, allText = line.text, at = 0;
          if (!spans) {
            for (var i$12 = 1; i$12 < styles.length; i$12 += 2) {
              builder.addToken(builder, allText.slice(at, at = styles[i$12]), interpretTokenStyle(styles[i$12 + 1], builder.cm.options));
            }
            return;
          }
          var len = allText.length, pos = 0, i2 = 1, text = "", style, css;
          var nextChange = 0, spanStyle, spanEndStyle, spanStartStyle, collapsed, attributes;
          for (; ; ) {
            if (nextChange == pos) {
              spanStyle = spanEndStyle = spanStartStyle = css = "";
              attributes = null;
              collapsed = null;
              nextChange = Infinity;
              var foundBookmarks = [], endStyles = void 0;
              for (var j = 0; j < spans.length; ++j) {
                var sp = spans[j], m = sp.marker;
                if (m.type == "bookmark" && sp.from == pos && m.widgetNode) {
                  foundBookmarks.push(m);
                } else if (sp.from <= pos && (sp.to == null || sp.to > pos || m.collapsed && sp.to == pos && sp.from == pos)) {
                  if (sp.to != null && sp.to != pos && nextChange > sp.to) {
                    nextChange = sp.to;
                    spanEndStyle = "";
                  }
                  if (m.className) {
                    spanStyle += " " + m.className;
                  }
                  if (m.css) {
                    css = (css ? css + ";" : "") + m.css;
                  }
                  if (m.startStyle && sp.from == pos) {
                    spanStartStyle += " " + m.startStyle;
                  }
                  if (m.endStyle && sp.to == nextChange) {
                    (endStyles || (endStyles = [])).push(m.endStyle, sp.to);
                  }
                  if (m.title) {
                    (attributes || (attributes = {})).title = m.title;
                  }
                  if (m.attributes) {
                    for (var attr in m.attributes) {
                      (attributes || (attributes = {}))[attr] = m.attributes[attr];
                    }
                  }
                  if (m.collapsed && (!collapsed || compareCollapsedMarkers(collapsed.marker, m) < 0)) {
                    collapsed = sp;
                  }
                } else if (sp.from > pos && nextChange > sp.from) {
                  nextChange = sp.from;
                }
              }
              if (endStyles) {
                for (var j$1 = 0; j$1 < endStyles.length; j$1 += 2) {
                  if (endStyles[j$1 + 1] == nextChange) {
                    spanEndStyle += " " + endStyles[j$1];
                  }
                }
              }
              if (!collapsed || collapsed.from == pos) {
                for (var j$2 = 0; j$2 < foundBookmarks.length; ++j$2) {
                  buildCollapsedSpan(builder, 0, foundBookmarks[j$2]);
                }
              }
              if (collapsed && (collapsed.from || 0) == pos) {
                buildCollapsedSpan(
                  builder,
                  (collapsed.to == null ? len + 1 : collapsed.to) - pos,
                  collapsed.marker,
                  collapsed.from == null
                );
                if (collapsed.to == null) {
                  return;
                }
                if (collapsed.to == pos) {
                  collapsed = false;
                }
              }
            }
            if (pos >= len) {
              break;
            }
            var upto = Math.min(len, nextChange);
            while (true) {
              if (text) {
                var end = pos + text.length;
                if (!collapsed) {
                  var tokenText = end > upto ? text.slice(0, upto - pos) : text;
                  builder.addToken(
                    builder,
                    tokenText,
                    style ? style + spanStyle : spanStyle,
                    spanStartStyle,
                    pos + tokenText.length == nextChange ? spanEndStyle : "",
                    css,
                    attributes
                  );
                }
                if (end >= upto) {
                  text = text.slice(upto - pos);
                  pos = upto;
                  break;
                }
                pos = end;
                spanStartStyle = "";
              }
              text = allText.slice(at, at = styles[i2++]);
              style = interpretTokenStyle(styles[i2++], builder.cm.options);
            }
          }
        }
        function LineView(doc, line, lineN) {
          this.line = line;
          this.rest = visualLineContinued(line);
          this.size = this.rest ? lineNo(lst(this.rest)) - lineN + 1 : 1;
          this.node = this.text = null;
          this.hidden = lineIsHidden(doc, line);
        }
        function buildViewArray(cm, from, to) {
          var array = [], nextPos;
          for (var pos = from; pos < to; pos = nextPos) {
            var view = new LineView(cm.doc, getLine(cm.doc, pos), pos);
            nextPos = pos + view.size;
            array.push(view);
          }
          return array;
        }
        var operationGroup = null;
        function pushOperation(op) {
          if (operationGroup) {
            operationGroup.ops.push(op);
          } else {
            op.ownsGroup = operationGroup = {
              ops: [op],
              delayedCallbacks: []
            };
          }
        }
        function fireCallbacksForOps(group) {
          var callbacks = group.delayedCallbacks, i2 = 0;
          do {
            for (; i2 < callbacks.length; i2++) {
              callbacks[i2].call(null);
            }
            for (var j = 0; j < group.ops.length; j++) {
              var op = group.ops[j];
              if (op.cursorActivityHandlers) {
                while (op.cursorActivityCalled < op.cursorActivityHandlers.length) {
                  op.cursorActivityHandlers[op.cursorActivityCalled++].call(null, op.cm);
                }
              }
            }
          } while (i2 < callbacks.length);
        }
        function finishOperation(op, endCb) {
          var group = op.ownsGroup;
          if (!group) {
            return;
          }
          try {
            fireCallbacksForOps(group);
          } finally {
            operationGroup = null;
            endCb(group);
          }
        }
        var orphanDelayedCallbacks = null;
        function signalLater(emitter, type2) {
          var arr = getHandlers(emitter, type2);
          if (!arr.length) {
            return;
          }
          var args = Array.prototype.slice.call(arguments, 2), list;
          if (operationGroup) {
            list = operationGroup.delayedCallbacks;
          } else if (orphanDelayedCallbacks) {
            list = orphanDelayedCallbacks;
          } else {
            list = orphanDelayedCallbacks = [];
            setTimeout(fireOrphanDelayed, 0);
          }
          var loop = function(i3) {
            list.push(function() {
              return arr[i3].apply(null, args);
            });
          };
          for (var i2 = 0; i2 < arr.length; ++i2)
            loop(i2);
        }
        function fireOrphanDelayed() {
          var delayed = orphanDelayedCallbacks;
          orphanDelayedCallbacks = null;
          for (var i2 = 0; i2 < delayed.length; ++i2) {
            delayed[i2]();
          }
        }
        function updateLineForChanges(cm, lineView, lineN, dims) {
          for (var j = 0; j < lineView.changes.length; j++) {
            var type2 = lineView.changes[j];
            if (type2 == "text") {
              updateLineText(cm, lineView);
            } else if (type2 == "gutter") {
              updateLineGutter(cm, lineView, lineN, dims);
            } else if (type2 == "class") {
              updateLineClasses(cm, lineView);
            } else if (type2 == "widget") {
              updateLineWidgets(cm, lineView, dims);
            }
          }
          lineView.changes = null;
        }
        function ensureLineWrapped(lineView) {
          if (lineView.node == lineView.text) {
            lineView.node = elt("div", null, null, "position: relative");
            if (lineView.text.parentNode) {
              lineView.text.parentNode.replaceChild(lineView.node, lineView.text);
            }
            lineView.node.appendChild(lineView.text);
            if (ie && ie_version < 8) {
              lineView.node.style.zIndex = 2;
            }
          }
          return lineView.node;
        }
        function updateLineBackground(cm, lineView) {
          var cls = lineView.bgClass ? lineView.bgClass + " " + (lineView.line.bgClass || "") : lineView.line.bgClass;
          if (cls) {
            cls += " CodeMirror-linebackground";
          }
          if (lineView.background) {
            if (cls) {
              lineView.background.className = cls;
            } else {
              lineView.background.parentNode.removeChild(lineView.background);
              lineView.background = null;
            }
          } else if (cls) {
            var wrap = ensureLineWrapped(lineView);
            lineView.background = wrap.insertBefore(elt("div", null, cls), wrap.firstChild);
            cm.display.input.setUneditable(lineView.background);
          }
        }
        function getLineContent(cm, lineView) {
          var ext = cm.display.externalMeasured;
          if (ext && ext.line == lineView.line) {
            cm.display.externalMeasured = null;
            lineView.measure = ext.measure;
            return ext.built;
          }
          return buildLineContent(cm, lineView);
        }
        function updateLineText(cm, lineView) {
          var cls = lineView.text.className;
          var built = getLineContent(cm, lineView);
          if (lineView.text == lineView.node) {
            lineView.node = built.pre;
          }
          lineView.text.parentNode.replaceChild(built.pre, lineView.text);
          lineView.text = built.pre;
          if (built.bgClass != lineView.bgClass || built.textClass != lineView.textClass) {
            lineView.bgClass = built.bgClass;
            lineView.textClass = built.textClass;
            updateLineClasses(cm, lineView);
          } else if (cls) {
            lineView.text.className = cls;
          }
        }
        function updateLineClasses(cm, lineView) {
          updateLineBackground(cm, lineView);
          if (lineView.line.wrapClass) {
            ensureLineWrapped(lineView).className = lineView.line.wrapClass;
          } else if (lineView.node != lineView.text) {
            lineView.node.className = "";
          }
          var textClass = lineView.textClass ? lineView.textClass + " " + (lineView.line.textClass || "") : lineView.line.textClass;
          lineView.text.className = textClass || "";
        }
        function updateLineGutter(cm, lineView, lineN, dims) {
          if (lineView.gutter) {
            lineView.node.removeChild(lineView.gutter);
            lineView.gutter = null;
          }
          if (lineView.gutterBackground) {
            lineView.node.removeChild(lineView.gutterBackground);
            lineView.gutterBackground = null;
          }
          if (lineView.line.gutterClass) {
            var wrap = ensureLineWrapped(lineView);
            lineView.gutterBackground = elt(
              "div",
              null,
              "CodeMirror-gutter-background " + lineView.line.gutterClass,
              "left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px; width: " + dims.gutterTotalWidth + "px"
            );
            cm.display.input.setUneditable(lineView.gutterBackground);
            wrap.insertBefore(lineView.gutterBackground, lineView.text);
          }
          var markers = lineView.line.gutterMarkers;
          if (cm.options.lineNumbers || markers) {
            var wrap$1 = ensureLineWrapped(lineView);
            var gutterWrap = lineView.gutter = elt("div", null, "CodeMirror-gutter-wrapper", "left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px");
            gutterWrap.setAttribute("aria-hidden", "true");
            cm.display.input.setUneditable(gutterWrap);
            wrap$1.insertBefore(gutterWrap, lineView.text);
            if (lineView.line.gutterClass) {
              gutterWrap.className += " " + lineView.line.gutterClass;
            }
            if (cm.options.lineNumbers && (!markers || !markers["CodeMirror-linenumbers"])) {
              lineView.lineNumber = gutterWrap.appendChild(
                elt(
                  "div",
                  lineNumberFor(cm.options, lineN),
                  "CodeMirror-linenumber CodeMirror-gutter-elt",
                  "left: " + dims.gutterLeft["CodeMirror-linenumbers"] + "px; width: " + cm.display.lineNumInnerWidth + "px"
                )
              );
            }
            if (markers) {
              for (var k2 = 0; k2 < cm.display.gutterSpecs.length; ++k2) {
                var id = cm.display.gutterSpecs[k2].className, found = markers.hasOwnProperty(id) && markers[id];
                if (found) {
                  gutterWrap.appendChild(elt(
                    "div",
                    [found],
                    "CodeMirror-gutter-elt",
                    "left: " + dims.gutterLeft[id] + "px; width: " + dims.gutterWidth[id] + "px"
                  ));
                }
              }
            }
          }
        }
        function updateLineWidgets(cm, lineView, dims) {
          if (lineView.alignable) {
            lineView.alignable = null;
          }
          var isWidget = classTest("CodeMirror-linewidget");
          for (var node = lineView.node.firstChild, next = void 0; node; node = next) {
            next = node.nextSibling;
            if (isWidget.test(node.className)) {
              lineView.node.removeChild(node);
            }
          }
          insertLineWidgets(cm, lineView, dims);
        }
        function buildLineElement(cm, lineView, lineN, dims) {
          var built = getLineContent(cm, lineView);
          lineView.text = lineView.node = built.pre;
          if (built.bgClass) {
            lineView.bgClass = built.bgClass;
          }
          if (built.textClass) {
            lineView.textClass = built.textClass;
          }
          updateLineClasses(cm, lineView);
          updateLineGutter(cm, lineView, lineN, dims);
          insertLineWidgets(cm, lineView, dims);
          return lineView.node;
        }
        function insertLineWidgets(cm, lineView, dims) {
          insertLineWidgetsFor(cm, lineView.line, lineView, dims, true);
          if (lineView.rest) {
            for (var i2 = 0; i2 < lineView.rest.length; i2++) {
              insertLineWidgetsFor(cm, lineView.rest[i2], lineView, dims, false);
            }
          }
        }
        function insertLineWidgetsFor(cm, line, lineView, dims, allowAbove) {
          if (!line.widgets) {
            return;
          }
          var wrap = ensureLineWrapped(lineView);
          for (var i2 = 0, ws = line.widgets; i2 < ws.length; ++i2) {
            var widget = ws[i2], node = elt("div", [widget.node], "CodeMirror-linewidget" + (widget.className ? " " + widget.className : ""));
            if (!widget.handleMouseEvents) {
              node.setAttribute("cm-ignore-events", "true");
            }
            positionLineWidget(widget, node, lineView, dims);
            cm.display.input.setUneditable(node);
            if (allowAbove && widget.above) {
              wrap.insertBefore(node, lineView.gutter || lineView.text);
            } else {
              wrap.appendChild(node);
            }
            signalLater(widget, "redraw");
          }
        }
        function positionLineWidget(widget, node, lineView, dims) {
          if (widget.noHScroll) {
            (lineView.alignable || (lineView.alignable = [])).push(node);
            var width = dims.wrapperWidth;
            node.style.left = dims.fixedPos + "px";
            if (!widget.coverGutter) {
              width -= dims.gutterTotalWidth;
              node.style.paddingLeft = dims.gutterTotalWidth + "px";
            }
            node.style.width = width + "px";
          }
          if (widget.coverGutter) {
            node.style.zIndex = 5;
            node.style.position = "relative";
            if (!widget.noHScroll) {
              node.style.marginLeft = -dims.gutterTotalWidth + "px";
            }
          }
        }
        function widgetHeight(widget) {
          if (widget.height != null) {
            return widget.height;
          }
          var cm = widget.doc.cm;
          if (!cm) {
            return 0;
          }
          if (!contains(document.body, widget.node)) {
            var parentStyle = "position: relative;";
            if (widget.coverGutter) {
              parentStyle += "margin-left: -" + cm.display.gutters.offsetWidth + "px;";
            }
            if (widget.noHScroll) {
              parentStyle += "width: " + cm.display.wrapper.clientWidth + "px;";
            }
            removeChildrenAndAdd(cm.display.measure, elt("div", [widget.node], null, parentStyle));
          }
          return widget.height = widget.node.parentNode.offsetHeight;
        }
        function eventInWidget(display, e) {
          for (var n = e_target(e); n != display.wrapper; n = n.parentNode) {
            if (!n || n.nodeType == 1 && n.getAttribute("cm-ignore-events") == "true" || n.parentNode == display.sizer && n != display.mover) {
              return true;
            }
          }
        }
        function paddingTop(display) {
          return display.lineSpace.offsetTop;
        }
        function paddingVert(display) {
          return display.mover.offsetHeight - display.lineSpace.offsetHeight;
        }
        function paddingH(display) {
          if (display.cachedPaddingH) {
            return display.cachedPaddingH;
          }
          var e = removeChildrenAndAdd(display.measure, elt("pre", "x", "CodeMirror-line-like"));
          var style = window.getComputedStyle ? window.getComputedStyle(e) : e.currentStyle;
          var data = { left: parseInt(style.paddingLeft), right: parseInt(style.paddingRight) };
          if (!isNaN(data.left) && !isNaN(data.right)) {
            display.cachedPaddingH = data;
          }
          return data;
        }
        function scrollGap(cm) {
          return scrollerGap - cm.display.nativeBarWidth;
        }
        function displayWidth(cm) {
          return cm.display.scroller.clientWidth - scrollGap(cm) - cm.display.barWidth;
        }
        function displayHeight(cm) {
          return cm.display.scroller.clientHeight - scrollGap(cm) - cm.display.barHeight;
        }
        function ensureLineHeights(cm, lineView, rect) {
          var wrapping = cm.options.lineWrapping;
          var curWidth = wrapping && displayWidth(cm);
          if (!lineView.measure.heights || wrapping && lineView.measure.width != curWidth) {
            var heights = lineView.measure.heights = [];
            if (wrapping) {
              lineView.measure.width = curWidth;
              var rects = lineView.text.firstChild.getClientRects();
              for (var i2 = 0; i2 < rects.length - 1; i2++) {
                var cur = rects[i2], next = rects[i2 + 1];
                if (Math.abs(cur.bottom - next.bottom) > 2) {
                  heights.push((cur.bottom + next.top) / 2 - rect.top);
                }
              }
            }
            heights.push(rect.bottom - rect.top);
          }
        }
        function mapFromLineView(lineView, line, lineN) {
          if (lineView.line == line) {
            return { map: lineView.measure.map, cache: lineView.measure.cache };
          }
          for (var i2 = 0; i2 < lineView.rest.length; i2++) {
            if (lineView.rest[i2] == line) {
              return { map: lineView.measure.maps[i2], cache: lineView.measure.caches[i2] };
            }
          }
          for (var i$12 = 0; i$12 < lineView.rest.length; i$12++) {
            if (lineNo(lineView.rest[i$12]) > lineN) {
              return { map: lineView.measure.maps[i$12], cache: lineView.measure.caches[i$12], before: true };
            }
          }
        }
        function updateExternalMeasurement(cm, line) {
          line = visualLine(line);
          var lineN = lineNo(line);
          var view = cm.display.externalMeasured = new LineView(cm.doc, line, lineN);
          view.lineN = lineN;
          var built = view.built = buildLineContent(cm, view);
          view.text = built.pre;
          removeChildrenAndAdd(cm.display.lineMeasure, built.pre);
          return view;
        }
        function measureChar(cm, line, ch, bias) {
          return measureCharPrepared(cm, prepareMeasureForLine(cm, line), ch, bias);
        }
        function findViewForLine(cm, lineN) {
          if (lineN >= cm.display.viewFrom && lineN < cm.display.viewTo) {
            return cm.display.view[findViewIndex(cm, lineN)];
          }
          var ext = cm.display.externalMeasured;
          if (ext && lineN >= ext.lineN && lineN < ext.lineN + ext.size) {
            return ext;
          }
        }
        function prepareMeasureForLine(cm, line) {
          var lineN = lineNo(line);
          var view = findViewForLine(cm, lineN);
          if (view && !view.text) {
            view = null;
          } else if (view && view.changes) {
            updateLineForChanges(cm, view, lineN, getDimensions(cm));
            cm.curOp.forceUpdate = true;
          }
          if (!view) {
            view = updateExternalMeasurement(cm, line);
          }
          var info = mapFromLineView(view, line, lineN);
          return {
            line,
            view,
            rect: null,
            map: info.map,
            cache: info.cache,
            before: info.before,
            hasHeights: false
          };
        }
        function measureCharPrepared(cm, prepared, ch, bias, varHeight) {
          if (prepared.before) {
            ch = -1;
          }
          var key = ch + (bias || ""), found;
          if (prepared.cache.hasOwnProperty(key)) {
            found = prepared.cache[key];
          } else {
            if (!prepared.rect) {
              prepared.rect = prepared.view.text.getBoundingClientRect();
            }
            if (!prepared.hasHeights) {
              ensureLineHeights(cm, prepared.view, prepared.rect);
              prepared.hasHeights = true;
            }
            found = measureCharInner(cm, prepared, ch, bias);
            if (!found.bogus) {
              prepared.cache[key] = found;
            }
          }
          return {
            left: found.left,
            right: found.right,
            top: varHeight ? found.rtop : found.top,
            bottom: varHeight ? found.rbottom : found.bottom
          };
        }
        var nullRect = { left: 0, right: 0, top: 0, bottom: 0 };
        function nodeAndOffsetInLineMap(map2, ch, bias) {
          var node, start, end, collapse, mStart, mEnd;
          for (var i2 = 0; i2 < map2.length; i2 += 3) {
            mStart = map2[i2];
            mEnd = map2[i2 + 1];
            if (ch < mStart) {
              start = 0;
              end = 1;
              collapse = "left";
            } else if (ch < mEnd) {
              start = ch - mStart;
              end = start + 1;
            } else if (i2 == map2.length - 3 || ch == mEnd && map2[i2 + 3] > ch) {
              end = mEnd - mStart;
              start = end - 1;
              if (ch >= mEnd) {
                collapse = "right";
              }
            }
            if (start != null) {
              node = map2[i2 + 2];
              if (mStart == mEnd && bias == (node.insertLeft ? "left" : "right")) {
                collapse = bias;
              }
              if (bias == "left" && start == 0) {
                while (i2 && map2[i2 - 2] == map2[i2 - 3] && map2[i2 - 1].insertLeft) {
                  node = map2[(i2 -= 3) + 2];
                  collapse = "left";
                }
              }
              if (bias == "right" && start == mEnd - mStart) {
                while (i2 < map2.length - 3 && map2[i2 + 3] == map2[i2 + 4] && !map2[i2 + 5].insertLeft) {
                  node = map2[(i2 += 3) + 2];
                  collapse = "right";
                }
              }
              break;
            }
          }
          return { node, start, end, collapse, coverStart: mStart, coverEnd: mEnd };
        }
        function getUsefulRect(rects, bias) {
          var rect = nullRect;
          if (bias == "left") {
            for (var i2 = 0; i2 < rects.length; i2++) {
              if ((rect = rects[i2]).left != rect.right) {
                break;
              }
            }
          } else {
            for (var i$12 = rects.length - 1; i$12 >= 0; i$12--) {
              if ((rect = rects[i$12]).left != rect.right) {
                break;
              }
            }
          }
          return rect;
        }
        function measureCharInner(cm, prepared, ch, bias) {
          var place = nodeAndOffsetInLineMap(prepared.map, ch, bias);
          var node = place.node, start = place.start, end = place.end, collapse = place.collapse;
          var rect;
          if (node.nodeType == 3) {
            for (var i$12 = 0; i$12 < 4; i$12++) {
              while (start && isExtendingChar(prepared.line.text.charAt(place.coverStart + start))) {
                --start;
              }
              while (place.coverStart + end < place.coverEnd && isExtendingChar(prepared.line.text.charAt(place.coverStart + end))) {
                ++end;
              }
              if (ie && ie_version < 9 && start == 0 && end == place.coverEnd - place.coverStart) {
                rect = node.parentNode.getBoundingClientRect();
              } else {
                rect = getUsefulRect(range(node, start, end).getClientRects(), bias);
              }
              if (rect.left || rect.right || start == 0) {
                break;
              }
              end = start;
              start = start - 1;
              collapse = "right";
            }
            if (ie && ie_version < 11) {
              rect = maybeUpdateRectForZooming(cm.display.measure, rect);
            }
          } else {
            if (start > 0) {
              collapse = bias = "right";
            }
            var rects;
            if (cm.options.lineWrapping && (rects = node.getClientRects()).length > 1) {
              rect = rects[bias == "right" ? rects.length - 1 : 0];
            } else {
              rect = node.getBoundingClientRect();
            }
          }
          if (ie && ie_version < 9 && !start && (!rect || !rect.left && !rect.right)) {
            var rSpan = node.parentNode.getClientRects()[0];
            if (rSpan) {
              rect = { left: rSpan.left, right: rSpan.left + charWidth(cm.display), top: rSpan.top, bottom: rSpan.bottom };
            } else {
              rect = nullRect;
            }
          }
          var rtop = rect.top - prepared.rect.top, rbot = rect.bottom - prepared.rect.top;
          var mid = (rtop + rbot) / 2;
          var heights = prepared.view.measure.heights;
          var i2 = 0;
          for (; i2 < heights.length - 1; i2++) {
            if (mid < heights[i2]) {
              break;
            }
          }
          var top = i2 ? heights[i2 - 1] : 0, bot = heights[i2];
          var result = {
            left: (collapse == "right" ? rect.right : rect.left) - prepared.rect.left,
            right: (collapse == "left" ? rect.left : rect.right) - prepared.rect.left,
            top,
            bottom: bot
          };
          if (!rect.left && !rect.right) {
            result.bogus = true;
          }
          if (!cm.options.singleCursorHeightPerLine) {
            result.rtop = rtop;
            result.rbottom = rbot;
          }
          return result;
        }
        function maybeUpdateRectForZooming(measure, rect) {
          if (!window.screen || screen.logicalXDPI == null || screen.logicalXDPI == screen.deviceXDPI || !hasBadZoomedRects(measure)) {
            return rect;
          }
          var scaleX = screen.logicalXDPI / screen.deviceXDPI;
          var scaleY = screen.logicalYDPI / screen.deviceYDPI;
          return {
            left: rect.left * scaleX,
            right: rect.right * scaleX,
            top: rect.top * scaleY,
            bottom: rect.bottom * scaleY
          };
        }
        function clearLineMeasurementCacheFor(lineView) {
          if (lineView.measure) {
            lineView.measure.cache = {};
            lineView.measure.heights = null;
            if (lineView.rest) {
              for (var i2 = 0; i2 < lineView.rest.length; i2++) {
                lineView.measure.caches[i2] = {};
              }
            }
          }
        }
        function clearLineMeasurementCache(cm) {
          cm.display.externalMeasure = null;
          removeChildren(cm.display.lineMeasure);
          for (var i2 = 0; i2 < cm.display.view.length; i2++) {
            clearLineMeasurementCacheFor(cm.display.view[i2]);
          }
        }
        function clearCaches(cm) {
          clearLineMeasurementCache(cm);
          cm.display.cachedCharWidth = cm.display.cachedTextHeight = cm.display.cachedPaddingH = null;
          if (!cm.options.lineWrapping) {
            cm.display.maxLineChanged = true;
          }
          cm.display.lineNumChars = null;
        }
        function pageScrollX() {
          if (chrome && android) {
            return -(document.body.getBoundingClientRect().left - parseInt(getComputedStyle(document.body).marginLeft));
          }
          return window.pageXOffset || (document.documentElement || document.body).scrollLeft;
        }
        function pageScrollY() {
          if (chrome && android) {
            return -(document.body.getBoundingClientRect().top - parseInt(getComputedStyle(document.body).marginTop));
          }
          return window.pageYOffset || (document.documentElement || document.body).scrollTop;
        }
        function widgetTopHeight(lineObj) {
          var height = 0;
          if (lineObj.widgets) {
            for (var i2 = 0; i2 < lineObj.widgets.length; ++i2) {
              if (lineObj.widgets[i2].above) {
                height += widgetHeight(lineObj.widgets[i2]);
              }
            }
          }
          return height;
        }
        function intoCoordSystem(cm, lineObj, rect, context, includeWidgets) {
          if (!includeWidgets) {
            var height = widgetTopHeight(lineObj);
            rect.top += height;
            rect.bottom += height;
          }
          if (context == "line") {
            return rect;
          }
          if (!context) {
            context = "local";
          }
          var yOff = heightAtLine(lineObj);
          if (context == "local") {
            yOff += paddingTop(cm.display);
          } else {
            yOff -= cm.display.viewOffset;
          }
          if (context == "page" || context == "window") {
            var lOff = cm.display.lineSpace.getBoundingClientRect();
            yOff += lOff.top + (context == "window" ? 0 : pageScrollY());
            var xOff = lOff.left + (context == "window" ? 0 : pageScrollX());
            rect.left += xOff;
            rect.right += xOff;
          }
          rect.top += yOff;
          rect.bottom += yOff;
          return rect;
        }
        function fromCoordSystem(cm, coords, context) {
          if (context == "div") {
            return coords;
          }
          var left = coords.left, top = coords.top;
          if (context == "page") {
            left -= pageScrollX();
            top -= pageScrollY();
          } else if (context == "local" || !context) {
            var localBox = cm.display.sizer.getBoundingClientRect();
            left += localBox.left;
            top += localBox.top;
          }
          var lineSpaceBox = cm.display.lineSpace.getBoundingClientRect();
          return { left: left - lineSpaceBox.left, top: top - lineSpaceBox.top };
        }
        function charCoords(cm, pos, context, lineObj, bias) {
          if (!lineObj) {
            lineObj = getLine(cm.doc, pos.line);
          }
          return intoCoordSystem(cm, lineObj, measureChar(cm, lineObj, pos.ch, bias), context);
        }
        function cursorCoords(cm, pos, context, lineObj, preparedMeasure, varHeight) {
          lineObj = lineObj || getLine(cm.doc, pos.line);
          if (!preparedMeasure) {
            preparedMeasure = prepareMeasureForLine(cm, lineObj);
          }
          function get(ch2, right) {
            var m = measureCharPrepared(cm, preparedMeasure, ch2, right ? "right" : "left", varHeight);
            if (right) {
              m.left = m.right;
            } else {
              m.right = m.left;
            }
            return intoCoordSystem(cm, lineObj, m, context);
          }
          var order = getOrder(lineObj, cm.doc.direction), ch = pos.ch, sticky = pos.sticky;
          if (ch >= lineObj.text.length) {
            ch = lineObj.text.length;
            sticky = "before";
          } else if (ch <= 0) {
            ch = 0;
            sticky = "after";
          }
          if (!order) {
            return get(sticky == "before" ? ch - 1 : ch, sticky == "before");
          }
          function getBidi(ch2, partPos2, invert) {
            var part = order[partPos2], right = part.level == 1;
            return get(invert ? ch2 - 1 : ch2, right != invert);
          }
          var partPos = getBidiPartAt(order, ch, sticky);
          var other = bidiOther;
          var val = getBidi(ch, partPos, sticky == "before");
          if (other != null) {
            val.other = getBidi(ch, other, sticky != "before");
          }
          return val;
        }
        function estimateCoords(cm, pos) {
          var left = 0;
          pos = clipPos(cm.doc, pos);
          if (!cm.options.lineWrapping) {
            left = charWidth(cm.display) * pos.ch;
          }
          var lineObj = getLine(cm.doc, pos.line);
          var top = heightAtLine(lineObj) + paddingTop(cm.display);
          return { left, right: left, top, bottom: top + lineObj.height };
        }
        function PosWithInfo(line, ch, sticky, outside, xRel) {
          var pos = Pos(line, ch, sticky);
          pos.xRel = xRel;
          if (outside) {
            pos.outside = outside;
          }
          return pos;
        }
        function coordsChar(cm, x, y) {
          var doc = cm.doc;
          y += cm.display.viewOffset;
          if (y < 0) {
            return PosWithInfo(doc.first, 0, null, -1, -1);
          }
          var lineN = lineAtHeight(doc, y), last = doc.first + doc.size - 1;
          if (lineN > last) {
            return PosWithInfo(doc.first + doc.size - 1, getLine(doc, last).text.length, null, 1, 1);
          }
          if (x < 0) {
            x = 0;
          }
          var lineObj = getLine(doc, lineN);
          for (; ; ) {
            var found = coordsCharInner(cm, lineObj, lineN, x, y);
            var collapsed = collapsedSpanAround(lineObj, found.ch + (found.xRel > 0 || found.outside > 0 ? 1 : 0));
            if (!collapsed) {
              return found;
            }
            var rangeEnd = collapsed.find(1);
            if (rangeEnd.line == lineN) {
              return rangeEnd;
            }
            lineObj = getLine(doc, lineN = rangeEnd.line);
          }
        }
        function wrappedLineExtent(cm, lineObj, preparedMeasure, y) {
          y -= widgetTopHeight(lineObj);
          var end = lineObj.text.length;
          var begin = findFirst(function(ch) {
            return measureCharPrepared(cm, preparedMeasure, ch - 1).bottom <= y;
          }, end, 0);
          end = findFirst(function(ch) {
            return measureCharPrepared(cm, preparedMeasure, ch).top > y;
          }, begin, end);
          return { begin, end };
        }
        function wrappedLineExtentChar(cm, lineObj, preparedMeasure, target) {
          if (!preparedMeasure) {
            preparedMeasure = prepareMeasureForLine(cm, lineObj);
          }
          var targetTop = intoCoordSystem(cm, lineObj, measureCharPrepared(cm, preparedMeasure, target), "line").top;
          return wrappedLineExtent(cm, lineObj, preparedMeasure, targetTop);
        }
        function boxIsAfter(box, x, y, left) {
          return box.bottom <= y ? false : box.top > y ? true : (left ? box.left : box.right) > x;
        }
        function coordsCharInner(cm, lineObj, lineNo2, x, y) {
          y -= heightAtLine(lineObj);
          var preparedMeasure = prepareMeasureForLine(cm, lineObj);
          var widgetHeight2 = widgetTopHeight(lineObj);
          var begin = 0, end = lineObj.text.length, ltr = true;
          var order = getOrder(lineObj, cm.doc.direction);
          if (order) {
            var part = (cm.options.lineWrapping ? coordsBidiPartWrapped : coordsBidiPart)(cm, lineObj, lineNo2, preparedMeasure, order, x, y);
            ltr = part.level != 1;
            begin = ltr ? part.from : part.to - 1;
            end = ltr ? part.to : part.from - 1;
          }
          var chAround = null, boxAround = null;
          var ch = findFirst(function(ch2) {
            var box = measureCharPrepared(cm, preparedMeasure, ch2);
            box.top += widgetHeight2;
            box.bottom += widgetHeight2;
            if (!boxIsAfter(box, x, y, false)) {
              return false;
            }
            if (box.top <= y && box.left <= x) {
              chAround = ch2;
              boxAround = box;
            }
            return true;
          }, begin, end);
          var baseX, sticky, outside = false;
          if (boxAround) {
            var atLeft = x - boxAround.left < boxAround.right - x, atStart = atLeft == ltr;
            ch = chAround + (atStart ? 0 : 1);
            sticky = atStart ? "after" : "before";
            baseX = atLeft ? boxAround.left : boxAround.right;
          } else {
            if (!ltr && (ch == end || ch == begin)) {
              ch++;
            }
            sticky = ch == 0 ? "after" : ch == lineObj.text.length ? "before" : measureCharPrepared(cm, preparedMeasure, ch - (ltr ? 1 : 0)).bottom + widgetHeight2 <= y == ltr ? "after" : "before";
            var coords = cursorCoords(cm, Pos(lineNo2, ch, sticky), "line", lineObj, preparedMeasure);
            baseX = coords.left;
            outside = y < coords.top ? -1 : y >= coords.bottom ? 1 : 0;
          }
          ch = skipExtendingChars(lineObj.text, ch, 1);
          return PosWithInfo(lineNo2, ch, sticky, outside, x - baseX);
        }
        function coordsBidiPart(cm, lineObj, lineNo2, preparedMeasure, order, x, y) {
          var index2 = findFirst(function(i2) {
            var part2 = order[i2], ltr2 = part2.level != 1;
            return boxIsAfter(cursorCoords(
              cm,
              Pos(lineNo2, ltr2 ? part2.to : part2.from, ltr2 ? "before" : "after"),
              "line",
              lineObj,
              preparedMeasure
            ), x, y, true);
          }, 0, order.length - 1);
          var part = order[index2];
          if (index2 > 0) {
            var ltr = part.level != 1;
            var start = cursorCoords(
              cm,
              Pos(lineNo2, ltr ? part.from : part.to, ltr ? "after" : "before"),
              "line",
              lineObj,
              preparedMeasure
            );
            if (boxIsAfter(start, x, y, true) && start.top > y) {
              part = order[index2 - 1];
            }
          }
          return part;
        }
        function coordsBidiPartWrapped(cm, lineObj, _lineNo, preparedMeasure, order, x, y) {
          var ref = wrappedLineExtent(cm, lineObj, preparedMeasure, y);
          var begin = ref.begin;
          var end = ref.end;
          if (/\s/.test(lineObj.text.charAt(end - 1))) {
            end--;
          }
          var part = null, closestDist = null;
          for (var i2 = 0; i2 < order.length; i2++) {
            var p = order[i2];
            if (p.from >= end || p.to <= begin) {
              continue;
            }
            var ltr = p.level != 1;
            var endX = measureCharPrepared(cm, preparedMeasure, ltr ? Math.min(end, p.to) - 1 : Math.max(begin, p.from)).right;
            var dist = endX < x ? x - endX + 1e9 : endX - x;
            if (!part || closestDist > dist) {
              part = p;
              closestDist = dist;
            }
          }
          if (!part) {
            part = order[order.length - 1];
          }
          if (part.from < begin) {
            part = { from: begin, to: part.to, level: part.level };
          }
          if (part.to > end) {
            part = { from: part.from, to: end, level: part.level };
          }
          return part;
        }
        var measureText;
        function textHeight(display) {
          if (display.cachedTextHeight != null) {
            return display.cachedTextHeight;
          }
          if (measureText == null) {
            measureText = elt("pre", null, "CodeMirror-line-like");
            for (var i2 = 0; i2 < 49; ++i2) {
              measureText.appendChild(document.createTextNode("x"));
              measureText.appendChild(elt("br"));
            }
            measureText.appendChild(document.createTextNode("x"));
          }
          removeChildrenAndAdd(display.measure, measureText);
          var height = measureText.offsetHeight / 50;
          if (height > 3) {
            display.cachedTextHeight = height;
          }
          removeChildren(display.measure);
          return height || 1;
        }
        function charWidth(display) {
          if (display.cachedCharWidth != null) {
            return display.cachedCharWidth;
          }
          var anchor = elt("span", "xxxxxxxxxx");
          var pre = elt("pre", [anchor], "CodeMirror-line-like");
          removeChildrenAndAdd(display.measure, pre);
          var rect = anchor.getBoundingClientRect(), width = (rect.right - rect.left) / 10;
          if (width > 2) {
            display.cachedCharWidth = width;
          }
          return width || 10;
        }
        function getDimensions(cm) {
          var d = cm.display, left = {}, width = {};
          var gutterLeft = d.gutters.clientLeft;
          for (var n = d.gutters.firstChild, i2 = 0; n; n = n.nextSibling, ++i2) {
            var id = cm.display.gutterSpecs[i2].className;
            left[id] = n.offsetLeft + n.clientLeft + gutterLeft;
            width[id] = n.clientWidth;
          }
          return {
            fixedPos: compensateForHScroll(d),
            gutterTotalWidth: d.gutters.offsetWidth,
            gutterLeft: left,
            gutterWidth: width,
            wrapperWidth: d.wrapper.clientWidth
          };
        }
        function compensateForHScroll(display) {
          return display.scroller.getBoundingClientRect().left - display.sizer.getBoundingClientRect().left;
        }
        function estimateHeight(cm) {
          var th = textHeight(cm.display), wrapping = cm.options.lineWrapping;
          var perLine = wrapping && Math.max(5, cm.display.scroller.clientWidth / charWidth(cm.display) - 3);
          return function(line) {
            if (lineIsHidden(cm.doc, line)) {
              return 0;
            }
            var widgetsHeight = 0;
            if (line.widgets) {
              for (var i2 = 0; i2 < line.widgets.length; i2++) {
                if (line.widgets[i2].height) {
                  widgetsHeight += line.widgets[i2].height;
                }
              }
            }
            if (wrapping) {
              return widgetsHeight + (Math.ceil(line.text.length / perLine) || 1) * th;
            } else {
              return widgetsHeight + th;
            }
          };
        }
        function estimateLineHeights(cm) {
          var doc = cm.doc, est = estimateHeight(cm);
          doc.iter(function(line) {
            var estHeight = est(line);
            if (estHeight != line.height) {
              updateLineHeight(line, estHeight);
            }
          });
        }
        function posFromMouse(cm, e, liberal, forRect) {
          var display = cm.display;
          if (!liberal && e_target(e).getAttribute("cm-not-content") == "true") {
            return null;
          }
          var x, y, space = display.lineSpace.getBoundingClientRect();
          try {
            x = e.clientX - space.left;
            y = e.clientY - space.top;
          } catch (e$1) {
            return null;
          }
          var coords = coordsChar(cm, x, y), line;
          if (forRect && coords.xRel > 0 && (line = getLine(cm.doc, coords.line).text).length == coords.ch) {
            var colDiff = countColumn(line, line.length, cm.options.tabSize) - line.length;
            coords = Pos(coords.line, Math.max(0, Math.round((x - paddingH(cm.display).left) / charWidth(cm.display)) - colDiff));
          }
          return coords;
        }
        function findViewIndex(cm, n) {
          if (n >= cm.display.viewTo) {
            return null;
          }
          n -= cm.display.viewFrom;
          if (n < 0) {
            return null;
          }
          var view = cm.display.view;
          for (var i2 = 0; i2 < view.length; i2++) {
            n -= view[i2].size;
            if (n < 0) {
              return i2;
            }
          }
        }
        function regChange(cm, from, to, lendiff) {
          if (from == null) {
            from = cm.doc.first;
          }
          if (to == null) {
            to = cm.doc.first + cm.doc.size;
          }
          if (!lendiff) {
            lendiff = 0;
          }
          var display = cm.display;
          if (lendiff && to < display.viewTo && (display.updateLineNumbers == null || display.updateLineNumbers > from)) {
            display.updateLineNumbers = from;
          }
          cm.curOp.viewChanged = true;
          if (from >= display.viewTo) {
            if (sawCollapsedSpans && visualLineNo(cm.doc, from) < display.viewTo) {
              resetView(cm);
            }
          } else if (to <= display.viewFrom) {
            if (sawCollapsedSpans && visualLineEndNo(cm.doc, to + lendiff) > display.viewFrom) {
              resetView(cm);
            } else {
              display.viewFrom += lendiff;
              display.viewTo += lendiff;
            }
          } else if (from <= display.viewFrom && to >= display.viewTo) {
            resetView(cm);
          } else if (from <= display.viewFrom) {
            var cut = viewCuttingPoint(cm, to, to + lendiff, 1);
            if (cut) {
              display.view = display.view.slice(cut.index);
              display.viewFrom = cut.lineN;
              display.viewTo += lendiff;
            } else {
              resetView(cm);
            }
          } else if (to >= display.viewTo) {
            var cut$1 = viewCuttingPoint(cm, from, from, -1);
            if (cut$1) {
              display.view = display.view.slice(0, cut$1.index);
              display.viewTo = cut$1.lineN;
            } else {
              resetView(cm);
            }
          } else {
            var cutTop = viewCuttingPoint(cm, from, from, -1);
            var cutBot = viewCuttingPoint(cm, to, to + lendiff, 1);
            if (cutTop && cutBot) {
              display.view = display.view.slice(0, cutTop.index).concat(buildViewArray(cm, cutTop.lineN, cutBot.lineN)).concat(display.view.slice(cutBot.index));
              display.viewTo += lendiff;
            } else {
              resetView(cm);
            }
          }
          var ext = display.externalMeasured;
          if (ext) {
            if (to < ext.lineN) {
              ext.lineN += lendiff;
            } else if (from < ext.lineN + ext.size) {
              display.externalMeasured = null;
            }
          }
        }
        function regLineChange(cm, line, type2) {
          cm.curOp.viewChanged = true;
          var display = cm.display, ext = cm.display.externalMeasured;
          if (ext && line >= ext.lineN && line < ext.lineN + ext.size) {
            display.externalMeasured = null;
          }
          if (line < display.viewFrom || line >= display.viewTo) {
            return;
          }
          var lineView = display.view[findViewIndex(cm, line)];
          if (lineView.node == null) {
            return;
          }
          var arr = lineView.changes || (lineView.changes = []);
          if (indexOf(arr, type2) == -1) {
            arr.push(type2);
          }
        }
        function resetView(cm) {
          cm.display.viewFrom = cm.display.viewTo = cm.doc.first;
          cm.display.view = [];
          cm.display.viewOffset = 0;
        }
        function viewCuttingPoint(cm, oldN, newN, dir) {
          var index2 = findViewIndex(cm, oldN), diff, view = cm.display.view;
          if (!sawCollapsedSpans || newN == cm.doc.first + cm.doc.size) {
            return { index: index2, lineN: newN };
          }
          var n = cm.display.viewFrom;
          for (var i2 = 0; i2 < index2; i2++) {
            n += view[i2].size;
          }
          if (n != oldN) {
            if (dir > 0) {
              if (index2 == view.length - 1) {
                return null;
              }
              diff = n + view[index2].size - oldN;
              index2++;
            } else {
              diff = n - oldN;
            }
            oldN += diff;
            newN += diff;
          }
          while (visualLineNo(cm.doc, newN) != newN) {
            if (index2 == (dir < 0 ? 0 : view.length - 1)) {
              return null;
            }
            newN += dir * view[index2 - (dir < 0 ? 1 : 0)].size;
            index2 += dir;
          }
          return { index: index2, lineN: newN };
        }
        function adjustView(cm, from, to) {
          var display = cm.display, view = display.view;
          if (view.length == 0 || from >= display.viewTo || to <= display.viewFrom) {
            display.view = buildViewArray(cm, from, to);
            display.viewFrom = from;
          } else {
            if (display.viewFrom > from) {
              display.view = buildViewArray(cm, from, display.viewFrom).concat(display.view);
            } else if (display.viewFrom < from) {
              display.view = display.view.slice(findViewIndex(cm, from));
            }
            display.viewFrom = from;
            if (display.viewTo < to) {
              display.view = display.view.concat(buildViewArray(cm, display.viewTo, to));
            } else if (display.viewTo > to) {
              display.view = display.view.slice(0, findViewIndex(cm, to));
            }
          }
          display.viewTo = to;
        }
        function countDirtyView(cm) {
          var view = cm.display.view, dirty = 0;
          for (var i2 = 0; i2 < view.length; i2++) {
            var lineView = view[i2];
            if (!lineView.hidden && (!lineView.node || lineView.changes)) {
              ++dirty;
            }
          }
          return dirty;
        }
        function updateSelection(cm) {
          cm.display.input.showSelection(cm.display.input.prepareSelection());
        }
        function prepareSelection(cm, primary) {
          if (primary === void 0)
            primary = true;
          var doc = cm.doc, result = {};
          var curFragment = result.cursors = document.createDocumentFragment();
          var selFragment = result.selection = document.createDocumentFragment();
          for (var i2 = 0; i2 < doc.sel.ranges.length; i2++) {
            if (!primary && i2 == doc.sel.primIndex) {
              continue;
            }
            var range2 = doc.sel.ranges[i2];
            if (range2.from().line >= cm.display.viewTo || range2.to().line < cm.display.viewFrom) {
              continue;
            }
            var collapsed = range2.empty();
            if (collapsed || cm.options.showCursorWhenSelecting) {
              drawSelectionCursor(cm, range2.head, curFragment);
            }
            if (!collapsed) {
              drawSelectionRange(cm, range2, selFragment);
            }
          }
          return result;
        }
        function drawSelectionCursor(cm, head, output) {
          var pos = cursorCoords(cm, head, "div", null, null, !cm.options.singleCursorHeightPerLine);
          var cursor = output.appendChild(elt("div", " ", "CodeMirror-cursor"));
          cursor.style.left = pos.left + "px";
          cursor.style.top = pos.top + "px";
          cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + "px";
          if (/\bcm-fat-cursor\b/.test(cm.getWrapperElement().className)) {
            var charPos = charCoords(cm, head, "div", null, null);
            if (charPos.right - charPos.left > 0) {
              cursor.style.width = charPos.right - charPos.left + "px";
            }
          }
          if (pos.other) {
            var otherCursor = output.appendChild(elt("div", " ", "CodeMirror-cursor CodeMirror-secondarycursor"));
            otherCursor.style.display = "";
            otherCursor.style.left = pos.other.left + "px";
            otherCursor.style.top = pos.other.top + "px";
            otherCursor.style.height = (pos.other.bottom - pos.other.top) * 0.85 + "px";
          }
        }
        function cmpCoords(a, b) {
          return a.top - b.top || a.left - b.left;
        }
        function drawSelectionRange(cm, range2, output) {
          var display = cm.display, doc = cm.doc;
          var fragment = document.createDocumentFragment();
          var padding = paddingH(cm.display), leftSide = padding.left;
          var rightSide = Math.max(display.sizerWidth, displayWidth(cm) - display.sizer.offsetLeft) - padding.right;
          var docLTR = doc.direction == "ltr";
          function add(left, top, width, bottom) {
            if (top < 0) {
              top = 0;
            }
            top = Math.round(top);
            bottom = Math.round(bottom);
            fragment.appendChild(elt("div", null, "CodeMirror-selected", "position: absolute; left: " + left + "px;\n                             top: " + top + "px; width: " + (width == null ? rightSide - left : width) + "px;\n                             height: " + (bottom - top) + "px"));
          }
          function drawForLine(line, fromArg, toArg) {
            var lineObj = getLine(doc, line);
            var lineLen = lineObj.text.length;
            var start, end;
            function coords(ch, bias) {
              return charCoords(cm, Pos(line, ch), "div", lineObj, bias);
            }
            function wrapX(pos, dir, side) {
              var extent = wrappedLineExtentChar(cm, lineObj, null, pos);
              var prop2 = dir == "ltr" == (side == "after") ? "left" : "right";
              var ch = side == "after" ? extent.begin : extent.end - (/\s/.test(lineObj.text.charAt(extent.end - 1)) ? 2 : 1);
              return coords(ch, prop2)[prop2];
            }
            var order = getOrder(lineObj, doc.direction);
            iterateBidiSections(order, fromArg || 0, toArg == null ? lineLen : toArg, function(from, to, dir, i2) {
              var ltr = dir == "ltr";
              var fromPos = coords(from, ltr ? "left" : "right");
              var toPos = coords(to - 1, ltr ? "right" : "left");
              var openStart = fromArg == null && from == 0, openEnd = toArg == null && to == lineLen;
              var first = i2 == 0, last = !order || i2 == order.length - 1;
              if (toPos.top - fromPos.top <= 3) {
                var openLeft = (docLTR ? openStart : openEnd) && first;
                var openRight = (docLTR ? openEnd : openStart) && last;
                var left = openLeft ? leftSide : (ltr ? fromPos : toPos).left;
                var right = openRight ? rightSide : (ltr ? toPos : fromPos).right;
                add(left, fromPos.top, right - left, fromPos.bottom);
              } else {
                var topLeft, topRight, botLeft, botRight;
                if (ltr) {
                  topLeft = docLTR && openStart && first ? leftSide : fromPos.left;
                  topRight = docLTR ? rightSide : wrapX(from, dir, "before");
                  botLeft = docLTR ? leftSide : wrapX(to, dir, "after");
                  botRight = docLTR && openEnd && last ? rightSide : toPos.right;
                } else {
                  topLeft = !docLTR ? leftSide : wrapX(from, dir, "before");
                  topRight = !docLTR && openStart && first ? rightSide : fromPos.right;
                  botLeft = !docLTR && openEnd && last ? leftSide : toPos.left;
                  botRight = !docLTR ? rightSide : wrapX(to, dir, "after");
                }
                add(topLeft, fromPos.top, topRight - topLeft, fromPos.bottom);
                if (fromPos.bottom < toPos.top) {
                  add(leftSide, fromPos.bottom, null, toPos.top);
                }
                add(botLeft, toPos.top, botRight - botLeft, toPos.bottom);
              }
              if (!start || cmpCoords(fromPos, start) < 0) {
                start = fromPos;
              }
              if (cmpCoords(toPos, start) < 0) {
                start = toPos;
              }
              if (!end || cmpCoords(fromPos, end) < 0) {
                end = fromPos;
              }
              if (cmpCoords(toPos, end) < 0) {
                end = toPos;
              }
            });
            return { start, end };
          }
          var sFrom = range2.from(), sTo = range2.to();
          if (sFrom.line == sTo.line) {
            drawForLine(sFrom.line, sFrom.ch, sTo.ch);
          } else {
            var fromLine = getLine(doc, sFrom.line), toLine = getLine(doc, sTo.line);
            var singleVLine = visualLine(fromLine) == visualLine(toLine);
            var leftEnd = drawForLine(sFrom.line, sFrom.ch, singleVLine ? fromLine.text.length + 1 : null).end;
            var rightStart = drawForLine(sTo.line, singleVLine ? 0 : null, sTo.ch).start;
            if (singleVLine) {
              if (leftEnd.top < rightStart.top - 2) {
                add(leftEnd.right, leftEnd.top, null, leftEnd.bottom);
                add(leftSide, rightStart.top, rightStart.left, rightStart.bottom);
              } else {
                add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom);
              }
            }
            if (leftEnd.bottom < rightStart.top) {
              add(leftSide, leftEnd.bottom, null, rightStart.top);
            }
          }
          output.appendChild(fragment);
        }
        function restartBlink(cm) {
          if (!cm.state.focused) {
            return;
          }
          var display = cm.display;
          clearInterval(display.blinker);
          var on2 = true;
          display.cursorDiv.style.visibility = "";
          if (cm.options.cursorBlinkRate > 0) {
            display.blinker = setInterval(function() {
              if (!cm.hasFocus()) {
                onBlur(cm);
              }
              display.cursorDiv.style.visibility = (on2 = !on2) ? "" : "hidden";
            }, cm.options.cursorBlinkRate);
          } else if (cm.options.cursorBlinkRate < 0) {
            display.cursorDiv.style.visibility = "hidden";
          }
        }
        function ensureFocus(cm) {
          if (!cm.hasFocus()) {
            cm.display.input.focus();
            if (!cm.state.focused) {
              onFocus(cm);
            }
          }
        }
        function delayBlurEvent(cm) {
          cm.state.delayingBlurEvent = true;
          setTimeout(function() {
            if (cm.state.delayingBlurEvent) {
              cm.state.delayingBlurEvent = false;
              if (cm.state.focused) {
                onBlur(cm);
              }
            }
          }, 100);
        }
        function onFocus(cm, e) {
          if (cm.state.delayingBlurEvent && !cm.state.draggingText) {
            cm.state.delayingBlurEvent = false;
          }
          if (cm.options.readOnly == "nocursor") {
            return;
          }
          if (!cm.state.focused) {
            signal(cm, "focus", cm, e);
            cm.state.focused = true;
            addClass(cm.display.wrapper, "CodeMirror-focused");
            if (!cm.curOp && cm.display.selForContextMenu != cm.doc.sel) {
              cm.display.input.reset();
              if (webkit) {
                setTimeout(function() {
                  return cm.display.input.reset(true);
                }, 20);
              }
            }
            cm.display.input.receivedFocus();
          }
          restartBlink(cm);
        }
        function onBlur(cm, e) {
          if (cm.state.delayingBlurEvent) {
            return;
          }
          if (cm.state.focused) {
            signal(cm, "blur", cm, e);
            cm.state.focused = false;
            rmClass(cm.display.wrapper, "CodeMirror-focused");
          }
          clearInterval(cm.display.blinker);
          setTimeout(function() {
            if (!cm.state.focused) {
              cm.display.shift = false;
            }
          }, 150);
        }
        function updateHeightsInViewport(cm) {
          var display = cm.display;
          var prevBottom = display.lineDiv.offsetTop;
          var viewTop = Math.max(0, display.scroller.getBoundingClientRect().top);
          var oldHeight = display.lineDiv.getBoundingClientRect().top;
          var mustScroll = 0;
          for (var i2 = 0; i2 < display.view.length; i2++) {
            var cur = display.view[i2], wrapping = cm.options.lineWrapping;
            var height = void 0, width = 0;
            if (cur.hidden) {
              continue;
            }
            oldHeight += cur.line.height;
            if (ie && ie_version < 8) {
              var bot = cur.node.offsetTop + cur.node.offsetHeight;
              height = bot - prevBottom;
              prevBottom = bot;
            } else {
              var box = cur.node.getBoundingClientRect();
              height = box.bottom - box.top;
              if (!wrapping && cur.text.firstChild) {
                width = cur.text.firstChild.getBoundingClientRect().right - box.left - 1;
              }
            }
            var diff = cur.line.height - height;
            if (diff > 5e-3 || diff < -5e-3) {
              if (oldHeight < viewTop) {
                mustScroll -= diff;
              }
              updateLineHeight(cur.line, height);
              updateWidgetHeight(cur.line);
              if (cur.rest) {
                for (var j = 0; j < cur.rest.length; j++) {
                  updateWidgetHeight(cur.rest[j]);
                }
              }
            }
            if (width > cm.display.sizerWidth) {
              var chWidth = Math.ceil(width / charWidth(cm.display));
              if (chWidth > cm.display.maxLineLength) {
                cm.display.maxLineLength = chWidth;
                cm.display.maxLine = cur.line;
                cm.display.maxLineChanged = true;
              }
            }
          }
          if (Math.abs(mustScroll) > 2) {
            display.scroller.scrollTop += mustScroll;
          }
        }
        function updateWidgetHeight(line) {
          if (line.widgets) {
            for (var i2 = 0; i2 < line.widgets.length; ++i2) {
              var w = line.widgets[i2], parent = w.node.parentNode;
              if (parent) {
                w.height = parent.offsetHeight;
              }
            }
          }
        }
        function visibleLines(display, doc, viewport) {
          var top = viewport && viewport.top != null ? Math.max(0, viewport.top) : display.scroller.scrollTop;
          top = Math.floor(top - paddingTop(display));
          var bottom = viewport && viewport.bottom != null ? viewport.bottom : top + display.wrapper.clientHeight;
          var from = lineAtHeight(doc, top), to = lineAtHeight(doc, bottom);
          if (viewport && viewport.ensure) {
            var ensureFrom = viewport.ensure.from.line, ensureTo = viewport.ensure.to.line;
            if (ensureFrom < from) {
              from = ensureFrom;
              to = lineAtHeight(doc, heightAtLine(getLine(doc, ensureFrom)) + display.wrapper.clientHeight);
            } else if (Math.min(ensureTo, doc.lastLine()) >= to) {
              from = lineAtHeight(doc, heightAtLine(getLine(doc, ensureTo)) - display.wrapper.clientHeight);
              to = ensureTo;
            }
          }
          return { from, to: Math.max(to, from + 1) };
        }
        function maybeScrollWindow(cm, rect) {
          if (signalDOMEvent(cm, "scrollCursorIntoView")) {
            return;
          }
          var display = cm.display, box = display.sizer.getBoundingClientRect(), doScroll = null;
          if (rect.top + box.top < 0) {
            doScroll = true;
          } else if (rect.bottom + box.top > (window.innerHeight || document.documentElement.clientHeight)) {
            doScroll = false;
          }
          if (doScroll != null && !phantom) {
            var scrollNode = elt("div", "​", null, "position: absolute;\n                         top: " + (rect.top - display.viewOffset - paddingTop(cm.display)) + "px;\n                         height: " + (rect.bottom - rect.top + scrollGap(cm) + display.barHeight) + "px;\n                         left: " + rect.left + "px; width: " + Math.max(2, rect.right - rect.left) + "px;");
            cm.display.lineSpace.appendChild(scrollNode);
            scrollNode.scrollIntoView(doScroll);
            cm.display.lineSpace.removeChild(scrollNode);
          }
        }
        function scrollPosIntoView(cm, pos, end, margin) {
          if (margin == null) {
            margin = 0;
          }
          var rect;
          if (!cm.options.lineWrapping && pos == end) {
            end = pos.sticky == "before" ? Pos(pos.line, pos.ch + 1, "before") : pos;
            pos = pos.ch ? Pos(pos.line, pos.sticky == "before" ? pos.ch - 1 : pos.ch, "after") : pos;
          }
          for (var limit = 0; limit < 5; limit++) {
            var changed = false;
            var coords = cursorCoords(cm, pos);
            var endCoords = !end || end == pos ? coords : cursorCoords(cm, end);
            rect = {
              left: Math.min(coords.left, endCoords.left),
              top: Math.min(coords.top, endCoords.top) - margin,
              right: Math.max(coords.left, endCoords.left),
              bottom: Math.max(coords.bottom, endCoords.bottom) + margin
            };
            var scrollPos = calculateScrollPos(cm, rect);
            var startTop = cm.doc.scrollTop, startLeft = cm.doc.scrollLeft;
            if (scrollPos.scrollTop != null) {
              updateScrollTop(cm, scrollPos.scrollTop);
              if (Math.abs(cm.doc.scrollTop - startTop) > 1) {
                changed = true;
              }
            }
            if (scrollPos.scrollLeft != null) {
              setScrollLeft(cm, scrollPos.scrollLeft);
              if (Math.abs(cm.doc.scrollLeft - startLeft) > 1) {
                changed = true;
              }
            }
            if (!changed) {
              break;
            }
          }
          return rect;
        }
        function scrollIntoView(cm, rect) {
          var scrollPos = calculateScrollPos(cm, rect);
          if (scrollPos.scrollTop != null) {
            updateScrollTop(cm, scrollPos.scrollTop);
          }
          if (scrollPos.scrollLeft != null) {
            setScrollLeft(cm, scrollPos.scrollLeft);
          }
        }
        function calculateScrollPos(cm, rect) {
          var display = cm.display, snapMargin = textHeight(cm.display);
          if (rect.top < 0) {
            rect.top = 0;
          }
          var screentop = cm.curOp && cm.curOp.scrollTop != null ? cm.curOp.scrollTop : display.scroller.scrollTop;
          var screen2 = displayHeight(cm), result = {};
          if (rect.bottom - rect.top > screen2) {
            rect.bottom = rect.top + screen2;
          }
          var docBottom = cm.doc.height + paddingVert(display);
          var atTop = rect.top < snapMargin, atBottom = rect.bottom > docBottom - snapMargin;
          if (rect.top < screentop) {
            result.scrollTop = atTop ? 0 : rect.top;
          } else if (rect.bottom > screentop + screen2) {
            var newTop = Math.min(rect.top, (atBottom ? docBottom : rect.bottom) - screen2);
            if (newTop != screentop) {
              result.scrollTop = newTop;
            }
          }
          var gutterSpace = cm.options.fixedGutter ? 0 : display.gutters.offsetWidth;
          var screenleft = cm.curOp && cm.curOp.scrollLeft != null ? cm.curOp.scrollLeft : display.scroller.scrollLeft - gutterSpace;
          var screenw = displayWidth(cm) - display.gutters.offsetWidth;
          var tooWide = rect.right - rect.left > screenw;
          if (tooWide) {
            rect.right = rect.left + screenw;
          }
          if (rect.left < 10) {
            result.scrollLeft = 0;
          } else if (rect.left < screenleft) {
            result.scrollLeft = Math.max(0, rect.left + gutterSpace - (tooWide ? 0 : 10));
          } else if (rect.right > screenw + screenleft - 3) {
            result.scrollLeft = rect.right + (tooWide ? 0 : 10) - screenw;
          }
          return result;
        }
        function addToScrollTop(cm, top) {
          if (top == null) {
            return;
          }
          resolveScrollToPos(cm);
          cm.curOp.scrollTop = (cm.curOp.scrollTop == null ? cm.doc.scrollTop : cm.curOp.scrollTop) + top;
        }
        function ensureCursorVisible(cm) {
          resolveScrollToPos(cm);
          var cur = cm.getCursor();
          cm.curOp.scrollToPos = { from: cur, to: cur, margin: cm.options.cursorScrollMargin };
        }
        function scrollToCoords(cm, x, y) {
          if (x != null || y != null) {
            resolveScrollToPos(cm);
          }
          if (x != null) {
            cm.curOp.scrollLeft = x;
          }
          if (y != null) {
            cm.curOp.scrollTop = y;
          }
        }
        function scrollToRange(cm, range2) {
          resolveScrollToPos(cm);
          cm.curOp.scrollToPos = range2;
        }
        function resolveScrollToPos(cm) {
          var range2 = cm.curOp.scrollToPos;
          if (range2) {
            cm.curOp.scrollToPos = null;
            var from = estimateCoords(cm, range2.from), to = estimateCoords(cm, range2.to);
            scrollToCoordsRange(cm, from, to, range2.margin);
          }
        }
        function scrollToCoordsRange(cm, from, to, margin) {
          var sPos = calculateScrollPos(cm, {
            left: Math.min(from.left, to.left),
            top: Math.min(from.top, to.top) - margin,
            right: Math.max(from.right, to.right),
            bottom: Math.max(from.bottom, to.bottom) + margin
          });
          scrollToCoords(cm, sPos.scrollLeft, sPos.scrollTop);
        }
        function updateScrollTop(cm, val) {
          if (Math.abs(cm.doc.scrollTop - val) < 2) {
            return;
          }
          if (!gecko) {
            updateDisplaySimple(cm, { top: val });
          }
          setScrollTop(cm, val, true);
          if (gecko) {
            updateDisplaySimple(cm);
          }
          startWorker(cm, 100);
        }
        function setScrollTop(cm, val, forceScroll) {
          val = Math.max(0, Math.min(cm.display.scroller.scrollHeight - cm.display.scroller.clientHeight, val));
          if (cm.display.scroller.scrollTop == val && !forceScroll) {
            return;
          }
          cm.doc.scrollTop = val;
          cm.display.scrollbars.setScrollTop(val);
          if (cm.display.scroller.scrollTop != val) {
            cm.display.scroller.scrollTop = val;
          }
        }
        function setScrollLeft(cm, val, isScroller, forceScroll) {
          val = Math.max(0, Math.min(val, cm.display.scroller.scrollWidth - cm.display.scroller.clientWidth));
          if ((isScroller ? val == cm.doc.scrollLeft : Math.abs(cm.doc.scrollLeft - val) < 2) && !forceScroll) {
            return;
          }
          cm.doc.scrollLeft = val;
          alignHorizontally(cm);
          if (cm.display.scroller.scrollLeft != val) {
            cm.display.scroller.scrollLeft = val;
          }
          cm.display.scrollbars.setScrollLeft(val);
        }
        function measureForScrollbars(cm) {
          var d = cm.display, gutterW = d.gutters.offsetWidth;
          var docH = Math.round(cm.doc.height + paddingVert(cm.display));
          return {
            clientHeight: d.scroller.clientHeight,
            viewHeight: d.wrapper.clientHeight,
            scrollWidth: d.scroller.scrollWidth,
            clientWidth: d.scroller.clientWidth,
            viewWidth: d.wrapper.clientWidth,
            barLeft: cm.options.fixedGutter ? gutterW : 0,
            docHeight: docH,
            scrollHeight: docH + scrollGap(cm) + d.barHeight,
            nativeBarWidth: d.nativeBarWidth,
            gutterWidth: gutterW
          };
        }
        var NativeScrollbars = function(place, scroll, cm) {
          this.cm = cm;
          var vert = this.vert = elt("div", [elt("div", null, null, "min-width: 1px")], "CodeMirror-vscrollbar");
          var horiz = this.horiz = elt("div", [elt("div", null, null, "height: 100%; min-height: 1px")], "CodeMirror-hscrollbar");
          vert.tabIndex = horiz.tabIndex = -1;
          place(vert);
          place(horiz);
          on(vert, "scroll", function() {
            if (vert.clientHeight) {
              scroll(vert.scrollTop, "vertical");
            }
          });
          on(horiz, "scroll", function() {
            if (horiz.clientWidth) {
              scroll(horiz.scrollLeft, "horizontal");
            }
          });
          this.checkedZeroWidth = false;
          if (ie && ie_version < 8) {
            this.horiz.style.minHeight = this.vert.style.minWidth = "18px";
          }
        };
        NativeScrollbars.prototype.update = function(measure) {
          var needsH = measure.scrollWidth > measure.clientWidth + 1;
          var needsV = measure.scrollHeight > measure.clientHeight + 1;
          var sWidth = measure.nativeBarWidth;
          if (needsV) {
            this.vert.style.display = "block";
            this.vert.style.bottom = needsH ? sWidth + "px" : "0";
            var totalHeight = measure.viewHeight - (needsH ? sWidth : 0);
            this.vert.firstChild.style.height = Math.max(0, measure.scrollHeight - measure.clientHeight + totalHeight) + "px";
          } else {
            this.vert.style.display = "";
            this.vert.firstChild.style.height = "0";
          }
          if (needsH) {
            this.horiz.style.display = "block";
            this.horiz.style.right = needsV ? sWidth + "px" : "0";
            this.horiz.style.left = measure.barLeft + "px";
            var totalWidth = measure.viewWidth - measure.barLeft - (needsV ? sWidth : 0);
            this.horiz.firstChild.style.width = Math.max(0, measure.scrollWidth - measure.clientWidth + totalWidth) + "px";
          } else {
            this.horiz.style.display = "";
            this.horiz.firstChild.style.width = "0";
          }
          if (!this.checkedZeroWidth && measure.clientHeight > 0) {
            if (sWidth == 0) {
              this.zeroWidthHack();
            }
            this.checkedZeroWidth = true;
          }
          return { right: needsV ? sWidth : 0, bottom: needsH ? sWidth : 0 };
        };
        NativeScrollbars.prototype.setScrollLeft = function(pos) {
          if (this.horiz.scrollLeft != pos) {
            this.horiz.scrollLeft = pos;
          }
          if (this.disableHoriz) {
            this.enableZeroWidthBar(this.horiz, this.disableHoriz, "horiz");
          }
        };
        NativeScrollbars.prototype.setScrollTop = function(pos) {
          if (this.vert.scrollTop != pos) {
            this.vert.scrollTop = pos;
          }
          if (this.disableVert) {
            this.enableZeroWidthBar(this.vert, this.disableVert, "vert");
          }
        };
        NativeScrollbars.prototype.zeroWidthHack = function() {
          var w = mac && !mac_geMountainLion ? "12px" : "18px";
          this.horiz.style.height = this.vert.style.width = w;
          this.horiz.style.pointerEvents = this.vert.style.pointerEvents = "none";
          this.disableHoriz = new Delayed();
          this.disableVert = new Delayed();
        };
        NativeScrollbars.prototype.enableZeroWidthBar = function(bar, delay, type2) {
          bar.style.pointerEvents = "auto";
          function maybeDisable() {
            var box = bar.getBoundingClientRect();
            var elt2 = type2 == "vert" ? document.elementFromPoint(box.right - 1, (box.top + box.bottom) / 2) : document.elementFromPoint((box.right + box.left) / 2, box.bottom - 1);
            if (elt2 != bar) {
              bar.style.pointerEvents = "none";
            } else {
              delay.set(1e3, maybeDisable);
            }
          }
          delay.set(1e3, maybeDisable);
        };
        NativeScrollbars.prototype.clear = function() {
          var parent = this.horiz.parentNode;
          parent.removeChild(this.horiz);
          parent.removeChild(this.vert);
        };
        var NullScrollbars = function() {
        };
        NullScrollbars.prototype.update = function() {
          return { bottom: 0, right: 0 };
        };
        NullScrollbars.prototype.setScrollLeft = function() {
        };
        NullScrollbars.prototype.setScrollTop = function() {
        };
        NullScrollbars.prototype.clear = function() {
        };
        function updateScrollbars(cm, measure) {
          if (!measure) {
            measure = measureForScrollbars(cm);
          }
          var startWidth = cm.display.barWidth, startHeight = cm.display.barHeight;
          updateScrollbarsInner(cm, measure);
          for (var i2 = 0; i2 < 4 && startWidth != cm.display.barWidth || startHeight != cm.display.barHeight; i2++) {
            if (startWidth != cm.display.barWidth && cm.options.lineWrapping) {
              updateHeightsInViewport(cm);
            }
            updateScrollbarsInner(cm, measureForScrollbars(cm));
            startWidth = cm.display.barWidth;
            startHeight = cm.display.barHeight;
          }
        }
        function updateScrollbarsInner(cm, measure) {
          var d = cm.display;
          var sizes = d.scrollbars.update(measure);
          d.sizer.style.paddingRight = (d.barWidth = sizes.right) + "px";
          d.sizer.style.paddingBottom = (d.barHeight = sizes.bottom) + "px";
          d.heightForcer.style.borderBottom = sizes.bottom + "px solid transparent";
          if (sizes.right && sizes.bottom) {
            d.scrollbarFiller.style.display = "block";
            d.scrollbarFiller.style.height = sizes.bottom + "px";
            d.scrollbarFiller.style.width = sizes.right + "px";
          } else {
            d.scrollbarFiller.style.display = "";
          }
          if (sizes.bottom && cm.options.coverGutterNextToScrollbar && cm.options.fixedGutter) {
            d.gutterFiller.style.display = "block";
            d.gutterFiller.style.height = sizes.bottom + "px";
            d.gutterFiller.style.width = measure.gutterWidth + "px";
          } else {
            d.gutterFiller.style.display = "";
          }
        }
        var scrollbarModel = { "native": NativeScrollbars, "null": NullScrollbars };
        function initScrollbars(cm) {
          if (cm.display.scrollbars) {
            cm.display.scrollbars.clear();
            if (cm.display.scrollbars.addClass) {
              rmClass(cm.display.wrapper, cm.display.scrollbars.addClass);
            }
          }
          cm.display.scrollbars = new scrollbarModel[cm.options.scrollbarStyle](function(node) {
            cm.display.wrapper.insertBefore(node, cm.display.scrollbarFiller);
            on(node, "mousedown", function() {
              if (cm.state.focused) {
                setTimeout(function() {
                  return cm.display.input.focus();
                }, 0);
              }
            });
            node.setAttribute("cm-not-content", "true");
          }, function(pos, axis) {
            if (axis == "horizontal") {
              setScrollLeft(cm, pos);
            } else {
              updateScrollTop(cm, pos);
            }
          }, cm);
          if (cm.display.scrollbars.addClass) {
            addClass(cm.display.wrapper, cm.display.scrollbars.addClass);
          }
        }
        var nextOpId = 0;
        function startOperation(cm) {
          cm.curOp = {
            cm,
            viewChanged: false,
            // Flag that indicates that lines might need to be redrawn
            startHeight: cm.doc.height,
            // Used to detect need to update scrollbar
            forceUpdate: false,
            // Used to force a redraw
            updateInput: 0,
            // Whether to reset the input textarea
            typing: false,
            // Whether this reset should be careful to leave existing text (for compositing)
            changeObjs: null,
            // Accumulated changes, for firing change events
            cursorActivityHandlers: null,
            // Set of handlers to fire cursorActivity on
            cursorActivityCalled: 0,
            // Tracks which cursorActivity handlers have been called already
            selectionChanged: false,
            // Whether the selection needs to be redrawn
            updateMaxLine: false,
            // Set when the widest line needs to be determined anew
            scrollLeft: null,
            scrollTop: null,
            // Intermediate scroll position, not pushed to DOM yet
            scrollToPos: null,
            // Used to scroll to a specific position
            focus: false,
            id: ++nextOpId,
            // Unique ID
            markArrays: null
            // Used by addMarkedSpan
          };
          pushOperation(cm.curOp);
        }
        function endOperation(cm) {
          var op = cm.curOp;
          if (op) {
            finishOperation(op, function(group) {
              for (var i2 = 0; i2 < group.ops.length; i2++) {
                group.ops[i2].cm.curOp = null;
              }
              endOperations(group);
            });
          }
        }
        function endOperations(group) {
          var ops = group.ops;
          for (var i2 = 0; i2 < ops.length; i2++) {
            endOperation_R1(ops[i2]);
          }
          for (var i$12 = 0; i$12 < ops.length; i$12++) {
            endOperation_W1(ops[i$12]);
          }
          for (var i$22 = 0; i$22 < ops.length; i$22++) {
            endOperation_R2(ops[i$22]);
          }
          for (var i$3 = 0; i$3 < ops.length; i$3++) {
            endOperation_W2(ops[i$3]);
          }
          for (var i$4 = 0; i$4 < ops.length; i$4++) {
            endOperation_finish(ops[i$4]);
          }
        }
        function endOperation_R1(op) {
          var cm = op.cm, display = cm.display;
          maybeClipScrollbars(cm);
          if (op.updateMaxLine) {
            findMaxLine(cm);
          }
          op.mustUpdate = op.viewChanged || op.forceUpdate || op.scrollTop != null || op.scrollToPos && (op.scrollToPos.from.line < display.viewFrom || op.scrollToPos.to.line >= display.viewTo) || display.maxLineChanged && cm.options.lineWrapping;
          op.update = op.mustUpdate && new DisplayUpdate(cm, op.mustUpdate && { top: op.scrollTop, ensure: op.scrollToPos }, op.forceUpdate);
        }
        function endOperation_W1(op) {
          op.updatedDisplay = op.mustUpdate && updateDisplayIfNeeded(op.cm, op.update);
        }
        function endOperation_R2(op) {
          var cm = op.cm, display = cm.display;
          if (op.updatedDisplay) {
            updateHeightsInViewport(cm);
          }
          op.barMeasure = measureForScrollbars(cm);
          if (display.maxLineChanged && !cm.options.lineWrapping) {
            op.adjustWidthTo = measureChar(cm, display.maxLine, display.maxLine.text.length).left + 3;
            cm.display.sizerWidth = op.adjustWidthTo;
            op.barMeasure.scrollWidth = Math.max(display.scroller.clientWidth, display.sizer.offsetLeft + op.adjustWidthTo + scrollGap(cm) + cm.display.barWidth);
            op.maxScrollLeft = Math.max(0, display.sizer.offsetLeft + op.adjustWidthTo - displayWidth(cm));
          }
          if (op.updatedDisplay || op.selectionChanged) {
            op.preparedSelection = display.input.prepareSelection();
          }
        }
        function endOperation_W2(op) {
          var cm = op.cm;
          if (op.adjustWidthTo != null) {
            cm.display.sizer.style.minWidth = op.adjustWidthTo + "px";
            if (op.maxScrollLeft < cm.doc.scrollLeft) {
              setScrollLeft(cm, Math.min(cm.display.scroller.scrollLeft, op.maxScrollLeft), true);
            }
            cm.display.maxLineChanged = false;
          }
          var takeFocus = op.focus && op.focus == activeElt();
          if (op.preparedSelection) {
            cm.display.input.showSelection(op.preparedSelection, takeFocus);
          }
          if (op.updatedDisplay || op.startHeight != cm.doc.height) {
            updateScrollbars(cm, op.barMeasure);
          }
          if (op.updatedDisplay) {
            setDocumentHeight(cm, op.barMeasure);
          }
          if (op.selectionChanged) {
            restartBlink(cm);
          }
          if (cm.state.focused && op.updateInput) {
            cm.display.input.reset(op.typing);
          }
          if (takeFocus) {
            ensureFocus(op.cm);
          }
        }
        function endOperation_finish(op) {
          var cm = op.cm, display = cm.display, doc = cm.doc;
          if (op.updatedDisplay) {
            postUpdateDisplay(cm, op.update);
          }
          if (display.wheelStartX != null && (op.scrollTop != null || op.scrollLeft != null || op.scrollToPos)) {
            display.wheelStartX = display.wheelStartY = null;
          }
          if (op.scrollTop != null) {
            setScrollTop(cm, op.scrollTop, op.forceScroll);
          }
          if (op.scrollLeft != null) {
            setScrollLeft(cm, op.scrollLeft, true, true);
          }
          if (op.scrollToPos) {
            var rect = scrollPosIntoView(
              cm,
              clipPos(doc, op.scrollToPos.from),
              clipPos(doc, op.scrollToPos.to),
              op.scrollToPos.margin
            );
            maybeScrollWindow(cm, rect);
          }
          var hidden = op.maybeHiddenMarkers, unhidden = op.maybeUnhiddenMarkers;
          if (hidden) {
            for (var i2 = 0; i2 < hidden.length; ++i2) {
              if (!hidden[i2].lines.length) {
                signal(hidden[i2], "hide");
              }
            }
          }
          if (unhidden) {
            for (var i$12 = 0; i$12 < unhidden.length; ++i$12) {
              if (unhidden[i$12].lines.length) {
                signal(unhidden[i$12], "unhide");
              }
            }
          }
          if (display.wrapper.offsetHeight) {
            doc.scrollTop = cm.display.scroller.scrollTop;
          }
          if (op.changeObjs) {
            signal(cm, "changes", cm, op.changeObjs);
          }
          if (op.update) {
            op.update.finish();
          }
        }
        function runInOp(cm, f) {
          if (cm.curOp) {
            return f();
          }
          startOperation(cm);
          try {
            return f();
          } finally {
            endOperation(cm);
          }
        }
        function operation(cm, f) {
          return function() {
            if (cm.curOp) {
              return f.apply(cm, arguments);
            }
            startOperation(cm);
            try {
              return f.apply(cm, arguments);
            } finally {
              endOperation(cm);
            }
          };
        }
        function methodOp(f) {
          return function() {
            if (this.curOp) {
              return f.apply(this, arguments);
            }
            startOperation(this);
            try {
              return f.apply(this, arguments);
            } finally {
              endOperation(this);
            }
          };
        }
        function docMethodOp(f) {
          return function() {
            var cm = this.cm;
            if (!cm || cm.curOp) {
              return f.apply(this, arguments);
            }
            startOperation(cm);
            try {
              return f.apply(this, arguments);
            } finally {
              endOperation(cm);
            }
          };
        }
        function startWorker(cm, time) {
          if (cm.doc.highlightFrontier < cm.display.viewTo) {
            cm.state.highlight.set(time, bind2(highlightWorker, cm));
          }
        }
        function highlightWorker(cm) {
          var doc = cm.doc;
          if (doc.highlightFrontier >= cm.display.viewTo) {
            return;
          }
          var end = +/* @__PURE__ */ new Date() + cm.options.workTime;
          var context = getContextBefore(cm, doc.highlightFrontier);
          var changedLines = [];
          doc.iter(context.line, Math.min(doc.first + doc.size, cm.display.viewTo + 500), function(line) {
            if (context.line >= cm.display.viewFrom) {
              var oldStyles = line.styles;
              var resetState = line.text.length > cm.options.maxHighlightLength ? copyState(doc.mode, context.state) : null;
              var highlighted = highlightLine(cm, line, context, true);
              if (resetState) {
                context.state = resetState;
              }
              line.styles = highlighted.styles;
              var oldCls = line.styleClasses, newCls = highlighted.classes;
              if (newCls) {
                line.styleClasses = newCls;
              } else if (oldCls) {
                line.styleClasses = null;
              }
              var ischange = !oldStyles || oldStyles.length != line.styles.length || oldCls != newCls && (!oldCls || !newCls || oldCls.bgClass != newCls.bgClass || oldCls.textClass != newCls.textClass);
              for (var i2 = 0; !ischange && i2 < oldStyles.length; ++i2) {
                ischange = oldStyles[i2] != line.styles[i2];
              }
              if (ischange) {
                changedLines.push(context.line);
              }
              line.stateAfter = context.save();
              context.nextLine();
            } else {
              if (line.text.length <= cm.options.maxHighlightLength) {
                processLine(cm, line.text, context);
              }
              line.stateAfter = context.line % 5 == 0 ? context.save() : null;
              context.nextLine();
            }
            if (+/* @__PURE__ */ new Date() > end) {
              startWorker(cm, cm.options.workDelay);
              return true;
            }
          });
          doc.highlightFrontier = context.line;
          doc.modeFrontier = Math.max(doc.modeFrontier, context.line);
          if (changedLines.length) {
            runInOp(cm, function() {
              for (var i2 = 0; i2 < changedLines.length; i2++) {
                regLineChange(cm, changedLines[i2], "text");
              }
            });
          }
        }
        var DisplayUpdate = function(cm, viewport, force) {
          var display = cm.display;
          this.viewport = viewport;
          this.visible = visibleLines(display, cm.doc, viewport);
          this.editorIsHidden = !display.wrapper.offsetWidth;
          this.wrapperHeight = display.wrapper.clientHeight;
          this.wrapperWidth = display.wrapper.clientWidth;
          this.oldDisplayWidth = displayWidth(cm);
          this.force = force;
          this.dims = getDimensions(cm);
          this.events = [];
        };
        DisplayUpdate.prototype.signal = function(emitter, type2) {
          if (hasHandler(emitter, type2)) {
            this.events.push(arguments);
          }
        };
        DisplayUpdate.prototype.finish = function() {
          for (var i2 = 0; i2 < this.events.length; i2++) {
            signal.apply(null, this.events[i2]);
          }
        };
        function maybeClipScrollbars(cm) {
          var display = cm.display;
          if (!display.scrollbarsClipped && display.scroller.offsetWidth) {
            display.nativeBarWidth = display.scroller.offsetWidth - display.scroller.clientWidth;
            display.heightForcer.style.height = scrollGap(cm) + "px";
            display.sizer.style.marginBottom = -display.nativeBarWidth + "px";
            display.sizer.style.borderRightWidth = scrollGap(cm) + "px";
            display.scrollbarsClipped = true;
          }
        }
        function selectionSnapshot(cm) {
          if (cm.hasFocus()) {
            return null;
          }
          var active = activeElt();
          if (!active || !contains(cm.display.lineDiv, active)) {
            return null;
          }
          var result = { activeElt: active };
          if (window.getSelection) {
            var sel = window.getSelection();
            if (sel.anchorNode && sel.extend && contains(cm.display.lineDiv, sel.anchorNode)) {
              result.anchorNode = sel.anchorNode;
              result.anchorOffset = sel.anchorOffset;
              result.focusNode = sel.focusNode;
              result.focusOffset = sel.focusOffset;
            }
          }
          return result;
        }
        function restoreSelection(snapshot) {
          if (!snapshot || !snapshot.activeElt || snapshot.activeElt == activeElt()) {
            return;
          }
          snapshot.activeElt.focus();
          if (!/^(INPUT|TEXTAREA)$/.test(snapshot.activeElt.nodeName) && snapshot.anchorNode && contains(document.body, snapshot.anchorNode) && contains(document.body, snapshot.focusNode)) {
            var sel = window.getSelection(), range2 = document.createRange();
            range2.setEnd(snapshot.anchorNode, snapshot.anchorOffset);
            range2.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range2);
            sel.extend(snapshot.focusNode, snapshot.focusOffset);
          }
        }
        function updateDisplayIfNeeded(cm, update) {
          var display = cm.display, doc = cm.doc;
          if (update.editorIsHidden) {
            resetView(cm);
            return false;
          }
          if (!update.force && update.visible.from >= display.viewFrom && update.visible.to <= display.viewTo && (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo) && display.renderedView == display.view && countDirtyView(cm) == 0) {
            return false;
          }
          if (maybeUpdateLineNumberWidth(cm)) {
            resetView(cm);
            update.dims = getDimensions(cm);
          }
          var end = doc.first + doc.size;
          var from = Math.max(update.visible.from - cm.options.viewportMargin, doc.first);
          var to = Math.min(end, update.visible.to + cm.options.viewportMargin);
          if (display.viewFrom < from && from - display.viewFrom < 20) {
            from = Math.max(doc.first, display.viewFrom);
          }
          if (display.viewTo > to && display.viewTo - to < 20) {
            to = Math.min(end, display.viewTo);
          }
          if (sawCollapsedSpans) {
            from = visualLineNo(cm.doc, from);
            to = visualLineEndNo(cm.doc, to);
          }
          var different = from != display.viewFrom || to != display.viewTo || display.lastWrapHeight != update.wrapperHeight || display.lastWrapWidth != update.wrapperWidth;
          adjustView(cm, from, to);
          display.viewOffset = heightAtLine(getLine(cm.doc, display.viewFrom));
          cm.display.mover.style.top = display.viewOffset + "px";
          var toUpdate = countDirtyView(cm);
          if (!different && toUpdate == 0 && !update.force && display.renderedView == display.view && (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo)) {
            return false;
          }
          var selSnapshot = selectionSnapshot(cm);
          if (toUpdate > 4) {
            display.lineDiv.style.display = "none";
          }
          patchDisplay(cm, display.updateLineNumbers, update.dims);
          if (toUpdate > 4) {
            display.lineDiv.style.display = "";
          }
          display.renderedView = display.view;
          restoreSelection(selSnapshot);
          removeChildren(display.cursorDiv);
          removeChildren(display.selectionDiv);
          display.gutters.style.height = display.sizer.style.minHeight = 0;
          if (different) {
            display.lastWrapHeight = update.wrapperHeight;
            display.lastWrapWidth = update.wrapperWidth;
            startWorker(cm, 400);
          }
          display.updateLineNumbers = null;
          return true;
        }
        function postUpdateDisplay(cm, update) {
          var viewport = update.viewport;
          for (var first = true; ; first = false) {
            if (!first || !cm.options.lineWrapping || update.oldDisplayWidth == displayWidth(cm)) {
              if (viewport && viewport.top != null) {
                viewport = { top: Math.min(cm.doc.height + paddingVert(cm.display) - displayHeight(cm), viewport.top) };
              }
              update.visible = visibleLines(cm.display, cm.doc, viewport);
              if (update.visible.from >= cm.display.viewFrom && update.visible.to <= cm.display.viewTo) {
                break;
              }
            } else if (first) {
              update.visible = visibleLines(cm.display, cm.doc, viewport);
            }
            if (!updateDisplayIfNeeded(cm, update)) {
              break;
            }
            updateHeightsInViewport(cm);
            var barMeasure = measureForScrollbars(cm);
            updateSelection(cm);
            updateScrollbars(cm, barMeasure);
            setDocumentHeight(cm, barMeasure);
            update.force = false;
          }
          update.signal(cm, "update", cm);
          if (cm.display.viewFrom != cm.display.reportedViewFrom || cm.display.viewTo != cm.display.reportedViewTo) {
            update.signal(cm, "viewportChange", cm, cm.display.viewFrom, cm.display.viewTo);
            cm.display.reportedViewFrom = cm.display.viewFrom;
            cm.display.reportedViewTo = cm.display.viewTo;
          }
        }
        function updateDisplaySimple(cm, viewport) {
          var update = new DisplayUpdate(cm, viewport);
          if (updateDisplayIfNeeded(cm, update)) {
            updateHeightsInViewport(cm);
            postUpdateDisplay(cm, update);
            var barMeasure = measureForScrollbars(cm);
            updateSelection(cm);
            updateScrollbars(cm, barMeasure);
            setDocumentHeight(cm, barMeasure);
            update.finish();
          }
        }
        function patchDisplay(cm, updateNumbersFrom, dims) {
          var display = cm.display, lineNumbers = cm.options.lineNumbers;
          var container = display.lineDiv, cur = container.firstChild;
          function rm(node2) {
            var next = node2.nextSibling;
            if (webkit && mac && cm.display.currentWheelTarget == node2) {
              node2.style.display = "none";
            } else {
              node2.parentNode.removeChild(node2);
            }
            return next;
          }
          var view = display.view, lineN = display.viewFrom;
          for (var i2 = 0; i2 < view.length; i2++) {
            var lineView = view[i2];
            if (lineView.hidden)
              ;
            else if (!lineView.node || lineView.node.parentNode != container) {
              var node = buildLineElement(cm, lineView, lineN, dims);
              container.insertBefore(node, cur);
            } else {
              while (cur != lineView.node) {
                cur = rm(cur);
              }
              var updateNumber = lineNumbers && updateNumbersFrom != null && updateNumbersFrom <= lineN && lineView.lineNumber;
              if (lineView.changes) {
                if (indexOf(lineView.changes, "gutter") > -1) {
                  updateNumber = false;
                }
                updateLineForChanges(cm, lineView, lineN, dims);
              }
              if (updateNumber) {
                removeChildren(lineView.lineNumber);
                lineView.lineNumber.appendChild(document.createTextNode(lineNumberFor(cm.options, lineN)));
              }
              cur = lineView.node.nextSibling;
            }
            lineN += lineView.size;
          }
          while (cur) {
            cur = rm(cur);
          }
        }
        function updateGutterSpace(display) {
          var width = display.gutters.offsetWidth;
          display.sizer.style.marginLeft = width + "px";
          signalLater(display, "gutterChanged", display);
        }
        function setDocumentHeight(cm, measure) {
          cm.display.sizer.style.minHeight = measure.docHeight + "px";
          cm.display.heightForcer.style.top = measure.docHeight + "px";
          cm.display.gutters.style.height = measure.docHeight + cm.display.barHeight + scrollGap(cm) + "px";
        }
        function alignHorizontally(cm) {
          var display = cm.display, view = display.view;
          if (!display.alignWidgets && (!display.gutters.firstChild || !cm.options.fixedGutter)) {
            return;
          }
          var comp = compensateForHScroll(display) - display.scroller.scrollLeft + cm.doc.scrollLeft;
          var gutterW = display.gutters.offsetWidth, left = comp + "px";
          for (var i2 = 0; i2 < view.length; i2++) {
            if (!view[i2].hidden) {
              if (cm.options.fixedGutter) {
                if (view[i2].gutter) {
                  view[i2].gutter.style.left = left;
                }
                if (view[i2].gutterBackground) {
                  view[i2].gutterBackground.style.left = left;
                }
              }
              var align = view[i2].alignable;
              if (align) {
                for (var j = 0; j < align.length; j++) {
                  align[j].style.left = left;
                }
              }
            }
          }
          if (cm.options.fixedGutter) {
            display.gutters.style.left = comp + gutterW + "px";
          }
        }
        function maybeUpdateLineNumberWidth(cm) {
          if (!cm.options.lineNumbers) {
            return false;
          }
          var doc = cm.doc, last = lineNumberFor(cm.options, doc.first + doc.size - 1), display = cm.display;
          if (last.length != display.lineNumChars) {
            var test = display.measure.appendChild(elt(
              "div",
              [elt("div", last)],
              "CodeMirror-linenumber CodeMirror-gutter-elt"
            ));
            var innerW = test.firstChild.offsetWidth, padding = test.offsetWidth - innerW;
            display.lineGutter.style.width = "";
            display.lineNumInnerWidth = Math.max(innerW, display.lineGutter.offsetWidth - padding) + 1;
            display.lineNumWidth = display.lineNumInnerWidth + padding;
            display.lineNumChars = display.lineNumInnerWidth ? last.length : -1;
            display.lineGutter.style.width = display.lineNumWidth + "px";
            updateGutterSpace(cm.display);
            return true;
          }
          return false;
        }
        function getGutters(gutters, lineNumbers) {
          var result = [], sawLineNumbers = false;
          for (var i2 = 0; i2 < gutters.length; i2++) {
            var name = gutters[i2], style = null;
            if (typeof name != "string") {
              style = name.style;
              name = name.className;
            }
            if (name == "CodeMirror-linenumbers") {
              if (!lineNumbers) {
                continue;
              } else {
                sawLineNumbers = true;
              }
            }
            result.push({ className: name, style });
          }
          if (lineNumbers && !sawLineNumbers) {
            result.push({ className: "CodeMirror-linenumbers", style: null });
          }
          return result;
        }
        function renderGutters(display) {
          var gutters = display.gutters, specs = display.gutterSpecs;
          removeChildren(gutters);
          display.lineGutter = null;
          for (var i2 = 0; i2 < specs.length; ++i2) {
            var ref = specs[i2];
            var className = ref.className;
            var style = ref.style;
            var gElt = gutters.appendChild(elt("div", null, "CodeMirror-gutter " + className));
            if (style) {
              gElt.style.cssText = style;
            }
            if (className == "CodeMirror-linenumbers") {
              display.lineGutter = gElt;
              gElt.style.width = (display.lineNumWidth || 1) + "px";
            }
          }
          gutters.style.display = specs.length ? "" : "none";
          updateGutterSpace(display);
        }
        function updateGutters(cm) {
          renderGutters(cm.display);
          regChange(cm);
          alignHorizontally(cm);
        }
        function Display(place, doc, input, options) {
          var d = this;
          this.input = input;
          d.scrollbarFiller = elt("div", null, "CodeMirror-scrollbar-filler");
          d.scrollbarFiller.setAttribute("cm-not-content", "true");
          d.gutterFiller = elt("div", null, "CodeMirror-gutter-filler");
          d.gutterFiller.setAttribute("cm-not-content", "true");
          d.lineDiv = eltP("div", null, "CodeMirror-code");
          d.selectionDiv = elt("div", null, null, "position: relative; z-index: 1");
          d.cursorDiv = elt("div", null, "CodeMirror-cursors");
          d.measure = elt("div", null, "CodeMirror-measure");
          d.lineMeasure = elt("div", null, "CodeMirror-measure");
          d.lineSpace = eltP(
            "div",
            [d.measure, d.lineMeasure, d.selectionDiv, d.cursorDiv, d.lineDiv],
            null,
            "position: relative; outline: none"
          );
          var lines = eltP("div", [d.lineSpace], "CodeMirror-lines");
          d.mover = elt("div", [lines], null, "position: relative");
          d.sizer = elt("div", [d.mover], "CodeMirror-sizer");
          d.sizerWidth = null;
          d.heightForcer = elt("div", null, null, "position: absolute; height: " + scrollerGap + "px; width: 1px;");
          d.gutters = elt("div", null, "CodeMirror-gutters");
          d.lineGutter = null;
          d.scroller = elt("div", [d.sizer, d.heightForcer, d.gutters], "CodeMirror-scroll");
          d.scroller.setAttribute("tabIndex", "-1");
          d.wrapper = elt("div", [d.scrollbarFiller, d.gutterFiller, d.scroller], "CodeMirror");
          d.wrapper.setAttribute("translate", "no");
          if (ie && ie_version < 8) {
            d.gutters.style.zIndex = -1;
            d.scroller.style.paddingRight = 0;
          }
          if (!webkit && !(gecko && mobile)) {
            d.scroller.draggable = true;
          }
          if (place) {
            if (place.appendChild) {
              place.appendChild(d.wrapper);
            } else {
              place(d.wrapper);
            }
          }
          d.viewFrom = d.viewTo = doc.first;
          d.reportedViewFrom = d.reportedViewTo = doc.first;
          d.view = [];
          d.renderedView = null;
          d.externalMeasured = null;
          d.viewOffset = 0;
          d.lastWrapHeight = d.lastWrapWidth = 0;
          d.updateLineNumbers = null;
          d.nativeBarWidth = d.barHeight = d.barWidth = 0;
          d.scrollbarsClipped = false;
          d.lineNumWidth = d.lineNumInnerWidth = d.lineNumChars = null;
          d.alignWidgets = false;
          d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null;
          d.maxLine = null;
          d.maxLineLength = 0;
          d.maxLineChanged = false;
          d.wheelDX = d.wheelDY = d.wheelStartX = d.wheelStartY = null;
          d.shift = false;
          d.selForContextMenu = null;
          d.activeTouch = null;
          d.gutterSpecs = getGutters(options.gutters, options.lineNumbers);
          renderGutters(d);
          input.init(d);
        }
        var wheelSamples = 0, wheelPixelsPerUnit = null;
        if (ie) {
          wheelPixelsPerUnit = -0.53;
        } else if (gecko) {
          wheelPixelsPerUnit = 15;
        } else if (chrome) {
          wheelPixelsPerUnit = -0.7;
        } else if (safari) {
          wheelPixelsPerUnit = -1 / 3;
        }
        function wheelEventDelta(e) {
          var dx = e.wheelDeltaX, dy = e.wheelDeltaY;
          if (dx == null && e.detail && e.axis == e.HORIZONTAL_AXIS) {
            dx = e.detail;
          }
          if (dy == null && e.detail && e.axis == e.VERTICAL_AXIS) {
            dy = e.detail;
          } else if (dy == null) {
            dy = e.wheelDelta;
          }
          return { x: dx, y: dy };
        }
        function wheelEventPixels(e) {
          var delta = wheelEventDelta(e);
          delta.x *= wheelPixelsPerUnit;
          delta.y *= wheelPixelsPerUnit;
          return delta;
        }
        function onScrollWheel(cm, e) {
          var delta = wheelEventDelta(e), dx = delta.x, dy = delta.y;
          var display = cm.display, scroll = display.scroller;
          var canScrollX = scroll.scrollWidth > scroll.clientWidth;
          var canScrollY = scroll.scrollHeight > scroll.clientHeight;
          if (!(dx && canScrollX || dy && canScrollY)) {
            return;
          }
          if (dy && mac && webkit) {
            outer:
              for (var cur = e.target, view = display.view; cur != scroll; cur = cur.parentNode) {
                for (var i2 = 0; i2 < view.length; i2++) {
                  if (view[i2].node == cur) {
                    cm.display.currentWheelTarget = cur;
                    break outer;
                  }
                }
              }
          }
          if (dx && !gecko && !presto && wheelPixelsPerUnit != null) {
            if (dy && canScrollY) {
              updateScrollTop(cm, Math.max(0, scroll.scrollTop + dy * wheelPixelsPerUnit));
            }
            setScrollLeft(cm, Math.max(0, scroll.scrollLeft + dx * wheelPixelsPerUnit));
            if (!dy || dy && canScrollY) {
              e_preventDefault(e);
            }
            display.wheelStartX = null;
            return;
          }
          if (dy && wheelPixelsPerUnit != null) {
            var pixels = dy * wheelPixelsPerUnit;
            var top = cm.doc.scrollTop, bot = top + display.wrapper.clientHeight;
            if (pixels < 0) {
              top = Math.max(0, top + pixels - 50);
            } else {
              bot = Math.min(cm.doc.height, bot + pixels + 50);
            }
            updateDisplaySimple(cm, { top, bottom: bot });
          }
          if (wheelSamples < 20) {
            if (display.wheelStartX == null) {
              display.wheelStartX = scroll.scrollLeft;
              display.wheelStartY = scroll.scrollTop;
              display.wheelDX = dx;
              display.wheelDY = dy;
              setTimeout(function() {
                if (display.wheelStartX == null) {
                  return;
                }
                var movedX = scroll.scrollLeft - display.wheelStartX;
                var movedY = scroll.scrollTop - display.wheelStartY;
                var sample = movedY && display.wheelDY && movedY / display.wheelDY || movedX && display.wheelDX && movedX / display.wheelDX;
                display.wheelStartX = display.wheelStartY = null;
                if (!sample) {
                  return;
                }
                wheelPixelsPerUnit = (wheelPixelsPerUnit * wheelSamples + sample) / (wheelSamples + 1);
                ++wheelSamples;
              }, 200);
            } else {
              display.wheelDX += dx;
              display.wheelDY += dy;
            }
          }
        }
        var Selection = function(ranges, primIndex) {
          this.ranges = ranges;
          this.primIndex = primIndex;
        };
        Selection.prototype.primary = function() {
          return this.ranges[this.primIndex];
        };
        Selection.prototype.equals = function(other) {
          if (other == this) {
            return true;
          }
          if (other.primIndex != this.primIndex || other.ranges.length != this.ranges.length) {
            return false;
          }
          for (var i2 = 0; i2 < this.ranges.length; i2++) {
            var here = this.ranges[i2], there = other.ranges[i2];
            if (!equalCursorPos(here.anchor, there.anchor) || !equalCursorPos(here.head, there.head)) {
              return false;
            }
          }
          return true;
        };
        Selection.prototype.deepCopy = function() {
          var out = [];
          for (var i2 = 0; i2 < this.ranges.length; i2++) {
            out[i2] = new Range(copyPos(this.ranges[i2].anchor), copyPos(this.ranges[i2].head));
          }
          return new Selection(out, this.primIndex);
        };
        Selection.prototype.somethingSelected = function() {
          for (var i2 = 0; i2 < this.ranges.length; i2++) {
            if (!this.ranges[i2].empty()) {
              return true;
            }
          }
          return false;
        };
        Selection.prototype.contains = function(pos, end) {
          if (!end) {
            end = pos;
          }
          for (var i2 = 0; i2 < this.ranges.length; i2++) {
            var range2 = this.ranges[i2];
            if (cmp(end, range2.from()) >= 0 && cmp(pos, range2.to()) <= 0) {
              return i2;
            }
          }
          return -1;
        };
        var Range = function(anchor, head) {
          this.anchor = anchor;
          this.head = head;
        };
        Range.prototype.from = function() {
          return minPos(this.anchor, this.head);
        };
        Range.prototype.to = function() {
          return maxPos(this.anchor, this.head);
        };
        Range.prototype.empty = function() {
          return this.head.line == this.anchor.line && this.head.ch == this.anchor.ch;
        };
        function normalizeSelection(cm, ranges, primIndex) {
          var mayTouch = cm && cm.options.selectionsMayTouch;
          var prim = ranges[primIndex];
          ranges.sort(function(a, b) {
            return cmp(a.from(), b.from());
          });
          primIndex = indexOf(ranges, prim);
          for (var i2 = 1; i2 < ranges.length; i2++) {
            var cur = ranges[i2], prev = ranges[i2 - 1];
            var diff = cmp(prev.to(), cur.from());
            if (mayTouch && !cur.empty() ? diff > 0 : diff >= 0) {
              var from = minPos(prev.from(), cur.from()), to = maxPos(prev.to(), cur.to());
              var inv = prev.empty() ? cur.from() == cur.head : prev.from() == prev.head;
              if (i2 <= primIndex) {
                --primIndex;
              }
              ranges.splice(--i2, 2, new Range(inv ? to : from, inv ? from : to));
            }
          }
          return new Selection(ranges, primIndex);
        }
        function simpleSelection(anchor, head) {
          return new Selection([new Range(anchor, head || anchor)], 0);
        }
        function changeEnd(change) {
          if (!change.text) {
            return change.to;
          }
          return Pos(
            change.from.line + change.text.length - 1,
            lst(change.text).length + (change.text.length == 1 ? change.from.ch : 0)
          );
        }
        function adjustForChange(pos, change) {
          if (cmp(pos, change.from) < 0) {
            return pos;
          }
          if (cmp(pos, change.to) <= 0) {
            return changeEnd(change);
          }
          var line = pos.line + change.text.length - (change.to.line - change.from.line) - 1, ch = pos.ch;
          if (pos.line == change.to.line) {
            ch += changeEnd(change).ch - change.to.ch;
          }
          return Pos(line, ch);
        }
        function computeSelAfterChange(doc, change) {
          var out = [];
          for (var i2 = 0; i2 < doc.sel.ranges.length; i2++) {
            var range2 = doc.sel.ranges[i2];
            out.push(new Range(
              adjustForChange(range2.anchor, change),
              adjustForChange(range2.head, change)
            ));
          }
          return normalizeSelection(doc.cm, out, doc.sel.primIndex);
        }
        function offsetPos(pos, old, nw) {
          if (pos.line == old.line) {
            return Pos(nw.line, pos.ch - old.ch + nw.ch);
          } else {
            return Pos(nw.line + (pos.line - old.line), pos.ch);
          }
        }
        function computeReplacedSel(doc, changes, hint) {
          var out = [];
          var oldPrev = Pos(doc.first, 0), newPrev = oldPrev;
          for (var i2 = 0; i2 < changes.length; i2++) {
            var change = changes[i2];
            var from = offsetPos(change.from, oldPrev, newPrev);
            var to = offsetPos(changeEnd(change), oldPrev, newPrev);
            oldPrev = change.to;
            newPrev = to;
            if (hint == "around") {
              var range2 = doc.sel.ranges[i2], inv = cmp(range2.head, range2.anchor) < 0;
              out[i2] = new Range(inv ? to : from, inv ? from : to);
            } else {
              out[i2] = new Range(from, from);
            }
          }
          return new Selection(out, doc.sel.primIndex);
        }
        function loadMode(cm) {
          cm.doc.mode = getMode(cm.options, cm.doc.modeOption);
          resetModeState(cm);
        }
        function resetModeState(cm) {
          cm.doc.iter(function(line) {
            if (line.stateAfter) {
              line.stateAfter = null;
            }
            if (line.styles) {
              line.styles = null;
            }
          });
          cm.doc.modeFrontier = cm.doc.highlightFrontier = cm.doc.first;
          startWorker(cm, 100);
          cm.state.modeGen++;
          if (cm.curOp) {
            regChange(cm);
          }
        }
        function isWholeLineUpdate(doc, change) {
          return change.from.ch == 0 && change.to.ch == 0 && lst(change.text) == "" && (!doc.cm || doc.cm.options.wholeLineUpdateBefore);
        }
        function updateDoc(doc, change, markedSpans, estimateHeight2) {
          function spansFor(n) {
            return markedSpans ? markedSpans[n] : null;
          }
          function update(line, text2, spans) {
            updateLine(line, text2, spans, estimateHeight2);
            signalLater(line, "change", line, change);
          }
          function linesFor(start, end) {
            var result = [];
            for (var i2 = start; i2 < end; ++i2) {
              result.push(new Line(text[i2], spansFor(i2), estimateHeight2));
            }
            return result;
          }
          var from = change.from, to = change.to, text = change.text;
          var firstLine = getLine(doc, from.line), lastLine = getLine(doc, to.line);
          var lastText = lst(text), lastSpans = spansFor(text.length - 1), nlines = to.line - from.line;
          if (change.full) {
            doc.insert(0, linesFor(0, text.length));
            doc.remove(text.length, doc.size - text.length);
          } else if (isWholeLineUpdate(doc, change)) {
            var added = linesFor(0, text.length - 1);
            update(lastLine, lastLine.text, lastSpans);
            if (nlines) {
              doc.remove(from.line, nlines);
            }
            if (added.length) {
              doc.insert(from.line, added);
            }
          } else if (firstLine == lastLine) {
            if (text.length == 1) {
              update(firstLine, firstLine.text.slice(0, from.ch) + lastText + firstLine.text.slice(to.ch), lastSpans);
            } else {
              var added$1 = linesFor(1, text.length - 1);
              added$1.push(new Line(lastText + firstLine.text.slice(to.ch), lastSpans, estimateHeight2));
              update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));
              doc.insert(from.line + 1, added$1);
            }
          } else if (text.length == 1) {
            update(firstLine, firstLine.text.slice(0, from.ch) + text[0] + lastLine.text.slice(to.ch), spansFor(0));
            doc.remove(from.line + 1, nlines);
          } else {
            update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));
            update(lastLine, lastText + lastLine.text.slice(to.ch), lastSpans);
            var added$2 = linesFor(1, text.length - 1);
            if (nlines > 1) {
              doc.remove(from.line + 1, nlines - 1);
            }
            doc.insert(from.line + 1, added$2);
          }
          signalLater(doc, "change", doc, change);
        }
        function linkedDocs(doc, f, sharedHistOnly) {
          function propagate(doc2, skip, sharedHist) {
            if (doc2.linked) {
              for (var i2 = 0; i2 < doc2.linked.length; ++i2) {
                var rel = doc2.linked[i2];
                if (rel.doc == skip) {
                  continue;
                }
                var shared = sharedHist && rel.sharedHist;
                if (sharedHistOnly && !shared) {
                  continue;
                }
                f(rel.doc, shared);
                propagate(rel.doc, doc2, shared);
              }
            }
          }
          propagate(doc, null, true);
        }
        function attachDoc(cm, doc) {
          if (doc.cm) {
            throw new Error("This document is already in use.");
          }
          cm.doc = doc;
          doc.cm = cm;
          estimateLineHeights(cm);
          loadMode(cm);
          setDirectionClass(cm);
          cm.options.direction = doc.direction;
          if (!cm.options.lineWrapping) {
            findMaxLine(cm);
          }
          cm.options.mode = doc.modeOption;
          regChange(cm);
        }
        function setDirectionClass(cm) {
          (cm.doc.direction == "rtl" ? addClass : rmClass)(cm.display.lineDiv, "CodeMirror-rtl");
        }
        function directionChanged(cm) {
          runInOp(cm, function() {
            setDirectionClass(cm);
            regChange(cm);
          });
        }
        function History(prev) {
          this.done = [];
          this.undone = [];
          this.undoDepth = prev ? prev.undoDepth : Infinity;
          this.lastModTime = this.lastSelTime = 0;
          this.lastOp = this.lastSelOp = null;
          this.lastOrigin = this.lastSelOrigin = null;
          this.generation = this.maxGeneration = prev ? prev.maxGeneration : 1;
        }
        function historyChangeFromChange(doc, change) {
          var histChange = { from: copyPos(change.from), to: changeEnd(change), text: getBetween(doc, change.from, change.to) };
          attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1);
          linkedDocs(doc, function(doc2) {
            return attachLocalSpans(doc2, histChange, change.from.line, change.to.line + 1);
          }, true);
          return histChange;
        }
        function clearSelectionEvents(array) {
          while (array.length) {
            var last = lst(array);
            if (last.ranges) {
              array.pop();
            } else {
              break;
            }
          }
        }
        function lastChangeEvent(hist, force) {
          if (force) {
            clearSelectionEvents(hist.done);
            return lst(hist.done);
          } else if (hist.done.length && !lst(hist.done).ranges) {
            return lst(hist.done);
          } else if (hist.done.length > 1 && !hist.done[hist.done.length - 2].ranges) {
            hist.done.pop();
            return lst(hist.done);
          }
        }
        function addChangeToHistory(doc, change, selAfter, opId) {
          var hist = doc.history;
          hist.undone.length = 0;
          var time = +/* @__PURE__ */ new Date(), cur;
          var last;
          if ((hist.lastOp == opId || hist.lastOrigin == change.origin && change.origin && (change.origin.charAt(0) == "+" && hist.lastModTime > time - (doc.cm ? doc.cm.options.historyEventDelay : 500) || change.origin.charAt(0) == "*")) && (cur = lastChangeEvent(hist, hist.lastOp == opId))) {
            last = lst(cur.changes);
            if (cmp(change.from, change.to) == 0 && cmp(change.from, last.to) == 0) {
              last.to = changeEnd(change);
            } else {
              cur.changes.push(historyChangeFromChange(doc, change));
            }
          } else {
            var before = lst(hist.done);
            if (!before || !before.ranges) {
              pushSelectionToHistory(doc.sel, hist.done);
            }
            cur = {
              changes: [historyChangeFromChange(doc, change)],
              generation: hist.generation
            };
            hist.done.push(cur);
            while (hist.done.length > hist.undoDepth) {
              hist.done.shift();
              if (!hist.done[0].ranges) {
                hist.done.shift();
              }
            }
          }
          hist.done.push(selAfter);
          hist.generation = ++hist.maxGeneration;
          hist.lastModTime = hist.lastSelTime = time;
          hist.lastOp = hist.lastSelOp = opId;
          hist.lastOrigin = hist.lastSelOrigin = change.origin;
          if (!last) {
            signal(doc, "historyAdded");
          }
        }
        function selectionEventCanBeMerged(doc, origin, prev, sel) {
          var ch = origin.charAt(0);
          return ch == "*" || ch == "+" && prev.ranges.length == sel.ranges.length && prev.somethingSelected() == sel.somethingSelected() && /* @__PURE__ */ new Date() - doc.history.lastSelTime <= (doc.cm ? doc.cm.options.historyEventDelay : 500);
        }
        function addSelectionToHistory(doc, sel, opId, options) {
          var hist = doc.history, origin = options && options.origin;
          if (opId == hist.lastSelOp || origin && hist.lastSelOrigin == origin && (hist.lastModTime == hist.lastSelTime && hist.lastOrigin == origin || selectionEventCanBeMerged(doc, origin, lst(hist.done), sel))) {
            hist.done[hist.done.length - 1] = sel;
          } else {
            pushSelectionToHistory(sel, hist.done);
          }
          hist.lastSelTime = +/* @__PURE__ */ new Date();
          hist.lastSelOrigin = origin;
          hist.lastSelOp = opId;
          if (options && options.clearRedo !== false) {
            clearSelectionEvents(hist.undone);
          }
        }
        function pushSelectionToHistory(sel, dest) {
          var top = lst(dest);
          if (!(top && top.ranges && top.equals(sel))) {
            dest.push(sel);
          }
        }
        function attachLocalSpans(doc, change, from, to) {
          var existing = change["spans_" + doc.id], n = 0;
          doc.iter(Math.max(doc.first, from), Math.min(doc.first + doc.size, to), function(line) {
            if (line.markedSpans) {
              (existing || (existing = change["spans_" + doc.id] = {}))[n] = line.markedSpans;
            }
            ++n;
          });
        }
        function removeClearedSpans(spans) {
          if (!spans) {
            return null;
          }
          var out;
          for (var i2 = 0; i2 < spans.length; ++i2) {
            if (spans[i2].marker.explicitlyCleared) {
              if (!out) {
                out = spans.slice(0, i2);
              }
            } else if (out) {
              out.push(spans[i2]);
            }
          }
          return !out ? spans : out.length ? out : null;
        }
        function getOldSpans(doc, change) {
          var found = change["spans_" + doc.id];
          if (!found) {
            return null;
          }
          var nw = [];
          for (var i2 = 0; i2 < change.text.length; ++i2) {
            nw.push(removeClearedSpans(found[i2]));
          }
          return nw;
        }
        function mergeOldSpans(doc, change) {
          var old = getOldSpans(doc, change);
          var stretched = stretchSpansOverChange(doc, change);
          if (!old) {
            return stretched;
          }
          if (!stretched) {
            return old;
          }
          for (var i2 = 0; i2 < old.length; ++i2) {
            var oldCur = old[i2], stretchCur = stretched[i2];
            if (oldCur && stretchCur) {
              spans:
                for (var j = 0; j < stretchCur.length; ++j) {
                  var span = stretchCur[j];
                  for (var k2 = 0; k2 < oldCur.length; ++k2) {
                    if (oldCur[k2].marker == span.marker) {
                      continue spans;
                    }
                  }
                  oldCur.push(span);
                }
            } else if (stretchCur) {
              old[i2] = stretchCur;
            }
          }
          return old;
        }
        function copyHistoryArray(events2, newGroup, instantiateSel) {
          var copy = [];
          for (var i2 = 0; i2 < events2.length; ++i2) {
            var event = events2[i2];
            if (event.ranges) {
              copy.push(instantiateSel ? Selection.prototype.deepCopy.call(event) : event);
              continue;
            }
            var changes = event.changes, newChanges = [];
            copy.push({ changes: newChanges });
            for (var j = 0; j < changes.length; ++j) {
              var change = changes[j], m = void 0;
              newChanges.push({ from: change.from, to: change.to, text: change.text });
              if (newGroup) {
                for (var prop2 in change) {
                  if (m = prop2.match(/^spans_(\d+)$/)) {
                    if (indexOf(newGroup, Number(m[1])) > -1) {
                      lst(newChanges)[prop2] = change[prop2];
                      delete change[prop2];
                    }
                  }
                }
              }
            }
          }
          return copy;
        }
        function extendRange(range2, head, other, extend) {
          if (extend) {
            var anchor = range2.anchor;
            if (other) {
              var posBefore = cmp(head, anchor) < 0;
              if (posBefore != cmp(other, anchor) < 0) {
                anchor = head;
                head = other;
              } else if (posBefore != cmp(head, other) < 0) {
                head = other;
              }
            }
            return new Range(anchor, head);
          } else {
            return new Range(other || head, head);
          }
        }
        function extendSelection(doc, head, other, options, extend) {
          if (extend == null) {
            extend = doc.cm && (doc.cm.display.shift || doc.extend);
          }
          setSelection(doc, new Selection([extendRange(doc.sel.primary(), head, other, extend)], 0), options);
        }
        function extendSelections(doc, heads, options) {
          var out = [];
          var extend = doc.cm && (doc.cm.display.shift || doc.extend);
          for (var i2 = 0; i2 < doc.sel.ranges.length; i2++) {
            out[i2] = extendRange(doc.sel.ranges[i2], heads[i2], null, extend);
          }
          var newSel = normalizeSelection(doc.cm, out, doc.sel.primIndex);
          setSelection(doc, newSel, options);
        }
        function replaceOneSelection(doc, i2, range2, options) {
          var ranges = doc.sel.ranges.slice(0);
          ranges[i2] = range2;
          setSelection(doc, normalizeSelection(doc.cm, ranges, doc.sel.primIndex), options);
        }
        function setSimpleSelection(doc, anchor, head, options) {
          setSelection(doc, simpleSelection(anchor, head), options);
        }
        function filterSelectionChange(doc, sel, options) {
          var obj = {
            ranges: sel.ranges,
            update: function(ranges) {
              this.ranges = [];
              for (var i2 = 0; i2 < ranges.length; i2++) {
                this.ranges[i2] = new Range(
                  clipPos(doc, ranges[i2].anchor),
                  clipPos(doc, ranges[i2].head)
                );
              }
            },
            origin: options && options.origin
          };
          signal(doc, "beforeSelectionChange", doc, obj);
          if (doc.cm) {
            signal(doc.cm, "beforeSelectionChange", doc.cm, obj);
          }
          if (obj.ranges != sel.ranges) {
            return normalizeSelection(doc.cm, obj.ranges, obj.ranges.length - 1);
          } else {
            return sel;
          }
        }
        function setSelectionReplaceHistory(doc, sel, options) {
          var done = doc.history.done, last = lst(done);
          if (last && last.ranges) {
            done[done.length - 1] = sel;
            setSelectionNoUndo(doc, sel, options);
          } else {
            setSelection(doc, sel, options);
          }
        }
        function setSelection(doc, sel, options) {
          setSelectionNoUndo(doc, sel, options);
          addSelectionToHistory(doc, doc.sel, doc.cm ? doc.cm.curOp.id : NaN, options);
        }
        function setSelectionNoUndo(doc, sel, options) {
          if (hasHandler(doc, "beforeSelectionChange") || doc.cm && hasHandler(doc.cm, "beforeSelectionChange")) {
            sel = filterSelectionChange(doc, sel, options);
          }
          var bias = options && options.bias || (cmp(sel.primary().head, doc.sel.primary().head) < 0 ? -1 : 1);
          setSelectionInner(doc, skipAtomicInSelection(doc, sel, bias, true));
          if (!(options && options.scroll === false) && doc.cm && doc.cm.getOption("readOnly") != "nocursor") {
            ensureCursorVisible(doc.cm);
          }
        }
        function setSelectionInner(doc, sel) {
          if (sel.equals(doc.sel)) {
            return;
          }
          doc.sel = sel;
          if (doc.cm) {
            doc.cm.curOp.updateInput = 1;
            doc.cm.curOp.selectionChanged = true;
            signalCursorActivity(doc.cm);
          }
          signalLater(doc, "cursorActivity", doc);
        }
        function reCheckSelection(doc) {
          setSelectionInner(doc, skipAtomicInSelection(doc, doc.sel, null, false));
        }
        function skipAtomicInSelection(doc, sel, bias, mayClear) {
          var out;
          for (var i2 = 0; i2 < sel.ranges.length; i2++) {
            var range2 = sel.ranges[i2];
            var old = sel.ranges.length == doc.sel.ranges.length && doc.sel.ranges[i2];
            var newAnchor = skipAtomic(doc, range2.anchor, old && old.anchor, bias, mayClear);
            var newHead = skipAtomic(doc, range2.head, old && old.head, bias, mayClear);
            if (out || newAnchor != range2.anchor || newHead != range2.head) {
              if (!out) {
                out = sel.ranges.slice(0, i2);
              }
              out[i2] = new Range(newAnchor, newHead);
            }
          }
          return out ? normalizeSelection(doc.cm, out, sel.primIndex) : sel;
        }
        function skipAtomicInner(doc, pos, oldPos, dir, mayClear) {
          var line = getLine(doc, pos.line);
          if (line.markedSpans) {
            for (var i2 = 0; i2 < line.markedSpans.length; ++i2) {
              var sp = line.markedSpans[i2], m = sp.marker;
              var preventCursorLeft = "selectLeft" in m ? !m.selectLeft : m.inclusiveLeft;
              var preventCursorRight = "selectRight" in m ? !m.selectRight : m.inclusiveRight;
              if ((sp.from == null || (preventCursorLeft ? sp.from <= pos.ch : sp.from < pos.ch)) && (sp.to == null || (preventCursorRight ? sp.to >= pos.ch : sp.to > pos.ch))) {
                if (mayClear) {
                  signal(m, "beforeCursorEnter");
                  if (m.explicitlyCleared) {
                    if (!line.markedSpans) {
                      break;
                    } else {
                      --i2;
                      continue;
                    }
                  }
                }
                if (!m.atomic) {
                  continue;
                }
                if (oldPos) {
                  var near = m.find(dir < 0 ? 1 : -1), diff = void 0;
                  if (dir < 0 ? preventCursorRight : preventCursorLeft) {
                    near = movePos(doc, near, -dir, near && near.line == pos.line ? line : null);
                  }
                  if (near && near.line == pos.line && (diff = cmp(near, oldPos)) && (dir < 0 ? diff < 0 : diff > 0)) {
                    return skipAtomicInner(doc, near, pos, dir, mayClear);
                  }
                }
                var far = m.find(dir < 0 ? -1 : 1);
                if (dir < 0 ? preventCursorLeft : preventCursorRight) {
                  far = movePos(doc, far, dir, far.line == pos.line ? line : null);
                }
                return far ? skipAtomicInner(doc, far, pos, dir, mayClear) : null;
              }
            }
          }
          return pos;
        }
        function skipAtomic(doc, pos, oldPos, bias, mayClear) {
          var dir = bias || 1;
          var found = skipAtomicInner(doc, pos, oldPos, dir, mayClear) || !mayClear && skipAtomicInner(doc, pos, oldPos, dir, true) || skipAtomicInner(doc, pos, oldPos, -dir, mayClear) || !mayClear && skipAtomicInner(doc, pos, oldPos, -dir, true);
          if (!found) {
            doc.cantEdit = true;
            return Pos(doc.first, 0);
          }
          return found;
        }
        function movePos(doc, pos, dir, line) {
          if (dir < 0 && pos.ch == 0) {
            if (pos.line > doc.first) {
              return clipPos(doc, Pos(pos.line - 1));
            } else {
              return null;
            }
          } else if (dir > 0 && pos.ch == (line || getLine(doc, pos.line)).text.length) {
            if (pos.line < doc.first + doc.size - 1) {
              return Pos(pos.line + 1, 0);
            } else {
              return null;
            }
          } else {
            return new Pos(pos.line, pos.ch + dir);
          }
        }
        function selectAll(cm) {
          cm.setSelection(Pos(cm.firstLine(), 0), Pos(cm.lastLine()), sel_dontScroll);
        }
        function filterChange(doc, change, update) {
          var obj = {
            canceled: false,
            from: change.from,
            to: change.to,
            text: change.text,
            origin: change.origin,
            cancel: function() {
              return obj.canceled = true;
            }
          };
          if (update) {
            obj.update = function(from, to, text, origin) {
              if (from) {
                obj.from = clipPos(doc, from);
              }
              if (to) {
                obj.to = clipPos(doc, to);
              }
              if (text) {
                obj.text = text;
              }
              if (origin !== void 0) {
                obj.origin = origin;
              }
            };
          }
          signal(doc, "beforeChange", doc, obj);
          if (doc.cm) {
            signal(doc.cm, "beforeChange", doc.cm, obj);
          }
          if (obj.canceled) {
            if (doc.cm) {
              doc.cm.curOp.updateInput = 2;
            }
            return null;
          }
          return { from: obj.from, to: obj.to, text: obj.text, origin: obj.origin };
        }
        function makeChange(doc, change, ignoreReadOnly) {
          if (doc.cm) {
            if (!doc.cm.curOp) {
              return operation(doc.cm, makeChange)(doc, change, ignoreReadOnly);
            }
            if (doc.cm.state.suppressEdits) {
              return;
            }
          }
          if (hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange")) {
            change = filterChange(doc, change, true);
            if (!change) {
              return;
            }
          }
          var split = sawReadOnlySpans && !ignoreReadOnly && removeReadOnlyRanges(doc, change.from, change.to);
          if (split) {
            for (var i2 = split.length - 1; i2 >= 0; --i2) {
              makeChangeInner(doc, { from: split[i2].from, to: split[i2].to, text: i2 ? [""] : change.text, origin: change.origin });
            }
          } else {
            makeChangeInner(doc, change);
          }
        }
        function makeChangeInner(doc, change) {
          if (change.text.length == 1 && change.text[0] == "" && cmp(change.from, change.to) == 0) {
            return;
          }
          var selAfter = computeSelAfterChange(doc, change);
          addChangeToHistory(doc, change, selAfter, doc.cm ? doc.cm.curOp.id : NaN);
          makeChangeSingleDoc(doc, change, selAfter, stretchSpansOverChange(doc, change));
          var rebased = [];
          linkedDocs(doc, function(doc2, sharedHist) {
            if (!sharedHist && indexOf(rebased, doc2.history) == -1) {
              rebaseHist(doc2.history, change);
              rebased.push(doc2.history);
            }
            makeChangeSingleDoc(doc2, change, null, stretchSpansOverChange(doc2, change));
          });
        }
        function makeChangeFromHistory(doc, type2, allowSelectionOnly) {
          var suppress = doc.cm && doc.cm.state.suppressEdits;
          if (suppress && !allowSelectionOnly) {
            return;
          }
          var hist = doc.history, event, selAfter = doc.sel;
          var source = type2 == "undo" ? hist.done : hist.undone, dest = type2 == "undo" ? hist.undone : hist.done;
          var i2 = 0;
          for (; i2 < source.length; i2++) {
            event = source[i2];
            if (allowSelectionOnly ? event.ranges && !event.equals(doc.sel) : !event.ranges) {
              break;
            }
          }
          if (i2 == source.length) {
            return;
          }
          hist.lastOrigin = hist.lastSelOrigin = null;
          for (; ; ) {
            event = source.pop();
            if (event.ranges) {
              pushSelectionToHistory(event, dest);
              if (allowSelectionOnly && !event.equals(doc.sel)) {
                setSelection(doc, event, { clearRedo: false });
                return;
              }
              selAfter = event;
            } else if (suppress) {
              source.push(event);
              return;
            } else {
              break;
            }
          }
          var antiChanges = [];
          pushSelectionToHistory(selAfter, dest);
          dest.push({ changes: antiChanges, generation: hist.generation });
          hist.generation = event.generation || ++hist.maxGeneration;
          var filter2 = hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange");
          var loop = function(i3) {
            var change = event.changes[i3];
            change.origin = type2;
            if (filter2 && !filterChange(doc, change, false)) {
              source.length = 0;
              return {};
            }
            antiChanges.push(historyChangeFromChange(doc, change));
            var after = i3 ? computeSelAfterChange(doc, change) : lst(source);
            makeChangeSingleDoc(doc, change, after, mergeOldSpans(doc, change));
            if (!i3 && doc.cm) {
              doc.cm.scrollIntoView({ from: change.from, to: changeEnd(change) });
            }
            var rebased = [];
            linkedDocs(doc, function(doc2, sharedHist) {
              if (!sharedHist && indexOf(rebased, doc2.history) == -1) {
                rebaseHist(doc2.history, change);
                rebased.push(doc2.history);
              }
              makeChangeSingleDoc(doc2, change, null, mergeOldSpans(doc2, change));
            });
          };
          for (var i$12 = event.changes.length - 1; i$12 >= 0; --i$12) {
            var returned = loop(i$12);
            if (returned)
              return returned.v;
          }
        }
        function shiftDoc(doc, distance) {
          if (distance == 0) {
            return;
          }
          doc.first += distance;
          doc.sel = new Selection(map(doc.sel.ranges, function(range2) {
            return new Range(
              Pos(range2.anchor.line + distance, range2.anchor.ch),
              Pos(range2.head.line + distance, range2.head.ch)
            );
          }), doc.sel.primIndex);
          if (doc.cm) {
            regChange(doc.cm, doc.first, doc.first - distance, distance);
            for (var d = doc.cm.display, l = d.viewFrom; l < d.viewTo; l++) {
              regLineChange(doc.cm, l, "gutter");
            }
          }
        }
        function makeChangeSingleDoc(doc, change, selAfter, spans) {
          if (doc.cm && !doc.cm.curOp) {
            return operation(doc.cm, makeChangeSingleDoc)(doc, change, selAfter, spans);
          }
          if (change.to.line < doc.first) {
            shiftDoc(doc, change.text.length - 1 - (change.to.line - change.from.line));
            return;
          }
          if (change.from.line > doc.lastLine()) {
            return;
          }
          if (change.from.line < doc.first) {
            var shift = change.text.length - 1 - (doc.first - change.from.line);
            shiftDoc(doc, shift);
            change = {
              from: Pos(doc.first, 0),
              to: Pos(change.to.line + shift, change.to.ch),
              text: [lst(change.text)],
              origin: change.origin
            };
          }
          var last = doc.lastLine();
          if (change.to.line > last) {
            change = {
              from: change.from,
              to: Pos(last, getLine(doc, last).text.length),
              text: [change.text[0]],
              origin: change.origin
            };
          }
          change.removed = getBetween(doc, change.from, change.to);
          if (!selAfter) {
            selAfter = computeSelAfterChange(doc, change);
          }
          if (doc.cm) {
            makeChangeSingleDocInEditor(doc.cm, change, spans);
          } else {
            updateDoc(doc, change, spans);
          }
          setSelectionNoUndo(doc, selAfter, sel_dontScroll);
          if (doc.cantEdit && skipAtomic(doc, Pos(doc.firstLine(), 0))) {
            doc.cantEdit = false;
          }
        }
        function makeChangeSingleDocInEditor(cm, change, spans) {
          var doc = cm.doc, display = cm.display, from = change.from, to = change.to;
          var recomputeMaxLength = false, checkWidthStart = from.line;
          if (!cm.options.lineWrapping) {
            checkWidthStart = lineNo(visualLine(getLine(doc, from.line)));
            doc.iter(checkWidthStart, to.line + 1, function(line) {
              if (line == display.maxLine) {
                recomputeMaxLength = true;
                return true;
              }
            });
          }
          if (doc.sel.contains(change.from, change.to) > -1) {
            signalCursorActivity(cm);
          }
          updateDoc(doc, change, spans, estimateHeight(cm));
          if (!cm.options.lineWrapping) {
            doc.iter(checkWidthStart, from.line + change.text.length, function(line) {
              var len = lineLength(line);
              if (len > display.maxLineLength) {
                display.maxLine = line;
                display.maxLineLength = len;
                display.maxLineChanged = true;
                recomputeMaxLength = false;
              }
            });
            if (recomputeMaxLength) {
              cm.curOp.updateMaxLine = true;
            }
          }
          retreatFrontier(doc, from.line);
          startWorker(cm, 400);
          var lendiff = change.text.length - (to.line - from.line) - 1;
          if (change.full) {
            regChange(cm);
          } else if (from.line == to.line && change.text.length == 1 && !isWholeLineUpdate(cm.doc, change)) {
            regLineChange(cm, from.line, "text");
          } else {
            regChange(cm, from.line, to.line + 1, lendiff);
          }
          var changesHandler = hasHandler(cm, "changes"), changeHandler = hasHandler(cm, "change");
          if (changeHandler || changesHandler) {
            var obj = {
              from,
              to,
              text: change.text,
              removed: change.removed,
              origin: change.origin
            };
            if (changeHandler) {
              signalLater(cm, "change", cm, obj);
            }
            if (changesHandler) {
              (cm.curOp.changeObjs || (cm.curOp.changeObjs = [])).push(obj);
            }
          }
          cm.display.selForContextMenu = null;
        }
        function replaceRange(doc, code2, from, to, origin) {
          var assign;
          if (!to) {
            to = from;
          }
          if (cmp(to, from) < 0) {
            assign = [to, from], from = assign[0], to = assign[1];
          }
          if (typeof code2 == "string") {
            code2 = doc.splitLines(code2);
          }
          makeChange(doc, { from, to, text: code2, origin });
        }
        function rebaseHistSelSingle(pos, from, to, diff) {
          if (to < pos.line) {
            pos.line += diff;
          } else if (from < pos.line) {
            pos.line = from;
            pos.ch = 0;
          }
        }
        function rebaseHistArray(array, from, to, diff) {
          for (var i2 = 0; i2 < array.length; ++i2) {
            var sub = array[i2], ok = true;
            if (sub.ranges) {
              if (!sub.copied) {
                sub = array[i2] = sub.deepCopy();
                sub.copied = true;
              }
              for (var j = 0; j < sub.ranges.length; j++) {
                rebaseHistSelSingle(sub.ranges[j].anchor, from, to, diff);
                rebaseHistSelSingle(sub.ranges[j].head, from, to, diff);
              }
              continue;
            }
            for (var j$1 = 0; j$1 < sub.changes.length; ++j$1) {
              var cur = sub.changes[j$1];
              if (to < cur.from.line) {
                cur.from = Pos(cur.from.line + diff, cur.from.ch);
                cur.to = Pos(cur.to.line + diff, cur.to.ch);
              } else if (from <= cur.to.line) {
                ok = false;
                break;
              }
            }
            if (!ok) {
              array.splice(0, i2 + 1);
              i2 = 0;
            }
          }
        }
        function rebaseHist(hist, change) {
          var from = change.from.line, to = change.to.line, diff = change.text.length - (to - from) - 1;
          rebaseHistArray(hist.done, from, to, diff);
          rebaseHistArray(hist.undone, from, to, diff);
        }
        function changeLine(doc, handle2, changeType, op) {
          var no = handle2, line = handle2;
          if (typeof handle2 == "number") {
            line = getLine(doc, clipLine(doc, handle2));
          } else {
            no = lineNo(handle2);
          }
          if (no == null) {
            return null;
          }
          if (op(line, no) && doc.cm) {
            regLineChange(doc.cm, no, changeType);
          }
          return line;
        }
        function LeafChunk(lines) {
          this.lines = lines;
          this.parent = null;
          var height = 0;
          for (var i2 = 0; i2 < lines.length; ++i2) {
            lines[i2].parent = this;
            height += lines[i2].height;
          }
          this.height = height;
        }
        LeafChunk.prototype = {
          chunkSize: function() {
            return this.lines.length;
          },
          // Remove the n lines at offset 'at'.
          removeInner: function(at, n) {
            for (var i2 = at, e = at + n; i2 < e; ++i2) {
              var line = this.lines[i2];
              this.height -= line.height;
              cleanUpLine(line);
              signalLater(line, "delete");
            }
            this.lines.splice(at, n);
          },
          // Helper used to collapse a small branch into a single leaf.
          collapse: function(lines) {
            lines.push.apply(lines, this.lines);
          },
          // Insert the given array of lines at offset 'at', count them as
          // having the given height.
          insertInner: function(at, lines, height) {
            this.height += height;
            this.lines = this.lines.slice(0, at).concat(lines).concat(this.lines.slice(at));
            for (var i2 = 0; i2 < lines.length; ++i2) {
              lines[i2].parent = this;
            }
          },
          // Used to iterate over a part of the tree.
          iterN: function(at, n, op) {
            for (var e = at + n; at < e; ++at) {
              if (op(this.lines[at])) {
                return true;
              }
            }
          }
        };
        function BranchChunk(children) {
          this.children = children;
          var size = 0, height = 0;
          for (var i2 = 0; i2 < children.length; ++i2) {
            var ch = children[i2];
            size += ch.chunkSize();
            height += ch.height;
            ch.parent = this;
          }
          this.size = size;
          this.height = height;
          this.parent = null;
        }
        BranchChunk.prototype = {
          chunkSize: function() {
            return this.size;
          },
          removeInner: function(at, n) {
            this.size -= n;
            for (var i2 = 0; i2 < this.children.length; ++i2) {
              var child = this.children[i2], sz = child.chunkSize();
              if (at < sz) {
                var rm = Math.min(n, sz - at), oldHeight = child.height;
                child.removeInner(at, rm);
                this.height -= oldHeight - child.height;
                if (sz == rm) {
                  this.children.splice(i2--, 1);
                  child.parent = null;
                }
                if ((n -= rm) == 0) {
                  break;
                }
                at = 0;
              } else {
                at -= sz;
              }
            }
            if (this.size - n < 25 && (this.children.length > 1 || !(this.children[0] instanceof LeafChunk))) {
              var lines = [];
              this.collapse(lines);
              this.children = [new LeafChunk(lines)];
              this.children[0].parent = this;
            }
          },
          collapse: function(lines) {
            for (var i2 = 0; i2 < this.children.length; ++i2) {
              this.children[i2].collapse(lines);
            }
          },
          insertInner: function(at, lines, height) {
            this.size += lines.length;
            this.height += height;
            for (var i2 = 0; i2 < this.children.length; ++i2) {
              var child = this.children[i2], sz = child.chunkSize();
              if (at <= sz) {
                child.insertInner(at, lines, height);
                if (child.lines && child.lines.length > 50) {
                  var remaining = child.lines.length % 25 + 25;
                  for (var pos = remaining; pos < child.lines.length; ) {
                    var leaf = new LeafChunk(child.lines.slice(pos, pos += 25));
                    child.height -= leaf.height;
                    this.children.splice(++i2, 0, leaf);
                    leaf.parent = this;
                  }
                  child.lines = child.lines.slice(0, remaining);
                  this.maybeSpill();
                }
                break;
              }
              at -= sz;
            }
          },
          // When a node has grown, check whether it should be split.
          maybeSpill: function() {
            if (this.children.length <= 10) {
              return;
            }
            var me = this;
            do {
              var spilled = me.children.splice(me.children.length - 5, 5);
              var sibling = new BranchChunk(spilled);
              if (!me.parent) {
                var copy = new BranchChunk(me.children);
                copy.parent = me;
                me.children = [copy, sibling];
                me = copy;
              } else {
                me.size -= sibling.size;
                me.height -= sibling.height;
                var myIndex = indexOf(me.parent.children, me);
                me.parent.children.splice(myIndex + 1, 0, sibling);
              }
              sibling.parent = me.parent;
            } while (me.children.length > 10);
            me.parent.maybeSpill();
          },
          iterN: function(at, n, op) {
            for (var i2 = 0; i2 < this.children.length; ++i2) {
              var child = this.children[i2], sz = child.chunkSize();
              if (at < sz) {
                var used = Math.min(n, sz - at);
                if (child.iterN(at, used, op)) {
                  return true;
                }
                if ((n -= used) == 0) {
                  break;
                }
                at = 0;
              } else {
                at -= sz;
              }
            }
          }
        };
        var LineWidget = function(doc, node, options) {
          if (options) {
            for (var opt in options) {
              if (options.hasOwnProperty(opt)) {
                this[opt] = options[opt];
              }
            }
          }
          this.doc = doc;
          this.node = node;
        };
        LineWidget.prototype.clear = function() {
          var cm = this.doc.cm, ws = this.line.widgets, line = this.line, no = lineNo(line);
          if (no == null || !ws) {
            return;
          }
          for (var i2 = 0; i2 < ws.length; ++i2) {
            if (ws[i2] == this) {
              ws.splice(i2--, 1);
            }
          }
          if (!ws.length) {
            line.widgets = null;
          }
          var height = widgetHeight(this);
          updateLineHeight(line, Math.max(0, line.height - height));
          if (cm) {
            runInOp(cm, function() {
              adjustScrollWhenAboveVisible(cm, line, -height);
              regLineChange(cm, no, "widget");
            });
            signalLater(cm, "lineWidgetCleared", cm, this, no);
          }
        };
        LineWidget.prototype.changed = function() {
          var this$1 = this;
          var oldH = this.height, cm = this.doc.cm, line = this.line;
          this.height = null;
          var diff = widgetHeight(this) - oldH;
          if (!diff) {
            return;
          }
          if (!lineIsHidden(this.doc, line)) {
            updateLineHeight(line, line.height + diff);
          }
          if (cm) {
            runInOp(cm, function() {
              cm.curOp.forceUpdate = true;
              adjustScrollWhenAboveVisible(cm, line, diff);
              signalLater(cm, "lineWidgetChanged", cm, this$1, lineNo(line));
            });
          }
        };
        eventMixin(LineWidget);
        function adjustScrollWhenAboveVisible(cm, line, diff) {
          if (heightAtLine(line) < (cm.curOp && cm.curOp.scrollTop || cm.doc.scrollTop)) {
            addToScrollTop(cm, diff);
          }
        }
        function addLineWidget(doc, handle2, node, options) {
          var widget = new LineWidget(doc, node, options);
          var cm = doc.cm;
          if (cm && widget.noHScroll) {
            cm.display.alignWidgets = true;
          }
          changeLine(doc, handle2, "widget", function(line) {
            var widgets = line.widgets || (line.widgets = []);
            if (widget.insertAt == null) {
              widgets.push(widget);
            } else {
              widgets.splice(Math.min(widgets.length, Math.max(0, widget.insertAt)), 0, widget);
            }
            widget.line = line;
            if (cm && !lineIsHidden(doc, line)) {
              var aboveVisible = heightAtLine(line) < doc.scrollTop;
              updateLineHeight(line, line.height + widgetHeight(widget));
              if (aboveVisible) {
                addToScrollTop(cm, widget.height);
              }
              cm.curOp.forceUpdate = true;
            }
            return true;
          });
          if (cm) {
            signalLater(cm, "lineWidgetAdded", cm, widget, typeof handle2 == "number" ? handle2 : lineNo(handle2));
          }
          return widget;
        }
        var nextMarkerId = 0;
        var TextMarker = function(doc, type2) {
          this.lines = [];
          this.type = type2;
          this.doc = doc;
          this.id = ++nextMarkerId;
        };
        TextMarker.prototype.clear = function() {
          if (this.explicitlyCleared) {
            return;
          }
          var cm = this.doc.cm, withOp = cm && !cm.curOp;
          if (withOp) {
            startOperation(cm);
          }
          if (hasHandler(this, "clear")) {
            var found = this.find();
            if (found) {
              signalLater(this, "clear", found.from, found.to);
            }
          }
          var min = null, max = null;
          for (var i2 = 0; i2 < this.lines.length; ++i2) {
            var line = this.lines[i2];
            var span = getMarkedSpanFor(line.markedSpans, this);
            if (cm && !this.collapsed) {
              regLineChange(cm, lineNo(line), "text");
            } else if (cm) {
              if (span.to != null) {
                max = lineNo(line);
              }
              if (span.from != null) {
                min = lineNo(line);
              }
            }
            line.markedSpans = removeMarkedSpan(line.markedSpans, span);
            if (span.from == null && this.collapsed && !lineIsHidden(this.doc, line) && cm) {
              updateLineHeight(line, textHeight(cm.display));
            }
          }
          if (cm && this.collapsed && !cm.options.lineWrapping) {
            for (var i$12 = 0; i$12 < this.lines.length; ++i$12) {
              var visual = visualLine(this.lines[i$12]), len = lineLength(visual);
              if (len > cm.display.maxLineLength) {
                cm.display.maxLine = visual;
                cm.display.maxLineLength = len;
                cm.display.maxLineChanged = true;
              }
            }
          }
          if (min != null && cm && this.collapsed) {
            regChange(cm, min, max + 1);
          }
          this.lines.length = 0;
          this.explicitlyCleared = true;
          if (this.atomic && this.doc.cantEdit) {
            this.doc.cantEdit = false;
            if (cm) {
              reCheckSelection(cm.doc);
            }
          }
          if (cm) {
            signalLater(cm, "markerCleared", cm, this, min, max);
          }
          if (withOp) {
            endOperation(cm);
          }
          if (this.parent) {
            this.parent.clear();
          }
        };
        TextMarker.prototype.find = function(side, lineObj) {
          if (side == null && this.type == "bookmark") {
            side = 1;
          }
          var from, to;
          for (var i2 = 0; i2 < this.lines.length; ++i2) {
            var line = this.lines[i2];
            var span = getMarkedSpanFor(line.markedSpans, this);
            if (span.from != null) {
              from = Pos(lineObj ? line : lineNo(line), span.from);
              if (side == -1) {
                return from;
              }
            }
            if (span.to != null) {
              to = Pos(lineObj ? line : lineNo(line), span.to);
              if (side == 1) {
                return to;
              }
            }
          }
          return from && { from, to };
        };
        TextMarker.prototype.changed = function() {
          var this$1 = this;
          var pos = this.find(-1, true), widget = this, cm = this.doc.cm;
          if (!pos || !cm) {
            return;
          }
          runInOp(cm, function() {
            var line = pos.line, lineN = lineNo(pos.line);
            var view = findViewForLine(cm, lineN);
            if (view) {
              clearLineMeasurementCacheFor(view);
              cm.curOp.selectionChanged = cm.curOp.forceUpdate = true;
            }
            cm.curOp.updateMaxLine = true;
            if (!lineIsHidden(widget.doc, line) && widget.height != null) {
              var oldHeight = widget.height;
              widget.height = null;
              var dHeight = widgetHeight(widget) - oldHeight;
              if (dHeight) {
                updateLineHeight(line, line.height + dHeight);
              }
            }
            signalLater(cm, "markerChanged", cm, this$1);
          });
        };
        TextMarker.prototype.attachLine = function(line) {
          if (!this.lines.length && this.doc.cm) {
            var op = this.doc.cm.curOp;
            if (!op.maybeHiddenMarkers || indexOf(op.maybeHiddenMarkers, this) == -1) {
              (op.maybeUnhiddenMarkers || (op.maybeUnhiddenMarkers = [])).push(this);
            }
          }
          this.lines.push(line);
        };
        TextMarker.prototype.detachLine = function(line) {
          this.lines.splice(indexOf(this.lines, line), 1);
          if (!this.lines.length && this.doc.cm) {
            var op = this.doc.cm.curOp;
            (op.maybeHiddenMarkers || (op.maybeHiddenMarkers = [])).push(this);
          }
        };
        eventMixin(TextMarker);
        function markText(doc, from, to, options, type2) {
          if (options && options.shared) {
            return markTextShared(doc, from, to, options, type2);
          }
          if (doc.cm && !doc.cm.curOp) {
            return operation(doc.cm, markText)(doc, from, to, options, type2);
          }
          var marker = new TextMarker(doc, type2), diff = cmp(from, to);
          if (options) {
            copyObj(options, marker, false);
          }
          if (diff > 0 || diff == 0 && marker.clearWhenEmpty !== false) {
            return marker;
          }
          if (marker.replacedWith) {
            marker.collapsed = true;
            marker.widgetNode = eltP("span", [marker.replacedWith], "CodeMirror-widget");
            if (!options.handleMouseEvents) {
              marker.widgetNode.setAttribute("cm-ignore-events", "true");
            }
            if (options.insertLeft) {
              marker.widgetNode.insertLeft = true;
            }
          }
          if (marker.collapsed) {
            if (conflictingCollapsedRange(doc, from.line, from, to, marker) || from.line != to.line && conflictingCollapsedRange(doc, to.line, from, to, marker)) {
              throw new Error("Inserting collapsed marker partially overlapping an existing one");
            }
            seeCollapsedSpans();
          }
          if (marker.addToHistory) {
            addChangeToHistory(doc, { from, to, origin: "markText" }, doc.sel, NaN);
          }
          var curLine = from.line, cm = doc.cm, updateMaxLine;
          doc.iter(curLine, to.line + 1, function(line) {
            if (cm && marker.collapsed && !cm.options.lineWrapping && visualLine(line) == cm.display.maxLine) {
              updateMaxLine = true;
            }
            if (marker.collapsed && curLine != from.line) {
              updateLineHeight(line, 0);
            }
            addMarkedSpan(line, new MarkedSpan(
              marker,
              curLine == from.line ? from.ch : null,
              curLine == to.line ? to.ch : null
            ), doc.cm && doc.cm.curOp);
            ++curLine;
          });
          if (marker.collapsed) {
            doc.iter(from.line, to.line + 1, function(line) {
              if (lineIsHidden(doc, line)) {
                updateLineHeight(line, 0);
              }
            });
          }
          if (marker.clearOnEnter) {
            on(marker, "beforeCursorEnter", function() {
              return marker.clear();
            });
          }
          if (marker.readOnly) {
            seeReadOnlySpans();
            if (doc.history.done.length || doc.history.undone.length) {
              doc.clearHistory();
            }
          }
          if (marker.collapsed) {
            marker.id = ++nextMarkerId;
            marker.atomic = true;
          }
          if (cm) {
            if (updateMaxLine) {
              cm.curOp.updateMaxLine = true;
            }
            if (marker.collapsed) {
              regChange(cm, from.line, to.line + 1);
            } else if (marker.className || marker.startStyle || marker.endStyle || marker.css || marker.attributes || marker.title) {
              for (var i2 = from.line; i2 <= to.line; i2++) {
                regLineChange(cm, i2, "text");
              }
            }
            if (marker.atomic) {
              reCheckSelection(cm.doc);
            }
            signalLater(cm, "markerAdded", cm, marker);
          }
          return marker;
        }
        var SharedTextMarker = function(markers, primary) {
          this.markers = markers;
          this.primary = primary;
          for (var i2 = 0; i2 < markers.length; ++i2) {
            markers[i2].parent = this;
          }
        };
        SharedTextMarker.prototype.clear = function() {
          if (this.explicitlyCleared) {
            return;
          }
          this.explicitlyCleared = true;
          for (var i2 = 0; i2 < this.markers.length; ++i2) {
            this.markers[i2].clear();
          }
          signalLater(this, "clear");
        };
        SharedTextMarker.prototype.find = function(side, lineObj) {
          return this.primary.find(side, lineObj);
        };
        eventMixin(SharedTextMarker);
        function markTextShared(doc, from, to, options, type2) {
          options = copyObj(options);
          options.shared = false;
          var markers = [markText(doc, from, to, options, type2)], primary = markers[0];
          var widget = options.widgetNode;
          linkedDocs(doc, function(doc2) {
            if (widget) {
              options.widgetNode = widget.cloneNode(true);
            }
            markers.push(markText(doc2, clipPos(doc2, from), clipPos(doc2, to), options, type2));
            for (var i2 = 0; i2 < doc2.linked.length; ++i2) {
              if (doc2.linked[i2].isParent) {
                return;
              }
            }
            primary = lst(markers);
          });
          return new SharedTextMarker(markers, primary);
        }
        function findSharedMarkers(doc) {
          return doc.findMarks(Pos(doc.first, 0), doc.clipPos(Pos(doc.lastLine())), function(m) {
            return m.parent;
          });
        }
        function copySharedMarkers(doc, markers) {
          for (var i2 = 0; i2 < markers.length; i2++) {
            var marker = markers[i2], pos = marker.find();
            var mFrom = doc.clipPos(pos.from), mTo = doc.clipPos(pos.to);
            if (cmp(mFrom, mTo)) {
              var subMark = markText(doc, mFrom, mTo, marker.primary, marker.primary.type);
              marker.markers.push(subMark);
              subMark.parent = marker;
            }
          }
        }
        function detachSharedMarkers(markers) {
          var loop = function(i3) {
            var marker = markers[i3], linked = [marker.primary.doc];
            linkedDocs(marker.primary.doc, function(d) {
              return linked.push(d);
            });
            for (var j = 0; j < marker.markers.length; j++) {
              var subMarker = marker.markers[j];
              if (indexOf(linked, subMarker.doc) == -1) {
                subMarker.parent = null;
                marker.markers.splice(j--, 1);
              }
            }
          };
          for (var i2 = 0; i2 < markers.length; i2++)
            loop(i2);
        }
        var nextDocId = 0;
        var Doc = function(text, mode, firstLine, lineSep, direction) {
          if (!(this instanceof Doc)) {
            return new Doc(text, mode, firstLine, lineSep, direction);
          }
          if (firstLine == null) {
            firstLine = 0;
          }
          BranchChunk.call(this, [new LeafChunk([new Line("", null)])]);
          this.first = firstLine;
          this.scrollTop = this.scrollLeft = 0;
          this.cantEdit = false;
          this.cleanGeneration = 1;
          this.modeFrontier = this.highlightFrontier = firstLine;
          var start = Pos(firstLine, 0);
          this.sel = simpleSelection(start);
          this.history = new History(null);
          this.id = ++nextDocId;
          this.modeOption = mode;
          this.lineSep = lineSep;
          this.direction = direction == "rtl" ? "rtl" : "ltr";
          this.extend = false;
          if (typeof text == "string") {
            text = this.splitLines(text);
          }
          updateDoc(this, { from: start, to: start, text });
          setSelection(this, simpleSelection(start), sel_dontScroll);
        };
        Doc.prototype = createObj(BranchChunk.prototype, {
          constructor: Doc,
          // Iterate over the document. Supports two forms -- with only one
          // argument, it calls that for each line in the document. With
          // three, it iterates over the range given by the first two (with
          // the second being non-inclusive).
          iter: function(from, to, op) {
            if (op) {
              this.iterN(from - this.first, to - from, op);
            } else {
              this.iterN(this.first, this.first + this.size, from);
            }
          },
          // Non-public interface for adding and removing lines.
          insert: function(at, lines) {
            var height = 0;
            for (var i2 = 0; i2 < lines.length; ++i2) {
              height += lines[i2].height;
            }
            this.insertInner(at - this.first, lines, height);
          },
          remove: function(at, n) {
            this.removeInner(at - this.first, n);
          },
          // From here, the methods are part of the public interface. Most
          // are also available from CodeMirror (editor) instances.
          getValue: function(lineSep) {
            var lines = getLines(this, this.first, this.first + this.size);
            if (lineSep === false) {
              return lines;
            }
            return lines.join(lineSep || this.lineSeparator());
          },
          setValue: docMethodOp(function(code2) {
            var top = Pos(this.first, 0), last = this.first + this.size - 1;
            makeChange(this, {
              from: top,
              to: Pos(last, getLine(this, last).text.length),
              text: this.splitLines(code2),
              origin: "setValue",
              full: true
            }, true);
            if (this.cm) {
              scrollToCoords(this.cm, 0, 0);
            }
            setSelection(this, simpleSelection(top), sel_dontScroll);
          }),
          replaceRange: function(code2, from, to, origin) {
            from = clipPos(this, from);
            to = to ? clipPos(this, to) : from;
            replaceRange(this, code2, from, to, origin);
          },
          getRange: function(from, to, lineSep) {
            var lines = getBetween(this, clipPos(this, from), clipPos(this, to));
            if (lineSep === false) {
              return lines;
            }
            if (lineSep === "") {
              return lines.join("");
            }
            return lines.join(lineSep || this.lineSeparator());
          },
          getLine: function(line) {
            var l = this.getLineHandle(line);
            return l && l.text;
          },
          getLineHandle: function(line) {
            if (isLine(this, line)) {
              return getLine(this, line);
            }
          },
          getLineNumber: function(line) {
            return lineNo(line);
          },
          getLineHandleVisualStart: function(line) {
            if (typeof line == "number") {
              line = getLine(this, line);
            }
            return visualLine(line);
          },
          lineCount: function() {
            return this.size;
          },
          firstLine: function() {
            return this.first;
          },
          lastLine: function() {
            return this.first + this.size - 1;
          },
          clipPos: function(pos) {
            return clipPos(this, pos);
          },
          getCursor: function(start) {
            var range2 = this.sel.primary(), pos;
            if (start == null || start == "head") {
              pos = range2.head;
            } else if (start == "anchor") {
              pos = range2.anchor;
            } else if (start == "end" || start == "to" || start === false) {
              pos = range2.to();
            } else {
              pos = range2.from();
            }
            return pos;
          },
          listSelections: function() {
            return this.sel.ranges;
          },
          somethingSelected: function() {
            return this.sel.somethingSelected();
          },
          setCursor: docMethodOp(function(line, ch, options) {
            setSimpleSelection(this, clipPos(this, typeof line == "number" ? Pos(line, ch || 0) : line), null, options);
          }),
          setSelection: docMethodOp(function(anchor, head, options) {
            setSimpleSelection(this, clipPos(this, anchor), clipPos(this, head || anchor), options);
          }),
          extendSelection: docMethodOp(function(head, other, options) {
            extendSelection(this, clipPos(this, head), other && clipPos(this, other), options);
          }),
          extendSelections: docMethodOp(function(heads, options) {
            extendSelections(this, clipPosArray(this, heads), options);
          }),
          extendSelectionsBy: docMethodOp(function(f, options) {
            var heads = map(this.sel.ranges, f);
            extendSelections(this, clipPosArray(this, heads), options);
          }),
          setSelections: docMethodOp(function(ranges, primary, options) {
            if (!ranges.length) {
              return;
            }
            var out = [];
            for (var i2 = 0; i2 < ranges.length; i2++) {
              out[i2] = new Range(
                clipPos(this, ranges[i2].anchor),
                clipPos(this, ranges[i2].head || ranges[i2].anchor)
              );
            }
            if (primary == null) {
              primary = Math.min(ranges.length - 1, this.sel.primIndex);
            }
            setSelection(this, normalizeSelection(this.cm, out, primary), options);
          }),
          addSelection: docMethodOp(function(anchor, head, options) {
            var ranges = this.sel.ranges.slice(0);
            ranges.push(new Range(clipPos(this, anchor), clipPos(this, head || anchor)));
            setSelection(this, normalizeSelection(this.cm, ranges, ranges.length - 1), options);
          }),
          getSelection: function(lineSep) {
            var ranges = this.sel.ranges, lines;
            for (var i2 = 0; i2 < ranges.length; i2++) {
              var sel = getBetween(this, ranges[i2].from(), ranges[i2].to());
              lines = lines ? lines.concat(sel) : sel;
            }
            if (lineSep === false) {
              return lines;
            } else {
              return lines.join(lineSep || this.lineSeparator());
            }
          },
          getSelections: function(lineSep) {
            var parts = [], ranges = this.sel.ranges;
            for (var i2 = 0; i2 < ranges.length; i2++) {
              var sel = getBetween(this, ranges[i2].from(), ranges[i2].to());
              if (lineSep !== false) {
                sel = sel.join(lineSep || this.lineSeparator());
              }
              parts[i2] = sel;
            }
            return parts;
          },
          replaceSelection: function(code2, collapse, origin) {
            var dup = [];
            for (var i2 = 0; i2 < this.sel.ranges.length; i2++) {
              dup[i2] = code2;
            }
            this.replaceSelections(dup, collapse, origin || "+input");
          },
          replaceSelections: docMethodOp(function(code2, collapse, origin) {
            var changes = [], sel = this.sel;
            for (var i2 = 0; i2 < sel.ranges.length; i2++) {
              var range2 = sel.ranges[i2];
              changes[i2] = { from: range2.from(), to: range2.to(), text: this.splitLines(code2[i2]), origin };
            }
            var newSel = collapse && collapse != "end" && computeReplacedSel(this, changes, collapse);
            for (var i$12 = changes.length - 1; i$12 >= 0; i$12--) {
              makeChange(this, changes[i$12]);
            }
            if (newSel) {
              setSelectionReplaceHistory(this, newSel);
            } else if (this.cm) {
              ensureCursorVisible(this.cm);
            }
          }),
          undo: docMethodOp(function() {
            makeChangeFromHistory(this, "undo");
          }),
          redo: docMethodOp(function() {
            makeChangeFromHistory(this, "redo");
          }),
          undoSelection: docMethodOp(function() {
            makeChangeFromHistory(this, "undo", true);
          }),
          redoSelection: docMethodOp(function() {
            makeChangeFromHistory(this, "redo", true);
          }),
          setExtending: function(val) {
            this.extend = val;
          },
          getExtending: function() {
            return this.extend;
          },
          historySize: function() {
            var hist = this.history, done = 0, undone = 0;
            for (var i2 = 0; i2 < hist.done.length; i2++) {
              if (!hist.done[i2].ranges) {
                ++done;
              }
            }
            for (var i$12 = 0; i$12 < hist.undone.length; i$12++) {
              if (!hist.undone[i$12].ranges) {
                ++undone;
              }
            }
            return { undo: done, redo: undone };
          },
          clearHistory: function() {
            var this$1 = this;
            this.history = new History(this.history);
            linkedDocs(this, function(doc) {
              return doc.history = this$1.history;
            }, true);
          },
          markClean: function() {
            this.cleanGeneration = this.changeGeneration(true);
          },
          changeGeneration: function(forceSplit) {
            if (forceSplit) {
              this.history.lastOp = this.history.lastSelOp = this.history.lastOrigin = null;
            }
            return this.history.generation;
          },
          isClean: function(gen) {
            return this.history.generation == (gen || this.cleanGeneration);
          },
          getHistory: function() {
            return {
              done: copyHistoryArray(this.history.done),
              undone: copyHistoryArray(this.history.undone)
            };
          },
          setHistory: function(histData) {
            var hist = this.history = new History(this.history);
            hist.done = copyHistoryArray(histData.done.slice(0), null, true);
            hist.undone = copyHistoryArray(histData.undone.slice(0), null, true);
          },
          setGutterMarker: docMethodOp(function(line, gutterID, value) {
            return changeLine(this, line, "gutter", function(line2) {
              var markers = line2.gutterMarkers || (line2.gutterMarkers = {});
              markers[gutterID] = value;
              if (!value && isEmpty(markers)) {
                line2.gutterMarkers = null;
              }
              return true;
            });
          }),
          clearGutter: docMethodOp(function(gutterID) {
            var this$1 = this;
            this.iter(function(line) {
              if (line.gutterMarkers && line.gutterMarkers[gutterID]) {
                changeLine(this$1, line, "gutter", function() {
                  line.gutterMarkers[gutterID] = null;
                  if (isEmpty(line.gutterMarkers)) {
                    line.gutterMarkers = null;
                  }
                  return true;
                });
              }
            });
          }),
          lineInfo: function(line) {
            var n;
            if (typeof line == "number") {
              if (!isLine(this, line)) {
                return null;
              }
              n = line;
              line = getLine(this, line);
              if (!line) {
                return null;
              }
            } else {
              n = lineNo(line);
              if (n == null) {
                return null;
              }
            }
            return {
              line: n,
              handle: line,
              text: line.text,
              gutterMarkers: line.gutterMarkers,
              textClass: line.textClass,
              bgClass: line.bgClass,
              wrapClass: line.wrapClass,
              widgets: line.widgets
            };
          },
          addLineClass: docMethodOp(function(handle2, where, cls) {
            return changeLine(this, handle2, where == "gutter" ? "gutter" : "class", function(line) {
              var prop2 = where == "text" ? "textClass" : where == "background" ? "bgClass" : where == "gutter" ? "gutterClass" : "wrapClass";
              if (!line[prop2]) {
                line[prop2] = cls;
              } else if (classTest(cls).test(line[prop2])) {
                return false;
              } else {
                line[prop2] += " " + cls;
              }
              return true;
            });
          }),
          removeLineClass: docMethodOp(function(handle2, where, cls) {
            return changeLine(this, handle2, where == "gutter" ? "gutter" : "class", function(line) {
              var prop2 = where == "text" ? "textClass" : where == "background" ? "bgClass" : where == "gutter" ? "gutterClass" : "wrapClass";
              var cur = line[prop2];
              if (!cur) {
                return false;
              } else if (cls == null) {
                line[prop2] = null;
              } else {
                var found = cur.match(classTest(cls));
                if (!found) {
                  return false;
                }
                var end = found.index + found[0].length;
                line[prop2] = cur.slice(0, found.index) + (!found.index || end == cur.length ? "" : " ") + cur.slice(end) || null;
              }
              return true;
            });
          }),
          addLineWidget: docMethodOp(function(handle2, node, options) {
            return addLineWidget(this, handle2, node, options);
          }),
          removeLineWidget: function(widget) {
            widget.clear();
          },
          markText: function(from, to, options) {
            return markText(this, clipPos(this, from), clipPos(this, to), options, options && options.type || "range");
          },
          setBookmark: function(pos, options) {
            var realOpts = {
              replacedWith: options && (options.nodeType == null ? options.widget : options),
              insertLeft: options && options.insertLeft,
              clearWhenEmpty: false,
              shared: options && options.shared,
              handleMouseEvents: options && options.handleMouseEvents
            };
            pos = clipPos(this, pos);
            return markText(this, pos, pos, realOpts, "bookmark");
          },
          findMarksAt: function(pos) {
            pos = clipPos(this, pos);
            var markers = [], spans = getLine(this, pos.line).markedSpans;
            if (spans) {
              for (var i2 = 0; i2 < spans.length; ++i2) {
                var span = spans[i2];
                if ((span.from == null || span.from <= pos.ch) && (span.to == null || span.to >= pos.ch)) {
                  markers.push(span.marker.parent || span.marker);
                }
              }
            }
            return markers;
          },
          findMarks: function(from, to, filter2) {
            from = clipPos(this, from);
            to = clipPos(this, to);
            var found = [], lineNo2 = from.line;
            this.iter(from.line, to.line + 1, function(line) {
              var spans = line.markedSpans;
              if (spans) {
                for (var i2 = 0; i2 < spans.length; i2++) {
                  var span = spans[i2];
                  if (!(span.to != null && lineNo2 == from.line && from.ch >= span.to || span.from == null && lineNo2 != from.line || span.from != null && lineNo2 == to.line && span.from >= to.ch) && (!filter2 || filter2(span.marker))) {
                    found.push(span.marker.parent || span.marker);
                  }
                }
              }
              ++lineNo2;
            });
            return found;
          },
          getAllMarks: function() {
            var markers = [];
            this.iter(function(line) {
              var sps = line.markedSpans;
              if (sps) {
                for (var i2 = 0; i2 < sps.length; ++i2) {
                  if (sps[i2].from != null) {
                    markers.push(sps[i2].marker);
                  }
                }
              }
            });
            return markers;
          },
          posFromIndex: function(off2) {
            var ch, lineNo2 = this.first, sepSize = this.lineSeparator().length;
            this.iter(function(line) {
              var sz = line.text.length + sepSize;
              if (sz > off2) {
                ch = off2;
                return true;
              }
              off2 -= sz;
              ++lineNo2;
            });
            return clipPos(this, Pos(lineNo2, ch));
          },
          indexFromPos: function(coords) {
            coords = clipPos(this, coords);
            var index2 = coords.ch;
            if (coords.line < this.first || coords.ch < 0) {
              return 0;
            }
            var sepSize = this.lineSeparator().length;
            this.iter(this.first, coords.line, function(line) {
              index2 += line.text.length + sepSize;
            });
            return index2;
          },
          copy: function(copyHistory) {
            var doc = new Doc(
              getLines(this, this.first, this.first + this.size),
              this.modeOption,
              this.first,
              this.lineSep,
              this.direction
            );
            doc.scrollTop = this.scrollTop;
            doc.scrollLeft = this.scrollLeft;
            doc.sel = this.sel;
            doc.extend = false;
            if (copyHistory) {
              doc.history.undoDepth = this.history.undoDepth;
              doc.setHistory(this.getHistory());
            }
            return doc;
          },
          linkedDoc: function(options) {
            if (!options) {
              options = {};
            }
            var from = this.first, to = this.first + this.size;
            if (options.from != null && options.from > from) {
              from = options.from;
            }
            if (options.to != null && options.to < to) {
              to = options.to;
            }
            var copy = new Doc(getLines(this, from, to), options.mode || this.modeOption, from, this.lineSep, this.direction);
            if (options.sharedHist) {
              copy.history = this.history;
            }
            (this.linked || (this.linked = [])).push({ doc: copy, sharedHist: options.sharedHist });
            copy.linked = [{ doc: this, isParent: true, sharedHist: options.sharedHist }];
            copySharedMarkers(copy, findSharedMarkers(this));
            return copy;
          },
          unlinkDoc: function(other) {
            if (other instanceof CodeMirror2) {
              other = other.doc;
            }
            if (this.linked) {
              for (var i2 = 0; i2 < this.linked.length; ++i2) {
                var link = this.linked[i2];
                if (link.doc != other) {
                  continue;
                }
                this.linked.splice(i2, 1);
                other.unlinkDoc(this);
                detachSharedMarkers(findSharedMarkers(this));
                break;
              }
            }
            if (other.history == this.history) {
              var splitIds = [other.id];
              linkedDocs(other, function(doc) {
                return splitIds.push(doc.id);
              }, true);
              other.history = new History(null);
              other.history.done = copyHistoryArray(this.history.done, splitIds);
              other.history.undone = copyHistoryArray(this.history.undone, splitIds);
            }
          },
          iterLinkedDocs: function(f) {
            linkedDocs(this, f);
          },
          getMode: function() {
            return this.mode;
          },
          getEditor: function() {
            return this.cm;
          },
          splitLines: function(str) {
            if (this.lineSep) {
              return str.split(this.lineSep);
            }
            return splitLinesAuto(str);
          },
          lineSeparator: function() {
            return this.lineSep || "\n";
          },
          setDirection: docMethodOp(function(dir) {
            if (dir != "rtl") {
              dir = "ltr";
            }
            if (dir == this.direction) {
              return;
            }
            this.direction = dir;
            this.iter(function(line) {
              return line.order = null;
            });
            if (this.cm) {
              directionChanged(this.cm);
            }
          })
        });
        Doc.prototype.eachLine = Doc.prototype.iter;
        var lastDrop = 0;
        function onDrop(e) {
          var cm = this;
          clearDragCursor(cm);
          if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) {
            return;
          }
          e_preventDefault(e);
          if (ie) {
            lastDrop = +/* @__PURE__ */ new Date();
          }
          var pos = posFromMouse(cm, e, true), files = e.dataTransfer.files;
          if (!pos || cm.isReadOnly()) {
            return;
          }
          if (files && files.length && window.FileReader && window.File) {
            var n = files.length, text = Array(n), read = 0;
            var markAsReadAndPasteIfAllFilesAreRead = function() {
              if (++read == n) {
                operation(cm, function() {
                  pos = clipPos(cm.doc, pos);
                  var change = {
                    from: pos,
                    to: pos,
                    text: cm.doc.splitLines(
                      text.filter(function(t) {
                        return t != null;
                      }).join(cm.doc.lineSeparator())
                    ),
                    origin: "paste"
                  };
                  makeChange(cm.doc, change);
                  setSelectionReplaceHistory(cm.doc, simpleSelection(clipPos(cm.doc, pos), clipPos(cm.doc, changeEnd(change))));
                })();
              }
            };
            var readTextFromFile = function(file, i3) {
              if (cm.options.allowDropFileTypes && indexOf(cm.options.allowDropFileTypes, file.type) == -1) {
                markAsReadAndPasteIfAllFilesAreRead();
                return;
              }
              var reader = new FileReader();
              reader.onerror = function() {
                return markAsReadAndPasteIfAllFilesAreRead();
              };
              reader.onload = function() {
                var content = reader.result;
                if (/[\x00-\x08\x0e-\x1f]{2}/.test(content)) {
                  markAsReadAndPasteIfAllFilesAreRead();
                  return;
                }
                text[i3] = content;
                markAsReadAndPasteIfAllFilesAreRead();
              };
              reader.readAsText(file);
            };
            for (var i2 = 0; i2 < files.length; i2++) {
              readTextFromFile(files[i2], i2);
            }
          } else {
            if (cm.state.draggingText && cm.doc.sel.contains(pos) > -1) {
              cm.state.draggingText(e);
              setTimeout(function() {
                return cm.display.input.focus();
              }, 20);
              return;
            }
            try {
              var text$1 = e.dataTransfer.getData("Text");
              if (text$1) {
                var selected;
                if (cm.state.draggingText && !cm.state.draggingText.copy) {
                  selected = cm.listSelections();
                }
                setSelectionNoUndo(cm.doc, simpleSelection(pos, pos));
                if (selected) {
                  for (var i$12 = 0; i$12 < selected.length; ++i$12) {
                    replaceRange(cm.doc, "", selected[i$12].anchor, selected[i$12].head, "drag");
                  }
                }
                cm.replaceSelection(text$1, "around", "paste");
                cm.display.input.focus();
              }
            } catch (e$1) {
            }
          }
        }
        function onDragStart(cm, e) {
          if (ie && (!cm.state.draggingText || +/* @__PURE__ */ new Date() - lastDrop < 100)) {
            e_stop(e);
            return;
          }
          if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) {
            return;
          }
          e.dataTransfer.setData("Text", cm.getSelection());
          e.dataTransfer.effectAllowed = "copyMove";
          if (e.dataTransfer.setDragImage && !safari) {
            var img = elt("img", null, null, "position: fixed; left: 0; top: 0;");
            img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";
            if (presto) {
              img.width = img.height = 1;
              cm.display.wrapper.appendChild(img);
              img._top = img.offsetTop;
            }
            e.dataTransfer.setDragImage(img, 0, 0);
            if (presto) {
              img.parentNode.removeChild(img);
            }
          }
        }
        function onDragOver(cm, e) {
          var pos = posFromMouse(cm, e);
          if (!pos) {
            return;
          }
          var frag = document.createDocumentFragment();
          drawSelectionCursor(cm, pos, frag);
          if (!cm.display.dragCursor) {
            cm.display.dragCursor = elt("div", null, "CodeMirror-cursors CodeMirror-dragcursors");
            cm.display.lineSpace.insertBefore(cm.display.dragCursor, cm.display.cursorDiv);
          }
          removeChildrenAndAdd(cm.display.dragCursor, frag);
        }
        function clearDragCursor(cm) {
          if (cm.display.dragCursor) {
            cm.display.lineSpace.removeChild(cm.display.dragCursor);
            cm.display.dragCursor = null;
          }
        }
        function forEachCodeMirror(f) {
          if (!document.getElementsByClassName) {
            return;
          }
          var byClass = document.getElementsByClassName("CodeMirror"), editors2 = [];
          for (var i2 = 0; i2 < byClass.length; i2++) {
            var cm = byClass[i2].CodeMirror;
            if (cm) {
              editors2.push(cm);
            }
          }
          if (editors2.length) {
            editors2[0].operation(function() {
              for (var i3 = 0; i3 < editors2.length; i3++) {
                f(editors2[i3]);
              }
            });
          }
        }
        var globalsRegistered = false;
        function ensureGlobalHandlers() {
          if (globalsRegistered) {
            return;
          }
          registerGlobalHandlers();
          globalsRegistered = true;
        }
        function registerGlobalHandlers() {
          var resizeTimer;
          on(window, "resize", function() {
            if (resizeTimer == null) {
              resizeTimer = setTimeout(function() {
                resizeTimer = null;
                forEachCodeMirror(onResize);
              }, 100);
            }
          });
          on(window, "blur", function() {
            return forEachCodeMirror(onBlur);
          });
        }
        function onResize(cm) {
          var d = cm.display;
          d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null;
          d.scrollbarsClipped = false;
          cm.setSize();
        }
        var keyNames = {
          3: "Pause",
          8: "Backspace",
          9: "Tab",
          13: "Enter",
          16: "Shift",
          17: "Ctrl",
          18: "Alt",
          19: "Pause",
          20: "CapsLock",
          27: "Esc",
          32: "Space",
          33: "PageUp",
          34: "PageDown",
          35: "End",
          36: "Home",
          37: "Left",
          38: "Up",
          39: "Right",
          40: "Down",
          44: "PrintScrn",
          45: "Insert",
          46: "Delete",
          59: ";",
          61: "=",
          91: "Mod",
          92: "Mod",
          93: "Mod",
          106: "*",
          107: "=",
          109: "-",
          110: ".",
          111: "/",
          145: "ScrollLock",
          173: "-",
          186: ";",
          187: "=",
          188: ",",
          189: "-",
          190: ".",
          191: "/",
          192: "`",
          219: "[",
          220: "\\",
          221: "]",
          222: "'",
          224: "Mod",
          63232: "Up",
          63233: "Down",
          63234: "Left",
          63235: "Right",
          63272: "Delete",
          63273: "Home",
          63275: "End",
          63276: "PageUp",
          63277: "PageDown",
          63302: "Insert"
        };
        for (var i = 0; i < 10; i++) {
          keyNames[i + 48] = keyNames[i + 96] = String(i);
        }
        for (var i$1 = 65; i$1 <= 90; i$1++) {
          keyNames[i$1] = String.fromCharCode(i$1);
        }
        for (var i$2 = 1; i$2 <= 12; i$2++) {
          keyNames[i$2 + 111] = keyNames[i$2 + 63235] = "F" + i$2;
        }
        var keyMap = {};
        keyMap.basic = {
          "Left": "goCharLeft",
          "Right": "goCharRight",
          "Up": "goLineUp",
          "Down": "goLineDown",
          "End": "goLineEnd",
          "Home": "goLineStartSmart",
          "PageUp": "goPageUp",
          "PageDown": "goPageDown",
          "Delete": "delCharAfter",
          "Backspace": "delCharBefore",
          "Shift-Backspace": "delCharBefore",
          "Tab": "defaultTab",
          "Shift-Tab": "indentAuto",
          "Enter": "newlineAndIndent",
          "Insert": "toggleOverwrite",
          "Esc": "singleSelection"
        };
        keyMap.pcDefault = {
          "Ctrl-A": "selectAll",
          "Ctrl-D": "deleteLine",
          "Ctrl-Z": "undo",
          "Shift-Ctrl-Z": "redo",
          "Ctrl-Y": "redo",
          "Ctrl-Home": "goDocStart",
          "Ctrl-End": "goDocEnd",
          "Ctrl-Up": "goLineUp",
          "Ctrl-Down": "goLineDown",
          "Ctrl-Left": "goGroupLeft",
          "Ctrl-Right": "goGroupRight",
          "Alt-Left": "goLineStart",
          "Alt-Right": "goLineEnd",
          "Ctrl-Backspace": "delGroupBefore",
          "Ctrl-Delete": "delGroupAfter",
          "Ctrl-S": "save",
          "Ctrl-F": "find",
          "Ctrl-G": "findNext",
          "Shift-Ctrl-G": "findPrev",
          "Shift-Ctrl-F": "replace",
          "Shift-Ctrl-R": "replaceAll",
          "Ctrl-[": "indentLess",
          "Ctrl-]": "indentMore",
          "Ctrl-U": "undoSelection",
          "Shift-Ctrl-U": "redoSelection",
          "Alt-U": "redoSelection",
          "fallthrough": "basic"
        };
        keyMap.emacsy = {
          "Ctrl-F": "goCharRight",
          "Ctrl-B": "goCharLeft",
          "Ctrl-P": "goLineUp",
          "Ctrl-N": "goLineDown",
          "Ctrl-A": "goLineStart",
          "Ctrl-E": "goLineEnd",
          "Ctrl-V": "goPageDown",
          "Shift-Ctrl-V": "goPageUp",
          "Ctrl-D": "delCharAfter",
          "Ctrl-H": "delCharBefore",
          "Alt-Backspace": "delWordBefore",
          "Ctrl-K": "killLine",
          "Ctrl-T": "transposeChars",
          "Ctrl-O": "openLine"
        };
        keyMap.macDefault = {
          "Cmd-A": "selectAll",
          "Cmd-D": "deleteLine",
          "Cmd-Z": "undo",
          "Shift-Cmd-Z": "redo",
          "Cmd-Y": "redo",
          "Cmd-Home": "goDocStart",
          "Cmd-Up": "goDocStart",
          "Cmd-End": "goDocEnd",
          "Cmd-Down": "goDocEnd",
          "Alt-Left": "goGroupLeft",
          "Alt-Right": "goGroupRight",
          "Cmd-Left": "goLineLeft",
          "Cmd-Right": "goLineRight",
          "Alt-Backspace": "delGroupBefore",
          "Ctrl-Alt-Backspace": "delGroupAfter",
          "Alt-Delete": "delGroupAfter",
          "Cmd-S": "save",
          "Cmd-F": "find",
          "Cmd-G": "findNext",
          "Shift-Cmd-G": "findPrev",
          "Cmd-Alt-F": "replace",
          "Shift-Cmd-Alt-F": "replaceAll",
          "Cmd-[": "indentLess",
          "Cmd-]": "indentMore",
          "Cmd-Backspace": "delWrappedLineLeft",
          "Cmd-Delete": "delWrappedLineRight",
          "Cmd-U": "undoSelection",
          "Shift-Cmd-U": "redoSelection",
          "Ctrl-Up": "goDocStart",
          "Ctrl-Down": "goDocEnd",
          "fallthrough": ["basic", "emacsy"]
        };
        keyMap["default"] = mac ? keyMap.macDefault : keyMap.pcDefault;
        function normalizeKeyName(name) {
          var parts = name.split(/-(?!$)/);
          name = parts[parts.length - 1];
          var alt, ctrl, shift, cmd;
          for (var i2 = 0; i2 < parts.length - 1; i2++) {
            var mod = parts[i2];
            if (/^(cmd|meta|m)$/i.test(mod)) {
              cmd = true;
            } else if (/^a(lt)?$/i.test(mod)) {
              alt = true;
            } else if (/^(c|ctrl|control)$/i.test(mod)) {
              ctrl = true;
            } else if (/^s(hift)?$/i.test(mod)) {
              shift = true;
            } else {
              throw new Error("Unrecognized modifier name: " + mod);
            }
          }
          if (alt) {
            name = "Alt-" + name;
          }
          if (ctrl) {
            name = "Ctrl-" + name;
          }
          if (cmd) {
            name = "Cmd-" + name;
          }
          if (shift) {
            name = "Shift-" + name;
          }
          return name;
        }
        function normalizeKeyMap(keymap) {
          var copy = {};
          for (var keyname in keymap) {
            if (keymap.hasOwnProperty(keyname)) {
              var value = keymap[keyname];
              if (/^(name|fallthrough|(de|at)tach)$/.test(keyname)) {
                continue;
              }
              if (value == "...") {
                delete keymap[keyname];
                continue;
              }
              var keys = map(keyname.split(" "), normalizeKeyName);
              for (var i2 = 0; i2 < keys.length; i2++) {
                var val = void 0, name = void 0;
                if (i2 == keys.length - 1) {
                  name = keys.join(" ");
                  val = value;
                } else {
                  name = keys.slice(0, i2 + 1).join(" ");
                  val = "...";
                }
                var prev = copy[name];
                if (!prev) {
                  copy[name] = val;
                } else if (prev != val) {
                  throw new Error("Inconsistent bindings for " + name);
                }
              }
              delete keymap[keyname];
            }
          }
          for (var prop2 in copy) {
            keymap[prop2] = copy[prop2];
          }
          return keymap;
        }
        function lookupKey(key, map2, handle2, context) {
          map2 = getKeyMap(map2);
          var found = map2.call ? map2.call(key, context) : map2[key];
          if (found === false) {
            return "nothing";
          }
          if (found === "...") {
            return "multi";
          }
          if (found != null && handle2(found)) {
            return "handled";
          }
          if (map2.fallthrough) {
            if (Object.prototype.toString.call(map2.fallthrough) != "[object Array]") {
              return lookupKey(key, map2.fallthrough, handle2, context);
            }
            for (var i2 = 0; i2 < map2.fallthrough.length; i2++) {
              var result = lookupKey(key, map2.fallthrough[i2], handle2, context);
              if (result) {
                return result;
              }
            }
          }
        }
        function isModifierKey(value) {
          var name = typeof value == "string" ? value : keyNames[value.keyCode];
          return name == "Ctrl" || name == "Alt" || name == "Shift" || name == "Mod";
        }
        function addModifierNames(name, event, noShift) {
          var base = name;
          if (event.altKey && base != "Alt") {
            name = "Alt-" + name;
          }
          if ((flipCtrlCmd ? event.metaKey : event.ctrlKey) && base != "Ctrl") {
            name = "Ctrl-" + name;
          }
          if ((flipCtrlCmd ? event.ctrlKey : event.metaKey) && base != "Mod") {
            name = "Cmd-" + name;
          }
          if (!noShift && event.shiftKey && base != "Shift") {
            name = "Shift-" + name;
          }
          return name;
        }
        function keyName(event, noShift) {
          if (presto && event.keyCode == 34 && event["char"]) {
            return false;
          }
          var name = keyNames[event.keyCode];
          if (name == null || event.altGraphKey) {
            return false;
          }
          if (event.keyCode == 3 && event.code) {
            name = event.code;
          }
          return addModifierNames(name, event, noShift);
        }
        function getKeyMap(val) {
          return typeof val == "string" ? keyMap[val] : val;
        }
        function deleteNearSelection(cm, compute) {
          var ranges = cm.doc.sel.ranges, kill = [];
          for (var i2 = 0; i2 < ranges.length; i2++) {
            var toKill = compute(ranges[i2]);
            while (kill.length && cmp(toKill.from, lst(kill).to) <= 0) {
              var replaced = kill.pop();
              if (cmp(replaced.from, toKill.from) < 0) {
                toKill.from = replaced.from;
                break;
              }
            }
            kill.push(toKill);
          }
          runInOp(cm, function() {
            for (var i3 = kill.length - 1; i3 >= 0; i3--) {
              replaceRange(cm.doc, "", kill[i3].from, kill[i3].to, "+delete");
            }
            ensureCursorVisible(cm);
          });
        }
        function moveCharLogically(line, ch, dir) {
          var target = skipExtendingChars(line.text, ch + dir, dir);
          return target < 0 || target > line.text.length ? null : target;
        }
        function moveLogically(line, start, dir) {
          var ch = moveCharLogically(line, start.ch, dir);
          return ch == null ? null : new Pos(start.line, ch, dir < 0 ? "after" : "before");
        }
        function endOfLine(visually, cm, lineObj, lineNo2, dir) {
          if (visually) {
            if (cm.doc.direction == "rtl") {
              dir = -dir;
            }
            var order = getOrder(lineObj, cm.doc.direction);
            if (order) {
              var part = dir < 0 ? lst(order) : order[0];
              var moveInStorageOrder = dir < 0 == (part.level == 1);
              var sticky = moveInStorageOrder ? "after" : "before";
              var ch;
              if (part.level > 0 || cm.doc.direction == "rtl") {
                var prep = prepareMeasureForLine(cm, lineObj);
                ch = dir < 0 ? lineObj.text.length - 1 : 0;
                var targetTop = measureCharPrepared(cm, prep, ch).top;
                ch = findFirst(function(ch2) {
                  return measureCharPrepared(cm, prep, ch2).top == targetTop;
                }, dir < 0 == (part.level == 1) ? part.from : part.to - 1, ch);
                if (sticky == "before") {
                  ch = moveCharLogically(lineObj, ch, 1);
                }
              } else {
                ch = dir < 0 ? part.to : part.from;
              }
              return new Pos(lineNo2, ch, sticky);
            }
          }
          return new Pos(lineNo2, dir < 0 ? lineObj.text.length : 0, dir < 0 ? "before" : "after");
        }
        function moveVisually(cm, line, start, dir) {
          var bidi = getOrder(line, cm.doc.direction);
          if (!bidi) {
            return moveLogically(line, start, dir);
          }
          if (start.ch >= line.text.length) {
            start.ch = line.text.length;
            start.sticky = "before";
          } else if (start.ch <= 0) {
            start.ch = 0;
            start.sticky = "after";
          }
          var partPos = getBidiPartAt(bidi, start.ch, start.sticky), part = bidi[partPos];
          if (cm.doc.direction == "ltr" && part.level % 2 == 0 && (dir > 0 ? part.to > start.ch : part.from < start.ch)) {
            return moveLogically(line, start, dir);
          }
          var mv = function(pos, dir2) {
            return moveCharLogically(line, pos instanceof Pos ? pos.ch : pos, dir2);
          };
          var prep;
          var getWrappedLineExtent = function(ch2) {
            if (!cm.options.lineWrapping) {
              return { begin: 0, end: line.text.length };
            }
            prep = prep || prepareMeasureForLine(cm, line);
            return wrappedLineExtentChar(cm, line, prep, ch2);
          };
          var wrappedLineExtent2 = getWrappedLineExtent(start.sticky == "before" ? mv(start, -1) : start.ch);
          if (cm.doc.direction == "rtl" || part.level == 1) {
            var moveInStorageOrder = part.level == 1 == dir < 0;
            var ch = mv(start, moveInStorageOrder ? 1 : -1);
            if (ch != null && (!moveInStorageOrder ? ch >= part.from && ch >= wrappedLineExtent2.begin : ch <= part.to && ch <= wrappedLineExtent2.end)) {
              var sticky = moveInStorageOrder ? "before" : "after";
              return new Pos(start.line, ch, sticky);
            }
          }
          var searchInVisualLine = function(partPos2, dir2, wrappedLineExtent3) {
            var getRes = function(ch3, moveInStorageOrder3) {
              return moveInStorageOrder3 ? new Pos(start.line, mv(ch3, 1), "before") : new Pos(start.line, ch3, "after");
            };
            for (; partPos2 >= 0 && partPos2 < bidi.length; partPos2 += dir2) {
              var part2 = bidi[partPos2];
              var moveInStorageOrder2 = dir2 > 0 == (part2.level != 1);
              var ch2 = moveInStorageOrder2 ? wrappedLineExtent3.begin : mv(wrappedLineExtent3.end, -1);
              if (part2.from <= ch2 && ch2 < part2.to) {
                return getRes(ch2, moveInStorageOrder2);
              }
              ch2 = moveInStorageOrder2 ? part2.from : mv(part2.to, -1);
              if (wrappedLineExtent3.begin <= ch2 && ch2 < wrappedLineExtent3.end) {
                return getRes(ch2, moveInStorageOrder2);
              }
            }
          };
          var res = searchInVisualLine(partPos + dir, dir, wrappedLineExtent2);
          if (res) {
            return res;
          }
          var nextCh = dir > 0 ? wrappedLineExtent2.end : mv(wrappedLineExtent2.begin, -1);
          if (nextCh != null && !(dir > 0 && nextCh == line.text.length)) {
            res = searchInVisualLine(dir > 0 ? 0 : bidi.length - 1, dir, getWrappedLineExtent(nextCh));
            if (res) {
              return res;
            }
          }
          return null;
        }
        var commands2 = {
          selectAll,
          singleSelection: function(cm) {
            return cm.setSelection(cm.getCursor("anchor"), cm.getCursor("head"), sel_dontScroll);
          },
          killLine: function(cm) {
            return deleteNearSelection(cm, function(range2) {
              if (range2.empty()) {
                var len = getLine(cm.doc, range2.head.line).text.length;
                if (range2.head.ch == len && range2.head.line < cm.lastLine()) {
                  return { from: range2.head, to: Pos(range2.head.line + 1, 0) };
                } else {
                  return { from: range2.head, to: Pos(range2.head.line, len) };
                }
              } else {
                return { from: range2.from(), to: range2.to() };
              }
            });
          },
          deleteLine: function(cm) {
            return deleteNearSelection(cm, function(range2) {
              return {
                from: Pos(range2.from().line, 0),
                to: clipPos(cm.doc, Pos(range2.to().line + 1, 0))
              };
            });
          },
          delLineLeft: function(cm) {
            return deleteNearSelection(cm, function(range2) {
              return {
                from: Pos(range2.from().line, 0),
                to: range2.from()
              };
            });
          },
          delWrappedLineLeft: function(cm) {
            return deleteNearSelection(cm, function(range2) {
              var top = cm.charCoords(range2.head, "div").top + 5;
              var leftPos = cm.coordsChar({ left: 0, top }, "div");
              return { from: leftPos, to: range2.from() };
            });
          },
          delWrappedLineRight: function(cm) {
            return deleteNearSelection(cm, function(range2) {
              var top = cm.charCoords(range2.head, "div").top + 5;
              var rightPos = cm.coordsChar({ left: cm.display.lineDiv.offsetWidth + 100, top }, "div");
              return { from: range2.from(), to: rightPos };
            });
          },
          undo: function(cm) {
            return cm.undo();
          },
          redo: function(cm) {
            return cm.redo();
          },
          undoSelection: function(cm) {
            return cm.undoSelection();
          },
          redoSelection: function(cm) {
            return cm.redoSelection();
          },
          goDocStart: function(cm) {
            return cm.extendSelection(Pos(cm.firstLine(), 0));
          },
          goDocEnd: function(cm) {
            return cm.extendSelection(Pos(cm.lastLine()));
          },
          goLineStart: function(cm) {
            return cm.extendSelectionsBy(
              function(range2) {
                return lineStart(cm, range2.head.line);
              },
              { origin: "+move", bias: 1 }
            );
          },
          goLineStartSmart: function(cm) {
            return cm.extendSelectionsBy(
              function(range2) {
                return lineStartSmart(cm, range2.head);
              },
              { origin: "+move", bias: 1 }
            );
          },
          goLineEnd: function(cm) {
            return cm.extendSelectionsBy(
              function(range2) {
                return lineEnd(cm, range2.head.line);
              },
              { origin: "+move", bias: -1 }
            );
          },
          goLineRight: function(cm) {
            return cm.extendSelectionsBy(function(range2) {
              var top = cm.cursorCoords(range2.head, "div").top + 5;
              return cm.coordsChar({ left: cm.display.lineDiv.offsetWidth + 100, top }, "div");
            }, sel_move);
          },
          goLineLeft: function(cm) {
            return cm.extendSelectionsBy(function(range2) {
              var top = cm.cursorCoords(range2.head, "div").top + 5;
              return cm.coordsChar({ left: 0, top }, "div");
            }, sel_move);
          },
          goLineLeftSmart: function(cm) {
            return cm.extendSelectionsBy(function(range2) {
              var top = cm.cursorCoords(range2.head, "div").top + 5;
              var pos = cm.coordsChar({ left: 0, top }, "div");
              if (pos.ch < cm.getLine(pos.line).search(/\S/)) {
                return lineStartSmart(cm, range2.head);
              }
              return pos;
            }, sel_move);
          },
          goLineUp: function(cm) {
            return cm.moveV(-1, "line");
          },
          goLineDown: function(cm) {
            return cm.moveV(1, "line");
          },
          goPageUp: function(cm) {
            return cm.moveV(-1, "page");
          },
          goPageDown: function(cm) {
            return cm.moveV(1, "page");
          },
          goCharLeft: function(cm) {
            return cm.moveH(-1, "char");
          },
          goCharRight: function(cm) {
            return cm.moveH(1, "char");
          },
          goColumnLeft: function(cm) {
            return cm.moveH(-1, "column");
          },
          goColumnRight: function(cm) {
            return cm.moveH(1, "column");
          },
          goWordLeft: function(cm) {
            return cm.moveH(-1, "word");
          },
          goGroupRight: function(cm) {
            return cm.moveH(1, "group");
          },
          goGroupLeft: function(cm) {
            return cm.moveH(-1, "group");
          },
          goWordRight: function(cm) {
            return cm.moveH(1, "word");
          },
          delCharBefore: function(cm) {
            return cm.deleteH(-1, "codepoint");
          },
          delCharAfter: function(cm) {
            return cm.deleteH(1, "char");
          },
          delWordBefore: function(cm) {
            return cm.deleteH(-1, "word");
          },
          delWordAfter: function(cm) {
            return cm.deleteH(1, "word");
          },
          delGroupBefore: function(cm) {
            return cm.deleteH(-1, "group");
          },
          delGroupAfter: function(cm) {
            return cm.deleteH(1, "group");
          },
          indentAuto: function(cm) {
            return cm.indentSelection("smart");
          },
          indentMore: function(cm) {
            return cm.indentSelection("add");
          },
          indentLess: function(cm) {
            return cm.indentSelection("subtract");
          },
          insertTab: function(cm) {
            return cm.replaceSelection("	");
          },
          insertSoftTab: function(cm) {
            var spaces = [], ranges = cm.listSelections(), tabSize = cm.options.tabSize;
            for (var i2 = 0; i2 < ranges.length; i2++) {
              var pos = ranges[i2].from();
              var col = countColumn(cm.getLine(pos.line), pos.ch, tabSize);
              spaces.push(spaceStr(tabSize - col % tabSize));
            }
            cm.replaceSelections(spaces);
          },
          defaultTab: function(cm) {
            if (cm.somethingSelected()) {
              cm.indentSelection("add");
            } else {
              cm.execCommand("insertTab");
            }
          },
          // Swap the two chars left and right of each selection's head.
          // Move cursor behind the two swapped characters afterwards.
          //
          // Doesn't consider line feeds a character.
          // Doesn't scan more than one line above to find a character.
          // Doesn't do anything on an empty line.
          // Doesn't do anything with non-empty selections.
          transposeChars: function(cm) {
            return runInOp(cm, function() {
              var ranges = cm.listSelections(), newSel = [];
              for (var i2 = 0; i2 < ranges.length; i2++) {
                if (!ranges[i2].empty()) {
                  continue;
                }
                var cur = ranges[i2].head, line = getLine(cm.doc, cur.line).text;
                if (line) {
                  if (cur.ch == line.length) {
                    cur = new Pos(cur.line, cur.ch - 1);
                  }
                  if (cur.ch > 0) {
                    cur = new Pos(cur.line, cur.ch + 1);
                    cm.replaceRange(
                      line.charAt(cur.ch - 1) + line.charAt(cur.ch - 2),
                      Pos(cur.line, cur.ch - 2),
                      cur,
                      "+transpose"
                    );
                  } else if (cur.line > cm.doc.first) {
                    var prev = getLine(cm.doc, cur.line - 1).text;
                    if (prev) {
                      cur = new Pos(cur.line, 1);
                      cm.replaceRange(
                        line.charAt(0) + cm.doc.lineSeparator() + prev.charAt(prev.length - 1),
                        Pos(cur.line - 1, prev.length - 1),
                        cur,
                        "+transpose"
                      );
                    }
                  }
                }
                newSel.push(new Range(cur, cur));
              }
              cm.setSelections(newSel);
            });
          },
          newlineAndIndent: function(cm) {
            return runInOp(cm, function() {
              var sels = cm.listSelections();
              for (var i2 = sels.length - 1; i2 >= 0; i2--) {
                cm.replaceRange(cm.doc.lineSeparator(), sels[i2].anchor, sels[i2].head, "+input");
              }
              sels = cm.listSelections();
              for (var i$12 = 0; i$12 < sels.length; i$12++) {
                cm.indentLine(sels[i$12].from().line, null, true);
              }
              ensureCursorVisible(cm);
            });
          },
          openLine: function(cm) {
            return cm.replaceSelection("\n", "start");
          },
          toggleOverwrite: function(cm) {
            return cm.toggleOverwrite();
          }
        };
        function lineStart(cm, lineN) {
          var line = getLine(cm.doc, lineN);
          var visual = visualLine(line);
          if (visual != line) {
            lineN = lineNo(visual);
          }
          return endOfLine(true, cm, visual, lineN, 1);
        }
        function lineEnd(cm, lineN) {
          var line = getLine(cm.doc, lineN);
          var visual = visualLineEnd(line);
          if (visual != line) {
            lineN = lineNo(visual);
          }
          return endOfLine(true, cm, line, lineN, -1);
        }
        function lineStartSmart(cm, pos) {
          var start = lineStart(cm, pos.line);
          var line = getLine(cm.doc, start.line);
          var order = getOrder(line, cm.doc.direction);
          if (!order || order[0].level == 0) {
            var firstNonWS = Math.max(start.ch, line.text.search(/\S/));
            var inWS = pos.line == start.line && pos.ch <= firstNonWS && pos.ch;
            return Pos(start.line, inWS ? 0 : firstNonWS, start.sticky);
          }
          return start;
        }
        function doHandleBinding(cm, bound, dropShift) {
          if (typeof bound == "string") {
            bound = commands2[bound];
            if (!bound) {
              return false;
            }
          }
          cm.display.input.ensurePolled();
          var prevShift = cm.display.shift, done = false;
          try {
            if (cm.isReadOnly()) {
              cm.state.suppressEdits = true;
            }
            if (dropShift) {
              cm.display.shift = false;
            }
            done = bound(cm) != Pass;
          } finally {
            cm.display.shift = prevShift;
            cm.state.suppressEdits = false;
          }
          return done;
        }
        function lookupKeyForEditor(cm, name, handle2) {
          for (var i2 = 0; i2 < cm.state.keyMaps.length; i2++) {
            var result = lookupKey(name, cm.state.keyMaps[i2], handle2, cm);
            if (result) {
              return result;
            }
          }
          return cm.options.extraKeys && lookupKey(name, cm.options.extraKeys, handle2, cm) || lookupKey(name, cm.options.keyMap, handle2, cm);
        }
        var stopSeq = new Delayed();
        function dispatchKey(cm, name, e, handle2) {
          var seq = cm.state.keySeq;
          if (seq) {
            if (isModifierKey(name)) {
              return "handled";
            }
            if (/\'$/.test(name)) {
              cm.state.keySeq = null;
            } else {
              stopSeq.set(50, function() {
                if (cm.state.keySeq == seq) {
                  cm.state.keySeq = null;
                  cm.display.input.reset();
                }
              });
            }
            if (dispatchKeyInner(cm, seq + " " + name, e, handle2)) {
              return true;
            }
          }
          return dispatchKeyInner(cm, name, e, handle2);
        }
        function dispatchKeyInner(cm, name, e, handle2) {
          var result = lookupKeyForEditor(cm, name, handle2);
          if (result == "multi") {
            cm.state.keySeq = name;
          }
          if (result == "handled") {
            signalLater(cm, "keyHandled", cm, name, e);
          }
          if (result == "handled" || result == "multi") {
            e_preventDefault(e);
            restartBlink(cm);
          }
          return !!result;
        }
        function handleKeyBinding(cm, e) {
          var name = keyName(e, true);
          if (!name) {
            return false;
          }
          if (e.shiftKey && !cm.state.keySeq) {
            return dispatchKey(cm, "Shift-" + name, e, function(b) {
              return doHandleBinding(cm, b, true);
            }) || dispatchKey(cm, name, e, function(b) {
              if (typeof b == "string" ? /^go[A-Z]/.test(b) : b.motion) {
                return doHandleBinding(cm, b);
              }
            });
          } else {
            return dispatchKey(cm, name, e, function(b) {
              return doHandleBinding(cm, b);
            });
          }
        }
        function handleCharBinding(cm, e, ch) {
          return dispatchKey(cm, "'" + ch + "'", e, function(b) {
            return doHandleBinding(cm, b, true);
          });
        }
        var lastStoppedKey = null;
        function onKeyDown(e) {
          var cm = this;
          if (e.target && e.target != cm.display.input.getField()) {
            return;
          }
          cm.curOp.focus = activeElt();
          if (signalDOMEvent(cm, e)) {
            return;
          }
          if (ie && ie_version < 11 && e.keyCode == 27) {
            e.returnValue = false;
          }
          var code2 = e.keyCode;
          cm.display.shift = code2 == 16 || e.shiftKey;
          var handled = handleKeyBinding(cm, e);
          if (presto) {
            lastStoppedKey = handled ? code2 : null;
            if (!handled && code2 == 88 && !hasCopyEvent && (mac ? e.metaKey : e.ctrlKey)) {
              cm.replaceSelection("", null, "cut");
            }
          }
          if (gecko && !mac && !handled && code2 == 46 && e.shiftKey && !e.ctrlKey && document.execCommand) {
            document.execCommand("cut");
          }
          if (code2 == 18 && !/\bCodeMirror-crosshair\b/.test(cm.display.lineDiv.className)) {
            showCrossHair(cm);
          }
        }
        function showCrossHair(cm) {
          var lineDiv = cm.display.lineDiv;
          addClass(lineDiv, "CodeMirror-crosshair");
          function up(e) {
            if (e.keyCode == 18 || !e.altKey) {
              rmClass(lineDiv, "CodeMirror-crosshair");
              off(document, "keyup", up);
              off(document, "mouseover", up);
            }
          }
          on(document, "keyup", up);
          on(document, "mouseover", up);
        }
        function onKeyUp(e) {
          if (e.keyCode == 16) {
            this.doc.sel.shift = false;
          }
          signalDOMEvent(this, e);
        }
        function onKeyPress(e) {
          var cm = this;
          if (e.target && e.target != cm.display.input.getField()) {
            return;
          }
          if (eventInWidget(cm.display, e) || signalDOMEvent(cm, e) || e.ctrlKey && !e.altKey || mac && e.metaKey) {
            return;
          }
          var keyCode = e.keyCode, charCode = e.charCode;
          if (presto && keyCode == lastStoppedKey) {
            lastStoppedKey = null;
            e_preventDefault(e);
            return;
          }
          if (presto && (!e.which || e.which < 10) && handleKeyBinding(cm, e)) {
            return;
          }
          var ch = String.fromCharCode(charCode == null ? keyCode : charCode);
          if (ch == "\b") {
            return;
          }
          if (handleCharBinding(cm, e, ch)) {
            return;
          }
          cm.display.input.onKeyPress(e);
        }
        var DOUBLECLICK_DELAY = 400;
        var PastClick = function(time, pos, button) {
          this.time = time;
          this.pos = pos;
          this.button = button;
        };
        PastClick.prototype.compare = function(time, pos, button) {
          return this.time + DOUBLECLICK_DELAY > time && cmp(pos, this.pos) == 0 && button == this.button;
        };
        var lastClick, lastDoubleClick;
        function clickRepeat(pos, button) {
          var now = +/* @__PURE__ */ new Date();
          if (lastDoubleClick && lastDoubleClick.compare(now, pos, button)) {
            lastClick = lastDoubleClick = null;
            return "triple";
          } else if (lastClick && lastClick.compare(now, pos, button)) {
            lastDoubleClick = new PastClick(now, pos, button);
            lastClick = null;
            return "double";
          } else {
            lastClick = new PastClick(now, pos, button);
            lastDoubleClick = null;
            return "single";
          }
        }
        function onMouseDown(e) {
          var cm = this, display = cm.display;
          if (signalDOMEvent(cm, e) || display.activeTouch && display.input.supportsTouch()) {
            return;
          }
          display.input.ensurePolled();
          display.shift = e.shiftKey;
          if (eventInWidget(display, e)) {
            if (!webkit) {
              display.scroller.draggable = false;
              setTimeout(function() {
                return display.scroller.draggable = true;
              }, 100);
            }
            return;
          }
          if (clickInGutter(cm, e)) {
            return;
          }
          var pos = posFromMouse(cm, e), button = e_button(e), repeat = pos ? clickRepeat(pos, button) : "single";
          window.focus();
          if (button == 1 && cm.state.selectingText) {
            cm.state.selectingText(e);
          }
          if (pos && handleMappedButton(cm, button, pos, repeat, e)) {
            return;
          }
          if (button == 1) {
            if (pos) {
              leftButtonDown(cm, pos, repeat, e);
            } else if (e_target(e) == display.scroller) {
              e_preventDefault(e);
            }
          } else if (button == 2) {
            if (pos) {
              extendSelection(cm.doc, pos);
            }
            setTimeout(function() {
              return display.input.focus();
            }, 20);
          } else if (button == 3) {
            if (captureRightClick) {
              cm.display.input.onContextMenu(e);
            } else {
              delayBlurEvent(cm);
            }
          }
        }
        function handleMappedButton(cm, button, pos, repeat, event) {
          var name = "Click";
          if (repeat == "double") {
            name = "Double" + name;
          } else if (repeat == "triple") {
            name = "Triple" + name;
          }
          name = (button == 1 ? "Left" : button == 2 ? "Middle" : "Right") + name;
          return dispatchKey(cm, addModifierNames(name, event), event, function(bound) {
            if (typeof bound == "string") {
              bound = commands2[bound];
            }
            if (!bound) {
              return false;
            }
            var done = false;
            try {
              if (cm.isReadOnly()) {
                cm.state.suppressEdits = true;
              }
              done = bound(cm, pos) != Pass;
            } finally {
              cm.state.suppressEdits = false;
            }
            return done;
          });
        }
        function configureMouse(cm, repeat, event) {
          var option = cm.getOption("configureMouse");
          var value = option ? option(cm, repeat, event) : {};
          if (value.unit == null) {
            var rect = chromeOS ? event.shiftKey && event.metaKey : event.altKey;
            value.unit = rect ? "rectangle" : repeat == "single" ? "char" : repeat == "double" ? "word" : "line";
          }
          if (value.extend == null || cm.doc.extend) {
            value.extend = cm.doc.extend || event.shiftKey;
          }
          if (value.addNew == null) {
            value.addNew = mac ? event.metaKey : event.ctrlKey;
          }
          if (value.moveOnDrag == null) {
            value.moveOnDrag = !(mac ? event.altKey : event.ctrlKey);
          }
          return value;
        }
        function leftButtonDown(cm, pos, repeat, event) {
          if (ie) {
            setTimeout(bind2(ensureFocus, cm), 0);
          } else {
            cm.curOp.focus = activeElt();
          }
          var behavior = configureMouse(cm, repeat, event);
          var sel = cm.doc.sel, contained;
          if (cm.options.dragDrop && dragAndDrop && !cm.isReadOnly() && repeat == "single" && (contained = sel.contains(pos)) > -1 && (cmp((contained = sel.ranges[contained]).from(), pos) < 0 || pos.xRel > 0) && (cmp(contained.to(), pos) > 0 || pos.xRel < 0)) {
            leftButtonStartDrag(cm, event, pos, behavior);
          } else {
            leftButtonSelect(cm, event, pos, behavior);
          }
        }
        function leftButtonStartDrag(cm, event, pos, behavior) {
          var display = cm.display, moved = false;
          var dragEnd = operation(cm, function(e) {
            if (webkit) {
              display.scroller.draggable = false;
            }
            cm.state.draggingText = false;
            if (cm.state.delayingBlurEvent) {
              if (cm.hasFocus()) {
                cm.state.delayingBlurEvent = false;
              } else {
                delayBlurEvent(cm);
              }
            }
            off(display.wrapper.ownerDocument, "mouseup", dragEnd);
            off(display.wrapper.ownerDocument, "mousemove", mouseMove);
            off(display.scroller, "dragstart", dragStart);
            off(display.scroller, "drop", dragEnd);
            if (!moved) {
              e_preventDefault(e);
              if (!behavior.addNew) {
                extendSelection(cm.doc, pos, null, null, behavior.extend);
              }
              if (webkit && !safari || ie && ie_version == 9) {
                setTimeout(function() {
                  display.wrapper.ownerDocument.body.focus({ preventScroll: true });
                  display.input.focus();
                }, 20);
              } else {
                display.input.focus();
              }
            }
          });
          var mouseMove = function(e2) {
            moved = moved || Math.abs(event.clientX - e2.clientX) + Math.abs(event.clientY - e2.clientY) >= 10;
          };
          var dragStart = function() {
            return moved = true;
          };
          if (webkit) {
            display.scroller.draggable = true;
          }
          cm.state.draggingText = dragEnd;
          dragEnd.copy = !behavior.moveOnDrag;
          on(display.wrapper.ownerDocument, "mouseup", dragEnd);
          on(display.wrapper.ownerDocument, "mousemove", mouseMove);
          on(display.scroller, "dragstart", dragStart);
          on(display.scroller, "drop", dragEnd);
          cm.state.delayingBlurEvent = true;
          setTimeout(function() {
            return display.input.focus();
          }, 20);
          if (display.scroller.dragDrop) {
            display.scroller.dragDrop();
          }
        }
        function rangeForUnit(cm, pos, unit) {
          if (unit == "char") {
            return new Range(pos, pos);
          }
          if (unit == "word") {
            return cm.findWordAt(pos);
          }
          if (unit == "line") {
            return new Range(Pos(pos.line, 0), clipPos(cm.doc, Pos(pos.line + 1, 0)));
          }
          var result = unit(cm, pos);
          return new Range(result.from, result.to);
        }
        function leftButtonSelect(cm, event, start, behavior) {
          if (ie) {
            delayBlurEvent(cm);
          }
          var display = cm.display, doc = cm.doc;
          e_preventDefault(event);
          var ourRange, ourIndex, startSel = doc.sel, ranges = startSel.ranges;
          if (behavior.addNew && !behavior.extend) {
            ourIndex = doc.sel.contains(start);
            if (ourIndex > -1) {
              ourRange = ranges[ourIndex];
            } else {
              ourRange = new Range(start, start);
            }
          } else {
            ourRange = doc.sel.primary();
            ourIndex = doc.sel.primIndex;
          }
          if (behavior.unit == "rectangle") {
            if (!behavior.addNew) {
              ourRange = new Range(start, start);
            }
            start = posFromMouse(cm, event, true, true);
            ourIndex = -1;
          } else {
            var range2 = rangeForUnit(cm, start, behavior.unit);
            if (behavior.extend) {
              ourRange = extendRange(ourRange, range2.anchor, range2.head, behavior.extend);
            } else {
              ourRange = range2;
            }
          }
          if (!behavior.addNew) {
            ourIndex = 0;
            setSelection(doc, new Selection([ourRange], 0), sel_mouse);
            startSel = doc.sel;
          } else if (ourIndex == -1) {
            ourIndex = ranges.length;
            setSelection(
              doc,
              normalizeSelection(cm, ranges.concat([ourRange]), ourIndex),
              { scroll: false, origin: "*mouse" }
            );
          } else if (ranges.length > 1 && ranges[ourIndex].empty() && behavior.unit == "char" && !behavior.extend) {
            setSelection(
              doc,
              normalizeSelection(cm, ranges.slice(0, ourIndex).concat(ranges.slice(ourIndex + 1)), 0),
              { scroll: false, origin: "*mouse" }
            );
            startSel = doc.sel;
          } else {
            replaceOneSelection(doc, ourIndex, ourRange, sel_mouse);
          }
          var lastPos = start;
          function extendTo(pos) {
            if (cmp(lastPos, pos) == 0) {
              return;
            }
            lastPos = pos;
            if (behavior.unit == "rectangle") {
              var ranges2 = [], tabSize = cm.options.tabSize;
              var startCol = countColumn(getLine(doc, start.line).text, start.ch, tabSize);
              var posCol = countColumn(getLine(doc, pos.line).text, pos.ch, tabSize);
              var left = Math.min(startCol, posCol), right = Math.max(startCol, posCol);
              for (var line = Math.min(start.line, pos.line), end = Math.min(cm.lastLine(), Math.max(start.line, pos.line)); line <= end; line++) {
                var text = getLine(doc, line).text, leftPos = findColumn(text, left, tabSize);
                if (left == right) {
                  ranges2.push(new Range(Pos(line, leftPos), Pos(line, leftPos)));
                } else if (text.length > leftPos) {
                  ranges2.push(new Range(Pos(line, leftPos), Pos(line, findColumn(text, right, tabSize))));
                }
              }
              if (!ranges2.length) {
                ranges2.push(new Range(start, start));
              }
              setSelection(
                doc,
                normalizeSelection(cm, startSel.ranges.slice(0, ourIndex).concat(ranges2), ourIndex),
                { origin: "*mouse", scroll: false }
              );
              cm.scrollIntoView(pos);
            } else {
              var oldRange = ourRange;
              var range3 = rangeForUnit(cm, pos, behavior.unit);
              var anchor = oldRange.anchor, head;
              if (cmp(range3.anchor, anchor) > 0) {
                head = range3.head;
                anchor = minPos(oldRange.from(), range3.anchor);
              } else {
                head = range3.anchor;
                anchor = maxPos(oldRange.to(), range3.head);
              }
              var ranges$1 = startSel.ranges.slice(0);
              ranges$1[ourIndex] = bidiSimplify(cm, new Range(clipPos(doc, anchor), head));
              setSelection(doc, normalizeSelection(cm, ranges$1, ourIndex), sel_mouse);
            }
          }
          var editorSize = display.wrapper.getBoundingClientRect();
          var counter = 0;
          function extend(e) {
            var curCount = ++counter;
            var cur = posFromMouse(cm, e, true, behavior.unit == "rectangle");
            if (!cur) {
              return;
            }
            if (cmp(cur, lastPos) != 0) {
              cm.curOp.focus = activeElt();
              extendTo(cur);
              var visible = visibleLines(display, doc);
              if (cur.line >= visible.to || cur.line < visible.from) {
                setTimeout(operation(cm, function() {
                  if (counter == curCount) {
                    extend(e);
                  }
                }), 150);
              }
            } else {
              var outside = e.clientY < editorSize.top ? -20 : e.clientY > editorSize.bottom ? 20 : 0;
              if (outside) {
                setTimeout(operation(cm, function() {
                  if (counter != curCount) {
                    return;
                  }
                  display.scroller.scrollTop += outside;
                  extend(e);
                }), 50);
              }
            }
          }
          function done(e) {
            cm.state.selectingText = false;
            counter = Infinity;
            if (e) {
              e_preventDefault(e);
              display.input.focus();
            }
            off(display.wrapper.ownerDocument, "mousemove", move);
            off(display.wrapper.ownerDocument, "mouseup", up);
            doc.history.lastSelOrigin = null;
          }
          var move = operation(cm, function(e) {
            if (e.buttons === 0 || !e_button(e)) {
              done(e);
            } else {
              extend(e);
            }
          });
          var up = operation(cm, done);
          cm.state.selectingText = up;
          on(display.wrapper.ownerDocument, "mousemove", move);
          on(display.wrapper.ownerDocument, "mouseup", up);
        }
        function bidiSimplify(cm, range2) {
          var anchor = range2.anchor;
          var head = range2.head;
          var anchorLine = getLine(cm.doc, anchor.line);
          if (cmp(anchor, head) == 0 && anchor.sticky == head.sticky) {
            return range2;
          }
          var order = getOrder(anchorLine);
          if (!order) {
            return range2;
          }
          var index2 = getBidiPartAt(order, anchor.ch, anchor.sticky), part = order[index2];
          if (part.from != anchor.ch && part.to != anchor.ch) {
            return range2;
          }
          var boundary = index2 + (part.from == anchor.ch == (part.level != 1) ? 0 : 1);
          if (boundary == 0 || boundary == order.length) {
            return range2;
          }
          var leftSide;
          if (head.line != anchor.line) {
            leftSide = (head.line - anchor.line) * (cm.doc.direction == "ltr" ? 1 : -1) > 0;
          } else {
            var headIndex = getBidiPartAt(order, head.ch, head.sticky);
            var dir = headIndex - index2 || (head.ch - anchor.ch) * (part.level == 1 ? -1 : 1);
            if (headIndex == boundary - 1 || headIndex == boundary) {
              leftSide = dir < 0;
            } else {
              leftSide = dir > 0;
            }
          }
          var usePart = order[boundary + (leftSide ? -1 : 0)];
          var from = leftSide == (usePart.level == 1);
          var ch = from ? usePart.from : usePart.to, sticky = from ? "after" : "before";
          return anchor.ch == ch && anchor.sticky == sticky ? range2 : new Range(new Pos(anchor.line, ch, sticky), head);
        }
        function gutterEvent(cm, e, type2, prevent) {
          var mX, mY;
          if (e.touches) {
            mX = e.touches[0].clientX;
            mY = e.touches[0].clientY;
          } else {
            try {
              mX = e.clientX;
              mY = e.clientY;
            } catch (e$1) {
              return false;
            }
          }
          if (mX >= Math.floor(cm.display.gutters.getBoundingClientRect().right)) {
            return false;
          }
          if (prevent) {
            e_preventDefault(e);
          }
          var display = cm.display;
          var lineBox = display.lineDiv.getBoundingClientRect();
          if (mY > lineBox.bottom || !hasHandler(cm, type2)) {
            return e_defaultPrevented(e);
          }
          mY -= lineBox.top - display.viewOffset;
          for (var i2 = 0; i2 < cm.display.gutterSpecs.length; ++i2) {
            var g = display.gutters.childNodes[i2];
            if (g && g.getBoundingClientRect().right >= mX) {
              var line = lineAtHeight(cm.doc, mY);
              var gutter = cm.display.gutterSpecs[i2];
              signal(cm, type2, cm, line, gutter.className, e);
              return e_defaultPrevented(e);
            }
          }
        }
        function clickInGutter(cm, e) {
          return gutterEvent(cm, e, "gutterClick", true);
        }
        function onContextMenu(cm, e) {
          if (eventInWidget(cm.display, e) || contextMenuInGutter(cm, e)) {
            return;
          }
          if (signalDOMEvent(cm, e, "contextmenu")) {
            return;
          }
          if (!captureRightClick) {
            cm.display.input.onContextMenu(e);
          }
        }
        function contextMenuInGutter(cm, e) {
          if (!hasHandler(cm, "gutterContextMenu")) {
            return false;
          }
          return gutterEvent(cm, e, "gutterContextMenu", false);
        }
        function themeChanged(cm) {
          cm.display.wrapper.className = cm.display.wrapper.className.replace(/\s*cm-s-\S+/g, "") + cm.options.theme.replace(/(^|\s)\s*/g, " cm-s-");
          clearCaches(cm);
        }
        var Init = { toString: function() {
          return "CodeMirror.Init";
        } };
        var defaults = {};
        var optionHandlers = {};
        function defineOptions(CodeMirror3) {
          var optionHandlers2 = CodeMirror3.optionHandlers;
          function option(name, deflt, handle2, notOnInit) {
            CodeMirror3.defaults[name] = deflt;
            if (handle2) {
              optionHandlers2[name] = notOnInit ? function(cm, val, old) {
                if (old != Init) {
                  handle2(cm, val, old);
                }
              } : handle2;
            }
          }
          CodeMirror3.defineOption = option;
          CodeMirror3.Init = Init;
          option("value", "", function(cm, val) {
            return cm.setValue(val);
          }, true);
          option("mode", null, function(cm, val) {
            cm.doc.modeOption = val;
            loadMode(cm);
          }, true);
          option("indentUnit", 2, loadMode, true);
          option("indentWithTabs", false);
          option("smartIndent", true);
          option("tabSize", 4, function(cm) {
            resetModeState(cm);
            clearCaches(cm);
            regChange(cm);
          }, true);
          option("lineSeparator", null, function(cm, val) {
            cm.doc.lineSep = val;
            if (!val) {
              return;
            }
            var newBreaks = [], lineNo2 = cm.doc.first;
            cm.doc.iter(function(line) {
              for (var pos = 0; ; ) {
                var found = line.text.indexOf(val, pos);
                if (found == -1) {
                  break;
                }
                pos = found + val.length;
                newBreaks.push(Pos(lineNo2, found));
              }
              lineNo2++;
            });
            for (var i2 = newBreaks.length - 1; i2 >= 0; i2--) {
              replaceRange(cm.doc, val, newBreaks[i2], Pos(newBreaks[i2].line, newBreaks[i2].ch + val.length));
            }
          });
          option("specialChars", /[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g, function(cm, val, old) {
            cm.state.specialChars = new RegExp(val.source + (val.test("	") ? "" : "|	"), "g");
            if (old != Init) {
              cm.refresh();
            }
          });
          option("specialCharPlaceholder", defaultSpecialCharPlaceholder, function(cm) {
            return cm.refresh();
          }, true);
          option("electricChars", true);
          option("inputStyle", mobile ? "contenteditable" : "textarea", function() {
            throw new Error("inputStyle can not (yet) be changed in a running editor");
          }, true);
          option("spellcheck", false, function(cm, val) {
            return cm.getInputField().spellcheck = val;
          }, true);
          option("autocorrect", false, function(cm, val) {
            return cm.getInputField().autocorrect = val;
          }, true);
          option("autocapitalize", false, function(cm, val) {
            return cm.getInputField().autocapitalize = val;
          }, true);
          option("rtlMoveVisually", !windows);
          option("wholeLineUpdateBefore", true);
          option("theme", "default", function(cm) {
            themeChanged(cm);
            updateGutters(cm);
          }, true);
          option("keyMap", "default", function(cm, val, old) {
            var next = getKeyMap(val);
            var prev = old != Init && getKeyMap(old);
            if (prev && prev.detach) {
              prev.detach(cm, next);
            }
            if (next.attach) {
              next.attach(cm, prev || null);
            }
          });
          option("extraKeys", null);
          option("configureMouse", null);
          option("lineWrapping", false, wrappingChanged, true);
          option("gutters", [], function(cm, val) {
            cm.display.gutterSpecs = getGutters(val, cm.options.lineNumbers);
            updateGutters(cm);
          }, true);
          option("fixedGutter", true, function(cm, val) {
            cm.display.gutters.style.left = val ? compensateForHScroll(cm.display) + "px" : "0";
            cm.refresh();
          }, true);
          option("coverGutterNextToScrollbar", false, function(cm) {
            return updateScrollbars(cm);
          }, true);
          option("scrollbarStyle", "native", function(cm) {
            initScrollbars(cm);
            updateScrollbars(cm);
            cm.display.scrollbars.setScrollTop(cm.doc.scrollTop);
            cm.display.scrollbars.setScrollLeft(cm.doc.scrollLeft);
          }, true);
          option("lineNumbers", false, function(cm, val) {
            cm.display.gutterSpecs = getGutters(cm.options.gutters, val);
            updateGutters(cm);
          }, true);
          option("firstLineNumber", 1, updateGutters, true);
          option("lineNumberFormatter", function(integer) {
            return integer;
          }, updateGutters, true);
          option("showCursorWhenSelecting", false, updateSelection, true);
          option("resetSelectionOnContextMenu", true);
          option("lineWiseCopyCut", true);
          option("pasteLinesPerSelection", true);
          option("selectionsMayTouch", false);
          option("readOnly", false, function(cm, val) {
            if (val == "nocursor") {
              onBlur(cm);
              cm.display.input.blur();
            }
            cm.display.input.readOnlyChanged(val);
          });
          option("screenReaderLabel", null, function(cm, val) {
            val = val === "" ? null : val;
            cm.display.input.screenReaderLabelChanged(val);
          });
          option("disableInput", false, function(cm, val) {
            if (!val) {
              cm.display.input.reset();
            }
          }, true);
          option("dragDrop", true, dragDropChanged);
          option("allowDropFileTypes", null);
          option("cursorBlinkRate", 530);
          option("cursorScrollMargin", 0);
          option("cursorHeight", 1, updateSelection, true);
          option("singleCursorHeightPerLine", true, updateSelection, true);
          option("workTime", 100);
          option("workDelay", 100);
          option("flattenSpans", true, resetModeState, true);
          option("addModeClass", false, resetModeState, true);
          option("pollInterval", 100);
          option("undoDepth", 200, function(cm, val) {
            return cm.doc.history.undoDepth = val;
          });
          option("historyEventDelay", 1250);
          option("viewportMargin", 10, function(cm) {
            return cm.refresh();
          }, true);
          option("maxHighlightLength", 1e4, resetModeState, true);
          option("moveInputWithCursor", true, function(cm, val) {
            if (!val) {
              cm.display.input.resetPosition();
            }
          });
          option("tabindex", null, function(cm, val) {
            return cm.display.input.getField().tabIndex = val || "";
          });
          option("autofocus", null);
          option("direction", "ltr", function(cm, val) {
            return cm.doc.setDirection(val);
          }, true);
          option("phrases", null);
        }
        function dragDropChanged(cm, value, old) {
          var wasOn = old && old != Init;
          if (!value != !wasOn) {
            var funcs = cm.display.dragFunctions;
            var toggle = value ? on : off;
            toggle(cm.display.scroller, "dragstart", funcs.start);
            toggle(cm.display.scroller, "dragenter", funcs.enter);
            toggle(cm.display.scroller, "dragover", funcs.over);
            toggle(cm.display.scroller, "dragleave", funcs.leave);
            toggle(cm.display.scroller, "drop", funcs.drop);
          }
        }
        function wrappingChanged(cm) {
          if (cm.options.lineWrapping) {
            addClass(cm.display.wrapper, "CodeMirror-wrap");
            cm.display.sizer.style.minWidth = "";
            cm.display.sizerWidth = null;
          } else {
            rmClass(cm.display.wrapper, "CodeMirror-wrap");
            findMaxLine(cm);
          }
          estimateLineHeights(cm);
          regChange(cm);
          clearCaches(cm);
          setTimeout(function() {
            return updateScrollbars(cm);
          }, 100);
        }
        function CodeMirror2(place, options) {
          var this$1 = this;
          if (!(this instanceof CodeMirror2)) {
            return new CodeMirror2(place, options);
          }
          this.options = options = options ? copyObj(options) : {};
          copyObj(defaults, options, false);
          var doc = options.value;
          if (typeof doc == "string") {
            doc = new Doc(doc, options.mode, null, options.lineSeparator, options.direction);
          } else if (options.mode) {
            doc.modeOption = options.mode;
          }
          this.doc = doc;
          var input = new CodeMirror2.inputStyles[options.inputStyle](this);
          var display = this.display = new Display(place, doc, input, options);
          display.wrapper.CodeMirror = this;
          themeChanged(this);
          if (options.lineWrapping) {
            this.display.wrapper.className += " CodeMirror-wrap";
          }
          initScrollbars(this);
          this.state = {
            keyMaps: [],
            // stores maps added by addKeyMap
            overlays: [],
            // highlighting overlays, as added by addOverlay
            modeGen: 0,
            // bumped when mode/overlay changes, used to invalidate highlighting info
            overwrite: false,
            delayingBlurEvent: false,
            focused: false,
            suppressEdits: false,
            // used to disable editing during key handlers when in readOnly mode
            pasteIncoming: -1,
            cutIncoming: -1,
            // help recognize paste/cut edits in input.poll
            selectingText: false,
            draggingText: false,
            highlight: new Delayed(),
            // stores highlight worker timeout
            keySeq: null,
            // Unfinished key sequence
            specialChars: null
          };
          if (options.autofocus && !mobile) {
            display.input.focus();
          }
          if (ie && ie_version < 11) {
            setTimeout(function() {
              return this$1.display.input.reset(true);
            }, 20);
          }
          registerEventHandlers(this);
          ensureGlobalHandlers();
          startOperation(this);
          this.curOp.forceUpdate = true;
          attachDoc(this, doc);
          if (options.autofocus && !mobile || this.hasFocus()) {
            setTimeout(function() {
              if (this$1.hasFocus() && !this$1.state.focused) {
                onFocus(this$1);
              }
            }, 20);
          } else {
            onBlur(this);
          }
          for (var opt in optionHandlers) {
            if (optionHandlers.hasOwnProperty(opt)) {
              optionHandlers[opt](this, options[opt], Init);
            }
          }
          maybeUpdateLineNumberWidth(this);
          if (options.finishInit) {
            options.finishInit(this);
          }
          for (var i2 = 0; i2 < initHooks.length; ++i2) {
            initHooks[i2](this);
          }
          endOperation(this);
          if (webkit && options.lineWrapping && getComputedStyle(display.lineDiv).textRendering == "optimizelegibility") {
            display.lineDiv.style.textRendering = "auto";
          }
        }
        CodeMirror2.defaults = defaults;
        CodeMirror2.optionHandlers = optionHandlers;
        function registerEventHandlers(cm) {
          var d = cm.display;
          on(d.scroller, "mousedown", operation(cm, onMouseDown));
          if (ie && ie_version < 11) {
            on(d.scroller, "dblclick", operation(cm, function(e) {
              if (signalDOMEvent(cm, e)) {
                return;
              }
              var pos = posFromMouse(cm, e);
              if (!pos || clickInGutter(cm, e) || eventInWidget(cm.display, e)) {
                return;
              }
              e_preventDefault(e);
              var word = cm.findWordAt(pos);
              extendSelection(cm.doc, word.anchor, word.head);
            }));
          } else {
            on(d.scroller, "dblclick", function(e) {
              return signalDOMEvent(cm, e) || e_preventDefault(e);
            });
          }
          on(d.scroller, "contextmenu", function(e) {
            return onContextMenu(cm, e);
          });
          on(d.input.getField(), "contextmenu", function(e) {
            if (!d.scroller.contains(e.target)) {
              onContextMenu(cm, e);
            }
          });
          var touchFinished, prevTouch = { end: 0 };
          function finishTouch() {
            if (d.activeTouch) {
              touchFinished = setTimeout(function() {
                return d.activeTouch = null;
              }, 1e3);
              prevTouch = d.activeTouch;
              prevTouch.end = +/* @__PURE__ */ new Date();
            }
          }
          function isMouseLikeTouchEvent(e) {
            if (e.touches.length != 1) {
              return false;
            }
            var touch = e.touches[0];
            return touch.radiusX <= 1 && touch.radiusY <= 1;
          }
          function farAway(touch, other) {
            if (other.left == null) {
              return true;
            }
            var dx = other.left - touch.left, dy = other.top - touch.top;
            return dx * dx + dy * dy > 20 * 20;
          }
          on(d.scroller, "touchstart", function(e) {
            if (!signalDOMEvent(cm, e) && !isMouseLikeTouchEvent(e) && !clickInGutter(cm, e)) {
              d.input.ensurePolled();
              clearTimeout(touchFinished);
              var now = +/* @__PURE__ */ new Date();
              d.activeTouch = {
                start: now,
                moved: false,
                prev: now - prevTouch.end <= 300 ? prevTouch : null
              };
              if (e.touches.length == 1) {
                d.activeTouch.left = e.touches[0].pageX;
                d.activeTouch.top = e.touches[0].pageY;
              }
            }
          });
          on(d.scroller, "touchmove", function() {
            if (d.activeTouch) {
              d.activeTouch.moved = true;
            }
          });
          on(d.scroller, "touchend", function(e) {
            var touch = d.activeTouch;
            if (touch && !eventInWidget(d, e) && touch.left != null && !touch.moved && /* @__PURE__ */ new Date() - touch.start < 300) {
              var pos = cm.coordsChar(d.activeTouch, "page"), range2;
              if (!touch.prev || farAway(touch, touch.prev)) {
                range2 = new Range(pos, pos);
              } else if (!touch.prev.prev || farAway(touch, touch.prev.prev)) {
                range2 = cm.findWordAt(pos);
              } else {
                range2 = new Range(Pos(pos.line, 0), clipPos(cm.doc, Pos(pos.line + 1, 0)));
              }
              cm.setSelection(range2.anchor, range2.head);
              cm.focus();
              e_preventDefault(e);
            }
            finishTouch();
          });
          on(d.scroller, "touchcancel", finishTouch);
          on(d.scroller, "scroll", function() {
            if (d.scroller.clientHeight) {
              updateScrollTop(cm, d.scroller.scrollTop);
              setScrollLeft(cm, d.scroller.scrollLeft, true);
              signal(cm, "scroll", cm);
            }
          });
          on(d.scroller, "mousewheel", function(e) {
            return onScrollWheel(cm, e);
          });
          on(d.scroller, "DOMMouseScroll", function(e) {
            return onScrollWheel(cm, e);
          });
          on(d.wrapper, "scroll", function() {
            return d.wrapper.scrollTop = d.wrapper.scrollLeft = 0;
          });
          d.dragFunctions = {
            enter: function(e) {
              if (!signalDOMEvent(cm, e)) {
                e_stop(e);
              }
            },
            over: function(e) {
              if (!signalDOMEvent(cm, e)) {
                onDragOver(cm, e);
                e_stop(e);
              }
            },
            start: function(e) {
              return onDragStart(cm, e);
            },
            drop: operation(cm, onDrop),
            leave: function(e) {
              if (!signalDOMEvent(cm, e)) {
                clearDragCursor(cm);
              }
            }
          };
          var inp = d.input.getField();
          on(inp, "keyup", function(e) {
            return onKeyUp.call(cm, e);
          });
          on(inp, "keydown", operation(cm, onKeyDown));
          on(inp, "keypress", operation(cm, onKeyPress));
          on(inp, "focus", function(e) {
            return onFocus(cm, e);
          });
          on(inp, "blur", function(e) {
            return onBlur(cm, e);
          });
        }
        var initHooks = [];
        CodeMirror2.defineInitHook = function(f) {
          return initHooks.push(f);
        };
        function indentLine(cm, n, how, aggressive) {
          var doc = cm.doc, state;
          if (how == null) {
            how = "add";
          }
          if (how == "smart") {
            if (!doc.mode.indent) {
              how = "prev";
            } else {
              state = getContextBefore(cm, n).state;
            }
          }
          var tabSize = cm.options.tabSize;
          var line = getLine(doc, n), curSpace = countColumn(line.text, null, tabSize);
          if (line.stateAfter) {
            line.stateAfter = null;
          }
          var curSpaceString = line.text.match(/^\s*/)[0], indentation;
          if (!aggressive && !/\S/.test(line.text)) {
            indentation = 0;
            how = "not";
          } else if (how == "smart") {
            indentation = doc.mode.indent(state, line.text.slice(curSpaceString.length), line.text);
            if (indentation == Pass || indentation > 150) {
              if (!aggressive) {
                return;
              }
              how = "prev";
            }
          }
          if (how == "prev") {
            if (n > doc.first) {
              indentation = countColumn(getLine(doc, n - 1).text, null, tabSize);
            } else {
              indentation = 0;
            }
          } else if (how == "add") {
            indentation = curSpace + cm.options.indentUnit;
          } else if (how == "subtract") {
            indentation = curSpace - cm.options.indentUnit;
          } else if (typeof how == "number") {
            indentation = curSpace + how;
          }
          indentation = Math.max(0, indentation);
          var indentString = "", pos = 0;
          if (cm.options.indentWithTabs) {
            for (var i2 = Math.floor(indentation / tabSize); i2; --i2) {
              pos += tabSize;
              indentString += "	";
            }
          }
          if (pos < indentation) {
            indentString += spaceStr(indentation - pos);
          }
          if (indentString != curSpaceString) {
            replaceRange(doc, indentString, Pos(n, 0), Pos(n, curSpaceString.length), "+input");
            line.stateAfter = null;
            return true;
          } else {
            for (var i$12 = 0; i$12 < doc.sel.ranges.length; i$12++) {
              var range2 = doc.sel.ranges[i$12];
              if (range2.head.line == n && range2.head.ch < curSpaceString.length) {
                var pos$1 = Pos(n, curSpaceString.length);
                replaceOneSelection(doc, i$12, new Range(pos$1, pos$1));
                break;
              }
            }
          }
        }
        var lastCopied = null;
        function setLastCopied(newLastCopied) {
          lastCopied = newLastCopied;
        }
        function applyTextInput(cm, inserted, deleted, sel, origin) {
          var doc = cm.doc;
          cm.display.shift = false;
          if (!sel) {
            sel = doc.sel;
          }
          var recent = +/* @__PURE__ */ new Date() - 200;
          var paste = origin == "paste" || cm.state.pasteIncoming > recent;
          var textLines = splitLinesAuto(inserted), multiPaste = null;
          if (paste && sel.ranges.length > 1) {
            if (lastCopied && lastCopied.text.join("\n") == inserted) {
              if (sel.ranges.length % lastCopied.text.length == 0) {
                multiPaste = [];
                for (var i2 = 0; i2 < lastCopied.text.length; i2++) {
                  multiPaste.push(doc.splitLines(lastCopied.text[i2]));
                }
              }
            } else if (textLines.length == sel.ranges.length && cm.options.pasteLinesPerSelection) {
              multiPaste = map(textLines, function(l) {
                return [l];
              });
            }
          }
          var updateInput = cm.curOp.updateInput;
          for (var i$12 = sel.ranges.length - 1; i$12 >= 0; i$12--) {
            var range2 = sel.ranges[i$12];
            var from = range2.from(), to = range2.to();
            if (range2.empty()) {
              if (deleted && deleted > 0) {
                from = Pos(from.line, from.ch - deleted);
              } else if (cm.state.overwrite && !paste) {
                to = Pos(to.line, Math.min(getLine(doc, to.line).text.length, to.ch + lst(textLines).length));
              } else if (paste && lastCopied && lastCopied.lineWise && lastCopied.text.join("\n") == textLines.join("\n")) {
                from = to = Pos(from.line, 0);
              }
            }
            var changeEvent = {
              from,
              to,
              text: multiPaste ? multiPaste[i$12 % multiPaste.length] : textLines,
              origin: origin || (paste ? "paste" : cm.state.cutIncoming > recent ? "cut" : "+input")
            };
            makeChange(cm.doc, changeEvent);
            signalLater(cm, "inputRead", cm, changeEvent);
          }
          if (inserted && !paste) {
            triggerElectric(cm, inserted);
          }
          ensureCursorVisible(cm);
          if (cm.curOp.updateInput < 2) {
            cm.curOp.updateInput = updateInput;
          }
          cm.curOp.typing = true;
          cm.state.pasteIncoming = cm.state.cutIncoming = -1;
        }
        function handlePaste(e, cm) {
          var pasted = e.clipboardData && e.clipboardData.getData("Text");
          if (pasted) {
            e.preventDefault();
            if (!cm.isReadOnly() && !cm.options.disableInput) {
              runInOp(cm, function() {
                return applyTextInput(cm, pasted, 0, null, "paste");
              });
            }
            return true;
          }
        }
        function triggerElectric(cm, inserted) {
          if (!cm.options.electricChars || !cm.options.smartIndent) {
            return;
          }
          var sel = cm.doc.sel;
          for (var i2 = sel.ranges.length - 1; i2 >= 0; i2--) {
            var range2 = sel.ranges[i2];
            if (range2.head.ch > 100 || i2 && sel.ranges[i2 - 1].head.line == range2.head.line) {
              continue;
            }
            var mode = cm.getModeAt(range2.head);
            var indented = false;
            if (mode.electricChars) {
              for (var j = 0; j < mode.electricChars.length; j++) {
                if (inserted.indexOf(mode.electricChars.charAt(j)) > -1) {
                  indented = indentLine(cm, range2.head.line, "smart");
                  break;
                }
              }
            } else if (mode.electricInput) {
              if (mode.electricInput.test(getLine(cm.doc, range2.head.line).text.slice(0, range2.head.ch))) {
                indented = indentLine(cm, range2.head.line, "smart");
              }
            }
            if (indented) {
              signalLater(cm, "electricInput", cm, range2.head.line);
            }
          }
        }
        function copyableRanges(cm) {
          var text = [], ranges = [];
          for (var i2 = 0; i2 < cm.doc.sel.ranges.length; i2++) {
            var line = cm.doc.sel.ranges[i2].head.line;
            var lineRange = { anchor: Pos(line, 0), head: Pos(line + 1, 0) };
            ranges.push(lineRange);
            text.push(cm.getRange(lineRange.anchor, lineRange.head));
          }
          return { text, ranges };
        }
        function disableBrowserMagic(field, spellcheck, autocorrect, autocapitalize) {
          field.setAttribute("autocorrect", autocorrect ? "" : "off");
          field.setAttribute("autocapitalize", autocapitalize ? "" : "off");
          field.setAttribute("spellcheck", !!spellcheck);
        }
        function hiddenTextarea() {
          var te = elt("textarea", null, null, "position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none");
          var div = elt("div", [te], null, "overflow: hidden; position: relative; width: 3px; height: 0px;");
          if (webkit) {
            te.style.width = "1000px";
          } else {
            te.setAttribute("wrap", "off");
          }
          if (ios) {
            te.style.border = "1px solid black";
          }
          disableBrowserMagic(te);
          return div;
        }
        function addEditorMethods(CodeMirror3) {
          var optionHandlers2 = CodeMirror3.optionHandlers;
          var helpers = CodeMirror3.helpers = {};
          CodeMirror3.prototype = {
            constructor: CodeMirror3,
            focus: function() {
              window.focus();
              this.display.input.focus();
            },
            setOption: function(option, value) {
              var options = this.options, old = options[option];
              if (options[option] == value && option != "mode") {
                return;
              }
              options[option] = value;
              if (optionHandlers2.hasOwnProperty(option)) {
                operation(this, optionHandlers2[option])(this, value, old);
              }
              signal(this, "optionChange", this, option);
            },
            getOption: function(option) {
              return this.options[option];
            },
            getDoc: function() {
              return this.doc;
            },
            addKeyMap: function(map2, bottom) {
              this.state.keyMaps[bottom ? "push" : "unshift"](getKeyMap(map2));
            },
            removeKeyMap: function(map2) {
              var maps = this.state.keyMaps;
              for (var i2 = 0; i2 < maps.length; ++i2) {
                if (maps[i2] == map2 || maps[i2].name == map2) {
                  maps.splice(i2, 1);
                  return true;
                }
              }
            },
            addOverlay: methodOp(function(spec, options) {
              var mode = spec.token ? spec : CodeMirror3.getMode(this.options, spec);
              if (mode.startState) {
                throw new Error("Overlays may not be stateful.");
              }
              insertSorted(
                this.state.overlays,
                {
                  mode,
                  modeSpec: spec,
                  opaque: options && options.opaque,
                  priority: options && options.priority || 0
                },
                function(overlay) {
                  return overlay.priority;
                }
              );
              this.state.modeGen++;
              regChange(this);
            }),
            removeOverlay: methodOp(function(spec) {
              var overlays = this.state.overlays;
              for (var i2 = 0; i2 < overlays.length; ++i2) {
                var cur = overlays[i2].modeSpec;
                if (cur == spec || typeof spec == "string" && cur.name == spec) {
                  overlays.splice(i2, 1);
                  this.state.modeGen++;
                  regChange(this);
                  return;
                }
              }
            }),
            indentLine: methodOp(function(n, dir, aggressive) {
              if (typeof dir != "string" && typeof dir != "number") {
                if (dir == null) {
                  dir = this.options.smartIndent ? "smart" : "prev";
                } else {
                  dir = dir ? "add" : "subtract";
                }
              }
              if (isLine(this.doc, n)) {
                indentLine(this, n, dir, aggressive);
              }
            }),
            indentSelection: methodOp(function(how) {
              var ranges = this.doc.sel.ranges, end = -1;
              for (var i2 = 0; i2 < ranges.length; i2++) {
                var range2 = ranges[i2];
                if (!range2.empty()) {
                  var from = range2.from(), to = range2.to();
                  var start = Math.max(end, from.line);
                  end = Math.min(this.lastLine(), to.line - (to.ch ? 0 : 1)) + 1;
                  for (var j = start; j < end; ++j) {
                    indentLine(this, j, how);
                  }
                  var newRanges = this.doc.sel.ranges;
                  if (from.ch == 0 && ranges.length == newRanges.length && newRanges[i2].from().ch > 0) {
                    replaceOneSelection(this.doc, i2, new Range(from, newRanges[i2].to()), sel_dontScroll);
                  }
                } else if (range2.head.line > end) {
                  indentLine(this, range2.head.line, how, true);
                  end = range2.head.line;
                  if (i2 == this.doc.sel.primIndex) {
                    ensureCursorVisible(this);
                  }
                }
              }
            }),
            // Fetch the parser token for a given character. Useful for hacks
            // that want to inspect the mode state (say, for completion).
            getTokenAt: function(pos, precise) {
              return takeToken(this, pos, precise);
            },
            getLineTokens: function(line, precise) {
              return takeToken(this, Pos(line), precise, true);
            },
            getTokenTypeAt: function(pos) {
              pos = clipPos(this.doc, pos);
              var styles = getLineStyles(this, getLine(this.doc, pos.line));
              var before = 0, after = (styles.length - 1) / 2, ch = pos.ch;
              var type2;
              if (ch == 0) {
                type2 = styles[2];
              } else {
                for (; ; ) {
                  var mid = before + after >> 1;
                  if ((mid ? styles[mid * 2 - 1] : 0) >= ch) {
                    after = mid;
                  } else if (styles[mid * 2 + 1] < ch) {
                    before = mid + 1;
                  } else {
                    type2 = styles[mid * 2 + 2];
                    break;
                  }
                }
              }
              var cut = type2 ? type2.indexOf("overlay ") : -1;
              return cut < 0 ? type2 : cut == 0 ? null : type2.slice(0, cut - 1);
            },
            getModeAt: function(pos) {
              var mode = this.doc.mode;
              if (!mode.innerMode) {
                return mode;
              }
              return CodeMirror3.innerMode(mode, this.getTokenAt(pos).state).mode;
            },
            getHelper: function(pos, type2) {
              return this.getHelpers(pos, type2)[0];
            },
            getHelpers: function(pos, type2) {
              var found = [];
              if (!helpers.hasOwnProperty(type2)) {
                return found;
              }
              var help = helpers[type2], mode = this.getModeAt(pos);
              if (typeof mode[type2] == "string") {
                if (help[mode[type2]]) {
                  found.push(help[mode[type2]]);
                }
              } else if (mode[type2]) {
                for (var i2 = 0; i2 < mode[type2].length; i2++) {
                  var val = help[mode[type2][i2]];
                  if (val) {
                    found.push(val);
                  }
                }
              } else if (mode.helperType && help[mode.helperType]) {
                found.push(help[mode.helperType]);
              } else if (help[mode.name]) {
                found.push(help[mode.name]);
              }
              for (var i$12 = 0; i$12 < help._global.length; i$12++) {
                var cur = help._global[i$12];
                if (cur.pred(mode, this) && indexOf(found, cur.val) == -1) {
                  found.push(cur.val);
                }
              }
              return found;
            },
            getStateAfter: function(line, precise) {
              var doc = this.doc;
              line = clipLine(doc, line == null ? doc.first + doc.size - 1 : line);
              return getContextBefore(this, line + 1, precise).state;
            },
            cursorCoords: function(start, mode) {
              var pos, range2 = this.doc.sel.primary();
              if (start == null) {
                pos = range2.head;
              } else if (typeof start == "object") {
                pos = clipPos(this.doc, start);
              } else {
                pos = start ? range2.from() : range2.to();
              }
              return cursorCoords(this, pos, mode || "page");
            },
            charCoords: function(pos, mode) {
              return charCoords(this, clipPos(this.doc, pos), mode || "page");
            },
            coordsChar: function(coords, mode) {
              coords = fromCoordSystem(this, coords, mode || "page");
              return coordsChar(this, coords.left, coords.top);
            },
            lineAtHeight: function(height, mode) {
              height = fromCoordSystem(this, { top: height, left: 0 }, mode || "page").top;
              return lineAtHeight(this.doc, height + this.display.viewOffset);
            },
            heightAtLine: function(line, mode, includeWidgets) {
              var end = false, lineObj;
              if (typeof line == "number") {
                var last = this.doc.first + this.doc.size - 1;
                if (line < this.doc.first) {
                  line = this.doc.first;
                } else if (line > last) {
                  line = last;
                  end = true;
                }
                lineObj = getLine(this.doc, line);
              } else {
                lineObj = line;
              }
              return intoCoordSystem(this, lineObj, { top: 0, left: 0 }, mode || "page", includeWidgets || end).top + (end ? this.doc.height - heightAtLine(lineObj) : 0);
            },
            defaultTextHeight: function() {
              return textHeight(this.display);
            },
            defaultCharWidth: function() {
              return charWidth(this.display);
            },
            getViewport: function() {
              return { from: this.display.viewFrom, to: this.display.viewTo };
            },
            addWidget: function(pos, node, scroll, vert, horiz) {
              var display = this.display;
              pos = cursorCoords(this, clipPos(this.doc, pos));
              var top = pos.bottom, left = pos.left;
              node.style.position = "absolute";
              node.setAttribute("cm-ignore-events", "true");
              this.display.input.setUneditable(node);
              display.sizer.appendChild(node);
              if (vert == "over") {
                top = pos.top;
              } else if (vert == "above" || vert == "near") {
                var vspace = Math.max(display.wrapper.clientHeight, this.doc.height), hspace = Math.max(display.sizer.clientWidth, display.lineSpace.clientWidth);
                if ((vert == "above" || pos.bottom + node.offsetHeight > vspace) && pos.top > node.offsetHeight) {
                  top = pos.top - node.offsetHeight;
                } else if (pos.bottom + node.offsetHeight <= vspace) {
                  top = pos.bottom;
                }
                if (left + node.offsetWidth > hspace) {
                  left = hspace - node.offsetWidth;
                }
              }
              node.style.top = top + "px";
              node.style.left = node.style.right = "";
              if (horiz == "right") {
                left = display.sizer.clientWidth - node.offsetWidth;
                node.style.right = "0px";
              } else {
                if (horiz == "left") {
                  left = 0;
                } else if (horiz == "middle") {
                  left = (display.sizer.clientWidth - node.offsetWidth) / 2;
                }
                node.style.left = left + "px";
              }
              if (scroll) {
                scrollIntoView(this, { left, top, right: left + node.offsetWidth, bottom: top + node.offsetHeight });
              }
            },
            triggerOnKeyDown: methodOp(onKeyDown),
            triggerOnKeyPress: methodOp(onKeyPress),
            triggerOnKeyUp: onKeyUp,
            triggerOnMouseDown: methodOp(onMouseDown),
            execCommand: function(cmd) {
              if (commands2.hasOwnProperty(cmd)) {
                return commands2[cmd].call(null, this);
              }
            },
            triggerElectric: methodOp(function(text) {
              triggerElectric(this, text);
            }),
            findPosH: function(from, amount, unit, visually) {
              var dir = 1;
              if (amount < 0) {
                dir = -1;
                amount = -amount;
              }
              var cur = clipPos(this.doc, from);
              for (var i2 = 0; i2 < amount; ++i2) {
                cur = findPosH(this.doc, cur, dir, unit, visually);
                if (cur.hitSide) {
                  break;
                }
              }
              return cur;
            },
            moveH: methodOp(function(dir, unit) {
              var this$1 = this;
              this.extendSelectionsBy(function(range2) {
                if (this$1.display.shift || this$1.doc.extend || range2.empty()) {
                  return findPosH(this$1.doc, range2.head, dir, unit, this$1.options.rtlMoveVisually);
                } else {
                  return dir < 0 ? range2.from() : range2.to();
                }
              }, sel_move);
            }),
            deleteH: methodOp(function(dir, unit) {
              var sel = this.doc.sel, doc = this.doc;
              if (sel.somethingSelected()) {
                doc.replaceSelection("", null, "+delete");
              } else {
                deleteNearSelection(this, function(range2) {
                  var other = findPosH(doc, range2.head, dir, unit, false);
                  return dir < 0 ? { from: other, to: range2.head } : { from: range2.head, to: other };
                });
              }
            }),
            findPosV: function(from, amount, unit, goalColumn) {
              var dir = 1, x = goalColumn;
              if (amount < 0) {
                dir = -1;
                amount = -amount;
              }
              var cur = clipPos(this.doc, from);
              for (var i2 = 0; i2 < amount; ++i2) {
                var coords = cursorCoords(this, cur, "div");
                if (x == null) {
                  x = coords.left;
                } else {
                  coords.left = x;
                }
                cur = findPosV(this, coords, dir, unit);
                if (cur.hitSide) {
                  break;
                }
              }
              return cur;
            },
            moveV: methodOp(function(dir, unit) {
              var this$1 = this;
              var doc = this.doc, goals = [];
              var collapse = !this.display.shift && !doc.extend && doc.sel.somethingSelected();
              doc.extendSelectionsBy(function(range2) {
                if (collapse) {
                  return dir < 0 ? range2.from() : range2.to();
                }
                var headPos = cursorCoords(this$1, range2.head, "div");
                if (range2.goalColumn != null) {
                  headPos.left = range2.goalColumn;
                }
                goals.push(headPos.left);
                var pos = findPosV(this$1, headPos, dir, unit);
                if (unit == "page" && range2 == doc.sel.primary()) {
                  addToScrollTop(this$1, charCoords(this$1, pos, "div").top - headPos.top);
                }
                return pos;
              }, sel_move);
              if (goals.length) {
                for (var i2 = 0; i2 < doc.sel.ranges.length; i2++) {
                  doc.sel.ranges[i2].goalColumn = goals[i2];
                }
              }
            }),
            // Find the word at the given position (as returned by coordsChar).
            findWordAt: function(pos) {
              var doc = this.doc, line = getLine(doc, pos.line).text;
              var start = pos.ch, end = pos.ch;
              if (line) {
                var helper = this.getHelper(pos, "wordChars");
                if ((pos.sticky == "before" || end == line.length) && start) {
                  --start;
                } else {
                  ++end;
                }
                var startChar = line.charAt(start);
                var check = isWordChar(startChar, helper) ? function(ch) {
                  return isWordChar(ch, helper);
                } : /\s/.test(startChar) ? function(ch) {
                  return /\s/.test(ch);
                } : function(ch) {
                  return !/\s/.test(ch) && !isWordChar(ch);
                };
                while (start > 0 && check(line.charAt(start - 1))) {
                  --start;
                }
                while (end < line.length && check(line.charAt(end))) {
                  ++end;
                }
              }
              return new Range(Pos(pos.line, start), Pos(pos.line, end));
            },
            toggleOverwrite: function(value) {
              if (value != null && value == this.state.overwrite) {
                return;
              }
              if (this.state.overwrite = !this.state.overwrite) {
                addClass(this.display.cursorDiv, "CodeMirror-overwrite");
              } else {
                rmClass(this.display.cursorDiv, "CodeMirror-overwrite");
              }
              signal(this, "overwriteToggle", this, this.state.overwrite);
            },
            hasFocus: function() {
              return this.display.input.getField() == activeElt();
            },
            isReadOnly: function() {
              return !!(this.options.readOnly || this.doc.cantEdit);
            },
            scrollTo: methodOp(function(x, y) {
              scrollToCoords(this, x, y);
            }),
            getScrollInfo: function() {
              var scroller = this.display.scroller;
              return {
                left: scroller.scrollLeft,
                top: scroller.scrollTop,
                height: scroller.scrollHeight - scrollGap(this) - this.display.barHeight,
                width: scroller.scrollWidth - scrollGap(this) - this.display.barWidth,
                clientHeight: displayHeight(this),
                clientWidth: displayWidth(this)
              };
            },
            scrollIntoView: methodOp(function(range2, margin) {
              if (range2 == null) {
                range2 = { from: this.doc.sel.primary().head, to: null };
                if (margin == null) {
                  margin = this.options.cursorScrollMargin;
                }
              } else if (typeof range2 == "number") {
                range2 = { from: Pos(range2, 0), to: null };
              } else if (range2.from == null) {
                range2 = { from: range2, to: null };
              }
              if (!range2.to) {
                range2.to = range2.from;
              }
              range2.margin = margin || 0;
              if (range2.from.line != null) {
                scrollToRange(this, range2);
              } else {
                scrollToCoordsRange(this, range2.from, range2.to, range2.margin);
              }
            }),
            setSize: methodOp(function(width, height) {
              var this$1 = this;
              var interpret = function(val) {
                return typeof val == "number" || /^\d+$/.test(String(val)) ? val + "px" : val;
              };
              if (width != null) {
                this.display.wrapper.style.width = interpret(width);
              }
              if (height != null) {
                this.display.wrapper.style.height = interpret(height);
              }
              if (this.options.lineWrapping) {
                clearLineMeasurementCache(this);
              }
              var lineNo2 = this.display.viewFrom;
              this.doc.iter(lineNo2, this.display.viewTo, function(line) {
                if (line.widgets) {
                  for (var i2 = 0; i2 < line.widgets.length; i2++) {
                    if (line.widgets[i2].noHScroll) {
                      regLineChange(this$1, lineNo2, "widget");
                      break;
                    }
                  }
                }
                ++lineNo2;
              });
              this.curOp.forceUpdate = true;
              signal(this, "refresh", this);
            }),
            operation: function(f) {
              return runInOp(this, f);
            },
            startOperation: function() {
              return startOperation(this);
            },
            endOperation: function() {
              return endOperation(this);
            },
            refresh: methodOp(function() {
              var oldHeight = this.display.cachedTextHeight;
              regChange(this);
              this.curOp.forceUpdate = true;
              clearCaches(this);
              scrollToCoords(this, this.doc.scrollLeft, this.doc.scrollTop);
              updateGutterSpace(this.display);
              if (oldHeight == null || Math.abs(oldHeight - textHeight(this.display)) > 0.5 || this.options.lineWrapping) {
                estimateLineHeights(this);
              }
              signal(this, "refresh", this);
            }),
            swapDoc: methodOp(function(doc) {
              var old = this.doc;
              old.cm = null;
              if (this.state.selectingText) {
                this.state.selectingText();
              }
              attachDoc(this, doc);
              clearCaches(this);
              this.display.input.reset();
              scrollToCoords(this, doc.scrollLeft, doc.scrollTop);
              this.curOp.forceScroll = true;
              signalLater(this, "swapDoc", this, old);
              return old;
            }),
            phrase: function(phraseText) {
              var phrases = this.options.phrases;
              return phrases && Object.prototype.hasOwnProperty.call(phrases, phraseText) ? phrases[phraseText] : phraseText;
            },
            getInputField: function() {
              return this.display.input.getField();
            },
            getWrapperElement: function() {
              return this.display.wrapper;
            },
            getScrollerElement: function() {
              return this.display.scroller;
            },
            getGutterElement: function() {
              return this.display.gutters;
            }
          };
          eventMixin(CodeMirror3);
          CodeMirror3.registerHelper = function(type2, name, value) {
            if (!helpers.hasOwnProperty(type2)) {
              helpers[type2] = CodeMirror3[type2] = { _global: [] };
            }
            helpers[type2][name] = value;
          };
          CodeMirror3.registerGlobalHelper = function(type2, name, predicate, value) {
            CodeMirror3.registerHelper(type2, name, value);
            helpers[type2]._global.push({ pred: predicate, val: value });
          };
        }
        function findPosH(doc, pos, dir, unit, visually) {
          var oldPos = pos;
          var origDir = dir;
          var lineObj = getLine(doc, pos.line);
          var lineDir = visually && doc.direction == "rtl" ? -dir : dir;
          function findNextLine() {
            var l = pos.line + lineDir;
            if (l < doc.first || l >= doc.first + doc.size) {
              return false;
            }
            pos = new Pos(l, pos.ch, pos.sticky);
            return lineObj = getLine(doc, l);
          }
          function moveOnce(boundToLine) {
            var next;
            if (unit == "codepoint") {
              var ch = lineObj.text.charCodeAt(pos.ch + (dir > 0 ? 0 : -1));
              if (isNaN(ch)) {
                next = null;
              } else {
                var astral = dir > 0 ? ch >= 55296 && ch < 56320 : ch >= 56320 && ch < 57343;
                next = new Pos(pos.line, Math.max(0, Math.min(lineObj.text.length, pos.ch + dir * (astral ? 2 : 1))), -dir);
              }
            } else if (visually) {
              next = moveVisually(doc.cm, lineObj, pos, dir);
            } else {
              next = moveLogically(lineObj, pos, dir);
            }
            if (next == null) {
              if (!boundToLine && findNextLine()) {
                pos = endOfLine(visually, doc.cm, lineObj, pos.line, lineDir);
              } else {
                return false;
              }
            } else {
              pos = next;
            }
            return true;
          }
          if (unit == "char" || unit == "codepoint") {
            moveOnce();
          } else if (unit == "column") {
            moveOnce(true);
          } else if (unit == "word" || unit == "group") {
            var sawType = null, group = unit == "group";
            var helper = doc.cm && doc.cm.getHelper(pos, "wordChars");
            for (var first = true; ; first = false) {
              if (dir < 0 && !moveOnce(!first)) {
                break;
              }
              var cur = lineObj.text.charAt(pos.ch) || "\n";
              var type2 = isWordChar(cur, helper) ? "w" : group && cur == "\n" ? "n" : !group || /\s/.test(cur) ? null : "p";
              if (group && !first && !type2) {
                type2 = "s";
              }
              if (sawType && sawType != type2) {
                if (dir < 0) {
                  dir = 1;
                  moveOnce();
                  pos.sticky = "after";
                }
                break;
              }
              if (type2) {
                sawType = type2;
              }
              if (dir > 0 && !moveOnce(!first)) {
                break;
              }
            }
          }
          var result = skipAtomic(doc, pos, oldPos, origDir, true);
          if (equalCursorPos(oldPos, result)) {
            result.hitSide = true;
          }
          return result;
        }
        function findPosV(cm, pos, dir, unit) {
          var doc = cm.doc, x = pos.left, y;
          if (unit == "page") {
            var pageSize = Math.min(cm.display.wrapper.clientHeight, window.innerHeight || document.documentElement.clientHeight);
            var moveAmount = Math.max(pageSize - 0.5 * textHeight(cm.display), 3);
            y = (dir > 0 ? pos.bottom : pos.top) + dir * moveAmount;
          } else if (unit == "line") {
            y = dir > 0 ? pos.bottom + 3 : pos.top - 3;
          }
          var target;
          for (; ; ) {
            target = coordsChar(cm, x, y);
            if (!target.outside) {
              break;
            }
            if (dir < 0 ? y <= 0 : y >= doc.height) {
              target.hitSide = true;
              break;
            }
            y += dir * 5;
          }
          return target;
        }
        var ContentEditableInput = function(cm) {
          this.cm = cm;
          this.lastAnchorNode = this.lastAnchorOffset = this.lastFocusNode = this.lastFocusOffset = null;
          this.polling = new Delayed();
          this.composing = null;
          this.gracePeriod = false;
          this.readDOMTimeout = null;
        };
        ContentEditableInput.prototype.init = function(display) {
          var this$1 = this;
          var input = this, cm = input.cm;
          var div = input.div = display.lineDiv;
          div.contentEditable = true;
          disableBrowserMagic(div, cm.options.spellcheck, cm.options.autocorrect, cm.options.autocapitalize);
          function belongsToInput(e) {
            for (var t = e.target; t; t = t.parentNode) {
              if (t == div) {
                return true;
              }
              if (/\bCodeMirror-(?:line)?widget\b/.test(t.className)) {
                break;
              }
            }
            return false;
          }
          on(div, "paste", function(e) {
            if (!belongsToInput(e) || signalDOMEvent(cm, e) || handlePaste(e, cm)) {
              return;
            }
            if (ie_version <= 11) {
              setTimeout(operation(cm, function() {
                return this$1.updateFromDOM();
              }), 20);
            }
          });
          on(div, "compositionstart", function(e) {
            this$1.composing = { data: e.data, done: false };
          });
          on(div, "compositionupdate", function(e) {
            if (!this$1.composing) {
              this$1.composing = { data: e.data, done: false };
            }
          });
          on(div, "compositionend", function(e) {
            if (this$1.composing) {
              if (e.data != this$1.composing.data) {
                this$1.readFromDOMSoon();
              }
              this$1.composing.done = true;
            }
          });
          on(div, "touchstart", function() {
            return input.forceCompositionEnd();
          });
          on(div, "input", function() {
            if (!this$1.composing) {
              this$1.readFromDOMSoon();
            }
          });
          function onCopyCut(e) {
            if (!belongsToInput(e) || signalDOMEvent(cm, e)) {
              return;
            }
            if (cm.somethingSelected()) {
              setLastCopied({ lineWise: false, text: cm.getSelections() });
              if (e.type == "cut") {
                cm.replaceSelection("", null, "cut");
              }
            } else if (!cm.options.lineWiseCopyCut) {
              return;
            } else {
              var ranges = copyableRanges(cm);
              setLastCopied({ lineWise: true, text: ranges.text });
              if (e.type == "cut") {
                cm.operation(function() {
                  cm.setSelections(ranges.ranges, 0, sel_dontScroll);
                  cm.replaceSelection("", null, "cut");
                });
              }
            }
            if (e.clipboardData) {
              e.clipboardData.clearData();
              var content = lastCopied.text.join("\n");
              e.clipboardData.setData("Text", content);
              if (e.clipboardData.getData("Text") == content) {
                e.preventDefault();
                return;
              }
            }
            var kludge = hiddenTextarea(), te = kludge.firstChild;
            cm.display.lineSpace.insertBefore(kludge, cm.display.lineSpace.firstChild);
            te.value = lastCopied.text.join("\n");
            var hadFocus = activeElt();
            selectInput(te);
            setTimeout(function() {
              cm.display.lineSpace.removeChild(kludge);
              hadFocus.focus();
              if (hadFocus == div) {
                input.showPrimarySelection();
              }
            }, 50);
          }
          on(div, "copy", onCopyCut);
          on(div, "cut", onCopyCut);
        };
        ContentEditableInput.prototype.screenReaderLabelChanged = function(label) {
          if (label) {
            this.div.setAttribute("aria-label", label);
          } else {
            this.div.removeAttribute("aria-label");
          }
        };
        ContentEditableInput.prototype.prepareSelection = function() {
          var result = prepareSelection(this.cm, false);
          result.focus = activeElt() == this.div;
          return result;
        };
        ContentEditableInput.prototype.showSelection = function(info, takeFocus) {
          if (!info || !this.cm.display.view.length) {
            return;
          }
          if (info.focus || takeFocus) {
            this.showPrimarySelection();
          }
          this.showMultipleSelections(info);
        };
        ContentEditableInput.prototype.getSelection = function() {
          return this.cm.display.wrapper.ownerDocument.getSelection();
        };
        ContentEditableInput.prototype.showPrimarySelection = function() {
          var sel = this.getSelection(), cm = this.cm, prim = cm.doc.sel.primary();
          var from = prim.from(), to = prim.to();
          if (cm.display.viewTo == cm.display.viewFrom || from.line >= cm.display.viewTo || to.line < cm.display.viewFrom) {
            sel.removeAllRanges();
            return;
          }
          var curAnchor = domToPos(cm, sel.anchorNode, sel.anchorOffset);
          var curFocus = domToPos(cm, sel.focusNode, sel.focusOffset);
          if (curAnchor && !curAnchor.bad && curFocus && !curFocus.bad && cmp(minPos(curAnchor, curFocus), from) == 0 && cmp(maxPos(curAnchor, curFocus), to) == 0) {
            return;
          }
          var view = cm.display.view;
          var start = from.line >= cm.display.viewFrom && posToDOM(cm, from) || { node: view[0].measure.map[2], offset: 0 };
          var end = to.line < cm.display.viewTo && posToDOM(cm, to);
          if (!end) {
            var measure = view[view.length - 1].measure;
            var map2 = measure.maps ? measure.maps[measure.maps.length - 1] : measure.map;
            end = { node: map2[map2.length - 1], offset: map2[map2.length - 2] - map2[map2.length - 3] };
          }
          if (!start || !end) {
            sel.removeAllRanges();
            return;
          }
          var old = sel.rangeCount && sel.getRangeAt(0), rng;
          try {
            rng = range(start.node, start.offset, end.offset, end.node);
          } catch (e) {
          }
          if (rng) {
            if (!gecko && cm.state.focused) {
              sel.collapse(start.node, start.offset);
              if (!rng.collapsed) {
                sel.removeAllRanges();
                sel.addRange(rng);
              }
            } else {
              sel.removeAllRanges();
              sel.addRange(rng);
            }
            if (old && sel.anchorNode == null) {
              sel.addRange(old);
            } else if (gecko) {
              this.startGracePeriod();
            }
          }
          this.rememberSelection();
        };
        ContentEditableInput.prototype.startGracePeriod = function() {
          var this$1 = this;
          clearTimeout(this.gracePeriod);
          this.gracePeriod = setTimeout(function() {
            this$1.gracePeriod = false;
            if (this$1.selectionChanged()) {
              this$1.cm.operation(function() {
                return this$1.cm.curOp.selectionChanged = true;
              });
            }
          }, 20);
        };
        ContentEditableInput.prototype.showMultipleSelections = function(info) {
          removeChildrenAndAdd(this.cm.display.cursorDiv, info.cursors);
          removeChildrenAndAdd(this.cm.display.selectionDiv, info.selection);
        };
        ContentEditableInput.prototype.rememberSelection = function() {
          var sel = this.getSelection();
          this.lastAnchorNode = sel.anchorNode;
          this.lastAnchorOffset = sel.anchorOffset;
          this.lastFocusNode = sel.focusNode;
          this.lastFocusOffset = sel.focusOffset;
        };
        ContentEditableInput.prototype.selectionInEditor = function() {
          var sel = this.getSelection();
          if (!sel.rangeCount) {
            return false;
          }
          var node = sel.getRangeAt(0).commonAncestorContainer;
          return contains(this.div, node);
        };
        ContentEditableInput.prototype.focus = function() {
          if (this.cm.options.readOnly != "nocursor") {
            if (!this.selectionInEditor() || activeElt() != this.div) {
              this.showSelection(this.prepareSelection(), true);
            }
            this.div.focus();
          }
        };
        ContentEditableInput.prototype.blur = function() {
          this.div.blur();
        };
        ContentEditableInput.prototype.getField = function() {
          return this.div;
        };
        ContentEditableInput.prototype.supportsTouch = function() {
          return true;
        };
        ContentEditableInput.prototype.receivedFocus = function() {
          var this$1 = this;
          var input = this;
          if (this.selectionInEditor()) {
            setTimeout(function() {
              return this$1.pollSelection();
            }, 20);
          } else {
            runInOp(this.cm, function() {
              return input.cm.curOp.selectionChanged = true;
            });
          }
          function poll() {
            if (input.cm.state.focused) {
              input.pollSelection();
              input.polling.set(input.cm.options.pollInterval, poll);
            }
          }
          this.polling.set(this.cm.options.pollInterval, poll);
        };
        ContentEditableInput.prototype.selectionChanged = function() {
          var sel = this.getSelection();
          return sel.anchorNode != this.lastAnchorNode || sel.anchorOffset != this.lastAnchorOffset || sel.focusNode != this.lastFocusNode || sel.focusOffset != this.lastFocusOffset;
        };
        ContentEditableInput.prototype.pollSelection = function() {
          if (this.readDOMTimeout != null || this.gracePeriod || !this.selectionChanged()) {
            return;
          }
          var sel = this.getSelection(), cm = this.cm;
          if (android && chrome && this.cm.display.gutterSpecs.length && isInGutter(sel.anchorNode)) {
            this.cm.triggerOnKeyDown({ type: "keydown", keyCode: 8, preventDefault: Math.abs });
            this.blur();
            this.focus();
            return;
          }
          if (this.composing) {
            return;
          }
          this.rememberSelection();
          var anchor = domToPos(cm, sel.anchorNode, sel.anchorOffset);
          var head = domToPos(cm, sel.focusNode, sel.focusOffset);
          if (anchor && head) {
            runInOp(cm, function() {
              setSelection(cm.doc, simpleSelection(anchor, head), sel_dontScroll);
              if (anchor.bad || head.bad) {
                cm.curOp.selectionChanged = true;
              }
            });
          }
        };
        ContentEditableInput.prototype.pollContent = function() {
          if (this.readDOMTimeout != null) {
            clearTimeout(this.readDOMTimeout);
            this.readDOMTimeout = null;
          }
          var cm = this.cm, display = cm.display, sel = cm.doc.sel.primary();
          var from = sel.from(), to = sel.to();
          if (from.ch == 0 && from.line > cm.firstLine()) {
            from = Pos(from.line - 1, getLine(cm.doc, from.line - 1).length);
          }
          if (to.ch == getLine(cm.doc, to.line).text.length && to.line < cm.lastLine()) {
            to = Pos(to.line + 1, 0);
          }
          if (from.line < display.viewFrom || to.line > display.viewTo - 1) {
            return false;
          }
          var fromIndex, fromLine, fromNode;
          if (from.line == display.viewFrom || (fromIndex = findViewIndex(cm, from.line)) == 0) {
            fromLine = lineNo(display.view[0].line);
            fromNode = display.view[0].node;
          } else {
            fromLine = lineNo(display.view[fromIndex].line);
            fromNode = display.view[fromIndex - 1].node.nextSibling;
          }
          var toIndex = findViewIndex(cm, to.line);
          var toLine, toNode;
          if (toIndex == display.view.length - 1) {
            toLine = display.viewTo - 1;
            toNode = display.lineDiv.lastChild;
          } else {
            toLine = lineNo(display.view[toIndex + 1].line) - 1;
            toNode = display.view[toIndex + 1].node.previousSibling;
          }
          if (!fromNode) {
            return false;
          }
          var newText = cm.doc.splitLines(domTextBetween(cm, fromNode, toNode, fromLine, toLine));
          var oldText = getBetween(cm.doc, Pos(fromLine, 0), Pos(toLine, getLine(cm.doc, toLine).text.length));
          while (newText.length > 1 && oldText.length > 1) {
            if (lst(newText) == lst(oldText)) {
              newText.pop();
              oldText.pop();
              toLine--;
            } else if (newText[0] == oldText[0]) {
              newText.shift();
              oldText.shift();
              fromLine++;
            } else {
              break;
            }
          }
          var cutFront = 0, cutEnd = 0;
          var newTop = newText[0], oldTop = oldText[0], maxCutFront = Math.min(newTop.length, oldTop.length);
          while (cutFront < maxCutFront && newTop.charCodeAt(cutFront) == oldTop.charCodeAt(cutFront)) {
            ++cutFront;
          }
          var newBot = lst(newText), oldBot = lst(oldText);
          var maxCutEnd = Math.min(
            newBot.length - (newText.length == 1 ? cutFront : 0),
            oldBot.length - (oldText.length == 1 ? cutFront : 0)
          );
          while (cutEnd < maxCutEnd && newBot.charCodeAt(newBot.length - cutEnd - 1) == oldBot.charCodeAt(oldBot.length - cutEnd - 1)) {
            ++cutEnd;
          }
          if (newText.length == 1 && oldText.length == 1 && fromLine == from.line) {
            while (cutFront && cutFront > from.ch && newBot.charCodeAt(newBot.length - cutEnd - 1) == oldBot.charCodeAt(oldBot.length - cutEnd - 1)) {
              cutFront--;
              cutEnd++;
            }
          }
          newText[newText.length - 1] = newBot.slice(0, newBot.length - cutEnd).replace(/^\u200b+/, "");
          newText[0] = newText[0].slice(cutFront).replace(/\u200b+$/, "");
          var chFrom = Pos(fromLine, cutFront);
          var chTo = Pos(toLine, oldText.length ? lst(oldText).length - cutEnd : 0);
          if (newText.length > 1 || newText[0] || cmp(chFrom, chTo)) {
            replaceRange(cm.doc, newText, chFrom, chTo, "+input");
            return true;
          }
        };
        ContentEditableInput.prototype.ensurePolled = function() {
          this.forceCompositionEnd();
        };
        ContentEditableInput.prototype.reset = function() {
          this.forceCompositionEnd();
        };
        ContentEditableInput.prototype.forceCompositionEnd = function() {
          if (!this.composing) {
            return;
          }
          clearTimeout(this.readDOMTimeout);
          this.composing = null;
          this.updateFromDOM();
          this.div.blur();
          this.div.focus();
        };
        ContentEditableInput.prototype.readFromDOMSoon = function() {
          var this$1 = this;
          if (this.readDOMTimeout != null) {
            return;
          }
          this.readDOMTimeout = setTimeout(function() {
            this$1.readDOMTimeout = null;
            if (this$1.composing) {
              if (this$1.composing.done) {
                this$1.composing = null;
              } else {
                return;
              }
            }
            this$1.updateFromDOM();
          }, 80);
        };
        ContentEditableInput.prototype.updateFromDOM = function() {
          var this$1 = this;
          if (this.cm.isReadOnly() || !this.pollContent()) {
            runInOp(this.cm, function() {
              return regChange(this$1.cm);
            });
          }
        };
        ContentEditableInput.prototype.setUneditable = function(node) {
          node.contentEditable = "false";
        };
        ContentEditableInput.prototype.onKeyPress = function(e) {
          if (e.charCode == 0 || this.composing) {
            return;
          }
          e.preventDefault();
          if (!this.cm.isReadOnly()) {
            operation(this.cm, applyTextInput)(this.cm, String.fromCharCode(e.charCode == null ? e.keyCode : e.charCode), 0);
          }
        };
        ContentEditableInput.prototype.readOnlyChanged = function(val) {
          this.div.contentEditable = String(val != "nocursor");
        };
        ContentEditableInput.prototype.onContextMenu = function() {
        };
        ContentEditableInput.prototype.resetPosition = function() {
        };
        ContentEditableInput.prototype.needsContentAttribute = true;
        function posToDOM(cm, pos) {
          var view = findViewForLine(cm, pos.line);
          if (!view || view.hidden) {
            return null;
          }
          var line = getLine(cm.doc, pos.line);
          var info = mapFromLineView(view, line, pos.line);
          var order = getOrder(line, cm.doc.direction), side = "left";
          if (order) {
            var partPos = getBidiPartAt(order, pos.ch);
            side = partPos % 2 ? "right" : "left";
          }
          var result = nodeAndOffsetInLineMap(info.map, pos.ch, side);
          result.offset = result.collapse == "right" ? result.end : result.start;
          return result;
        }
        function isInGutter(node) {
          for (var scan = node; scan; scan = scan.parentNode) {
            if (/CodeMirror-gutter-wrapper/.test(scan.className)) {
              return true;
            }
          }
          return false;
        }
        function badPos(pos, bad) {
          if (bad) {
            pos.bad = true;
          }
          return pos;
        }
        function domTextBetween(cm, from, to, fromLine, toLine) {
          var text = "", closing = false, lineSep = cm.doc.lineSeparator(), extraLinebreak = false;
          function recognizeMarker(id) {
            return function(marker) {
              return marker.id == id;
            };
          }
          function close() {
            if (closing) {
              text += lineSep;
              if (extraLinebreak) {
                text += lineSep;
              }
              closing = extraLinebreak = false;
            }
          }
          function addText(str) {
            if (str) {
              close();
              text += str;
            }
          }
          function walk(node) {
            if (node.nodeType == 1) {
              var cmText = node.getAttribute("cm-text");
              if (cmText) {
                addText(cmText);
                return;
              }
              var markerID = node.getAttribute("cm-marker"), range2;
              if (markerID) {
                var found = cm.findMarks(Pos(fromLine, 0), Pos(toLine + 1, 0), recognizeMarker(+markerID));
                if (found.length && (range2 = found[0].find(0))) {
                  addText(getBetween(cm.doc, range2.from, range2.to).join(lineSep));
                }
                return;
              }
              if (node.getAttribute("contenteditable") == "false") {
                return;
              }
              var isBlock = /^(pre|div|p|li|table|br)$/i.test(node.nodeName);
              if (!/^br$/i.test(node.nodeName) && node.textContent.length == 0) {
                return;
              }
              if (isBlock) {
                close();
              }
              for (var i2 = 0; i2 < node.childNodes.length; i2++) {
                walk(node.childNodes[i2]);
              }
              if (/^(pre|p)$/i.test(node.nodeName)) {
                extraLinebreak = true;
              }
              if (isBlock) {
                closing = true;
              }
            } else if (node.nodeType == 3) {
              addText(node.nodeValue.replace(/\u200b/g, "").replace(/\u00a0/g, " "));
            }
          }
          for (; ; ) {
            walk(from);
            if (from == to) {
              break;
            }
            from = from.nextSibling;
            extraLinebreak = false;
          }
          return text;
        }
        function domToPos(cm, node, offset) {
          var lineNode;
          if (node == cm.display.lineDiv) {
            lineNode = cm.display.lineDiv.childNodes[offset];
            if (!lineNode) {
              return badPos(cm.clipPos(Pos(cm.display.viewTo - 1)), true);
            }
            node = null;
            offset = 0;
          } else {
            for (lineNode = node; ; lineNode = lineNode.parentNode) {
              if (!lineNode || lineNode == cm.display.lineDiv) {
                return null;
              }
              if (lineNode.parentNode && lineNode.parentNode == cm.display.lineDiv) {
                break;
              }
            }
          }
          for (var i2 = 0; i2 < cm.display.view.length; i2++) {
            var lineView = cm.display.view[i2];
            if (lineView.node == lineNode) {
              return locateNodeInLineView(lineView, node, offset);
            }
          }
        }
        function locateNodeInLineView(lineView, node, offset) {
          var wrapper = lineView.text.firstChild, bad = false;
          if (!node || !contains(wrapper, node)) {
            return badPos(Pos(lineNo(lineView.line), 0), true);
          }
          if (node == wrapper) {
            bad = true;
            node = wrapper.childNodes[offset];
            offset = 0;
            if (!node) {
              var line = lineView.rest ? lst(lineView.rest) : lineView.line;
              return badPos(Pos(lineNo(line), line.text.length), bad);
            }
          }
          var textNode = node.nodeType == 3 ? node : null, topNode = node;
          if (!textNode && node.childNodes.length == 1 && node.firstChild.nodeType == 3) {
            textNode = node.firstChild;
            if (offset) {
              offset = textNode.nodeValue.length;
            }
          }
          while (topNode.parentNode != wrapper) {
            topNode = topNode.parentNode;
          }
          var measure = lineView.measure, maps = measure.maps;
          function find(textNode2, topNode2, offset2) {
            for (var i2 = -1; i2 < (maps ? maps.length : 0); i2++) {
              var map2 = i2 < 0 ? measure.map : maps[i2];
              for (var j = 0; j < map2.length; j += 3) {
                var curNode = map2[j + 2];
                if (curNode == textNode2 || curNode == topNode2) {
                  var line2 = lineNo(i2 < 0 ? lineView.line : lineView.rest[i2]);
                  var ch = map2[j] + offset2;
                  if (offset2 < 0 || curNode != textNode2) {
                    ch = map2[j + (offset2 ? 1 : 0)];
                  }
                  return Pos(line2, ch);
                }
              }
            }
          }
          var found = find(textNode, topNode, offset);
          if (found) {
            return badPos(found, bad);
          }
          for (var after = topNode.nextSibling, dist = textNode ? textNode.nodeValue.length - offset : 0; after; after = after.nextSibling) {
            found = find(after, after.firstChild, 0);
            if (found) {
              return badPos(Pos(found.line, found.ch - dist), bad);
            } else {
              dist += after.textContent.length;
            }
          }
          for (var before = topNode.previousSibling, dist$1 = offset; before; before = before.previousSibling) {
            found = find(before, before.firstChild, -1);
            if (found) {
              return badPos(Pos(found.line, found.ch + dist$1), bad);
            } else {
              dist$1 += before.textContent.length;
            }
          }
        }
        var TextareaInput = function(cm) {
          this.cm = cm;
          this.prevInput = "";
          this.pollingFast = false;
          this.polling = new Delayed();
          this.hasSelection = false;
          this.composing = null;
        };
        TextareaInput.prototype.init = function(display) {
          var this$1 = this;
          var input = this, cm = this.cm;
          this.createField(display);
          var te = this.textarea;
          display.wrapper.insertBefore(this.wrapper, display.wrapper.firstChild);
          if (ios) {
            te.style.width = "0px";
          }
          on(te, "input", function() {
            if (ie && ie_version >= 9 && this$1.hasSelection) {
              this$1.hasSelection = null;
            }
            input.poll();
          });
          on(te, "paste", function(e) {
            if (signalDOMEvent(cm, e) || handlePaste(e, cm)) {
              return;
            }
            cm.state.pasteIncoming = +/* @__PURE__ */ new Date();
            input.fastPoll();
          });
          function prepareCopyCut(e) {
            if (signalDOMEvent(cm, e)) {
              return;
            }
            if (cm.somethingSelected()) {
              setLastCopied({ lineWise: false, text: cm.getSelections() });
            } else if (!cm.options.lineWiseCopyCut) {
              return;
            } else {
              var ranges = copyableRanges(cm);
              setLastCopied({ lineWise: true, text: ranges.text });
              if (e.type == "cut") {
                cm.setSelections(ranges.ranges, null, sel_dontScroll);
              } else {
                input.prevInput = "";
                te.value = ranges.text.join("\n");
                selectInput(te);
              }
            }
            if (e.type == "cut") {
              cm.state.cutIncoming = +/* @__PURE__ */ new Date();
            }
          }
          on(te, "cut", prepareCopyCut);
          on(te, "copy", prepareCopyCut);
          on(display.scroller, "paste", function(e) {
            if (eventInWidget(display, e) || signalDOMEvent(cm, e)) {
              return;
            }
            if (!te.dispatchEvent) {
              cm.state.pasteIncoming = +/* @__PURE__ */ new Date();
              input.focus();
              return;
            }
            var event = new Event("paste");
            event.clipboardData = e.clipboardData;
            te.dispatchEvent(event);
          });
          on(display.lineSpace, "selectstart", function(e) {
            if (!eventInWidget(display, e)) {
              e_preventDefault(e);
            }
          });
          on(te, "compositionstart", function() {
            var start = cm.getCursor("from");
            if (input.composing) {
              input.composing.range.clear();
            }
            input.composing = {
              start,
              range: cm.markText(start, cm.getCursor("to"), { className: "CodeMirror-composing" })
            };
          });
          on(te, "compositionend", function() {
            if (input.composing) {
              input.poll();
              input.composing.range.clear();
              input.composing = null;
            }
          });
        };
        TextareaInput.prototype.createField = function(_display) {
          this.wrapper = hiddenTextarea();
          this.textarea = this.wrapper.firstChild;
        };
        TextareaInput.prototype.screenReaderLabelChanged = function(label) {
          if (label) {
            this.textarea.setAttribute("aria-label", label);
          } else {
            this.textarea.removeAttribute("aria-label");
          }
        };
        TextareaInput.prototype.prepareSelection = function() {
          var cm = this.cm, display = cm.display, doc = cm.doc;
          var result = prepareSelection(cm);
          if (cm.options.moveInputWithCursor) {
            var headPos = cursorCoords(cm, doc.sel.primary().head, "div");
            var wrapOff = display.wrapper.getBoundingClientRect(), lineOff = display.lineDiv.getBoundingClientRect();
            result.teTop = Math.max(0, Math.min(
              display.wrapper.clientHeight - 10,
              headPos.top + lineOff.top - wrapOff.top
            ));
            result.teLeft = Math.max(0, Math.min(
              display.wrapper.clientWidth - 10,
              headPos.left + lineOff.left - wrapOff.left
            ));
          }
          return result;
        };
        TextareaInput.prototype.showSelection = function(drawn) {
          var cm = this.cm, display = cm.display;
          removeChildrenAndAdd(display.cursorDiv, drawn.cursors);
          removeChildrenAndAdd(display.selectionDiv, drawn.selection);
          if (drawn.teTop != null) {
            this.wrapper.style.top = drawn.teTop + "px";
            this.wrapper.style.left = drawn.teLeft + "px";
          }
        };
        TextareaInput.prototype.reset = function(typing) {
          if (this.contextMenuPending || this.composing) {
            return;
          }
          var cm = this.cm;
          if (cm.somethingSelected()) {
            this.prevInput = "";
            var content = cm.getSelection();
            this.textarea.value = content;
            if (cm.state.focused) {
              selectInput(this.textarea);
            }
            if (ie && ie_version >= 9) {
              this.hasSelection = content;
            }
          } else if (!typing) {
            this.prevInput = this.textarea.value = "";
            if (ie && ie_version >= 9) {
              this.hasSelection = null;
            }
          }
        };
        TextareaInput.prototype.getField = function() {
          return this.textarea;
        };
        TextareaInput.prototype.supportsTouch = function() {
          return false;
        };
        TextareaInput.prototype.focus = function() {
          if (this.cm.options.readOnly != "nocursor" && (!mobile || activeElt() != this.textarea)) {
            try {
              this.textarea.focus();
            } catch (e) {
            }
          }
        };
        TextareaInput.prototype.blur = function() {
          this.textarea.blur();
        };
        TextareaInput.prototype.resetPosition = function() {
          this.wrapper.style.top = this.wrapper.style.left = 0;
        };
        TextareaInput.prototype.receivedFocus = function() {
          this.slowPoll();
        };
        TextareaInput.prototype.slowPoll = function() {
          var this$1 = this;
          if (this.pollingFast) {
            return;
          }
          this.polling.set(this.cm.options.pollInterval, function() {
            this$1.poll();
            if (this$1.cm.state.focused) {
              this$1.slowPoll();
            }
          });
        };
        TextareaInput.prototype.fastPoll = function() {
          var missed = false, input = this;
          input.pollingFast = true;
          function p() {
            var changed = input.poll();
            if (!changed && !missed) {
              missed = true;
              input.polling.set(60, p);
            } else {
              input.pollingFast = false;
              input.slowPoll();
            }
          }
          input.polling.set(20, p);
        };
        TextareaInput.prototype.poll = function() {
          var this$1 = this;
          var cm = this.cm, input = this.textarea, prevInput = this.prevInput;
          if (this.contextMenuPending || !cm.state.focused || hasSelection(input) && !prevInput && !this.composing || cm.isReadOnly() || cm.options.disableInput || cm.state.keySeq) {
            return false;
          }
          var text = input.value;
          if (text == prevInput && !cm.somethingSelected()) {
            return false;
          }
          if (ie && ie_version >= 9 && this.hasSelection === text || mac && /[\uf700-\uf7ff]/.test(text)) {
            cm.display.input.reset();
            return false;
          }
          if (cm.doc.sel == cm.display.selForContextMenu) {
            var first = text.charCodeAt(0);
            if (first == 8203 && !prevInput) {
              prevInput = "​";
            }
            if (first == 8666) {
              this.reset();
              return this.cm.execCommand("undo");
            }
          }
          var same = 0, l = Math.min(prevInput.length, text.length);
          while (same < l && prevInput.charCodeAt(same) == text.charCodeAt(same)) {
            ++same;
          }
          runInOp(cm, function() {
            applyTextInput(
              cm,
              text.slice(same),
              prevInput.length - same,
              null,
              this$1.composing ? "*compose" : null
            );
            if (text.length > 1e3 || text.indexOf("\n") > -1) {
              input.value = this$1.prevInput = "";
            } else {
              this$1.prevInput = text;
            }
            if (this$1.composing) {
              this$1.composing.range.clear();
              this$1.composing.range = cm.markText(
                this$1.composing.start,
                cm.getCursor("to"),
                { className: "CodeMirror-composing" }
              );
            }
          });
          return true;
        };
        TextareaInput.prototype.ensurePolled = function() {
          if (this.pollingFast && this.poll()) {
            this.pollingFast = false;
          }
        };
        TextareaInput.prototype.onKeyPress = function() {
          if (ie && ie_version >= 9) {
            this.hasSelection = null;
          }
          this.fastPoll();
        };
        TextareaInput.prototype.onContextMenu = function(e) {
          var input = this, cm = input.cm, display = cm.display, te = input.textarea;
          if (input.contextMenuPending) {
            input.contextMenuPending();
          }
          var pos = posFromMouse(cm, e), scrollPos = display.scroller.scrollTop;
          if (!pos || presto) {
            return;
          }
          var reset = cm.options.resetSelectionOnContextMenu;
          if (reset && cm.doc.sel.contains(pos) == -1) {
            operation(cm, setSelection)(cm.doc, simpleSelection(pos), sel_dontScroll);
          }
          var oldCSS = te.style.cssText, oldWrapperCSS = input.wrapper.style.cssText;
          var wrapperBox = input.wrapper.offsetParent.getBoundingClientRect();
          input.wrapper.style.cssText = "position: static";
          te.style.cssText = "position: absolute; width: 30px; height: 30px;\n      top: " + (e.clientY - wrapperBox.top - 5) + "px; left: " + (e.clientX - wrapperBox.left - 5) + "px;\n      z-index: 1000; background: " + (ie ? "rgba(255, 255, 255, .05)" : "transparent") + ";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";
          var oldScrollY;
          if (webkit) {
            oldScrollY = window.scrollY;
          }
          display.input.focus();
          if (webkit) {
            window.scrollTo(null, oldScrollY);
          }
          display.input.reset();
          if (!cm.somethingSelected()) {
            te.value = input.prevInput = " ";
          }
          input.contextMenuPending = rehide;
          display.selForContextMenu = cm.doc.sel;
          clearTimeout(display.detectingSelectAll);
          function prepareSelectAllHack() {
            if (te.selectionStart != null) {
              var selected = cm.somethingSelected();
              var extval = "​" + (selected ? te.value : "");
              te.value = "⇚";
              te.value = extval;
              input.prevInput = selected ? "" : "​";
              te.selectionStart = 1;
              te.selectionEnd = extval.length;
              display.selForContextMenu = cm.doc.sel;
            }
          }
          function rehide() {
            if (input.contextMenuPending != rehide) {
              return;
            }
            input.contextMenuPending = false;
            input.wrapper.style.cssText = oldWrapperCSS;
            te.style.cssText = oldCSS;
            if (ie && ie_version < 9) {
              display.scrollbars.setScrollTop(display.scroller.scrollTop = scrollPos);
            }
            if (te.selectionStart != null) {
              if (!ie || ie && ie_version < 9) {
                prepareSelectAllHack();
              }
              var i2 = 0, poll = function() {
                if (display.selForContextMenu == cm.doc.sel && te.selectionStart == 0 && te.selectionEnd > 0 && input.prevInput == "​") {
                  operation(cm, selectAll)(cm);
                } else if (i2++ < 10) {
                  display.detectingSelectAll = setTimeout(poll, 500);
                } else {
                  display.selForContextMenu = null;
                  display.input.reset();
                }
              };
              display.detectingSelectAll = setTimeout(poll, 200);
            }
          }
          if (ie && ie_version >= 9) {
            prepareSelectAllHack();
          }
          if (captureRightClick) {
            e_stop(e);
            var mouseup = function() {
              off(window, "mouseup", mouseup);
              setTimeout(rehide, 20);
            };
            on(window, "mouseup", mouseup);
          } else {
            setTimeout(rehide, 50);
          }
        };
        TextareaInput.prototype.readOnlyChanged = function(val) {
          if (!val) {
            this.reset();
          }
          this.textarea.disabled = val == "nocursor";
          this.textarea.readOnly = !!val;
        };
        TextareaInput.prototype.setUneditable = function() {
        };
        TextareaInput.prototype.needsContentAttribute = false;
        function fromTextArea(textarea, options) {
          options = options ? copyObj(options) : {};
          options.value = textarea.value;
          if (!options.tabindex && textarea.tabIndex) {
            options.tabindex = textarea.tabIndex;
          }
          if (!options.placeholder && textarea.placeholder) {
            options.placeholder = textarea.placeholder;
          }
          if (options.autofocus == null) {
            var hasFocus = activeElt();
            options.autofocus = hasFocus == textarea || textarea.getAttribute("autofocus") != null && hasFocus == document.body;
          }
          function save() {
            textarea.value = cm.getValue();
          }
          var realSubmit;
          if (textarea.form) {
            on(textarea.form, "submit", save);
            if (!options.leaveSubmitMethodAlone) {
              var form = textarea.form;
              realSubmit = form.submit;
              try {
                var wrappedSubmit = form.submit = function() {
                  save();
                  form.submit = realSubmit;
                  form.submit();
                  form.submit = wrappedSubmit;
                };
              } catch (e) {
              }
            }
          }
          options.finishInit = function(cm2) {
            cm2.save = save;
            cm2.getTextArea = function() {
              return textarea;
            };
            cm2.toTextArea = function() {
              cm2.toTextArea = isNaN;
              save();
              textarea.parentNode.removeChild(cm2.getWrapperElement());
              textarea.style.display = "";
              if (textarea.form) {
                off(textarea.form, "submit", save);
                if (!options.leaveSubmitMethodAlone && typeof textarea.form.submit == "function") {
                  textarea.form.submit = realSubmit;
                }
              }
            };
          };
          textarea.style.display = "none";
          var cm = CodeMirror2(
            function(node) {
              return textarea.parentNode.insertBefore(node, textarea.nextSibling);
            },
            options
          );
          return cm;
        }
        function addLegacyProps(CodeMirror3) {
          CodeMirror3.off = off;
          CodeMirror3.on = on;
          CodeMirror3.wheelEventPixels = wheelEventPixels;
          CodeMirror3.Doc = Doc;
          CodeMirror3.splitLines = splitLinesAuto;
          CodeMirror3.countColumn = countColumn;
          CodeMirror3.findColumn = findColumn;
          CodeMirror3.isWordChar = isWordCharBasic;
          CodeMirror3.Pass = Pass;
          CodeMirror3.signal = signal;
          CodeMirror3.Line = Line;
          CodeMirror3.changeEnd = changeEnd;
          CodeMirror3.scrollbarModel = scrollbarModel;
          CodeMirror3.Pos = Pos;
          CodeMirror3.cmpPos = cmp;
          CodeMirror3.modes = modes;
          CodeMirror3.mimeModes = mimeModes;
          CodeMirror3.resolveMode = resolveMode;
          CodeMirror3.getMode = getMode;
          CodeMirror3.modeExtensions = modeExtensions;
          CodeMirror3.extendMode = extendMode;
          CodeMirror3.copyState = copyState;
          CodeMirror3.startState = startState;
          CodeMirror3.innerMode = innerMode;
          CodeMirror3.commands = commands2;
          CodeMirror3.keyMap = keyMap;
          CodeMirror3.keyName = keyName;
          CodeMirror3.isModifierKey = isModifierKey;
          CodeMirror3.lookupKey = lookupKey;
          CodeMirror3.normalizeKeyMap = normalizeKeyMap;
          CodeMirror3.StringStream = StringStream;
          CodeMirror3.SharedTextMarker = SharedTextMarker;
          CodeMirror3.TextMarker = TextMarker;
          CodeMirror3.LineWidget = LineWidget;
          CodeMirror3.e_preventDefault = e_preventDefault;
          CodeMirror3.e_stopPropagation = e_stopPropagation;
          CodeMirror3.e_stop = e_stop;
          CodeMirror3.addClass = addClass;
          CodeMirror3.contains = contains;
          CodeMirror3.rmClass = rmClass;
          CodeMirror3.keyNames = keyNames;
        }
        defineOptions(CodeMirror2);
        addEditorMethods(CodeMirror2);
        var dontDelegate = "iter insert remove copy getEditor constructor".split(" ");
        for (var prop in Doc.prototype) {
          if (Doc.prototype.hasOwnProperty(prop) && indexOf(dontDelegate, prop) < 0) {
            CodeMirror2.prototype[prop] = /* @__PURE__ */ function(method) {
              return function() {
                return method.apply(this.doc, arguments);
              };
            }(Doc.prototype[prop]);
          }
        }
        eventMixin(Doc);
        CodeMirror2.inputStyles = { "textarea": TextareaInput, "contenteditable": ContentEditableInput };
        CodeMirror2.defineMode = function(name) {
          if (!CodeMirror2.defaults.mode && name != "null") {
            CodeMirror2.defaults.mode = name;
          }
          defineMode.apply(this, arguments);
        };
        CodeMirror2.defineMIME = defineMIME;
        CodeMirror2.defineMode("null", function() {
          return { token: function(stream) {
            return stream.skipToEnd();
          } };
        });
        CodeMirror2.defineMIME("text/plain", "null");
        CodeMirror2.defineExtension = function(name, func) {
          CodeMirror2.prototype[name] = func;
        };
        CodeMirror2.defineDocExtension = function(name, func) {
          Doc.prototype[name] = func;
        };
        CodeMirror2.fromTextArea = fromTextArea;
        addLegacyProps(CodeMirror2);
        CodeMirror2.version = "5.63.0";
        return CodeMirror2;
      });
    }
  ),
  /***/
  656: (
    /***/
    (__unused_webpack_module, __unused_webpack_exports, __webpack_require__2) => {
      (function(mod) {
        if (true)
          mod(__webpack_require__2(237));
        else {
        }
      })(function(CodeMirror2) {
        "use strict";
        CodeMirror2.defineMode("css", function(config2, parserConfig) {
          var inline = parserConfig.inline;
          if (!parserConfig.propertyKeywords)
            parserConfig = CodeMirror2.resolveMode("text/css");
          var indentUnit = config2.indentUnit, tokenHooks = parserConfig.tokenHooks, documentTypes2 = parserConfig.documentTypes || {}, mediaTypes2 = parserConfig.mediaTypes || {}, mediaFeatures2 = parserConfig.mediaFeatures || {}, mediaValueKeywords2 = parserConfig.mediaValueKeywords || {}, propertyKeywords2 = parserConfig.propertyKeywords || {}, nonStandardPropertyKeywords2 = parserConfig.nonStandardPropertyKeywords || {}, fontProperties2 = parserConfig.fontProperties || {}, counterDescriptors2 = parserConfig.counterDescriptors || {}, colorKeywords2 = parserConfig.colorKeywords || {}, valueKeywords2 = parserConfig.valueKeywords || {}, allowNested = parserConfig.allowNested, lineComment = parserConfig.lineComment, supportsAtComponent = parserConfig.supportsAtComponent === true, highlightNonStandardPropertyKeywords = config2.highlightNonStandardPropertyKeywords !== false;
          var type2, override;
          function ret(style, tp) {
            type2 = tp;
            return style;
          }
          function tokenBase(stream, state) {
            var ch = stream.next();
            if (tokenHooks[ch]) {
              var result = tokenHooks[ch](stream, state);
              if (result !== false)
                return result;
            }
            if (ch == "@") {
              stream.eatWhile(/[\w\\\-]/);
              return ret("def", stream.current());
            } else if (ch == "=" || (ch == "~" || ch == "|") && stream.eat("=")) {
              return ret(null, "compare");
            } else if (ch == '"' || ch == "'") {
              state.tokenize = tokenString(ch);
              return state.tokenize(stream, state);
            } else if (ch == "#") {
              stream.eatWhile(/[\w\\\-]/);
              return ret("atom", "hash");
            } else if (ch == "!") {
              stream.match(/^\s*\w*/);
              return ret("keyword", "important");
            } else if (/\d/.test(ch) || ch == "." && stream.eat(/\d/)) {
              stream.eatWhile(/[\w.%]/);
              return ret("number", "unit");
            } else if (ch === "-") {
              if (/[\d.]/.test(stream.peek())) {
                stream.eatWhile(/[\w.%]/);
                return ret("number", "unit");
              } else if (stream.match(/^-[\w\\\-]*/)) {
                stream.eatWhile(/[\w\\\-]/);
                if (stream.match(/^\s*:/, false))
                  return ret("variable-2", "variable-definition");
                return ret("variable-2", "variable");
              } else if (stream.match(/^\w+-/)) {
                return ret("meta", "meta");
              }
            } else if (/[,+>*\/]/.test(ch)) {
              return ret(null, "select-op");
            } else if (ch == "." && stream.match(/^-?[_a-z][_a-z0-9-]*/i)) {
              return ret("qualifier", "qualifier");
            } else if (/[:;{}\[\]\(\)]/.test(ch)) {
              return ret(null, ch);
            } else if (stream.match(/^[\w-.]+(?=\()/)) {
              if (/^(url(-prefix)?|domain|regexp)$/i.test(stream.current())) {
                state.tokenize = tokenParenthesized;
              }
              return ret("variable callee", "variable");
            } else if (/[\w\\\-]/.test(ch)) {
              stream.eatWhile(/[\w\\\-]/);
              return ret("property", "word");
            } else {
              return ret(null, null);
            }
          }
          function tokenString(quote) {
            return function(stream, state) {
              var escaped = false, ch;
              while ((ch = stream.next()) != null) {
                if (ch == quote && !escaped) {
                  if (quote == ")")
                    stream.backUp(1);
                  break;
                }
                escaped = !escaped && ch == "\\";
              }
              if (ch == quote || !escaped && quote != ")")
                state.tokenize = null;
              return ret("string", "string");
            };
          }
          function tokenParenthesized(stream, state) {
            stream.next();
            if (!stream.match(/^\s*[\"\')]/, false))
              state.tokenize = tokenString(")");
            else
              state.tokenize = null;
            return ret(null, "(");
          }
          function Context(type3, indent, prev) {
            this.type = type3;
            this.indent = indent;
            this.prev = prev;
          }
          function pushContext(state, stream, type3, indent) {
            state.context = new Context(type3, stream.indentation() + (indent === false ? 0 : indentUnit), state.context);
            return type3;
          }
          function popContext(state) {
            if (state.context.prev)
              state.context = state.context.prev;
            return state.context.type;
          }
          function pass(type3, stream, state) {
            return states[state.context.type](type3, stream, state);
          }
          function popAndPass(type3, stream, state, n) {
            for (var i = n || 1; i > 0; i--)
              state.context = state.context.prev;
            return pass(type3, stream, state);
          }
          function wordAsValue(stream) {
            var word = stream.current().toLowerCase();
            if (valueKeywords2.hasOwnProperty(word))
              override = "atom";
            else if (colorKeywords2.hasOwnProperty(word))
              override = "keyword";
            else
              override = "variable";
          }
          var states = {};
          states.top = function(type3, stream, state) {
            if (type3 == "{") {
              return pushContext(state, stream, "block");
            } else if (type3 == "}" && state.context.prev) {
              return popContext(state);
            } else if (supportsAtComponent && /@component/i.test(type3)) {
              return pushContext(state, stream, "atComponentBlock");
            } else if (/^@(-moz-)?document$/i.test(type3)) {
              return pushContext(state, stream, "documentTypes");
            } else if (/^@(media|supports|(-moz-)?document|import)$/i.test(type3)) {
              return pushContext(state, stream, "atBlock");
            } else if (/^@(font-face|counter-style)/i.test(type3)) {
              state.stateArg = type3;
              return "restricted_atBlock_before";
            } else if (/^@(-(moz|ms|o|webkit)-)?keyframes$/i.test(type3)) {
              return "keyframes";
            } else if (type3 && type3.charAt(0) == "@") {
              return pushContext(state, stream, "at");
            } else if (type3 == "hash") {
              override = "builtin";
            } else if (type3 == "word") {
              override = "tag";
            } else if (type3 == "variable-definition") {
              return "maybeprop";
            } else if (type3 == "interpolation") {
              return pushContext(state, stream, "interpolation");
            } else if (type3 == ":") {
              return "pseudo";
            } else if (allowNested && type3 == "(") {
              return pushContext(state, stream, "parens");
            }
            return state.context.type;
          };
          states.block = function(type3, stream, state) {
            if (type3 == "word") {
              var word = stream.current().toLowerCase();
              if (propertyKeywords2.hasOwnProperty(word)) {
                override = "property";
                return "maybeprop";
              } else if (nonStandardPropertyKeywords2.hasOwnProperty(word)) {
                override = highlightNonStandardPropertyKeywords ? "string-2" : "property";
                return "maybeprop";
              } else if (allowNested) {
                override = stream.match(/^\s*:(?:\s|$)/, false) ? "property" : "tag";
                return "block";
              } else {
                override += " error";
                return "maybeprop";
              }
            } else if (type3 == "meta") {
              return "block";
            } else if (!allowNested && (type3 == "hash" || type3 == "qualifier")) {
              override = "error";
              return "block";
            } else {
              return states.top(type3, stream, state);
            }
          };
          states.maybeprop = function(type3, stream, state) {
            if (type3 == ":")
              return pushContext(state, stream, "prop");
            return pass(type3, stream, state);
          };
          states.prop = function(type3, stream, state) {
            if (type3 == ";")
              return popContext(state);
            if (type3 == "{" && allowNested)
              return pushContext(state, stream, "propBlock");
            if (type3 == "}" || type3 == "{")
              return popAndPass(type3, stream, state);
            if (type3 == "(")
              return pushContext(state, stream, "parens");
            if (type3 == "hash" && !/^#([0-9a-fA-f]{3,4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(stream.current())) {
              override += " error";
            } else if (type3 == "word") {
              wordAsValue(stream);
            } else if (type3 == "interpolation") {
              return pushContext(state, stream, "interpolation");
            }
            return "prop";
          };
          states.propBlock = function(type3, _stream, state) {
            if (type3 == "}")
              return popContext(state);
            if (type3 == "word") {
              override = "property";
              return "maybeprop";
            }
            return state.context.type;
          };
          states.parens = function(type3, stream, state) {
            if (type3 == "{" || type3 == "}")
              return popAndPass(type3, stream, state);
            if (type3 == ")")
              return popContext(state);
            if (type3 == "(")
              return pushContext(state, stream, "parens");
            if (type3 == "interpolation")
              return pushContext(state, stream, "interpolation");
            if (type3 == "word")
              wordAsValue(stream);
            return "parens";
          };
          states.pseudo = function(type3, stream, state) {
            if (type3 == "meta")
              return "pseudo";
            if (type3 == "word") {
              override = "variable-3";
              return state.context.type;
            }
            return pass(type3, stream, state);
          };
          states.documentTypes = function(type3, stream, state) {
            if (type3 == "word" && documentTypes2.hasOwnProperty(stream.current())) {
              override = "tag";
              return state.context.type;
            } else {
              return states.atBlock(type3, stream, state);
            }
          };
          states.atBlock = function(type3, stream, state) {
            if (type3 == "(")
              return pushContext(state, stream, "atBlock_parens");
            if (type3 == "}" || type3 == ";")
              return popAndPass(type3, stream, state);
            if (type3 == "{")
              return popContext(state) && pushContext(state, stream, allowNested ? "block" : "top");
            if (type3 == "interpolation")
              return pushContext(state, stream, "interpolation");
            if (type3 == "word") {
              var word = stream.current().toLowerCase();
              if (word == "only" || word == "not" || word == "and" || word == "or")
                override = "keyword";
              else if (mediaTypes2.hasOwnProperty(word))
                override = "attribute";
              else if (mediaFeatures2.hasOwnProperty(word))
                override = "property";
              else if (mediaValueKeywords2.hasOwnProperty(word))
                override = "keyword";
              else if (propertyKeywords2.hasOwnProperty(word))
                override = "property";
              else if (nonStandardPropertyKeywords2.hasOwnProperty(word))
                override = highlightNonStandardPropertyKeywords ? "string-2" : "property";
              else if (valueKeywords2.hasOwnProperty(word))
                override = "atom";
              else if (colorKeywords2.hasOwnProperty(word))
                override = "keyword";
              else
                override = "error";
            }
            return state.context.type;
          };
          states.atComponentBlock = function(type3, stream, state) {
            if (type3 == "}")
              return popAndPass(type3, stream, state);
            if (type3 == "{")
              return popContext(state) && pushContext(state, stream, allowNested ? "block" : "top", false);
            if (type3 == "word")
              override = "error";
            return state.context.type;
          };
          states.atBlock_parens = function(type3, stream, state) {
            if (type3 == ")")
              return popContext(state);
            if (type3 == "{" || type3 == "}")
              return popAndPass(type3, stream, state, 2);
            return states.atBlock(type3, stream, state);
          };
          states.restricted_atBlock_before = function(type3, stream, state) {
            if (type3 == "{")
              return pushContext(state, stream, "restricted_atBlock");
            if (type3 == "word" && state.stateArg == "@counter-style") {
              override = "variable";
              return "restricted_atBlock_before";
            }
            return pass(type3, stream, state);
          };
          states.restricted_atBlock = function(type3, stream, state) {
            if (type3 == "}") {
              state.stateArg = null;
              return popContext(state);
            }
            if (type3 == "word") {
              if (state.stateArg == "@font-face" && !fontProperties2.hasOwnProperty(stream.current().toLowerCase()) || state.stateArg == "@counter-style" && !counterDescriptors2.hasOwnProperty(stream.current().toLowerCase()))
                override = "error";
              else
                override = "property";
              return "maybeprop";
            }
            return "restricted_atBlock";
          };
          states.keyframes = function(type3, stream, state) {
            if (type3 == "word") {
              override = "variable";
              return "keyframes";
            }
            if (type3 == "{")
              return pushContext(state, stream, "top");
            return pass(type3, stream, state);
          };
          states.at = function(type3, stream, state) {
            if (type3 == ";")
              return popContext(state);
            if (type3 == "{" || type3 == "}")
              return popAndPass(type3, stream, state);
            if (type3 == "word")
              override = "tag";
            else if (type3 == "hash")
              override = "builtin";
            return "at";
          };
          states.interpolation = function(type3, stream, state) {
            if (type3 == "}")
              return popContext(state);
            if (type3 == "{" || type3 == ";")
              return popAndPass(type3, stream, state);
            if (type3 == "word")
              override = "variable";
            else if (type3 != "variable" && type3 != "(" && type3 != ")")
              override = "error";
            return "interpolation";
          };
          return {
            startState: function(base) {
              return {
                tokenize: null,
                state: inline ? "block" : "top",
                stateArg: null,
                context: new Context(inline ? "block" : "top", base || 0, null)
              };
            },
            token: function(stream, state) {
              if (!state.tokenize && stream.eatSpace())
                return null;
              var style = (state.tokenize || tokenBase)(stream, state);
              if (style && typeof style == "object") {
                type2 = style[1];
                style = style[0];
              }
              override = style;
              if (type2 != "comment")
                state.state = states[state.state](type2, stream, state);
              return override;
            },
            indent: function(state, textAfter) {
              var cx = state.context, ch = textAfter && textAfter.charAt(0);
              var indent = cx.indent;
              if (cx.type == "prop" && (ch == "}" || ch == ")"))
                cx = cx.prev;
              if (cx.prev) {
                if (ch == "}" && (cx.type == "block" || cx.type == "top" || cx.type == "interpolation" || cx.type == "restricted_atBlock")) {
                  cx = cx.prev;
                  indent = cx.indent;
                } else if (ch == ")" && (cx.type == "parens" || cx.type == "atBlock_parens") || ch == "{" && (cx.type == "at" || cx.type == "atBlock")) {
                  indent = Math.max(0, cx.indent - indentUnit);
                }
              }
              return indent;
            },
            electricChars: "}",
            blockCommentStart: "/*",
            blockCommentEnd: "*/",
            blockCommentContinue: " * ",
            lineComment,
            fold: "brace"
          };
        });
        function keySet(array) {
          var keys = {};
          for (var i = 0; i < array.length; ++i) {
            keys[array[i].toLowerCase()] = true;
          }
          return keys;
        }
        var documentTypes_ = [
          "domain",
          "regexp",
          "url",
          "url-prefix"
        ], documentTypes = keySet(documentTypes_);
        var mediaTypes_ = [
          "all",
          "aural",
          "braille",
          "handheld",
          "print",
          "projection",
          "screen",
          "tty",
          "tv",
          "embossed"
        ], mediaTypes = keySet(mediaTypes_);
        var mediaFeatures_ = [
          "width",
          "min-width",
          "max-width",
          "height",
          "min-height",
          "max-height",
          "device-width",
          "min-device-width",
          "max-device-width",
          "device-height",
          "min-device-height",
          "max-device-height",
          "aspect-ratio",
          "min-aspect-ratio",
          "max-aspect-ratio",
          "device-aspect-ratio",
          "min-device-aspect-ratio",
          "max-device-aspect-ratio",
          "color",
          "min-color",
          "max-color",
          "color-index",
          "min-color-index",
          "max-color-index",
          "monochrome",
          "min-monochrome",
          "max-monochrome",
          "resolution",
          "min-resolution",
          "max-resolution",
          "scan",
          "grid",
          "orientation",
          "device-pixel-ratio",
          "min-device-pixel-ratio",
          "max-device-pixel-ratio",
          "pointer",
          "any-pointer",
          "hover",
          "any-hover",
          "prefers-color-scheme"
        ], mediaFeatures = keySet(mediaFeatures_);
        var mediaValueKeywords_ = [
          "landscape",
          "portrait",
          "none",
          "coarse",
          "fine",
          "on-demand",
          "hover",
          "interlace",
          "progressive",
          "dark",
          "light"
        ], mediaValueKeywords = keySet(mediaValueKeywords_);
        var propertyKeywords_ = [
          "align-content",
          "align-items",
          "align-self",
          "alignment-adjust",
          "alignment-baseline",
          "all",
          "anchor-point",
          "animation",
          "animation-delay",
          "animation-direction",
          "animation-duration",
          "animation-fill-mode",
          "animation-iteration-count",
          "animation-name",
          "animation-play-state",
          "animation-timing-function",
          "appearance",
          "azimuth",
          "backdrop-filter",
          "backface-visibility",
          "background",
          "background-attachment",
          "background-blend-mode",
          "background-clip",
          "background-color",
          "background-image",
          "background-origin",
          "background-position",
          "background-position-x",
          "background-position-y",
          "background-repeat",
          "background-size",
          "baseline-shift",
          "binding",
          "bleed",
          "block-size",
          "bookmark-label",
          "bookmark-level",
          "bookmark-state",
          "bookmark-target",
          "border",
          "border-bottom",
          "border-bottom-color",
          "border-bottom-left-radius",
          "border-bottom-right-radius",
          "border-bottom-style",
          "border-bottom-width",
          "border-collapse",
          "border-color",
          "border-image",
          "border-image-outset",
          "border-image-repeat",
          "border-image-slice",
          "border-image-source",
          "border-image-width",
          "border-left",
          "border-left-color",
          "border-left-style",
          "border-left-width",
          "border-radius",
          "border-right",
          "border-right-color",
          "border-right-style",
          "border-right-width",
          "border-spacing",
          "border-style",
          "border-top",
          "border-top-color",
          "border-top-left-radius",
          "border-top-right-radius",
          "border-top-style",
          "border-top-width",
          "border-width",
          "bottom",
          "box-decoration-break",
          "box-shadow",
          "box-sizing",
          "break-after",
          "break-before",
          "break-inside",
          "caption-side",
          "caret-color",
          "clear",
          "clip",
          "color",
          "color-profile",
          "column-count",
          "column-fill",
          "column-gap",
          "column-rule",
          "column-rule-color",
          "column-rule-style",
          "column-rule-width",
          "column-span",
          "column-width",
          "columns",
          "contain",
          "content",
          "counter-increment",
          "counter-reset",
          "crop",
          "cue",
          "cue-after",
          "cue-before",
          "cursor",
          "direction",
          "display",
          "dominant-baseline",
          "drop-initial-after-adjust",
          "drop-initial-after-align",
          "drop-initial-before-adjust",
          "drop-initial-before-align",
          "drop-initial-size",
          "drop-initial-value",
          "elevation",
          "empty-cells",
          "fit",
          "fit-content",
          "fit-position",
          "flex",
          "flex-basis",
          "flex-direction",
          "flex-flow",
          "flex-grow",
          "flex-shrink",
          "flex-wrap",
          "float",
          "float-offset",
          "flow-from",
          "flow-into",
          "font",
          "font-family",
          "font-feature-settings",
          "font-kerning",
          "font-language-override",
          "font-optical-sizing",
          "font-size",
          "font-size-adjust",
          "font-stretch",
          "font-style",
          "font-synthesis",
          "font-variant",
          "font-variant-alternates",
          "font-variant-caps",
          "font-variant-east-asian",
          "font-variant-ligatures",
          "font-variant-numeric",
          "font-variant-position",
          "font-variation-settings",
          "font-weight",
          "gap",
          "grid",
          "grid-area",
          "grid-auto-columns",
          "grid-auto-flow",
          "grid-auto-rows",
          "grid-column",
          "grid-column-end",
          "grid-column-gap",
          "grid-column-start",
          "grid-gap",
          "grid-row",
          "grid-row-end",
          "grid-row-gap",
          "grid-row-start",
          "grid-template",
          "grid-template-areas",
          "grid-template-columns",
          "grid-template-rows",
          "hanging-punctuation",
          "height",
          "hyphens",
          "icon",
          "image-orientation",
          "image-rendering",
          "image-resolution",
          "inline-box-align",
          "inset",
          "inset-block",
          "inset-block-end",
          "inset-block-start",
          "inset-inline",
          "inset-inline-end",
          "inset-inline-start",
          "isolation",
          "justify-content",
          "justify-items",
          "justify-self",
          "left",
          "letter-spacing",
          "line-break",
          "line-height",
          "line-height-step",
          "line-stacking",
          "line-stacking-ruby",
          "line-stacking-shift",
          "line-stacking-strategy",
          "list-style",
          "list-style-image",
          "list-style-position",
          "list-style-type",
          "margin",
          "margin-bottom",
          "margin-left",
          "margin-right",
          "margin-top",
          "marks",
          "marquee-direction",
          "marquee-loop",
          "marquee-play-count",
          "marquee-speed",
          "marquee-style",
          "mask-clip",
          "mask-composite",
          "mask-image",
          "mask-mode",
          "mask-origin",
          "mask-position",
          "mask-repeat",
          "mask-size",
          "mask-type",
          "max-block-size",
          "max-height",
          "max-inline-size",
          "max-width",
          "min-block-size",
          "min-height",
          "min-inline-size",
          "min-width",
          "mix-blend-mode",
          "move-to",
          "nav-down",
          "nav-index",
          "nav-left",
          "nav-right",
          "nav-up",
          "object-fit",
          "object-position",
          "offset",
          "offset-anchor",
          "offset-distance",
          "offset-path",
          "offset-position",
          "offset-rotate",
          "opacity",
          "order",
          "orphans",
          "outline",
          "outline-color",
          "outline-offset",
          "outline-style",
          "outline-width",
          "overflow",
          "overflow-style",
          "overflow-wrap",
          "overflow-x",
          "overflow-y",
          "padding",
          "padding-bottom",
          "padding-left",
          "padding-right",
          "padding-top",
          "page",
          "page-break-after",
          "page-break-before",
          "page-break-inside",
          "page-policy",
          "pause",
          "pause-after",
          "pause-before",
          "perspective",
          "perspective-origin",
          "pitch",
          "pitch-range",
          "place-content",
          "place-items",
          "place-self",
          "play-during",
          "position",
          "presentation-level",
          "punctuation-trim",
          "quotes",
          "region-break-after",
          "region-break-before",
          "region-break-inside",
          "region-fragment",
          "rendering-intent",
          "resize",
          "rest",
          "rest-after",
          "rest-before",
          "richness",
          "right",
          "rotate",
          "rotation",
          "rotation-point",
          "row-gap",
          "ruby-align",
          "ruby-overhang",
          "ruby-position",
          "ruby-span",
          "scale",
          "scroll-behavior",
          "scroll-margin",
          "scroll-margin-block",
          "scroll-margin-block-end",
          "scroll-margin-block-start",
          "scroll-margin-bottom",
          "scroll-margin-inline",
          "scroll-margin-inline-end",
          "scroll-margin-inline-start",
          "scroll-margin-left",
          "scroll-margin-right",
          "scroll-margin-top",
          "scroll-padding",
          "scroll-padding-block",
          "scroll-padding-block-end",
          "scroll-padding-block-start",
          "scroll-padding-bottom",
          "scroll-padding-inline",
          "scroll-padding-inline-end",
          "scroll-padding-inline-start",
          "scroll-padding-left",
          "scroll-padding-right",
          "scroll-padding-top",
          "scroll-snap-align",
          "scroll-snap-type",
          "shape-image-threshold",
          "shape-inside",
          "shape-margin",
          "shape-outside",
          "size",
          "speak",
          "speak-as",
          "speak-header",
          "speak-numeral",
          "speak-punctuation",
          "speech-rate",
          "stress",
          "string-set",
          "tab-size",
          "table-layout",
          "target",
          "target-name",
          "target-new",
          "target-position",
          "text-align",
          "text-align-last",
          "text-combine-upright",
          "text-decoration",
          "text-decoration-color",
          "text-decoration-line",
          "text-decoration-skip",
          "text-decoration-skip-ink",
          "text-decoration-style",
          "text-emphasis",
          "text-emphasis-color",
          "text-emphasis-position",
          "text-emphasis-style",
          "text-height",
          "text-indent",
          "text-justify",
          "text-orientation",
          "text-outline",
          "text-overflow",
          "text-rendering",
          "text-shadow",
          "text-size-adjust",
          "text-space-collapse",
          "text-transform",
          "text-underline-position",
          "text-wrap",
          "top",
          "touch-action",
          "transform",
          "transform-origin",
          "transform-style",
          "transition",
          "transition-delay",
          "transition-duration",
          "transition-property",
          "transition-timing-function",
          "translate",
          "unicode-bidi",
          "user-select",
          "vertical-align",
          "visibility",
          "voice-balance",
          "voice-duration",
          "voice-family",
          "voice-pitch",
          "voice-range",
          "voice-rate",
          "voice-stress",
          "voice-volume",
          "volume",
          "white-space",
          "widows",
          "width",
          "will-change",
          "word-break",
          "word-spacing",
          "word-wrap",
          "writing-mode",
          "z-index",
          // SVG-specific
          "clip-path",
          "clip-rule",
          "mask",
          "enable-background",
          "filter",
          "flood-color",
          "flood-opacity",
          "lighting-color",
          "stop-color",
          "stop-opacity",
          "pointer-events",
          "color-interpolation",
          "color-interpolation-filters",
          "color-rendering",
          "fill",
          "fill-opacity",
          "fill-rule",
          "image-rendering",
          "marker",
          "marker-end",
          "marker-mid",
          "marker-start",
          "paint-order",
          "shape-rendering",
          "stroke",
          "stroke-dasharray",
          "stroke-dashoffset",
          "stroke-linecap",
          "stroke-linejoin",
          "stroke-miterlimit",
          "stroke-opacity",
          "stroke-width",
          "text-rendering",
          "baseline-shift",
          "dominant-baseline",
          "glyph-orientation-horizontal",
          "glyph-orientation-vertical",
          "text-anchor",
          "writing-mode"
        ], propertyKeywords = keySet(propertyKeywords_);
        var nonStandardPropertyKeywords_ = [
          "accent-color",
          "aspect-ratio",
          "border-block",
          "border-block-color",
          "border-block-end",
          "border-block-end-color",
          "border-block-end-style",
          "border-block-end-width",
          "border-block-start",
          "border-block-start-color",
          "border-block-start-style",
          "border-block-start-width",
          "border-block-style",
          "border-block-width",
          "border-inline",
          "border-inline-color",
          "border-inline-end",
          "border-inline-end-color",
          "border-inline-end-style",
          "border-inline-end-width",
          "border-inline-start",
          "border-inline-start-color",
          "border-inline-start-style",
          "border-inline-start-width",
          "border-inline-style",
          "border-inline-width",
          "content-visibility",
          "margin-block",
          "margin-block-end",
          "margin-block-start",
          "margin-inline",
          "margin-inline-end",
          "margin-inline-start",
          "overflow-anchor",
          "overscroll-behavior",
          "padding-block",
          "padding-block-end",
          "padding-block-start",
          "padding-inline",
          "padding-inline-end",
          "padding-inline-start",
          "scroll-snap-stop",
          "scrollbar-3d-light-color",
          "scrollbar-arrow-color",
          "scrollbar-base-color",
          "scrollbar-dark-shadow-color",
          "scrollbar-face-color",
          "scrollbar-highlight-color",
          "scrollbar-shadow-color",
          "scrollbar-track-color",
          "searchfield-cancel-button",
          "searchfield-decoration",
          "searchfield-results-button",
          "searchfield-results-decoration",
          "shape-inside",
          "zoom"
        ], nonStandardPropertyKeywords = keySet(nonStandardPropertyKeywords_);
        var fontProperties_ = [
          "font-display",
          "font-family",
          "src",
          "unicode-range",
          "font-variant",
          "font-feature-settings",
          "font-stretch",
          "font-weight",
          "font-style"
        ], fontProperties = keySet(fontProperties_);
        var counterDescriptors_ = [
          "additive-symbols",
          "fallback",
          "negative",
          "pad",
          "prefix",
          "range",
          "speak-as",
          "suffix",
          "symbols",
          "system"
        ], counterDescriptors = keySet(counterDescriptors_);
        var colorKeywords_ = [
          "aliceblue",
          "antiquewhite",
          "aqua",
          "aquamarine",
          "azure",
          "beige",
          "bisque",
          "black",
          "blanchedalmond",
          "blue",
          "blueviolet",
          "brown",
          "burlywood",
          "cadetblue",
          "chartreuse",
          "chocolate",
          "coral",
          "cornflowerblue",
          "cornsilk",
          "crimson",
          "cyan",
          "darkblue",
          "darkcyan",
          "darkgoldenrod",
          "darkgray",
          "darkgreen",
          "darkgrey",
          "darkkhaki",
          "darkmagenta",
          "darkolivegreen",
          "darkorange",
          "darkorchid",
          "darkred",
          "darksalmon",
          "darkseagreen",
          "darkslateblue",
          "darkslategray",
          "darkslategrey",
          "darkturquoise",
          "darkviolet",
          "deeppink",
          "deepskyblue",
          "dimgray",
          "dimgrey",
          "dodgerblue",
          "firebrick",
          "floralwhite",
          "forestgreen",
          "fuchsia",
          "gainsboro",
          "ghostwhite",
          "gold",
          "goldenrod",
          "gray",
          "grey",
          "green",
          "greenyellow",
          "honeydew",
          "hotpink",
          "indianred",
          "indigo",
          "ivory",
          "khaki",
          "lavender",
          "lavenderblush",
          "lawngreen",
          "lemonchiffon",
          "lightblue",
          "lightcoral",
          "lightcyan",
          "lightgoldenrodyellow",
          "lightgray",
          "lightgreen",
          "lightgrey",
          "lightpink",
          "lightsalmon",
          "lightseagreen",
          "lightskyblue",
          "lightslategray",
          "lightslategrey",
          "lightsteelblue",
          "lightyellow",
          "lime",
          "limegreen",
          "linen",
          "magenta",
          "maroon",
          "mediumaquamarine",
          "mediumblue",
          "mediumorchid",
          "mediumpurple",
          "mediumseagreen",
          "mediumslateblue",
          "mediumspringgreen",
          "mediumturquoise",
          "mediumvioletred",
          "midnightblue",
          "mintcream",
          "mistyrose",
          "moccasin",
          "navajowhite",
          "navy",
          "oldlace",
          "olive",
          "olivedrab",
          "orange",
          "orangered",
          "orchid",
          "palegoldenrod",
          "palegreen",
          "paleturquoise",
          "palevioletred",
          "papayawhip",
          "peachpuff",
          "peru",
          "pink",
          "plum",
          "powderblue",
          "purple",
          "rebeccapurple",
          "red",
          "rosybrown",
          "royalblue",
          "saddlebrown",
          "salmon",
          "sandybrown",
          "seagreen",
          "seashell",
          "sienna",
          "silver",
          "skyblue",
          "slateblue",
          "slategray",
          "slategrey",
          "snow",
          "springgreen",
          "steelblue",
          "tan",
          "teal",
          "thistle",
          "tomato",
          "turquoise",
          "violet",
          "wheat",
          "white",
          "whitesmoke",
          "yellow",
          "yellowgreen"
        ], colorKeywords = keySet(colorKeywords_);
        var valueKeywords_ = [
          "above",
          "absolute",
          "activeborder",
          "additive",
          "activecaption",
          "afar",
          "after-white-space",
          "ahead",
          "alias",
          "all",
          "all-scroll",
          "alphabetic",
          "alternate",
          "always",
          "amharic",
          "amharic-abegede",
          "antialiased",
          "appworkspace",
          "arabic-indic",
          "armenian",
          "asterisks",
          "attr",
          "auto",
          "auto-flow",
          "avoid",
          "avoid-column",
          "avoid-page",
          "avoid-region",
          "axis-pan",
          "background",
          "backwards",
          "baseline",
          "below",
          "bidi-override",
          "binary",
          "bengali",
          "blink",
          "block",
          "block-axis",
          "blur",
          "bold",
          "bolder",
          "border",
          "border-box",
          "both",
          "bottom",
          "break",
          "break-all",
          "break-word",
          "brightness",
          "bullets",
          "button",
          "button-bevel",
          "buttonface",
          "buttonhighlight",
          "buttonshadow",
          "buttontext",
          "calc",
          "cambodian",
          "capitalize",
          "caps-lock-indicator",
          "caption",
          "captiontext",
          "caret",
          "cell",
          "center",
          "checkbox",
          "circle",
          "cjk-decimal",
          "cjk-earthly-branch",
          "cjk-heavenly-stem",
          "cjk-ideographic",
          "clear",
          "clip",
          "close-quote",
          "col-resize",
          "collapse",
          "color",
          "color-burn",
          "color-dodge",
          "column",
          "column-reverse",
          "compact",
          "condensed",
          "contain",
          "content",
          "contents",
          "content-box",
          "context-menu",
          "continuous",
          "contrast",
          "copy",
          "counter",
          "counters",
          "cover",
          "crop",
          "cross",
          "crosshair",
          "cubic-bezier",
          "currentcolor",
          "cursive",
          "cyclic",
          "darken",
          "dashed",
          "decimal",
          "decimal-leading-zero",
          "default",
          "default-button",
          "dense",
          "destination-atop",
          "destination-in",
          "destination-out",
          "destination-over",
          "devanagari",
          "difference",
          "disc",
          "discard",
          "disclosure-closed",
          "disclosure-open",
          "document",
          "dot-dash",
          "dot-dot-dash",
          "dotted",
          "double",
          "down",
          "drop-shadow",
          "e-resize",
          "ease",
          "ease-in",
          "ease-in-out",
          "ease-out",
          "element",
          "ellipse",
          "ellipsis",
          "embed",
          "end",
          "ethiopic",
          "ethiopic-abegede",
          "ethiopic-abegede-am-et",
          "ethiopic-abegede-gez",
          "ethiopic-abegede-ti-er",
          "ethiopic-abegede-ti-et",
          "ethiopic-halehame-aa-er",
          "ethiopic-halehame-aa-et",
          "ethiopic-halehame-am-et",
          "ethiopic-halehame-gez",
          "ethiopic-halehame-om-et",
          "ethiopic-halehame-sid-et",
          "ethiopic-halehame-so-et",
          "ethiopic-halehame-ti-er",
          "ethiopic-halehame-ti-et",
          "ethiopic-halehame-tig",
          "ethiopic-numeric",
          "ew-resize",
          "exclusion",
          "expanded",
          "extends",
          "extra-condensed",
          "extra-expanded",
          "fantasy",
          "fast",
          "fill",
          "fill-box",
          "fixed",
          "flat",
          "flex",
          "flex-end",
          "flex-start",
          "footnotes",
          "forwards",
          "from",
          "geometricPrecision",
          "georgian",
          "grayscale",
          "graytext",
          "grid",
          "groove",
          "gujarati",
          "gurmukhi",
          "hand",
          "hangul",
          "hangul-consonant",
          "hard-light",
          "hebrew",
          "help",
          "hidden",
          "hide",
          "higher",
          "highlight",
          "highlighttext",
          "hiragana",
          "hiragana-iroha",
          "horizontal",
          "hsl",
          "hsla",
          "hue",
          "hue-rotate",
          "icon",
          "ignore",
          "inactiveborder",
          "inactivecaption",
          "inactivecaptiontext",
          "infinite",
          "infobackground",
          "infotext",
          "inherit",
          "initial",
          "inline",
          "inline-axis",
          "inline-block",
          "inline-flex",
          "inline-grid",
          "inline-table",
          "inset",
          "inside",
          "intrinsic",
          "invert",
          "italic",
          "japanese-formal",
          "japanese-informal",
          "justify",
          "kannada",
          "katakana",
          "katakana-iroha",
          "keep-all",
          "khmer",
          "korean-hangul-formal",
          "korean-hanja-formal",
          "korean-hanja-informal",
          "landscape",
          "lao",
          "large",
          "larger",
          "left",
          "level",
          "lighter",
          "lighten",
          "line-through",
          "linear",
          "linear-gradient",
          "lines",
          "list-item",
          "listbox",
          "listitem",
          "local",
          "logical",
          "loud",
          "lower",
          "lower-alpha",
          "lower-armenian",
          "lower-greek",
          "lower-hexadecimal",
          "lower-latin",
          "lower-norwegian",
          "lower-roman",
          "lowercase",
          "ltr",
          "luminosity",
          "malayalam",
          "manipulation",
          "match",
          "matrix",
          "matrix3d",
          "media-controls-background",
          "media-current-time-display",
          "media-fullscreen-button",
          "media-mute-button",
          "media-play-button",
          "media-return-to-realtime-button",
          "media-rewind-button",
          "media-seek-back-button",
          "media-seek-forward-button",
          "media-slider",
          "media-sliderthumb",
          "media-time-remaining-display",
          "media-volume-slider",
          "media-volume-slider-container",
          "media-volume-sliderthumb",
          "medium",
          "menu",
          "menulist",
          "menulist-button",
          "menulist-text",
          "menulist-textfield",
          "menutext",
          "message-box",
          "middle",
          "min-intrinsic",
          "mix",
          "mongolian",
          "monospace",
          "move",
          "multiple",
          "multiple_mask_images",
          "multiply",
          "myanmar",
          "n-resize",
          "narrower",
          "ne-resize",
          "nesw-resize",
          "no-close-quote",
          "no-drop",
          "no-open-quote",
          "no-repeat",
          "none",
          "normal",
          "not-allowed",
          "nowrap",
          "ns-resize",
          "numbers",
          "numeric",
          "nw-resize",
          "nwse-resize",
          "oblique",
          "octal",
          "opacity",
          "open-quote",
          "optimizeLegibility",
          "optimizeSpeed",
          "oriya",
          "oromo",
          "outset",
          "outside",
          "outside-shape",
          "overlay",
          "overline",
          "padding",
          "padding-box",
          "painted",
          "page",
          "paused",
          "persian",
          "perspective",
          "pinch-zoom",
          "plus-darker",
          "plus-lighter",
          "pointer",
          "polygon",
          "portrait",
          "pre",
          "pre-line",
          "pre-wrap",
          "preserve-3d",
          "progress",
          "push-button",
          "radial-gradient",
          "radio",
          "read-only",
          "read-write",
          "read-write-plaintext-only",
          "rectangle",
          "region",
          "relative",
          "repeat",
          "repeating-linear-gradient",
          "repeating-radial-gradient",
          "repeat-x",
          "repeat-y",
          "reset",
          "reverse",
          "rgb",
          "rgba",
          "ridge",
          "right",
          "rotate",
          "rotate3d",
          "rotateX",
          "rotateY",
          "rotateZ",
          "round",
          "row",
          "row-resize",
          "row-reverse",
          "rtl",
          "run-in",
          "running",
          "s-resize",
          "sans-serif",
          "saturate",
          "saturation",
          "scale",
          "scale3d",
          "scaleX",
          "scaleY",
          "scaleZ",
          "screen",
          "scroll",
          "scrollbar",
          "scroll-position",
          "se-resize",
          "searchfield",
          "searchfield-cancel-button",
          "searchfield-decoration",
          "searchfield-results-button",
          "searchfield-results-decoration",
          "self-start",
          "self-end",
          "semi-condensed",
          "semi-expanded",
          "separate",
          "sepia",
          "serif",
          "show",
          "sidama",
          "simp-chinese-formal",
          "simp-chinese-informal",
          "single",
          "skew",
          "skewX",
          "skewY",
          "skip-white-space",
          "slide",
          "slider-horizontal",
          "slider-vertical",
          "sliderthumb-horizontal",
          "sliderthumb-vertical",
          "slow",
          "small",
          "small-caps",
          "small-caption",
          "smaller",
          "soft-light",
          "solid",
          "somali",
          "source-atop",
          "source-in",
          "source-out",
          "source-over",
          "space",
          "space-around",
          "space-between",
          "space-evenly",
          "spell-out",
          "square",
          "square-button",
          "start",
          "static",
          "status-bar",
          "stretch",
          "stroke",
          "stroke-box",
          "sub",
          "subpixel-antialiased",
          "svg_masks",
          "super",
          "sw-resize",
          "symbolic",
          "symbols",
          "system-ui",
          "table",
          "table-caption",
          "table-cell",
          "table-column",
          "table-column-group",
          "table-footer-group",
          "table-header-group",
          "table-row",
          "table-row-group",
          "tamil",
          "telugu",
          "text",
          "text-bottom",
          "text-top",
          "textarea",
          "textfield",
          "thai",
          "thick",
          "thin",
          "threeddarkshadow",
          "threedface",
          "threedhighlight",
          "threedlightshadow",
          "threedshadow",
          "tibetan",
          "tigre",
          "tigrinya-er",
          "tigrinya-er-abegede",
          "tigrinya-et",
          "tigrinya-et-abegede",
          "to",
          "top",
          "trad-chinese-formal",
          "trad-chinese-informal",
          "transform",
          "translate",
          "translate3d",
          "translateX",
          "translateY",
          "translateZ",
          "transparent",
          "ultra-condensed",
          "ultra-expanded",
          "underline",
          "unidirectional-pan",
          "unset",
          "up",
          "upper-alpha",
          "upper-armenian",
          "upper-greek",
          "upper-hexadecimal",
          "upper-latin",
          "upper-norwegian",
          "upper-roman",
          "uppercase",
          "urdu",
          "url",
          "var",
          "vertical",
          "vertical-text",
          "view-box",
          "visible",
          "visibleFill",
          "visiblePainted",
          "visibleStroke",
          "visual",
          "w-resize",
          "wait",
          "wave",
          "wider",
          "window",
          "windowframe",
          "windowtext",
          "words",
          "wrap",
          "wrap-reverse",
          "x-large",
          "x-small",
          "xor",
          "xx-large",
          "xx-small"
        ], valueKeywords = keySet(valueKeywords_);
        var allWords = documentTypes_.concat(mediaTypes_).concat(mediaFeatures_).concat(mediaValueKeywords_).concat(propertyKeywords_).concat(nonStandardPropertyKeywords_).concat(colorKeywords_).concat(valueKeywords_);
        CodeMirror2.registerHelper("hintWords", "css", allWords);
        function tokenCComment(stream, state) {
          var maybeEnd = false, ch;
          while ((ch = stream.next()) != null) {
            if (maybeEnd && ch == "/") {
              state.tokenize = null;
              break;
            }
            maybeEnd = ch == "*";
          }
          return ["comment", "comment"];
        }
        CodeMirror2.defineMIME("text/css", {
          documentTypes,
          mediaTypes,
          mediaFeatures,
          mediaValueKeywords,
          propertyKeywords,
          nonStandardPropertyKeywords,
          fontProperties,
          counterDescriptors,
          colorKeywords,
          valueKeywords,
          tokenHooks: {
            "/": function(stream, state) {
              if (!stream.eat("*"))
                return false;
              state.tokenize = tokenCComment;
              return tokenCComment(stream, state);
            }
          },
          name: "css"
        });
        CodeMirror2.defineMIME("text/x-scss", {
          mediaTypes,
          mediaFeatures,
          mediaValueKeywords,
          propertyKeywords,
          nonStandardPropertyKeywords,
          colorKeywords,
          valueKeywords,
          fontProperties,
          allowNested: true,
          lineComment: "//",
          tokenHooks: {
            "/": function(stream, state) {
              if (stream.eat("/")) {
                stream.skipToEnd();
                return ["comment", "comment"];
              } else if (stream.eat("*")) {
                state.tokenize = tokenCComment;
                return tokenCComment(stream, state);
              } else {
                return ["operator", "operator"];
              }
            },
            ":": function(stream) {
              if (stream.match(/^\s*\{/, false))
                return [null, null];
              return false;
            },
            "$": function(stream) {
              stream.match(/^[\w-]+/);
              if (stream.match(/^\s*:/, false))
                return ["variable-2", "variable-definition"];
              return ["variable-2", "variable"];
            },
            "#": function(stream) {
              if (!stream.eat("{"))
                return false;
              return [null, "interpolation"];
            }
          },
          name: "css",
          helperType: "scss"
        });
        CodeMirror2.defineMIME("text/x-less", {
          mediaTypes,
          mediaFeatures,
          mediaValueKeywords,
          propertyKeywords,
          nonStandardPropertyKeywords,
          colorKeywords,
          valueKeywords,
          fontProperties,
          allowNested: true,
          lineComment: "//",
          tokenHooks: {
            "/": function(stream, state) {
              if (stream.eat("/")) {
                stream.skipToEnd();
                return ["comment", "comment"];
              } else if (stream.eat("*")) {
                state.tokenize = tokenCComment;
                return tokenCComment(stream, state);
              } else {
                return ["operator", "operator"];
              }
            },
            "@": function(stream) {
              if (stream.eat("{"))
                return [null, "interpolation"];
              if (stream.match(/^(charset|document|font-face|import|(-(moz|ms|o|webkit)-)?keyframes|media|namespace|page|supports)\b/i, false))
                return false;
              stream.eatWhile(/[\w\\\-]/);
              if (stream.match(/^\s*:/, false))
                return ["variable-2", "variable-definition"];
              return ["variable-2", "variable"];
            },
            "&": function() {
              return ["atom", "atom"];
            }
          },
          name: "css",
          helperType: "less"
        });
        CodeMirror2.defineMIME("text/x-gss", {
          documentTypes,
          mediaTypes,
          mediaFeatures,
          propertyKeywords,
          nonStandardPropertyKeywords,
          fontProperties,
          counterDescriptors,
          colorKeywords,
          valueKeywords,
          supportsAtComponent: true,
          tokenHooks: {
            "/": function(stream, state) {
              if (!stream.eat("*"))
                return false;
              state.tokenize = tokenCComment;
              return tokenCComment(stream, state);
            }
          },
          name: "css",
          helperType: "gss"
        });
      });
    }
  ),
  /***/
  520: (
    /***/
    (__unused_webpack_module, __unused_webpack_exports, __webpack_require__2) => {
      (function(mod) {
        if (true)
          mod(__webpack_require__2(237), __webpack_require__2(576), __webpack_require__2(792), __webpack_require__2(656));
        else {
        }
      })(function(CodeMirror2) {
        "use strict";
        var defaultTags = {
          script: [
            ["lang", /(javascript|babel)/i, "javascript"],
            ["type", /^(?:text|application)\/(?:x-)?(?:java|ecma)script$|^module$|^$/i, "javascript"],
            ["type", /./, "text/plain"],
            [null, null, "javascript"]
          ],
          style: [
            ["lang", /^css$/i, "css"],
            ["type", /^(text\/)?(x-)?(stylesheet|css)$/i, "css"],
            ["type", /./, "text/plain"],
            [null, null, "css"]
          ]
        };
        function maybeBackup(stream, pat, style) {
          var cur = stream.current(), close = cur.search(pat);
          if (close > -1) {
            stream.backUp(cur.length - close);
          } else if (cur.match(/<\/?$/)) {
            stream.backUp(cur.length);
            if (!stream.match(pat, false))
              stream.match(cur);
          }
          return style;
        }
        var attrRegexpCache = {};
        function getAttrRegexp(attr) {
          var regexp = attrRegexpCache[attr];
          if (regexp)
            return regexp;
          return attrRegexpCache[attr] = new RegExp("\\s+" + attr + `\\s*=\\s*('|")?([^'"]+)('|")?\\s*`);
        }
        function getAttrValue(text, attr) {
          var match = text.match(getAttrRegexp(attr));
          return match ? /^\s*(.*?)\s*$/.exec(match[2])[1] : "";
        }
        function getTagRegexp(tagName2, anchored) {
          return new RegExp((anchored ? "^" : "") + "</s*" + tagName2 + "s*>", "i");
        }
        function addTags(from, to) {
          for (var tag in from) {
            var dest = to[tag] || (to[tag] = []);
            var source = from[tag];
            for (var i = source.length - 1; i >= 0; i--)
              dest.unshift(source[i]);
          }
        }
        function findMatchingMode(tagInfo, tagText) {
          for (var i = 0; i < tagInfo.length; i++) {
            var spec = tagInfo[i];
            if (!spec[0] || spec[1].test(getAttrValue(tagText, spec[0])))
              return spec[2];
          }
        }
        CodeMirror2.defineMode("htmlmixed", function(config2, parserConfig) {
          var htmlMode = CodeMirror2.getMode(config2, {
            name: "xml",
            htmlMode: true,
            multilineTagIndentFactor: parserConfig.multilineTagIndentFactor,
            multilineTagIndentPastTag: parserConfig.multilineTagIndentPastTag,
            allowMissingTagName: parserConfig.allowMissingTagName
          });
          var tags = {};
          var configTags = parserConfig && parserConfig.tags, configScript = parserConfig && parserConfig.scriptTypes;
          addTags(defaultTags, tags);
          if (configTags)
            addTags(configTags, tags);
          if (configScript)
            for (var i = configScript.length - 1; i >= 0; i--)
              tags.script.unshift(["type", configScript[i].matches, configScript[i].mode]);
          function html2(stream, state) {
            var style = htmlMode.token(stream, state.htmlState), tag = /\btag\b/.test(style), tagName2;
            if (tag && !/[<>\s\/]/.test(stream.current()) && (tagName2 = state.htmlState.tagName && state.htmlState.tagName.toLowerCase()) && tags.hasOwnProperty(tagName2)) {
              state.inTag = tagName2 + " ";
            } else if (state.inTag && tag && />$/.test(stream.current())) {
              var inTag = /^([\S]+) (.*)/.exec(state.inTag);
              state.inTag = null;
              var modeSpec = stream.current() == ">" && findMatchingMode(tags[inTag[1]], inTag[2]);
              var mode = CodeMirror2.getMode(config2, modeSpec);
              var endTagA = getTagRegexp(inTag[1], true), endTag = getTagRegexp(inTag[1], false);
              state.token = function(stream2, state2) {
                if (stream2.match(endTagA, false)) {
                  state2.token = html2;
                  state2.localState = state2.localMode = null;
                  return null;
                }
                return maybeBackup(stream2, endTag, state2.localMode.token(stream2, state2.localState));
              };
              state.localMode = mode;
              state.localState = CodeMirror2.startState(mode, htmlMode.indent(state.htmlState, "", ""));
            } else if (state.inTag) {
              state.inTag += stream.current();
              if (stream.eol())
                state.inTag += " ";
            }
            return style;
          }
          ;
          return {
            startState: function() {
              var state = CodeMirror2.startState(htmlMode);
              return { token: html2, inTag: null, localMode: null, localState: null, htmlState: state };
            },
            copyState: function(state) {
              var local;
              if (state.localState) {
                local = CodeMirror2.copyState(state.localMode, state.localState);
              }
              return {
                token: state.token,
                inTag: state.inTag,
                localMode: state.localMode,
                localState: local,
                htmlState: CodeMirror2.copyState(htmlMode, state.htmlState)
              };
            },
            token: function(stream, state) {
              return state.token(stream, state);
            },
            indent: function(state, textAfter, line) {
              if (!state.localMode || /^\s*<\//.test(textAfter))
                return htmlMode.indent(state.htmlState, textAfter, line);
              else if (state.localMode.indent)
                return state.localMode.indent(state.localState, textAfter, line);
              else
                return CodeMirror2.Pass;
            },
            innerMode: function(state) {
              return { state: state.localState || state.htmlState, mode: state.localMode || htmlMode };
            }
          };
        }, "xml", "javascript", "css");
        CodeMirror2.defineMIME("text/html", "htmlmixed");
      });
    }
  ),
  /***/
  792: (
    /***/
    (__unused_webpack_module, __unused_webpack_exports, __webpack_require__2) => {
      (function(mod) {
        if (true)
          mod(__webpack_require__2(237));
        else {
        }
      })(function(CodeMirror2) {
        "use strict";
        CodeMirror2.defineMode("javascript", function(config2, parserConfig) {
          var indentUnit = config2.indentUnit;
          var statementIndent = parserConfig.statementIndent;
          var jsonldMode = parserConfig.jsonld;
          var jsonMode = parserConfig.json || jsonldMode;
          var trackScope = parserConfig.trackScope !== false;
          var isTS = parserConfig.typescript;
          var wordRE = parserConfig.wordCharacters || /[\w$\xa1-\uffff]/;
          var keywords = function() {
            function kw(type3) {
              return { type: type3, style: "keyword" };
            }
            var A = kw("keyword a"), B = kw("keyword b"), C = kw("keyword c"), D = kw("keyword d");
            var operator = kw("operator"), atom = { type: "atom", style: "atom" };
            return {
              "if": kw("if"),
              "while": A,
              "with": A,
              "else": B,
              "do": B,
              "try": B,
              "finally": B,
              "return": D,
              "break": D,
              "continue": D,
              "new": kw("new"),
              "delete": C,
              "void": C,
              "throw": C,
              "debugger": kw("debugger"),
              "var": kw("var"),
              "const": kw("var"),
              "let": kw("var"),
              "function": kw("function"),
              "catch": kw("catch"),
              "for": kw("for"),
              "switch": kw("switch"),
              "case": kw("case"),
              "default": kw("default"),
              "in": operator,
              "typeof": operator,
              "instanceof": operator,
              "true": atom,
              "false": atom,
              "null": atom,
              "undefined": atom,
              "NaN": atom,
              "Infinity": atom,
              "this": kw("this"),
              "class": kw("class"),
              "super": kw("atom"),
              "yield": C,
              "export": kw("export"),
              "import": kw("import"),
              "extends": C,
              "await": C
            };
          }();
          var isOperatorChar = /[+\-*&%=<>!?|~^@]/;
          var isJsonldKeyword = /^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;
          function readRegexp(stream) {
            var escaped = false, next, inSet = false;
            while ((next = stream.next()) != null) {
              if (!escaped) {
                if (next == "/" && !inSet)
                  return;
                if (next == "[")
                  inSet = true;
                else if (inSet && next == "]")
                  inSet = false;
              }
              escaped = !escaped && next == "\\";
            }
          }
          var type2, content;
          function ret(tp, style, cont2) {
            type2 = tp;
            content = cont2;
            return style;
          }
          function tokenBase(stream, state) {
            var ch = stream.next();
            if (ch == '"' || ch == "'") {
              state.tokenize = tokenString(ch);
              return state.tokenize(stream, state);
            } else if (ch == "." && stream.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/)) {
              return ret("number", "number");
            } else if (ch == "." && stream.match("..")) {
              return ret("spread", "meta");
            } else if (/[\[\]{}\(\),;\:\.]/.test(ch)) {
              return ret(ch);
            } else if (ch == "=" && stream.eat(">")) {
              return ret("=>", "operator");
            } else if (ch == "0" && stream.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/)) {
              return ret("number", "number");
            } else if (/\d/.test(ch)) {
              stream.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/);
              return ret("number", "number");
            } else if (ch == "/") {
              if (stream.eat("*")) {
                state.tokenize = tokenComment;
                return tokenComment(stream, state);
              } else if (stream.eat("/")) {
                stream.skipToEnd();
                return ret("comment", "comment");
              } else if (expressionAllowed(stream, state, 1)) {
                readRegexp(stream);
                stream.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/);
                return ret("regexp", "string-2");
              } else {
                stream.eat("=");
                return ret("operator", "operator", stream.current());
              }
            } else if (ch == "`") {
              state.tokenize = tokenQuasi;
              return tokenQuasi(stream, state);
            } else if (ch == "#" && stream.peek() == "!") {
              stream.skipToEnd();
              return ret("meta", "meta");
            } else if (ch == "#" && stream.eatWhile(wordRE)) {
              return ret("variable", "property");
            } else if (ch == "<" && stream.match("!--") || ch == "-" && stream.match("->") && !/\S/.test(stream.string.slice(0, stream.start))) {
              stream.skipToEnd();
              return ret("comment", "comment");
            } else if (isOperatorChar.test(ch)) {
              if (ch != ">" || !state.lexical || state.lexical.type != ">") {
                if (stream.eat("=")) {
                  if (ch == "!" || ch == "=")
                    stream.eat("=");
                } else if (/[<>*+\-|&?]/.test(ch)) {
                  stream.eat(ch);
                  if (ch == ">")
                    stream.eat(ch);
                }
              }
              if (ch == "?" && stream.eat("."))
                return ret(".");
              return ret("operator", "operator", stream.current());
            } else if (wordRE.test(ch)) {
              stream.eatWhile(wordRE);
              var word = stream.current();
              if (state.lastType != ".") {
                if (keywords.propertyIsEnumerable(word)) {
                  var kw = keywords[word];
                  return ret(kw.type, kw.style, word);
                }
                if (word == "async" && stream.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/, false))
                  return ret("async", "keyword", word);
              }
              return ret("variable", "variable", word);
            }
          }
          function tokenString(quote) {
            return function(stream, state) {
              var escaped = false, next;
              if (jsonldMode && stream.peek() == "@" && stream.match(isJsonldKeyword)) {
                state.tokenize = tokenBase;
                return ret("jsonld-keyword", "meta");
              }
              while ((next = stream.next()) != null) {
                if (next == quote && !escaped)
                  break;
                escaped = !escaped && next == "\\";
              }
              if (!escaped)
                state.tokenize = tokenBase;
              return ret("string", "string");
            };
          }
          function tokenComment(stream, state) {
            var maybeEnd = false, ch;
            while (ch = stream.next()) {
              if (ch == "/" && maybeEnd) {
                state.tokenize = tokenBase;
                break;
              }
              maybeEnd = ch == "*";
            }
            return ret("comment", "comment");
          }
          function tokenQuasi(stream, state) {
            var escaped = false, next;
            while ((next = stream.next()) != null) {
              if (!escaped && (next == "`" || next == "$" && stream.eat("{"))) {
                state.tokenize = tokenBase;
                break;
              }
              escaped = !escaped && next == "\\";
            }
            return ret("quasi", "string-2", stream.current());
          }
          var brackets = "([{}])";
          function findFatArrow(stream, state) {
            if (state.fatArrowAt)
              state.fatArrowAt = null;
            var arrow = stream.string.indexOf("=>", stream.start);
            if (arrow < 0)
              return;
            if (isTS) {
              var m = /:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(stream.string.slice(stream.start, arrow));
              if (m)
                arrow = m.index;
            }
            var depth = 0, sawSomething = false;
            for (var pos = arrow - 1; pos >= 0; --pos) {
              var ch = stream.string.charAt(pos);
              var bracket = brackets.indexOf(ch);
              if (bracket >= 0 && bracket < 3) {
                if (!depth) {
                  ++pos;
                  break;
                }
                if (--depth == 0) {
                  if (ch == "(")
                    sawSomething = true;
                  break;
                }
              } else if (bracket >= 3 && bracket < 6) {
                ++depth;
              } else if (wordRE.test(ch)) {
                sawSomething = true;
              } else if (/["'\/`]/.test(ch)) {
                for (; ; --pos) {
                  if (pos == 0)
                    return;
                  var next = stream.string.charAt(pos - 1);
                  if (next == ch && stream.string.charAt(pos - 2) != "\\") {
                    pos--;
                    break;
                  }
                }
              } else if (sawSomething && !depth) {
                ++pos;
                break;
              }
            }
            if (sawSomething && !depth)
              state.fatArrowAt = pos;
          }
          var atomicTypes = {
            "atom": true,
            "number": true,
            "variable": true,
            "string": true,
            "regexp": true,
            "this": true,
            "import": true,
            "jsonld-keyword": true
          };
          function JSLexical(indented, column, type3, align, prev, info) {
            this.indented = indented;
            this.column = column;
            this.type = type3;
            this.prev = prev;
            this.info = info;
            if (align != null)
              this.align = align;
          }
          function inScope(state, varname) {
            if (!trackScope)
              return false;
            for (var v = state.localVars; v; v = v.next)
              if (v.name == varname)
                return true;
            for (var cx2 = state.context; cx2; cx2 = cx2.prev) {
              for (var v = cx2.vars; v; v = v.next)
                if (v.name == varname)
                  return true;
            }
          }
          function parseJS(state, style, type3, content2, stream) {
            var cc = state.cc;
            cx.state = state;
            cx.stream = stream;
            cx.marked = null, cx.cc = cc;
            cx.style = style;
            if (!state.lexical.hasOwnProperty("align"))
              state.lexical.align = true;
            while (true) {
              var combinator = cc.length ? cc.pop() : jsonMode ? expression : statement;
              if (combinator(type3, content2)) {
                while (cc.length && cc[cc.length - 1].lex)
                  cc.pop()();
                if (cx.marked)
                  return cx.marked;
                if (type3 == "variable" && inScope(state, content2))
                  return "variable-2";
                return style;
              }
            }
          }
          var cx = { state: null, column: null, marked: null, cc: null };
          function pass() {
            for (var i = arguments.length - 1; i >= 0; i--)
              cx.cc.push(arguments[i]);
          }
          function cont() {
            pass.apply(null, arguments);
            return true;
          }
          function inList(name, list) {
            for (var v = list; v; v = v.next)
              if (v.name == name)
                return true;
            return false;
          }
          function register(varname) {
            var state = cx.state;
            cx.marked = "def";
            if (!trackScope)
              return;
            if (state.context) {
              if (state.lexical.info == "var" && state.context && state.context.block) {
                var newContext = registerVarScoped(varname, state.context);
                if (newContext != null) {
                  state.context = newContext;
                  return;
                }
              } else if (!inList(varname, state.localVars)) {
                state.localVars = new Var(varname, state.localVars);
                return;
              }
            }
            if (parserConfig.globalVars && !inList(varname, state.globalVars))
              state.globalVars = new Var(varname, state.globalVars);
          }
          function registerVarScoped(varname, context) {
            if (!context) {
              return null;
            } else if (context.block) {
              var inner = registerVarScoped(varname, context.prev);
              if (!inner)
                return null;
              if (inner == context.prev)
                return context;
              return new Context(inner, context.vars, true);
            } else if (inList(varname, context.vars)) {
              return context;
            } else {
              return new Context(context.prev, new Var(varname, context.vars), false);
            }
          }
          function isModifier(name) {
            return name == "public" || name == "private" || name == "protected" || name == "abstract" || name == "readonly";
          }
          function Context(prev, vars, block2) {
            this.prev = prev;
            this.vars = vars;
            this.block = block2;
          }
          function Var(name, next) {
            this.name = name;
            this.next = next;
          }
          var defaultVars = new Var("this", new Var("arguments", null));
          function pushcontext() {
            cx.state.context = new Context(cx.state.context, cx.state.localVars, false);
            cx.state.localVars = defaultVars;
          }
          function pushblockcontext() {
            cx.state.context = new Context(cx.state.context, cx.state.localVars, true);
            cx.state.localVars = null;
          }
          function popcontext() {
            cx.state.localVars = cx.state.context.vars;
            cx.state.context = cx.state.context.prev;
          }
          popcontext.lex = true;
          function pushlex(type3, info) {
            var result = function() {
              var state = cx.state, indent = state.indented;
              if (state.lexical.type == "stat")
                indent = state.lexical.indented;
              else
                for (var outer = state.lexical; outer && outer.type == ")" && outer.align; outer = outer.prev)
                  indent = outer.indented;
              state.lexical = new JSLexical(indent, cx.stream.column(), type3, null, state.lexical, info);
            };
            result.lex = true;
            return result;
          }
          function poplex() {
            var state = cx.state;
            if (state.lexical.prev) {
              if (state.lexical.type == ")")
                state.indented = state.lexical.indented;
              state.lexical = state.lexical.prev;
            }
          }
          poplex.lex = true;
          function expect(wanted) {
            function exp(type3) {
              if (type3 == wanted)
                return cont();
              else if (wanted == ";" || type3 == "}" || type3 == ")" || type3 == "]")
                return pass();
              else
                return cont(exp);
            }
            ;
            return exp;
          }
          function statement(type3, value) {
            if (type3 == "var")
              return cont(pushlex("vardef", value), vardef, expect(";"), poplex);
            if (type3 == "keyword a")
              return cont(pushlex("form"), parenExpr, statement, poplex);
            if (type3 == "keyword b")
              return cont(pushlex("form"), statement, poplex);
            if (type3 == "keyword d")
              return cx.stream.match(/^\s*$/, false) ? cont() : cont(pushlex("stat"), maybeexpression, expect(";"), poplex);
            if (type3 == "debugger")
              return cont(expect(";"));
            if (type3 == "{")
              return cont(pushlex("}"), pushblockcontext, block, poplex, popcontext);
            if (type3 == ";")
              return cont();
            if (type3 == "if") {
              if (cx.state.lexical.info == "else" && cx.state.cc[cx.state.cc.length - 1] == poplex)
                cx.state.cc.pop()();
              return cont(pushlex("form"), parenExpr, statement, poplex, maybeelse);
            }
            if (type3 == "function")
              return cont(functiondef);
            if (type3 == "for")
              return cont(pushlex("form"), pushblockcontext, forspec, statement, popcontext, poplex);
            if (type3 == "class" || isTS && value == "interface") {
              cx.marked = "keyword";
              return cont(pushlex("form", type3 == "class" ? type3 : value), className, poplex);
            }
            if (type3 == "variable") {
              if (isTS && value == "declare") {
                cx.marked = "keyword";
                return cont(statement);
              } else if (isTS && (value == "module" || value == "enum" || value == "type") && cx.stream.match(/^\s*\w/, false)) {
                cx.marked = "keyword";
                if (value == "enum")
                  return cont(enumdef);
                else if (value == "type")
                  return cont(typename, expect("operator"), typeexpr, expect(";"));
                else
                  return cont(pushlex("form"), pattern, expect("{"), pushlex("}"), block, poplex, poplex);
              } else if (isTS && value == "namespace") {
                cx.marked = "keyword";
                return cont(pushlex("form"), expression, statement, poplex);
              } else if (isTS && value == "abstract") {
                cx.marked = "keyword";
                return cont(statement);
              } else {
                return cont(pushlex("stat"), maybelabel);
              }
            }
            if (type3 == "switch")
              return cont(
                pushlex("form"),
                parenExpr,
                expect("{"),
                pushlex("}", "switch"),
                pushblockcontext,
                block,
                poplex,
                poplex,
                popcontext
              );
            if (type3 == "case")
              return cont(expression, expect(":"));
            if (type3 == "default")
              return cont(expect(":"));
            if (type3 == "catch")
              return cont(pushlex("form"), pushcontext, maybeCatchBinding, statement, poplex, popcontext);
            if (type3 == "export")
              return cont(pushlex("stat"), afterExport, poplex);
            if (type3 == "import")
              return cont(pushlex("stat"), afterImport, poplex);
            if (type3 == "async")
              return cont(statement);
            if (value == "@")
              return cont(expression, statement);
            return pass(pushlex("stat"), expression, expect(";"), poplex);
          }
          function maybeCatchBinding(type3) {
            if (type3 == "(")
              return cont(funarg, expect(")"));
          }
          function expression(type3, value) {
            return expressionInner(type3, value, false);
          }
          function expressionNoComma(type3, value) {
            return expressionInner(type3, value, true);
          }
          function parenExpr(type3) {
            if (type3 != "(")
              return pass();
            return cont(pushlex(")"), maybeexpression, expect(")"), poplex);
          }
          function expressionInner(type3, value, noComma) {
            if (cx.state.fatArrowAt == cx.stream.start) {
              var body = noComma ? arrowBodyNoComma : arrowBody;
              if (type3 == "(")
                return cont(pushcontext, pushlex(")"), commasep(funarg, ")"), poplex, expect("=>"), body, popcontext);
              else if (type3 == "variable")
                return pass(pushcontext, pattern, expect("=>"), body, popcontext);
            }
            var maybeop = noComma ? maybeoperatorNoComma : maybeoperatorComma;
            if (atomicTypes.hasOwnProperty(type3))
              return cont(maybeop);
            if (type3 == "function")
              return cont(functiondef, maybeop);
            if (type3 == "class" || isTS && value == "interface") {
              cx.marked = "keyword";
              return cont(pushlex("form"), classExpression, poplex);
            }
            if (type3 == "keyword c" || type3 == "async")
              return cont(noComma ? expressionNoComma : expression);
            if (type3 == "(")
              return cont(pushlex(")"), maybeexpression, expect(")"), poplex, maybeop);
            if (type3 == "operator" || type3 == "spread")
              return cont(noComma ? expressionNoComma : expression);
            if (type3 == "[")
              return cont(pushlex("]"), arrayLiteral, poplex, maybeop);
            if (type3 == "{")
              return contCommasep(objprop, "}", null, maybeop);
            if (type3 == "quasi")
              return pass(quasi, maybeop);
            if (type3 == "new")
              return cont(maybeTarget(noComma));
            return cont();
          }
          function maybeexpression(type3) {
            if (type3.match(/[;\}\)\],]/))
              return pass();
            return pass(expression);
          }
          function maybeoperatorComma(type3, value) {
            if (type3 == ",")
              return cont(maybeexpression);
            return maybeoperatorNoComma(type3, value, false);
          }
          function maybeoperatorNoComma(type3, value, noComma) {
            var me = noComma == false ? maybeoperatorComma : maybeoperatorNoComma;
            var expr = noComma == false ? expression : expressionNoComma;
            if (type3 == "=>")
              return cont(pushcontext, noComma ? arrowBodyNoComma : arrowBody, popcontext);
            if (type3 == "operator") {
              if (/\+\+|--/.test(value) || isTS && value == "!")
                return cont(me);
              if (isTS && value == "<" && cx.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/, false))
                return cont(pushlex(">"), commasep(typeexpr, ">"), poplex, me);
              if (value == "?")
                return cont(expression, expect(":"), expr);
              return cont(expr);
            }
            if (type3 == "quasi") {
              return pass(quasi, me);
            }
            if (type3 == ";")
              return;
            if (type3 == "(")
              return contCommasep(expressionNoComma, ")", "call", me);
            if (type3 == ".")
              return cont(property, me);
            if (type3 == "[")
              return cont(pushlex("]"), maybeexpression, expect("]"), poplex, me);
            if (isTS && value == "as") {
              cx.marked = "keyword";
              return cont(typeexpr, me);
            }
            if (type3 == "regexp") {
              cx.state.lastType = cx.marked = "operator";
              cx.stream.backUp(cx.stream.pos - cx.stream.start - 1);
              return cont(expr);
            }
          }
          function quasi(type3, value) {
            if (type3 != "quasi")
              return pass();
            if (value.slice(value.length - 2) != "${")
              return cont(quasi);
            return cont(maybeexpression, continueQuasi);
          }
          function continueQuasi(type3) {
            if (type3 == "}") {
              cx.marked = "string-2";
              cx.state.tokenize = tokenQuasi;
              return cont(quasi);
            }
          }
          function arrowBody(type3) {
            findFatArrow(cx.stream, cx.state);
            return pass(type3 == "{" ? statement : expression);
          }
          function arrowBodyNoComma(type3) {
            findFatArrow(cx.stream, cx.state);
            return pass(type3 == "{" ? statement : expressionNoComma);
          }
          function maybeTarget(noComma) {
            return function(type3) {
              if (type3 == ".")
                return cont(noComma ? targetNoComma : target);
              else if (type3 == "variable" && isTS)
                return cont(maybeTypeArgs, noComma ? maybeoperatorNoComma : maybeoperatorComma);
              else
                return pass(noComma ? expressionNoComma : expression);
            };
          }
          function target(_, value) {
            if (value == "target") {
              cx.marked = "keyword";
              return cont(maybeoperatorComma);
            }
          }
          function targetNoComma(_, value) {
            if (value == "target") {
              cx.marked = "keyword";
              return cont(maybeoperatorNoComma);
            }
          }
          function maybelabel(type3) {
            if (type3 == ":")
              return cont(poplex, statement);
            return pass(maybeoperatorComma, expect(";"), poplex);
          }
          function property(type3) {
            if (type3 == "variable") {
              cx.marked = "property";
              return cont();
            }
          }
          function objprop(type3, value) {
            if (type3 == "async") {
              cx.marked = "property";
              return cont(objprop);
            } else if (type3 == "variable" || cx.style == "keyword") {
              cx.marked = "property";
              if (value == "get" || value == "set")
                return cont(getterSetter);
              var m;
              if (isTS && cx.state.fatArrowAt == cx.stream.start && (m = cx.stream.match(/^\s*:\s*/, false)))
                cx.state.fatArrowAt = cx.stream.pos + m[0].length;
              return cont(afterprop);
            } else if (type3 == "number" || type3 == "string") {
              cx.marked = jsonldMode ? "property" : cx.style + " property";
              return cont(afterprop);
            } else if (type3 == "jsonld-keyword") {
              return cont(afterprop);
            } else if (isTS && isModifier(value)) {
              cx.marked = "keyword";
              return cont(objprop);
            } else if (type3 == "[") {
              return cont(expression, maybetype, expect("]"), afterprop);
            } else if (type3 == "spread") {
              return cont(expressionNoComma, afterprop);
            } else if (value == "*") {
              cx.marked = "keyword";
              return cont(objprop);
            } else if (type3 == ":") {
              return pass(afterprop);
            }
          }
          function getterSetter(type3) {
            if (type3 != "variable")
              return pass(afterprop);
            cx.marked = "property";
            return cont(functiondef);
          }
          function afterprop(type3) {
            if (type3 == ":")
              return cont(expressionNoComma);
            if (type3 == "(")
              return pass(functiondef);
          }
          function commasep(what, end, sep) {
            function proceed(type3, value) {
              if (sep ? sep.indexOf(type3) > -1 : type3 == ",") {
                var lex = cx.state.lexical;
                if (lex.info == "call")
                  lex.pos = (lex.pos || 0) + 1;
                return cont(function(type4, value2) {
                  if (type4 == end || value2 == end)
                    return pass();
                  return pass(what);
                }, proceed);
              }
              if (type3 == end || value == end)
                return cont();
              if (sep && sep.indexOf(";") > -1)
                return pass(what);
              return cont(expect(end));
            }
            return function(type3, value) {
              if (type3 == end || value == end)
                return cont();
              return pass(what, proceed);
            };
          }
          function contCommasep(what, end, info) {
            for (var i = 3; i < arguments.length; i++)
              cx.cc.push(arguments[i]);
            return cont(pushlex(end, info), commasep(what, end), poplex);
          }
          function block(type3) {
            if (type3 == "}")
              return cont();
            return pass(statement, block);
          }
          function maybetype(type3, value) {
            if (isTS) {
              if (type3 == ":")
                return cont(typeexpr);
              if (value == "?")
                return cont(maybetype);
            }
          }
          function maybetypeOrIn(type3, value) {
            if (isTS && (type3 == ":" || value == "in"))
              return cont(typeexpr);
          }
          function mayberettype(type3) {
            if (isTS && type3 == ":") {
              if (cx.stream.match(/^\s*\w+\s+is\b/, false))
                return cont(expression, isKW, typeexpr);
              else
                return cont(typeexpr);
            }
          }
          function isKW(_, value) {
            if (value == "is") {
              cx.marked = "keyword";
              return cont();
            }
          }
          function typeexpr(type3, value) {
            if (value == "keyof" || value == "typeof" || value == "infer" || value == "readonly") {
              cx.marked = "keyword";
              return cont(value == "typeof" ? expressionNoComma : typeexpr);
            }
            if (type3 == "variable" || value == "void") {
              cx.marked = "type";
              return cont(afterType);
            }
            if (value == "|" || value == "&")
              return cont(typeexpr);
            if (type3 == "string" || type3 == "number" || type3 == "atom")
              return cont(afterType);
            if (type3 == "[")
              return cont(pushlex("]"), commasep(typeexpr, "]", ","), poplex, afterType);
            if (type3 == "{")
              return cont(pushlex("}"), typeprops, poplex, afterType);
            if (type3 == "(")
              return cont(commasep(typearg, ")"), maybeReturnType, afterType);
            if (type3 == "<")
              return cont(commasep(typeexpr, ">"), typeexpr);
            if (type3 == "quasi") {
              return pass(quasiType, afterType);
            }
          }
          function maybeReturnType(type3) {
            if (type3 == "=>")
              return cont(typeexpr);
          }
          function typeprops(type3) {
            if (type3.match(/[\}\)\]]/))
              return cont();
            if (type3 == "," || type3 == ";")
              return cont(typeprops);
            return pass(typeprop, typeprops);
          }
          function typeprop(type3, value) {
            if (type3 == "variable" || cx.style == "keyword") {
              cx.marked = "property";
              return cont(typeprop);
            } else if (value == "?" || type3 == "number" || type3 == "string") {
              return cont(typeprop);
            } else if (type3 == ":") {
              return cont(typeexpr);
            } else if (type3 == "[") {
              return cont(expect("variable"), maybetypeOrIn, expect("]"), typeprop);
            } else if (type3 == "(") {
              return pass(functiondecl, typeprop);
            } else if (!type3.match(/[;\}\)\],]/)) {
              return cont();
            }
          }
          function quasiType(type3, value) {
            if (type3 != "quasi")
              return pass();
            if (value.slice(value.length - 2) != "${")
              return cont(quasiType);
            return cont(typeexpr, continueQuasiType);
          }
          function continueQuasiType(type3) {
            if (type3 == "}") {
              cx.marked = "string-2";
              cx.state.tokenize = tokenQuasi;
              return cont(quasiType);
            }
          }
          function typearg(type3, value) {
            if (type3 == "variable" && cx.stream.match(/^\s*[?:]/, false) || value == "?")
              return cont(typearg);
            if (type3 == ":")
              return cont(typeexpr);
            if (type3 == "spread")
              return cont(typearg);
            return pass(typeexpr);
          }
          function afterType(type3, value) {
            if (value == "<")
              return cont(pushlex(">"), commasep(typeexpr, ">"), poplex, afterType);
            if (value == "|" || type3 == "." || value == "&")
              return cont(typeexpr);
            if (type3 == "[")
              return cont(typeexpr, expect("]"), afterType);
            if (value == "extends" || value == "implements") {
              cx.marked = "keyword";
              return cont(typeexpr);
            }
            if (value == "?")
              return cont(typeexpr, expect(":"), typeexpr);
          }
          function maybeTypeArgs(_, value) {
            if (value == "<")
              return cont(pushlex(">"), commasep(typeexpr, ">"), poplex, afterType);
          }
          function typeparam() {
            return pass(typeexpr, maybeTypeDefault);
          }
          function maybeTypeDefault(_, value) {
            if (value == "=")
              return cont(typeexpr);
          }
          function vardef(_, value) {
            if (value == "enum") {
              cx.marked = "keyword";
              return cont(enumdef);
            }
            return pass(pattern, maybetype, maybeAssign, vardefCont);
          }
          function pattern(type3, value) {
            if (isTS && isModifier(value)) {
              cx.marked = "keyword";
              return cont(pattern);
            }
            if (type3 == "variable") {
              register(value);
              return cont();
            }
            if (type3 == "spread")
              return cont(pattern);
            if (type3 == "[")
              return contCommasep(eltpattern, "]");
            if (type3 == "{")
              return contCommasep(proppattern, "}");
          }
          function proppattern(type3, value) {
            if (type3 == "variable" && !cx.stream.match(/^\s*:/, false)) {
              register(value);
              return cont(maybeAssign);
            }
            if (type3 == "variable")
              cx.marked = "property";
            if (type3 == "spread")
              return cont(pattern);
            if (type3 == "}")
              return pass();
            if (type3 == "[")
              return cont(expression, expect("]"), expect(":"), proppattern);
            return cont(expect(":"), pattern, maybeAssign);
          }
          function eltpattern() {
            return pass(pattern, maybeAssign);
          }
          function maybeAssign(_type, value) {
            if (value == "=")
              return cont(expressionNoComma);
          }
          function vardefCont(type3) {
            if (type3 == ",")
              return cont(vardef);
          }
          function maybeelse(type3, value) {
            if (type3 == "keyword b" && value == "else")
              return cont(pushlex("form", "else"), statement, poplex);
          }
          function forspec(type3, value) {
            if (value == "await")
              return cont(forspec);
            if (type3 == "(")
              return cont(pushlex(")"), forspec1, poplex);
          }
          function forspec1(type3) {
            if (type3 == "var")
              return cont(vardef, forspec2);
            if (type3 == "variable")
              return cont(forspec2);
            return pass(forspec2);
          }
          function forspec2(type3, value) {
            if (type3 == ")")
              return cont();
            if (type3 == ";")
              return cont(forspec2);
            if (value == "in" || value == "of") {
              cx.marked = "keyword";
              return cont(expression, forspec2);
            }
            return pass(expression, forspec2);
          }
          function functiondef(type3, value) {
            if (value == "*") {
              cx.marked = "keyword";
              return cont(functiondef);
            }
            if (type3 == "variable") {
              register(value);
              return cont(functiondef);
            }
            if (type3 == "(")
              return cont(pushcontext, pushlex(")"), commasep(funarg, ")"), poplex, mayberettype, statement, popcontext);
            if (isTS && value == "<")
              return cont(pushlex(">"), commasep(typeparam, ">"), poplex, functiondef);
          }
          function functiondecl(type3, value) {
            if (value == "*") {
              cx.marked = "keyword";
              return cont(functiondecl);
            }
            if (type3 == "variable") {
              register(value);
              return cont(functiondecl);
            }
            if (type3 == "(")
              return cont(pushcontext, pushlex(")"), commasep(funarg, ")"), poplex, mayberettype, popcontext);
            if (isTS && value == "<")
              return cont(pushlex(">"), commasep(typeparam, ">"), poplex, functiondecl);
          }
          function typename(type3, value) {
            if (type3 == "keyword" || type3 == "variable") {
              cx.marked = "type";
              return cont(typename);
            } else if (value == "<") {
              return cont(pushlex(">"), commasep(typeparam, ">"), poplex);
            }
          }
          function funarg(type3, value) {
            if (value == "@")
              cont(expression, funarg);
            if (type3 == "spread")
              return cont(funarg);
            if (isTS && isModifier(value)) {
              cx.marked = "keyword";
              return cont(funarg);
            }
            if (isTS && type3 == "this")
              return cont(maybetype, maybeAssign);
            return pass(pattern, maybetype, maybeAssign);
          }
          function classExpression(type3, value) {
            if (type3 == "variable")
              return className(type3, value);
            return classNameAfter(type3, value);
          }
          function className(type3, value) {
            if (type3 == "variable") {
              register(value);
              return cont(classNameAfter);
            }
          }
          function classNameAfter(type3, value) {
            if (value == "<")
              return cont(pushlex(">"), commasep(typeparam, ">"), poplex, classNameAfter);
            if (value == "extends" || value == "implements" || isTS && type3 == ",") {
              if (value == "implements")
                cx.marked = "keyword";
              return cont(isTS ? typeexpr : expression, classNameAfter);
            }
            if (type3 == "{")
              return cont(pushlex("}"), classBody, poplex);
          }
          function classBody(type3, value) {
            if (type3 == "async" || type3 == "variable" && (value == "static" || value == "get" || value == "set" || isTS && isModifier(value)) && cx.stream.match(/^\s+[\w$\xa1-\uffff]/, false)) {
              cx.marked = "keyword";
              return cont(classBody);
            }
            if (type3 == "variable" || cx.style == "keyword") {
              cx.marked = "property";
              return cont(classfield, classBody);
            }
            if (type3 == "number" || type3 == "string")
              return cont(classfield, classBody);
            if (type3 == "[")
              return cont(expression, maybetype, expect("]"), classfield, classBody);
            if (value == "*") {
              cx.marked = "keyword";
              return cont(classBody);
            }
            if (isTS && type3 == "(")
              return pass(functiondecl, classBody);
            if (type3 == ";" || type3 == ",")
              return cont(classBody);
            if (type3 == "}")
              return cont();
            if (value == "@")
              return cont(expression, classBody);
          }
          function classfield(type3, value) {
            if (value == "!")
              return cont(classfield);
            if (value == "?")
              return cont(classfield);
            if (type3 == ":")
              return cont(typeexpr, maybeAssign);
            if (value == "=")
              return cont(expressionNoComma);
            var context = cx.state.lexical.prev, isInterface = context && context.info == "interface";
            return pass(isInterface ? functiondecl : functiondef);
          }
          function afterExport(type3, value) {
            if (value == "*") {
              cx.marked = "keyword";
              return cont(maybeFrom, expect(";"));
            }
            if (value == "default") {
              cx.marked = "keyword";
              return cont(expression, expect(";"));
            }
            if (type3 == "{")
              return cont(commasep(exportField, "}"), maybeFrom, expect(";"));
            return pass(statement);
          }
          function exportField(type3, value) {
            if (value == "as") {
              cx.marked = "keyword";
              return cont(expect("variable"));
            }
            if (type3 == "variable")
              return pass(expressionNoComma, exportField);
          }
          function afterImport(type3) {
            if (type3 == "string")
              return cont();
            if (type3 == "(")
              return pass(expression);
            if (type3 == ".")
              return pass(maybeoperatorComma);
            return pass(importSpec, maybeMoreImports, maybeFrom);
          }
          function importSpec(type3, value) {
            if (type3 == "{")
              return contCommasep(importSpec, "}");
            if (type3 == "variable")
              register(value);
            if (value == "*")
              cx.marked = "keyword";
            return cont(maybeAs);
          }
          function maybeMoreImports(type3) {
            if (type3 == ",")
              return cont(importSpec, maybeMoreImports);
          }
          function maybeAs(_type, value) {
            if (value == "as") {
              cx.marked = "keyword";
              return cont(importSpec);
            }
          }
          function maybeFrom(_type, value) {
            if (value == "from") {
              cx.marked = "keyword";
              return cont(expression);
            }
          }
          function arrayLiteral(type3) {
            if (type3 == "]")
              return cont();
            return pass(commasep(expressionNoComma, "]"));
          }
          function enumdef() {
            return pass(pushlex("form"), pattern, expect("{"), pushlex("}"), commasep(enummember, "}"), poplex, poplex);
          }
          function enummember() {
            return pass(pattern, maybeAssign);
          }
          function isContinuedStatement(state, textAfter) {
            return state.lastType == "operator" || state.lastType == "," || isOperatorChar.test(textAfter.charAt(0)) || /[,.]/.test(textAfter.charAt(0));
          }
          function expressionAllowed(stream, state, backUp) {
            return state.tokenize == tokenBase && /^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(state.lastType) || state.lastType == "quasi" && /\{\s*$/.test(stream.string.slice(0, stream.pos - (backUp || 0)));
          }
          return {
            startState: function(basecolumn) {
              var state = {
                tokenize: tokenBase,
                lastType: "sof",
                cc: [],
                lexical: new JSLexical((basecolumn || 0) - indentUnit, 0, "block", false),
                localVars: parserConfig.localVars,
                context: parserConfig.localVars && new Context(null, null, false),
                indented: basecolumn || 0
              };
              if (parserConfig.globalVars && typeof parserConfig.globalVars == "object")
                state.globalVars = parserConfig.globalVars;
              return state;
            },
            token: function(stream, state) {
              if (stream.sol()) {
                if (!state.lexical.hasOwnProperty("align"))
                  state.lexical.align = false;
                state.indented = stream.indentation();
                findFatArrow(stream, state);
              }
              if (state.tokenize != tokenComment && stream.eatSpace())
                return null;
              var style = state.tokenize(stream, state);
              if (type2 == "comment")
                return style;
              state.lastType = type2 == "operator" && (content == "++" || content == "--") ? "incdec" : type2;
              return parseJS(state, style, type2, content, stream);
            },
            indent: function(state, textAfter) {
              if (state.tokenize == tokenComment || state.tokenize == tokenQuasi)
                return CodeMirror2.Pass;
              if (state.tokenize != tokenBase)
                return 0;
              var firstChar = textAfter && textAfter.charAt(0), lexical = state.lexical, top;
              if (!/^\s*else\b/.test(textAfter))
                for (var i = state.cc.length - 1; i >= 0; --i) {
                  var c = state.cc[i];
                  if (c == poplex)
                    lexical = lexical.prev;
                  else if (c != maybeelse && c != popcontext)
                    break;
                }
              while ((lexical.type == "stat" || lexical.type == "form") && (firstChar == "}" || (top = state.cc[state.cc.length - 1]) && (top == maybeoperatorComma || top == maybeoperatorNoComma) && !/^[,\.=+\-*:?[\(]/.test(textAfter)))
                lexical = lexical.prev;
              if (statementIndent && lexical.type == ")" && lexical.prev.type == "stat")
                lexical = lexical.prev;
              var type3 = lexical.type, closing = firstChar == type3;
              if (type3 == "vardef")
                return lexical.indented + (state.lastType == "operator" || state.lastType == "," ? lexical.info.length + 1 : 0);
              else if (type3 == "form" && firstChar == "{")
                return lexical.indented;
              else if (type3 == "form")
                return lexical.indented + indentUnit;
              else if (type3 == "stat")
                return lexical.indented + (isContinuedStatement(state, textAfter) ? statementIndent || indentUnit : 0);
              else if (lexical.info == "switch" && !closing && parserConfig.doubleIndentSwitch != false)
                return lexical.indented + (/^(?:case|default)\b/.test(textAfter) ? indentUnit : 2 * indentUnit);
              else if (lexical.align)
                return lexical.column + (closing ? 0 : 1);
              else
                return lexical.indented + (closing ? 0 : indentUnit);
            },
            electricInput: /^\s*(?:case .*?:|default:|\{|\})$/,
            blockCommentStart: jsonMode ? null : "/*",
            blockCommentEnd: jsonMode ? null : "*/",
            blockCommentContinue: jsonMode ? null : " * ",
            lineComment: jsonMode ? null : "//",
            fold: "brace",
            closeBrackets: "()[]{}''\"\"``",
            helperType: jsonMode ? "json" : "javascript",
            jsonldMode,
            jsonMode,
            expressionAllowed,
            skipExpression: function(state) {
              parseJS(state, "atom", "atom", "true", new CodeMirror2.StringStream("", 2, null));
            }
          };
        });
        CodeMirror2.registerHelper("wordChars", "javascript", /[\w$]/);
        CodeMirror2.defineMIME("text/javascript", "javascript");
        CodeMirror2.defineMIME("text/ecmascript", "javascript");
        CodeMirror2.defineMIME("application/javascript", "javascript");
        CodeMirror2.defineMIME("application/x-javascript", "javascript");
        CodeMirror2.defineMIME("application/ecmascript", "javascript");
        CodeMirror2.defineMIME("application/json", { name: "javascript", json: true });
        CodeMirror2.defineMIME("application/x-json", { name: "javascript", json: true });
        CodeMirror2.defineMIME("application/manifest+json", { name: "javascript", json: true });
        CodeMirror2.defineMIME("application/ld+json", { name: "javascript", jsonld: true });
        CodeMirror2.defineMIME("text/typescript", { name: "javascript", typescript: true });
        CodeMirror2.defineMIME("application/typescript", { name: "javascript", typescript: true });
      });
    }
  ),
  /***/
  576: (
    /***/
    (__unused_webpack_module, __unused_webpack_exports, __webpack_require__2) => {
      (function(mod) {
        if (true)
          mod(__webpack_require__2(237));
        else {
        }
      })(function(CodeMirror2) {
        "use strict";
        var htmlConfig = {
          autoSelfClosers: {
            "area": true,
            "base": true,
            "br": true,
            "col": true,
            "command": true,
            "embed": true,
            "frame": true,
            "hr": true,
            "img": true,
            "input": true,
            "keygen": true,
            "link": true,
            "meta": true,
            "param": true,
            "source": true,
            "track": true,
            "wbr": true,
            "menuitem": true
          },
          implicitlyClosed: {
            "dd": true,
            "li": true,
            "optgroup": true,
            "option": true,
            "p": true,
            "rp": true,
            "rt": true,
            "tbody": true,
            "td": true,
            "tfoot": true,
            "th": true,
            "tr": true
          },
          contextGrabbers: {
            "dd": { "dd": true, "dt": true },
            "dt": { "dd": true, "dt": true },
            "li": { "li": true },
            "option": { "option": true, "optgroup": true },
            "optgroup": { "optgroup": true },
            "p": {
              "address": true,
              "article": true,
              "aside": true,
              "blockquote": true,
              "dir": true,
              "div": true,
              "dl": true,
              "fieldset": true,
              "footer": true,
              "form": true,
              "h1": true,
              "h2": true,
              "h3": true,
              "h4": true,
              "h5": true,
              "h6": true,
              "header": true,
              "hgroup": true,
              "hr": true,
              "menu": true,
              "nav": true,
              "ol": true,
              "p": true,
              "pre": true,
              "section": true,
              "table": true,
              "ul": true
            },
            "rp": { "rp": true, "rt": true },
            "rt": { "rp": true, "rt": true },
            "tbody": { "tbody": true, "tfoot": true },
            "td": { "td": true, "th": true },
            "tfoot": { "tbody": true },
            "th": { "td": true, "th": true },
            "thead": { "tbody": true, "tfoot": true },
            "tr": { "tr": true }
          },
          doNotIndent: { "pre": true },
          allowUnquoted: true,
          allowMissing: true,
          caseFold: true
        };
        var xmlConfig = {
          autoSelfClosers: {},
          implicitlyClosed: {},
          contextGrabbers: {},
          doNotIndent: {},
          allowUnquoted: false,
          allowMissing: false,
          allowMissingTagName: false,
          caseFold: false
        };
        CodeMirror2.defineMode("xml", function(editorConf, config_) {
          var indentUnit = editorConf.indentUnit;
          var config2 = {};
          var defaults = config_.htmlMode ? htmlConfig : xmlConfig;
          for (var prop in defaults)
            config2[prop] = defaults[prop];
          for (var prop in config_)
            config2[prop] = config_[prop];
          var type2, setStyle;
          function inText(stream, state) {
            function chain(parser2) {
              state.tokenize = parser2;
              return parser2(stream, state);
            }
            var ch = stream.next();
            if (ch == "<") {
              if (stream.eat("!")) {
                if (stream.eat("[")) {
                  if (stream.match("CDATA["))
                    return chain(inBlock("atom", "]]>"));
                  else
                    return null;
                } else if (stream.match("--")) {
                  return chain(inBlock("comment", "-->"));
                } else if (stream.match("DOCTYPE", true, true)) {
                  stream.eatWhile(/[\w\._\-]/);
                  return chain(doctype(1));
                } else {
                  return null;
                }
              } else if (stream.eat("?")) {
                stream.eatWhile(/[\w\._\-]/);
                state.tokenize = inBlock("meta", "?>");
                return "meta";
              } else {
                type2 = stream.eat("/") ? "closeTag" : "openTag";
                state.tokenize = inTag;
                return "tag bracket";
              }
            } else if (ch == "&") {
              var ok;
              if (stream.eat("#")) {
                if (stream.eat("x")) {
                  ok = stream.eatWhile(/[a-fA-F\d]/) && stream.eat(";");
                } else {
                  ok = stream.eatWhile(/[\d]/) && stream.eat(";");
                }
              } else {
                ok = stream.eatWhile(/[\w\.\-:]/) && stream.eat(";");
              }
              return ok ? "atom" : "error";
            } else {
              stream.eatWhile(/[^&<]/);
              return null;
            }
          }
          inText.isInText = true;
          function inTag(stream, state) {
            var ch = stream.next();
            if (ch == ">" || ch == "/" && stream.eat(">")) {
              state.tokenize = inText;
              type2 = ch == ">" ? "endTag" : "selfcloseTag";
              return "tag bracket";
            } else if (ch == "=") {
              type2 = "equals";
              return null;
            } else if (ch == "<") {
              state.tokenize = inText;
              state.state = baseState;
              state.tagName = state.tagStart = null;
              var next = state.tokenize(stream, state);
              return next ? next + " tag error" : "tag error";
            } else if (/[\'\"]/.test(ch)) {
              state.tokenize = inAttribute(ch);
              state.stringStartCol = stream.column();
              return state.tokenize(stream, state);
            } else {
              stream.match(/^[^\s\u00a0=<>\"\']*[^\s\u00a0=<>\"\'\/]/);
              return "word";
            }
          }
          function inAttribute(quote) {
            var closure = function(stream, state) {
              while (!stream.eol()) {
                if (stream.next() == quote) {
                  state.tokenize = inTag;
                  break;
                }
              }
              return "string";
            };
            closure.isInAttribute = true;
            return closure;
          }
          function inBlock(style, terminator) {
            return function(stream, state) {
              while (!stream.eol()) {
                if (stream.match(terminator)) {
                  state.tokenize = inText;
                  break;
                }
                stream.next();
              }
              return style;
            };
          }
          function doctype(depth) {
            return function(stream, state) {
              var ch;
              while ((ch = stream.next()) != null) {
                if (ch == "<") {
                  state.tokenize = doctype(depth + 1);
                  return state.tokenize(stream, state);
                } else if (ch == ">") {
                  if (depth == 1) {
                    state.tokenize = inText;
                    break;
                  } else {
                    state.tokenize = doctype(depth - 1);
                    return state.tokenize(stream, state);
                  }
                }
              }
              return "meta";
            };
          }
          function lower(tagName2) {
            return tagName2 && tagName2.toLowerCase();
          }
          function Context(state, tagName2, startOfLine) {
            this.prev = state.context;
            this.tagName = tagName2 || "";
            this.indent = state.indented;
            this.startOfLine = startOfLine;
            if (config2.doNotIndent.hasOwnProperty(tagName2) || state.context && state.context.noIndent)
              this.noIndent = true;
          }
          function popContext(state) {
            if (state.context)
              state.context = state.context.prev;
          }
          function maybePopContext(state, nextTagName) {
            var parentTagName;
            while (true) {
              if (!state.context) {
                return;
              }
              parentTagName = state.context.tagName;
              if (!config2.contextGrabbers.hasOwnProperty(lower(parentTagName)) || !config2.contextGrabbers[lower(parentTagName)].hasOwnProperty(lower(nextTagName))) {
                return;
              }
              popContext(state);
            }
          }
          function baseState(type3, stream, state) {
            if (type3 == "openTag") {
              state.tagStart = stream.column();
              return tagNameState;
            } else if (type3 == "closeTag") {
              return closeTagNameState;
            } else {
              return baseState;
            }
          }
          function tagNameState(type3, stream, state) {
            if (type3 == "word") {
              state.tagName = stream.current();
              setStyle = "tag";
              return attrState;
            } else if (config2.allowMissingTagName && type3 == "endTag") {
              setStyle = "tag bracket";
              return attrState(type3, stream, state);
            } else {
              setStyle = "error";
              return tagNameState;
            }
          }
          function closeTagNameState(type3, stream, state) {
            if (type3 == "word") {
              var tagName2 = stream.current();
              if (state.context && state.context.tagName != tagName2 && config2.implicitlyClosed.hasOwnProperty(lower(state.context.tagName)))
                popContext(state);
              if (state.context && state.context.tagName == tagName2 || config2.matchClosing === false) {
                setStyle = "tag";
                return closeState;
              } else {
                setStyle = "tag error";
                return closeStateErr;
              }
            } else if (config2.allowMissingTagName && type3 == "endTag") {
              setStyle = "tag bracket";
              return closeState(type3, stream, state);
            } else {
              setStyle = "error";
              return closeStateErr;
            }
          }
          function closeState(type3, _stream, state) {
            if (type3 != "endTag") {
              setStyle = "error";
              return closeState;
            }
            popContext(state);
            return baseState;
          }
          function closeStateErr(type3, stream, state) {
            setStyle = "error";
            return closeState(type3, stream, state);
          }
          function attrState(type3, _stream, state) {
            if (type3 == "word") {
              setStyle = "attribute";
              return attrEqState;
            } else if (type3 == "endTag" || type3 == "selfcloseTag") {
              var tagName2 = state.tagName, tagStart = state.tagStart;
              state.tagName = state.tagStart = null;
              if (type3 == "selfcloseTag" || config2.autoSelfClosers.hasOwnProperty(lower(tagName2))) {
                maybePopContext(state, tagName2);
              } else {
                maybePopContext(state, tagName2);
                state.context = new Context(state, tagName2, tagStart == state.indented);
              }
              return baseState;
            }
            setStyle = "error";
            return attrState;
          }
          function attrEqState(type3, stream, state) {
            if (type3 == "equals")
              return attrValueState;
            if (!config2.allowMissing)
              setStyle = "error";
            return attrState(type3, stream, state);
          }
          function attrValueState(type3, stream, state) {
            if (type3 == "string")
              return attrContinuedState;
            if (type3 == "word" && config2.allowUnquoted) {
              setStyle = "string";
              return attrState;
            }
            setStyle = "error";
            return attrState(type3, stream, state);
          }
          function attrContinuedState(type3, stream, state) {
            if (type3 == "string")
              return attrContinuedState;
            return attrState(type3, stream, state);
          }
          return {
            startState: function(baseIndent) {
              var state = {
                tokenize: inText,
                state: baseState,
                indented: baseIndent || 0,
                tagName: null,
                tagStart: null,
                context: null
              };
              if (baseIndent != null)
                state.baseIndent = baseIndent;
              return state;
            },
            token: function(stream, state) {
              if (!state.tagName && stream.sol())
                state.indented = stream.indentation();
              if (stream.eatSpace())
                return null;
              type2 = null;
              var style = state.tokenize(stream, state);
              if ((style || type2) && style != "comment") {
                setStyle = null;
                state.state = state.state(type2 || style, stream, state);
                if (setStyle)
                  style = setStyle == "error" ? style + " error" : setStyle;
              }
              return style;
            },
            indent: function(state, textAfter, fullLine) {
              var context = state.context;
              if (state.tokenize.isInAttribute) {
                if (state.tagStart == state.indented)
                  return state.stringStartCol + 1;
                else
                  return state.indented + indentUnit;
              }
              if (context && context.noIndent)
                return CodeMirror2.Pass;
              if (state.tokenize != inTag && state.tokenize != inText)
                return fullLine ? fullLine.match(/^(\s*)/)[0].length : 0;
              if (state.tagName) {
                if (config2.multilineTagIndentPastTag !== false)
                  return state.tagStart + state.tagName.length + 2;
                else
                  return state.tagStart + indentUnit * (config2.multilineTagIndentFactor || 1);
              }
              if (config2.alignCDATA && /<!\[CDATA\[/.test(textAfter))
                return 0;
              var tagAfter = textAfter && /^<(\/)?([\w_:\.-]*)/.exec(textAfter);
              if (tagAfter && tagAfter[1]) {
                while (context) {
                  if (context.tagName == tagAfter[2]) {
                    context = context.prev;
                    break;
                  } else if (config2.implicitlyClosed.hasOwnProperty(lower(context.tagName))) {
                    context = context.prev;
                  } else {
                    break;
                  }
                }
              } else if (tagAfter) {
                while (context) {
                  var grabbers = config2.contextGrabbers[lower(context.tagName)];
                  if (grabbers && grabbers.hasOwnProperty(lower(tagAfter[2])))
                    context = context.prev;
                  else
                    break;
                }
              }
              while (context && context.prev && !context.startOfLine)
                context = context.prev;
              if (context)
                return context.indent + indentUnit;
              else
                return state.baseIndent || 0;
            },
            electricInput: /<\/[\s\w:]+>$/,
            blockCommentStart: "<!--",
            blockCommentEnd: "-->",
            configuration: config2.htmlMode ? "html" : "xml",
            helperType: config2.htmlMode ? "html" : "xml",
            skipAttribute: function(state) {
              if (state.state == attrValueState)
                state.state = attrState;
            },
            xmlCurrentTag: function(state) {
              return state.tagName ? { name: state.tagName, close: state.type == "closeTag" } : null;
            },
            xmlCurrentContext: function(state) {
              var context = [];
              for (var cx = state.context; cx; cx = cx.prev)
                context.push(cx.tagName);
              return context.reverse();
            }
          };
        });
        CodeMirror2.defineMIME("text/xml", "xml");
        CodeMirror2.defineMIME("application/xml", "xml");
        if (!CodeMirror2.mimeModes.hasOwnProperty("text/html"))
          CodeMirror2.defineMIME("text/html", { name: "xml", htmlMode: true });
      });
    }
  ),
  /***/
  578: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        A: () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var _common__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(268);
      var __extends2 = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var ModuleModel2 = (
        /** @class */
        function(_super) {
          __extends2(ModuleModel3, _super);
          function ModuleModel3(module, attributes, options) {
            var _this = _super.call(this, attributes, options) || this;
            _this._module = module;
            return _this;
          }
          Object.defineProperty(ModuleModel3.prototype, "module", {
            get: function() {
              return this._module;
            },
            enumerable: false,
            configurable: true
          });
          Object.defineProperty(ModuleModel3.prototype, "config", {
            get: function() {
              return this._module.config;
            },
            enumerable: false,
            configurable: true
          });
          Object.defineProperty(ModuleModel3.prototype, "em", {
            get: function() {
              return this._module.em;
            },
            enumerable: false,
            configurable: true
          });
          return ModuleModel3;
        }(_common__WEBPACK_IMPORTED_MODULE_0__.Kx)
      );
      const __WEBPACK_DEFAULT_EXPORT__ = ModuleModel2;
    }
  ),
  /***/
  683: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        A: () => __WEBPACK_DEFAULT_EXPORT__,
        /* harmony export */
        F: () => (
          /* binding */
          CanvasSpotBuiltInTypes
        )
        /* harmony export */
      });
      var _abstract__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(578);
      var __extends2 = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var CanvasSpotBuiltInTypes;
      (function(CanvasSpotBuiltInTypes2) {
        CanvasSpotBuiltInTypes2["Select"] = "select";
        CanvasSpotBuiltInTypes2["Hover"] = "hover";
        CanvasSpotBuiltInTypes2["Spacing"] = "spacing";
        CanvasSpotBuiltInTypes2["Target"] = "target";
        CanvasSpotBuiltInTypes2["Resize"] = "resize";
      })(CanvasSpotBuiltInTypes || (CanvasSpotBuiltInTypes = {}));
      var CanvasSpot2 = (
        /** @class */
        function(_super) {
          __extends2(CanvasSpot3, _super);
          function CanvasSpot3() {
            return _super !== null && _super.apply(this, arguments) || this;
          }
          CanvasSpot3.prototype.defaults = function() {
            return {
              id: "",
              type: ""
            };
          };
          Object.defineProperty(CanvasSpot3.prototype, "type", {
            get: function() {
              return this.get("type") || "";
            },
            enumerable: false,
            configurable: true
          });
          Object.defineProperty(CanvasSpot3.prototype, "component", {
            get: function() {
              var _a2;
              var cmp = this.get("component");
              return cmp || ((_a2 = this.get("componentView")) === null || _a2 === void 0 ? void 0 : _a2.model);
            },
            enumerable: false,
            configurable: true
          });
          Object.defineProperty(CanvasSpot3.prototype, "componentView", {
            get: function() {
              var _a2;
              var cmpView = this.get("componentView");
              return cmpView || ((_a2 = this.get("component")) === null || _a2 === void 0 ? void 0 : _a2.getView());
            },
            enumerable: false,
            configurable: true
          });
          Object.defineProperty(CanvasSpot3.prototype, "el", {
            get: function() {
              var _a2;
              return (_a2 = this.componentView) === null || _a2 === void 0 ? void 0 : _a2.el;
            },
            enumerable: false,
            configurable: true
          });
          CanvasSpot3.prototype.getBoxRect = function(opts) {
            var _a2 = this, el = _a2.el, em = _a2.em;
            var cvView = em.Canvas.getCanvasView();
            var boxRect = this.get("boxRect");
            if (boxRect) {
              return boxRect;
            } else if (el && cvView) {
              return cvView.getElBoxRect(el, opts);
            }
            return {
              x: 0,
              y: 0,
              width: 0,
              height: 0
            };
          };
          CanvasSpot3.prototype.getStyle = function(opts) {
            if (opts === void 0) {
              opts = {};
            }
            var _a2 = opts.boxRect || this.getBoxRect(opts), width = _a2.width, height = _a2.height, x = _a2.x, y = _a2.y;
            return {
              width: "".concat(width, "px"),
              height: "".concat(height, "px"),
              top: "0",
              left: "0",
              position: "absolute",
              translate: "".concat(x, "px ").concat(y, "px")
            };
          };
          CanvasSpot3.prototype.isType = function(type2) {
            return this.type === type2;
          };
          return CanvasSpot3;
        }(_abstract__WEBPACK_IMPORTED_MODULE_0__.A)
      );
      const __WEBPACK_DEFAULT_EXPORT__ = CanvasSpot2;
    }
  ),
  /***/
  242: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        A: () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var CommandsEvents;
      (function(CommandsEvents2) {
        CommandsEvents2["run"] = "command:run";
        CommandsEvents2["_run"] = "run";
        CommandsEvents2["runCommand"] = "command:run:";
        CommandsEvents2["_runCommand"] = "run:";
        CommandsEvents2["runBeforeCommand"] = "command:run:before:";
        CommandsEvents2["abort"] = "command:abort:";
        CommandsEvents2["_abort"] = "abort:";
        CommandsEvents2["stop"] = "command:stop";
        CommandsEvents2["_stop"] = "stop";
        CommandsEvents2["stopCommand"] = "command:stop:";
        CommandsEvents2["_stopCommand"] = "stop:";
        CommandsEvents2["stopBeforeCommand"] = "command:stop:before:";
      })(CommandsEvents || (CommandsEvents = {}));
      const __WEBPACK_DEFAULT_EXPORT__ = CommandsEvents;
    }
  ),
  /***/
  404: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed) {
          ed.Components.clear();
          ed.Css.clear();
        }
      };
    }
  ),
  /***/
  228: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _utils_Dragger__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__2(14);
      var _utils_dom__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(926);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed) {
          (0, underscore__WEBPACK_IMPORTED_MODULE_0__.bindAll)(this, "onKeyUp", "enableDragger", "disableDragger");
          this.editor = ed;
          this.canvasModel = this.canvas.getCanvasView().model;
          this.toggleMove(1);
        },
        stop: function(ed) {
          this.toggleMove();
          this.disableDragger();
        },
        onKeyUp: function(ev) {
          if ((0, _utils_dom__WEBPACK_IMPORTED_MODULE_1__.Ch)(ev) === " ") {
            this.editor.stopCommand(this.id);
          }
        },
        enableDragger: function(ev) {
          this.toggleDragger(1, ev);
        },
        disableDragger: function(ev) {
          this.toggleDragger(0, ev);
        },
        toggleDragger: function(enable, ev) {
          var _a2 = this, canvasModel = _a2.canvasModel, em = _a2.em;
          var dragger = this.dragger;
          var methodCls = enable ? "add" : "remove";
          this.getCanvas().classList[methodCls]("".concat(this.ppfx, "is__grabbing"));
          if (!dragger) {
            dragger = new _utils_Dragger__WEBPACK_IMPORTED_MODULE_2__.A({
              getPosition: function() {
                return {
                  x: canvasModel.get("x"),
                  y: canvasModel.get("y")
                };
              },
              setPosition: function(_a3) {
                var x = _a3.x, y = _a3.y;
                canvasModel.set({ x, y });
              },
              onStart: function(ev2, dragger2) {
                em.trigger("canvas:move:start", dragger2);
              },
              onDrag: function(ev2, dragger2) {
                em.trigger("canvas:move", dragger2);
              },
              onEnd: function(ev2, dragger2) {
                em.trigger("canvas:move:end", dragger2);
              }
            });
            this.dragger = dragger;
          }
          enable ? dragger.start(ev) : dragger.stop();
        },
        toggleMove: function(enable) {
          var ppfx = this.ppfx;
          var methodCls = enable ? "add" : "remove";
          var methodEv = enable ? "on" : "off";
          var methodsEv = { on: _utils_dom__WEBPACK_IMPORTED_MODULE_1__.on, off: _utils_dom__WEBPACK_IMPORTED_MODULE_1__.AU };
          var canvas2 = this.getCanvas();
          var classes = ["".concat(ppfx, "is__grab")];
          !enable && classes.push("".concat(ppfx, "is__grabbing"));
          classes.forEach(function(cls) {
            return canvas2.classList[methodCls](cls);
          });
          methodsEv[methodEv](document, "keyup", this.onKeyUp);
          methodsEv[methodEv](canvas2, "mousedown", this.enableDragger);
          methodsEv[methodEv](document, "mouseup", this.disableDragger);
        }
      };
    }
  ),
  /***/
  570: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__,
        /* harmony export */
        defineCommand: () => (
          /* binding */
          defineCommand
        )
        /* harmony export */
      });
      var _common__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(268);
      var _types__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(242);
      var __extends2 = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      function defineCommand(def) {
        return def;
      }
      var CommandAbstract2 = (
        /** @class */
        function(_super) {
          __extends2(CommandAbstract3, _super);
          function CommandAbstract3(o) {
            var _this = _super.call(this, 0) || this;
            _this.config = o || {};
            _this.em = _this.config.em || {};
            var pfx = _this.config.stylePrefix;
            _this.pfx = pfx;
            _this.ppfx = _this.config.pStylePrefix;
            _this.hoverClass = "".concat(pfx, "hover");
            _this.badgeClass = "".concat(pfx, "badge");
            _this.plhClass = "".concat(pfx, "placeholder");
            _this.freezClass = "".concat(_this.ppfx, "freezed");
            _this.canvas = _this.em.Canvas;
            _this.init(_this.config);
            return _this;
          }
          CommandAbstract3.prototype.onFrameScroll = function(e) {
          };
          CommandAbstract3.prototype.getCanvas = function() {
            return this.canvas.getElement();
          };
          CommandAbstract3.prototype.getCanvasBody = function() {
            return this.canvas.getBody();
          };
          CommandAbstract3.prototype.getCanvasTools = function() {
            return this.canvas.getToolsEl();
          };
          CommandAbstract3.prototype.offset = function(el) {
            var rect = el.getBoundingClientRect();
            return {
              top: rect.top + el.ownerDocument.body.scrollTop,
              left: rect.left + el.ownerDocument.body.scrollLeft
            };
          };
          CommandAbstract3.prototype.init = function(o) {
          };
          CommandAbstract3.prototype.callRun = function(editor, options) {
            if (options === void 0) {
              options = {};
            }
            var id = this.id;
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A.runBeforeCommand).concat(id), { options });
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A._runCommand).concat(id, ":before"), options);
            if (options.abort) {
              editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A.abort).concat(id), { options });
              editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A._abort).concat(id), options);
              return;
            }
            var sender = options.sender || editor;
            var result = this.run(editor, sender, options);
            var data = { id, result, options };
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A.runCommand).concat(id), data);
            editor.trigger(_types__WEBPACK_IMPORTED_MODULE_0__.A.run, data);
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A._runCommand).concat(id), result, options);
            editor.trigger(_types__WEBPACK_IMPORTED_MODULE_0__.A._run, id, result, options);
            return result;
          };
          CommandAbstract3.prototype.callStop = function(editor, options) {
            if (options === void 0) {
              options = {};
            }
            var id = this.id;
            var sender = options.sender || editor;
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A.stopBeforeCommand).concat(id), { options });
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A._stopCommand).concat(id, ":before"), options);
            var result = this.stop(editor, sender, options);
            var data = { id, result, options };
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A.stopCommand).concat(id), data);
            editor.trigger(_types__WEBPACK_IMPORTED_MODULE_0__.A.stop, data);
            editor.trigger("".concat(_types__WEBPACK_IMPORTED_MODULE_0__.A._stopCommand).concat(id), result, options);
            editor.trigger(_types__WEBPACK_IMPORTED_MODULE_0__.A._stop, id, result, options);
            return result;
          };
          CommandAbstract3.prototype.stopCommand = function(opts) {
            this.em.Commands.stop(this.id, opts);
          };
          CommandAbstract3.prototype.run = function(em, sender, options) {
          };
          CommandAbstract3.prototype.stop = function(em, sender, options) {
          };
          return CommandAbstract3;
        }(_common__WEBPACK_IMPORTED_MODULE_1__.Kx)
      );
      const __WEBPACK_DEFAULT_EXPORT__ = CommandAbstract2;
    }
  ),
  /***/
  377: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var __spreadArray2 = function(to, from, pack) {
        if (pack || arguments.length === 2)
          for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
              if (!ar)
                ar = Array.prototype.slice.call(from, 0, i);
              ar[i] = from[i];
            }
          }
        return to.concat(ar || Array.prototype.slice.call(from));
      };
      var command = {
        run: function(ed, s, opts) {
          var _this = this;
          if (opts === void 0) {
            opts = {};
          }
          var removed = [];
          var components = opts.component || ed.getSelectedAll();
          components = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isArray)(components) ? __spreadArray2([], components, true) : [components];
          components.filter(Boolean).forEach(function(component) {
            var _a2, _b;
            if (!component.get("removable")) {
              return _this.em.logWarning("The element is not removable", {
                component
              });
            }
            removed.push(component);
            var cmp = ((_b = (_a2 = component.delegate) === null || _a2 === void 0 ? void 0 : _a2.remove) === null || _b === void 0 ? void 0 : _b.call(_a2, component)) || component;
            cmp.remove();
          });
          ed.selectRemove(removed);
          return removed;
        }
      };
      const __WEBPACK_DEFAULT_EXPORT__ = command;
    }
  ),
  /***/
  728: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _utils_Dragger__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(14);
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      var evName = "dmode";
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(editor, sender, opts) {
          var _this = this;
          if (opts === void 0) {
            opts = {};
          }
          (0, underscore__WEBPACK_IMPORTED_MODULE_0__.bindAll)(this, "setPosition", "onStart", "onDrag", "onEnd", "getPosition", "getGuidesStatic", "renderGuide", "getGuidesTarget");
          var target = opts.target, event = opts.event, mode = opts.mode, _a2 = opts.dragger, dragger = _a2 === void 0 ? {} : _a2;
          var el = target.getEl();
          var config2 = __assign2({ doc: el.ownerDocument, onStart: this.onStart, onEnd: this.onEnd, onDrag: this.onDrag, getPosition: this.getPosition, setPosition: this.setPosition, guidesStatic: function() {
            return _this.guidesStatic;
          }, guidesTarget: function() {
            return _this.guidesTarget;
          } }, dragger);
          this.setupGuides();
          this.opts = opts;
          this.editor = editor;
          this.em = editor.getModel();
          this.target = target;
          this.isTran = mode == "translate";
          this.guidesContainer = this.getGuidesContainer();
          this.guidesTarget = this.getGuidesTarget();
          this.guidesStatic = this.getGuidesStatic();
          var drg = this.dragger;
          if (!drg) {
            drg = new _utils_Dragger__WEBPACK_IMPORTED_MODULE_1__.A(config2);
            this.dragger = drg;
          } else {
            drg.setOptions(config2);
          }
          event && drg.start(event);
          this.toggleDrag(1);
          this.em.trigger("".concat(evName, ":start"), this.getEventOpts());
          return drg;
        },
        getEventOpts: function() {
          return {
            mode: this.opts.mode,
            target: this.target,
            guidesTarget: this.guidesTarget,
            guidesStatic: this.guidesStatic
          };
        },
        stop: function() {
          this.toggleDrag();
        },
        setupGuides: function() {
          (this.guides || []).forEach(function(item) {
            var guide = item.guide;
            guide && guide.parentNode.removeChild(guide);
          });
          this.guides = [];
        },
        getGuidesContainer: function() {
          var _this = this;
          var guidesEl = this.guidesEl;
          if (!guidesEl) {
            var _a2 = this, editor = _a2.editor, em = _a2.em, opts_1 = _a2.opts;
            var pfx = editor.getConfig().stylePrefix;
            var elInfoX = document.createElement("div");
            var elInfoY = document.createElement("div");
            var guideContent = '<div class="'.concat(pfx, "guide-info__line ").concat(pfx, 'danger-bg">\n        <div class="').concat(pfx, "guide-info__content ").concat(pfx, 'danger-color"></div>\n      </div>');
            guidesEl = document.createElement("div");
            guidesEl.className = "".concat(pfx, "guides");
            elInfoX.className = "".concat(pfx, "guide-info ").concat(pfx, "guide-info__x");
            elInfoY.className = "".concat(pfx, "guide-info ").concat(pfx, "guide-info__y");
            elInfoX.innerHTML = guideContent;
            elInfoY.innerHTML = guideContent;
            guidesEl.appendChild(elInfoX);
            guidesEl.appendChild(elInfoY);
            editor.Canvas.getGlobalToolsEl().appendChild(guidesEl);
            this.guidesEl = guidesEl;
            this.elGuideInfoX = elInfoX;
            this.elGuideInfoY = elInfoY;
            this.elGuideInfoContentX = elInfoX.querySelector(".".concat(pfx, "guide-info__content"));
            this.elGuideInfoContentY = elInfoY.querySelector(".".concat(pfx, "guide-info__content"));
            em.on("canvas:update frame:scroll", (0, underscore__WEBPACK_IMPORTED_MODULE_0__.debounce)(function() {
              var _a3;
              _this.updateGuides();
              opts_1.debug && ((_a3 = _this.guides) === null || _a3 === void 0 ? void 0 : _a3.forEach(function(item) {
                return _this.renderGuide(item);
              }));
            }, 200));
          }
          return guidesEl;
        },
        getGuidesStatic: function() {
          var _this = this;
          var result = [];
          var el = this.target.getEl();
          var _a2 = el.parentNode, parentNode = _a2 === void 0 ? {} : _a2;
          (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(parentNode.children, function(item) {
            return result = result.concat(el !== item ? _this.getElementGuides(item) : []);
          });
          return result.concat(this.getElementGuides(parentNode));
        },
        getGuidesTarget: function() {
          return this.getElementGuides(this.target.getEl());
        },
        updateGuides: function(guides) {
          var _this = this;
          var lastEl;
          var lastPos;
          (guides || this.guides).forEach(function(item) {
            var origin = item.origin;
            var pos = lastEl === origin ? lastPos : _this.getElementPos(origin);
            lastEl = origin;
            lastPos = pos;
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(_this.getGuidePosUpdate(item, pos), function(val, key) {
              return item[key] = val;
            });
            item.originRect = pos;
          });
        },
        getGuidePosUpdate: function(item, rect) {
          var result = {};
          var top = rect.top, height = rect.height, left = rect.left, width = rect.width;
          switch (item.type) {
            case "t":
              result.y = top;
              break;
            case "b":
              result.y = top + height;
              break;
            case "l":
              result.x = left;
              break;
            case "r":
              result.x = left + width;
              break;
            case "x":
              result.x = left + width / 2;
              break;
            case "y":
              result.y = top + height / 2;
              break;
          }
          return result;
        },
        renderGuide: function(item) {
          if (item === void 0) {
            item = {};
          }
          var el = item.guide || document.createElement("div");
          var un = "px";
          var guideSize = item.active ? 2 : 1;
          var numEl = el.children[0];
          el.style = "position: absolute; background-color: ".concat(item.active ? "green" : "red", ";");
          if (!el.children.length) {
            numEl = document.createElement("div");
            numEl.style = "position: absolute; color: red; padding: 5px; top: 0; left: 0;";
            el.appendChild(numEl);
          }
          if (item.y) {
            el.style.width = "100%";
            el.style.height = "".concat(guideSize).concat(un);
            el.style.top = "".concat(item.y).concat(un);
            el.style.left = 0;
          } else {
            el.style.width = "".concat(guideSize).concat(un);
            el.style.height = "100%";
            el.style.left = "".concat(item.x).concat(un);
            el.style.top = "0".concat(un);
          }
          !item.guide && this.guidesContainer.appendChild(el);
          return el;
        },
        getElementPos: function(el) {
          return this.editor.Canvas.getElementPos(el, { noScroll: 1 });
        },
        getElementGuides: function(el) {
          var _this = this;
          var opts = this.opts;
          var originRect = this.getElementPos(el);
          var top = originRect.top, height = originRect.height, left = originRect.left, width = originRect.width;
          var guides = [
            { type: "t", y: top },
            // Top
            { type: "b", y: top + height },
            // Bottom
            { type: "l", x: left },
            // Left
            { type: "r", x: left + width },
            // Right
            { type: "x", x: left + width / 2 },
            // Mid x
            { type: "y", y: top + height / 2 }
            // Mid y
          ].map(function(item) {
            return __assign2(__assign2({}, item), { origin: el, originRect, guide: opts.debug && _this.renderGuide(item) });
          });
          guides.forEach(function(item) {
            var _a2;
            return (_a2 = _this.guides) === null || _a2 === void 0 ? void 0 : _a2.push(item);
          });
          return guides;
        },
        getTranslate: function(transform, axis) {
          if (axis === void 0) {
            axis = "x";
          }
          var result = 0;
          (transform || "").split(" ").forEach(function(item) {
            var itemStr = item.trim();
            var fn = "translate".concat(axis.toUpperCase(), "(");
            if (itemStr.indexOf(fn) === 0)
              result = parseFloat(itemStr.replace(fn, ""));
          });
          return result;
        },
        setTranslate: function(transform, axis, value) {
          var fn = "translate".concat(axis.toUpperCase(), "(");
          var val = "".concat(fn).concat(value, ")");
          var result = (transform || "").split(" ").map(function(item) {
            var itemStr = item.trim();
            if (itemStr.indexOf(fn) === 0)
              item = val;
            return item;
          }).join(" ");
          if (result.indexOf(fn) < 0)
            result += " ".concat(val);
          return result;
        },
        getPosition: function() {
          var _a2 = this, target = _a2.target, isTran = _a2.isTran;
          var _b = target.getStyle(), left = _b.left, top = _b.top, transform = _b.transform;
          var x = 0;
          var y = 0;
          if (isTran) {
            x = this.getTranslate(transform);
            y = this.getTranslate(transform, "y");
          } else {
            x = parseFloat(left || 0);
            y = parseFloat(top || 0);
          }
          return { x, y };
        },
        setPosition: function(_a2) {
          var x = _a2.x, y = _a2.y, end = _a2.end, position = _a2.position, width = _a2.width, height = _a2.height;
          var _b = this, target = _b.target, isTran = _b.isTran, em = _b.em;
          var unit = "px";
          var __p = !end;
          var left = "".concat(parseInt(x, 10)).concat(unit);
          var top = "".concat(parseInt(y, 10)).concat(unit);
          var styleUp = {};
          if (isTran) {
            var transform = target.getStyle()["transform"] || "";
            transform = this.setTranslate(transform, "x", left);
            transform = this.setTranslate(transform, "y", top);
            styleUp = { transform, __p };
            target.addStyle(styleUp, { avoidStore: !end });
          } else {
            var adds_1 = { position, width, height };
            var style_1 = { left, top, __p };
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.keys)(adds_1).forEach(function(add) {
              var prop = adds_1[add];
              if (prop)
                style_1[add] = prop;
            });
            styleUp = style_1;
            target.addStyle(styleUp, { avoidStore: !end });
          }
          em === null || em === void 0 ? void 0 : em.Styles.__emitCmpStyleUpdate(styleUp, { components: em.getSelected() });
        },
        _getDragData: function() {
          var target = this.target;
          return {
            target,
            parent: target.parent(),
            index: target.index()
          };
        },
        onStart: function(event) {
          var _a2 = this, target = _a2.target, editor = _a2.editor, isTran = _a2.isTran, opts = _a2.opts;
          var center = opts.center, onStart = opts.onStart;
          var Canvas2 = editor.Canvas;
          var style = target.getStyle();
          var position = "absolute";
          var relPos = [position, "relative"];
          onStart && onStart(this._getDragData());
          if (isTran)
            return;
          if (style.position !== position) {
            var _b = Canvas2.offset(target.getEl()), left = _b.left, top_1 = _b.top, width = _b.width, height = _b.height;
            var parent_1 = target.parent();
            var parentRel = void 0;
            do {
              var pStyle = parent_1.getStyle();
              parentRel = relPos.indexOf(pStyle.position) >= 0 ? parent_1 : null;
              parent_1 = parent_1.parent();
            } while (parent_1 && !parentRel);
            if (center) {
              var _c = Canvas2.getMouseRelativeCanvas(event), x = _c.x, y = _c.y;
              left = x;
              top_1 = y;
            } else if (parentRel) {
              var offsetP = Canvas2.offset(parentRel.getEl());
              left = left - offsetP.left;
              top_1 = top_1 - offsetP.top;
            }
            this.setPosition({
              x: left,
              y: top_1,
              width: "".concat(width, "px"),
              height: "".concat(height, "px"),
              position
            });
          }
        },
        onDrag: function() {
          var _this = this;
          var args = [];
          for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
          }
          var _a2 = this, guidesTarget = _a2.guidesTarget, opts = _a2.opts;
          var onDrag = opts.onDrag;
          this.updateGuides(guidesTarget);
          opts.debug && guidesTarget.forEach(function(item) {
            return _this.renderGuide(item);
          });
          opts.guidesInfo && this.renderGuideInfo(guidesTarget.filter(function(item) {
            return item.active;
          }));
          onDrag && onDrag(this._getDragData());
        },
        onEnd: function(ev, dragger, opt) {
          if (opt === void 0) {
            opt = {};
          }
          var _a2 = this, editor = _a2.editor, opts = _a2.opts, id = _a2.id;
          var onEnd = opts.onEnd;
          onEnd && onEnd(ev, opt, __assign2(__assign2({ event: ev }, opt), this._getDragData()));
          editor.stopCommand(id);
          this.hideGuidesInfo();
          this.em.trigger("".concat(evName, ":end"), this.getEventOpts());
        },
        hideGuidesInfo: function() {
          var _this = this;
          ["X", "Y"].forEach(function(item) {
            var guide = _this["elGuideInfo".concat(item)];
            if (guide)
              guide.style.display = "none";
          });
        },
        /**
         * Render guides with spacing information
         */
        renderGuideInfo: function(guides) {
          var _this = this;
          if (guides === void 0) {
            guides = [];
          }
          var guidesStatic = this.guidesStatic;
          this.hideGuidesInfo();
          guides.forEach(function(item) {
            var origin = item.origin, x = item.x;
            var rectOrigin = _this.getElementPos(origin);
            var axis = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(x) ? "y" : "x";
            var isY = axis === "y";
            var origEdge1 = rectOrigin[isY ? "left" : "top"];
            var origEdge1Raw = rectOrigin.rect[isY ? "left" : "top"];
            var origEdge2 = isY ? origEdge1 + rectOrigin.width : origEdge1 + rectOrigin.height;
            var origEdge2Raw = isY ? origEdge1Raw + rectOrigin.rect.width : origEdge1Raw + rectOrigin.rect.height;
            var elGuideInfo = _this["elGuideInfo".concat(axis.toUpperCase())];
            var elGuideInfoCnt = _this["elGuideInfoContent".concat(axis.toUpperCase())];
            var guideInfoStyle = elGuideInfo.style;
            var res = guidesStatic === null || guidesStatic === void 0 ? void 0 : guidesStatic.filter(function(stat) {
              return stat.type === item.type;
            }).map(function(stat) {
              var _a3 = stat.originRect, left2 = _a3.left, width2 = _a3.width, top = _a3.top, height2 = _a3.height;
              var statEdge12 = isY ? left2 : top;
              var statEdge22 = isY ? left2 + width2 : top + height2;
              return {
                gap: statEdge22 < origEdge1 ? origEdge1 - statEdge22 : statEdge12 - origEdge2,
                guide: stat
              };
            }).filter(function(item2) {
              return item2.gap > 0;
            }).sort(function(a, b) {
              return a.gap - b.gap;
            }).map(function(item2) {
              return item2.guide;
            })[0];
            if (res) {
              var _a2 = res.originRect, left = _a2.left, width = _a2.width, top_2 = _a2.top, height = _a2.height, rect = _a2.rect;
              var isEdge1 = isY ? left < rectOrigin.left : top_2 < rectOrigin.top;
              var statEdge1 = isY ? left : top_2;
              var statEdge1Raw = isY ? rect.left : rect.top;
              var statEdge2 = isY ? left + width : top_2 + height;
              var statEdge2Raw = isY ? rect.left + rect.width : rect.top + rect.height;
              var posFirst = isY ? item.y : item.x;
              var posSecond = isEdge1 ? statEdge2 : origEdge2;
              var pos2 = "".concat(posFirst, "px");
              var size = isEdge1 ? origEdge1 - statEdge2 : statEdge1 - origEdge2;
              var sizeRaw = isEdge1 ? origEdge1Raw - statEdge2Raw : statEdge1Raw - origEdge2Raw;
              guideInfoStyle.display = "";
              guideInfoStyle[isY ? "top" : "left"] = pos2;
              guideInfoStyle[isY ? "left" : "top"] = "".concat(posSecond, "px");
              guideInfoStyle[isY ? "width" : "height"] = "".concat(size, "px");
              elGuideInfoCnt.innerHTML = "".concat(Math.round(sizeRaw), "px");
              _this.em.trigger("".concat(evName, ":active"), __assign2(__assign2({}, _this.getEventOpts()), { guide: item, guidesStatic, matched: res, posFirst, posSecond, size, sizeRaw, elGuideInfo, elGuideInfoCnt }));
            }
          });
        },
        toggleDrag: function(enable) {
          var _a2 = this, ppfx = _a2.ppfx, editor = _a2.editor;
          var methodCls = enable ? "add" : "remove";
          var classes = ["".concat(ppfx, "is__grabbing")];
          var Canvas2 = editor.Canvas;
          var body = Canvas2.getBody();
          classes.forEach(function(cls) {
            return body.classList[methodCls](cls);
          });
          Canvas2[enable ? "startAutoscroll" : "stopAutoscroll"]();
        }
      };
    }
  ),
  /***/
  462: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed) {
          if (!ed.Canvas.hasFocus())
            return;
          var toSelect = [];
          ed.getSelectedAll().forEach(function(component) {
            var coll = component.components();
            var next = coll && coll.filter(function(c) {
              return c.get("selectable");
            })[0];
            next && toSelect.push(next);
          });
          toSelect.length && ed.select(toSelect);
        }
      };
    }
  ),
  /***/
  658: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed, snd, opts) {
          if (opts === void 0) {
            opts = {};
          }
          if (!ed.Canvas.hasFocus() && !opts.force)
            return;
          var toSelect = [];
          ed.getSelectedAll().forEach(function(component) {
            var next = component.parent();
            while (next && !next.get("selectable")) {
              next = next.parent();
            }
            next && toSelect.push(next);
          });
          toSelect.length && ed.select(toSelect);
        }
      };
    }
  ),
  /***/
  619: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed) {
          if (!ed.Canvas.hasFocus())
            return;
          var toSelect = [];
          ed.getSelectedAll().forEach(function(cmp) {
            var parent = cmp.parent();
            if (!parent)
              return;
            var len = parent.components().length;
            var incr = 0;
            var at = 0;
            var next;
            do {
              incr++;
              at = cmp.index() + incr;
              next = at <= len ? parent.getChildAt(at) : null;
            } while (next && !next.get("selectable"));
            toSelect.push(next || cmp);
          });
          toSelect.length && ed.select(toSelect);
        }
      };
    }
  ),
  /***/
  935: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed) {
          if (!ed.Canvas.hasFocus())
            return;
          var toSelect = [];
          ed.getSelectedAll().forEach(function(cmp) {
            var parent = cmp.parent();
            if (!parent)
              return;
            var incr = 0;
            var at = 0;
            var next;
            do {
              incr++;
              at = cmp.index() - incr;
              next = at >= 0 ? parent.getChildAt(at) : null;
            } while (next && !next.get("selectable"));
            toSelect.push(next || cmp);
          });
          toSelect.length && ed.select(toSelect);
        }
      };
    }
  ),
  /***/
  536: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed, s, opts) {
          if (opts === void 0) {
            opts = {};
          }
          var target = opts.target;
          var toRemove = [];
          if (!target.get("styles"))
            return toRemove;
          var type2 = target.get("type");
          var wrappers = ed.Pages.getAllWrappers();
          var len = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.flatten)(wrappers.map(function(wrp) {
            return wrp.findType(type2);
          })).length;
          if (!len) {
            var rules = ed.CssComposer.getAll();
            toRemove = rules.filter(function(rule) {
              return rule.get("group") === "cmp:".concat(type2);
            });
            rules.remove(toRemove);
          }
          return toRemove;
        }
      };
    }
  ),
  /***/
  957: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var __spreadArray2 = function(to, from, pack) {
        if (pack || arguments.length === 2)
          for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
              if (!ar)
                ar = Array.prototype.slice.call(from, 0, i);
              ar[i] = from[i];
            }
          }
        return to.concat(ar || Array.prototype.slice.call(from));
      };
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed) {
          var em = ed.getModel();
          var models = __spreadArray2([], ed.getSelectedAll(), true).map(function(md) {
            var _a2, _b;
            return ((_b = (_a2 = md.delegate) === null || _a2 === void 0 ? void 0 : _a2.copy) === null || _b === void 0 ? void 0 : _b.call(_a2, md)) || md;
          }).filter(Boolean);
          models.length && em.set("clipboard", models);
        }
      };
    }
  ),
  /***/
  413: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var _utils_dom__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(926);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(editor, sender, opts) {
          var _this = this;
          if (opts === void 0) {
            opts = {};
          }
          sender && sender.set && sender.set("active", 0);
          var config2 = editor.getConfig();
          var modal = editor.Modal;
          var pfx = config2.stylePrefix;
          this.cm = editor.CodeManager || null;
          if (!this.editors) {
            var oHtmlEd = this.buildEditor("htmlmixed", "hopscotch", "HTML");
            var oCsslEd = this.buildEditor("css", "hopscotch", "CSS");
            this.htmlEditor = oHtmlEd.model;
            this.cssEditor = oCsslEd.model;
            var editors2 = (0, _utils_dom__WEBPACK_IMPORTED_MODULE_0__.a_)("div", { class: "".concat(pfx, "export-dl") });
            editors2.appendChild(oHtmlEd.el);
            editors2.appendChild(oCsslEd.el);
            this.editors = editors2;
          }
          modal.open({
            title: config2.textViewCode,
            content: this.editors
          }).getModel().once("change:open", function() {
            return editor.stopCommand("".concat(_this.id));
          });
          this.htmlEditor.setContent(editor.getHtml(opts.optsHtml));
          this.cssEditor.setContent(editor.getCss(opts.optsCss));
        },
        stop: function(editor) {
          var modal = editor.Modal;
          modal && modal.close();
        },
        buildEditor: function(codeName, theme, label) {
          var cm = this.em.CodeManager;
          var model = cm.createViewer({
            label,
            codeName,
            theme
          });
          var el = new cm.EditorView({
            model,
            config: cm.getConfig()
          }).render().el;
          return { model, el };
        }
      };
    }
  ),
  /***/
  516: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        /**
         * Check if fullscreen mode is enabled
         * @return {Boolean}
         */
        isEnabled: function() {
          var d = document;
          if (d.fullscreenElement || d.webkitFullscreenElement || d.mozFullScreenElement) {
            return true;
          }
          return false;
        },
        /**
         * Enable fullscreen mode and return browser prefix
         * @param  {HTMLElement} el
         * @return {string}
         */
        enable: function(el) {
          var pfx = "";
          if (el.requestFullscreen) {
            el.requestFullscreen();
          } else if (el.webkitRequestFullscreen) {
            pfx = "webkit";
            el.webkitRequestFullscreen();
          } else if (el.mozRequestFullScreen) {
            pfx = "moz";
            el.mozRequestFullScreen();
          } else if (el.msRequestFullscreen) {
            el.msRequestFullscreen();
          }
          return pfx;
        },
        /**
         * Disable fullscreen mode
         */
        disable: function() {
          var d = document;
          if (this.isEnabled()) {
            if (d.exitFullscreen)
              d.exitFullscreen();
            else if (d.webkitExitFullscreen)
              d.webkitExitFullscreen();
            else if (d.mozCancelFullScreen)
              d.mozCancelFullScreen();
            else if (d.msExitFullscreen)
              d.msExitFullscreen();
          }
        },
        /**
         * Triggered when the state of the fullscreen is changed. Inside detects if
         * it's enabled
         * @param  {strinf} pfx Browser prefix
         * @param  {Event} e
         */
        fsChanged: function(pfx) {
          if (!this.isEnabled()) {
            this.stopCommand({ sender: this.sender });
            document.removeEventListener("".concat(pfx || "", "fullscreenchange"), this.fsChanged);
          }
        },
        run: function(editor, sender, opts) {
          if (opts === void 0) {
            opts = {};
          }
          this.sender = sender;
          var target = opts.target;
          var targetEl = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isElement)(target) ? target : document.querySelector(target);
          var pfx = this.enable(targetEl || editor.getContainer());
          this.fsChanged = this.fsChanged.bind(this, pfx);
          document.addEventListener(pfx + "fullscreenchange", this.fsChanged);
        },
        stop: function(editor, sender) {
          if (sender && sender.set)
            sender.set("active", false);
          this.disable();
        }
      };
    }
  ),
  /***/
  13: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _common__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__2(694);
      var _utils_dom__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__2(926);
      var _SelectComponent__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__2(194);
      var _SelectPosition__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(582);
      const __WEBPACK_DEFAULT_EXPORT__ = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.extend)({}, _SelectPosition__WEBPACK_IMPORTED_MODULE_1__["default"], _SelectComponent__WEBPACK_IMPORTED_MODULE_2__["default"], {
        init: function(o) {
          _SelectComponent__WEBPACK_IMPORTED_MODULE_2__["default"].init.apply(this, arguments);
          (0, underscore__WEBPACK_IMPORTED_MODULE_0__.bindAll)(this, "initSorter", "rollback", "onEndMove");
          this.opt = o;
          this.hoverClass = this.ppfx + "highlighter-warning";
          this.badgeClass = this.ppfx + "badge-warning";
          this.noSelClass = this.ppfx + "no-select";
        },
        enable: function() {
          var args = [];
          for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
          }
          _SelectComponent__WEBPACK_IMPORTED_MODULE_2__["default"].enable.apply(this, args);
          this.getBadgeEl().addClass(this.badgeClass);
          this.getHighlighterEl().addClass(this.hoverClass);
          var wp = this.$wrapper;
          wp.css("cursor", "move");
          wp.on("mousedown", this.initSorter);
          wp.addClass(this.noSelClass);
        },
        /**
         * Overwrite for doing nothing
         * @private
         */
        toggleClipboard: function() {
        },
        /**
         * Delegate sorting
         * @param  {Event} e
         * @private
         * */
        initSorter: function(e) {
          var el = (0, _common__WEBPACK_IMPORTED_MODULE_3__["default"])(e.target).data("model");
          var drag = el.get("draggable");
          if (!drag)
            return;
          this.cacheEl = null;
          this.startSelectPosition(e.target, this.frameEl.contentDocument);
          this.sorter.draggable = drag;
          this.sorter.onEndMove = this.onEndMove.bind(this);
          this.stopSelectComponent();
          this.$wrapper.off("mousedown", this.initSorter);
          (0, _utils_dom__WEBPACK_IMPORTED_MODULE_4__.on)(this.getContentWindow(), "keydown", this.rollback);
        },
        /**
         * Init sorter from model
         * @param  {Object} model
         * @private
         */
        initSorterFromModel: function(model) {
          var drag = model.get("draggable");
          if (!drag)
            return;
          this.cacheEl = null;
          var el = model.view.el;
          this.startSelectPosition(el, this.frameEl.contentDocument);
          this.sorter.draggable = drag;
          this.sorter.onEndMove = this.onEndMoveFromModel.bind(this);
          this.stopSelectComponent();
          (0, _utils_dom__WEBPACK_IMPORTED_MODULE_4__.on)(this.getContentWindow(), "keydown", this.rollback);
        },
        /**
         * Init sorter from models
         * @param  {Object} model
         * @private
         */
        initSorterFromModels: function(models) {
          this.cacheEl = null;
          var lastModel = models[models.length - 1];
          var frameView = this.em.getCurrentFrame();
          var el = lastModel.getEl(frameView === null || frameView === void 0 ? void 0 : frameView.model);
          var doc = el.ownerDocument;
          this.startSelectPosition(el, doc, { onStart: this.onStart });
          this.sorter.draggable = lastModel.get("draggable");
          this.sorter.toMove = models;
          this.sorter.onMoveClb = this.onDrag;
          this.sorter.onEndMove = this.onEndMoveFromModel.bind(this);
          this.stopSelectComponent();
          (0, _utils_dom__WEBPACK_IMPORTED_MODULE_4__.on)(this.getContentWindow(), "keydown", this.rollback);
        },
        onEndMoveFromModel: function() {
          (0, _utils_dom__WEBPACK_IMPORTED_MODULE_4__.AU)(this.getContentWindow(), "keydown", this.rollback);
        },
        /**
         * Callback after sorting
         * @private
         */
        onEndMove: function() {
          this.enable();
          (0, _utils_dom__WEBPACK_IMPORTED_MODULE_4__.AU)(this.getContentWindow(), "keydown", this.rollback);
        },
        /**
         * Say what to do after the component was selected (selectComponent)
         * @param {Event} e
         * @param {Object} Selected element
         * @private
         * */
        onSelect: function(e, el) {
        },
        /**
         * Used to bring the previous situation before start moving the component
         * @param {Event} e
         * @param {Boolean} Indicates if rollback in anycase
         * @private
         * */
        rollback: function(e, force) {
          var key = e.which || e.keyCode;
          if (key == 27 || force) {
            this.sorter.moved = false;
            this.sorter.endMove();
          }
          return;
        },
        /**
         * Returns badge element
         * @return {HTMLElement}
         * @private
         */
        getBadgeEl: function() {
          if (!this.$badge)
            this.$badge = (0, _common__WEBPACK_IMPORTED_MODULE_3__["default"])(this.getBadge());
          return this.$badge;
        },
        /**
         * Returns highlighter element
         * @return {HTMLElement}
         * @private
         */
        getHighlighterEl: function() {
          if (!this.$hl)
            this.$hl = (0, _common__WEBPACK_IMPORTED_MODULE_3__["default"])(this.canvas.getHighlighter());
          return this.$hl;
        },
        stop: function() {
          var args = [];
          for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
          }
          _SelectComponent__WEBPACK_IMPORTED_MODULE_2__["default"].stop.apply(this, args);
          this.getBadgeEl().removeClass(this.badgeClass);
          this.getHighlighterEl().removeClass(this.hoverClass);
          var wp = this.$wrapper;
          wp.css("cursor", "").unbind().removeClass(this.noSelClass);
        }
      });
    }
  ),
  /***/
  204: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _utils_dom__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(926);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        open: function(content) {
          var _this = this;
          var _a2 = this, editor = _a2.editor, title = _a2.title, config2 = _a2.config, am = _a2.am;
          var custom = config2.custom;
          if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(custom.open)) {
            return custom.open(am.__customData());
          }
          var Modal2 = editor.Modal;
          Modal2.open({ title, content }).onceClose(function() {
            return editor.stopCommand(_this.id);
          });
        },
        close: function() {
          var custom = this.config.custom;
          if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(custom.close)) {
            return custom.close(this.am.__customData());
          }
          var Modal2 = this.editor.Modal;
          Modal2 && Modal2.close();
        },
        run: function(editor, sender, opts) {
          if (opts === void 0) {
            opts = {};
          }
          var am = editor.AssetManager;
          var config2 = am.getConfig();
          var _a2 = opts.types, types2 = _a2 === void 0 ? [] : _a2, accept = opts.accept, select = opts.select;
          this.title = opts.modalTitle || editor.t("assetManager.modalTitle") || "";
          this.editor = editor;
          this.config = config2;
          this.am = am;
          am.setTarget(opts.target);
          am.onClick(opts.onClick);
          am.onDblClick(opts.onDblClick);
          am.onSelect(opts.onSelect);
          am.__behaviour({
            select,
            types: types2,
            options: opts
          });
          if (config2.custom) {
            this.rendered = this.rendered || (0, _utils_dom__WEBPACK_IMPORTED_MODULE_1__.a_)("div");
            this.rendered.className = "".concat(config2.stylePrefix, "custom-wrp");
            am.__behaviour({ container: this.rendered });
            am.__trgCustom();
          } else {
            if (!this.rendered || types2) {
              var assets = am.getAll().filter(function(i) {
                return i;
              });
              if (types2 && types2.length) {
                assets = assets.filter(function(a) {
                  return types2.indexOf(a.get("type")) !== -1;
                });
              }
              am.render(assets);
              this.rendered = am.getContainer();
            }
            if (accept) {
              var uploadEl = this.rendered.querySelector("input#".concat(config2.stylePrefix, "uploadFile"));
              uploadEl && uploadEl.setAttribute("accept", accept);
            }
          }
          this.open(this.rendered);
          return this;
        },
        stop: function(editor) {
          this.editor = editor;
          this.close(this.rendered);
        }
      };
    }
  ),
  /***/
  195: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _utils_dom__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(926);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        open: function() {
          var _a2 = this, container = _a2.container, editor = _a2.editor, bm = _a2.bm, config2 = _a2.config;
          var custom = config2.custom, appendTo = config2.appendTo;
          if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(custom.open)) {
            return custom.open(bm.__customData());
          }
          if (this.firstRender && !appendTo) {
            var id = "views-container";
            var pn = editor.Panels;
            var panels2 = pn.getPanel(id) || pn.addPanel({ id });
            panels2.set("appendContent", container).trigger("change:appendContent");
            if (!custom)
              container.appendChild(bm.render());
          }
          if (container)
            container.style.display = "block";
        },
        close: function() {
          var _a2 = this, container = _a2.container, config2 = _a2.config;
          var custom = config2.custom;
          if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(custom.close)) {
            return custom.close(this.bm.__customData());
          }
          if (container)
            container.style.display = "none";
        },
        run: function(editor) {
          var bm = editor.Blocks;
          this.config = bm.getConfig();
          this.firstRender = !this.container;
          this.container = this.container || (0, _utils_dom__WEBPACK_IMPORTED_MODULE_1__.a_)("div");
          this.editor = editor;
          this.bm = bm;
          var container = this.container;
          bm.__behaviour({
            container
          });
          if (this.config.custom) {
            bm.__trgCustom();
          }
          this.open();
        },
        stop: function() {
          this.close();
        }
      };
    }
  ),
  /***/
  671: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(editor) {
          var lm = editor.LayerManager;
          var pn = editor.Panels;
          var lmConfig = lm.getConfig();
          if (lmConfig.appendTo)
            return;
          if (!this.layers) {
            var id = "views-container";
            var layers = document.createElement("div");
            var panels2 = pn.getPanel(id) || pn.addPanel({ id });
            if (lmConfig.custom) {
              lm.__trgCustom({ container: layers });
            } else {
              layers.appendChild(lm.render());
            }
            panels2.set("appendContent", layers).trigger("change:appendContent");
            this.layers = layers;
          }
          this.layers.style.display = "block";
        },
        stop: function() {
          var layers = this.layers;
          layers && (layers.style.display = "none");
        }
      };
    }
  ),
  /***/
  49: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var _common__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(694);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(editor, sender) {
          this.sender = sender;
          if (!this.$cnt) {
            var config2 = editor.getConfig();
            var Panels2 = editor.Panels, DeviceManager2 = editor.DeviceManager, SelectorManager2 = editor.SelectorManager, StyleManager2 = editor.StyleManager;
            var trgEvCnt = "change:appendContent";
            var $cnt = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div></div>");
            var $cntInner = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div></div>");
            var $cntSlm = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div></div>");
            var $cntSm = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div></div>");
            this.$cnt = $cnt;
            this.$cntInner = $cntInner;
            $cntInner.append($cntSlm);
            $cntInner.append($cntSm);
            $cnt.append($cntInner);
            if (DeviceManager2 && config2.showDevices) {
              var devicePanel = Panels2.addPanel({ id: "devices-c" });
              var dvEl = DeviceManager2.render();
              devicePanel.set("appendContent", dvEl).trigger(trgEvCnt);
            }
            var slmConfig = SelectorManager2.getConfig();
            if (slmConfig.custom) {
              SelectorManager2.__trgCustom({ container: $cntSlm.get(0) });
            } else if (!slmConfig.appendTo) {
              $cntSlm.append(SelectorManager2.render([]));
            }
            this.sm = StyleManager2;
            var smConfig = StyleManager2.getConfig();
            var pfx = smConfig.stylePrefix;
            this.$header = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])('<div class="'.concat(pfx, 'header">').concat(editor.t("styleManager.empty"), "</div>"));
            $cnt.append(this.$header);
            if (smConfig.custom) {
              StyleManager2.__trgCustom({ container: $cntSm.get(0) });
            } else if (!smConfig.appendTo) {
              $cntSm.append(StyleManager2.render());
            }
            var pnCnt = "views-container";
            var pnl = Panels2.getPanel(pnCnt) || Panels2.addPanel({ id: pnCnt });
            pnl.set("appendContent", $cnt).trigger(trgEvCnt);
            var em = editor.getModel();
            this.listenTo(em, StyleManager2.events.target, this.toggleSm);
          }
          this.toggleSm();
        },
        /**
         * Toggle Style Manager visibility
         * @private
         */
        toggleSm: function() {
          var _a2 = this, sender = _a2.sender, sm = _a2.sm, $cntInner = _a2.$cntInner, $header = _a2.$header;
          if (sender && sender.get && !sender.get("active") || !sm)
            return;
          if (sm.getSelected()) {
            $cntInner === null || $cntInner === void 0 ? void 0 : $cntInner.show();
            $header === null || $header === void 0 ? void 0 : $header.hide();
          } else {
            $cntInner === null || $cntInner === void 0 ? void 0 : $cntInner.hide();
            $header === null || $header === void 0 ? void 0 : $header.show();
          }
        },
        stop: function() {
          var _a2, _b;
          (_a2 = this.$cntInner) === null || _a2 === void 0 ? void 0 : _a2.hide();
          (_b = this.$header) === null || _b === void 0 ? void 0 : _b.hide();
        }
      };
    }
  ),
  /***/
  590: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var _common__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(694);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(editor, sender) {
          this.sender = sender;
          var em = editor.getModel();
          var config2 = editor.Config;
          var pfx = config2.stylePrefix;
          var tm = editor.TraitManager;
          var confTm = tm.getConfig();
          var panelC;
          if (confTm.appendTo)
            return;
          if (!this.$cn) {
            this.$cn = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div></div>");
            this.$cn2 = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div></div>");
            this.$cn.append(this.$cn2);
            this.$header = (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])("<div>").append('<div class="'.concat(confTm.stylePrefix, 'header">').concat(em.t("traitManager.empty"), "</div>"));
            this.$cn.append(this.$header);
            if (confTm.custom) {
              tm.__trgCustom({ container: this.$cn2.get(0) });
            } else {
              this.$cn2.append('<div class="'.concat(pfx, 'traits-label">').concat(em.t("traitManager.label"), "</div>"));
              this.$cn2.append(tm.render());
            }
            var panels2 = editor.Panels;
            if (!panels2.getPanel("views-container")) {
              panelC = panels2.addPanel({ id: "views-container" });
            } else {
              panelC = panels2.getPanel("views-container");
            }
            panelC === null || panelC === void 0 ? void 0 : panelC.set("appendContent", this.$cn.get(0)).trigger("change:appendContent");
            this.target = editor.getModel();
            this.listenTo(this.target, "component:toggled", this.toggleTm);
          }
          this.toggleTm();
        },
        /**
         * Toggle Trait Manager visibility
         * @private
         */
        toggleTm: function() {
          var sender = this.sender;
          if (sender && sender.get && !sender.get("active"))
            return;
          if (this.target.getSelectedAll().length === 1) {
            this.$cn2.show();
            this.$header.hide();
          } else {
            this.$cn2.hide();
            this.$header.show();
          }
        },
        stop: function() {
          this.$cn2 && this.$cn2.hide();
          this.$header && this.$header.hide();
        }
      };
    }
  ),
  /***/
  483: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(ed, s, opts) {
          if (opts === void 0) {
            opts = {};
          }
          var em = ed.getModel();
          var clp = em.get("clipboard");
          var lastSelected = ed.getSelected();
          if ((clp === null || clp === void 0 ? void 0 : clp.length) && lastSelected) {
            ed.getSelectedAll().forEach(function(sel) {
              var _a2, _b, _c;
              var selected = ((_b = (_a2 = sel.delegate) === null || _a2 === void 0 ? void 0 : _a2.copy) === null || _b === void 0 ? void 0 : _b.call(_a2, sel)) || sel;
              var collection = selected.collection;
              var added;
              if (collection) {
                var at = selected.index() + 1;
                var addOpts = { at, action: opts.action || "paste-component" };
                if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.contains)(clp, selected) && selected.get("copyable")) {
                  added = collection.add(selected.clone(), addOpts);
                } else {
                  added = doAdd(ed, clp, selected.parent(), addOpts);
                }
              } else {
                var pageBody = (_c = em.Pages.getSelected()) === null || _c === void 0 ? void 0 : _c.getMainComponent();
                var addOpts = { at: (pageBody === null || pageBody === void 0 ? void 0 : pageBody.components().length) || 0, action: opts.action || "paste-component" };
                added = doAdd(ed, clp, pageBody, addOpts);
              }
              added = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isArray)(added) ? added : [added];
              added.forEach(function(add) {
                return ed.trigger("component:paste", add);
              });
            });
            lastSelected.emitUpdate();
          }
        }
      };
      function doAdd(ed, clp, parent, addOpts) {
        var copyable = clp.filter(function(cop) {
          return cop.get("copyable");
        });
        var pasteable = copyable.filter(function(cop) {
          return ed.Components.canMove(parent, cop).result;
        });
        return parent.components().add(pasteable.map(function(cop) {
          return cop.clone();
        }), addOpts);
      }
    }
  ),
  /***/
  857: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var __spreadArray2 = function(to, from, pack) {
        if (pack || arguments.length === 2)
          for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
              if (!ar)
                ar = Array.prototype.slice.call(from, 0, i);
              ar[i] = from[i];
            }
          }
        return to.concat(ar || Array.prototype.slice.call(from));
      };
      var cmdOutline = "core:component-outline";
      const __WEBPACK_DEFAULT_EXPORT__ = {
        getPanels: function(editor) {
          if (!this.panels) {
            this.panels = editor.Panels.getPanels();
          }
          return this.panels;
        },
        preventDrag: function(opts) {
          opts.abort = 1;
        },
        tglEffects: function(on) {
          var em = this.em;
          var mthEv = on ? "on" : "off";
          if (em) {
            var canvas2 = em.Canvas;
            var body = canvas2.getBody();
            var tlb = canvas2.getToolbarEl();
            tlb && (tlb.style.display = on ? "none" : "");
            var elP = body.querySelectorAll(".".concat(this.ppfx, "no-pointer"));
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(elP, function(item) {
              return item.style.pointerEvents = on ? "all" : "";
            });
            em[mthEv]("run:tlb-move:before", this.preventDrag);
          }
        },
        run: function(editor, sender) {
          var _this = this;
          this.sender = sender;
          this.selected = __spreadArray2([], editor.getSelectedAll(), true);
          editor.select();
          if (!this.shouldRunSwVisibility) {
            this.shouldRunSwVisibility = editor.Commands.isActive(cmdOutline);
          }
          this.shouldRunSwVisibility && editor.stopCommand(cmdOutline);
          editor.getModel().stopDefault();
          var panels2 = this.getPanels(editor);
          var canvas2 = editor.Canvas.getElement();
          var editorEl = editor.getEl();
          var pfx = editor.Config.stylePrefix;
          if (!this.helper) {
            var helper = document.createElement("span");
            helper.className = "".concat(pfx, "off-prv fa fa-eye-slash");
            editorEl.appendChild(helper);
            helper.onclick = function() {
              return _this.stopCommand();
            };
            this.helper = helper;
          }
          this.helper.style.display = "inline-block";
          panels2.forEach(function(panel) {
            return panel.set("visible", false);
          });
          var canvasS = canvas2.style;
          canvasS.width = "100%";
          canvasS.height = "100%";
          canvasS.top = "0";
          canvasS.left = "0";
          canvasS.padding = "0";
          canvasS.margin = "0";
          editor.refresh();
          this.tglEffects(1);
        },
        stop: function(editor) {
          var _a2 = this, _b = _a2.sender, sender = _b === void 0 ? {} : _b, selected = _a2.selected;
          sender.set && sender.set("active", 0);
          var panels2 = this.getPanels(editor);
          if (this.shouldRunSwVisibility) {
            editor.runCommand(cmdOutline);
            this.shouldRunSwVisibility = false;
          }
          editor.getModel().runDefault();
          panels2.forEach(function(panel) {
            return panel.set("visible", true);
          });
          var canvas2 = editor.Canvas.getElement();
          canvas2.setAttribute("style", "");
          selected && editor.select(selected);
          delete this.selected;
          if (this.helper) {
            this.helper.style.display = "none";
          }
          editor.refresh();
          this.tglEffects();
        }
      };
    }
  ),
  /***/
  869: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      const __WEBPACK_DEFAULT_EXPORT__ = {
        run: function(editor, sender, opts) {
          var opt = opts || {};
          var canvas2 = editor.Canvas;
          var canvasView = canvas2.getCanvasView();
          var options = __assign2({ appendTo: canvas2.getResizerEl(), prefix: editor.getConfig().stylePrefix, posFetcher: canvasView.getElementPos.bind(canvasView), mousePosFetcher: canvas2.getMouseRelativePos.bind(canvas2) }, opt.options || {});
          var canvasResizer = this.canvasResizer;
          if (!canvasResizer || opt.forceNew) {
            this.canvasResizer = new editor.Utils.Resizer(options);
            canvasResizer = this.canvasResizer;
          }
          canvasResizer.setOptions(options, true);
          canvasResizer.blur();
          canvasResizer.focus(opt.el);
          return canvasResizer;
        },
        stop: function() {
          var _a2;
          (_a2 = this.canvasResizer) === null || _a2 === void 0 ? void 0 : _a2.blur();
        }
      };
    }
  ),
  /***/
  194: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        "default": () => (
          /* binding */
          SelectComponent
        )
      });
      var index_all2 = __webpack_require__2(523);
      var common2 = __webpack_require__2(268);
      ;
      var __extends2 = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var ToolbarButton = (
        /** @class */
        function(_super) {
          __extends2(ToolbarButton2, _super);
          function ToolbarButton2() {
            return _super !== null && _super.apply(this, arguments) || this;
          }
          ToolbarButton2.prototype.defaults = function() {
            return {
              command: "",
              attributes: {}
            };
          };
          return ToolbarButton2;
        }(common2.Kx)
      );
      const model_ToolbarButton = ToolbarButton;
      ;
      var Toolbar_extends = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var Toolbar = (
        /** @class */
        function(_super) {
          Toolbar_extends(Toolbar2, _super);
          function Toolbar2() {
            return _super !== null && _super.apply(this, arguments) || this;
          }
          return Toolbar2;
        }(common2.pM)
      );
      const model_Toolbar = Toolbar;
      Toolbar.prototype.model = model_ToolbarButton;
      var DomainViews2 = __webpack_require__2(754);
      ;
      var ToolbarButtonView_extends = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      var ToolbarButtonView = (
        /** @class */
        function(_super) {
          ToolbarButtonView_extends(ToolbarButtonView2, _super);
          function ToolbarButtonView2(props) {
            var _this = _super.call(this, props) || this;
            _this.em = props.config.em;
            return _this;
          }
          ToolbarButtonView2.prototype.events = function() {
            return this.model.get("events") || {
              mousedown: "handleClick"
            };
          };
          ToolbarButtonView2.prototype.attributes = function() {
            return this.model.get("attributes");
          };
          ToolbarButtonView2.prototype.handleClick = function(event) {
            event.preventDefault();
            event.stopPropagation();
            var em = this.em;
            var _a2 = em.Canvas.getFrameEl().getBoundingClientRect(), left = _a2.left, top = _a2.top;
            var ev = __assign2(__assign2({}, event), { clientX: event.clientX - left, clientY: event.clientY - top });
            em.trigger("toolbar:run:before", { event: ev });
            this.execCommand(ev);
          };
          ToolbarButtonView2.prototype.execCommand = function(event) {
            var _a2 = this, em = _a2.em, model = _a2.model;
            var opts = { event };
            var command = model.get("command");
            var editor = em.Editor;
            if ((0, index_all2.isFunction)(command)) {
              command(editor, null, opts);
            }
            if ((0, index_all2.isString)(command)) {
              editor.runCommand(command, opts);
            }
          };
          ToolbarButtonView2.prototype.render = function() {
            var _a2 = this, em = _a2.em, $el = _a2.$el, model = _a2.model;
            var id = model.get("id");
            var label = model.get("label");
            var pfx = em.getConfig().stylePrefix;
            $el.addClass("".concat(pfx, "toolbar-item"));
            id && $el.addClass("".concat(pfx, "toolbar-item__").concat(id));
            label && $el.append(label);
            return this;
          };
          return ToolbarButtonView2;
        }(common2.Ss)
      );
      const view_ToolbarButtonView = ToolbarButtonView;
      ;
      var ToolbarView_extends = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var ToolbarView = (
        /** @class */
        function(_super) {
          ToolbarView_extends(ToolbarView2, _super);
          function ToolbarView2(opts) {
            var _this = _super.call(this, opts) || this;
            var em = opts.em;
            _this.em = em;
            _this.config = { em };
            _this.listenTo(_this.collection, "reset", _this.render);
            return _this;
          }
          ToolbarView2.prototype.onRender = function() {
            var pfx = this.em.config.stylePrefix;
            this.el.className = "".concat(pfx, "toolbar-items");
          };
          return ToolbarView2;
        }(DomainViews2.A)
      );
      const view_ToolbarView = ToolbarView;
      ToolbarView.prototype.itemView = view_ToolbarButtonView;
      var dom2 = __webpack_require__2(926);
      var mixins2 = __webpack_require__2(342);
      var CanvasSpot2 = __webpack_require__2(683);
      var types2 = __webpack_require__2(249);
      ;
      var SelectComponent_assign = function() {
        SelectComponent_assign = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return SelectComponent_assign.apply(this, arguments);
      };
      var __rest2 = function(s, e) {
        var t = {};
        for (var p in s)
          if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
            t[p] = s[p];
        if (s != null && typeof Object.getOwnPropertySymbols === "function")
          for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
              t[p[i]] = s[p[i]];
          }
        return t;
      };
      var showOffsets;
      const SelectComponent = {
        activeResizer: false,
        init: function() {
          this.onSelect = (0, index_all2.debounce)(this.onSelect, 0);
          (0, index_all2.bindAll)(this, "onHover", "onOut", "onClick", "onFrameScroll", "onFrameResize", "onFrameUpdated", "onContainerChange");
        },
        enable: function() {
          this.frameOff = this.canvasOff = this.adjScroll = null;
          this.startSelectComponent();
          showOffsets = true;
        },
        /**
         * Start select component event
         * @private
         * */
        startSelectComponent: function() {
          this.toggleSelectComponent(1);
          this.em.getSelected() && this.onSelect();
        },
        /**
         * Stop select component event
         * @private
         * */
        stopSelectComponent: function() {
          this.toggleSelectComponent();
        },
        /**
         * Toggle select component event
         * @private
         * */
        toggleSelectComponent: function(enable) {
          var _this = this;
          var em = this.em;
          var listenToEl = em.getConfig().listenToEl;
          var parentNode = em.getContainer().parentNode;
          var method = enable ? "on" : "off";
          var methods = { on: dom2.on, off: dom2.AU };
          var eventCmpUpdate = types2.I.update;
          !listenToEl.length && parentNode && listenToEl.push(parentNode);
          var trigger = function(win, body) {
            methods[method](body, "mouseover", _this.onHover);
            methods[method](body, "mouseleave", _this.onOut);
            methods[method](body, "click", _this.onClick);
            methods[method](win, "scroll", _this.onFrameScroll, true);
            methods[method](win, "resize", _this.onFrameResize);
          };
          methods[method](window, "resize", this.onFrameUpdated);
          methods[method](listenToEl, "scroll", this.onContainerChange);
          em[method]("component:toggled ".concat(eventCmpUpdate, " undo redo"), this.onSelect, this);
          em[method]("change:componentHovered", this.onHovered, this);
          em[method]("component:resize styleable:change component:input", this.updateGlobalPos, this);
          em[method]("".concat(eventCmpUpdate, ":toolbar"), this._upToolbar, this);
          em[method]("frame:updated", this.onFrameUpdated, this);
          em[method]("canvas:updateTools", this.onFrameUpdated, this);
          em[method](em.Canvas.events.refresh, this.updateAttached, this);
          em.Canvas.getFrames().forEach(function(frame) {
            var view = frame.view;
            var win = view === null || view === void 0 ? void 0 : view.getWindow();
            win && trigger(win, view === null || view === void 0 ? void 0 : view.getBody());
          });
        },
        /**
         * Hover command
         * @param {Object}  e
         * @private
         */
        onHover: function(ev) {
          ev.stopPropagation();
          var em = this.em;
          var el = ev.target;
          var view = (0, mixins2.getComponentView)(el);
          var frameView = view === null || view === void 0 ? void 0 : view.frameView;
          var model = view === null || view === void 0 ? void 0 : view.model;
          if (!model) {
            var parentEl = el.parentNode;
            while (!model && parentEl && !(0, dom2.ZQ)(parentEl)) {
              model = (0, mixins2.getComponentModel)(parentEl);
              parentEl = parentEl.parentNode;
            }
          }
          this.currentDoc = el.ownerDocument;
          em.setHovered(model, { useValid: true });
          frameView && em.setCurrentFrame(frameView);
        },
        onFrameUpdated: function() {
          this.updateLocalPos();
          this.updateGlobalPos();
        },
        onHovered: function(em, component) {
          var _this = this;
          var _a2;
          var result = {};
          if (component) {
            (_a2 = component.views) === null || _a2 === void 0 ? void 0 : _a2.forEach(function(view) {
              var el = view.el;
              var pos = _this.getElementPos(el);
              result = { el, pos, component, view: (0, mixins2.getViewEl)(el) };
              if (el.ownerDocument === _this.currentDoc) {
                _this.elHovered = result;
              }
              _this.updateToolsLocal(result);
            });
          } else {
            this.currentDoc = null;
            this.elHovered = 0;
            this.updateToolsLocal();
            this.canvas.getFrames().forEach(function(frame) {
              var view = frame.view;
              var el = view && view.getToolsEl();
              el && _this.toggleToolsEl(0, 0, { el });
            });
          }
        },
        /**
         * Say what to do after the component was selected
         * @param {Object}  e
         * @param {Object}  el
         * @private
         * */
        onSelect: function() {
          var em = this.em;
          var component = em.getSelected();
          var currentFrame = em.getCurrentFrame();
          var view = component && component.getView(currentFrame === null || currentFrame === void 0 ? void 0 : currentFrame.model);
          var el = view && view.el;
          var result = {};
          if (el && (0, dom2.zN)(el)) {
            var pos = this.getElementPos(el);
            result = { el, pos, component, view: (0, mixins2.getViewEl)(el) };
          }
          this.elSelected = result;
          this.updateToolsGlobal();
          this.updateLocalPos(result);
          this.initResize(component);
        },
        updateGlobalPos: function() {
          var sel = this.getElSelected();
          if (!sel.el)
            return;
          sel.pos = this.getElementPos(sel.el);
          this.updateToolsGlobal();
        },
        updateLocalPos: function(data) {
          var sel = this.getElHovered();
          if (!sel.el)
            return;
          sel.pos = this.getElementPos(sel.el);
          this.updateToolsLocal(data);
        },
        getElHovered: function() {
          return this.elHovered || {};
        },
        getElSelected: function() {
          return this.elSelected || {};
        },
        onOut: function() {
          this.em.setHovered();
        },
        toggleToolsEl: function(on, view, opts) {
          if (opts === void 0) {
            opts = {};
          }
          var el = opts.el || this.canvas.getToolsEl(view);
          el && (el.style.display = on ? "" : "none");
          return el || {};
        },
        /**
         * Show element offset viewer
         * @param {HTMLElement}  el
         * @param {Object} pos
         */
        showElementOffset: function(el, pos, opts) {
          if (opts === void 0) {
            opts = {};
          }
          if (!showOffsets)
            return;
          this.editor.runCommand("show-offset", {
            el,
            elPos: pos,
            view: opts.view,
            force: 1,
            top: 0,
            left: 0
          });
        },
        /**
         * Hide element offset viewer
         * @param {HTMLElement}  el
         * @param {Object} pos
         */
        hideElementOffset: function(view) {
          this.editor.stopCommand("show-offset", {
            view
          });
        },
        /**
         * Show fixed element offset viewer
         * @param {HTMLElement}  el
         * @param {Object} pos
         */
        showFixedElementOffset: function(el, pos) {
          this.editor.runCommand("show-offset", {
            el,
            elPos: pos,
            state: "Fixed"
          });
        },
        /**
         * Hide fixed element offset viewer
         * @param {HTMLElement}  el
         * @param {Object} pos
         */
        hideFixedElementOffset: function() {
          if (this.editor)
            this.editor.stopCommand("show-offset", { state: "Fixed" });
        },
        /**
         * Hide Highlighter element
         */
        hideHighlighter: function(view) {
          this.canvas.getHighlighter(view).style.opacity = 0;
        },
        /**
         * On element click
         * @param {Event}  e
         * @private
         */
        onClick: function(ev) {
          ev.stopPropagation();
          ev.preventDefault();
          var em = this.em;
          if (em.get("_cmpDrag"))
            return em.set("_cmpDrag");
          var el = ev.target;
          var cmp = (0, mixins2.getComponentModel)(el);
          if (!cmp) {
            var parentEl = el.parentNode;
            while (!cmp && parentEl && !(0, dom2.ZQ)(parentEl)) {
              cmp = (0, mixins2.getComponentModel)(parentEl);
              parentEl = parentEl.parentNode;
            }
          }
          if (cmp) {
            if (em.isEditing() && // Avoid selection of inner text components during editing
            (!cmp.get("textable") && cmp.isChildOf("text") || // Prevents selecting another component if the pointer was pressed and
            // dragged outside of the editing component
            em.getEditing() !== cmp)) {
              return;
            }
            this.select(cmp, ev);
          }
        },
        /**
         * Select component
         * @param  {Component} model
         * @param  {Event} event
         */
        select: function(model, event) {
          if (event === void 0) {
            event = {};
          }
          if (!model)
            return;
          this.editor.select(model, { event, useValid: true });
          this.initResize(model);
        },
        /**
         * Update badge for the component
         * @param {Object} Component
         * @param {Object} pos Position object
         * @private
         * */
        updateBadge: function(el, pos, opts) {
          if (opts === void 0) {
            opts = {};
          }
          var canvas2 = this.canvas;
          var model = (0, mixins2.getComponentModel)(el);
          var badge = this.getBadge(opts);
          var bStyle = badge.style;
          if (!model || !model.get("badgable")) {
            bStyle.display = "none";
            return;
          }
          if (!opts.posOnly) {
            var config2 = this.canvas.getConfig();
            var icon = model.getIcon();
            var ppfx = config2.pStylePrefix || "";
            var clsBadge = "".concat(ppfx, "badge");
            var customeLabel = config2.customBadgeLabel;
            var badgeLabel = "".concat(icon ? '<div class="'.concat(clsBadge, '__icon">').concat(icon, "</div>") : "", '\n        <div class="').concat(clsBadge, '__name">').concat(model.getName(), "</div>");
            badge.innerHTML = customeLabel ? customeLabel(model) : badgeLabel;
          }
          var un = "px";
          bStyle.display = "block";
          var targetToElem = canvas2.getTargetToElementFixed(el, badge, {
            pos
          });
          var top = targetToElem.top;
          var left = opts.leftOff < 0 ? -opts.leftOff : 0;
          bStyle.top = top + un;
          bStyle.left = left + un;
        },
        /**
         * Update highlighter element
         * @param {HTMLElement} el
         * @param {Object} pos Position object
         * @private
         */
        showHighlighter: function(view) {
          this.canvas.getHighlighter(view).style.opacity = "";
        },
        /**
         * Init resizer on the element if possible
         * @param  {HTMLElement|Component} elem
         * @private
         */
        initResize: function(elem) {
          var _a2 = this, em = _a2.em, canvas2 = _a2.canvas;
          var editor = em.Editor;
          var model = !(0, index_all2.isElement)(elem) && (0, dom2.GW)(elem) ? elem : em.getSelected();
          var resizable = model === null || model === void 0 ? void 0 : model.get("resizable");
          var spotTypeResize = CanvasSpot2.F.Resize;
          var hasCustomResize = canvas2.hasCustomSpot(spotTypeResize);
          canvas2.removeSpots({ type: spotTypeResize });
          if (model && resizable) {
            canvas2.addSpot({ type: spotTypeResize, component: model });
            var el = (0, index_all2.isElement)(elem) ? elem : model.getEl();
            var _b = (0, mixins2.isObject)(resizable) ? resizable : {}, _c = _b.onStart, onStart_1 = _c === void 0 ? function() {
            } : _c, _d = _b.onMove, onMove_1 = _d === void 0 ? function() {
            } : _d, _e = _b.onEnd, onEnd_1 = _e === void 0 ? function() {
            } : _e, _f = _b.updateTarget, updateTarget_1 = _f === void 0 ? function() {
            } : _f, resizableOpts = __rest2(_b, ["onStart", "onMove", "onEnd", "updateTarget"]);
            if (hasCustomResize || !el || this.activeResizer)
              return;
            var modelToStyle_1;
            var config2 = em.config;
            var pfx = config2.stylePrefix || "";
            var resizeClass_1 = "".concat(pfx, "resizing");
            var self_1 = this;
            var resizeEventOpts_1 = {
              component: model,
              el
            };
            var toggleBodyClass_1 = function(method, e, opts) {
              var docs = opts.docs;
              docs && docs.forEach(function(doc) {
                var body = doc.body;
                var cls = body.className || "";
                body.className = (method == "add" ? "".concat(cls, " ").concat(resizeClass_1) : cls.replace(resizeClass_1, "")).trim();
              });
            };
            var options = SelectComponent_assign({
              // Here the resizer is updated with the current element height and width
              onStart: function(ev, opts) {
                onStart_1(ev, opts);
                var el2 = opts.el, config3 = opts.config, resizer = opts.resizer;
                var keyHeight = config3.keyHeight, keyWidth = config3.keyWidth, currentUnit = config3.currentUnit, keepAutoHeight = config3.keepAutoHeight, keepAutoWidth = config3.keepAutoWidth;
                toggleBodyClass_1("add", ev, opts);
                modelToStyle_1 = em.Styles.getModelToStyle(model);
                canvas2.toggleFramesEvents(false);
                var computedStyle = getComputedStyle(el2);
                var modelStyle = modelToStyle_1.getStyle();
                var currentWidth = modelStyle[keyWidth];
                config3.autoWidth = keepAutoWidth && currentWidth === "auto";
                if (isNaN(parseFloat(currentWidth))) {
                  currentWidth = computedStyle[keyWidth];
                }
                var currentHeight = modelStyle[keyHeight];
                config3.autoHeight = keepAutoHeight && currentHeight === "auto";
                if (isNaN(parseFloat(currentHeight))) {
                  currentHeight = computedStyle[keyHeight];
                }
                resizer.startDim.w = parseFloat(currentWidth);
                resizer.startDim.h = parseFloat(currentHeight);
                showOffsets = false;
                if (currentUnit) {
                  config3.unitHeight = (0, mixins2.getUnitFromValue)(currentHeight);
                  config3.unitWidth = (0, mixins2.getUnitFromValue)(currentWidth);
                }
                self_1.activeResizer = true;
                editor.trigger("component:resize", SelectComponent_assign(SelectComponent_assign({}, resizeEventOpts_1), { type: "start" }));
              },
              // Update all positioned elements (eg. component toolbar)
              onMove: function(ev) {
                onMove_1(ev);
                editor.trigger("component:resize", SelectComponent_assign(SelectComponent_assign({}, resizeEventOpts_1), { type: "move" }));
              },
              onEnd: function(ev, opts) {
                onEnd_1(ev, opts);
                toggleBodyClass_1("remove", ev, opts);
                editor.trigger("component:resize", SelectComponent_assign(SelectComponent_assign({}, resizeEventOpts_1), { type: "end" }));
                canvas2.toggleFramesEvents(true);
                showOffsets = true;
                self_1.activeResizer = false;
              },
              updateTarget: function(el2, rect, options2) {
                updateTarget_1(el2, rect, options2);
                if (!modelToStyle_1) {
                  return;
                }
                var store = options2.store, selectedHandler = options2.selectedHandler, config3 = options2.config;
                var keyHeight = config3.keyHeight, keyWidth = config3.keyWidth, autoHeight = config3.autoHeight, autoWidth = config3.autoWidth, unitWidth = config3.unitWidth, unitHeight = config3.unitHeight;
                var onlyHeight = ["tc", "bc"].indexOf(selectedHandler) >= 0;
                var onlyWidth = ["cl", "cr"].indexOf(selectedHandler) >= 0;
                var style = {};
                if (!onlyHeight) {
                  var bodyw = canvas2.getBody().offsetWidth;
                  var width = rect.w < bodyw ? rect.w : bodyw;
                  style[keyWidth] = autoWidth ? "auto" : "".concat(width).concat(unitWidth);
                }
                if (!onlyWidth) {
                  style[keyHeight] = autoHeight ? "auto" : "".concat(rect.h).concat(unitHeight);
                }
                if (em.getDragMode(model)) {
                  style.top = "".concat(rect.t).concat(unitHeight);
                  style.left = "".concat(rect.l).concat(unitWidth);
                }
                var finalStyle = SelectComponent_assign(SelectComponent_assign({}, style), {
                  // value for the partial update
                  __p: !store
                });
                modelToStyle_1.addStyle(finalStyle, { avoidStore: !store });
                em.Styles.__emitCmpStyleUpdate(finalStyle, { components: em.getSelected() });
              }
            }, resizableOpts);
            this.resizer = editor.runCommand("resize", { el, options, force: 1 });
          } else {
            if (hasCustomResize)
              return;
            editor.stopCommand("resize");
            this.resizer = null;
          }
        },
        /**
         * Update toolbar if the component has one
         * @param {Object} mod
         */
        updateToolbar: function(mod) {
          var canvas2 = this.canvas;
          var em = this.config.em;
          var model = mod === em ? em.getSelected() : mod;
          var toolbarEl = canvas2.getToolbarEl();
          var toolbarStyle = toolbarEl.style;
          var toolbar = model.get("toolbar");
          var showToolbar = em.config.showToolbar;
          var noCustomSpotSelect = !canvas2.hasCustomSpot(CanvasSpot2.F.Select);
          if (model && showToolbar && toolbar && toolbar.length && noCustomSpotSelect) {
            toolbarStyle.display = "";
            if (!this.toolbar) {
              toolbarEl.innerHTML = "";
              this.toolbar = new model_Toolbar(toolbar);
              var toolbarView = new view_ToolbarView({ collection: this.toolbar, em });
              toolbarEl.appendChild(toolbarView.render().el);
            }
            this.toolbar.reset(toolbar);
            toolbarStyle.top = "-100px";
            toolbarStyle.left = "0";
          } else {
            toolbarStyle.display = "none";
          }
        },
        /**
         * Update toolbar positions
         * @param {HTMLElement} el
         * @param {Object} pos
         */
        updateToolbarPos: function(pos) {
          var unit = "px";
          var style = this.canvas.getToolbarEl().style;
          style.top = "".concat(pos.top).concat(unit);
          style.left = "".concat(pos.left).concat(unit);
          style.opacity = "";
        },
        /**
         * Return canvas dimensions and positions
         * @return {Object}
         */
        getCanvasPosition: function() {
          return this.canvas.getCanvasView().getPosition();
        },
        /**
         * Returns badge element
         * @return {HTMLElement}
         * @private
         */
        getBadge: function(opts) {
          if (opts === void 0) {
            opts = {};
          }
          return this.canvas.getBadgeEl(opts.view);
        },
        /**
         * On frame scroll callback
         * @private
         */
        onFrameScroll: function() {
          this.updateTools();
          this.canvas.refreshSpots();
        },
        onFrameResize: function() {
          this.canvas.refresh({ all: true });
        },
        updateTools: function() {
          this.updateLocalPos();
          this.updateGlobalPos();
        },
        isCompSelected: function(comp) {
          return comp && comp.get("status") === "selected";
        },
        /**
         * Update tools visible on hover
         * @param {HTMLElement} el
         * @param {Object} pos
         */
        updateToolsLocal: function(data) {
          var config2 = this.em.getConfig();
          var _a2 = data || this.getElHovered(), el = _a2.el, pos = _a2.pos, view = _a2.view, component = _a2.component;
          if (!el) {
            this.lastHovered = 0;
            return;
          }
          var isHoverEn = component.get("hoverable");
          var isNewEl = this.lastHovered !== el;
          var badgeOpts = isNewEl ? {} : { posOnly: 1 };
          var customHoverSpot = this.canvas.hasCustomSpot(CanvasSpot2.F.Hover);
          if (isNewEl && isHoverEn) {
            this.lastHovered = el;
            customHoverSpot ? this.hideHighlighter(view) : this.showHighlighter(view);
            this.showElementOffset(el, pos, { view });
          }
          if (this.isCompSelected(component)) {
            this.hideHighlighter(view);
            !config2.showOffsetsSelected && this.hideElementOffset(view);
          }
          var unit = "px";
          var toolsEl = this.toggleToolsEl(1, view);
          var style = toolsEl.style;
          var frameOff = this.canvas.canvasRectOffset(el, pos);
          var topOff = frameOff.top;
          var leftOff = frameOff.left;
          !customHoverSpot && this.updateBadge(el, pos, SelectComponent_assign(SelectComponent_assign({}, badgeOpts), { view, topOff, leftOff }));
          style.top = topOff + unit;
          style.left = leftOff + unit;
          style.width = pos.width + unit;
          style.height = pos.height + unit;
          this._trgToolUp("local", {
            component,
            el: toolsEl,
            top: topOff,
            left: leftOff,
            width: pos.width,
            height: pos.height
          });
        },
        _upToolbar: (0, index_all2.debounce)(function() {
          this.updateToolsGlobal({ force: 1 });
        }, 0),
        _trgToolUp: function(type2, opts) {
          if (opts === void 0) {
            opts = {};
          }
          this.em.trigger("canvas:tools:update", SelectComponent_assign({ type: type2 }, opts));
        },
        updateToolsGlobal: function(opts) {
          if (opts === void 0) {
            opts = {};
          }
          var _a2 = this.getElSelected(), el = _a2.el, pos = _a2.pos, component = _a2.component;
          if (!el) {
            this.toggleToolsEl();
            this.lastSelected = 0;
            return;
          }
          var canvas2 = this.canvas;
          var isNewEl = this.lastSelected !== el;
          if (isNewEl || opts.force) {
            this.lastSelected = el;
            this.updateToolbar(component);
          }
          var unit = "px";
          var toolsEl = this.toggleToolsEl(1);
          var style = toolsEl.style;
          var targetToElem = canvas2.getTargetToElementFixed(el, canvas2.getToolbarEl(), { pos });
          var topOff = targetToElem.canvasOffsetTop;
          var leftOff = targetToElem.canvasOffsetLeft;
          style.top = topOff + unit;
          style.left = leftOff + unit;
          style.width = pos.width + unit;
          style.height = pos.height + unit;
          this.updateToolbarPos({ top: targetToElem.top, left: targetToElem.left });
          this._trgToolUp("global", {
            component,
            el: toolsEl,
            top: topOff,
            left: leftOff,
            width: pos.width,
            height: pos.height
          });
        },
        /**
         * Update attached elements, eg. component toolbar
         */
        updateAttached: (0, index_all2.debounce)(function() {
          this.updateGlobalPos();
        }, 0),
        onContainerChange: (0, index_all2.debounce)(function() {
          this.em.refreshCanvas();
        }, 150),
        /**
         * Returns element's data info
         * @param {HTMLElement} el
         * @return {Object}
         * @private
         */
        getElementPos: function(el) {
          return this.canvas.getCanvasView().getElementPos(el, { noScroll: true });
        },
        /**
         * Hide badge
         * @private
         * */
        hideBadge: function() {
          this.getBadge().style.display = "none";
        },
        /**
         * Clean previous model from different states
         * @param {Component} model
         * @private
         */
        cleanPrevious: function(model) {
          model && model.set({
            status: "",
            state: ""
          });
        },
        /**
         * Returns content window
         * @private
         */
        getContentWindow: function() {
          return this.canvas.getWindow();
        },
        run: function(editor) {
          if (!(0, mixins2.hasWin)())
            return;
          this.editor = editor && editor.get("Editor");
          this.enable();
        },
        stop: function(ed, sender, opts) {
          if (opts === void 0) {
            opts = {};
          }
          if (!(0, mixins2.hasWin)())
            return;
          var _a2 = this, em = _a2.em, editor = _a2.editor;
          this.onHovered();
          this.stopSelectComponent();
          !opts.preserveSelected && em.setSelected();
          this.toggleToolsEl();
          editor && editor.stopCommand("resize");
        }
      };
    }
  ),
  /***/
  582: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var _common__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(694);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        /**
         * Start select position event
         * @param {HTMLElement} trg
         * @private
         * */
        startSelectPosition: function(trg, doc, opts) {
          var _this = this;
          if (opts === void 0) {
            opts = {};
          }
          this.isPointed = false;
          var utils2 = this.em.Utils;
          var container = trg.ownerDocument.body;
          if (utils2 && !this.sorter)
            this.sorter = new utils2.Sorter({
              // @ts-ignore
              container,
              placer: this.canvas.getPlacerEl(),
              containerSel: "*",
              itemSel: "*",
              pfx: this.ppfx,
              direction: "a",
              document: doc,
              wmargin: 1,
              nested: 1,
              em: this.em,
              canvasRelative: 1,
              scale: function() {
                return _this.em.getZoomDecimal();
              }
            });
          if (opts.onStart)
            this.sorter.onStart = opts.onStart;
          trg && this.sorter.startSort(trg, { container });
        },
        /**
         * Get frame position
         * @return {Object}
         * @private
         */
        getOffsetDim: function() {
          var frameOff = this.offset(this.canvas.getFrameEl());
          var canvasOff = this.offset(this.canvas.getElement());
          var top = frameOff.top - canvasOff.top;
          var left = frameOff.left - canvasOff.left;
          return { top, left };
        },
        /**
         * Stop select position event
         * @private
         * */
        stopSelectPosition: function() {
          this.posTargetCollection = null;
          this.posIndex = this.posMethod == "after" && this.cDim.length !== 0 ? this.posIndex + 1 : this.posIndex;
          if (this.sorter) {
            this.sorter.moved = 0;
            this.sorter.endMove();
          }
          if (this.cDim) {
            this.posIsLastEl = this.cDim.length !== 0 && this.posMethod == "after" && this.posIndex == this.cDim.length;
            this.posTargetEl = this.cDim.length === 0 ? (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])(this.outsideElem) : !this.posIsLastEl && this.cDim[this.posIndex] ? (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])(this.cDim[this.posIndex][5]).parent() : (0, _common__WEBPACK_IMPORTED_MODULE_0__["default"])(this.outsideElem);
            this.posTargetModel = this.posTargetEl.data("model");
            this.posTargetCollection = this.posTargetEl.data("model-comp");
          }
        },
        /**
         * Enabel select position
         * @private
         */
        enable: function() {
          this.startSelectPosition();
        },
        /**
         * Check if the pointer is near to the float component
         * @param {number} index
         * @param {string} method
         * @param {Array<Array>} dims
         * @return {Boolean}
         * @private
         * */
        nearFloat: function(index2, method, dims) {
          var i = index2 || 0;
          var m = method || "before";
          var len = dims.length;
          var isLast = len !== 0 && m == "after" && i == len;
          if (len !== 0 && (!isLast && !dims[i][4] || dims[i - 1] && !dims[i - 1][4] || isLast && !dims[i - 1][4]))
            return 1;
          return 0;
        },
        run: function() {
          this.enable();
        },
        stop: function() {
          this.stopSelectPosition();
          this.$wrapper.css("cursor", "");
          this.$wrapper.unbind();
        }
      };
    }
  ),
  /***/
  131: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _canvas_model_CanvasSpot__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(683);
      var _common__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__2(694);
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      const __WEBPACK_DEFAULT_EXPORT__ = {
        getOffsetMethod: function(state) {
          var method = state || "";
          return "get" + method + "OffsetViewerEl";
        },
        run: function(editor, sender, opts) {
          var canvas2 = this.canvas;
          var opt = opts || {};
          var state = opt.state || "";
          var config2 = editor.getConfig();
          var zoom = this.em.getZoomDecimal();
          var el = opt.el;
          if (!config2.showOffsets || !(el instanceof HTMLElement) || !config2.showOffsetsSelected && state == "Fixed") {
            editor.stopCommand("".concat(this.id), opts);
            return;
          }
          if (canvas2.hasCustomSpot(_canvas_model_CanvasSpot__WEBPACK_IMPORTED_MODULE_1__.F.Spacing)) {
            return;
          }
          var pos = __assign2({}, opt.elPos || canvas2.getElementPos(el));
          if (!(0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(opt.top)) {
            pos.top = opt.top;
          }
          if (!(0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(opt.left)) {
            pos.left = opt.left;
          }
          var style = window.getComputedStyle(el);
          var ppfx = this.ppfx;
          var stateVar = state + "State";
          var method = this.getOffsetMethod(state);
          var offsetViewer = canvas2[method](opts.view);
          offsetViewer.style.opacity = "";
          var marginT = this["marginT" + state];
          var marginB = this["marginB" + state];
          var marginL = this["marginL" + state];
          var marginR = this["marginR" + state];
          var padT = this["padT" + state];
          var padB = this["padB" + state];
          var padL = this["padL" + state];
          var padR = this["padR" + state];
          if (offsetViewer.childNodes.length) {
            this[stateVar] = "1";
            marginT = offsetViewer.querySelector("[data-offset-m-t]");
            marginB = offsetViewer.querySelector("[data-offset-m-b]");
            marginL = offsetViewer.querySelector("[data-offset-m-l]");
            marginR = offsetViewer.querySelector("[data-offset-m-r]");
            padT = offsetViewer.querySelector("[data-offset-p-t]");
            padB = offsetViewer.querySelector("[data-offset-p-b]");
            padL = offsetViewer.querySelector("[data-offset-p-l]");
            padR = offsetViewer.querySelector("[data-offset-p-r]");
          }
          if (!this[stateVar]) {
            var stateLow = state.toLowerCase();
            var marginName = stateLow + "margin-v";
            var paddingName = stateLow + "padding-v";
            var marginV = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(ppfx, 'marginName">')).get(0);
            var paddingV = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(ppfx, 'paddingName">')).get(0);
            var marginEls = ppfx + marginName + "-el";
            var paddingEls = ppfx + paddingName + "-el";
            var fullMargName = "".concat(marginEls, " ").concat(ppfx + marginName);
            var fullPadName = "".concat(paddingEls, " ").concat(ppfx + paddingName);
            marginT = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullMargName, '-top"></div>')).get(0);
            marginB = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullMargName, '-bottom"></div>')).get(0);
            marginL = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullMargName, '-left"></div>')).get(0);
            marginR = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullMargName, '-right"></div>')).get(0);
            padT = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullPadName, '-top"></div>')).get(0);
            padB = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullPadName, '-bottom"></div>')).get(0);
            padL = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullPadName, '-left"></div>')).get(0);
            padR = (0, _common__WEBPACK_IMPORTED_MODULE_2__["default"])('<div class="'.concat(fullPadName, '-right"></div>')).get(0);
            this["marginT" + state] = marginT;
            this["marginB" + state] = marginB;
            this["marginL" + state] = marginL;
            this["marginR" + state] = marginR;
            this["padT" + state] = padT;
            this["padB" + state] = padB;
            this["padL" + state] = padL;
            this["padR" + state] = padR;
            marginV.appendChild(marginT);
            marginV.appendChild(marginB);
            marginV.appendChild(marginL);
            marginV.appendChild(marginR);
            paddingV.appendChild(padT);
            paddingV.appendChild(padB);
            paddingV.appendChild(padL);
            paddingV.appendChild(padR);
            offsetViewer.appendChild(marginV);
            offsetViewer.appendChild(paddingV);
            this[stateVar] = "1";
          }
          var unit = "px";
          var marginLeftSt = parseFloat(style.marginLeft.replace(unit, "")) * zoom;
          var marginRightSt = parseFloat(style.marginRight.replace(unit, "")) * zoom;
          var marginTopSt = parseFloat(style.marginTop.replace(unit, "")) * zoom;
          var marginBottomSt = parseFloat(style.marginBottom.replace(unit, "")) * zoom;
          var mtStyle = marginT.style;
          var mbStyle = marginB.style;
          var mlStyle = marginL.style;
          var mrStyle = marginR.style;
          var ptStyle = padT.style;
          var pbStyle = padB.style;
          var plStyle = padL.style;
          var prStyle = padR.style;
          var posLeft = parseFloat(pos.left);
          var widthEl = parseFloat(style.width) * zoom + unit;
          mtStyle.height = marginTopSt + unit;
          mtStyle.width = widthEl;
          mtStyle.top = pos.top - marginTopSt + unit;
          mtStyle.left = posLeft + unit;
          mbStyle.height = marginBottomSt + unit;
          mbStyle.width = widthEl;
          mbStyle.top = pos.top + pos.height + unit;
          mbStyle.left = posLeft + unit;
          var marginSideH = pos.height + marginTopSt + marginBottomSt + unit;
          var marginSideT = pos.top - marginTopSt + unit;
          mlStyle.height = marginSideH;
          mlStyle.width = marginLeftSt + unit;
          mlStyle.top = marginSideT;
          mlStyle.left = posLeft - marginLeftSt + unit;
          mrStyle.height = marginSideH;
          mrStyle.width = marginRightSt + unit;
          mrStyle.top = marginSideT;
          mrStyle.left = posLeft + pos.width + unit;
          var padTop = parseFloat(style.paddingTop) * zoom;
          ptStyle.height = padTop + unit;
          var padBot = parseFloat(style.paddingBottom) * zoom;
          pbStyle.height = padBot + unit;
          var padSideH = pos.height - padBot - padTop + unit;
          var padSideT = pos.top + padTop + unit;
          plStyle.height = padSideH;
          plStyle.width = parseFloat(style.paddingLeft) * zoom + unit;
          plStyle.top = padSideT;
          var padRight = parseFloat(style.paddingRight) * zoom;
          prStyle.height = padSideH;
          prStyle.width = padRight + unit;
          prStyle.top = padSideT;
        },
        stop: function(editor, sender, opts) {
          if (opts === void 0) {
            opts = {};
          }
          var opt = opts || {};
          var state = opt.state || "";
          var method = this.getOffsetMethod(state);
          var view = opts.view;
          var canvas2 = this.canvas;
          var offsetViewer = canvas2[method](view);
          offsetViewer.style.opacity = 0;
        }
      };
    }
  ),
  /***/
  229: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _utils_mixins__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(342);
      const __WEBPACK_DEFAULT_EXPORT__ = {
        init: function() {
          (0, underscore__WEBPACK_IMPORTED_MODULE_0__.bindAll)(this, "_onFramesChange");
        },
        run: function(ed) {
          this.toggleVis(ed, true);
        },
        stop: function(ed) {
          this.toggleVis(ed, false);
        },
        toggleVis: function(ed, active) {
          if (active === void 0) {
            active = true;
          }
          if (!ed.Commands.isActive("preview")) {
            var cv = ed.Canvas;
            var mth = active ? "on" : "off";
            var canvasModel = cv.getModel();
            canvasModel[mth]("change:frames", this._onFramesChange);
            this.handleFrames(cv.getFrames(), active);
          }
        },
        handleFrames: function(frames, active) {
          var _this = this;
          frames.forEach(function(frame) {
            var _a2;
            ((_a2 = frame.view) === null || _a2 === void 0 ? void 0 : _a2.loaded) && _this._upFrame(frame, active);
            if (!frame.__ol) {
              frame.on("loaded", function() {
                return _this._upFrame(frame);
              });
              frame.__ol = true;
            }
          });
        },
        _onFramesChange: function(_, frames) {
          this.handleFrames(frames);
        },
        _upFrame: function(frame, active) {
          var _a2;
          var _b = this, ppfx = _b.ppfx, em = _b.em, id = _b.id;
          var isActive = (0, _utils_mixins__WEBPACK_IMPORTED_MODULE_1__.isDef)(active) ? active : em.Commands.isActive(id);
          var method = isActive ? "add" : "remove";
          var cls = "".concat(ppfx, "dashed");
          (_a2 = frame.view) === null || _a2 === void 0 ? void 0 : _a2.getBody().classList[method](cls);
        }
      };
    }
  ),
  /***/
  268: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        Kx: () => (
          /* binding */
          Model
        ),
        /* harmony export */
        Ss: () => (
          /* binding */
          View
        ),
        /* harmony export */
        lK: () => (
          /* binding */
          DEFAULT_COORDS
        ),
        /* harmony export */
        pM: () => (
          /* binding */
          Collection
        ),
        /* harmony export */
        x2: () => (
          /* binding */
          CoordinatesTypes
        )
        /* harmony export */
      });
      var backbone__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(391);
      var backbone__WEBPACK_IMPORTED_MODULE_0___default = __webpack_require__2.n(backbone__WEBPACK_IMPORTED_MODULE_0__);
      var __extends2 = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      var Model = (
        /** @class */
        function(_super) {
          __extends2(Model2, _super);
          function Model2() {
            return _super !== null && _super.apply(this, arguments) || this;
          }
          return Model2;
        }(backbone__WEBPACK_IMPORTED_MODULE_0___default().Model)
      );
      var Collection = (
        /** @class */
        function(_super) {
          __extends2(Collection2, _super);
          function Collection2() {
            return _super !== null && _super.apply(this, arguments) || this;
          }
          return Collection2;
        }(backbone__WEBPACK_IMPORTED_MODULE_0___default().Collection)
      );
      var View = (
        /** @class */
        function(_super) {
          __extends2(View2, _super);
          function View2() {
            return _super !== null && _super.apply(this, arguments) || this;
          }
          return View2;
        }(backbone__WEBPACK_IMPORTED_MODULE_0___default().View)
      );
      var CoordinatesTypes;
      (function(CoordinatesTypes2) {
        CoordinatesTypes2["Screen"] = "screen";
        CoordinatesTypes2["World"] = "world";
      })(CoordinatesTypes || (CoordinatesTypes = {}));
      var DEFAULT_COORDS = {
        x: 0,
        y: 0
      };
      var DEFAULT_BOXRECT = __assign2(__assign2({}, DEFAULT_COORDS), { width: 0, height: 0 });
    }
  ),
  /***/
  249: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        I: () => (
          /* binding */
          ComponentsEvents
        ),
        /* harmony export */
        t: () => (
          /* binding */
          ActionLabelComponents
        )
        /* harmony export */
      });
      var ActionLabelComponents;
      (function(ActionLabelComponents2) {
        ActionLabelComponents2["remove"] = "component:remove";
        ActionLabelComponents2["add"] = "component:add";
        ActionLabelComponents2["move"] = "component:move";
      })(ActionLabelComponents || (ActionLabelComponents = {}));
      var ComponentsEvents;
      (function(ComponentsEvents2) {
        ComponentsEvents2["add"] = "component:add";
        ComponentsEvents2["remove"] = "component:remove";
        ComponentsEvents2["removeBefore"] = "component:remove:before";
        ComponentsEvents2["create"] = "component:create";
        ComponentsEvents2["update"] = "component:update";
        ComponentsEvents2["updateInside"] = "component:update-inside";
        ComponentsEvents2["symbolMainAdd"] = "symbol:main:add";
        ComponentsEvents2["symbolMainUpdate"] = "symbol:main:update";
        ComponentsEvents2["symbolMainUpdateDeep"] = "symbol:main:update-deep";
        ComponentsEvents2["symbolMainRemove"] = "symbol:main:remove";
        ComponentsEvents2["symbolMain"] = "symbol:main";
        ComponentsEvents2["symbolInstanceAdd"] = "symbol:instance:add";
        ComponentsEvents2["symbolInstanceRemove"] = "symbol:instance:remove";
        ComponentsEvents2["symbolInstance"] = "symbol:instance";
        ComponentsEvents2["symbol"] = "symbol";
      })(ComponentsEvents || (ComponentsEvents = {}));
    }
  ),
  /***/
  754: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        A: () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _common__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(268);
      var __extends2 = /* @__PURE__ */ function() {
        var extendStatics = function(d, b) {
          extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
            d2.__proto__ = b2;
          } || function(d2, b2) {
            for (var p in b2)
              if (Object.prototype.hasOwnProperty.call(b2, p))
                d2[p] = b2[p];
          };
          return extendStatics(d, b);
        };
        return function(d, b) {
          if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
          extendStatics(d, b);
          function __() {
            this.constructor = d;
          }
          d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
      }();
      var DomainViews2 = (
        /** @class */
        function(_super) {
          __extends2(DomainViews3, _super);
          function DomainViews3(opts, config2, autoAdd) {
            if (opts === void 0) {
              opts = {};
            }
            if (autoAdd === void 0) {
              autoAdd = false;
            }
            var _this = _super.call(this, opts) || this;
            _this.itemsView = "";
            _this.itemType = "type";
            _this.reuseView = false;
            _this.config = config2 || opts.config || {};
            autoAdd && _this.listenTo(_this.collection, "add", _this.addTo);
            _this.items = [];
            return _this;
          }
          DomainViews3.prototype.addTo = function(model) {
            this.add(model);
          };
          DomainViews3.prototype.itemViewNotFound = function(type2) {
            var _a2 = this, config2 = _a2.config, ns = _a2.ns;
            var em = config2.em;
            var warn = "".concat(ns ? "[".concat(ns, "]: ") : "", "'").concat(type2, "' type not found");
            em && em.logWarning(warn);
          };
          DomainViews3.prototype.add = function(model, fragment) {
            var _a2 = this, config2 = _a2.config, reuseView = _a2.reuseView, items = _a2.items;
            var itemsView = this.itemsView || {};
            var inputTypes = [
              "button",
              "checkbox",
              "color",
              "date",
              "datetime-local",
              "email",
              "file",
              "hidden",
              "image",
              "month",
              "number",
              "password",
              "radio",
              "range",
              "reset",
              "search",
              "submit",
              "tel",
              "text",
              "time",
              "url",
              "week"
            ];
            var frag = fragment || null;
            var itemView = this.itemView;
            var typeField = model.get(this.itemType);
            var view;
            if (itemsView[typeField]) {
              itemView = itemsView[typeField];
            } else if (typeField && !itemsView[typeField] && !(0, underscore__WEBPACK_IMPORTED_MODULE_0__.includes)(inputTypes, typeField)) {
              this.itemViewNotFound(typeField);
            }
            if (model.view && reuseView) {
              view = model.view;
            } else {
              view = new itemView({ model, config: config2 }, config2);
            }
            items && items.push(view);
            var rendered = view.render().el;
            if (frag)
              frag.appendChild(rendered);
            else
              this.$el.append(rendered);
          };
          DomainViews3.prototype.render = function() {
            var frag = document.createDocumentFragment();
            this.clearItems();
            this.$el.empty();
            if (this.collection.length)
              this.collection.each(function(model) {
                this.add(model, frag);
              }, this);
            this.$el.append(frag);
            this.onRender();
            return this;
          };
          DomainViews3.prototype.onRender = function() {
          };
          DomainViews3.prototype.onRemoveBefore = function(items, opts) {
          };
          DomainViews3.prototype.onRemove = function(items, opts) {
          };
          DomainViews3.prototype.remove = function(opts) {
            if (opts === void 0) {
              opts = {};
            }
            var items = this.items;
            this.onRemoveBefore(items, opts);
            this.clearItems();
            _super.prototype.remove.call(this);
            this.onRemove(items, opts);
            return this;
          };
          DomainViews3.prototype.clearItems = function() {
            var items = this.items || [];
          };
          return DomainViews3;
        }(_common__WEBPACK_IMPORTED_MODULE_1__.Ss)
      );
      const __WEBPACK_DEFAULT_EXPORT__ = DomainViews2;
      DomainViews2.prototype.itemView = "";
    }
  ),
  /***/
  14: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        A: () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _dom__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(926);
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      var resetPos = function() {
        return { x: 0, y: 0 };
      };
      var xyArr = ["x", "y"];
      var Dragger2 = (
        /** @class */
        function() {
          function Dragger3(opts) {
            if (opts === void 0) {
              opts = {};
            }
            this.opts = {
              snapOffset: 5,
              scale: 1
            };
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.bindAll)(this, "drag", "stop", "keyHandle", "handleScroll");
            this.setOptions(opts);
            this.delta = resetPos();
            this.lastScroll = resetPos();
            this.lastScrollDiff = resetPos();
            this.startPointer = resetPos();
            this.startPosition = resetPos();
            this.globScrollDiff = resetPos();
            this.currentPointer = resetPos();
            this.position = resetPos();
            this.guidesStatic = [];
            this.guidesTarget = [];
            this.docs = [];
            return this;
          }
          Dragger3.prototype.setOptions = function(opts) {
            if (opts === void 0) {
              opts = {};
            }
            this.opts = __assign2(__assign2({}, this.opts), opts);
          };
          Dragger3.prototype.toggleDrag = function(enable) {
            var docs = this.getDocumentEl();
            var container = this.getContainerEl();
            var win = this.getWindowEl();
            var method = enable ? "on" : "off";
            var methods = { on: _dom__WEBPACK_IMPORTED_MODULE_1__.on, off: _dom__WEBPACK_IMPORTED_MODULE_1__.AU };
            methods[method](container, "mousemove dragover", this.drag);
            methods[method](docs, "mouseup dragend touchend", this.stop);
            methods[method](docs, "keydown", this.keyHandle);
            methods[method](win, "scroll", this.handleScroll);
          };
          Dragger3.prototype.handleScroll = function() {
            var _a2 = this, lastScroll = _a2.lastScroll, delta = _a2.delta;
            var actualScroll = this.getScrollInfo();
            var scrollDiff = {
              x: actualScroll.x - lastScroll.x,
              y: actualScroll.y - lastScroll.y
            };
            this.move(delta.x + scrollDiff.x, delta.y + scrollDiff.y);
            this.lastScrollDiff = scrollDiff;
          };
          Dragger3.prototype.start = function(ev) {
            var opts = this.opts;
            var onStart = opts.onStart;
            this.toggleDrag(true);
            this.startPointer = this.getPointerPos(ev);
            this.guidesStatic = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.result)(opts, "guidesStatic") || [];
            this.guidesTarget = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.result)(opts, "guidesTarget") || [];
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(onStart) && onStart(ev, this);
            this.startPosition = this.getStartPosition();
            this.lastScrollDiff = resetPos();
            this.globScrollDiff = resetPos();
            this.drag(ev);
          };
          Dragger3.prototype.drag = function(ev) {
            var _this = this;
            var _a2 = this, opts = _a2.opts, lastScrollDiff = _a2.lastScrollDiff, globScrollDiff = _a2.globScrollDiff;
            var onDrag = opts.onDrag;
            var startPointer = this.startPointer;
            var currentPos = this.getPointerPos(ev);
            var glDiff = {
              x: globScrollDiff.x + lastScrollDiff.x,
              y: globScrollDiff.y + lastScrollDiff.y
            };
            this.globScrollDiff = glDiff;
            var delta = {
              x: currentPos.x - startPointer.x + glDiff.x,
              y: currentPos.y - startPointer.y + glDiff.y
            };
            this.lastScrollDiff = resetPos();
            var lockedAxis = this.lockedAxis;
            if (ev.shiftKey) {
              lockedAxis = !lockedAxis && this.detectAxisLock(delta.x, delta.y);
            } else {
              lockedAxis = null;
            }
            if (lockedAxis === "x") {
              delta.x = startPointer.x;
            } else if (lockedAxis === "y") {
              delta.y = startPointer.y;
            }
            var moveDelta = function(delta2) {
              xyArr.forEach(function(co) {
                return delta2[co] = delta2[co] * (0, underscore__WEBPACK_IMPORTED_MODULE_0__.result)(opts, "scale");
              });
              _this.delta = delta2;
              _this.move(delta2.x, delta2.y);
              (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(onDrag) && onDrag(ev, _this);
            };
            var deltaPre = __assign2({}, delta);
            this.currentPointer = currentPos;
            this.lockedAxis = lockedAxis;
            this.lastScroll = this.getScrollInfo();
            moveDelta(delta);
            if (this.guidesTarget.length) {
              var _b = this.snapGuides(deltaPre), newDelta = _b.newDelta, trgX = _b.trgX, trgY = _b.trgY;
              (trgX || trgY) && moveDelta(newDelta);
            }
            ev.which === 0 && this.stop(ev);
          };
          Dragger3.prototype.snapGuides = function(delta) {
            var _this = this;
            var newDelta = delta;
            var _a2 = this, trgX = _a2.trgX, trgY = _a2.trgY;
            this.guidesTarget.forEach(function(trg) {
              if (trg.x && _this.trgX || trg.y && _this.trgY)
                return;
              trg.active = false;
              _this.guidesStatic.forEach(function(stat) {
                if (trg.y && stat.x || trg.x && stat.y)
                  return;
                var isY = trg.y && stat.y;
                var axs = isY ? "y" : "x";
                var trgPoint = trg[axs];
                var statPoint = stat[axs];
                var deltaPoint = delta[axs];
                var trgGuide = isY ? trgY : trgX;
                if (_this.isPointIn(trgPoint, statPoint)) {
                  if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(trgGuide)) {
                    var trgValue = deltaPoint - (trgPoint - statPoint);
                    _this.setGuideLock(trg, trgValue);
                  }
                }
              });
            });
            trgX = this.trgX;
            trgY = this.trgY;
            xyArr.forEach(function(co) {
              var axis = co.toUpperCase();
              var trg = _this["trg".concat(axis)];
              if (trg && !_this.isPointIn(delta[co], trg.lock)) {
                _this.setGuideLock(trg, null);
                trg = null;
              }
              if (trg && !(0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(trg.lock)) {
                newDelta[co] = trg.lock;
              }
            });
            return {
              newDelta,
              trgX: this.trgX,
              trgY: this.trgY
            };
          };
          Dragger3.prototype.isPointIn = function(src2, trg, _a2) {
            var _b = _a2 === void 0 ? {} : _a2, offset = _b.offset;
            var ofst = offset || this.opts.snapOffset || 0;
            return src2 >= trg && src2 <= trg + ofst || src2 <= trg && src2 >= trg - ofst;
          };
          Dragger3.prototype.setGuideLock = function(guide, value) {
            var axis = !(0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(guide.x) ? "X" : "Y";
            var trgName = "trg".concat(axis);
            if (value !== null) {
              guide.active = true;
              guide.lock = value;
              this[trgName] = guide;
            } else {
              delete guide.active;
              delete guide.lock;
              delete this[trgName];
            }
            return guide;
          };
          Dragger3.prototype.stop = function(ev, opts) {
            if (opts === void 0) {
              opts = {};
            }
            var delta = this.delta;
            var cancelled = !!opts.cancel;
            var x = cancelled ? 0 : delta.x;
            var y = cancelled ? 0 : delta.y;
            this.toggleDrag();
            this.lockedAxis = null;
            this.move(x, y, true);
            var onEnd = this.opts.onEnd;
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(onEnd) && onEnd(ev, this, { cancelled });
          };
          Dragger3.prototype.keyHandle = function(ev) {
            if ((0, _dom__WEBPACK_IMPORTED_MODULE_1__.v$)(ev)) {
              this.stop(ev, { cancel: true });
            }
          };
          Dragger3.prototype.move = function(x, y, end) {
            var _a2 = this, el = _a2.el, opts = _a2.opts;
            var pos = this.startPosition;
            if (!pos)
              return;
            var setPosition = opts.setPosition;
            var xPos = pos.x + x;
            var yPos = pos.y + y;
            this.position = {
              x: xPos,
              y: yPos,
              end
            };
            (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(setPosition) && setPosition(this.position);
            if (el) {
              el.style.left = "".concat(xPos, "px");
              el.style.top = "".concat(yPos, "px");
            }
          };
          Dragger3.prototype.getContainerEl = function() {
            var container = this.opts.container;
            return container ? [container] : this.getDocumentEl();
          };
          Dragger3.prototype.getWindowEl = function() {
            var cont = this.getContainerEl();
            return cont.map(function(item) {
              var doc = item.ownerDocument || item;
              return doc.defaultView || doc.parentWindow;
            });
          };
          Dragger3.prototype.getDocumentEl = function(el) {
            var doc = this.opts.doc;
            el = el || this.el;
            if (!this.docs.length) {
              var docs = [document];
              el && docs.push(el.ownerDocument);
              doc && docs.push(doc);
              this.docs = docs;
            }
            return this.docs;
          };
          Dragger3.prototype.getPointerPos = function(ev) {
            var getPos = this.opts.getPointerPosition;
            var pEv = (0, _dom__WEBPACK_IMPORTED_MODULE_1__.G2)(ev);
            return getPos ? getPos(ev) : {
              x: pEv.clientX,
              y: pEv.clientY
            };
          };
          Dragger3.prototype.getStartPosition = function() {
            var _a2 = this, el = _a2.el, opts = _a2.opts;
            var getPos = opts.getPosition;
            var result = resetPos();
            if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(getPos)) {
              result = getPos();
            } else if (el) {
              result = {
                x: parseFloat(el.style.left),
                y: parseFloat(el.style.top)
              };
            }
            return result;
          };
          Dragger3.prototype.getScrollInfo = function() {
            var doc = this.opts.doc;
            var body = doc && doc.body;
            return {
              y: body ? body.scrollTop : 0,
              x: body ? body.scrollLeft : 0
            };
          };
          Dragger3.prototype.detectAxisLock = function(x, y) {
            var relX = x;
            var relY = y;
            var absX = Math.abs(relX);
            var absY = Math.abs(relY);
            if (relY >= absX || relY <= -absX) {
              return "x";
            } else if (relX > absY || relX < -absY) {
              return "y";
            }
          };
          return Dragger3;
        }()
      );
      const __WEBPACK_DEFAULT_EXPORT__ = Dragger2;
    }
  ),
  /***/
  694: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        "default": () => __WEBPACK_DEFAULT_EXPORT__
        /* harmony export */
      });
      var doc = typeof document !== "undefined" ? document : null, win = typeof window !== "undefined" ? window : null, _Array$prototype = Array.prototype, filter2 = _Array$prototype.filter, indexOf = _Array$prototype.indexOf, map = _Array$prototype.map, push = _Array$prototype.push, reverse = _Array$prototype.reverse, slice = _Array$prototype.slice, splice = _Array$prototype.splice;
      var idRe = /^#[\w-]*$/, classRe = /^\.[\w-]*$/, htmlRe = /<.+>/, tagRe = /^\w+$/;
      function find(selector, context) {
        if (context === void 0) {
          context = doc;
        }
        return classRe.test(selector) ? context.getElementsByClassName(selector.slice(1)) : tagRe.test(selector) ? context.getElementsByTagName(selector) : context.querySelectorAll(selector);
      }
      function Cash(selector, context) {
        if (context === void 0) {
          context = doc;
        }
        if (!selector)
          return;
        if (selector.__cash)
          return selector;
        var eles = selector;
        if (isString(selector)) {
          if (context.__cash)
            context = context[0];
          eles = idRe.test(selector) ? context.getElementById(selector.slice(1)) : htmlRe.test(selector) ? parseHTML(selector) : find(selector, context);
          if (!eles)
            return;
        } else if (isFunction(selector)) {
          return this.ready(selector);
        }
        if (eles.nodeType || eles === win)
          eles = [eles];
        this.length = eles.length;
        for (var i = 0, l = this.length; i < l; i++) {
          this[i] = eles[i];
        }
      }
      function cash(selector, context) {
        return new Cash(selector, context);
      }
      var fn = cash.fn = cash.prototype = Cash.prototype = {
        constructor: cash,
        __cash: true,
        length: 0,
        splice
        // Ensures a cash collection gets printed as array-like in Chrome
      };
      fn.get = function(index2) {
        if (index2 === void 0)
          return slice.call(this);
        return this[index2 < 0 ? index2 + this.length : index2];
      };
      fn.eq = function(index2) {
        return cash(this.get(index2));
      };
      fn.first = function() {
        return this.eq(0);
      };
      fn.last = function() {
        return this.eq(-1);
      };
      fn.map = function(callback) {
        return cash(map.call(this, function(ele, i) {
          return callback.call(ele, i, ele);
        }));
      };
      fn.slice = function() {
        return cash(slice.apply(this, arguments));
      };
      var camelCaseRe = /(?:^\w|[A-Z]|\b\w)/g, camelCaseWhitespaceRe = /[\s-_]+/g;
      function camelCase(str) {
        return str.replace(camelCaseRe, function(letter, index2) {
          return letter[!index2 ? "toLowerCase" : "toUpperCase"]();
        }).replace(camelCaseWhitespaceRe, "");
      }
      cash.camelCase = camelCase;
      function each(arr, callback) {
        for (var i = 0, l = arr.length; i < l; i++) {
          if (callback.call(arr[i], arr[i], i, arr) === false)
            break;
        }
      }
      cash.each = each;
      fn.each = function(callback) {
        each(this, function(ele, i) {
          return callback.call(ele, i, ele);
        });
        return this;
      };
      fn.removeProp = function(prop) {
        return this.each(function(i, ele) {
          delete ele[prop];
        });
      };
      function extend(target) {
        if (target === void 0) {
          target = this;
        }
        var args = arguments, length = args.length;
        for (var i = length < 2 ? 0 : 1; i < length; i++) {
          for (var key in args[i]) {
            target[key] = args[i][key];
          }
        }
        return target;
      }
      cash.extend = fn.extend = extend;
      var guid = 1;
      cash.guid = guid;
      function matches(ele, selector) {
        var matches2 = ele && (ele.matches || ele.webkitMatchesSelector || ele.mozMatchesSelector || ele.msMatchesSelector || ele.oMatchesSelector);
        return !!matches2 && matches2.call(ele, selector);
      }
      cash.matches = matches;
      function isFunction(x) {
        return typeof x === "function";
      }
      cash.isFunction = isFunction;
      function isString(x) {
        return typeof x === "string";
      }
      cash.isString = isString;
      function isNumeric(x) {
        return !isNaN(parseFloat(x)) && isFinite(x);
      }
      cash.isNumeric = isNumeric;
      var isArray2 = Array.isArray;
      cash.isArray = isArray2;
      fn.prop = function(prop, value) {
        if (!prop)
          return;
        if (isString(prop)) {
          if (arguments.length < 2)
            return this[0] && this[0][prop];
          return this.each(function(i, ele) {
            ele[prop] = value;
          });
        }
        for (var key in prop) {
          this.prop(key, prop[key]);
        }
        return this;
      };
      function getCompareFunction(selector) {
        return isString(selector) ? function(i, ele) {
          return matches(ele, selector);
        } : selector.__cash ? function(i, ele) {
          return selector.is(ele);
        } : function(i, ele, selector2) {
          return ele === selector2;
        };
      }
      fn.filter = function(selector) {
        if (!selector)
          return cash();
        var comparator = isFunction(selector) ? selector : getCompareFunction(selector);
        return cash(filter2.call(this, function(ele, i) {
          return comparator.call(ele, i, ele, selector);
        }));
      };
      var splitValuesRe = /\S+/g;
      function getSplitValues(str) {
        return isString(str) ? str.match(splitValuesRe) || [] : [];
      }
      fn.hasClass = function(cls) {
        var classes = getSplitValues(cls);
        var check = false;
        if (classes.length) {
          this.each(function(i, ele) {
            check = ele.classList.contains(classes[0]);
            return !check;
          });
        }
        return check;
      };
      fn.removeAttr = function(attr) {
        var attrs = getSplitValues(attr);
        if (!attrs.length)
          return this;
        return this.each(function(i, ele) {
          each(attrs, function(a) {
            ele.removeAttribute(a);
          });
        });
      };
      fn.attr = function(attr, value) {
        if (!attr)
          return;
        if (isString(attr)) {
          if (arguments.length < 2) {
            if (!this[0])
              return;
            var _value = this[0].getAttribute(attr);
            return _value === null ? void 0 : _value;
          }
          if (value === null)
            return this.removeAttr(attr);
          return this.each(function(i, ele) {
            ele.setAttribute(attr, value);
          });
        }
        for (var key in attr) {
          this.attr(key, attr[key]);
        }
        return this;
      };
      fn.toggleClass = function(cls, force) {
        var classes = getSplitValues(cls), isForce = force !== void 0;
        if (!classes.length)
          return this;
        return this.each(function(i, ele) {
          each(classes, function(c) {
            if (isForce) {
              force ? ele.classList.add(c) : ele.classList.remove(c);
            } else {
              ele.classList.toggle(c);
            }
          });
        });
      };
      fn.addClass = function(cls) {
        return this.toggleClass(cls, true);
      };
      fn.removeClass = function(cls) {
        return !arguments.length ? this.attr("class", "") : this.toggleClass(cls, false);
      };
      function unique(arr) {
        return arr.filter(function(item, index2, self2) {
          return self2.indexOf(item) === index2;
        });
      }
      cash.unique = unique;
      fn.add = function(selector, context) {
        return cash(unique(this.get().concat(cash(selector, context).get())));
      };
      function computeStyle(ele, prop, isVariable) {
        if (ele.nodeType !== 1)
          return;
        var style2 = win.getComputedStyle(ele, null);
        return prop ? isVariable ? style2.getPropertyValue(prop) : style2[prop] : style2;
      }
      function computeStyleInt(ele, prop) {
        return parseInt(computeStyle(ele, prop), 10) || 0;
      }
      var cssVariableRe = /^--/;
      function isCSSVariable(prop) {
        return cssVariableRe.test(prop);
      }
      var prefixedProps = {}, docEl = doc && doc.createElement("div"), style = docEl ? docEl.style : {}, vendorsPrefixes = ["webkit", "moz", "ms", "o"];
      function getPrefixedProp(prop, isVariable) {
        if (isVariable === void 0) {
          isVariable = isCSSVariable(prop);
        }
        if (isVariable)
          return prop;
        if (!prefixedProps[prop]) {
          var propCC = camelCase(prop), propUC = "" + propCC.charAt(0).toUpperCase() + propCC.slice(1), props = (propCC + " " + vendorsPrefixes.join(propUC + " ") + propUC).split(" ");
          each(props, function(p) {
            if (p in style) {
              prefixedProps[prop] = p;
              return false;
            }
          });
        }
        return prefixedProps[prop];
      }
      cash.prefixedProp = getPrefixedProp;
      var numericProps = {
        animationIterationCount: true,
        columnCount: true,
        flexGrow: true,
        flexShrink: true,
        fontWeight: true,
        lineHeight: true,
        opacity: true,
        order: true,
        orphans: true,
        widows: true,
        zIndex: true
      };
      function getSuffixedValue(prop, value, isVariable) {
        if (isVariable === void 0) {
          isVariable = isCSSVariable(prop);
        }
        return !isVariable && !numericProps[prop] && isNumeric(value) ? value + "px" : value;
      }
      fn.css = function(prop, value) {
        if (isString(prop)) {
          var isVariable = isCSSVariable(prop);
          prop = getPrefixedProp(prop, isVariable);
          if (arguments.length < 2)
            return this[0] && computeStyle(this[0], prop, isVariable);
          if (!prop)
            return this;
          value = getSuffixedValue(prop, value, isVariable);
          return this.each(function(i, ele) {
            if (ele.nodeType !== 1)
              return;
            if (isVariable) {
              ele.style.setProperty(prop, value);
            } else {
              ele.style[prop] = value;
            }
          });
        }
        for (var key in prop) {
          this.css(key, prop[key]);
        }
        return this;
      };
      var dataNamespace = "__cashData", dataAttributeRe = /^data-(.*)/;
      cash.hasData = function(ele) {
        return dataNamespace in ele;
      };
      function getDataCache(ele) {
        return ele[dataNamespace] = ele[dataNamespace] || {};
      }
      function getData(ele, key) {
        var cache = getDataCache(ele);
        if (key) {
          if (!(key in cache)) {
            var value = ele.dataset ? ele.dataset[key] || ele.dataset[camelCase(key)] : cash(ele).attr("data-" + key);
            if (value !== void 0) {
              try {
                value = JSON.parse(value);
              } catch (e) {
              }
              cache[key] = value;
            }
          }
          return cache[key];
        }
        return cache;
      }
      function removeData(ele, key) {
        if (key === void 0) {
          delete ele[dataNamespace];
        } else {
          delete getDataCache(ele)[key];
        }
      }
      function setData(ele, key, value) {
        getDataCache(ele)[key] = value;
      }
      fn.data = function(name, value) {
        var _this = this;
        if (!name) {
          if (!this[0])
            return;
          each(this[0].attributes, function(attr) {
            var match = attr.name.match(dataAttributeRe);
            if (!match)
              return;
            _this.data(match[1]);
          });
          return getData(this[0]);
        }
        if (isString(name)) {
          if (value === void 0)
            return this[0] && getData(this[0], name);
          return this.each(function(i, ele) {
            return setData(ele, name, value);
          });
        }
        for (var key in name) {
          this.data(key, name[key]);
        }
        return this;
      };
      fn.removeData = function(key) {
        return this.each(function(i, ele) {
          return removeData(ele, key);
        });
      };
      function getExtraSpace(ele, xAxis) {
        return computeStyleInt(ele, "border" + (xAxis ? "Left" : "Top") + "Width") + computeStyleInt(ele, "padding" + (xAxis ? "Left" : "Top")) + computeStyleInt(ele, "padding" + (xAxis ? "Right" : "Bottom")) + computeStyleInt(ele, "border" + (xAxis ? "Right" : "Bottom") + "Width");
      }
      each(["Width", "Height"], function(prop) {
        fn["inner" + prop] = function() {
          if (!this[0])
            return;
          if (this[0] === win)
            return win["inner" + prop];
          return this[0]["client" + prop];
        };
      });
      each(["width", "height"], function(prop, index2) {
        fn[prop] = function(value) {
          if (!this[0])
            return value === void 0 ? void 0 : this;
          if (!arguments.length) {
            if (this[0] === win)
              return this[0][camelCase("outer-" + prop)];
            return this[0].getBoundingClientRect()[prop] - getExtraSpace(this[0], !index2);
          }
          value = parseInt(value, 10);
          return this.each(function(i, ele) {
            if (ele.nodeType !== 1)
              return;
            var boxSizing = computeStyle(ele, "boxSizing");
            ele.style[prop] = getSuffixedValue(prop, value + (boxSizing === "border-box" ? getExtraSpace(ele, !index2) : 0));
          });
        };
      });
      each(["Width", "Height"], function(prop, index2) {
        fn["outer" + prop] = function(includeMargins) {
          if (!this[0])
            return;
          if (this[0] === win)
            return win["outer" + prop];
          return this[0]["offset" + prop] + (includeMargins ? computeStyleInt(this[0], "margin" + (!index2 ? "Left" : "Top")) + computeStyleInt(this[0], "margin" + (!index2 ? "Right" : "Bottom")) : 0);
        };
      });
      function hasNamespaces(ns1, ns2) {
        for (var i = 0, l = ns2.length; i < l; i++) {
          if (ns1.indexOf(ns2[i]) < 0)
            return false;
        }
        return true;
      }
      function removeEventListeners(cache, ele, name) {
        each(cache[name], function(_ref) {
          var namespaces = _ref[0], callback = _ref[1];
          ele.removeEventListener(name, callback);
        });
        delete cache[name];
      }
      var eventsNamespace = "__cashEvents", eventsNamespacesSeparator = ".";
      function getEventsCache(ele) {
        return ele[eventsNamespace] = ele[eventsNamespace] || {};
      }
      function addEvent2(ele, name, namespaces, callback) {
        callback.guid = callback.guid || guid++;
        var eventCache = getEventsCache(ele);
        eventCache[name] = eventCache[name] || [];
        eventCache[name].push([namespaces, callback]);
        ele.addEventListener(name, callback);
      }
      function parseEventName(eventName) {
        var parts = eventName.split(eventsNamespacesSeparator);
        return [parts[0], parts.slice(1).sort()];
      }
      function removeEvent(ele, name, namespaces, callback) {
        var cache = getEventsCache(ele);
        if (!name) {
          if (!namespaces || !namespaces.length) {
            for (name in cache) {
              removeEventListeners(cache, ele, name);
            }
          } else {
            for (name in cache) {
              removeEvent(ele, name, namespaces, callback);
            }
          }
        } else {
          var eventCache = cache[name];
          if (!eventCache)
            return;
          if (callback)
            callback.guid = callback.guid || guid++;
          cache[name] = eventCache.filter(function(_ref2) {
            var ns = _ref2[0], cb = _ref2[1];
            if (callback && cb.guid !== callback.guid || !hasNamespaces(ns, namespaces))
              return true;
            ele.removeEventListener(name, cb);
          });
        }
      }
      fn.off = function(eventFullName, callback) {
        var _this2 = this;
        if (eventFullName === void 0) {
          this.each(function(i, ele) {
            return removeEvent(ele);
          });
        } else {
          each(getSplitValues(eventFullName), function(eventFullName2) {
            var _parseEventName = parseEventName(eventFullName2), name = _parseEventName[0], namespaces = _parseEventName[1];
            _this2.each(function(i, ele) {
              return removeEvent(ele, name, namespaces, callback);
            });
          });
        }
        return this;
      };
      fn.on = function(eventFullName, selector, callback, _one) {
        var _this3 = this;
        if (!isString(eventFullName)) {
          for (var key in eventFullName) {
            this.on(key, selector, eventFullName[key]);
          }
          return this;
        }
        if (isFunction(selector)) {
          callback = selector;
          selector = false;
        }
        each(getSplitValues(eventFullName), function(eventFullName2) {
          var _parseEventName2 = parseEventName(eventFullName2), name = _parseEventName2[0], namespaces = _parseEventName2[1];
          _this3.each(function(i, ele) {
            var finalCallback = function finalCallback2(event) {
              if (event.namespace && !hasNamespaces(namespaces, event.namespace.split(eventsNamespacesSeparator)))
                return;
              var thisArg = ele;
              if (selector) {
                var target = event.target;
                while (!matches(target, selector)) {
                  if (target === ele)
                    return;
                  target = target.parentNode;
                  if (!target)
                    return;
                }
                thisArg = target;
              }
              event.namespace = event.namespace || "";
              var returnValue = callback.call(thisArg, event, event.data);
              if (_one) {
                removeEvent(ele, name, namespaces, finalCallback2);
              }
              if (returnValue === false) {
                event.preventDefault();
                event.stopPropagation();
              }
            };
            finalCallback.guid = callback.guid = callback.guid || guid++;
            addEvent2(ele, name, namespaces, finalCallback);
          });
        });
        return this;
      };
      fn.one = function(eventFullName, delegate, callback) {
        return this.on(eventFullName, delegate, callback, true);
      };
      fn.ready = function(callback) {
        var finalCallback = function finalCallback2() {
          return callback(cash);
        };
        if (doc.readyState !== "loading") {
          setTimeout(finalCallback);
        } else {
          doc.addEventListener("DOMContentLoaded", finalCallback);
        }
        return this;
      };
      fn.trigger = function(eventFullName, data) {
        var evt = eventFullName;
        if (isString(eventFullName)) {
          var _parseEventName3 = parseEventName(eventFullName), name = _parseEventName3[0], namespaces = _parseEventName3[1];
          evt = doc.createEvent("HTMLEvents");
          evt.initEvent(name, true, true);
          evt.namespace = namespaces.join(eventsNamespacesSeparator);
        }
        evt.data = data;
        return this.each(function(i, ele) {
          ele.dispatchEvent(evt);
        });
      };
      function getValueSelectMultiple(ele) {
        var values = [];
        each(ele.options, function(option) {
          if (option.selected && !option.disabled && !option.parentNode.disabled) {
            values.push(option.value);
          }
        });
        return values;
      }
      function getValueSelectSingle(ele) {
        return ele.selectedIndex < 0 ? null : ele.options[ele.selectedIndex].value;
      }
      var selectOneRe = /select-one/i, selectMultipleRe = /select-multiple/i;
      function getValue(ele) {
        var type2 = ele.type;
        if (selectOneRe.test(type2))
          return getValueSelectSingle(ele);
        if (selectMultipleRe.test(type2))
          return getValueSelectMultiple(ele);
        return ele.value;
      }
      var queryEncodeSpaceRe = /%20/g;
      function queryEncode(prop, value) {
        return "&" + encodeURIComponent(prop) + "=" + encodeURIComponent(value).replace(queryEncodeSpaceRe, "+");
      }
      var skippableRe = /file|reset|submit|button|image/i, checkableRe = /radio|checkbox/i;
      fn.serialize = function() {
        var query = "";
        this.each(function(i, ele) {
          each(ele.elements || [ele], function(ele2) {
            if (ele2.disabled || !ele2.name || ele2.tagName === "FIELDSET")
              return;
            if (skippableRe.test(ele2.type))
              return;
            if (checkableRe.test(ele2.type) && !ele2.checked)
              return;
            var value = getValue(ele2);
            if (value === void 0)
              return;
            var values = isArray2(value) ? value : [value];
            each(values, function(value2) {
              query += queryEncode(ele2.name, value2);
            });
          });
        });
        return query.substr(1);
      };
      fn.val = function(value) {
        if (value === void 0)
          return this[0] && getValue(this[0]);
        return this.each(function(i, ele) {
          var isMultiple = selectMultipleRe.test(ele.type), eleValue = value === null ? isMultiple ? [] : "" : value;
          if (isMultiple && isArray2(eleValue)) {
            each(ele.options, function(option) {
              option.selected = eleValue.indexOf(option.value) >= 0;
            });
          } else {
            ele.value = eleValue;
          }
        });
      };
      fn.clone = function() {
        return this.map(function(i, ele) {
          return ele.cloneNode(true);
        });
      };
      fn.detach = function() {
        return this.each(function(i, ele) {
          if (ele.parentNode) {
            ele.parentNode.removeChild(ele);
          }
        });
      };
      var fragmentRe = /^\s*<(\w+)[^>]*>/, singleTagRe = /^\s*<(\w+)\s*\/?>(?:<\/\1>)?\s*$/;
      var containers;
      function initContainers() {
        if (containers)
          return;
        var table = doc.createElement("table"), tr = doc.createElement("tr");
        containers = {
          "*": doc.createElement("div"),
          tr: doc.createElement("tbody"),
          td: tr,
          th: tr,
          thead: table,
          tbody: table,
          tfoot: table
        };
      }
      function parseHTML(html2) {
        initContainers();
        if (!isString(html2))
          return [];
        if (singleTagRe.test(html2))
          return [doc.createElement(RegExp.$1)];
        var fragment = fragmentRe.test(html2) && RegExp.$1, container = containers[fragment] || containers["*"];
        container.innerHTML = html2;
        return cash(container.childNodes).detach().get();
      }
      cash.parseHTML = parseHTML;
      fn.empty = function() {
        var ele = this[0];
        if (ele) {
          while (ele.firstChild) {
            ele.removeChild(ele.firstChild);
          }
        }
        return this;
      };
      function insertElement(ele, child, prepend) {
        if (prepend) {
          ele.insertBefore(child, ele.childNodes[0]);
        } else {
          ele.appendChild(child);
        }
      }
      function insertContent(parent, child, prepend) {
        if (child === void 0)
          return;
        var isStr = isString(child);
        if (!isStr && child.length) {
          each(child, function(ele) {
            return insertContent(parent, ele, prepend);
          });
        } else {
          each(parent, isStr ? function(ele) {
            ele.insertAdjacentHTML(prepend ? "afterbegin" : "beforeend", child);
          } : function(ele, index2) {
            return insertElement(ele, !index2 ? child : child.cloneNode(true), prepend);
          });
        }
      }
      fn.append = function() {
        var _this4 = this;
        each(arguments, function(content) {
          insertContent(_this4, content);
        });
        return this;
      };
      fn.appendTo = function(parent) {
        insertContent(cash(parent), this);
        return this;
      };
      fn.html = function(content) {
        if (content === void 0)
          return this[0] && this[0].innerHTML;
        var source = content.nodeType ? content[0].outerHTML : content;
        return this.each(function(i, ele) {
          ele.innerHTML = source;
        });
      };
      fn.insertAfter = function(content) {
        var _this5 = this;
        cash(content).each(function(index2, ele) {
          var parent = ele.parentNode;
          _this5.each(function(i, e) {
            parent.insertBefore(!index2 ? e : e.cloneNode(true), ele.nextSibling);
          });
        });
        return this;
      };
      fn.after = function() {
        var _this6 = this;
        each(reverse.apply(arguments), function(content) {
          reverse.apply(cash(content).slice()).insertAfter(_this6);
        });
        return this;
      };
      fn.insertBefore = function(selector) {
        var _this7 = this;
        cash(selector).each(function(index2, ele) {
          var parent = ele.parentNode;
          _this7.each(function(i, e) {
            parent.insertBefore(!index2 ? e : e.cloneNode(true), ele);
          });
        });
        return this;
      };
      fn.before = function() {
        var _this8 = this;
        each(arguments, function(content) {
          cash(content).insertBefore(_this8);
        });
        return this;
      };
      fn.prepend = function() {
        var _this9 = this;
        each(arguments, function(content) {
          insertContent(_this9, content, true);
        });
        return this;
      };
      fn.prependTo = function(parent) {
        insertContent(cash(parent), reverse.apply(this.slice()), true);
        return this;
      };
      fn.remove = function() {
        return this.detach().off();
      };
      fn.replaceWith = function(content) {
        var _this10 = this;
        return this.each(function(i, ele) {
          var parent = ele.parentNode;
          if (!parent)
            return;
          var $eles = i ? cash(content).clone() : cash(content);
          if (!$eles[0]) {
            _this10.remove();
            return false;
          }
          parent.replaceChild($eles[0], ele);
          cash($eles[0]).after($eles.slice(1));
        });
      };
      fn.replaceAll = function(content) {
        cash(content).replaceWith(this);
        return this;
      };
      fn.text = function(content) {
        if (content === void 0)
          return this[0] ? this[0].textContent : "";
        return this.each(function(i, ele) {
          ele.textContent = content;
        });
      };
      var docEle = doc && doc.documentElement;
      fn.offset = function() {
        var ele = this[0];
        if (!ele)
          return;
        var rect = ele.getBoundingClientRect();
        return {
          top: rect.top + win.pageYOffset - docEle.clientTop,
          left: rect.left + win.pageXOffset - docEle.clientLeft
        };
      };
      fn.offsetParent = function() {
        return cash(this[0] && this[0].offsetParent);
      };
      fn.position = function() {
        var ele = this[0];
        if (!ele)
          return;
        return {
          left: ele.offsetLeft,
          top: ele.offsetTop
        };
      };
      fn.children = function(selector) {
        var result = [];
        this.each(function(i, ele) {
          push.apply(result, ele.children);
        });
        result = cash(unique(result));
        if (!selector)
          return result;
        return result.filter(function(i, ele) {
          return matches(ele, selector);
        });
      };
      fn.contents = function() {
        var result = [];
        this.each(function(i, ele) {
          push.apply(result, ele.tagName === "IFRAME" ? [ele.contentDocument] : ele.childNodes);
        });
        return cash(result.length && unique(result));
      };
      fn.find = function(selector) {
        var result = [];
        for (var i = 0, l = this.length; i < l; i++) {
          var found = find(selector, this[i]);
          if (found.length) {
            push.apply(result, found);
          }
        }
        return cash(result.length && unique(result));
      };
      fn.has = function(selector) {
        var comparator = isString(selector) ? function(i, ele) {
          return !!find(selector, ele).length;
        } : function(i, ele) {
          return ele.contains(selector);
        };
        return this.filter(comparator);
      };
      fn.is = function(selector) {
        if (!selector || !this[0])
          return false;
        var comparator = getCompareFunction(selector);
        var check = false;
        this.each(function(i, ele) {
          check = comparator(i, ele, selector);
          return !check;
        });
        return check;
      };
      fn.next = function() {
        return cash(this[0] && this[0].nextElementSibling);
      };
      fn.not = function(selector) {
        if (!selector || !this[0])
          return this;
        var comparator = getCompareFunction(selector);
        return this.filter(function(i, ele) {
          return !comparator(i, ele, selector);
        });
      };
      fn.parent = function() {
        var result = [];
        this.each(function(i, ele) {
          if (ele && ele.parentNode) {
            result.push(ele.parentNode);
          }
        });
        return cash(unique(result));
      };
      fn.index = function(ele) {
        var child = ele ? cash(ele)[0] : this[0], collection = ele ? this : cash(child).parent().children();
        return indexOf.call(collection, child);
      };
      fn.closest = function(selector) {
        if (!selector || !this[0])
          return cash();
        if (this.is(selector))
          return this.filter(selector);
        return this.parent().closest(selector);
      };
      fn.parents = function(selector) {
        var result = [];
        var last;
        this.each(function(i, ele) {
          last = ele;
          while (last && last.parentNode && last !== doc.body.parentNode) {
            last = last.parentNode;
            if (!selector || selector && matches(last, selector)) {
              result.push(last);
            }
          }
        });
        return cash(unique(result));
      };
      fn.prev = function() {
        return cash(this[0] && this[0].previousElementSibling);
      };
      fn.siblings = function() {
        var ele = this[0];
        return this.parent().children().filter(function(i, child) {
          return child !== ele;
        });
      };
      const __WEBPACK_DEFAULT_EXPORT__ = cash;
    }
  ),
  /***/
  926: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        AU: () => (
          /* binding */
          off
        ),
        /* harmony export */
        BC: () => (
          /* binding */
          append
        ),
        /* harmony export */
        C8: () => (
          /* binding */
          getElRect
        ),
        /* harmony export */
        Ch: () => (
          /* binding */
          getKeyChar
        ),
        /* harmony export */
        Ci: () => (
          /* binding */
          isEnterKey
        ),
        /* harmony export */
        D8: () => (
          /* binding */
          motionsEv
        ),
        /* harmony export */
        G2: () => (
          /* binding */
          getPointerEvent
        ),
        /* harmony export */
        GW: () => (
          /* binding */
          isTaggableNode
        ),
        /* harmony export */
        GZ: () => (
          /* binding */
          createText
        ),
        /* harmony export */
        I6: () => (
          /* binding */
          find
        ),
        /* harmony export */
        LJ: () => (
          /* binding */
          doctypeToString
        ),
        /* harmony export */
        Sc: () => (
          /* binding */
          appendAtIndex
        ),
        /* harmony export */
        X6: () => (
          /* binding */
          attrUp
        ),
        /* harmony export */
        Xy: () => (
          /* binding */
          getDocumentScroll
        ),
        /* harmony export */
        YZ: () => (
          /* binding */
          removeEl
        ),
        /* harmony export */
        ZQ: () => (
          /* binding */
          isDoc
        ),
        /* harmony export */
        a_: () => (
          /* binding */
          createEl
        ),
        /* harmony export */
        af: () => (
          /* binding */
          appendVNodes
        ),
        /* harmony export */
        bG: () => (
          /* binding */
          replaceWith
        ),
        /* harmony export */
        cx: () => (
          /* binding */
          cx
        ),
        /* harmony export */
        ir: () => (
          /* binding */
          isTextNode
        ),
        /* harmony export */
        kk: () => (
          /* binding */
          attrToString
        ),
        /* harmony export */
        on: () => (
          /* binding */
          on
        ),
        /* harmony export */
        rp: () => (
          /* binding */
          hasModifierKey
        ),
        /* harmony export */
        v$: () => (
          /* binding */
          isEscKey
        ),
        /* harmony export */
        yL: () => (
          /* binding */
          createCustomEvent
        ),
        /* harmony export */
        zN: () => (
          /* binding */
          isVisible
        )
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var __spreadArray2 = function(to, from, pack) {
        if (pack || arguments.length === 2)
          for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
              if (!ar)
                ar = Array.prototype.slice.call(from, 0, i);
              ar[i] = from[i];
            }
          }
        return to.concat(ar || Array.prototype.slice.call(from));
      };
      var KEY_TAG = "tag";
      var KEY_ATTR = "attributes";
      var KEY_CHILD = "children";
      var motionsEv = "transitionend oTransitionEnd transitionend webkitTransitionEnd";
      var isDoc = function(el) {
        return (el === null || el === void 0 ? void 0 : el.nodeType) === Node.DOCUMENT_NODE;
      };
      var removeEl = function(el) {
        var parent = el && el.parentNode;
        parent && parent.removeChild(el);
      };
      function cx() {
        var inputs = [];
        for (var _i = 0; _i < arguments.length; _i++) {
          inputs[_i] = arguments[_i];
        }
        var inp = Array.isArray(inputs[0]) ? inputs[0] : __spreadArray2([], inputs, true);
        return inp.filter(Boolean).join(" ");
      }
      var find = function(el, query) {
        return el.querySelectorAll(query);
      };
      var attrUp = function(el, attrs) {
        if (attrs === void 0) {
          attrs = {};
        }
        return el && el.setAttribute && (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(attrs, function(value, key) {
          return el.setAttribute(key, value);
        });
      };
      var isVisible = function(el) {
        var _a2;
        return el && !!(el.offsetWidth || el.offsetHeight || ((_a2 = el.getClientRects) === null || _a2 === void 0 ? void 0 : _a2.call(el).length));
      };
      var empty = function(node) {
        while (node.firstChild)
          node.removeChild(node.firstChild);
      };
      var replaceWith = function(oldEl, newEl) {
        var _a2;
        (_a2 = oldEl.parentNode) === null || _a2 === void 0 ? void 0 : _a2.replaceChild(newEl, oldEl);
      };
      var appendAtIndex = function(parent, child, index2) {
        var childNodes = parent.childNodes;
        var total = childNodes.length;
        var at = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(index2) ? total : index2;
        if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isString)(child)) {
          parent.insertAdjacentHTML("beforeEnd", child);
          child = parent.lastChild;
          parent.removeChild(child);
        }
        if (at >= total) {
          parent.appendChild(child);
        } else {
          parent.insertBefore(child, childNodes[at]);
        }
      };
      var append = function(parent, child) {
        return appendAtIndex(parent, child);
      };
      var createEl = function(tag, attrs, child) {
        if (attrs === void 0) {
          attrs = {};
        }
        var el = document.createElement(tag);
        attrs && (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(attrs, function(value, key) {
          return el.setAttribute(key, value);
        });
        if (child) {
          if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isString)(child))
            el.innerHTML = child;
          else
            el.appendChild(child);
        }
        return el;
      };
      var createText = function(str) {
        return document.createTextNode(str);
      };
      var createCustomEvent = function(e, cls) {
        var oEvent;
        var type2 = e.type;
        try {
          oEvent = new window[cls](type2, e);
        } catch (err) {
          oEvent = document.createEvent(cls);
          oEvent.initEvent(type2, true, true);
        }
        oEvent._parentEvent = e;
        if (type2.indexOf("key") === 0) {
          oEvent.keyCodeVal = e.keyCode;
          ["keyCode", "which"].forEach(function(prop) {
            Object.defineProperty(oEvent, prop, {
              get: function() {
                return this.keyCodeVal;
              }
            });
          });
        }
        return oEvent;
      };
      var appendVNodes = function(node, vNodes) {
        if (vNodes === void 0) {
          vNodes = [];
        }
        var vNodesArr = Array.isArray(vNodes) ? vNodes : [vNodes];
        vNodesArr.forEach(function(vnode) {
          var tag = vnode[KEY_TAG] || "div";
          var attr = vnode[KEY_ATTR] || {};
          var el = document.createElement(tag);
          (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(attr, function(value, key) {
            el.setAttribute(key, value);
          });
          node.appendChild(el);
        });
      };
      var isTextNode = function(el) {
        return (el === null || el === void 0 ? void 0 : el.nodeType) === Node.TEXT_NODE;
      };
      var isCommentNode = function(el) {
        return (el === null || el === void 0 ? void 0 : el.nodeType) === Node.COMMENT_NODE;
      };
      var isTaggableNode = function(el) {
        return el && !isTextNode(el) && !isCommentNode(el);
      };
      var getElRect = function(el) {
        var def = {
          top: 0,
          left: 0,
          width: 0,
          height: 0
        };
        if (!el)
          return def;
        var rectText;
        if (isTextNode(el)) {
          var range = document.createRange();
          range.selectNode(el);
          rectText = range.getBoundingClientRect();
          range.detach();
        }
        return rectText || (el.getBoundingClientRect ? el.getBoundingClientRect() : def);
      };
      var getDocumentScroll = function(el) {
        var doc = (el === null || el === void 0 ? void 0 : el.ownerDocument) || document;
        var docEl = doc.documentElement;
        var win = doc.defaultView || window;
        return {
          x: (win.pageXOffset || docEl.scrollLeft || 0) - (docEl.clientLeft || 0),
          y: (win.pageYOffset || docEl.scrollTop || 0) - (docEl.clientTop || 0)
        };
      };
      var getKeyCode = function(ev) {
        return ev.which || ev.keyCode;
      };
      var getKeyChar = function(ev) {
        return String.fromCharCode(getKeyCode(ev));
      };
      var getPointerEvent = function(ev) {
        return ev.touches && ev.touches[0] ? ev.touches[0] : ev;
      };
      var isEscKey = function(ev) {
        return getKeyCode(ev) === 27;
      };
      var isEnterKey = function(ev) {
        return getKeyCode(ev) === 13;
      };
      var hasCtrlKey = function(ev) {
        return ev.ctrlKey;
      };
      var hasModifierKey = function(ev) {
        return hasCtrlKey(ev) || ev.metaKey;
      };
      var doctypeToString = function(dt) {
        if (!dt)
          return "";
        var name = dt.name, publicId = dt.publicId, systemId = dt.systemId;
        var pubId = publicId ? ' PUBLIC "'.concat(publicId, '"') : "";
        var sysId = !publicId && systemId ? ' SYSTEM "'.concat(systemId, '"') : "";
        return "<!DOCTYPE ".concat(name).concat(pubId).concat(sysId, ">");
      };
      var attrToString = function(attrs) {
        if (attrs === void 0) {
          attrs = {};
        }
        var res = [];
        (0, underscore__WEBPACK_IMPORTED_MODULE_0__.each)(attrs, function(value, key) {
          return res.push("".concat(key, '="').concat(value, '"'));
        });
        return res.join(" ");
      };
      var on = function(el, ev, fn, opts) {
        var evs = ev.split(/\s+/);
        var els = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isArray)(el) ? el : [el];
        evs.forEach(function(ev2) {
          els.forEach(function(el2) {
            return el2 === null || el2 === void 0 ? void 0 : el2.addEventListener(ev2, fn, opts);
          });
        });
      };
      var off = function(el, ev, fn, opts) {
        var evs = ev.split(/\s+/);
        var els = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isArray)(el) ? el : [el];
        evs.forEach(function(ev2) {
          els.forEach(function(el2) {
            return el2 === null || el2 === void 0 ? void 0 : el2.removeEventListener(ev2, fn, opts);
          });
        });
      };
    }
  ),
  /***/
  342: (
    /***/
    (__unused_webpack_module, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        /* harmony export */
        appendStyles: () => (
          /* binding */
          appendStyles
        ),
        /* harmony export */
        buildBase64UrlFromSvg: () => (
          /* binding */
          buildBase64UrlFromSvg
        ),
        /* harmony export */
        camelCase: () => (
          /* binding */
          camelCase
        ),
        /* harmony export */
        capitalize: () => (
          /* binding */
          capitalize
        ),
        /* harmony export */
        createId: () => (
          /* binding */
          createId
        ),
        /* harmony export */
        deepMerge: () => (
          /* binding */
          deepMerge
        ),
        /* harmony export */
        escape: () => (
          /* binding */
          escape
        ),
        /* harmony export */
        escapeNodeContent: () => (
          /* binding */
          escapeNodeContent
        ),
        /* harmony export */
        find: () => (
          /* binding */
          find
        ),
        /* harmony export */
        getComponentModel: () => (
          /* binding */
          getComponentModel
        ),
        /* harmony export */
        getComponentView: () => (
          /* binding */
          getComponentView
        ),
        /* harmony export */
        getElement: () => (
          /* binding */
          getElement
        ),
        /* harmony export */
        getGlobal: () => (
          /* binding */
          getGlobal
        ),
        /* harmony export */
        getModel: () => (
          /* binding */
          getModel
        ),
        /* harmony export */
        getUiClass: () => (
          /* binding */
          getUiClass
        ),
        /* harmony export */
        getUnitFromValue: () => (
          /* binding */
          getUnitFromValue
        ),
        /* harmony export */
        getViewEl: () => (
          /* binding */
          getViewEl
        ),
        /* harmony export */
        hasDnd: () => (
          /* binding */
          hasDnd
        ),
        /* harmony export */
        hasWin: () => (
          /* binding */
          hasWin
        ),
        /* harmony export */
        isBultInMethod: () => (
          /* binding */
          isBultInMethod
        ),
        /* harmony export */
        isComponent: () => (
          /* binding */
          isComponent
        ),
        /* harmony export */
        isDef: () => (
          /* binding */
          isDef
        ),
        /* harmony export */
        isEmptyObj: () => (
          /* binding */
          isEmptyObj
        ),
        /* harmony export */
        isObject: () => (
          /* binding */
          isObject
        ),
        /* harmony export */
        isRule: () => (
          /* binding */
          isRule
        ),
        /* harmony export */
        matches: () => (
          /* binding */
          matches
        ),
        /* harmony export */
        normalizeFloat: () => (
          /* binding */
          normalizeFloat
        ),
        /* harmony export */
        normalizeKey: () => (
          /* binding */
          normalizeKey
        ),
        /* harmony export */
        setViewEl: () => (
          /* binding */
          setViewEl
        ),
        /* harmony export */
        shallowDiff: () => (
          /* binding */
          shallowDiff
        ),
        /* harmony export */
        toLowerCase: () => (
          /* binding */
          toLowerCase
        ),
        /* harmony export */
        upFirst: () => (
          /* binding */
          upFirst
        ),
        /* harmony export */
        wait: () => (
          /* binding */
          wait
        )
        /* harmony export */
      });
      var underscore__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__2(523);
      var _dom__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__2(926);
      var __assign2 = function() {
        __assign2 = Object.assign || function(t) {
          for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s)
              if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
          }
          return t;
        };
        return __assign2.apply(this, arguments);
      };
      var __spreadArray2 = function(to, from, pack) {
        if (pack || arguments.length === 2)
          for (var i = 0, l = from.length, ar; i < l; i++) {
            if (ar || !(i in from)) {
              if (!ar)
                ar = Array.prototype.slice.call(from, 0, i);
              ar[i] = from[i];
            }
          }
        return to.concat(ar || Array.prototype.slice.call(from));
      };
      var obj = {};
      var isBultInMethod = function(key) {
        return (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isFunction)(obj[key]);
      };
      var normalizeKey = function(key) {
        return isBultInMethod(key) ? "_".concat(key) : key;
      };
      var wait = function(mls) {
        if (mls === void 0) {
          mls = 0;
        }
        return new Promise(function(res) {
          return setTimeout(res, mls);
        });
      };
      var isDef = function(value) {
        return typeof value !== "undefined";
      };
      var hasWin = function() {
        return typeof window !== "undefined";
      };
      var getGlobal = function() {
        return typeof globalThis !== "undefined" ? globalThis : typeof window !== "undefined" ? window : __webpack_require__2.g;
      };
      var toLowerCase = function(str) {
        return (str || "").toLowerCase();
      };
      var elProt = hasWin() ? window.Element.prototype : {};
      var matches = elProt.matches || elProt.webkitMatchesSelector || elProt.mozMatchesSelector || elProt.msMatchesSelector;
      var getUiClass = function(em, defCls) {
        var _a2 = em.getConfig(), stylePrefix = _a2.stylePrefix, customUI = _a2.customUI;
        return [customUI && "".concat(stylePrefix, "cui"), defCls].filter(function(i) {
          return i;
        }).join(" ");
      };
      var appendStyles = function(styles, opts) {
        if (opts === void 0) {
          opts = {};
        }
        var stls = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isArray)(styles) ? __spreadArray2([], styles, true) : [styles];
        if (stls.length) {
          var href = stls.shift();
          if (href && (!opts.unique || !document.querySelector('link[href="'.concat(href, '"]')))) {
            var head = document.head;
            var link = document.createElement("link");
            link.href = href;
            link.rel = "stylesheet";
            if (opts.prepand) {
              head.insertBefore(link, head.firstChild);
            } else {
              head.appendChild(link);
            }
          }
          appendStyles(stls);
        }
      };
      var shallowDiff = function(objOrig, objNew) {
        var result = {};
        var keysNew = (0, underscore__WEBPACK_IMPORTED_MODULE_0__.keys)(objNew);
        for (var prop in objOrig) {
          if (objOrig.hasOwnProperty(prop)) {
            var origValue = objOrig[prop];
            var newValue = objNew[prop];
            if (keysNew.indexOf(prop) >= 0) {
              if (origValue !== newValue) {
                result[prop] = newValue;
              }
            } else {
              result[prop] = null;
            }
          }
        }
        for (var prop in objNew) {
          if (objNew.hasOwnProperty(prop)) {
            if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isUndefined)(objOrig[prop])) {
              result[prop] = objNew[prop];
            }
          }
        }
        return result;
      };
      var getUnitFromValue = function(value) {
        return value.replace(parseFloat(value), "");
      };
      var upFirst = function(value) {
        return value[0].toUpperCase() + value.toLowerCase().slice(1);
      };
      var camelCase = function(value) {
        return value.replace(/-./g, function(x) {
          return x[1].toUpperCase();
        });
      };
      var normalizeFloat = function(value, step, valueDef) {
        if (step === void 0) {
          step = 1;
        }
        if (valueDef === void 0) {
          valueDef = 0;
        }
        var stepDecimals = 0;
        if (isNaN(value))
          return valueDef;
        value = parseFloat(value);
        if (Math.floor(value) !== value) {
          var side = step.toString().split(".")[1];
          stepDecimals = side ? side.length : 0;
        }
        return stepDecimals ? parseFloat(value.toFixed(stepDecimals)) : value;
      };
      var hasDnd = function(em) {
        return "draggable" in document.createElement("i") && (em ? em.config.nativeDnD : true);
      };
      var getElement = function(el) {
        if ((0, underscore__WEBPACK_IMPORTED_MODULE_0__.isElement)(el) || (0, _dom__WEBPACK_IMPORTED_MODULE_1__.ir)(el)) {
          return el;
        } else if (el && el.getEl) {
          return el.getEl();
        }
      };
      var find = function(arr, test) {
        var result = null;
        arr.some(function(el, i) {
          return test(el, i, arr) ? (result = el, 1) : 0;
        });
        return result;
      };
      var escape = function(str) {
        if (str === void 0) {
          str = "";
        }
        return "".concat(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/`/g, "&#96;");
      };
      var escapeNodeContent = function(str) {
        if (str === void 0) {
          str = "";
        }
        return "".concat(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      };
      var deepMerge = function() {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
          args[_i] = arguments[_i];
        }
        var target = __assign2({}, args[0]);
        for (var i = 1; i < args.length; i++) {
          var source = __assign2({}, args[i]);
          for (var key in source) {
            var targValue = target[key];
            var srcValue = source[key];
            if (isObject(targValue) && isObject(srcValue)) {
              target[key] = deepMerge(targValue, srcValue);
            } else {
              target[key] = srcValue;
            }
          }
        }
        return target;
      };
      var getModel = function(el, $) {
        var model;
        if (!$ && el && el.__cashData) {
          model = el.__cashData.model;
        } else if ($ && (0, underscore__WEBPACK_IMPORTED_MODULE_0__.isElement)(el)) {
          model = $(el).data("model");
        }
        return model;
      };
      var isObject = function(val) {
        return val && !Array.isArray(val) && typeof val === "object";
      };
      var isEmptyObj = function(val) {
        return Object.keys(val).length <= 0;
      };
      var capitalize = function(str) {
        if (str === void 0) {
          str = "";
        }
        return str && str.charAt(0).toUpperCase() + str.substring(1);
      };
      var isRule = function(obj2) {
        return obj2 && obj2.toCSS;
      };
      var getViewEl = function(el) {
        return el === null || el === void 0 ? void 0 : el.__gjsv;
      };
      var isComponent = function(obj2) {
        return !!(obj2 === null || obj2 === void 0 ? void 0 : obj2.toHTML);
      };
      var getComponentView = function(el) {
        return getViewEl(el);
      };
      var getComponentModel = function(el) {
        var _a2;
        return (_a2 = getComponentView(el)) === null || _a2 === void 0 ? void 0 : _a2.model;
      };
      var setViewEl = function(el, view) {
        el.__gjsv = view;
      };
      var createId = function(length) {
        if (length === void 0) {
          length = 16;
        }
        var result = "";
        var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var len = chars.length;
        for (var i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * len));
        }
        return result;
      };
      var buildBase64UrlFromSvg = function(svg) {
        if (svg && svg.substr(0, 4) === "<svg") {
          var base64Str = "";
          if (hasWin()) {
            base64Str = window.btoa(svg);
          } else if (typeof Buffer !== "undefined") {
            base64Str = Buffer.from(svg, "utf8").toString("base64");
          }
          return base64Str ? "data:image/svg+xml;base64,".concat(base64Str) : svg;
        }
        return svg;
      };
    }
  ),
  /***/
  585: (
    /***/
    (module, __unused_webpack_exports, __webpack_require__2) => {
      var map = {
        "./CanvasClear": 404,
        "./CanvasClear.ts": 404,
        "./CanvasMove": 228,
        "./CanvasMove.ts": 228,
        "./CommandAbstract": 570,
        "./CommandAbstract.ts": 570,
        "./ComponentDelete": 377,
        "./ComponentDelete.ts": 377,
        "./ComponentDrag": 728,
        "./ComponentDrag.ts": 728,
        "./ComponentEnter": 462,
        "./ComponentEnter.ts": 462,
        "./ComponentExit": 658,
        "./ComponentExit.ts": 658,
        "./ComponentNext": 619,
        "./ComponentNext.ts": 619,
        "./ComponentPrev": 935,
        "./ComponentPrev.ts": 935,
        "./ComponentStyleClear": 536,
        "./ComponentStyleClear.ts": 536,
        "./CopyComponent": 957,
        "./CopyComponent.ts": 957,
        "./ExportTemplate": 413,
        "./ExportTemplate.ts": 413,
        "./Fullscreen": 516,
        "./Fullscreen.ts": 516,
        "./MoveComponent": 13,
        "./MoveComponent.ts": 13,
        "./OpenAssets": 204,
        "./OpenAssets.ts": 204,
        "./OpenBlocks": 195,
        "./OpenBlocks.ts": 195,
        "./OpenLayers": 671,
        "./OpenLayers.ts": 671,
        "./OpenStyleManager": 49,
        "./OpenStyleManager.ts": 49,
        "./OpenTraitManager": 590,
        "./OpenTraitManager.ts": 590,
        "./PasteComponent": 483,
        "./PasteComponent.ts": 483,
        "./Preview": 857,
        "./Preview.ts": 857,
        "./Resize": 869,
        "./Resize.ts": 869,
        "./SelectComponent": 194,
        "./SelectComponent.ts": 194,
        "./SelectPosition": 582,
        "./SelectPosition.ts": 582,
        "./ShowOffset": 131,
        "./ShowOffset.ts": 131,
        "./SwitchVisibility": 229,
        "./SwitchVisibility.ts": 229
      };
      function webpackContext(req) {
        var id = webpackContextResolve(req);
        return __webpack_require__2(id);
      }
      function webpackContextResolve(req) {
        if (!__webpack_require__2.o(map, req)) {
          var e = new Error("Cannot find module '" + req + "'");
          e.code = "MODULE_NOT_FOUND";
          throw e;
        }
        return map[req];
      }
      webpackContext.keys = function webpackContextKeys() {
        return Object.keys(map);
      };
      webpackContext.resolve = webpackContextResolve;
      module.exports = webpackContext;
      webpackContext.id = 585;
    }
  ),
  /***/
  523: (
    /***/
    (__unused_webpack___webpack_module__, __webpack_exports__2, __webpack_require__2) => {
      __webpack_require__2.r(__webpack_exports__2);
      __webpack_require__2.d(__webpack_exports__2, {
        VERSION: () => (
          /* reexport */
          VERSION
        ),
        after: () => (
          /* reexport */
          after
        ),
        all: () => (
          /* reexport */
          every
        ),
        allKeys: () => (
          /* reexport */
          allKeys
        ),
        any: () => (
          /* reexport */
          some
        ),
        assign: () => (
          /* reexport */
          extendOwn
        ),
        before: () => (
          /* reexport */
          before
        ),
        bind: () => (
          /* reexport */
          bind2
        ),
        bindAll: () => (
          /* reexport */
          bindAll
        ),
        chain: () => (
          /* reexport */
          chain
        ),
        chunk: () => (
          /* reexport */
          chunk
        ),
        clone: () => (
          /* reexport */
          clone
        ),
        collect: () => (
          /* reexport */
          map
        ),
        compact: () => (
          /* reexport */
          compact
        ),
        compose: () => (
          /* reexport */
          compose
        ),
        constant: () => (
          /* reexport */
          constant
        ),
        contains: () => (
          /* reexport */
          contains
        ),
        countBy: () => (
          /* reexport */
          countBy
        ),
        create: () => (
          /* reexport */
          create
        ),
        debounce: () => (
          /* reexport */
          debounce
        ),
        "default": () => (
          /* reexport */
          index_default
        ),
        defaults: () => (
          /* reexport */
          defaults
        ),
        defer: () => (
          /* reexport */
          defer
        ),
        delay: () => (
          /* reexport */
          delay
        ),
        detect: () => (
          /* reexport */
          find
        ),
        difference: () => (
          /* reexport */
          difference
        ),
        drop: () => (
          /* reexport */
          rest
        ),
        each: () => (
          /* reexport */
          each
        ),
        escape: () => (
          /* reexport */
          modules_escape
        ),
        every: () => (
          /* reexport */
          every
        ),
        extend: () => (
          /* reexport */
          extend
        ),
        extendOwn: () => (
          /* reexport */
          extendOwn
        ),
        filter: () => (
          /* reexport */
          filter2
        ),
        find: () => (
          /* reexport */
          find
        ),
        findIndex: () => (
          /* reexport */
          findIndex
        ),
        findKey: () => (
          /* reexport */
          findKey
        ),
        findLastIndex: () => (
          /* reexport */
          findLastIndex
        ),
        findWhere: () => (
          /* reexport */
          findWhere
        ),
        first: () => (
          /* reexport */
          first
        ),
        flatten: () => (
          /* reexport */
          flatten_flatten
        ),
        foldl: () => (
          /* reexport */
          reduce
        ),
        foldr: () => (
          /* reexport */
          reduceRight
        ),
        forEach: () => (
          /* reexport */
          each
        ),
        functions: () => (
          /* reexport */
          functions
        ),
        get: () => (
          /* reexport */
          get
        ),
        groupBy: () => (
          /* reexport */
          groupBy
        ),
        has: () => (
          /* reexport */
          has_has
        ),
        head: () => (
          /* reexport */
          first
        ),
        identity: () => (
          /* reexport */
          identity
        ),
        include: () => (
          /* reexport */
          contains
        ),
        includes: () => (
          /* reexport */
          contains
        ),
        indexBy: () => (
          /* reexport */
          indexBy
        ),
        indexOf: () => (
          /* reexport */
          indexOf
        ),
        initial: () => (
          /* reexport */
          initial
        ),
        inject: () => (
          /* reexport */
          reduce
        ),
        intersection: () => (
          /* reexport */
          intersection
        ),
        invert: () => (
          /* reexport */
          invert
        ),
        invoke: () => (
          /* reexport */
          invoke
        ),
        isArguments: () => (
          /* reexport */
          modules_isArguments
        ),
        isArray: () => (
          /* reexport */
          isArray2
        ),
        isArrayBuffer: () => (
          /* reexport */
          isArrayBuffer
        ),
        isBoolean: () => (
          /* reexport */
          isBoolean
        ),
        isDataView: () => (
          /* reexport */
          modules_isDataView
        ),
        isDate: () => (
          /* reexport */
          isDate
        ),
        isElement: () => (
          /* reexport */
          isElement
        ),
        isEmpty: () => (
          /* reexport */
          isEmpty
        ),
        isEqual: () => (
          /* reexport */
          isEqual
        ),
        isError: () => (
          /* reexport */
          isError
        ),
        isFinite: () => (
          /* reexport */
          isFinite_isFinite
        ),
        isFunction: () => (
          /* reexport */
          modules_isFunction
        ),
        isMap: () => (
          /* reexport */
          isMap
        ),
        isMatch: () => (
          /* reexport */
          isMatch
        ),
        isNaN: () => (
          /* reexport */
          isNaN_isNaN
        ),
        isNull: () => (
          /* reexport */
          isNull
        ),
        isNumber: () => (
          /* reexport */
          isNumber
        ),
        isObject: () => (
          /* reexport */
          isObject
        ),
        isRegExp: () => (
          /* reexport */
          isRegExp
        ),
        isSet: () => (
          /* reexport */
          isSet
        ),
        isString: () => (
          /* reexport */
          isString
        ),
        isSymbol: () => (
          /* reexport */
          isSymbol2
        ),
        isTypedArray: () => (
          /* reexport */
          modules_isTypedArray
        ),
        isUndefined: () => (
          /* reexport */
          isUndefined
        ),
        isWeakMap: () => (
          /* reexport */
          isWeakMap
        ),
        isWeakSet: () => (
          /* reexport */
          isWeakSet
        ),
        iteratee: () => (
          /* reexport */
          iteratee
        ),
        keys: () => (
          /* reexport */
          keys
        ),
        last: () => (
          /* reexport */
          last
        ),
        lastIndexOf: () => (
          /* reexport */
          lastIndexOf
        ),
        map: () => (
          /* reexport */
          map
        ),
        mapObject: () => (
          /* reexport */
          mapObject
        ),
        matcher: () => (
          /* reexport */
          matcher
        ),
        matches: () => (
          /* reexport */
          matcher
        ),
        max: () => (
          /* reexport */
          max
        ),
        memoize: () => (
          /* reexport */
          memoize
        ),
        methods: () => (
          /* reexport */
          functions
        ),
        min: () => (
          /* reexport */
          min
        ),
        mixin: () => (
          /* reexport */
          mixin
        ),
        negate: () => (
          /* reexport */
          negate
        ),
        noop: () => (
          /* reexport */
          noop2
        ),
        now: () => (
          /* reexport */
          now
        ),
        object: () => (
          /* reexport */
          object
        ),
        omit: () => (
          /* reexport */
          omit
        ),
        once: () => (
          /* reexport */
          once
        ),
        pairs: () => (
          /* reexport */
          pairs
        ),
        partial: () => (
          /* reexport */
          modules_partial
        ),
        partition: () => (
          /* reexport */
          partition
        ),
        pick: () => (
          /* reexport */
          pick
        ),
        pluck: () => (
          /* reexport */
          pluck
        ),
        property: () => (
          /* reexport */
          property
        ),
        propertyOf: () => (
          /* reexport */
          propertyOf
        ),
        random: () => (
          /* reexport */
          random
        ),
        range: () => (
          /* reexport */
          range
        ),
        reduce: () => (
          /* reexport */
          reduce
        ),
        reduceRight: () => (
          /* reexport */
          reduceRight
        ),
        reject: () => (
          /* reexport */
          reject2
        ),
        rest: () => (
          /* reexport */
          rest
        ),
        restArguments: () => (
          /* reexport */
          restArguments
        ),
        result: () => (
          /* reexport */
          result
        ),
        sample: () => (
          /* reexport */
          sample
        ),
        select: () => (
          /* reexport */
          filter2
        ),
        shuffle: () => (
          /* reexport */
          shuffle
        ),
        size: () => (
          /* reexport */
          size
        ),
        some: () => (
          /* reexport */
          some
        ),
        sortBy: () => (
          /* reexport */
          sortBy
        ),
        sortedIndex: () => (
          /* reexport */
          sortedIndex
        ),
        tail: () => (
          /* reexport */
          rest
        ),
        take: () => (
          /* reexport */
          first
        ),
        tap: () => (
          /* reexport */
          tap
        ),
        template: () => (
          /* reexport */
          template
        ),
        templateSettings: () => (
          /* reexport */
          templateSettings
        ),
        throttle: () => (
          /* reexport */
          throttle
        ),
        times: () => (
          /* reexport */
          times
        ),
        toArray: () => (
          /* reexport */
          toArray
        ),
        toPath: () => (
          /* reexport */
          toPath
        ),
        transpose: () => (
          /* reexport */
          unzip
        ),
        unescape: () => (
          /* reexport */
          modules_unescape
        ),
        union: () => (
          /* reexport */
          union
        ),
        uniq: () => (
          /* reexport */
          uniq
        ),
        unique: () => (
          /* reexport */
          uniq
        ),
        uniqueId: () => (
          /* reexport */
          uniqueId
        ),
        unzip: () => (
          /* reexport */
          unzip
        ),
        values: () => (
          /* reexport */
          values
        ),
        where: () => (
          /* reexport */
          where
        ),
        without: () => (
          /* reexport */
          without
        ),
        wrap: () => (
          /* reexport */
          wrap
        ),
        zip: () => (
          /* reexport */
          zip
        )
      });
      var modules_namespaceObject = {};
      __webpack_require__2.r(modules_namespaceObject);
      __webpack_require__2.d(modules_namespaceObject, {
        VERSION: () => VERSION,
        after: () => after,
        all: () => every,
        allKeys: () => allKeys,
        any: () => some,
        assign: () => extendOwn,
        before: () => before,
        bind: () => bind2,
        bindAll: () => bindAll,
        chain: () => chain,
        chunk: () => chunk,
        clone: () => clone,
        collect: () => map,
        compact: () => compact,
        compose: () => compose,
        constant: () => constant,
        contains: () => contains,
        countBy: () => countBy,
        create: () => create,
        debounce: () => debounce,
        "default": () => underscore_array_methods,
        defaults: () => defaults,
        defer: () => defer,
        delay: () => delay,
        detect: () => find,
        difference: () => difference,
        drop: () => rest,
        each: () => each,
        escape: () => modules_escape,
        every: () => every,
        extend: () => extend,
        extendOwn: () => extendOwn,
        filter: () => filter2,
        find: () => find,
        findIndex: () => findIndex,
        findKey: () => findKey,
        findLastIndex: () => findLastIndex,
        findWhere: () => findWhere,
        first: () => first,
        flatten: () => flatten_flatten,
        foldl: () => reduce,
        foldr: () => reduceRight,
        forEach: () => each,
        functions: () => functions,
        get: () => get,
        groupBy: () => groupBy,
        has: () => has_has,
        head: () => first,
        identity: () => identity,
        include: () => contains,
        includes: () => contains,
        indexBy: () => indexBy,
        indexOf: () => indexOf,
        initial: () => initial,
        inject: () => reduce,
        intersection: () => intersection,
        invert: () => invert,
        invoke: () => invoke,
        isArguments: () => modules_isArguments,
        isArray: () => isArray2,
        isArrayBuffer: () => isArrayBuffer,
        isBoolean: () => isBoolean,
        isDataView: () => modules_isDataView,
        isDate: () => isDate,
        isElement: () => isElement,
        isEmpty: () => isEmpty,
        isEqual: () => isEqual,
        isError: () => isError,
        isFinite: () => isFinite_isFinite,
        isFunction: () => modules_isFunction,
        isMap: () => isMap,
        isMatch: () => isMatch,
        isNaN: () => isNaN_isNaN,
        isNull: () => isNull,
        isNumber: () => isNumber,
        isObject: () => isObject,
        isRegExp: () => isRegExp,
        isSet: () => isSet,
        isString: () => isString,
        isSymbol: () => isSymbol2,
        isTypedArray: () => modules_isTypedArray,
        isUndefined: () => isUndefined,
        isWeakMap: () => isWeakMap,
        isWeakSet: () => isWeakSet,
        iteratee: () => iteratee,
        keys: () => keys,
        last: () => last,
        lastIndexOf: () => lastIndexOf,
        map: () => map,
        mapObject: () => mapObject,
        matcher: () => matcher,
        matches: () => matcher,
        max: () => max,
        memoize: () => memoize,
        methods: () => functions,
        min: () => min,
        mixin: () => mixin,
        negate: () => negate,
        noop: () => noop2,
        now: () => now,
        object: () => object,
        omit: () => omit,
        once: () => once,
        pairs: () => pairs,
        partial: () => modules_partial,
        partition: () => partition,
        pick: () => pick,
        pluck: () => pluck,
        property: () => property,
        propertyOf: () => propertyOf,
        random: () => random,
        range: () => range,
        reduce: () => reduce,
        reduceRight: () => reduceRight,
        reject: () => reject2,
        rest: () => rest,
        restArguments: () => restArguments,
        result: () => result,
        sample: () => sample,
        select: () => filter2,
        shuffle: () => shuffle,
        size: () => size,
        some: () => some,
        sortBy: () => sortBy,
        sortedIndex: () => sortedIndex,
        tail: () => rest,
        take: () => first,
        tap: () => tap,
        template: () => template,
        templateSettings: () => templateSettings,
        throttle: () => throttle,
        times: () => times,
        toArray: () => toArray,
        toPath: () => toPath,
        transpose: () => unzip,
        unescape: () => modules_unescape,
        union: () => union,
        uniq: () => uniq,
        unique: () => uniq,
        uniqueId: () => uniqueId,
        unzip: () => unzip,
        values: () => values,
        where: () => where,
        without: () => without,
        wrap: () => wrap,
        zip: () => zip
      });
      ;
      var VERSION = "1.13.1";
      var root = typeof self == "object" && self.self === self && self || typeof global == "object" && global.global === global && global || Function("return this")() || {};
      var ArrayProto = Array.prototype, ObjProto = Object.prototype;
      var SymbolProto = typeof Symbol !== "undefined" ? Symbol.prototype : null;
      var push = ArrayProto.push, slice = ArrayProto.slice, _setup_toString = ObjProto.toString, _setup_hasOwnProperty = ObjProto.hasOwnProperty;
      var supportsArrayBuffer = typeof ArrayBuffer !== "undefined", supportsDataView = typeof DataView !== "undefined";
      var nativeIsArray = Array.isArray, nativeKeys = Object.keys, nativeCreate = Object.create, nativeIsView = supportsArrayBuffer && ArrayBuffer.isView;
      var _isNaN = isNaN, _isFinite = isFinite;
      var hasEnumBug = !{ toString: null }.propertyIsEnumerable("toString");
      var nonEnumerableProps = [
        "valueOf",
        "isPrototypeOf",
        "toString",
        "propertyIsEnumerable",
        "hasOwnProperty",
        "toLocaleString"
      ];
      var MAX_ARRAY_INDEX = Math.pow(2, 53) - 1;
      ;
      function restArguments(func, startIndex) {
        startIndex = startIndex == null ? func.length - 1 : +startIndex;
        return function() {
          var length = Math.max(arguments.length - startIndex, 0), rest2 = Array(length), index2 = 0;
          for (; index2 < length; index2++) {
            rest2[index2] = arguments[index2 + startIndex];
          }
          switch (startIndex) {
            case 0:
              return func.call(this, rest2);
            case 1:
              return func.call(this, arguments[0], rest2);
            case 2:
              return func.call(this, arguments[0], arguments[1], rest2);
          }
          var args = Array(startIndex + 1);
          for (index2 = 0; index2 < startIndex; index2++) {
            args[index2] = arguments[index2];
          }
          args[startIndex] = rest2;
          return func.apply(this, args);
        };
      }
      ;
      function isObject(obj) {
        var type2 = typeof obj;
        return type2 === "function" || type2 === "object" && !!obj;
      }
      ;
      function isNull(obj) {
        return obj === null;
      }
      ;
      function isUndefined(obj) {
        return obj === void 0;
      }
      ;
      function isBoolean(obj) {
        return obj === true || obj === false || _setup_toString.call(obj) === "[object Boolean]";
      }
      ;
      function isElement(obj) {
        return !!(obj && obj.nodeType === 1);
      }
      ;
      function tagTester(name) {
        var tag = "[object " + name + "]";
        return function(obj) {
          return _setup_toString.call(obj) === tag;
        };
      }
      ;
      const isString = tagTester("String");
      ;
      const isNumber = tagTester("Number");
      ;
      const isDate = tagTester("Date");
      ;
      const isRegExp = tagTester("RegExp");
      ;
      const isError = tagTester("Error");
      ;
      const isSymbol2 = tagTester("Symbol");
      ;
      const isArrayBuffer = tagTester("ArrayBuffer");
      ;
      var isFunction = tagTester("Function");
      var nodelist = root.document && root.document.childNodes;
      if (typeof Int8Array != "object" && typeof nodelist != "function") {
        isFunction = function(obj) {
          return typeof obj == "function" || false;
        };
      }
      const modules_isFunction = isFunction;
      ;
      const _hasObjectTag = tagTester("Object");
      ;
      var hasStringTagBug = supportsDataView && _hasObjectTag(new DataView(new ArrayBuffer(8))), isIE11 = typeof Map !== "undefined" && _hasObjectTag(/* @__PURE__ */ new Map());
      ;
      var isDataView = tagTester("DataView");
      function ie10IsDataView(obj) {
        return obj != null && modules_isFunction(obj.getInt8) && isArrayBuffer(obj.buffer);
      }
      const modules_isDataView = hasStringTagBug ? ie10IsDataView : isDataView;
      ;
      const isArray2 = nativeIsArray || tagTester("Array");
      ;
      function has(obj, key) {
        return obj != null && _setup_hasOwnProperty.call(obj, key);
      }
      ;
      var isArguments = tagTester("Arguments");
      (function() {
        if (!isArguments(arguments)) {
          isArguments = function(obj) {
            return has(obj, "callee");
          };
        }
      })();
      const modules_isArguments = isArguments;
      ;
      function isFinite_isFinite(obj) {
        return !isSymbol2(obj) && _isFinite(obj) && !isNaN(parseFloat(obj));
      }
      ;
      function isNaN_isNaN(obj) {
        return isNumber(obj) && _isNaN(obj);
      }
      ;
      function constant(value) {
        return function() {
          return value;
        };
      }
      ;
      function createSizePropertyCheck(getSizeProperty) {
        return function(collection) {
          var sizeProperty = getSizeProperty(collection);
          return typeof sizeProperty == "number" && sizeProperty >= 0 && sizeProperty <= MAX_ARRAY_INDEX;
        };
      }
      ;
      function shallowProperty(key) {
        return function(obj) {
          return obj == null ? void 0 : obj[key];
        };
      }
      ;
      const _getByteLength = shallowProperty("byteLength");
      ;
      const _isBufferLike = createSizePropertyCheck(_getByteLength);
      ;
      var typedArrayPattern = /\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;
      function isTypedArray(obj) {
        return nativeIsView ? nativeIsView(obj) && !modules_isDataView(obj) : _isBufferLike(obj) && typedArrayPattern.test(_setup_toString.call(obj));
      }
      const modules_isTypedArray = supportsArrayBuffer ? isTypedArray : constant(false);
      ;
      const _getLength = shallowProperty("length");
      ;
      function emulatedSet(keys2) {
        var hash = {};
        for (var l = keys2.length, i = 0; i < l; ++i)
          hash[keys2[i]] = true;
        return {
          contains: function(key) {
            return hash[key];
          },
          push: function(key) {
            hash[key] = true;
            return keys2.push(key);
          }
        };
      }
      function collectNonEnumProps(obj, keys2) {
        keys2 = emulatedSet(keys2);
        var nonEnumIdx = nonEnumerableProps.length;
        var constructor = obj.constructor;
        var proto = modules_isFunction(constructor) && constructor.prototype || ObjProto;
        var prop = "constructor";
        if (has(obj, prop) && !keys2.contains(prop))
          keys2.push(prop);
        while (nonEnumIdx--) {
          prop = nonEnumerableProps[nonEnumIdx];
          if (prop in obj && obj[prop] !== proto[prop] && !keys2.contains(prop)) {
            keys2.push(prop);
          }
        }
      }
      ;
      function keys(obj) {
        if (!isObject(obj))
          return [];
        if (nativeKeys)
          return nativeKeys(obj);
        var keys2 = [];
        for (var key in obj)
          if (has(obj, key))
            keys2.push(key);
        if (hasEnumBug)
          collectNonEnumProps(obj, keys2);
        return keys2;
      }
      ;
      function isEmpty(obj) {
        if (obj == null)
          return true;
        var length = _getLength(obj);
        if (typeof length == "number" && (isArray2(obj) || isString(obj) || modules_isArguments(obj)))
          return length === 0;
        return _getLength(keys(obj)) === 0;
      }
      ;
      function isMatch(object2, attrs) {
        var _keys = keys(attrs), length = _keys.length;
        if (object2 == null)
          return !length;
        var obj = Object(object2);
        for (var i = 0; i < length; i++) {
          var key = _keys[i];
          if (attrs[key] !== obj[key] || !(key in obj))
            return false;
        }
        return true;
      }
      ;
      function _(obj) {
        if (obj instanceof _)
          return obj;
        if (!(this instanceof _))
          return new _(obj);
        this._wrapped = obj;
      }
      _.VERSION = VERSION;
      _.prototype.value = function() {
        return this._wrapped;
      };
      _.prototype.valueOf = _.prototype.toJSON = _.prototype.value;
      _.prototype.toString = function() {
        return String(this._wrapped);
      };
      ;
      function toBufferView(bufferSource) {
        return new Uint8Array(
          bufferSource.buffer || bufferSource,
          bufferSource.byteOffset || 0,
          _getByteLength(bufferSource)
        );
      }
      ;
      var tagDataView = "[object DataView]";
      function eq(a, b, aStack, bStack) {
        if (a === b)
          return a !== 0 || 1 / a === 1 / b;
        if (a == null || b == null)
          return false;
        if (a !== a)
          return b !== b;
        var type2 = typeof a;
        if (type2 !== "function" && type2 !== "object" && typeof b != "object")
          return false;
        return deepEq(a, b, aStack, bStack);
      }
      function deepEq(a, b, aStack, bStack) {
        if (a instanceof _)
          a = a._wrapped;
        if (b instanceof _)
          b = b._wrapped;
        var className = _setup_toString.call(a);
        if (className !== _setup_toString.call(b))
          return false;
        if (hasStringTagBug && className == "[object Object]" && modules_isDataView(a)) {
          if (!modules_isDataView(b))
            return false;
          className = tagDataView;
        }
        switch (className) {
          case "[object RegExp]":
          case "[object String]":
            return "" + a === "" + b;
          case "[object Number]":
            if (+a !== +a)
              return +b !== +b;
            return +a === 0 ? 1 / +a === 1 / b : +a === +b;
          case "[object Date]":
          case "[object Boolean]":
            return +a === +b;
          case "[object Symbol]":
            return SymbolProto.valueOf.call(a) === SymbolProto.valueOf.call(b);
          case "[object ArrayBuffer]":
          case tagDataView:
            return deepEq(toBufferView(a), toBufferView(b), aStack, bStack);
        }
        var areArrays = className === "[object Array]";
        if (!areArrays && modules_isTypedArray(a)) {
          var byteLength = _getByteLength(a);
          if (byteLength !== _getByteLength(b))
            return false;
          if (a.buffer === b.buffer && a.byteOffset === b.byteOffset)
            return true;
          areArrays = true;
        }
        if (!areArrays) {
          if (typeof a != "object" || typeof b != "object")
            return false;
          var aCtor = a.constructor, bCtor = b.constructor;
          if (aCtor !== bCtor && !(modules_isFunction(aCtor) && aCtor instanceof aCtor && modules_isFunction(bCtor) && bCtor instanceof bCtor) && ("constructor" in a && "constructor" in b)) {
            return false;
          }
        }
        aStack = aStack || [];
        bStack = bStack || [];
        var length = aStack.length;
        while (length--) {
          if (aStack[length] === a)
            return bStack[length] === b;
        }
        aStack.push(a);
        bStack.push(b);
        if (areArrays) {
          length = a.length;
          if (length !== b.length)
            return false;
          while (length--) {
            if (!eq(a[length], b[length], aStack, bStack))
              return false;
          }
        } else {
          var _keys = keys(a), key;
          length = _keys.length;
          if (keys(b).length !== length)
            return false;
          while (length--) {
            key = _keys[length];
            if (!(has(b, key) && eq(a[key], b[key], aStack, bStack)))
              return false;
          }
        }
        aStack.pop();
        bStack.pop();
        return true;
      }
      function isEqual(a, b) {
        return eq(a, b);
      }
      ;
      function allKeys(obj) {
        if (!isObject(obj))
          return [];
        var keys2 = [];
        for (var key in obj)
          keys2.push(key);
        if (hasEnumBug)
          collectNonEnumProps(obj, keys2);
        return keys2;
      }
      ;
      function ie11fingerprint(methods) {
        var length = _getLength(methods);
        return function(obj) {
          if (obj == null)
            return false;
          var keys2 = allKeys(obj);
          if (_getLength(keys2))
            return false;
          for (var i = 0; i < length; i++) {
            if (!modules_isFunction(obj[methods[i]]))
              return false;
          }
          return methods !== weakMapMethods || !modules_isFunction(obj[forEachName]);
        };
      }
      var forEachName = "forEach", hasName = "has", commonInit = ["clear", "delete"], mapTail = ["get", hasName, "set"];
      var mapMethods = commonInit.concat(forEachName, mapTail), weakMapMethods = commonInit.concat(mapTail), setMethods = ["add"].concat(commonInit, forEachName, hasName);
      ;
      const isMap = isIE11 ? ie11fingerprint(mapMethods) : tagTester("Map");
      ;
      const isWeakMap = isIE11 ? ie11fingerprint(weakMapMethods) : tagTester("WeakMap");
      ;
      const isSet = isIE11 ? ie11fingerprint(setMethods) : tagTester("Set");
      ;
      const isWeakSet = tagTester("WeakSet");
      ;
      function values(obj) {
        var _keys = keys(obj);
        var length = _keys.length;
        var values2 = Array(length);
        for (var i = 0; i < length; i++) {
          values2[i] = obj[_keys[i]];
        }
        return values2;
      }
      ;
      function pairs(obj) {
        var _keys = keys(obj);
        var length = _keys.length;
        var pairs2 = Array(length);
        for (var i = 0; i < length; i++) {
          pairs2[i] = [_keys[i], obj[_keys[i]]];
        }
        return pairs2;
      }
      ;
      function invert(obj) {
        var result2 = {};
        var _keys = keys(obj);
        for (var i = 0, length = _keys.length; i < length; i++) {
          result2[obj[_keys[i]]] = _keys[i];
        }
        return result2;
      }
      ;
      function functions(obj) {
        var names = [];
        for (var key in obj) {
          if (modules_isFunction(obj[key]))
            names.push(key);
        }
        return names.sort();
      }
      ;
      function createAssigner(keysFunc, defaults2) {
        return function(obj) {
          var length = arguments.length;
          if (defaults2)
            obj = Object(obj);
          if (length < 2 || obj == null)
            return obj;
          for (var index2 = 1; index2 < length; index2++) {
            var source = arguments[index2], keys2 = keysFunc(source), l = keys2.length;
            for (var i = 0; i < l; i++) {
              var key = keys2[i];
              if (!defaults2 || obj[key] === void 0)
                obj[key] = source[key];
            }
          }
          return obj;
        };
      }
      ;
      const extend = createAssigner(allKeys);
      ;
      const extendOwn = createAssigner(keys);
      ;
      const defaults = createAssigner(allKeys, true);
      ;
      function ctor() {
        return function() {
        };
      }
      function baseCreate(prototype) {
        if (!isObject(prototype))
          return {};
        if (nativeCreate)
          return nativeCreate(prototype);
        var Ctor = ctor();
        Ctor.prototype = prototype;
        var result2 = new Ctor();
        Ctor.prototype = null;
        return result2;
      }
      ;
      function create(prototype, props) {
        var result2 = baseCreate(prototype);
        if (props)
          extendOwn(result2, props);
        return result2;
      }
      ;
      function clone(obj) {
        if (!isObject(obj))
          return obj;
        return isArray2(obj) ? obj.slice() : extend({}, obj);
      }
      ;
      function tap(obj, interceptor) {
        interceptor(obj);
        return obj;
      }
      ;
      function toPath(path) {
        return isArray2(path) ? path : [path];
      }
      _.toPath = toPath;
      ;
      function _toPath_toPath(path) {
        return _.toPath(path);
      }
      ;
      function deepGet(obj, path) {
        var length = path.length;
        for (var i = 0; i < length; i++) {
          if (obj == null)
            return void 0;
          obj = obj[path[i]];
        }
        return length ? obj : void 0;
      }
      ;
      function get(object2, path, defaultValue) {
        var value = deepGet(object2, _toPath_toPath(path));
        return isUndefined(value) ? defaultValue : value;
      }
      ;
      function has_has(obj, path) {
        path = _toPath_toPath(path);
        var length = path.length;
        for (var i = 0; i < length; i++) {
          var key = path[i];
          if (!has(obj, key))
            return false;
          obj = obj[key];
        }
        return !!length;
      }
      ;
      function identity(value) {
        return value;
      }
      ;
      function matcher(attrs) {
        attrs = extendOwn({}, attrs);
        return function(obj) {
          return isMatch(obj, attrs);
        };
      }
      ;
      function property(path) {
        path = _toPath_toPath(path);
        return function(obj) {
          return deepGet(obj, path);
        };
      }
      ;
      function optimizeCb(func, context, argCount) {
        if (context === void 0)
          return func;
        switch (argCount == null ? 3 : argCount) {
          case 1:
            return function(value) {
              return func.call(context, value);
            };
          case 3:
            return function(value, index2, collection) {
              return func.call(context, value, index2, collection);
            };
          case 4:
            return function(accumulator, value, index2, collection) {
              return func.call(context, accumulator, value, index2, collection);
            };
        }
        return function() {
          return func.apply(context, arguments);
        };
      }
      ;
      function baseIteratee(value, context, argCount) {
        if (value == null)
          return identity;
        if (modules_isFunction(value))
          return optimizeCb(value, context, argCount);
        if (isObject(value) && !isArray2(value))
          return matcher(value);
        return property(value);
      }
      ;
      function iteratee(value, context) {
        return baseIteratee(value, context, Infinity);
      }
      _.iteratee = iteratee;
      ;
      function cb(value, context, argCount) {
        if (_.iteratee !== iteratee)
          return _.iteratee(value, context);
        return baseIteratee(value, context, argCount);
      }
      ;
      function mapObject(obj, iteratee2, context) {
        iteratee2 = cb(iteratee2, context);
        var _keys = keys(obj), length = _keys.length, results = {};
        for (var index2 = 0; index2 < length; index2++) {
          var currentKey = _keys[index2];
          results[currentKey] = iteratee2(obj[currentKey], currentKey, obj);
        }
        return results;
      }
      ;
      function noop2() {
      }
      ;
      function propertyOf(obj) {
        if (obj == null)
          return noop2;
        return function(path) {
          return get(obj, path);
        };
      }
      ;
      function times(n, iteratee2, context) {
        var accum = Array(Math.max(0, n));
        iteratee2 = optimizeCb(iteratee2, context, 1);
        for (var i = 0; i < n; i++)
          accum[i] = iteratee2(i);
        return accum;
      }
      ;
      function random(min2, max2) {
        if (max2 == null) {
          max2 = min2;
          min2 = 0;
        }
        return min2 + Math.floor(Math.random() * (max2 - min2 + 1));
      }
      ;
      const now = Date.now || function() {
        return (/* @__PURE__ */ new Date()).getTime();
      };
      ;
      function createEscaper(map2) {
        var escaper = function(match) {
          return map2[match];
        };
        var source = "(?:" + keys(map2).join("|") + ")";
        var testRegexp = RegExp(source);
        var replaceRegexp = RegExp(source, "g");
        return function(string) {
          string = string == null ? "" : "" + string;
          return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
        };
      }
      ;
      const _escapeMap = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#x27;",
        "`": "&#x60;"
      };
      ;
      const modules_escape = createEscaper(_escapeMap);
      ;
      const _unescapeMap = invert(_escapeMap);
      ;
      const modules_unescape = createEscaper(_unescapeMap);
      ;
      const templateSettings = _.templateSettings = {
        evaluate: /<%([\s\S]+?)%>/g,
        interpolate: /<%=([\s\S]+?)%>/g,
        escape: /<%-([\s\S]+?)%>/g
      };
      ;
      var noMatch = /(.)^/;
      var escapes = {
        "'": "'",
        "\\": "\\",
        "\r": "r",
        "\n": "n",
        "\u2028": "u2028",
        "\u2029": "u2029"
      };
      var escapeRegExp2 = /\\|'|\r|\n|\u2028|\u2029/g;
      function escapeChar(match) {
        return "\\" + escapes[match];
      }
      var bareIdentifier = /^\s*(\w|\$)+\s*$/;
      function template(text, settings, oldSettings) {
        if (!settings && oldSettings)
          settings = oldSettings;
        settings = defaults({}, settings, _.templateSettings);
        var matcher2 = RegExp([
          (settings.escape || noMatch).source,
          (settings.interpolate || noMatch).source,
          (settings.evaluate || noMatch).source
        ].join("|") + "|$", "g");
        var index2 = 0;
        var source = "__p+='";
        text.replace(matcher2, function(match, escape, interpolate, evaluate, offset) {
          source += text.slice(index2, offset).replace(escapeRegExp2, escapeChar);
          index2 = offset + match.length;
          if (escape) {
            source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
          } else if (interpolate) {
            source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
          } else if (evaluate) {
            source += "';\n" + evaluate + "\n__p+='";
          }
          return match;
        });
        source += "';\n";
        var argument = settings.variable;
        if (argument) {
          if (!bareIdentifier.test(argument))
            throw new Error(
              "variable is not a bare identifier: " + argument
            );
        } else {
          source = "with(obj||{}){\n" + source + "}\n";
          argument = "obj";
        }
        source = "var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n" + source + "return __p;\n";
        var render;
        try {
          render = new Function(argument, "_", source);
        } catch (e) {
          e.source = source;
          throw e;
        }
        var template2 = function(data) {
          return render.call(this, data, _);
        };
        template2.source = "function(" + argument + "){\n" + source + "}";
        return template2;
      }
      ;
      function result(obj, path, fallback) {
        path = _toPath_toPath(path);
        var length = path.length;
        if (!length) {
          return modules_isFunction(fallback) ? fallback.call(obj) : fallback;
        }
        for (var i = 0; i < length; i++) {
          var prop = obj == null ? void 0 : obj[path[i]];
          if (prop === void 0) {
            prop = fallback;
            i = length;
          }
          obj = modules_isFunction(prop) ? prop.call(obj) : prop;
        }
        return obj;
      }
      ;
      var idCounter = 0;
      function uniqueId(prefix) {
        var id = ++idCounter + "";
        return prefix ? prefix + id : id;
      }
      ;
      function chain(obj) {
        var instance = _(obj);
        instance._chain = true;
        return instance;
      }
      ;
      function executeBound(sourceFunc, boundFunc, context, callingContext, args) {
        if (!(callingContext instanceof boundFunc))
          return sourceFunc.apply(context, args);
        var self2 = baseCreate(sourceFunc.prototype);
        var result2 = sourceFunc.apply(self2, args);
        if (isObject(result2))
          return result2;
        return self2;
      }
      ;
      var partial = restArguments(function(func, boundArgs) {
        var placeholder = partial.placeholder;
        var bound = function() {
          var position = 0, length = boundArgs.length;
          var args = Array(length);
          for (var i = 0; i < length; i++) {
            args[i] = boundArgs[i] === placeholder ? arguments[position++] : boundArgs[i];
          }
          while (position < arguments.length)
            args.push(arguments[position++]);
          return executeBound(func, bound, this, this, args);
        };
        return bound;
      });
      partial.placeholder = _;
      const modules_partial = partial;
      ;
      const bind2 = restArguments(function(func, context, args) {
        if (!modules_isFunction(func))
          throw new TypeError("Bind must be called on a function");
        var bound = restArguments(function(callArgs) {
          return executeBound(func, bound, context, this, args.concat(callArgs));
        });
        return bound;
      });
      ;
      const _isArrayLike = createSizePropertyCheck(_getLength);
      ;
      function flatten(input, depth, strict, output) {
        output = output || [];
        if (!depth && depth !== 0) {
          depth = Infinity;
        } else if (depth <= 0) {
          return output.concat(input);
        }
        var idx = output.length;
        for (var i = 0, length = _getLength(input); i < length; i++) {
          var value = input[i];
          if (_isArrayLike(value) && (isArray2(value) || modules_isArguments(value))) {
            if (depth > 1) {
              flatten(value, depth - 1, strict, output);
              idx = output.length;
            } else {
              var j = 0, len = value.length;
              while (j < len)
                output[idx++] = value[j++];
            }
          } else if (!strict) {
            output[idx++] = value;
          }
        }
        return output;
      }
      ;
      const bindAll = restArguments(function(obj, keys2) {
        keys2 = flatten(keys2, false, false);
        var index2 = keys2.length;
        if (index2 < 1)
          throw new Error("bindAll must be passed function names");
        while (index2--) {
          var key = keys2[index2];
          obj[key] = bind2(obj[key], obj);
        }
        return obj;
      });
      ;
      function memoize(func, hasher) {
        var memoize2 = function(key) {
          var cache = memoize2.cache;
          var address = "" + (hasher ? hasher.apply(this, arguments) : key);
          if (!has(cache, address))
            cache[address] = func.apply(this, arguments);
          return cache[address];
        };
        memoize2.cache = {};
        return memoize2;
      }
      ;
      const delay = restArguments(function(func, wait, args) {
        return setTimeout(function() {
          return func.apply(null, args);
        }, wait);
      });
      ;
      const defer = modules_partial(delay, _, 1);
      ;
      function throttle(func, wait, options) {
        var timeout, context, args, result2;
        var previous = 0;
        if (!options)
          options = {};
        var later = function() {
          previous = options.leading === false ? 0 : now();
          timeout = null;
          result2 = func.apply(context, args);
          if (!timeout)
            context = args = null;
        };
        var throttled = function() {
          var _now = now();
          if (!previous && options.leading === false)
            previous = _now;
          var remaining = wait - (_now - previous);
          context = this;
          args = arguments;
          if (remaining <= 0 || remaining > wait) {
            if (timeout) {
              clearTimeout(timeout);
              timeout = null;
            }
            previous = _now;
            result2 = func.apply(context, args);
            if (!timeout)
              context = args = null;
          } else if (!timeout && options.trailing !== false) {
            timeout = setTimeout(later, remaining);
          }
          return result2;
        };
        throttled.cancel = function() {
          clearTimeout(timeout);
          previous = 0;
          timeout = context = args = null;
        };
        return throttled;
      }
      ;
      function debounce(func, wait, immediate) {
        var timeout, previous, args, result2, context;
        var later = function() {
          var passed = now() - previous;
          if (wait > passed) {
            timeout = setTimeout(later, wait - passed);
          } else {
            timeout = null;
            if (!immediate)
              result2 = func.apply(context, args);
            if (!timeout)
              args = context = null;
          }
        };
        var debounced = restArguments(function(_args) {
          context = this;
          args = _args;
          previous = now();
          if (!timeout) {
            timeout = setTimeout(later, wait);
            if (immediate)
              result2 = func.apply(context, args);
          }
          return result2;
        });
        debounced.cancel = function() {
          clearTimeout(timeout);
          timeout = args = context = null;
        };
        return debounced;
      }
      ;
      function wrap(func, wrapper) {
        return modules_partial(wrapper, func);
      }
      ;
      function negate(predicate) {
        return function() {
          return !predicate.apply(this, arguments);
        };
      }
      ;
      function compose() {
        var args = arguments;
        var start = args.length - 1;
        return function() {
          var i = start;
          var result2 = args[start].apply(this, arguments);
          while (i--)
            result2 = args[i].call(this, result2);
          return result2;
        };
      }
      ;
      function after(times2, func) {
        return function() {
          if (--times2 < 1) {
            return func.apply(this, arguments);
          }
        };
      }
      ;
      function before(times2, func) {
        var memo;
        return function() {
          if (--times2 > 0) {
            memo = func.apply(this, arguments);
          }
          if (times2 <= 1)
            func = null;
          return memo;
        };
      }
      ;
      const once = modules_partial(before, 2);
      ;
      function findKey(obj, predicate, context) {
        predicate = cb(predicate, context);
        var _keys = keys(obj), key;
        for (var i = 0, length = _keys.length; i < length; i++) {
          key = _keys[i];
          if (predicate(obj[key], key, obj))
            return key;
        }
      }
      ;
      function createPredicateIndexFinder(dir) {
        return function(array, predicate, context) {
          predicate = cb(predicate, context);
          var length = _getLength(array);
          var index2 = dir > 0 ? 0 : length - 1;
          for (; index2 >= 0 && index2 < length; index2 += dir) {
            if (predicate(array[index2], index2, array))
              return index2;
          }
          return -1;
        };
      }
      ;
      const findIndex = createPredicateIndexFinder(1);
      ;
      const findLastIndex = createPredicateIndexFinder(-1);
      ;
      function sortedIndex(array, obj, iteratee2, context) {
        iteratee2 = cb(iteratee2, context, 1);
        var value = iteratee2(obj);
        var low = 0, high = _getLength(array);
        while (low < high) {
          var mid = Math.floor((low + high) / 2);
          if (iteratee2(array[mid]) < value)
            low = mid + 1;
          else
            high = mid;
        }
        return low;
      }
      ;
      function createIndexFinder(dir, predicateFind, sortedIndex2) {
        return function(array, item, idx) {
          var i = 0, length = _getLength(array);
          if (typeof idx == "number") {
            if (dir > 0) {
              i = idx >= 0 ? idx : Math.max(idx + length, i);
            } else {
              length = idx >= 0 ? Math.min(idx + 1, length) : idx + length + 1;
            }
          } else if (sortedIndex2 && idx && length) {
            idx = sortedIndex2(array, item);
            return array[idx] === item ? idx : -1;
          }
          if (item !== item) {
            idx = predicateFind(slice.call(array, i, length), isNaN_isNaN);
            return idx >= 0 ? idx + i : -1;
          }
          for (idx = dir > 0 ? i : length - 1; idx >= 0 && idx < length; idx += dir) {
            if (array[idx] === item)
              return idx;
          }
          return -1;
        };
      }
      ;
      const indexOf = createIndexFinder(1, findIndex, sortedIndex);
      ;
      const lastIndexOf = createIndexFinder(-1, findLastIndex);
      ;
      function find(obj, predicate, context) {
        var keyFinder = _isArrayLike(obj) ? findIndex : findKey;
        var key = keyFinder(obj, predicate, context);
        if (key !== void 0 && key !== -1)
          return obj[key];
      }
      ;
      function findWhere(obj, attrs) {
        return find(obj, matcher(attrs));
      }
      ;
      function each(obj, iteratee2, context) {
        iteratee2 = optimizeCb(iteratee2, context);
        var i, length;
        if (_isArrayLike(obj)) {
          for (i = 0, length = obj.length; i < length; i++) {
            iteratee2(obj[i], i, obj);
          }
        } else {
          var _keys = keys(obj);
          for (i = 0, length = _keys.length; i < length; i++) {
            iteratee2(obj[_keys[i]], _keys[i], obj);
          }
        }
        return obj;
      }
      ;
      function map(obj, iteratee2, context) {
        iteratee2 = cb(iteratee2, context);
        var _keys = !_isArrayLike(obj) && keys(obj), length = (_keys || obj).length, results = Array(length);
        for (var index2 = 0; index2 < length; index2++) {
          var currentKey = _keys ? _keys[index2] : index2;
          results[index2] = iteratee2(obj[currentKey], currentKey, obj);
        }
        return results;
      }
      ;
      function createReduce(dir) {
        var reducer = function(obj, iteratee2, memo, initial2) {
          var _keys = !_isArrayLike(obj) && keys(obj), length = (_keys || obj).length, index2 = dir > 0 ? 0 : length - 1;
          if (!initial2) {
            memo = obj[_keys ? _keys[index2] : index2];
            index2 += dir;
          }
          for (; index2 >= 0 && index2 < length; index2 += dir) {
            var currentKey = _keys ? _keys[index2] : index2;
            memo = iteratee2(memo, obj[currentKey], currentKey, obj);
          }
          return memo;
        };
        return function(obj, iteratee2, memo, context) {
          var initial2 = arguments.length >= 3;
          return reducer(obj, optimizeCb(iteratee2, context, 4), memo, initial2);
        };
      }
      ;
      const reduce = createReduce(1);
      ;
      const reduceRight = createReduce(-1);
      ;
      function filter2(obj, predicate, context) {
        var results = [];
        predicate = cb(predicate, context);
        each(obj, function(value, index2, list) {
          if (predicate(value, index2, list))
            results.push(value);
        });
        return results;
      }
      ;
      function reject2(obj, predicate, context) {
        return filter2(obj, negate(cb(predicate)), context);
      }
      ;
      function every(obj, predicate, context) {
        predicate = cb(predicate, context);
        var _keys = !_isArrayLike(obj) && keys(obj), length = (_keys || obj).length;
        for (var index2 = 0; index2 < length; index2++) {
          var currentKey = _keys ? _keys[index2] : index2;
          if (!predicate(obj[currentKey], currentKey, obj))
            return false;
        }
        return true;
      }
      ;
      function some(obj, predicate, context) {
        predicate = cb(predicate, context);
        var _keys = !_isArrayLike(obj) && keys(obj), length = (_keys || obj).length;
        for (var index2 = 0; index2 < length; index2++) {
          var currentKey = _keys ? _keys[index2] : index2;
          if (predicate(obj[currentKey], currentKey, obj))
            return true;
        }
        return false;
      }
      ;
      function contains(obj, item, fromIndex, guard) {
        if (!_isArrayLike(obj))
          obj = values(obj);
        if (typeof fromIndex != "number" || guard)
          fromIndex = 0;
        return indexOf(obj, item, fromIndex) >= 0;
      }
      ;
      const invoke = restArguments(function(obj, path, args) {
        var contextPath, func;
        if (modules_isFunction(path)) {
          func = path;
        } else {
          path = _toPath_toPath(path);
          contextPath = path.slice(0, -1);
          path = path[path.length - 1];
        }
        return map(obj, function(context) {
          var method = func;
          if (!method) {
            if (contextPath && contextPath.length) {
              context = deepGet(context, contextPath);
            }
            if (context == null)
              return void 0;
            method = context[path];
          }
          return method == null ? method : method.apply(context, args);
        });
      });
      ;
      function pluck(obj, key) {
        return map(obj, property(key));
      }
      ;
      function where(obj, attrs) {
        return filter2(obj, matcher(attrs));
      }
      ;
      function max(obj, iteratee2, context) {
        var result2 = -Infinity, lastComputed = -Infinity, value, computed;
        if (iteratee2 == null || typeof iteratee2 == "number" && typeof obj[0] != "object" && obj != null) {
          obj = _isArrayLike(obj) ? obj : values(obj);
          for (var i = 0, length = obj.length; i < length; i++) {
            value = obj[i];
            if (value != null && value > result2) {
              result2 = value;
            }
          }
        } else {
          iteratee2 = cb(iteratee2, context);
          each(obj, function(v, index2, list) {
            computed = iteratee2(v, index2, list);
            if (computed > lastComputed || computed === -Infinity && result2 === -Infinity) {
              result2 = v;
              lastComputed = computed;
            }
          });
        }
        return result2;
      }
      ;
      function min(obj, iteratee2, context) {
        var result2 = Infinity, lastComputed = Infinity, value, computed;
        if (iteratee2 == null || typeof iteratee2 == "number" && typeof obj[0] != "object" && obj != null) {
          obj = _isArrayLike(obj) ? obj : values(obj);
          for (var i = 0, length = obj.length; i < length; i++) {
            value = obj[i];
            if (value != null && value < result2) {
              result2 = value;
            }
          }
        } else {
          iteratee2 = cb(iteratee2, context);
          each(obj, function(v, index2, list) {
            computed = iteratee2(v, index2, list);
            if (computed < lastComputed || computed === Infinity && result2 === Infinity) {
              result2 = v;
              lastComputed = computed;
            }
          });
        }
        return result2;
      }
      ;
      function sample(obj, n, guard) {
        if (n == null || guard) {
          if (!_isArrayLike(obj))
            obj = values(obj);
          return obj[random(obj.length - 1)];
        }
        var sample2 = _isArrayLike(obj) ? clone(obj) : values(obj);
        var length = _getLength(sample2);
        n = Math.max(Math.min(n, length), 0);
        var last2 = length - 1;
        for (var index2 = 0; index2 < n; index2++) {
          var rand = random(index2, last2);
          var temp = sample2[index2];
          sample2[index2] = sample2[rand];
          sample2[rand] = temp;
        }
        return sample2.slice(0, n);
      }
      ;
      function shuffle(obj) {
        return sample(obj, Infinity);
      }
      ;
      function sortBy(obj, iteratee2, context) {
        var index2 = 0;
        iteratee2 = cb(iteratee2, context);
        return pluck(map(obj, function(value, key, list) {
          return {
            value,
            index: index2++,
            criteria: iteratee2(value, key, list)
          };
        }).sort(function(left, right) {
          var a = left.criteria;
          var b = right.criteria;
          if (a !== b) {
            if (a > b || a === void 0)
              return 1;
            if (a < b || b === void 0)
              return -1;
          }
          return left.index - right.index;
        }), "value");
      }
      ;
      function group(behavior, partition2) {
        return function(obj, iteratee2, context) {
          var result2 = partition2 ? [[], []] : {};
          iteratee2 = cb(iteratee2, context);
          each(obj, function(value, index2) {
            var key = iteratee2(value, index2, obj);
            behavior(result2, value, key);
          });
          return result2;
        };
      }
      ;
      const groupBy = group(function(result2, value, key) {
        if (has(result2, key))
          result2[key].push(value);
        else
          result2[key] = [value];
      });
      ;
      const indexBy = group(function(result2, value, key) {
        result2[key] = value;
      });
      ;
      const countBy = group(function(result2, value, key) {
        if (has(result2, key))
          result2[key]++;
        else
          result2[key] = 1;
      });
      ;
      const partition = group(function(result2, value, pass) {
        result2[pass ? 0 : 1].push(value);
      }, true);
      ;
      var reStrSymbol = /[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;
      function toArray(obj) {
        if (!obj)
          return [];
        if (isArray2(obj))
          return slice.call(obj);
        if (isString(obj)) {
          return obj.match(reStrSymbol);
        }
        if (_isArrayLike(obj))
          return map(obj, identity);
        return values(obj);
      }
      ;
      function size(obj) {
        if (obj == null)
          return 0;
        return _isArrayLike(obj) ? obj.length : keys(obj).length;
      }
      ;
      function keyInObj(value, key, obj) {
        return key in obj;
      }
      ;
      const pick = restArguments(function(obj, keys2) {
        var result2 = {}, iteratee2 = keys2[0];
        if (obj == null)
          return result2;
        if (modules_isFunction(iteratee2)) {
          if (keys2.length > 1)
            iteratee2 = optimizeCb(iteratee2, keys2[1]);
          keys2 = allKeys(obj);
        } else {
          iteratee2 = keyInObj;
          keys2 = flatten(keys2, false, false);
          obj = Object(obj);
        }
        for (var i = 0, length = keys2.length; i < length; i++) {
          var key = keys2[i];
          var value = obj[key];
          if (iteratee2(value, key, obj))
            result2[key] = value;
        }
        return result2;
      });
      ;
      const omit = restArguments(function(obj, keys2) {
        var iteratee2 = keys2[0], context;
        if (modules_isFunction(iteratee2)) {
          iteratee2 = negate(iteratee2);
          if (keys2.length > 1)
            context = keys2[1];
        } else {
          keys2 = map(flatten(keys2, false, false), String);
          iteratee2 = function(value, key) {
            return !contains(keys2, key);
          };
        }
        return pick(obj, iteratee2, context);
      });
      ;
      function initial(array, n, guard) {
        return slice.call(array, 0, Math.max(0, array.length - (n == null || guard ? 1 : n)));
      }
      ;
      function first(array, n, guard) {
        if (array == null || array.length < 1)
          return n == null || guard ? void 0 : [];
        if (n == null || guard)
          return array[0];
        return initial(array, array.length - n);
      }
      ;
      function rest(array, n, guard) {
        return slice.call(array, n == null || guard ? 1 : n);
      }
      ;
      function last(array, n, guard) {
        if (array == null || array.length < 1)
          return n == null || guard ? void 0 : [];
        if (n == null || guard)
          return array[array.length - 1];
        return rest(array, Math.max(0, array.length - n));
      }
      ;
      function compact(array) {
        return filter2(array, Boolean);
      }
      ;
      function flatten_flatten(array, depth) {
        return flatten(array, depth, false);
      }
      ;
      const difference = restArguments(function(array, rest2) {
        rest2 = flatten(rest2, true, true);
        return filter2(array, function(value) {
          return !contains(rest2, value);
        });
      });
      ;
      const without = restArguments(function(array, otherArrays) {
        return difference(array, otherArrays);
      });
      ;
      function uniq(array, isSorted, iteratee2, context) {
        if (!isBoolean(isSorted)) {
          context = iteratee2;
          iteratee2 = isSorted;
          isSorted = false;
        }
        if (iteratee2 != null)
          iteratee2 = cb(iteratee2, context);
        var result2 = [];
        var seen = [];
        for (var i = 0, length = _getLength(array); i < length; i++) {
          var value = array[i], computed = iteratee2 ? iteratee2(value, i, array) : value;
          if (isSorted && !iteratee2) {
            if (!i || seen !== computed)
              result2.push(value);
            seen = computed;
          } else if (iteratee2) {
            if (!contains(seen, computed)) {
              seen.push(computed);
              result2.push(value);
            }
          } else if (!contains(result2, value)) {
            result2.push(value);
          }
        }
        return result2;
      }
      ;
      const union = restArguments(function(arrays) {
        return uniq(flatten(arrays, true, true));
      });
      ;
      function intersection(array) {
        var result2 = [];
        var argsLength = arguments.length;
        for (var i = 0, length = _getLength(array); i < length; i++) {
          var item = array[i];
          if (contains(result2, item))
            continue;
          var j;
          for (j = 1; j < argsLength; j++) {
            if (!contains(arguments[j], item))
              break;
          }
          if (j === argsLength)
            result2.push(item);
        }
        return result2;
      }
      ;
      function unzip(array) {
        var length = array && max(array, _getLength).length || 0;
        var result2 = Array(length);
        for (var index2 = 0; index2 < length; index2++) {
          result2[index2] = pluck(array, index2);
        }
        return result2;
      }
      ;
      const zip = restArguments(unzip);
      ;
      function object(list, values2) {
        var result2 = {};
        for (var i = 0, length = _getLength(list); i < length; i++) {
          if (values2) {
            result2[list[i]] = values2[i];
          } else {
            result2[list[i][0]] = list[i][1];
          }
        }
        return result2;
      }
      ;
      function range(start, stop, step) {
        if (stop == null) {
          stop = start || 0;
          start = 0;
        }
        if (!step) {
          step = stop < start ? -1 : 1;
        }
        var length = Math.max(Math.ceil((stop - start) / step), 0);
        var range2 = Array(length);
        for (var idx = 0; idx < length; idx++, start += step) {
          range2[idx] = start;
        }
        return range2;
      }
      ;
      function chunk(array, count) {
        if (count == null || count < 1)
          return [];
        var result2 = [];
        var i = 0, length = array.length;
        while (i < length) {
          result2.push(slice.call(array, i, i += count));
        }
        return result2;
      }
      ;
      function chainResult(instance, obj) {
        return instance._chain ? _(obj).chain() : obj;
      }
      ;
      function mixin(obj) {
        each(functions(obj), function(name) {
          var func = _[name] = obj[name];
          _.prototype[name] = function() {
            var args = [this._wrapped];
            push.apply(args, arguments);
            return chainResult(this, func.apply(_, args));
          };
        });
        return _;
      }
      ;
      each(["pop", "push", "reverse", "shift", "sort", "splice", "unshift"], function(name) {
        var method = ArrayProto[name];
        _.prototype[name] = function() {
          var obj = this._wrapped;
          if (obj != null) {
            method.apply(obj, arguments);
            if ((name === "shift" || name === "splice") && obj.length === 0) {
              delete obj[0];
            }
          }
          return chainResult(this, obj);
        };
      });
      each(["concat", "join", "slice"], function(name) {
        var method = ArrayProto[name];
        _.prototype[name] = function() {
          var obj = this._wrapped;
          if (obj != null)
            obj = method.apply(obj, arguments);
          return chainResult(this, obj);
        };
      });
      const underscore_array_methods = _;
      ;
      ;
      var index_default_ = mixin(modules_namespaceObject);
      index_default_._ = index_default_;
      const index_default = index_default_;
      ;
    }
  )
  /******/
};
var __webpack_module_cache__ = {};
function __webpack_require__(moduleId) {
  var cachedModule = __webpack_module_cache__[moduleId];
  if (cachedModule !== void 0) {
    return cachedModule.exports;
  }
  var module = __webpack_module_cache__[moduleId] = {
    /******/
    // no module.id needed
    /******/
    // no module.loaded needed
    /******/
    exports: {}
    /******/
  };
  __webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);
  return module.exports;
}
(() => {
  __webpack_require__.n = (module) => {
    var getter = module && module.__esModule ? (
      /******/
      () => module["default"]
    ) : (
      /******/
      () => module
    );
    __webpack_require__.d(getter, { a: getter });
    return getter;
  };
})();
(() => {
  __webpack_require__.d = (exports, definition) => {
    for (var key in definition) {
      if (__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
        Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
      }
    }
  };
})();
(() => {
  __webpack_require__.g = function() {
    if (typeof globalThis === "object")
      return globalThis;
    try {
      return this || new Function("return this")();
    } catch (e) {
      if (typeof window === "object")
        return window;
    }
  }();
})();
(() => {
  __webpack_require__.o = (obj, prop) => Object.prototype.hasOwnProperty.call(obj, prop);
})();
(() => {
  __webpack_require__.r = (exports) => {
    if (typeof Symbol !== "undefined" && Symbol.toStringTag) {
      Object.defineProperty(exports, Symbol.toStringTag, { value: "Module" });
    }
    Object.defineProperty(exports, "__esModule", { value: true });
  };
})();
var __webpack_exports__ = {};
__webpack_require__.d(__webpack_exports__, {
  Ay: () => (
    /* binding */
    src_0
  ),
  I0: () => (
    /* binding */
    grapesjs
  ),
  nu: () => (
    /* binding */
    usePlugin
  )
});
var index_all = __webpack_require__(523);
var mixins = __webpack_require__(342);
function html(literals) {
  var substs = [];
  for (var _i = 1; _i < arguments.length; _i++) {
    substs[_i - 1] = arguments[_i];
  }
  var raw = literals.raw;
  return raw.reduce(function(acc, lit, i) {
    var subst = substs[i - 1];
    var last = raw[i - 1];
    if (Array.isArray(subst)) {
      subst = subst.join("");
    } else if (last && last.slice(-1) === "$") {
      acc = acc.slice(0, -1);
    } else {
      subst = (0, mixins.escape)(subst);
    }
    return acc + subst + lit;
  });
}
var config = {
  stylePrefix: "gjs-",
  components: "",
  style: "",
  fromElement: false,
  projectData: void 0,
  noticeOnUnload: true,
  showOffsets: false,
  showOffsetsSelected: false,
  forceClass: true,
  height: "900px",
  width: "100%",
  log: ["warning", "error"],
  baseCss: "",
  protectedCss: "* { box-sizing: border-box; } body {margin: 0;}",
  canvasCss: "",
  defaultCommand: "select-comp",
  showToolbar: true,
  showDevices: true,
  devicePreviewMode: false,
  mediaCondition: "max-width",
  tagVarStart: "{[ ",
  tagVarEnd: " ]}",
  keepEmptyTextNodes: false,
  jsInHtml: true,
  nativeDnD: true,
  multipleSelection: true,
  optsHtml: {},
  optsCss: {},
  avoidInlineStyle: true,
  avoidDefaults: true,
  clearStyles: false,
  listenToEl: [],
  cssIcons: "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css",
  icons: {
    /* eslint-disable max-len */
    close: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>',
    move: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,6V11H18V7.75L22.25,12L18,16.25V13H13V18H16.25L12,22.25L7.75,18H11V13H6V16.25L1.75,12L6,7.75V11H11V6H7.75L12,1.75L16.25,6H13Z"/></svg>',
    plus: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>',
    caret: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7,10L12,15L17,10H7Z" /></svg>',
    delete: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>',
    copy: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>',
    arrowUp: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13,20H11V8L5.5,13.5L4.08,12.08L12,4.16L19.92,12.08L18.5,13.5L13,8V20Z" /></svg>',
    chevron: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" /></svg>',
    eye: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" /></svg>',
    eyeOff: '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.74,7.13 11.35,7 12,7Z" /></svg>'
    /* eslint-enable max-len */
  },
  i18n: {},
  undoManager: {},
  assetManager: {},
  canvas: {},
  layerManager: {},
  storageManager: {},
  richTextEditor: {},
  domComponents: {},
  modal: {},
  codeManager: {},
  panels: {},
  commands: {},
  cssComposer: {},
  selectorManager: {},
  deviceManager: {},
  styleManager: {},
  blockManager: {},
  traitManager: {},
  textViewCode: "Code",
  keepUnusedStyles: false,
  customUI: false
};
var config_config = config;
var backbone = __webpack_require__(391);
var backbone_default = __webpack_require__.n(backbone);
var cash_dom = __webpack_require__(694);
var extender = function(_a2) {
  var $ = _a2.$;
  if ($ && $.prototype && $.prototype.constructor.name !== "jQuery") {
    var fn = $.fn;
    fn.hide = function() {
      return this.css("display", "none");
    };
    fn.show = function() {
      return this.css("display", "block");
    };
    fn.focus = function() {
      var el = this.get(0);
      el && el.focus();
      return this;
    };
    fn.bind = function(ev, h) {
      return this.on(ev, h);
    };
    fn.unbind = function(ev, h) {
      if ((0, index_all.isObject)(ev)) {
        for (var name_1 in ev) {
          ev.hasOwnProperty(name_1) && this.off(name_1, ev[name_1]);
        }
        return this;
      } else {
        return this.off(ev, h);
      }
    };
    fn.click = function(h) {
      return h ? this.on("click", h) : this.trigger("click");
    };
    fn.change = function(h) {
      return h ? this.on("change", h) : this.trigger("change");
    };
    fn.keydown = function(h) {
      return h ? this.on("keydown", h) : this.trigger("keydown");
    };
    fn.delegate = function(selector, events2, data, handler) {
      if (!handler) {
        handler = data;
      }
      return this.on(events2, selector, function(e) {
        e.data = data;
        handler(e);
      });
    };
    fn.scrollLeft = function() {
      var el = this.get(0);
      el = el.nodeType == 9 ? el.defaultView : el;
      var win = el instanceof Window ? el : null;
      return win ? win.pageXOffset : el.scrollLeft || 0;
    };
    fn.scrollTop = function() {
      var el = this.get(0);
      el = el.nodeType == 9 ? el.defaultView : el;
      var win = el instanceof Window ? el : null;
      return win ? win.pageYOffset : el.scrollTop || 0;
    };
    var offset_1 = $.prototype.offset;
    fn.offset = function(coords) {
      var top, left;
      if (coords) {
        top = coords.top;
        left = coords.left;
      }
      if (typeof top != "undefined") {
        this.css("top", "".concat(top, "px"));
      }
      if (typeof left != "undefined") {
        this.css("left", "".concat(left, "px"));
      }
      return offset_1.call(this);
    };
    $.map = function(items, clb) {
      var ar = [];
      for (var i = 0; i < items.length; i++) {
        ar.push(clb(items[i], i));
      }
      return ar;
    };
    var indexOf_1 = Array.prototype.indexOf;
    $.inArray = function(val, arr, i) {
      return arr == null ? -1 : indexOf_1.call(arr, val, i);
    };
    $.Event = function(src2, props) {
      if (!(this instanceof $.Event)) {
        return new $.Event(src2, props);
      }
      this.type = src2;
      this.isDefaultPrevented = function() {
        return false;
      };
    };
  }
};
var common = __webpack_require__(268);
var __extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Selectable = (
  /** @class */
  function(_super) {
    __extends(Selectable2, _super);
    function Selectable2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return Selectable2;
  }(common.Kx)
);
var Selected = (
  /** @class */
  function(_super) {
    __extends(Selected2, _super);
    function Selected2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Selected2.prototype.getByComponent = function(component) {
      var _this = this;
      return this.filter(function(s) {
        return _this.getComponent(s) === component;
      })[0];
    };
    Selected2.prototype.addComponent = function(component, opts) {
      var _this = this;
      var toAdd = ((0, index_all.isArray)(component) ? component : [component]).filter(function(c) {
        return !_this.hasComponent(c);
      }).map(function(component2) {
        return new Selectable({ component: component2 });
      })[0];
      return this.push(toAdd, opts);
    };
    Selected2.prototype.getComponent = function(model) {
      return model.get("component");
    };
    Selected2.prototype.hasComponent = function(component) {
      var model = this.getByComponent(component);
      return model && this.contains(model);
    };
    Selected2.prototype.lastComponent = function() {
      var last = this.last();
      return last ? this.getComponent(last) : void 0;
    };
    Selected2.prototype.allComponents = function() {
      var _this = this;
      return this.map(function(s) {
        return _this.getComponent(s);
      }).filter(function(i) {
        return i;
      });
    };
    Selected2.prototype.removeComponent = function(component, opts) {
      var _this = this;
      var toRemove = ((0, index_all.isArray)(component) ? component : [component]).map(function(c) {
        return _this.getByComponent(c);
      });
      return this.remove(toRemove, opts);
    };
    return Selected2;
  }(common.pM)
);
var model_Selected = Selected;
var Module_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var __assign = function() {
  __assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return __assign.apply(this, arguments);
};
var __spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var Module = (
  /** @class */
  function() {
    function Module2(em, moduleName, defaults) {
      this.debounced = [];
      this.collections = [];
      this.cls = [];
      this._em = em;
      this._name = moduleName;
      var name = this.name.charAt(0).toLowerCase() + this.name.slice(1);
      var cfgParent = !(0, index_all.isUndefined)(em.config[name]) ? em.config[name] : em.config[this.name];
      var cfg = cfgParent === true ? {} : cfgParent || {};
      cfg.pStylePrefix = em.config.pStylePrefix || "";
      if (!(0, index_all.isUndefined)(cfgParent) && !cfgParent) {
        cfg._disable = 1;
      }
      cfg.em = em;
      this._config = (0, mixins.deepMerge)(defaults || {}, cfg);
    }
    Object.defineProperty(Module2.prototype, "em", {
      get: function() {
        return this._em;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Module2.prototype, "config", {
      get: function() {
        return this._config;
      },
      enumerable: false,
      configurable: true
    });
    Module2.prototype.render = function(opts) {
    };
    Module2.prototype.postLoad = function(key) {
    };
    Object.defineProperty(Module2.prototype, "name", {
      get: function() {
        return this._name;
      },
      enumerable: false,
      configurable: true
    });
    Module2.prototype.getConfig = function(name) {
      return name ? this.config[name] : this.config;
    };
    Module2.prototype.__logWarn = function(str, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.em.logWarning("[".concat(this.name, "]: ").concat(str), opts);
    };
    Module2.prototype.destroy = function() {
      this.__destroy();
    };
    Module2.prototype.__destroy = function() {
      var _a2, _b, _c;
      (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.remove();
      (_b = this.state) === null || _b === void 0 ? void 0 : _b.stopListening();
      (_c = this.state) === null || _c === void 0 ? void 0 : _c.clear();
      this.debounced.forEach(function(d) {
        return d.cancel();
      });
      this.collections.forEach(function(c) {
        c.stopListening();
        c.reset();
      });
    };
    Module2.prototype.__appendTo = function() {
      var elTo = this.getConfig().appendTo;
      if (elTo) {
        var el = (0, index_all.isElement)(elTo) ? elTo : document.querySelector(elTo);
        if (!el)
          return this.__logWarn('"appendTo" element not found');
        el.appendChild(this.render());
      }
    };
    return Module2;
  }()
);
var abstract_Module = Module;
var ItemManagerModule = (
  /** @class */
  function(_super) {
    Module_extends(ItemManagerModule2, _super);
    function ItemManagerModule2(em, moduleName, all, events2, defaults, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, em, moduleName, defaults) || this;
      _this.cls = [];
      _this.private = false;
      _this.all = all;
      _this.events = events2;
      !opts.skipListen && _this.__initListen();
      return _this;
    }
    ItemManagerModule2.prototype.postLoad = function(key) {
    };
    ItemManagerModule2.prototype.render = function(opts) {
    };
    ItemManagerModule2.prototype.getProjectData = function(data) {
      var obj = {};
      var key = this.storageKey;
      if (key) {
        obj[key] = data || this.getAll();
      }
      return obj;
    };
    ItemManagerModule2.prototype.loadProjectData = function(data, param) {
      if (data === void 0) {
        data = {};
      }
      if (param === void 0) {
        param = {};
      }
      var all = param.all, onResult = param.onResult, reset = param.reset;
      var key = this.storageKey;
      var opts = { action: "load" };
      var coll = all || this.all;
      var result = data[key];
      if (typeof result == "string") {
        try {
          result = JSON.parse(result);
        } catch (err) {
          this.__logWarn("Data parsing failed", { input: result });
        }
      }
      reset && result && coll.reset(void 0, opts);
      if (onResult) {
        result && onResult(result, opts);
      } else if (result && (0, mixins.isDef)(result.length)) {
        coll.reset(result, opts);
      }
      return result;
    };
    ItemManagerModule2.prototype.clear = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var all = this.all;
      all && all.reset(void 0, opts);
      return this;
    };
    ItemManagerModule2.prototype.getAll = function() {
      return __spreadArray([], this.all.models, true);
    };
    ItemManagerModule2.prototype.getAllMap = function() {
      return this.getAll().reduce(function(acc, i) {
        acc[i.get(i.idAttribute)] = i;
        return acc;
      }, {});
    };
    ItemManagerModule2.prototype.__initListen = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, all = _a2.all, em = _a2.em, events2 = _a2.events;
      all && em && all.on("add", function(m, c, o) {
        return em.trigger(events2.add, m, o);
      }).on("remove", function(m, c, o) {
        return em.trigger(events2.remove, m, o);
      }).on("change", function(p, c) {
        return em.trigger(events2.update, p, p.changedAttributes(), c);
      }).on("all", this.__catchAllEvent, this);
      this.cls = [all].concat(opts.collections || []);
      (opts.propagate || []).forEach(function(_a3) {
        var entity = _a3.entity, event = _a3.event;
        entity.on("all", function(ev, model, coll, opts2) {
          var options = opts2 || coll;
          var opt = __assign({ event: ev }, options);
          [em, all].map(function(md) {
            return md.trigger(event, model, opt);
          });
        });
      });
    };
    ItemManagerModule2.prototype.__remove = function(model, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var md = (0, index_all.isString)(model) ? this.get(model) : model;
      var rm = function() {
        md && _this.all.remove(md, opts);
        return md;
      };
      !opts.silent && (em === null || em === void 0 ? void 0 : em.trigger(this.events.removeBefore, md, rm, opts));
      return !opts.abort && rm();
    };
    ItemManagerModule2.prototype.__catchAllEvent = function(event, model, coll, opts) {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      var options = opts || coll;
      em && events2.all && em.trigger(events2.all, { event, model, options });
      this.__onAllEvent();
    };
    ItemManagerModule2.prototype.__appendTo = function(renderProps) {
      var elTo = this.config.appendTo;
      if (elTo) {
        var el = (0, index_all.isElement)(elTo) ? elTo : document.querySelector(elTo);
        if (!el)
          return this.__logWarn('"appendTo" element not found');
        el.appendChild(this.render(renderProps));
      }
    };
    ItemManagerModule2.prototype.__onAllEvent = function() {
    };
    ItemManagerModule2.prototype._createId = function(len) {
      if (len === void 0) {
        len = 16;
      }
      var all = this.getAll();
      var ln = all.length + len;
      var allMap = this.getAllMap();
      var id;
      do {
        id = (0, mixins.createId)(ln);
      } while (allMap[id]);
      return id;
    };
    ItemManagerModule2.prototype.__listenAdd = function(model, event) {
      var _this = this;
      model.on("add", function(m, c, o) {
        return _this.em.trigger(event, m, o);
      });
    };
    ItemManagerModule2.prototype.__listenRemove = function(model, event) {
      var _this = this;
      model.on("remove", function(m, c, o) {
        return _this.em.trigger(event, m, o);
      });
    };
    ItemManagerModule2.prototype.__listenUpdate = function(model, event) {
      var _this = this;
      model.on("change", function(p, c) {
        return _this.em.trigger(event, p, p.changedAttributes(), c);
      });
    };
    ItemManagerModule2.prototype.__destroy = function() {
      var _a2;
      this.cls.forEach(function(coll) {
        coll.stopListening();
        coll.reset();
      });
      (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.view = void 0;
    };
    return ItemManagerModule2;
  }(Module)
);
var config_config_config = {
  stylePrefix: "cv-",
  scripts: [],
  styles: [],
  customBadgeLabel: void 0,
  autoscrollLimit: 50,
  extHl: false,
  frameContent: "<!DOCTYPE html>",
  frameStyle: "\n    body { background-color: #fff }\n    * ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1) }\n    * ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2) }\n    * ::-webkit-scrollbar { width: 10px }\n  ",
  notTextable: ["button", "a", "input[type=checkbox]", "input[type=radio]"],
  allowExternalDrop: true
};
var canvas_config_config = config_config_config;
var ModuleModel = __webpack_require__(578);
var device_manager_config_config_config = {
  default: "",
  devices: [
    {
      id: "desktop",
      name: "Desktop",
      width: ""
    },
    {
      id: "tablet",
      name: "Tablet",
      width: "770px",
      widthMedia: "992px"
    },
    {
      id: "mobileLandscape",
      name: "Mobile landscape",
      width: "568px",
      widthMedia: "768px"
    },
    {
      id: "mobilePortrait",
      name: "Mobile portrait",
      width: "320px",
      widthMedia: "480px"
    }
  ]
};
var device_manager_config_config = device_manager_config_config_config;
var Device_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Device = (
  /** @class */
  function(_super) {
    Device_extends(Device2, _super);
    function Device2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Device2.prototype.defaults = function() {
      return {
        name: "",
        width: null,
        height: "",
        widthMedia: null,
        priority: null
      };
    };
    Device2.prototype.initialize = function() {
      var _this = this;
      this.get("widthMedia") === null && this.set("widthMedia", this.get("width"));
      this.get("width") === null && this.set("width", this.get("widthMedia"));
      !this.get("priority") && this.set("priority", parseFloat(this.get("widthMedia")) || 0);
      var toCheck = ["width", "height", "widthMedia"];
      toCheck.forEach(function(prop) {
        return _this.checkUnit(prop);
      });
    };
    Device2.prototype.checkUnit = function(prop) {
      var pr = this.get(prop) || "";
      var noUnit = (parseFloat(pr) || 0).toString() === pr.toString();
      noUnit && this.set(prop, "".concat(pr, "px"));
    };
    Device2.prototype.getName = function() {
      return this.get("name") || this.get("id");
    };
    Device2.prototype.getWidthMedia = function() {
      return this.get("widthMedia") || "";
    };
    return Device2;
  }(common.Kx)
);
var model_Device = Device;
var Devices_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Devices = (
  /** @class */
  function(_super) {
    Devices_extends(Devices2, _super);
    function Devices2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return Devices2;
  }(common.pM)
);
var model_Devices = Devices;
Devices.prototype.model = model_Device;
var DevicesView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var __makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var DevicesView = (
  /** @class */
  function(_super) {
    DevicesView_extends(DevicesView2, _super);
    function DevicesView2(o) {
      var _this = _super.call(this, o) || this;
      _this.config = o.config || {};
      _this.em = _this.config.em;
      _this.ppfx = _this.config.pStylePrefix || "";
      _this.listenTo(_this.em, "change:device", _this.updateSelect);
      return _this;
    }
    DevicesView2.prototype.template = function(_a2) {
      var ppfx = _a2.ppfx, label = _a2.label;
      return html(templateObject_1 || (templateObject_1 = __makeTemplateObject(['\n      <div class="', 'device-label">', '</div>\n      <div class="', "field ", 'select">\n        <span id="', 'input-holder">\n          <select class="', 'devices"></select>\n        </span>\n        <div class="', 'sel-arrow">\n          <div class="', 'd-s-arrow"></div>\n        </div>\n      </div>\n      <button style="display:none" class="', 'add-trasp" data-add-trasp>+</button>\n    '], ['\n      <div class="', 'device-label">', '</div>\n      <div class="', "field ", 'select">\n        <span id="', 'input-holder">\n          <select class="', 'devices"></select>\n        </span>\n        <div class="', 'sel-arrow">\n          <div class="', 'd-s-arrow"></div>\n        </div>\n      </div>\n      <button style="display:none" class="', 'add-trasp" data-add-trasp>+</button>\n    '])), ppfx, label, ppfx, ppfx, ppfx, ppfx, ppfx, ppfx, ppfx);
    };
    DevicesView2.prototype.events = function() {
      return {
        change: "updateDevice",
        "click [data-add-trasp]": "startAdd"
      };
    };
    DevicesView2.prototype.startAdd = function() {
    };
    DevicesView2.prototype.updateDevice = function() {
      var em = this.em;
      if (em) {
        var devEl = this.devicesEl;
        em.set("device", devEl ? devEl.val() : "");
      }
    };
    DevicesView2.prototype.updateSelect = function() {
      var _a2 = this, em = _a2.em, devicesEl = _a2.devicesEl;
      if (em && em.getDeviceModel && devicesEl) {
        var device = em.getDeviceModel();
        devicesEl.val(device ? device.get("id") : "");
      }
    };
    DevicesView2.prototype.getOptions = function() {
      var _a2 = this, collection = _a2.collection, em = _a2.em;
      var result = "";
      collection.forEach(function(device) {
        var _a3 = device.attributes, name = _a3.name, id = _a3.id;
        var label = em && em.t && em.t("deviceManager.devices.".concat(id)) || name;
        result += '<option value="'.concat(id || name, '">').concat(label, "</option>");
      });
      return result;
    };
    DevicesView2.prototype.render = function() {
      var _a2 = this, em = _a2.em, ppfx = _a2.ppfx, $el = _a2.$el, el = _a2.el;
      var label = em && em.t && em.t("deviceManager.device");
      $el.html(this.template({ ppfx, label }));
      this.devicesEl = $el.find(".".concat(ppfx, "devices"));
      this.devicesEl.append(this.getOptions());
      this.devicesEl.val(em.get("device"));
      el.className = "".concat(ppfx, "devices-c");
      return this;
    };
    return DevicesView2;
  }(common.Ss)
);
var view_DevicesView = DevicesView;
var templateObject_1;
var device_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var device_manager_assign = function() {
  device_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return device_manager_assign.apply(this, arguments);
};
var evAll = "device";
var evPfx = "".concat(evAll, ":");
var evSelect = "".concat(evPfx, "select");
var evSelectBefore = "".concat(evSelect, ":before");
var evUpdate = "".concat(evPfx, "update");
var evAdd = "".concat(evPfx, "add");
var evAddBefore = "".concat(evAdd, ":before");
var evRemove = "".concat(evPfx, "remove");
var evRemoveBefore = "".concat(evRemove, ":before");
var chnSel = "change:device";
var deviceEvents = {
  all: evAll,
  select: evSelect,
  update: evUpdate,
  add: evAdd,
  remove: evRemove,
  removeBefore: evRemoveBefore
};
var DeviceManager = (
  /** @class */
  function(_super) {
    device_manager_extends(DeviceManager2, _super);
    function DeviceManager2(em) {
      var _a2;
      var _this = _super.call(this, em, "DeviceManager", new model_Devices(), deviceEvents, device_manager_config_config) || this;
      _this.Device = model_Device;
      _this.Devices = model_Devices;
      _this.storageKey = "";
      _this.devices = _this.all;
      (_a2 = _this.config.devices) === null || _a2 === void 0 ? void 0 : _a2.forEach(function(device) {
        return _this.add(device, { silent: true });
      });
      _this.select(_this.config.default || _this.devices.at(0));
      em.on(chnSel, _this._onSelect, _this);
      return _this;
    }
    DeviceManager2.prototype._onSelect = function(m, deviceId, opts) {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      var prevId = m.previous("device");
      var newDevice = this.get(deviceId);
      var ev = events2.select;
      em.trigger(ev, newDevice, this.get(prevId));
      this.__catchAllEvent(ev, newDevice, opts);
    };
    DeviceManager2.prototype.add = function(props, options) {
      if (options === void 0) {
        options = {};
      }
      var result;
      var opts = options;
      if ((0, index_all.isString)(props)) {
        var width = options;
        opts = arguments[2] || {};
        result = device_manager_assign(device_manager_assign({}, opts), { id: props, name: opts.name || props, width });
      } else {
        result = props;
      }
      if (!result.id) {
        result.id = result.name || this._createId();
      }
      return this.devices.add(result, opts);
    };
    DeviceManager2.prototype.get = function(id) {
      var byName = this.getAll().filter(function(d) {
        return d.get("name") === id;
      })[0];
      return byName || this.devices.get(id) || null;
    };
    DeviceManager2.prototype.remove = function(device, opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this.__remove(device, opts);
    };
    DeviceManager2.prototype.getDevices = function() {
      return this.devices.models;
    };
    DeviceManager2.prototype.select = function(device, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var md = (0, index_all.isString)(device) ? this.get(device) : device;
      md && this.em.set("device", md.get("id"), opts);
      return this;
    };
    DeviceManager2.prototype.getSelected = function() {
      return this.get(this.em.get("device"));
    };
    DeviceManager2.prototype.getAll = function() {
      return this.devices;
    };
    DeviceManager2.prototype.render = function() {
      var _a2;
      var em = this.em;
      (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.view = new view_DevicesView({
        collection: this.devices,
        config: device_manager_assign({ em }, this.config)
      });
      return this.view.render().el;
    };
    DeviceManager2.prototype.destroy = function() {
      this.__destroy();
    };
    return DeviceManager2;
  }(ItemManagerModule)
);
var device_manager = DeviceManager;
var PagesEvents;
(function(PagesEvents2) {
  PagesEvents2["add"] = "page:add";
  PagesEvents2["addBefore"] = "page:add:before";
  PagesEvents2["remove"] = "page:remove";
  PagesEvents2["removeBefore"] = "page:remove:before";
  PagesEvents2["select"] = "page:select";
  PagesEvents2["selectBefore"] = "page:select:before";
  PagesEvents2["update"] = "page:update";
  PagesEvents2["all"] = "page";
})(PagesEvents || (PagesEvents = {}));
var types = PagesEvents;
var ModuleCollection_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModuleCollection = (
  /** @class */
  function(_super) {
    ModuleCollection_extends(ModuleCollection2, _super);
    function ModuleCollection2(module, models, modelConstructor) {
      return _super.call(this, models, { module, modelConstructor }) || this;
    }
    ModuleCollection2.prototype.add = function(model, options) {
      var _this = this;
      var _a2;
      var models = (0, index_all.isArray)(model) ? model : !(0, index_all.isUndefined)(model) ? [model] : void 0;
      models = (_a2 = models === null || models === void 0 ? void 0 : models.map(function(m) {
        return m instanceof _this.newModel ? m : new _this.newModel(_this.module, m);
      })) !== null && _a2 !== void 0 ? _a2 : [void 0];
      return _super.prototype.add.call(this, (0, index_all.isArray)(model) ? models : models[0], options);
    };
    ModuleCollection2.prototype.preinitialize = function(models, options) {
      this.newModel = options.modelConstructor;
      this.module = options.module;
    };
    return ModuleCollection2;
  }(common.pM)
);
var abstract_ModuleCollection = ModuleCollection;
var Frame_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Frame_assign = function() {
  Frame_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Frame_assign.apply(this, arguments);
};
var Frame_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var keyAutoW = "__aw";
var keyAutoH = "__ah";
var getDimension = function(frame, type2) {
  var _a2;
  var dim = frame.get(type2);
  var viewDim = (_a2 = frame.view) === null || _a2 === void 0 ? void 0 : _a2.el[type2 === "width" ? "offsetWidth" : "offsetHeight"];
  if ((0, index_all.isNumber)(dim)) {
    return dim;
  } else if ((0, index_all.isString)(dim) && dim.endsWith("px")) {
    return parseFloat(dim);
  } else if (viewDim) {
    return viewDim;
  } else {
    return 0;
  }
};
var Frame = (
  /** @class */
  function(_super) {
    Frame_extends(Frame2, _super);
    function Frame2(module, attr) {
      var _this = _super.call(this, module, attr) || this;
      var em = _this.em;
      var _a2 = _this.attributes, styles = _a2.styles, component = _a2.component;
      var domc = em.Components;
      var conf = domc.getConfig();
      var allRules = em.Css.getAll();
      var idMap = {};
      var modOpts = { em, config: conf, frame: _this, idMap };
      if (!(0, mixins.isComponent)(component)) {
        var wrp = (0, mixins.isObject)(component) ? component : { components: component };
        !wrp.type && (wrp.type = "wrapper");
        var Wrapper = domc.getType("wrapper").model;
        _this.set("component", new Wrapper(wrp, modOpts));
      }
      if (!styles) {
        _this.set("styles", allRules);
      } else if (!(0, mixins.isObject)(styles)) {
        var newStyles = styles;
        if ((0, index_all.keys)(idMap).length) {
          newStyles = (0, index_all.isString)(newStyles) ? em.Parser.parseCss(newStyles) : newStyles;
          em.Css.checkId(newStyles, { idMap });
        }
        allRules.add(newStyles);
        _this.set("styles", allRules);
      }
      !attr.width && _this.set(keyAutoW, 1);
      !attr.height && _this.set(keyAutoH, 1);
      !_this.id && _this.set("id", (0, mixins.createId)());
      return _this;
    }
    Frame2.prototype.defaults = function() {
      return {
        x: 0,
        y: 0,
        changesCount: 0,
        attributes: {},
        width: null,
        height: null,
        head: [],
        component: "",
        styles: "",
        refFrame: null,
        _undo: true,
        _undoexc: ["changesCount"]
      };
    };
    Object.defineProperty(Frame2.prototype, "width", {
      get: function() {
        return getDimension(this, "width");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Frame2.prototype, "height", {
      get: function() {
        return getDimension(this, "height");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Frame2.prototype, "head", {
      get: function() {
        return this.get("head");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Frame2.prototype, "refFrame", {
      get: function() {
        return this.get("refFrame");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Frame2.prototype, "root", {
      get: function() {
        var refFrame = this.refFrame;
        return (refFrame === null || refFrame === void 0 ? void 0 : refFrame.getComponent()) || this.getComponent();
      },
      enumerable: false,
      configurable: true
    });
    Frame2.prototype.initRefs = function() {
      var refFrame = this.refFrame;
      if ((0, index_all.isString)(refFrame)) {
        var frame = this.module.framesById[refFrame];
        frame && this.set({ refFrame: frame }, { silent: true });
      }
    };
    Frame2.prototype.getBoxRect = function() {
      var _a2 = this.attributes, x = _a2.x, y = _a2.y;
      var _b = this, width = _b.width, height = _b.height;
      return {
        x,
        y,
        width,
        height
      };
    };
    Frame2.prototype.onRemove = function() {
      !this.refFrame && this.getComponent().remove({ root: 1 });
    };
    Frame2.prototype.changesUp = function(opt) {
      if (opt === void 0) {
        opt = {};
      }
      if (opt.temporary || opt.noCount || opt.avoidStore) {
        return;
      }
      this.set("changesCount", this.get("changesCount") + 1);
    };
    Frame2.prototype.getComponent = function() {
      return this.get("component");
    };
    Frame2.prototype.getStyles = function() {
      return this.get("styles");
    };
    Frame2.prototype.disable = function() {
      this.trigger("disable");
    };
    Frame2.prototype.remove = function() {
      var _a2;
      (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.view = void 0;
      var coll = this.collection;
      return coll && coll.remove(this);
    };
    Frame2.prototype.getHead = function() {
      return Frame_spreadArray([], this.head, true);
    };
    Frame2.prototype.setHead = function(value) {
      return this.set("head", Frame_spreadArray([], value, true));
    };
    Frame2.prototype.addHeadItem = function(item) {
      this.head.push(item);
    };
    Frame2.prototype.getHeadByAttr = function(attr, value, tag) {
      return this.head.filter(function(item) {
        return item.attributes && item.attributes[attr] == value && (!tag || tag === item.tag);
      })[0];
    };
    Frame2.prototype.removeHeadByAttr = function(attr, value, tag) {
      var item = this.getHeadByAttr(attr, value, tag);
      var index2 = this.head.indexOf(item);
      if (index2 >= 0) {
        this.head.splice(index2, 1);
      }
    };
    Frame2.prototype.addLink = function(href) {
      var tag = "link";
      !this.getHeadByAttr("href", href, tag) && this.addHeadItem({
        tag,
        attributes: {
          href,
          rel: "stylesheet"
        }
      });
    };
    Frame2.prototype.removeLink = function(href) {
      this.removeHeadByAttr("href", href, "link");
    };
    Frame2.prototype.addScript = function(src2) {
      var tag = "script";
      !this.getHeadByAttr("src", src2, tag) && this.addHeadItem({
        tag,
        attributes: { src: src2 }
      });
    };
    Frame2.prototype.removeScript = function(src2) {
      this.removeHeadByAttr("src", src2, "script");
    };
    Frame2.prototype.getPage = function() {
      var _a2;
      return (_a2 = this.collection) === null || _a2 === void 0 ? void 0 : _a2.page;
    };
    Frame2.prototype._emitUpdated = function(data) {
      if (data === void 0) {
        data = {};
      }
      this.em.trigger("frame:updated", Frame_assign({ frame: this }, data));
    };
    Frame2.prototype.hasAutoHeight = function() {
      var height = this.attributes.height;
      if (height === "auto" || this.config.infiniteCanvas) {
        return true;
      }
      return false;
    };
    Frame2.prototype.toJSON = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var obj = ModuleModel.A.prototype.toJSON.call(this, opts);
      var defaults = (0, index_all.result)(this, "defaults");
      if (opts.fromUndo)
        delete obj.component;
      delete obj.styles;
      delete obj.changesCount;
      obj[keyAutoW] && delete obj.width;
      obj[keyAutoH] && delete obj.height;
      if (obj.refFrame) {
        obj.refFrame = obj.refFrame.id;
        delete obj.component;
      }
      (0, index_all.forEach)(obj, function(value, key) {
        key.indexOf("_") === 0 && delete obj[key];
      });
      (0, index_all.forEach)(defaults, function(value, key) {
        if (obj[key] === value)
          delete obj[key];
      });
      (0, index_all.forEach)(["attributes", "head"], function(prop) {
        if ((0, index_all.isEmpty)(obj[prop]))
          delete obj[prop];
      });
      return obj;
    };
    return Frame2;
  }(ModuleModel.A)
);
var model_Frame = Frame;
var Frames_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Frames = (
  /** @class */
  function(_super) {
    Frames_extends(Frames2, _super);
    function Frames2(module, models) {
      if (models === void 0) {
        models = [];
      }
      var _this = _super.call(this, module, models, model_Frame) || this;
      _this.loadedItems = 0;
      _this.itemsToLoad = 0;
      (0, index_all.bindAll)(_this, "itemLoaded");
      _this.on("add", _this.onAdd);
      _this.on("reset", _this.onReset);
      _this.on("remove", _this.onRemove);
      _this.forEach(function(frame) {
        return _this.onAdd(frame);
      });
      return _this;
    }
    Frames2.prototype.onAdd = function(frame) {
      this.module.framesById[frame.id] = frame;
    };
    Frames2.prototype.onReset = function(m, opts) {
      var _this = this;
      var prev = (opts === null || opts === void 0 ? void 0 : opts.previousModels) || [];
      prev.map(function(p) {
        return _this.onRemove(p);
      });
    };
    Frames2.prototype.onRemove = function(frame) {
      frame.onRemove();
      delete this.module.framesById[frame.id];
    };
    Frames2.prototype.initRefs = function() {
      this.forEach(function(frame) {
        return frame.initRefs();
      });
    };
    Frames2.prototype.itemLoaded = function() {
      this.loadedItems++;
      if (this.loadedItems >= this.itemsToLoad) {
        this.trigger("loaded:all");
        this.listenToLoadItems(false);
      }
    };
    Frames2.prototype.listenToLoad = function() {
      this.loadedItems = 0;
      this.itemsToLoad = this.length;
      this.listenToLoadItems(true);
    };
    Frames2.prototype.listenToLoadItems = function(on) {
      var _this = this;
      this.forEach(function(item) {
        return item[on ? "on" : "off"]("loaded", _this.itemLoaded);
      });
    };
    return Frames2;
  }(abstract_ModuleCollection)
);
var model_Frames = Frames;
var Canvas_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Canvas = (
  /** @class */
  function(_super) {
    Canvas_extends(Canvas2, _super);
    function Canvas2(module) {
      var _this = this;
      var em = module.em, config2 = module.config;
      var scripts = config2.scripts, styles = config2.styles;
      _this = _super.call(this, module, { scripts, styles }) || this;
      _this.set("frames", new model_Frames(module));
      _this.on("change:zoom", _this.onZoomChange);
      _this.on("change:x change:y", _this.onCoordsChange);
      _this.on("change:pointer change:pointerScreen", _this.onPointerChange);
      _this.listenTo(em, "change:device ".concat(evUpdate), _this.updateDevice);
      _this.listenTo(em, types.select, _this._pageUpdated);
      return _this;
    }
    Canvas2.prototype.defaults = function() {
      return {
        frame: "",
        frames: [],
        rulers: false,
        zoom: 100,
        x: 0,
        y: 0,
        // Scripts to apply on all frames
        scripts: [],
        // Styles to apply on all frames
        styles: [],
        pointer: common.lK,
        pointerScreen: common.lK
      };
    };
    Object.defineProperty(Canvas2.prototype, "frames", {
      get: function() {
        return this.get("frames");
      },
      enumerable: false,
      configurable: true
    });
    Canvas2.prototype.init = function() {
      var em = this.em;
      var mainPage = em.Pages._initPage();
      this.set("frames", mainPage.getFrames());
      this.updateDevice({ frame: mainPage.getMainFrame() });
    };
    Canvas2.prototype._pageUpdated = function(page, prev) {
      var em = this.em;
      em.setSelected();
      em.get("readyCanvas") && em.stopDefault();
      prev === null || prev === void 0 ? void 0 : prev.getFrames().map(function(frame) {
        return frame.disable();
      });
      this.set("frames", page.getFrames());
      this.updateDevice({ frame: page.getMainFrame() });
    };
    Canvas2.prototype.updateDevice = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var device = em.getDeviceModel();
      var model = opts.frame || em.getCurrentFrameModel();
      if (model && device) {
        var _a2 = device.attributes, width = _a2.width, height = _a2.height;
        model.set({ width, height }, { noUndo: 1 });
      }
    };
    Canvas2.prototype.onZoomChange = function() {
      var _a2 = this, em = _a2.em, module = _a2.module;
      var zoom = this.get("zoom");
      zoom < 1 && this.set("zoom", 1);
      em.trigger(module.events.zoom);
    };
    Canvas2.prototype.onCoordsChange = function() {
      var _a2 = this, em = _a2.em, module = _a2.module;
      em.trigger(module.events.coords);
    };
    Canvas2.prototype.onPointerChange = function() {
      var _a2 = this, em = _a2.em, module = _a2.module;
      em.trigger(module.events.pointer);
    };
    Canvas2.prototype.getPointerCoords = function(type2) {
      if (type2 === void 0) {
        type2 = common.x2.World;
      }
      var _a2 = this.attributes, pointer = _a2.pointer, pointerScreen = _a2.pointerScreen;
      return type2 === common.x2.World ? pointer : pointerScreen;
    };
    return Canvas2;
  }(ModuleModel.A)
);
var model_Canvas = Canvas;
var CanvasSpot = __webpack_require__(683);
var dom_components_types = __webpack_require__(249);
var CanvasSpots_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CanvasSpots = (
  /** @class */
  function(_super) {
    CanvasSpots_extends(CanvasSpots2, _super);
    function CanvasSpots2(module, models) {
      if (models === void 0) {
        models = [];
      }
      var _this = _super.call(this, module, models, CanvasSpot.A) || this;
      _this.on("add", _this.onAdd);
      _this.on("change", _this.onChange);
      _this.on("remove", _this.onRemove);
      var em = _this.em;
      _this.refreshDbn = (0, index_all.debounce)(function() {
        return _this.refresh();
      }, 0);
      var evToRefreshDbn = "component:resize styleable:change component:input ".concat(dom_components_types.I.update, " frame:updated undo redo");
      _this.listenTo(em, evToRefreshDbn, function() {
        return _this.refreshDbn();
      });
      return _this;
    }
    Object.defineProperty(CanvasSpots2.prototype, "em", {
      get: function() {
        return this.module.em;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(CanvasSpots2.prototype, "events", {
      get: function() {
        return this.module.events;
      },
      enumerable: false,
      configurable: true
    });
    CanvasSpots2.prototype.refresh = function() {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      em.trigger(events2.spot);
    };
    CanvasSpots2.prototype.onAdd = function(spot) {
      this.__trgEvent(this.events.spotAdd, { spot });
    };
    CanvasSpots2.prototype.onChange = function(spot) {
      this.__trgEvent(this.events.spotUpdate, { spot });
    };
    CanvasSpots2.prototype.onRemove = function(spot) {
      this.__trgEvent(this.events.spotRemove, { spot });
    };
    CanvasSpots2.prototype.__trgEvent = function(event, props) {
      var module = this.module;
      var em = module.em;
      em.trigger(event, props);
      this.refreshDbn();
    };
    return CanvasSpots2;
  }(abstract_ModuleCollection)
);
var model_CanvasSpots = CanvasSpots;
var CanvasEvents;
(function(CanvasEvents2) {
  CanvasEvents2["dragEnter"] = "canvas:dragenter";
  CanvasEvents2["dragOver"] = "canvas:dragover";
  CanvasEvents2["dragEnd"] = "canvas:dragend";
  CanvasEvents2["dragData"] = "canvas:dragdata";
  CanvasEvents2["drop"] = "canvas:drop";
  CanvasEvents2["spot"] = "canvas:spot";
  CanvasEvents2["spotAdd"] = "canvas:spot:add";
  CanvasEvents2["spotUpdate"] = "canvas:spot:update";
  CanvasEvents2["spotRemove"] = "canvas:spot:remove";
  CanvasEvents2["coords"] = "canvas:coords";
  CanvasEvents2["zoom"] = "canvas:zoom";
  CanvasEvents2["pointer"] = "canvas:pointer";
  CanvasEvents2["refresh"] = "canvas:refresh";
  CanvasEvents2["frameLoad"] = "canvas:frame:load";
  CanvasEvents2["frameLoadHead"] = "canvas:frame:load:head";
  CanvasEvents2["frameLoadBody"] = "canvas:frame:load:body";
})(CanvasEvents || (CanvasEvents = {}));
var canvas_types = CanvasEvents;
var ModuleView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModuleView = (
  /** @class */
  function(_super) {
    ModuleView_extends(ModuleView2, _super);
    function ModuleView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ModuleView2.prototype, "pfx", {
      get: function() {
        return this.ppfx + this.config.stylePrefix || "";
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ModuleView2.prototype, "ppfx", {
      get: function() {
        return this.em.config.stylePrefix || "";
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ModuleView2.prototype, "module", {
      get: function() {
        var _a2, _b;
        return (_b = (_a2 = this.model) === null || _a2 === void 0 ? void 0 : _a2.module) !== null && _b !== void 0 ? _b : this.collection.module;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ModuleView2.prototype, "em", {
      get: function() {
        return this.module.em;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ModuleView2.prototype, "config", {
      get: function() {
        return this.module.config;
      },
      enumerable: false,
      configurable: true
    });
    ModuleView2.prototype.preinitialize = function(options) {
      this.className = "";
    };
    return ModuleView2;
  }(common.Ss)
);
var abstract_ModuleView = ModuleView;
var dom = __webpack_require__(926);
var ModuleDomainViews_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModuleDomainViews = (
  /** @class */
  function(_super) {
    ModuleDomainViews_extends(ModuleDomainViews2, _super);
    function ModuleDomainViews2(opts, autoAdd) {
      if (opts === void 0) {
        opts = {};
      }
      if (autoAdd === void 0) {
        autoAdd = false;
      }
      var _this = _super.call(this, opts) || this;
      _this.itemsView = "";
      _this.itemType = "type";
      _this.reuseView = false;
      _this.viewCollection = [];
      autoAdd && _this.listenTo(_this.collection, "add", _this.addTo);
      return _this;
    }
    ModuleDomainViews2.prototype.addTo = function(model) {
      this.add(model);
    };
    ModuleDomainViews2.prototype.itemViewNotFound = function(type2) {
    };
    ModuleDomainViews2.prototype.add = function(model, fragment) {
      var _a2 = this, reuseView = _a2.reuseView, viewCollection = _a2.viewCollection;
      var frag = fragment || null;
      var typeField = model.get(this.itemType);
      var view;
      if (model.view && reuseView) {
        view = model.view;
      } else {
        view = this.renderView(model, typeField);
      }
      viewCollection.push(view);
      var rendered = view.render().el;
      if (frag)
        frag.appendChild(rendered);
      else
        this.$el.append(rendered);
    };
    ModuleDomainViews2.prototype.render = function() {
      var _this = this;
      var frag = document.createDocumentFragment();
      this.clearItems();
      this.$el.empty();
      if (this.collection.length)
        this.collection.each(function(model) {
          return _this.add(model, frag);
        });
      this.$el.append(frag);
      this.onRender();
      return this;
    };
    ModuleDomainViews2.prototype.onRender = function() {
    };
    ModuleDomainViews2.prototype.onRemoveBefore = function(items, opts) {
    };
    ModuleDomainViews2.prototype.onRemove = function(items, opts) {
    };
    ModuleDomainViews2.prototype.remove = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var viewCollection = this.viewCollection;
      this.onRemoveBefore(viewCollection, opts);
      this.clearItems();
      common.Ss.prototype.remove.apply(this, opts);
      this.onRemove(viewCollection, opts);
      return this;
    };
    ModuleDomainViews2.prototype.clearItems = function() {
      var items = this.viewCollection || [];
    };
    return ModuleDomainViews2;
  }(abstract_ModuleView)
);
var abstract_ModuleDomainViews = ModuleDomainViews;
var CssRuleView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CssRuleView = (
  /** @class */
  function(_super) {
    CssRuleView_extends(CssRuleView2, _super);
    function CssRuleView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      _this.config = o.config || {};
      var model = _this.model;
      _this.listenTo(model, "change", _this.render);
      _this.listenTo(model, "destroy remove", _this.remove);
      _this.listenTo(model.get("selectors"), "change", _this.render);
      return _this;
    }
    CssRuleView2.prototype.tagName = function() {
      return "style";
    };
    CssRuleView2.prototype.render = function() {
      var _a2 = this, model = _a2.model, el = _a2.el;
      var important = model.get("important");
      el.innerHTML = model.toCSS({ important });
      return this;
    };
    return CssRuleView2;
  }(common.Ss)
);
var view_CssRuleView = CssRuleView;
var CssGroupRuleView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CssGroupRuleView = (
  /** @class */
  function(_super) {
    CssGroupRuleView_extends(CssGroupRuleView2, _super);
    function CssGroupRuleView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    CssGroupRuleView2.prototype._createElement = function() {
      return document.createTextNode("");
    };
    CssGroupRuleView2.prototype.render = function() {
      var model = this.model;
      var important = model.get("important");
      this.el.textContent = model.getDeclaration({ important });
      return this;
    };
    return CssGroupRuleView2;
  }(view_CssRuleView)
);
var view_CssGroupRuleView = CssGroupRuleView;
var CssRulesView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var getBlockId = function(pfx, order) {
  return "".concat(pfx).concat(order ? "-".concat(parseFloat(order)) : "");
};
var CssRulesView = (
  /** @class */
  function(_super) {
    CssRulesView_extends(CssRulesView2, _super);
    function CssRulesView2(o) {
      var _this = _super.call(this, o) || this;
      (0, index_all.bindAll)(_this, "sortRules");
      var config2 = o.config || {};
      _this.atRules = {};
      _this.config = config2;
      _this.em = config2.em;
      _this.pfx = config2.stylePrefix || "";
      _this.className = _this.pfx + "rules";
      var coll = _this.collection;
      _this.listenTo(coll, "add", _this.addTo);
      _this.listenTo(coll, "reset", _this.render);
      return _this;
    }
    CssRulesView2.prototype.addTo = function(model) {
      this.addToCollection(model);
    };
    CssRulesView2.prototype.addToCollection = function(model, fragmentEl) {
      if (!this.renderStarted) {
        return;
      }
      var fragment = fragmentEl || null;
      var config2 = this.config;
      var opts = { model, config: config2 };
      var rendered, view;
      if (model.get("atRuleType") === "keyframes") {
        var atRule = model.getAtRule();
        var atRuleEl = this.atRules[atRule];
        if (!atRuleEl) {
          var styleEl = document.createElement("style");
          atRuleEl = document.createTextNode("");
          styleEl.appendChild(document.createTextNode("".concat(atRule, "{")));
          styleEl.appendChild(atRuleEl);
          styleEl.appendChild(document.createTextNode("}"));
          this.atRules[atRule] = atRuleEl;
          rendered = styleEl;
        }
        view = new view_CssGroupRuleView(opts);
        atRuleEl.appendData(view.render().el.textContent);
      } else {
        view = new view_CssRuleView(opts);
        rendered = view.render().el;
      }
      var clsName = this.className;
      var mediaText = model.get("mediaText");
      var defaultBlockId = getBlockId(clsName);
      var blockId = defaultBlockId;
      if (mediaText) {
        blockId = getBlockId(clsName, this.getMediaWidth(mediaText));
      }
      if (rendered) {
        var container = fragment || this.el;
        var contRules = void 0;
        try {
          contRules = container.querySelector("#".concat(blockId));
        } catch (e) {
        }
        if (!contRules) {
          contRules = container.querySelector("#".concat(defaultBlockId));
        }
        contRules === null || contRules === void 0 ? void 0 : contRules.appendChild(rendered);
      }
      return rendered;
    };
    CssRulesView2.prototype.getMediaWidth = function(mediaText) {
      return mediaText && mediaText.replace("(".concat(this.em.getConfig().mediaCondition, ": "), "").replace(")", "");
    };
    CssRulesView2.prototype.sortRules = function(a, b) {
      var em = this.em;
      var isMobFirst = (em.getConfig().mediaCondition || "").indexOf("min-width") !== -1;
      if (!isMobFirst)
        return 0;
      var left = isMobFirst ? a : b;
      var right = isMobFirst ? b : a;
      return left - right;
    };
    CssRulesView2.prototype.render = function() {
      var _this = this;
      this.renderStarted = true;
      this.atRules = {};
      var _a2 = this, em = _a2.em, $el = _a2.$el, collection = _a2.collection;
      var cls = this.className;
      var frag = document.createDocumentFragment();
      $el.empty();
      var prs = em.Devices.getAll().pluck("priority").sort(this.sortRules);
      prs.every(function(pr) {
        return pr;
      }) && prs.unshift(0);
      prs.forEach(function(pr) {
        return frag.appendChild((0, dom.a_)("div", { id: getBlockId(cls, pr) }));
      });
      collection.each(function(model) {
        return _this.addToCollection(model, frag);
      });
      $el.append(frag);
      $el.attr("class", cls);
      return this;
    };
    return CssRulesView2;
  }(common.Ss)
);
var view_CssRulesView = CssRulesView;
var htmlType = "text/html";
var defaultType = htmlType;
var BrowserParserHtml = function(str, config2) {
  if (config2 === void 0) {
    config2 = {};
  }
  var parser2 = new DOMParser();
  var mimeType = config2.htmlType || defaultType;
  var toHTML = mimeType === htmlType;
  var strF = toHTML ? str : "<div>".concat(str, "</div>");
  var doc = parser2.parseFromString(strF, mimeType);
  var res;
  if (toHTML) {
    if (config2.asDocument)
      return doc;
    var head = doc.head, body_1 = doc.body;
    var scripts = head.querySelectorAll("script");
    (0, index_all.each)(scripts, function(node) {
      return body_1.appendChild(node);
    });
    var hEls_1 = [];
    (0, index_all.each)(head.children, function(n) {
      return hEls_1.push(n);
    });
    (0, index_all.each)(hEls_1, function(node, i) {
      return body_1.insertBefore(node, body_1.children[i]);
    });
    res = body_1;
  } else {
    res = doc.firstChild;
  }
  return res;
};
var ParserHtml_assign = function() {
  ParserHtml_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ParserHtml_assign.apply(this, arguments);
};
var modelAttrStart = "data-gjs-";
var ParserHtml_event = "parse:html";
var ParserHtml = function(em, config2) {
  if (config2 === void 0) {
    config2 = {};
  }
  return {
    compTypes: [],
    modelAttrStart,
    getPropAttribute: function(attrName, attrValue) {
      var name = attrName.replace(this.modelAttrStart, "");
      var valueLen = (attrValue === null || attrValue === void 0 ? void 0 : attrValue.length) || 0;
      var firstChar = attrValue === null || attrValue === void 0 ? void 0 : attrValue.substring(0, 1);
      var lastChar = attrValue === null || attrValue === void 0 ? void 0 : attrValue.substring(valueLen - 1);
      var value = attrValue === "true" ? true : attrValue === "false" ? false : attrValue;
      try {
        value = firstChar == "{" && lastChar == "}" || firstChar == "[" && lastChar == "]" ? JSON.parse(value) : value;
      } catch (e) {
      }
      return {
        name,
        value
      };
    },
    /**
     * Extract component props from an attribute object
     * @param {Object} attr
     * @returns {Object} An object containing props and attributes without them
     */
    splitPropsFromAttr: function(attr) {
      var _this = this;
      if (attr === void 0) {
        attr = {};
      }
      var props = {};
      var attrs = {};
      (0, index_all.each)(attr, function(value, key) {
        if (key.indexOf(_this.modelAttrStart) === 0) {
          var propsResult = _this.getPropAttribute(key, value);
          props[propsResult.name] = propsResult.value;
        } else {
          attrs[key] = value;
        }
      });
      return {
        props,
        attrs
      };
    },
    /**
     * Parse style string to object
     * @param {string} str
     * @return {Object}
     * @example
     * var stl = ParserHtml.parseStyle('color:black; width:100px; test:value;');
     * console.log(stl);
     * // {color: 'black', width: '100px', test: 'value'}
     */
    parseStyle: function(str) {
      var result = {};
      while (str.indexOf("/*") >= 0) {
        var start = str.indexOf("/*");
        var end = str.indexOf("*/") + 2;
        str = str.replace(str.slice(start, end), "");
      }
      var decls = str.split(";");
      for (var i = 0, len = decls.length; i < len; i++) {
        var decl = decls[i].trim();
        if (!decl)
          continue;
        var prop = decl.split(":");
        var key = prop[0].trim();
        var value = prop.slice(1).join(":").trim();
        if (result[key]) {
          if (!(0, index_all.isArray)(result[key])) {
            result[key] = [result[key]];
          }
          result[key].push(value);
        } else {
          result[key] = value;
        }
      }
      return result;
    },
    /**
     * Parse class string to array
     * @param {string} str
     * @return {Array<string>}
     * @example
     * var res = ParserHtml.parseClass('test1 test2 test3');
     * console.log(res);
     * // ['test1', 'test2', 'test3']
     */
    parseClass: function(str) {
      var result = [];
      var cls = str.split(" ");
      for (var i = 0, len = cls.length; i < len; i++) {
        var cl = cls[i].trim();
        if (!cl)
          continue;
        result.push(cl);
      }
      return result;
    },
    parseNodeAttr: function(node, result) {
      var model = result || {};
      var attrs = node.attributes || [];
      var attrsLen = attrs.length;
      for (var i = 0; i < attrsLen; i++) {
        var nodeName = attrs[i].nodeName;
        var nodeValue = attrs[i].nodeValue;
        if (nodeName == "style") {
          model.style = this.parseStyle(nodeValue);
        } else if (nodeName == "class") {
          model.classes = this.parseClass(nodeValue);
        } else if (nodeName == "contenteditable") {
          continue;
        } else if (nodeName.indexOf(this.modelAttrStart) === 0) {
          var propsResult = this.getPropAttribute(nodeName, nodeValue);
          model[propsResult.name] = propsResult.value;
        } else {
          if (nodeValue === "" && node[nodeName] === true) {
            nodeValue = true;
          }
          if (!model.attributes) {
            model.attributes = {};
          }
          model.attributes[nodeName] = nodeValue;
        }
      }
      return model;
    },
    detectNode: function(node, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var compTypes = this.compTypes;
      var result = {};
      if (compTypes) {
        var type2 = (_a2 = node.getAttribute) === null || _a2 === void 0 ? void 0 : _a2.call(node, "".concat(this.modelAttrStart, "type"));
        if (type2) {
          result = { type: type2 };
        } else {
          for (var i = 0; i < compTypes.length; i++) {
            var compType = compTypes[i];
            var obj = compType.model.isComponent(node, opts);
            if (obj) {
              if (typeof obj !== "object") {
                obj = { type: compType.id };
              }
              result = obj;
              break;
            }
          }
        }
      }
      return result;
    },
    parseNode: function(node, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var nodes = ((_a2 = node.content) === null || _a2 === void 0 ? void 0 : _a2.childNodes) || node.childNodes;
      var nodesLen = nodes.length;
      var model = this.detectNode(node, opts);
      if (!model.tagName) {
        var tag = node.tagName || "";
        var ns = node.namespaceURI || "";
        model.tagName = tag && ns === "http://www.w3.org/1999/xhtml" ? tag.toLowerCase() : tag;
      }
      model = this.parseNodeAttr(node, model);
      if (!nodesLen && "".concat(node.outerHTML).slice(-2) === "/>") {
        model.void = true;
      }
      if (nodesLen && !model.components && !opts.skipChildren) {
        var firstChild = nodes[0];
        if (nodesLen === 1 && firstChild.nodeType === 3) {
          !model.type && (model.type = "text");
          model.components = {
            type: "textnode",
            content: firstChild.nodeValue
          };
        } else {
          model.components = this.parseNodes(node, ParserHtml_assign(ParserHtml_assign({}, opts), { inSvg: opts.inSvg || model.type === "svg" }));
        }
      }
      var comps = model.components;
      if (!model.type && (comps === null || comps === void 0 ? void 0 : comps.length)) {
        var _b = config2.textTypes, textTypes = _b === void 0 ? [] : _b, _c = config2.textTags, textTags = _c === void 0 ? [] : _c;
        var allTxt = true;
        var foundTextNode = false;
        for (var i = 0; i < comps.length; i++) {
          var comp = comps[i];
          var cType = comp.type;
          if (!textTypes.includes(cType) && !textTags.includes(comp.tagName)) {
            allTxt = false;
            break;
          }
          if (cType === "textnode") {
            foundTextNode = true;
          }
        }
        if (allTxt && foundTextNode) {
          model.type = "text";
        }
      }
      return model;
    },
    /**
     * Get data from the node element
     * @param  {HTMLElement} el DOM element to traverse
     * @return {Array<Object>}
     */
    parseNodes: function(el, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var result = [];
      var nodes = ((_a2 = el.content) === null || _a2 === void 0 ? void 0 : _a2.childNodes) || el.childNodes;
      var nodesLen = nodes.length;
      for (var i = 0; i < nodesLen; i++) {
        var node = nodes[i];
        var nodePrev = result[result.length - 1];
        var model = this.parseNode(node, opts);
        if (model.type === "textnode") {
          if ((nodePrev === null || nodePrev === void 0 ? void 0 : nodePrev.type) === "textnode") {
            nodePrev.content += model.content;
            continue;
          }
          if (!opts.keepEmptyTextNodes) {
            var content = node.nodeValue || "";
            var isFirstOrLast = i === 0 || i === nodesLen - 1;
            var hasNewLive = content.includes("\n");
            if (content != " " && !content.trim() && (isFirstOrLast || hasNewLive)) {
              continue;
            }
          }
        }
        if (!model.tagName && (0, index_all.isUndefined)(model.content)) {
          continue;
        }
        result.push(model);
      }
      return result;
    },
    /**
     * Parse HTML string to a desired model object
     * @param  {string} str HTML string
     * @param  {ParserCss} parserCss In case there is style tags inside HTML
     * @return {Object}
     */
    parse: function(str, parserCss, opts) {
      var _a2, _b, _c;
      if (opts === void 0) {
        opts = {};
      }
      var conf = (em === null || em === void 0 ? void 0 : em.get("Config")) || {};
      var res = { html: [] };
      var cf = ParserHtml_assign(ParserHtml_assign({}, config2), opts);
      var options = ParserHtml_assign(ParserHtml_assign(ParserHtml_assign({}, config2.optionsHtml), {
        // @ts-ignore Support previous `configParser.htmlType` option
        htmlType: ((_a2 = config2.optionsHtml) === null || _a2 === void 0 ? void 0 : _a2.htmlType) || config2.htmlType
      }), opts);
      var preParser = options.preParser, asDocument = options.asDocument;
      var input = (0, index_all.isFunction)(preParser) ? preParser(str, { editor: em === null || em === void 0 ? void 0 : em.getEditor() }) : str;
      var parseRes = (0, index_all.isFunction)(cf.parserHtml) ? cf.parserHtml(input, options) : BrowserParserHtml(input, options);
      var root = parseRes;
      var docEl = parseRes;
      if (asDocument) {
        root = docEl.documentElement;
        res.doctype = (0, dom.LJ)(docEl.doctype);
      }
      var scripts = root.querySelectorAll("script");
      var i = scripts.length;
      var allowScripts = !(0, index_all.isUndefined)(conf.allowScripts) ? conf.allowScripts : options.allowScripts;
      if (!allowScripts) {
        while (i--)
          (_b = scripts[i].parentNode) === null || _b === void 0 ? void 0 : _b.removeChild(scripts[i]);
      }
      if (!options.allowUnsafeAttr || !options.allowUnsafeAttrValue) {
        this.__sanitizeNode(root, options);
      }
      if (parserCss) {
        var styles = root.querySelectorAll("style");
        var j = styles.length;
        var styleStr = "";
        while (j--) {
          styleStr = styles[j].innerHTML + styleStr;
          (_c = styles[j].parentNode) === null || _c === void 0 ? void 0 : _c.removeChild(styles[j]);
        }
        if (styleStr)
          res.css = parserCss.parse(styleStr);
      }
      em === null || em === void 0 ? void 0 : em.trigger("".concat(ParserHtml_event, ":root"), { input, root });
      var resHtml = [];
      if (asDocument) {
        res.head = this.parseNode(docEl.head, cf);
        res.root = this.parseNodeAttr(root);
        resHtml = this.parseNode(docEl.body, cf);
      } else {
        var result = this.parseNodes(root, cf);
        resHtml = result.length === 1 && !cf.returnArray ? result[0] : result;
      }
      res.html = resHtml;
      em === null || em === void 0 ? void 0 : em.trigger(ParserHtml_event, { input, output: res });
      return res;
    },
    __sanitizeNode: function(node, opts) {
      var _this = this;
      var attrs = node.attributes || [];
      var nodes = node.childNodes || [];
      var toRemove = [];
      (0, index_all.each)(attrs, function(attr) {
        var name = attr.nodeName || "";
        var value = attr.nodeValue || "";
        !opts.allowUnsafeAttr && name.startsWith("on") && toRemove.push(name);
        !opts.allowUnsafeAttrValue && value.startsWith("javascript:") && toRemove.push(name);
      });
      toRemove.map(function(name) {
        return node.removeAttribute(name);
      });
      (0, index_all.each)(nodes, function(node2) {
        return _this.__sanitizeNode(node2, opts);
      });
    }
  };
};
var model_ParserHtml = ParserHtml;
var StyleableModel_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var StyleableModel_assign = function() {
  StyleableModel_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return StyleableModel_assign.apply(this, arguments);
};
var parserHtml = model_ParserHtml();
var getLastStyleValue = function(value) {
  return (0, index_all.isArray)(value) ? value[value.length - 1] : value;
};
var StyleableModel = (
  /** @class */
  function(_super) {
    StyleableModel_extends(StyleableModel2, _super);
    function StyleableModel2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    StyleableModel2.prototype.parseStyle = function(str) {
      return parserHtml.parseStyle(str);
    };
    StyleableModel2.prototype.extendStyle = function(prop) {
      return StyleableModel_assign(StyleableModel_assign({}, this.getStyle()), prop);
    };
    StyleableModel2.prototype.getStyle = function(prop) {
      var style = this.get("style") || {};
      var result = StyleableModel_assign({}, style);
      return prop && (0, index_all.isString)(prop) ? result[prop] : result;
    };
    StyleableModel2.prototype.setStyle = function(prop, opts) {
      var _this = this;
      if (prop === void 0) {
        prop = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      if ((0, index_all.isString)(prop)) {
        prop = this.parseStyle(prop);
      }
      var propOrig = this.getStyle(opts);
      if (opts.partial || opts.avoidStore) {
        opts.avoidStore = true;
        prop.__p = true;
      } else {
        delete prop.__p;
      }
      var propNew = StyleableModel_assign({}, prop);
      var newStyle = StyleableModel_assign({}, propNew);
      (0, index_all.keys)(newStyle).forEach(function(prop2) {
        if (newStyle[prop2] === "") {
          delete newStyle[prop2];
        }
      });
      this.set("style", newStyle, opts);
      var diff = (0, mixins.shallowDiff)(propOrig, propNew);
      delete diff.__p;
      (0, index_all.keys)(diff).forEach(function(pr) {
        var em = _this.em;
        if (opts.noEvent)
          return;
        _this.trigger("change:style:".concat(pr));
        if (em) {
          em.trigger("styleable:change", _this, pr, opts);
          em.trigger("styleable:change:".concat(pr), _this, pr, opts);
        }
      });
      return propNew;
    };
    StyleableModel2.prototype.addStyle = function(prop, value, opts) {
      var _a2;
      if (value === void 0) {
        value = "";
      }
      if (opts === void 0) {
        opts = {};
      }
      if (typeof prop == "string") {
        prop = (_a2 = {}, _a2[prop] = value, _a2);
      } else {
        opts = value || {};
      }
      opts.addStyle = prop;
      prop = this.extendStyle(prop);
      this.setStyle(prop, opts);
    };
    StyleableModel2.prototype.removeStyle = function(prop) {
      var style = this.getStyle();
      delete style[prop];
      this.setStyle(style);
    };
    StyleableModel2.prototype.styleToString = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = [];
      var style = this.getStyle(opts);
      var imp = opts.important;
      var _loop_1 = function(prop2) {
        var important = (0, index_all.isArray)(imp) ? imp.indexOf(prop2) >= 0 : imp;
        var firstChars = prop2.substring(0, 2);
        var isPrivate = firstChars === "__";
        if (isPrivate)
          return "continue";
        var value = style[prop2];
        var values = (0, index_all.isArray)(value) ? value : [value];
        values.forEach(function(val) {
          var value2 = "".concat(val).concat(important ? " !important" : "");
          value2 && result.push("".concat(prop2, ":").concat(value2, ";"));
        });
      };
      for (var prop in style) {
        _loop_1(prop);
      }
      return result.join("");
    };
    StyleableModel2.prototype.getSelectors = function() {
      return this.get("selectors") || this.get("classes");
    };
    StyleableModel2.prototype.getSelectorsString = function(opts) {
      return this.selectorsToString ? this.selectorsToString(opts) : this.getSelectors().getFullString();
    };
    return StyleableModel2;
  }(common.Kx)
);
var model_StyleableModel = StyleableModel;
var SymbolUtils_assign = function() {
  SymbolUtils_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return SymbolUtils_assign.apply(this, arguments);
};
var SymbolUtils_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var isSymbolMain = function(cmp) {
  return (0, index_all.isArray)(cmp.get(keySymbols));
};
var isSymbolInstance = function(cmp) {
  return !!cmp.get(keySymbol);
};
var isSymbol = function(cmp) {
  return !!(isSymbolMain(cmp) || isSymbolInstance(cmp));
};
var isSymbolRoot = function(symbol) {
  var parent = symbol.parent();
  return isSymbol(symbol) && (!parent || !isSymbol(parent));
};
var initSymbol = function(symbol) {
  if (symbol.__symbReady)
    return;
  symbol.on("change", symbol.__upSymbProps);
  symbol.__symbReady = true;
};
var getSymbolMain = function(symbol) {
  var result = symbol.get(keySymbol);
  if (result && (0, index_all.isString)(result)) {
    var ref = symbol.__getAllById()[result];
    if (ref) {
      result = ref;
      symbol.set(keySymbol, ref);
    } else {
      result = 0;
    }
  }
  return result || void 0;
};
var getSymbolInstances = function(symbol) {
  var symbs = symbol === null || symbol === void 0 ? void 0 : symbol.get(keySymbols);
  if (symbs && (0, index_all.isArray)(symbs)) {
    symbs.forEach(function(symb, idx) {
      if (symb && (0, index_all.isString)(symb)) {
        symbs[idx] = symbol.__getAllById()[symb];
      }
    });
    symbs = symbs.filter(function(symb) {
      return symb && !(0, index_all.isString)(symb);
    });
  }
  return symbs || void 0;
};
var isSymbolOverride = function(symbol, prop) {
  if (prop === void 0) {
    prop = "";
  }
  var ovrd = symbol === null || symbol === void 0 ? void 0 : symbol.get(keySymbolOvrd);
  var prp = prop.split(":")[0];
  var props = prop !== prp ? [prop, prp] : [prop];
  return ovrd === true || (0, index_all.isArray)(ovrd) && props.some(function(p) {
    return ovrd.indexOf(p) >= 0;
  });
};
var getSymbolsToUpdate = function(symb, opts) {
  if (opts === void 0) {
    opts = {};
  }
  var result = [];
  var changed = opts.changed;
  if (opts.fromInstance || opts.noPropagate || opts.fromUndo || // Avoid updating others if the current component has override
  changed && isSymbolOverride(symb, changed)) {
    return result;
  }
  var symbols = getSymbolInstances(symb) || [];
  var symbol = getSymbolMain(symb);
  var all = symbol ? SymbolUtils_spreadArray([symbol], getSymbolInstances(symbol) || [], true) : symbols;
  result = all.filter(function(s) {
    return s !== symb;
  }).filter(function(s) {
    return !(changed && isSymbolOverride(s, changed));
  });
  return result;
};
var getSymbolTop = function(symbol, opts) {
  var result = symbol;
  var parent = symbol.parent(opts);
  while (parent && isSymbol(parent)) {
    result = parent;
    parent = parent.parent(opts);
  }
  return result;
};
var detachSymbolInstance = function(symbol, opts) {
  if (opts === void 0) {
    opts = {};
  }
  var symbolMain = getSymbolMain(symbol);
  var symbs = symbolMain && getSymbolInstances(symbolMain);
  !opts.skipRefs && symbs && symbolMain.set(keySymbols, symbs.filter(function(s) {
    return s !== symbol;
  }));
  symbol.set(keySymbol, 0);
  symbol.components().forEach(function(s) {
    return detachSymbolInstance(s, opts);
  });
};
var logSymbol = function(symb, type2, toUp, opts) {
  if (opts === void 0) {
    opts = {};
  }
  var symbol = getSymbolMain(symb);
  var symbols = getSymbolInstances(symb);
  if (!symbol && !symbols) {
    return;
  }
  symb.em.log(type2, { model: symb, toUp, context: "symbols", opts });
};
var updateSymbolProps = function(symbol, opts) {
  if (opts === void 0) {
    opts = {};
  }
  var changed = symbol.changedAttributes() || {};
  var attrs = changed.attributes || {};
  delete changed.status;
  delete changed.open;
  delete changed[keySymbols];
  delete changed[keySymbol];
  delete changed[keySymbolOvrd];
  delete changed.attributes;
  delete attrs.id;
  if (!(0, mixins.isEmptyObj)(attrs)) {
    changed.attributes = attrs;
  }
  if (!(0, mixins.isEmptyObj)(changed)) {
    var toUp = getSymbolsToUpdate(symbol, opts);
    (0, index_all.keys)(changed).map(function(prop) {
      if (isSymbolOverride(symbol, prop))
        delete changed[prop];
    });
    logSymbol(symbol, "props", toUp, { opts, changed });
    toUp.forEach(function(child) {
      var propsChanged = SymbolUtils_assign({}, changed);
      (0, index_all.keys)(propsChanged).map(function(prop) {
        if (isSymbolOverride(child, prop))
          delete propsChanged[prop];
      });
      child.set(propsChanged, SymbolUtils_assign({ fromInstance: symbol }, opts));
    });
  }
};
var updateSymbolCls = function(symbol, opts) {
  if (opts === void 0) {
    opts = {};
  }
  var toUp = getSymbolsToUpdate(symbol, opts);
  logSymbol(symbol, "classes", toUp, { opts });
  toUp.forEach(function(child) {
    child.set("classes", symbol.get("classes"), { fromInstance: symbol });
  });
  symbol.__changesUp(opts);
};
var updateSymbolComps = function(symbol, m, c, o) {
  var optUp = o || c || {};
  var fromInstance = optUp.fromInstance, fromUndo = optUp.fromUndo;
  var toUpOpts = { fromInstance, fromUndo };
  var isTemp = m.opt.temporary;
  if (!o) {
    var coll = m;
    var toUp = getSymbolsToUpdate(symbol, SymbolUtils_assign(SymbolUtils_assign({}, toUpOpts), { changed: "components:reset" }));
    var cmps_1 = coll.models;
    var newSymbols_1 = /* @__PURE__ */ new Set();
    logSymbol(symbol, "reset", toUp, { components: cmps_1 });
    toUp.forEach(function(rel) {
      var relCmps = rel.components();
      var toReset = cmps_1.map(function(cmp, i) {
        if (!isSymbol(cmp) || newSymbols_1.has(cmp)) {
          newSymbols_1.add(cmp);
          return cmp.clone({ symbol: true });
        }
        return relCmps.at(i);
      });
      relCmps.reset(toReset, SymbolUtils_assign({ fromInstance: symbol }, c));
    });
  } else if (o.add) {
    var addedInstances_1 = [];
    var isMainSymb_1 = !!getSymbolInstances(symbol);
    var toUp = getSymbolsToUpdate(symbol, SymbolUtils_assign(SymbolUtils_assign({}, toUpOpts), { changed: "components:add" }));
    if (toUp.length) {
      var addSymb = getSymbolMain(m);
      addedInstances_1 = (addSymb ? getSymbolInstances(addSymb) : getSymbolInstances(m)) || [];
      addedInstances_1 = SymbolUtils_spreadArray([], addedInstances_1, true);
      addedInstances_1.push(addSymb ? addSymb : m);
    }
    !isTemp && logSymbol(symbol, "add", toUp, {
      opts: o,
      addedInstances: addedInstances_1.map(function(c2) {
        return c2.cid;
      }),
      added: m.cid
    });
    toUp.forEach(function(symb2) {
      var symbTop = getSymbolTop(symb2);
      var symbPrev = addedInstances_1.filter(function(addedInst) {
        var addedTop = getSymbolTop(addedInst, { prev: 1 });
        return symbTop && addedTop && addedTop === symbTop;
      })[0];
      var toAppend = symbPrev || m.clone({ symbol: true, symbolInv: isMainSymb_1 });
      symb2.append(toAppend, SymbolUtils_assign({ fromInstance: symbol }, o));
    });
  } else {
    var symb = getSymbolMain(m);
    symb && !o.temporary && symb.set(keySymbols, getSymbolInstances(symb).filter(function(i) {
      return i !== m;
    }));
    if (!isSymbolRoot(m) && !o.skipRefsUp) {
      var changed_1 = "components:remove";
      var index_1 = o.index;
      var parent_1 = m.parent();
      var opts_1 = SymbolUtils_assign({ fromInstance: m }, o);
      var isSymbNested = isSymbolRoot(m);
      var toUpFn = function(symb2) {
        var symbPrnt = symb2.parent();
        symbPrnt && !isSymbolOverride(symbPrnt, changed_1) && symb2.remove(opts_1);
      };
      var toUp = !isSymbolOverride(parent_1, changed_1) ? getSymbolsToUpdate(m, toUpOpts) : [];
      if (isSymbNested) {
        toUp = parent_1 && getSymbolsToUpdate(parent_1, SymbolUtils_assign(SymbolUtils_assign({}, toUpOpts), { changed: changed_1 }));
        toUpFn = function(symb2) {
          var toRemove = symb2.components().at(index_1);
          toRemove && toRemove.remove(SymbolUtils_assign({ fromInstance: parent_1 }, opts_1));
        };
      }
      !isTemp && logSymbol(symbol, "remove", toUp, {
        opts: o,
        removed: m.cid,
        isSymbNested
      });
      toUp.forEach(toUpFn);
    }
  }
  symbol.__changesUp(optUp);
};
var Components_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Components_assign = function() {
  Components_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Components_assign.apply(this, arguments);
};
var __rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var Components_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var getComponentIds = function(cmp, res) {
  if (res === void 0) {
    res = [];
  }
  if (!cmp)
    return [];
  var cmps = (0, index_all.isArray)(cmp) || (0, index_all.isFunction)(cmp.map) ? cmp : [cmp];
  cmps.map(function(cmp2) {
    res.push(cmp2.getId());
    getComponentIds(cmp2.components().models, res);
  });
  return res;
};
var getComponentsFromDefs = function(items, all, opts) {
  if (all === void 0) {
    all = {};
  }
  if (opts === void 0) {
    opts = {};
  }
  opts.visitedCmps = opts.visitedCmps || {};
  var visitedCmps = opts.visitedCmps;
  var itms = (0, index_all.isArray)(items) ? items : [items];
  return itms.map(function(item) {
    var _a2 = item.attributes, attributes = _a2 === void 0 ? {} : _a2, components = item.components, tagName2 = item.tagName, style = item.style;
    var id = attributes.id, draggable = attributes.draggable, restAttr = __rest(attributes, ["id", "draggable"]);
    var result = item;
    if (id) {
      if (!visitedCmps[id]) {
        visitedCmps[id] = [];
        if (all[id]) {
          result = all[id];
          var cmp = result;
          tagName2 && cmp.set({ tagName: tagName2 }, Components_assign(Components_assign({}, opts), { silent: true }));
          (0, index_all.keys)(restAttr).length && cmp.addAttributes(restAttr, Components_assign({}, opts));
          (0, index_all.keys)(style).length && cmp.addStyle(style, opts);
        }
      } else {
        visitedCmps[id].push(result);
        id = model_Component.getNewId(all);
        result.attributes.id = id;
      }
    }
    if (components) {
      var newComponents = getComponentsFromDefs(components, all);
      if ((0, index_all.isFunction)(result.components)) {
        var cmps = result.components();
        cmps.length > 0 && cmps.reset(newComponents, opts);
      } else {
        result.components = newComponents;
      }
    }
    return result;
  });
};
var Components = (
  /** @class */
  function(_super) {
    Components_extends(Components2, _super);
    function Components2(models, opt) {
      var _this = _super.call(this, models, opt) || this;
      _this.opt = opt;
      _this.listenTo(_this, "add", _this.onAdd);
      _this.listenTo(_this, "remove", _this.removeChildren);
      _this.listenTo(_this, "reset", _this.resetChildren);
      var em = opt.em, config2 = opt.config;
      _this.config = config2;
      _this.em = em;
      _this.domc = opt.domc || (em === null || em === void 0 ? void 0 : em.Components);
      return _this;
    }
    Object.defineProperty(Components2.prototype, "events", {
      get: function() {
        var _a2;
        return (_a2 = this.domc) === null || _a2 === void 0 ? void 0 : _a2.events;
      },
      enumerable: false,
      configurable: true
    });
    Components2.prototype.resetChildren = function(models, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var coll = this;
      var prev = opts.previousModels || [];
      var toRemove = prev.filter(function(prev2) {
        return !models.get(prev2.cid);
      });
      var newIds = getComponentIds(models);
      var idsToKeep = getComponentIds(prev).filter(function(pr) {
        return newIds.indexOf(pr) >= 0;
      });
      opts.keepIds = (opts.keepIds || []).concat(idsToKeep);
      toRemove.forEach(function(md) {
        return _this.removeChildren(md, coll, opts);
      });
      models.each(function(model) {
        return _this.onAdd(model);
      });
    };
    Components2.prototype.resetFromString = function(input, opts) {
      var _a2, _b;
      if (input === void 0) {
        input = "";
      }
      if (opts === void 0) {
        opts = {};
      }
      opts.keepIds = getComponentIds(this);
      var _c = this, domc = _c.domc, em = _c.em, parent = _c.parent;
      var cssc = em === null || em === void 0 ? void 0 : em.Css;
      var allByID = (domc === null || domc === void 0 ? void 0 : domc.allById()) || {};
      var parsed = this.parseString(input, opts);
      var newCmps = getComponentsFromDefs(parsed, allByID, opts);
      var _d = opts.visitedCmps, visitedCmps = _d === void 0 ? {} : _d;
      Object.keys(visitedCmps).forEach(function(id) {
        var cmps = visitedCmps[id];
        if (cmps.length) {
          var rulesToClone_1 = (cssc === null || cssc === void 0 ? void 0 : cssc.getRules("#".concat(id))) || [];
          if (rulesToClone_1.length) {
            cmps.forEach(function(cmp) {
              rulesToClone_1.forEach(function(rule) {
                var newRule = rule.clone();
                newRule.set("selectors", ["#".concat(cmp.attributes.id)]);
                cssc.getAll().add(newRule);
              });
            });
          }
        }
      });
      this.reset(newCmps, opts);
      em === null || em === void 0 ? void 0 : em.trigger("component:content", parent, opts, input);
      (_b = (_a2 = parent).__checkInnerChilds) === null || _b === void 0 ? void 0 : _b.call(_a2);
    };
    Components2.prototype.removeChildren = function(removed, coll, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      if (!removed) {
        return;
      }
      var _a2 = this, domc = _a2.domc, em = _a2.em;
      var isTemp = opts.temporary || opts.fromUndo;
      removed.prevColl = this;
      if (!isTemp) {
        var id_1 = removed.getId();
        var sels = em.Selectors.getAll();
        var rules = em.Css.getAll();
        var canRemoveStyle = (opts.keepIds || []).indexOf(id_1) < 0;
        var allByID = domc ? domc.allById() : {};
        delete allByID[id_1];
        var rulesRemoved = canRemoveStyle ? rules.remove(rules.filter(function(r) {
          return r.getSelectors().getFullString() === "#".concat(id_1);
        }), opts) : [];
        sels.remove(rulesRemoved.map(function(rule) {
          return rule.getSelectors().at(0);
        }));
        if (!removed.opt.temporary) {
          em.Commands.run("core:component-style-clear", { target: removed });
          removed.removed();
          removed.trigger("removed");
          em.trigger(dom_components_types.I.remove, removed);
          if (domc && isSymbolInstance(removed) && isSymbolRoot(removed)) {
            domc.symbols.__trgEvent(domc.events.symbolInstanceRemove, { component: removed }, true);
          }
        }
        var inner_1 = removed.components();
        inner_1.forEach(function(it) {
          updateSymbolComps(it, it, inner_1, Components_assign(Components_assign({}, opts), { skipRefsUp: true }));
          _this.removeChildren(it, coll, opts);
        });
      }
      var inner = removed.components();
      em.stopListening(inner);
      em.stopListening(removed);
      em.stopListening(removed.get("classes"));
      removed.__postRemove();
    };
    Components2.prototype.model = function(attrs, options) {
      var opt = options.collection.opt;
      var em = opt.em;
      var model;
      var df = em.Components.componentTypes;
      options.em = em;
      options.config = opt.config;
      options.componentTypes = df;
      options.domc = opt.domc;
      for (var it_1 = 0; it_1 < df.length; it_1++) {
        var dfId = df[it_1].id;
        if (dfId == attrs.type) {
          model = df[it_1].model;
          break;
        }
      }
      if (!model) {
        model = df[df.length - 1].model;
        em && attrs.type && em.logWarning("Component type '".concat(attrs.type, "' not found"), {
          attrs,
          options
        });
      }
      return new model(attrs, options);
    };
    Components2.prototype.parseString = function(value, opt) {
      if (opt === void 0) {
        opt = {};
      }
      var _a2 = this, em = _a2.em, domc = _a2.domc, parent = _a2.parent;
      var asDocument = opt.asDocument && (parent === null || parent === void 0 ? void 0 : parent.is("wrapper"));
      var cssc = em.Css;
      var parsed = em.Parser.parseHtml(value, Components_assign({ asDocument }, opt.parserOptions));
      var components = parsed.html;
      if (asDocument) {
        var root = parent;
        var _b = parsed.html || {}, bodyCmps = _b.components, restBody = __rest(_b, ["components"]);
        var _c = parsed.head || {}, headCmps = _c.components, restHead = __rest(_c, ["components"]);
        components = bodyCmps;
        root.set(restBody, opt);
        root.head.set(restHead, opt);
        root.head.components(headCmps, opt);
        root.docEl.set(parsed.root, opt);
        root.set({ doctype: parsed.doctype });
      }
      model_Component.checkId(components, parsed.css, domc.componentsById, opt);
      if (parsed.css && cssc && !opt.temporary) {
        var at = opt.at, optsToPass = __rest(opt, ["at"]);
        cssc.addCollection(parsed.css, Components_assign(Components_assign({}, optsToPass), { extend: 1 }));
      }
      return components;
    };
    Components2.prototype.add = function(models, opt) {
      var _this = this;
      if (opt === void 0) {
        opt = {};
      }
      if (models == void 0)
        return;
      opt.keepIds = Components_spreadArray(Components_spreadArray([], opt.keepIds || [], true), getComponentIds(opt.previousModels), true);
      if ((0, index_all.isString)(models)) {
        models = this.parseString(models, opt);
      } else if ((0, index_all.isArray)(models)) {
        models.forEach(function(item, index2) {
          if ((0, index_all.isString)(item)) {
            var nodes = _this.parseString(item, opt);
            models[index2] = (0, index_all.isArray)(nodes) && !nodes.length ? null : nodes;
          }
        });
      }
      var processedModels = ((0, index_all.isArray)(models) ? models : [models]).filter(Boolean).map(function(model) {
        return _this.processDef(model);
      });
      models = (0, index_all.isArray)(models) ? (0, index_all.flatten)(processedModels, 1) : processedModels[0];
      return _super.prototype.add.call(this, models, opt);
    };
    Components2.prototype.processDef = function(mdl) {
      if (mdl.cid && mdl.ccid)
        return mdl;
      var _a2 = this, em = _a2.em, _b = _a2.config, config2 = _b === void 0 ? {} : _b;
      var processor = config2.processor;
      var model = mdl;
      if (processor) {
        model = Components_assign({}, model);
        var modelPr = processor(model);
        if (modelPr) {
          (0, index_all.each)(model, function(val, key) {
            return delete model[key];
          });
          (0, index_all.extend)(model, modelPr);
        }
      }
      if (model.$$typeof && typeof model.props == "object") {
        model = Components_assign({}, model);
        model.props = Components_assign({}, model.props);
        var domc = em.Components;
        var parser2 = em.Parser;
        var parserHtml2 = parser2.parserHtml;
        (0, index_all.each)(model, function(value, key) {
          if (!(0, index_all.includes)(["props", "type"], key))
            delete model[key];
        });
        var props = model.props;
        var comps = props.children;
        delete props.children;
        delete model.props;
        var res = parserHtml2.splitPropsFromAttr(props);
        model.attributes = res.attrs;
        if (comps) {
          model.components = comps;
        }
        if (!model.type) {
          model.type = "textnode";
        } else if (!domc.getType(model.type)) {
          model.tagName = model.type;
          delete model.type;
        }
        (0, index_all.extend)(model, res.props);
      }
      return model;
    };
    Components2.prototype.onAdd = function(model, c, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, domc = _a2.domc, em = _a2.em;
      var style = model.getStyle();
      var avoidInline2 = em && em.getConfig().avoidInlineStyle;
      domc && domc.Component.ensureInList(model);
      if (!(0, index_all.isEmpty)(style) && !avoidInline2 && em && em.getConfig().forceClass && !opts.temporary) {
        var name_1 = model.cid;
        em.Css.setClassRule(name_1, style);
        model.setStyle({});
        model.addClass(name_1);
      }
      model.__postAdd({ recursive: true });
      if (em && !opts.temporary) {
        var triggerAdd_1 = function(model2) {
          em.trigger(dom_components_types.I.add, model2, opts);
          model2.components().forEach(function(comp) {
            return triggerAdd_1(comp);
          });
        };
        triggerAdd_1(model);
        if (domc && isSymbolInstance(model) && isSymbolRoot(model)) {
          domc.symbols.__trgEvent(domc.events.symbolInstanceAdd, { component: model }, true);
        }
      }
    };
    return Components2;
  }(common.pM)
);
var model_Components = Components;
var Selector_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TYPE_CLASS = 1;
var TYPE_ID = 2;
var Selector = (
  /** @class */
  function(_super) {
    Selector_extends(Selector2, _super);
    function Selector2(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, props, opts) || this;
      var _a2 = opts.config, config2 = _a2 === void 0 ? {} : _a2;
      var name = _this.get("name");
      var label = _this.get("label");
      if (!name) {
        _this.set("name", label);
      } else if (!label) {
        _this.set("label", name);
      }
      var namePreEsc = _this.get("name");
      var escapeName = config2.escapeName;
      var nameEsc = escapeName ? escapeName(namePreEsc) : Selector2.escapeName(namePreEsc);
      _this.set("name", nameEsc);
      _this.em = opts.em;
      return _this;
    }
    Selector2.prototype.defaults = function() {
      return {
        name: "",
        label: "",
        type: TYPE_CLASS,
        active: true,
        private: false,
        protected: false,
        _undo: true
      };
    };
    Selector2.prototype.isId = function() {
      return this.get("type") === TYPE_ID;
    };
    Selector2.prototype.isClass = function() {
      return this.get("type") === TYPE_CLASS;
    };
    Selector2.prototype.getFullName = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var escape = opts.escape;
      var name = this.get("name");
      var pfx = "";
      switch (this.get("type")) {
        case TYPE_CLASS:
          pfx = ".";
          break;
        case TYPE_ID:
          pfx = "#";
          break;
      }
      return pfx + (escape ? escape(name) : name);
    };
    Selector2.prototype.toString = function() {
      return this.getFullName();
    };
    Selector2.prototype.getName = function() {
      return this.get("name") || "";
    };
    Selector2.prototype.getLabel = function() {
      return this.get("label") || "";
    };
    Selector2.prototype.setLabel = function(label) {
      return this.set("label", label);
    };
    Selector2.prototype.getActive = function() {
      return !!this.get("active");
    };
    Selector2.prototype.setActive = function(value) {
      return this.set("active", value);
    };
    Selector2.prototype.toJSON = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var obj = common.Kx.prototype.toJSON.call(this, [opts]);
      var defaults = (0, index_all.result)(this, "defaults");
      if (em === null || em === void 0 ? void 0 : em.getConfig().avoidDefaults) {
        (0, index_all.forEach)(defaults, function(value, key) {
          if (obj[key] === value) {
            delete obj[key];
          }
        });
        if (obj.label === obj.name) {
          delete obj.label;
        }
        var objLen = (0, index_all.keys)(obj).length;
        if (objLen === 1 && obj.name) {
          obj = obj.name;
        }
        if (objLen === 2 && obj.name && obj.type) {
          obj = this.getFullName();
        }
      }
      return obj;
    };
    Selector2.escapeName = function(name) {
      return "".concat(name).trim().replace(/\s+/g, "-");
    };
    Selector2.TYPE_CLASS = TYPE_CLASS;
    Selector2.TYPE_ID = TYPE_ID;
    return Selector2;
  }(common.Kx)
);
var model_Selector = Selector;
Selector.prototype.idAttribute = "name";
var Selectors_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var combine = function(tail, curr) {
  return tail.reduce(function(acc, item, n) {
    return acc.concat(combine(tail.slice(n + 1), "".concat(curr).concat(item)));
  }, [curr]);
};
var Selectors = (
  /** @class */
  function(_super) {
    Selectors_extends(Selectors2, _super);
    function Selectors2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Selectors2.prototype.modelId = function(attr) {
      return "".concat(attr.name, "_").concat(attr.type || model_Selector.TYPE_CLASS);
    };
    Selectors2.prototype.getStyleable = function() {
      return (0, index_all.filter)(this.models, function(item) {
        return item.getActive() && !item.get("private");
      });
    };
    Selectors2.prototype.getValid = function(_a2) {
      var _b = _a2 === void 0 ? {} : _a2, noDisabled = _b.noDisabled;
      return (0, index_all.filter)(this.models, function(item) {
        return !item.get("private");
      }).filter(function(item) {
        return noDisabled ? item.get("active") : 1;
      });
    };
    Selectors2.prototype.getFullString = function(collection, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = [];
      var coll = collection || this;
      coll.forEach(function(selector) {
        return result.push(selector.getFullName(opts));
      });
      opts.sort && result.sort();
      return result.join("").trim();
    };
    Selectors2.prototype.getFullName = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var combination = opts.combination, array = opts.array;
      var result = [];
      var sels = this.map(function(s) {
        return s.getFullName(opts);
      }).sort();
      if (combination) {
        sels.forEach(function(sel, n) {
          result = result.concat(combine(sels.slice(n + 1), sel));
        });
      } else {
        result = sels;
      }
      return array ? result : combination ? result.join(",") : result.join("");
    };
    return Selectors2;
  }(common.pM)
);
var model_Selectors = Selectors;
Selectors.prototype.model = model_Selector;
var ModuleCategory_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModuleCategory_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var Category = (
  /** @class */
  function(_super) {
    ModuleCategory_extends(Category2, _super);
    function Category2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Category2.prototype.defaults = function() {
      return {
        id: "",
        label: "",
        open: true,
        attributes: {}
      };
    };
    Category2.prototype.getId = function() {
      return this.get("id");
    };
    Category2.prototype.getLabel = function() {
      return this.get("label");
    };
    return Category2;
  }(common.Kx)
);
var ModuleCategory = Category;
function getItemsByCategory(allItems) {
  var categorySet = /* @__PURE__ */ new Set();
  var categoryMap = /* @__PURE__ */ new Map();
  var emptyItem = { items: [] };
  allItems.forEach(function(item) {
    var category = item.category;
    if (category) {
      categorySet.add(category);
      var categoryItems = categoryMap.get(category);
      if (categoryItems) {
        categoryItems.push(item);
      } else {
        categoryMap.set(category, [item]);
      }
    } else {
      emptyItem.items.push(item);
    }
  });
  var categoryWithItems = Array.from(categorySet).map(function(category) {
    return {
      category,
      items: categoryMap.get(category) || []
    };
  });
  return ModuleCategory_spreadArray(ModuleCategory_spreadArray([], categoryWithItems, true), [emptyItem], false);
}
var CollectionWithCategories_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CATEGORY_KEY = "category";
var CollectionWithCategories = (
  /** @class */
  function(_super) {
    CollectionWithCategories_extends(CollectionWithCategories2, _super);
    function CollectionWithCategories2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    CollectionWithCategories2.prototype.initCategory = function(model) {
      var category = model.get(CATEGORY_KEY);
      var isDefined = category instanceof ModuleCategory;
      if (category && !isDefined) {
        if ((0, index_all.isString)(category)) {
          category = { id: category, label: category };
        } else if ((0, mixins.isObject)(category) && !category.id) {
          category.id = category.label;
        }
        var catModel = this.getCategories().add(category);
        model.set(CATEGORY_KEY, catModel, { silent: true });
        return catModel;
      } else if (isDefined) {
        var catModel = category;
        this.getCategories().add(catModel);
        return catModel;
      }
    };
    return CollectionWithCategories2;
  }(common.pM)
);
var ModuleCategories_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Categories = (
  /** @class */
  function(_super) {
    ModuleCategories_extends(Categories2, _super);
    function Categories2(models, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, models, opts) || this;
      var events2 = opts.events, em = opts.em;
      var evUpdate2 = events2 === null || events2 === void 0 ? void 0 : events2.update;
      if (em) {
        evUpdate2 && _this.on("change", function(category, options) {
          return em.trigger(evUpdate2, { category, changes: category.changedAttributes(), options });
        });
      }
      return _this;
    }
    Categories2.prototype.add = function(model, opts) {
      var models = (0, index_all.isArray)(model) ? model : [model];
      models.forEach(function(md) {
        return md && (md.id = (0, mixins.normalizeKey)("".concat(md.id)));
      });
      return _super.prototype.add.call(this, model, opts);
    };
    Categories2.prototype.get = function(id) {
      return _super.prototype.get.call(this, (0, index_all.isString)(id) ? (0, mixins.normalizeKey)(id) : id);
    };
    return Categories2;
  }(common.pM)
);
var ModuleCategories = Categories;
Categories.prototype.model = ModuleCategory;
var TraitsEvents;
(function(TraitsEvents2) {
  TraitsEvents2["select"] = "trait:select";
  TraitsEvents2["value"] = "trait:value";
  TraitsEvents2["categoryUpdate"] = "trait:category:update";
  TraitsEvents2["custom"] = "trait:custom";
  TraitsEvents2["all"] = "trait";
})(TraitsEvents || (TraitsEvents = {}));
var trait_manager_types = TraitsEvents;
var Trait_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Trait_assign = function() {
  Trait_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Trait_assign.apply(this, arguments);
};
var Trait = (
  /** @class */
  function(_super) {
    Trait_extends(Trait2, _super);
    function Trait2(prop, em) {
      var _this = _super.call(this, prop) || this;
      var _a2 = _this.attributes, target = _a2.target, name = _a2.name;
      !_this.get("id") && _this.set("id", name);
      if (target) {
        _this.setTarget(target);
      }
      _this.em = em;
      return _this;
    }
    Trait2.prototype.defaults = function() {
      return {
        type: "text",
        label: "",
        name: "",
        unit: "",
        step: 1,
        value: "",
        default: "",
        placeholder: "",
        category: "",
        changeProp: false,
        options: []
      };
    };
    Object.defineProperty(Trait2.prototype, "parent", {
      get: function() {
        return this.collection;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Trait2.prototype, "category", {
      get: function() {
        var cat = this.get("category");
        return cat instanceof ModuleCategory ? cat : void 0;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Trait2.prototype, "component", {
      get: function() {
        return this.target;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Trait2.prototype, "changeProp", {
      get: function() {
        return !!this.get("changeProp");
      },
      enumerable: false,
      configurable: true
    });
    Trait2.prototype.setTarget = function(component) {
      if (component) {
        var _a2 = this.attributes, name_1 = _a2.name, changeProp = _a2.changeProp, initValue = _a2.value, getValue = _a2.getValue;
        this.target = component;
        this.unset("target");
        var targetEvent = changeProp ? "change:".concat(name_1) : "change:attributes:".concat(name_1);
        this.listenTo(component, targetEvent, this.targetUpdated);
        var value = initValue || // Avoid the risk of loops in case the trait has a custom getValue
        (!getValue ? this.getValue() : void 0);
        !(0, index_all.isUndefined)(value) && this.set({ value }, { silent: true });
      }
    };
    Trait2.prototype.getId = function() {
      return this.get("id");
    };
    Trait2.prototype.getType = function() {
      return this.get("type");
    };
    Trait2.prototype.getName = function() {
      return this.get("name");
    };
    Trait2.prototype.getLabel = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = opts.locale, locale = _b === void 0 ? true : _b;
      var id = this.getId();
      var name = this.get("label") || this.getName();
      return locale && ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.t("traitManager.traits.labels.".concat(id))) || name;
    };
    Trait2.prototype.getValue = function(opts) {
      return this.getTargetValue(opts);
    };
    Trait2.prototype.setValue = function(value, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, component = _a2.component, em = _a2.em;
      var partial = opts.partial;
      var valueOpts = {};
      var setValue = this.attributes.setValue;
      if (setValue) {
        setValue({
          value,
          component,
          editor: em === null || em === void 0 ? void 0 : em.getEditor(),
          trait: this,
          partial: !!partial,
          options: opts,
          emitUpdate: function() {
            return _this.targetUpdated();
          }
        });
        return;
      }
      if (partial) {
        valueOpts.avoidStore = true;
      }
      this.setTargetValue(value, valueOpts);
    };
    Trait2.prototype.getDefault = function() {
      return this.get("default");
    };
    Trait2.prototype.getOptions = function() {
      return this.get("options") || [];
    };
    Trait2.prototype.getOption = function(id) {
      var _this = this;
      var idSel = (0, mixins.isDef)(id) ? id : this.getValue();
      return this.getOptions().filter(function(o) {
        return _this.getOptionId(o) === idSel;
      })[0];
    };
    Trait2.prototype.getOptionId = function(option) {
      return option.id || option.value;
    };
    Trait2.prototype.getOptionLabel = function(id, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = opts.locale, locale = _b === void 0 ? true : _b;
      var option = (0, index_all.isString)(id) ? this.getOption(id) : id;
      var optId = this.getOptionId(option);
      var label = option.label || option.name || optId;
      var propName = this.getName();
      return locale && ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.t("traitManager.traits.options.".concat(propName, ".").concat(optId))) || label;
    };
    Trait2.prototype.getCategoryLabel = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, category = _a2.category;
      var _b = opts.locale, locale = _b === void 0 ? true : _b;
      var catId = category === null || category === void 0 ? void 0 : category.getId();
      var catLabel = category === null || category === void 0 ? void 0 : category.getLabel();
      return locale && (em === null || em === void 0 ? void 0 : em.t("traitManager.categories.".concat(catId))) || catLabel || "";
    };
    Trait2.prototype.runCommand = function() {
      var em = this.em;
      var command = this.attributes.command;
      if (command && em) {
        if ((0, index_all.isString)(command)) {
          return em.Commands.run(command);
        } else {
          return command(em.Editor, this);
        }
      }
    };
    Trait2.prototype.props = function() {
      return this.attributes;
    };
    Trait2.prototype.targetUpdated = function() {
      var _a2 = this, component = _a2.component, em = _a2.em;
      var value = this.getTargetValue({ useType: true });
      this.set({ value }, { fromTarget: 1 });
      var props = { trait: this, component, value };
      component.trigger(trait_manager_types.value, props);
      em === null || em === void 0 ? void 0 : em.trigger(trait_manager_types.value, props);
      em === null || em === void 0 ? void 0 : em.trigger("trait:update", props);
    };
    Trait2.prototype.getTargetValue = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, component = _a2.component, em = _a2.em;
      var name = this.getName();
      var getValue = this.get("getValue");
      var value;
      if (getValue) {
        value = getValue({
          editor: em === null || em === void 0 ? void 0 : em.getEditor(),
          trait: this,
          component
        });
      } else if (this.changeProp) {
        value = component.get(name);
      } else {
        value = component.getAttributes()[name];
      }
      if (opts.useType) {
        var type2 = this.getType();
        if (type2 === "checkbox") {
          var _b = this.attributes, valueTrue = _b.valueTrue, valueFalse = _b.valueFalse;
          if (!(0, index_all.isUndefined)(valueTrue) && valueTrue === value) {
            value = true;
          } else if (!(0, index_all.isUndefined)(valueFalse) && valueFalse === value) {
            value = false;
          }
        }
      }
      return !(0, index_all.isUndefined)(value) ? value : "";
    };
    Trait2.prototype.setTargetValue = function(value, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = this, component = _b.component, attributes = _b.attributes;
      var name = this.getName();
      if ((0, index_all.isUndefined)(value))
        return;
      var valueToSet = value;
      if (value === "false") {
        valueToSet = false;
      } else if (value === "true") {
        valueToSet = true;
      }
      if (this.getType() === "checkbox") {
        var valueTrue = attributes.valueTrue, valueFalse = attributes.valueFalse;
        if (valueToSet && !(0, index_all.isUndefined)(valueTrue)) {
          valueToSet = valueTrue;
        }
        if (!valueToSet && !(0, index_all.isUndefined)(valueFalse)) {
          valueToSet = valueFalse;
        }
      }
      var props = (_a2 = {}, _a2[name] = valueToSet, _a2);
      props.__p = opts.avoidStore ? null : void 0;
      if (this.changeProp) {
        component.set(props, opts);
      } else {
        component.addAttributes(props, opts);
      }
    };
    Trait2.prototype.setValueFromInput = function(value, final, opts) {
      if (final === void 0) {
        final = true;
      }
      if (opts === void 0) {
        opts = {};
      }
      var toSet = { value };
      this.set(toSet, Trait_assign(Trait_assign({}, opts), { avoidStore: 1 }));
      if (final) {
        this.set("value", "", opts);
        this.set(toSet, opts);
      }
    };
    Trait2.prototype.getInitValue = function() {
      var component = this.component;
      var name = this.getName();
      var value;
      if (component) {
        var attrs = component.get("attributes");
        value = this.changeProp ? component.get(name) : attrs[name];
      }
      return value || this.get("value") || this.get("default");
    };
    return Trait2;
  }(common.Kx)
);
var model_Trait = Trait;
var TraitFactory = (
  /** @class */
  function() {
    function TraitFactory2(config2) {
      if (config2 === void 0) {
        config2 = {};
      }
      this.config = config2;
    }
    TraitFactory2.prototype.build = function(prop, em) {
      return (0, index_all.isString)(prop) ? this.buildFromString(prop, em) : new model_Trait(prop, em);
    };
    TraitFactory2.prototype.buildFromString = function(name, em) {
      var obj = {
        name,
        type: "text"
      };
      switch (name) {
        case "target":
          obj.type = "select";
          obj.default = false;
          obj.options = this.config.optionsTarget;
          break;
      }
      return new model_Trait(obj, em);
    };
    return TraitFactory2;
  }()
);
var model_TraitFactory = TraitFactory;
var Traits_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Traits = (
  /** @class */
  function(_super) {
    Traits_extends(Traits2, _super);
    function Traits2(coll, options) {
      var _this = _super.call(this, coll) || this;
      _this.categories = new ModuleCategories();
      var em = options.em;
      _this.em = em;
      _this.categories = new ModuleCategories([], {
        em,
        events: { update: trait_manager_types.categoryUpdate }
      });
      _this.on("add", _this.handleAdd);
      _this.on("reset", _this.handleReset);
      var tm = _this.module;
      var tmOpts = tm === null || tm === void 0 ? void 0 : tm.getConfig();
      _this.tf = new model_TraitFactory(tmOpts);
      return _this;
    }
    Object.defineProperty(Traits2.prototype, "module", {
      get: function() {
        return this.em.Traits;
      },
      enumerable: false,
      configurable: true
    });
    Traits2.prototype.getCategories = function() {
      return this.categories;
    };
    Traits2.prototype.handleReset = function(coll, _a2) {
      var _b = _a2 === void 0 ? {} : _a2, _c = _b.previousModels, previousModels = _c === void 0 ? [] : _c;
      previousModels.forEach(function(model) {
        return model.trigger("remove");
      });
    };
    Traits2.prototype.handleAdd = function(model) {
      model.em = this.em;
      var target = this.target;
      if (target) {
        model.target = target;
      }
      this.initCategory(model);
    };
    Traits2.prototype.setTarget = function(target) {
      this.target = target;
      this.models.forEach(function(trait) {
        return trait.setTarget(target);
      });
    };
    Traits2.prototype.add = function(models, opt) {
      if (models == void 0) {
        return void 0;
      }
      var _a2 = this, target = _a2.target, em = _a2.em;
      if ((0, index_all.isArray)(models)) {
        var traits = [];
        for (var i = 0, len = models.length; i < len; i++) {
          var trait_1 = models[i];
          traits[i] = trait_1 instanceof model_Trait ? trait_1 : this.tf.build(trait_1, em);
          traits[i].setTarget(target);
        }
        return _super.prototype.add.call(this, traits, opt);
      }
      var trait = models instanceof model_Trait ? models : this.tf.build(models, em);
      trait.setTarget(target);
      return _super.prototype.add.call(this, trait, opt);
    };
    return Traits2;
  }(CollectionWithCategories)
);
var model_Traits = Traits;
var Component_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Component_assign = function() {
  Component_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Component_assign.apply(this, arguments);
};
var Component_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var Component_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var escapeRegExp = function(str) {
  return str.replace(/[|\\{}()[\]^$+*?.]/g, "\\$&");
};
var avoidInline = function(em) {
  return !!(em === null || em === void 0 ? void 0 : em.getConfig().avoidInlineStyle);
};
var eventDrag = "component:drag";
var keySymbols = "__symbols";
var keySymbol = "__symbol";
var keySymbolOvrd = "__symbol_ovrd";
var keyUpdate = dom_components_types.I.update;
var keyUpdateInside = dom_components_types.I.updateInside;
var Component = (
  /** @class */
  function(_super) {
    Component_extends(Component2, _super);
    function Component2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      (0, index_all.bindAll)(_this, "__upSymbProps", "__upSymbCls", "__upSymbComps");
      var em = opt.em;
      var parent = _this.parent();
      var parentAttr = parent === null || parent === void 0 ? void 0 : parent.attributes;
      var propagate = _this.get("propagate");
      propagate && _this.set("propagate", (0, index_all.isArray)(propagate) ? propagate : [propagate]);
      if (parentAttr && parentAttr.propagate && !propagate) {
        var newAttr_1 = {};
        var toPropagate = parentAttr.propagate;
        toPropagate.forEach(function(prop) {
          return newAttr_1[prop] = parent.get(prop);
        });
        newAttr_1.propagate = toPropagate;
        _this.set(Component_assign(Component_assign({}, newAttr_1), props));
      }
      if (opt && opt.config && opt.config.voidElements.indexOf(_this.get("tagName")) >= 0) {
        _this.set("void", true);
      }
      opt.em = em;
      _this.opt = opt;
      _this.em = em;
      _this.frame = opt.frame;
      _this.config = opt.config || {};
      _this.set("attributes", Component_assign(Component_assign({}, (0, index_all.result)(_this, "defaults").attributes || {}), _this.get("attributes") || {}));
      _this.ccid = Component2.createId(_this, opt);
      _this.initClasses();
      _this.initComponents();
      _this.initTraits();
      _this.initToolbar();
      _this.initScriptProps();
      _this.listenTo(_this, "change:script", _this.scriptUpdated);
      _this.listenTo(_this, "change:tagName", _this.tagUpdated);
      _this.listenTo(_this, "change:attributes", _this.attrUpdated);
      _this.listenTo(_this, "change:attributes:id", _this._idUpdated);
      _this.on("change:toolbar", _this.__emitUpdateTlb);
      _this.on("change", _this.__onChange);
      _this.on(keyUpdateInside, _this.__propToParent);
      _this.set("status", "");
      _this.views = [];
      ["classes", "traits", "components"].forEach(function(name) {
        var events2 = "add remove ".concat(name !== "components" ? "change" : "");
        _this.listenTo(_this.get(name), events2.trim(), function() {
          var args = [];
          for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
          }
          return _this.emitUpdate.apply(_this, Component_spreadArray([name], args, false));
        });
      });
      if (!opt.temporary) {
        var cssc = em && em.Css;
        var _a2 = _this.attributes, styles = _a2.styles, type2 = _a2.type;
        if (styles && cssc) {
          cssc.addCollection(styles, { avoidUpdateStyle: true }, { group: "cmp:".concat(type2) });
        }
        _this.__postAdd();
        _this.init();
        isSymbol(_this) && initSymbol(_this);
        em === null || em === void 0 ? void 0 : em.trigger(dom_components_types.I.create, _this, opt);
      }
      return _this;
    }
    Object.defineProperty(Component2.prototype, "defaults", {
      /**
       * @private
       * @ts-ignore */
      get: function() {
        var _a2;
        return _a2 = {
          tagName: "div",
          type: "",
          name: "",
          removable: true,
          draggable: true,
          droppable: true,
          badgable: true,
          stylable: true,
          "stylable-require": "",
          "style-signature": "",
          unstylable: "",
          highlightable: true,
          copyable: true,
          resizable: false,
          editable: false,
          layerable: true,
          selectable: true,
          hoverable: true,
          void: false,
          state: "",
          // Indicates if the component is in some CSS state like ':hover', ':active', etc.
          status: "",
          // State, eg. 'selected'
          content: "",
          icon: "",
          style: "",
          styles: "",
          // Component related styles
          classes: "",
          // Array of classes
          script: "",
          "script-props": "",
          "script-export": "",
          attributes: {},
          traits: ["id", "title"],
          propagate: "",
          dmode: "",
          toolbar: null,
          delegate: null
        }, _a2[keySymbol] = 0, _a2[keySymbols] = 0, _a2[keySymbolOvrd] = 0, _a2._undo = true, _a2._undoexc = ["status", "open"], _a2;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "tagName", {
      get: function() {
        return this.get("tagName");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "classes", {
      get: function() {
        return this.get("classes");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "traits", {
      get: function() {
        return this.get("traits");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "content", {
      get: function() {
        var _a2;
        return (_a2 = this.get("content")) !== null && _a2 !== void 0 ? _a2 : "";
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "toolbar", {
      get: function() {
        return this.get("toolbar") || [];
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "resizable", {
      get: function() {
        return this.get("resizable");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "delegate", {
      get: function() {
        return this.get("delegate");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Component2.prototype, "locked", {
      get: function() {
        return this.get("locked");
      },
      enumerable: false,
      configurable: true
    });
    Component2.prototype.init = function() {
    };
    Component2.prototype.updated = function(property, value, previous) {
    };
    Component2.prototype.removed = function() {
    };
    Component2.prototype.__postAdd = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var um = em === null || em === void 0 ? void 0 : em.UndoManager;
      var comps = this.components();
      if (um && !this.__hasUm) {
        um.add(comps);
        um.add(this.getSelectors());
        this.__hasUm = true;
      }
      opts.recursive && comps.map(function(c) {
        return c.__postAdd(opts);
      });
    };
    Component2.prototype.__postRemove = function() {
      var em = this.em;
      var um = em === null || em === void 0 ? void 0 : em.UndoManager;
      if (um) {
        um.remove(this.components());
        um.remove(this.getSelectors());
        delete this.__hasUm;
      }
    };
    Component2.prototype.__onChange = function(m, opts) {
      var _this = this;
      var changed = this.changedAttributes() || {};
      (0, index_all.keys)(changed).forEach(function(prop) {
        return _this.emitUpdate(prop);
      });
      ["status", "open", "toolbar", "traits"].forEach(function(name) {
        return delete changed[name];
      });
      if (!(0, mixins.isEmptyObj)(changed)) {
        this.__changesUp(opts);
        this.__propSelfToParent({ component: this, changed, options: opts });
      }
    };
    Component2.prototype.__onStyleChange = function(newStyles) {
      var _this = this;
      var em = this.em;
      if (!em)
        return;
      var event = "component:styleUpdate";
      var styleKeys = (0, index_all.keys)(newStyles);
      var pros = { style: newStyles };
      em.trigger(event, this, pros);
      styleKeys.forEach(function(key) {
        return em.trigger("".concat(event, ":").concat(key), _this, pros);
      });
    };
    Component2.prototype.__changesUp = function(opts) {
      var _a2 = this, em = _a2.em, frame = _a2.frame;
      [frame, em].forEach(function(md) {
        return md && md.changesUp(opts);
      });
    };
    Component2.prototype.__propSelfToParent = function(props) {
      this.trigger(keyUpdate, props);
      this.__propToParent(props);
    };
    Component2.prototype.__propToParent = function(props) {
      var parent = this.parent();
      parent && parent.trigger(keyUpdateInside, props);
    };
    Component2.prototype.__emitUpdateTlb = function() {
      this.emitUpdate("toolbar");
    };
    Component2.prototype.__getAllById = function() {
      var em = this.em;
      return em ? em.Components.allById() : {};
    };
    Component2.prototype.__upSymbProps = function(m, opts) {
      if (opts === void 0) {
        opts = {};
      }
      updateSymbolProps(this, opts);
    };
    Component2.prototype.__upSymbCls = function(m, c, opts) {
      if (opts === void 0) {
        opts = {};
      }
      updateSymbolCls(this, opts);
    };
    Component2.prototype.__upSymbComps = function(m, c, o) {
      updateSymbolComps(this, m, c, o);
    };
    Component2.prototype.is = function(type2) {
      return !!(this.get("type") == type2);
    };
    Component2.prototype.props = function() {
      return this.attributes;
    };
    Component2.prototype.index = function() {
      var collection = this.collection;
      return collection ? collection.indexOf(this) : 0;
    };
    Component2.prototype.setDragMode = function(value) {
      return this.set("dmode", value);
    };
    Component2.prototype.getDragMode = function() {
      return this.get("dmode") || "";
    };
    Component2.prototype.setSymbolOverride = function(value) {
      var _a2;
      this.set(keySymbolOvrd, (_a2 = (0, index_all.isString)(value) ? [value] : value) !== null && _a2 !== void 0 ? _a2 : 0);
    };
    Component2.prototype.getSymbolOverride = function() {
      return this.get(keySymbolOvrd);
    };
    Component2.prototype.find = function(query) {
      var _a2;
      var result = [];
      var $els = (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.$el.find(query);
      $els === null || $els === void 0 ? void 0 : $els.each(function(i) {
        var $el = $els.eq(i);
        var model = $el.data("model");
        model && result.push(model);
      });
      return result;
    };
    Component2.prototype.findType = function(type2) {
      var result = [];
      var find = function(components) {
        return components.forEach(function(item) {
          item.is(type2) && result.push(item);
          find(item.components());
        });
      };
      find(this.components());
      return result;
    };
    Component2.prototype.findFirstType = function(type2) {
      return this.findType(type2).at(0);
    };
    Component2.prototype.closest = function(query) {
      var _a2;
      var result = (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.$el.closest(query);
      return (result === null || result === void 0 ? void 0 : result.length) ? result.data("model") : void 0;
    };
    Component2.prototype.closestType = function(type2) {
      var parent = this.parent();
      while (parent && !parent.is(type2)) {
        parent = parent.parent();
      }
      return parent;
    };
    Component2.prototype.contains = function(component) {
      var result = false;
      if (!component)
        return result;
      var contains = function(components) {
        !result && components.forEach(function(item) {
          if (item === component)
            result = true;
          !result && contains(item.components());
        });
      };
      contains(this.components());
      return result;
    };
    Component2.prototype.tagUpdated = function() {
      this.trigger("rerender");
    };
    Component2.prototype.replaceWith = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var coll = this.collection;
      var at = coll.indexOf(this);
      coll.remove(this);
      var result = coll.add(el, Component_assign(Component_assign({}, opts), { at }));
      return (0, index_all.isArray)(result) ? result : [result];
    };
    Component2.prototype.attrUpdated = function(m, v, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var attrs = this.get("attributes");
      var classes = attrs.class;
      classes && this.setClass(classes);
      delete attrs.class;
      var style = attrs.style;
      style && this.setStyle(style, opts);
      delete attrs.style;
      var attrPrev = Component_assign({}, this.previous("attributes"));
      var diff = (0, mixins.shallowDiff)(attrPrev, this.get("attributes"));
      (0, index_all.keys)(diff).forEach(function(pr) {
        var _a2;
        var attrKey = "attributes:".concat(pr);
        _this.trigger("change:".concat(attrKey), _this, diff[pr], opts);
        (_a2 = _this.em) === null || _a2 === void 0 ? void 0 : _a2.trigger("".concat(keyUpdate, ":").concat(attrKey), _this, diff[pr], opts);
      });
    };
    Component2.prototype.setAttributes = function(attrs, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.set("attributes", Component_assign({}, attrs), opts);
      return this;
    };
    Component2.prototype.addAttributes = function(attrs, opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this.setAttributes(Component_assign(Component_assign({}, this.getAttributes({ noClass: true })), attrs), opts);
    };
    Component2.prototype.removeAttributes = function(attrs, opts) {
      if (attrs === void 0) {
        attrs = [];
      }
      if (opts === void 0) {
        opts = {};
      }
      var attrArr = Array.isArray(attrs) ? attrs : [attrs];
      var compAttr = this.getAttributes();
      attrArr.map(function(i) {
        return delete compAttr[i];
      });
      return this.setAttributes(compAttr, opts);
    };
    Component2.prototype.getStyle = function(options, optsAdd) {
      if (options === void 0) {
        options = {};
      }
      if (optsAdd === void 0) {
        optsAdd = {};
      }
      var em = this.em;
      var prop = (0, index_all.isString)(options) ? options : "";
      var opts = prop ? optsAdd : options;
      if (avoidInline(em) && !opts.inline) {
        var state = em.get("state");
        var cc = em.Css;
        var rule = cc.getIdRule(this.getId(), Component_assign({ state }, opts));
        this.rule = rule;
        if (rule) {
          return rule.getStyle(prop);
        }
        return {};
      }
      return _super.prototype.getStyle.call(this, prop);
    };
    Component2.prototype.setStyle = function(prop, opts) {
      var _this = this;
      if (prop === void 0) {
        prop = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, opt = _a2.opt, em = _a2.em;
      if (avoidInline(em) && !opt.temporary && !opts.inline) {
        var style = this.get("style") || {};
        prop = (0, index_all.isString)(prop) ? this.parseStyle(prop) : prop;
        prop = Component_assign(Component_assign({}, prop), style);
        var state = em.get("state");
        var cc = em.Css;
        var propOrig = this.getStyle(opts);
        this.rule = cc.setIdRule(this.getId(), prop, Component_assign({ state }, opts));
        var diff = (0, mixins.shallowDiff)(propOrig, prop);
        this.set("style", "", { silent: true });
        (0, index_all.keys)(diff).forEach(function(pr) {
          return _this.trigger("change:style:".concat(pr));
        });
      } else {
        prop = _super.prototype.setStyle.apply(this, arguments);
      }
      if (!opt.temporary) {
        this.__onStyleChange(opts.addStyle || prop);
      }
      return prop;
    };
    Component2.prototype.getAttributes = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var classes = [];
      var attributes = Component_assign({}, this.get("attributes"));
      var sm = em === null || em === void 0 ? void 0 : em.Selectors;
      var id = this.getId();
      if (opts.noClass) {
        delete attributes.class;
      } else {
        this.classes.forEach(function(cls) {
          return classes.push((0, index_all.isString)(cls) ? cls : cls.getName());
        });
        classes.length && (attributes.class = classes.join(" "));
      }
      if (!opts.noStyle) {
        var style = this.getStyle({ inline: true });
        if ((0, mixins.isObject)(style) && !(0, mixins.isEmptyObj)(style)) {
          attributes.style = this.styleToString({ inline: true });
        }
      }
      if (!(0, index_all.has)(attributes, "id")) {
        var addId = false;
        if (avoidInline(em) || !(0, index_all.isEmpty)(this.getStyle())) {
          addId = !!(sm === null || sm === void 0 ? void 0 : sm.get(id, sm.Selector.TYPE_ID));
        }
        if (
          // Symbols should always have an id
          isSymbol(this) || // Components with script should always have an id
          this.get("script-export") || this.get("script")
        ) {
          addId = true;
        }
        if (addId) {
          attributes.id = id;
        }
      }
      return attributes;
    };
    Component2.prototype.addClass = function(classes) {
      var added = this.em.Selectors.addClass(classes);
      return this.classes.add(added);
    };
    Component2.prototype.setClass = function(classes) {
      this.classes.reset();
      return this.addClass(classes);
    };
    Component2.prototype.removeClass = function(classes) {
      var removed = [];
      classes = (0, index_all.isArray)(classes) ? classes : [classes];
      var selectors = this.classes;
      var type2 = model_Selector.TYPE_CLASS;
      classes.forEach(function(classe) {
        var classes2 = classe.split(" ");
        classes2.forEach(function(name) {
          var selector = selectors.where({ name, type: type2 })[0];
          selector && removed.push(selectors.remove(selector));
        });
      });
      return removed;
    };
    Component2.prototype.getClasses = function() {
      var attr = this.getAttributes();
      var classStr = attr.class;
      return classStr ? classStr.split(" ") : [];
    };
    Component2.prototype.initClasses = function(m, c, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var event = "change:classes";
      var _a2 = this.get("attributes") || {}, attrCls = _a2.class, restAttr = Component_rest(_a2, ["class"]);
      var toListen = [this, event, this.initClasses];
      var cls = this.get("classes") || attrCls || [];
      var clsArr = (0, index_all.isString)(cls) ? cls.split(" ") : cls;
      this.stopListening.apply(this, toListen);
      var classes = this.normalizeClasses(clsArr);
      var selectors = new model_Selectors([]);
      this.set("classes", selectors, opts);
      selectors.add(classes);
      selectors.on("add remove reset", this.__upSymbCls);
      attrCls && classes.length && this.set("attributes", restAttr);
      this.listenTo.apply(this, toListen);
      return this;
    };
    Component2.prototype.initComponents = function() {
      var event = "change:components";
      var toListen = [this, event, this.initComponents];
      this.stopListening.apply(this, toListen);
      var comps = new model_Components([], this.opt);
      comps.parent = this;
      var components = this.get("components");
      var addChild = !this.opt.avoidChildren;
      this.set("components", comps);
      addChild && components && comps.add((0, index_all.isFunction)(components) ? components(this) : components, this.opt);
      comps.on("add remove reset", this.__upSymbComps);
      this.listenTo.apply(this, toListen);
      return this;
    };
    Component2.prototype.initTraits = function(changed) {
      var em = this.em;
      var event = "change:traits";
      this.off(event, this.initTraits);
      this.__loadTraits();
      var attrs = Component_assign({}, this.get("attributes"));
      var traits = this.traits;
      traits.each(function(trait) {
        if (!trait.changeProp) {
          var name_1 = trait.getName();
          var value = trait.getInitValue();
          if (name_1 && value)
            attrs[name_1] = value;
        }
      });
      traits.length && this.set("attributes", attrs);
      this.on(event, this.initTraits);
      changed && em && em.trigger("component:toggled");
      return this;
    };
    Component2.prototype.initScriptProps = function() {
      if (this.opt.temporary)
        return;
      var prop = "script-props";
      var toListen = ["change:".concat(prop), this.initScriptProps];
      this.off.apply(this, toListen);
      var prevProps = this.previous(prop) || [];
      var newProps = this.get(prop) || [];
      var prevPropsEv = prevProps.map(function(e) {
        return "change:".concat(e);
      }).join(" ");
      var newPropsEv = newProps.map(function(e) {
        return "change:".concat(e);
      }).join(" ");
      prevPropsEv && this.off(prevPropsEv, this.__scriptPropsChange);
      newPropsEv && this.on(newPropsEv, this.__scriptPropsChange);
      this.on.apply(this, toListen);
    };
    Component2.prototype.__scriptPropsChange = function(m, v, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.avoidStore)
        return;
      this.trigger("rerender");
    };
    Component2.prototype.append = function(components, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var compArr = (0, index_all.isArray)(components) ? Component_spreadArray([], components, true) : [components];
      var toAppend = compArr.map(function(comp) {
        if ((0, index_all.isString)(comp)) {
          return comp;
        } else {
          comp.collection && comp.collection.remove(comp, { temporary: true });
          return comp;
        }
      });
      var result = this.components().add(toAppend, Component_assign({ action: dom_components_types.t.add }, opts));
      return (0, index_all.isArray)(result) ? result : [result];
    };
    Component2.prototype.components = function(components, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var coll = this.get("components");
      if ((0, index_all.isUndefined)(components)) {
        return coll;
      } else {
        coll.reset(void 0, opts);
        return components ? this.append(components, opts) : [];
      }
    };
    Component2.prototype.getChildAt = function(index2) {
      return this.components().at(index2 || 0) || void 0;
    };
    Component2.prototype.getLastChild = function() {
      var children = this.components();
      return children.at(children.length - 1) || null;
    };
    Component2.prototype.empty = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.components().reset(void 0, opts);
      return this;
    };
    Component2.prototype.parent = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var coll = this.collection || opts.prev && this.prevColl;
      return coll ? coll.parent : void 0;
    };
    Component2.prototype.parents = function() {
      var parent = this.parent();
      return parent ? [parent].concat(parent.parents()) : [];
    };
    Component2.prototype.scriptUpdated = function() {
      this.set("scriptUpdated", 1);
    };
    Component2.prototype.initToolbar = function() {
      var em = this.em;
      var model = this;
      var ppfx = em && em.getConfig().stylePrefix || "";
      if (!model.get("toolbar") && em) {
        var tb = [];
        model.collection && tb.push({
          label: em.getIcon("arrowUp"),
          command: function(ed) {
            return ed.runCommand("core:component-exit", { force: 1 });
          }
        });
        model.get("draggable") && tb.push({
          attributes: { class: "".concat(ppfx, "no-touch-actions"), draggable: true },
          label: em.getIcon("move"),
          command: "tlb-move"
        });
        model.get("copyable") && tb.push({
          label: em.getIcon("copy"),
          command: "tlb-clone"
        });
        model.get("removable") && tb.push({
          label: em.getIcon("delete"),
          command: "tlb-delete"
        });
        model.set("toolbar", tb);
      }
    };
    Component2.prototype.__loadTraits = function(tr, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var traitsI = tr || this.traits;
      if (!(traitsI instanceof model_Traits)) {
        traitsI = (0, index_all.isFunction)(traitsI) ? traitsI(this) : traitsI;
        var traits = new model_Traits([], this.opt);
        traits.setTarget(this);
        if (traitsI.length) {
          traitsI.forEach(function(tr2) {
            return tr2.attributes && delete tr2.attributes.value;
          });
          traits.add(traitsI);
        }
        this.set({ traits }, opts);
      }
      return this;
    };
    Component2.prototype.getTraits = function() {
      this.__loadTraits();
      return Component_spreadArray([], this.traits.models, true);
    };
    Component2.prototype.setTraits = function(traits) {
      var tr = (0, index_all.isArray)(traits) ? traits : [traits];
      this.set({ traits: tr });
      return this.getTraits();
    };
    Component2.prototype.getTrait = function(id) {
      return this.getTraits().filter(function(trait) {
        return trait.get("id") === id || trait.get("name") === id;
      })[0] || null;
    };
    Component2.prototype.updateTrait = function(id, props) {
      var _a2;
      var trait = this.getTrait(id);
      trait && trait.set(props);
      (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.trigger("component:toggled");
      return this;
    };
    Component2.prototype.getTraitIndex = function(id) {
      var trait = this.getTrait(id);
      return trait ? this.traits.indexOf(trait) : -1;
    };
    Component2.prototype.removeTrait = function(id) {
      var _this = this;
      var _a2;
      var ids = (0, index_all.isArray)(id) ? id : [id];
      var toRemove = ids.map(function(id2) {
        return _this.getTrait(id2);
      });
      var traits = this.traits;
      var removed = toRemove.length ? traits.remove(toRemove) : [];
      (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.trigger("component:toggled");
      return (0, index_all.isArray)(removed) ? removed : [removed];
    };
    Component2.prototype.addTrait = function(trait, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      this.__loadTraits();
      var added = this.traits.add(trait, opts);
      (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.trigger("component:toggled");
      return (0, index_all.isArray)(added) ? added : [added];
    };
    Component2.prototype.normalizeClasses = function(arr) {
      var res = [];
      var em = this.em;
      var clm = em === null || em === void 0 ? void 0 : em.Selectors;
      if (!clm)
        return [];
      if (arr.models)
        return Component_spreadArray([], arr.models, true);
      arr.forEach(function(val) {
        return res.push(clm.add(val));
      });
      return res;
    };
    Component2.prototype.clone = function(opt) {
      if (opt === void 0) {
        opt = {};
      }
      var em = this.em;
      var attr = Component_assign({}, this.attributes);
      var opts = Component_assign({}, this.opt);
      var id = this.getId();
      var cssc = em === null || em === void 0 ? void 0 : em.Css;
      attr.attributes = Component_assign({}, attr.attributes);
      delete attr.attributes.id;
      attr.components = [];
      attr.classes = [];
      attr.traits = [];
      if (isSymbolRoot(this)) {
        opt.symbol = true;
      }
      this.get("components").each(function(md, i) {
        attr.components[i] = md.clone(Component_assign(Component_assign({}, opt), { _inner: 1 }));
      });
      this.get("traits").each(function(md, i) {
        attr.traits[i] = md.clone();
      });
      this.get("classes").each(function(md, i) {
        attr.classes[i] = md.get("name");
      });
      attr.status = "";
      opts.collection = null;
      var cloned = new this.constructor(attr, opts);
      var newId = "#".concat(cloned.getId());
      var rulesToClone = cssc ? cssc.getRules("#".concat(id)) : [];
      rulesToClone.forEach(function(rule) {
        var newRule = rule.clone();
        newRule.set("selectors", [newId]);
        cssc.getAll().add(newRule);
      });
      cloned.set(keySymbols, 0);
      var symbol = getSymbolMain(this);
      var symbols = getSymbolInstances(this);
      if (!opt.symbol && (symbol || symbols)) {
        cloned.set(keySymbol, 0);
        cloned.set(keySymbols, 0);
      } else if (symbol) {
        symbol.set(keySymbols, Component_spreadArray(Component_spreadArray([], getSymbolInstances(symbol), true), [cloned], false));
        initSymbol(cloned);
      } else if (opt.symbol) {
        if (isSymbolMain(this)) {
          this.set(keySymbols, Component_spreadArray(Component_spreadArray([], symbols, true), [cloned], false));
          cloned.set(keySymbol, this);
          initSymbol(cloned);
        } else if (opt.symbolInv) {
          this.set(keySymbols, [cloned]);
          cloned.set(keySymbol, this);
          [this, cloned].map(function(i) {
            return initSymbol(i);
          });
        } else {
          cloned.set(keySymbols, [this]);
          [this, cloned].map(function(i) {
            return initSymbol(i);
          });
          this.set(keySymbol, cloned);
        }
      }
      var event = "component:clone";
      em && em.trigger(event, cloned);
      this.trigger(event, cloned);
      return cloned;
    };
    Component2.prototype.getName = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var _a2 = this.attributes, type2 = _a2.type, tagName2 = _a2.tagName, name = _a2.name;
      var defName = type2 || tagName2;
      var nameTag = !type2 ? tagName2 : "";
      var i18nPfx = "domComponents.names.";
      var i18nName = name && (em === null || em === void 0 ? void 0 : em.t("".concat(i18nPfx).concat(name)));
      var i18nNameTag = nameTag && (em === null || em === void 0 ? void 0 : em.t("".concat(i18nPfx).concat(nameTag)));
      var i18nDefName = em && (em.t("".concat(i18nPfx).concat(type2)) || em.t("".concat(i18nPfx).concat(tagName2)));
      var customName = this.get("custom-name");
      return (!opts.noCustom ? customName : "") || // Used in Layers (when the user changes the name)
      i18nName || // Use local component `name` key (eg. `domComponents.names.myComponentName`)
      name || // Use component `name` key
      i18nNameTag || // Use local component `tagName` key (eg. `domComponents.names.div`)
      (0, mixins.capitalize)(nameTag) || // Use component `tagName` key
      i18nDefName || // Use local component `type` key (eg. `domComponents.names.image`)
      (0, mixins.capitalize)(defName);
    };
    Component2.prototype.setName = function(name, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.set("custom-name", name, opts);
    };
    Component2.prototype.getIcon = function() {
      var icon = this.get("icon");
      return icon ? icon + " " : "";
    };
    Component2.prototype.toHTML = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var model = this;
      var attrs = [];
      var customTag = opts.tag;
      var tag = customTag || model.get("tagName");
      var sTag = model.get("void");
      var customAttr = opts.attributes;
      var attributes = this.getAttrToHTML(opts);
      delete opts.tag;
      if (customAttr) {
        if ((0, index_all.isFunction)(customAttr)) {
          attributes = customAttr(model, attributes) || {};
        } else if ((0, mixins.isObject)(customAttr)) {
          attributes = customAttr;
        }
      }
      if (opts.withProps) {
        var props = this.toJSON();
        (0, index_all.forEach)(props, function(value2, key) {
          var skipProps = ["classes", "attributes", "components"];
          if (key[0] !== "_" && skipProps.indexOf(key) < 0) {
            attributes["data-gjs-".concat(key)] = (0, index_all.isArray)(value2) || (0, mixins.isObject)(value2) ? JSON.stringify(value2) : (0, index_all.isBoolean)(value2) ? "".concat(value2) : value2;
          }
        });
      }
      for (var attr in attributes) {
        var val = attributes[attr];
        if (!(0, index_all.isUndefined)(val) && val !== null) {
          if ((0, index_all.isBoolean)(val)) {
            val && attrs.push(attr);
          } else {
            var valueRes = "";
            if (opts.altQuoteAttr && (0, index_all.isString)(val) && val.indexOf('"') >= 0) {
              valueRes = "'".concat(val.replace(/'/g, "&apos;"), "'");
            } else {
              var value = (0, index_all.isString)(val) ? val.replace(/"/g, "&quot;") : val;
              valueRes = '"'.concat(value, '"');
            }
            attrs.push("".concat(attr, "=").concat(valueRes));
          }
        }
      }
      var attrString = attrs.length ? " ".concat(attrs.join(" ")) : "";
      var inner = model.getInnerHTML(opts);
      var code2 = "<".concat(tag).concat(attrString).concat(sTag ? "/" : "", ">").concat(inner);
      !sTag && (code2 += "</".concat(tag, ">"));
      return code2;
    };
    Component2.prototype.getInnerHTML = function(opts) {
      return this.__innerHTML(opts);
    };
    Component2.prototype.__innerHTML = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var cmps = this.components();
      return !cmps.length ? this.content : cmps.map(function(c) {
        return c.toHTML(opts);
      }).join("");
    };
    Component2.prototype.getAttrToHTML = function(opts) {
      var attrs = this.getAttributes();
      if (avoidInline(this.em) && (opts === null || opts === void 0 ? void 0 : opts.keepInlineStyle) !== true) {
        delete attrs.style;
      }
      return attrs;
    };
    Component2.prototype.toJSON = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var obj = backbone.Model.prototype.toJSON.call(this, opts);
      obj.attributes = this.getAttributes();
      delete obj.attributes.class;
      delete obj.toolbar;
      delete obj.traits;
      delete obj.status;
      delete obj.open;
      delete obj._undoexc;
      delete obj.delegate;
      if (!opts.fromUndo) {
        var symbol = obj[keySymbol];
        var symbols = obj[keySymbols];
        if (symbols && (0, index_all.isArray)(symbols)) {
          obj[keySymbols] = symbols.filter(function(i) {
            return i;
          }).map(function(i) {
            return i.getId ? i.getId() : i;
          });
        }
        if (symbol && !(0, index_all.isString)(symbol)) {
          obj[keySymbol] = symbol.getId();
        }
      }
      if (this.em.getConfig().avoidDefaults) {
        this.getChangedProps(obj);
      }
      return obj;
    };
    Component2.prototype.getChangedProps = function(res) {
      var obj = res || backbone.Model.prototype.toJSON.apply(this);
      var defaults = (0, index_all.result)(this, "defaults");
      (0, index_all.forEach)(defaults, function(value, key) {
        if (["type"].indexOf(key) === -1 && obj[key] === value) {
          delete obj[key];
        }
      });
      if ((0, index_all.isEmpty)(obj.type)) {
        delete obj.type;
      }
      (0, index_all.forEach)(["attributes", "style"], function(prop) {
        if ((0, index_all.isEmpty)(defaults[prop]) && (0, index_all.isEmpty)(obj[prop])) {
          delete obj[prop];
        }
      });
      (0, index_all.forEach)(["classes", "components"], function(prop) {
        if (!obj[prop] || (0, index_all.isEmpty)(defaults[prop]) && !obj[prop].length) {
          delete obj[prop];
        }
      });
      return obj;
    };
    Component2.prototype.getId = function() {
      var attrs = this.get("attributes") || {};
      return attrs.id || this.ccid || this.cid;
    };
    Component2.prototype.setId = function(id, opts) {
      var attrs = Component_assign({}, this.get("attributes"));
      attrs.id = id;
      this.set("attributes", attrs, opts);
      return this;
    };
    Component2.prototype.getEl = function(frame) {
      var view = this.getView(frame);
      return view && view.el;
    };
    Component2.prototype.getView = function(frame) {
      var _a2 = this, view = _a2.view, views = _a2.views, em = _a2.em;
      var frm = frame || (em === null || em === void 0 ? void 0 : em.getCurrentFrameModel());
      if (frm) {
        view = views.filter(function(view2) {
          return view2.frameView === frm.view;
        })[0];
      }
      return view;
    };
    Component2.prototype.getCurrentView = function() {
      var frameView = this.em.getCurrentFrame();
      var frame = frameView === null || frameView === void 0 ? void 0 : frameView.model;
      return this.getView(frame);
    };
    Component2.prototype.__getScriptProps = function() {
      var modelProps = this.props();
      var scrProps = this.get("script-props") || [];
      return scrProps.reduce(function(acc, prop) {
        acc[prop] = modelProps[prop];
        return acc;
      }, {});
    };
    Component2.prototype.getScriptString = function(script) {
      var _this = this;
      var scr = script || this.get("script") || "";
      if (!scr) {
        return scr;
      }
      if (this.get("script-props")) {
        scr = scr.toString().trim();
      } else {
        if ((0, index_all.isFunction)(scr)) {
          var scrStr = scr.toString().trim();
          scrStr = scrStr.slice(scrStr.indexOf("{") + 1, scrStr.lastIndexOf("}"));
          scr = scrStr.trim();
        }
        var config2 = this.em.getConfig();
        var tagVarStart = escapeRegExp(config2.tagVarStart || "{[ ");
        var tagVarEnd = escapeRegExp(config2.tagVarEnd || " ]}");
        var reg = new RegExp("".concat(tagVarStart, "([\\w\\d-]*)").concat(tagVarEnd), "g");
        scr = scr.replace(reg, function(match, v) {
          _this.scriptUpdated();
          var result = _this.attributes[v] || "";
          return (0, index_all.isArray)(result) || typeof result == "object" ? JSON.stringify(result) : result;
        });
      }
      return scr;
    };
    Component2.prototype.emitUpdate = function(property) {
      var _a2;
      var args = [];
      for (var _i = 1; _i < arguments.length; _i++) {
        args[_i - 1] = arguments[_i];
      }
      var em = this.em;
      var event = keyUpdate + (property ? ":".concat(property) : "");
      var item = property && this.get(property);
      property && this.updated.apply(this, Component_spreadArray([property, item, property && this.previous(property)], args, false));
      this.trigger.apply(this, Component_spreadArray([event], args, false));
      em && em.trigger.apply(em, Component_spreadArray([event, this], args, false));
      ["components", "classes"].indexOf(property) >= 0 && this.__propSelfToParent({
        component: this,
        changed: (_a2 = {}, _a2[property] = item, _a2),
        options: args[2] || args[1] || {}
      });
    };
    Component2.prototype.onAll = function(clb) {
      if ((0, index_all.isFunction)(clb)) {
        clb(this);
        this.components().forEach(function(model) {
          return model.onAll(clb);
        });
      }
      return this;
    };
    Component2.prototype.forEachChild = function(clb) {
      if ((0, index_all.isFunction)(clb)) {
        this.components().forEach(function(child) {
          clb(child);
          child.forEachChild(clb);
        });
      }
    };
    Component2.prototype.remove = function(opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var coll = this.collection;
      var remove = function() {
        coll && coll.remove(_this, Component_assign({ action: dom_components_types.t.remove }, opts));
        if (!coll) {
          _this.components("", opts);
          _this.components().removeChildren(_this, void 0, opts);
        }
      };
      var rmOpts = Component_assign({}, opts);
      [this, em].map(function(i) {
        return i.trigger(dom_components_types.I.removeBefore, _this, remove, rmOpts);
      });
      !rmOpts.abort && remove();
      return this;
    };
    Component2.prototype.move = function(component, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (component) {
        var at = opts.at;
        var index2 = this.index();
        var sameParent = component === this.parent();
        var sameIndex = index2 === at || index2 === at - 1;
        if (!sameParent || !sameIndex) {
          if (sameParent && at && at > index2) {
            opts.at = at - 1;
          }
          var action = dom_components_types.t.move;
          this.remove({ action, temporary: 1 });
          component.append(this, Component_assign({ action }, opts));
          this.emitUpdate();
        }
      }
      return this;
    };
    Component2.prototype.isInstanceOf = function(type2) {
      var _a2, _b;
      var cmp = (_b = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.Components.getType(type2)) === null || _b === void 0 ? void 0 : _b.model;
      if (!cmp)
        return false;
      var typeExtends = this.constructor.typeExtends;
      return this instanceof cmp || typeExtends.has(type2);
    };
    Component2.prototype.isChildOf = function(component) {
      var byType = (0, index_all.isString)(component);
      var parent = this.parent();
      while (parent) {
        if (byType) {
          if (parent.isInstanceOf(component)) {
            return true;
          }
        } else {
          if (parent === component) {
            return true;
          }
        }
        parent = parent.parent();
      }
      return false;
    };
    Component2.prototype.resetId = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var oldId = this.getId();
      if (!oldId)
        return this;
      var newId = Component2.createId(this);
      this.setId(newId);
      var rule = em === null || em === void 0 ? void 0 : em.Css.getIdRule(oldId);
      var selector = rule === null || rule === void 0 ? void 0 : rule.get("selectors").at(0);
      selector === null || selector === void 0 ? void 0 : selector.set("name", newId);
      return this;
    };
    Component2.prototype._getStyleRule = function(_a2) {
      var _b = _a2 === void 0 ? {} : _a2, id = _b.id;
      var em = this.em;
      var idS = id || this.getId();
      return em === null || em === void 0 ? void 0 : em.Css.getIdRule(idS);
    };
    Component2.prototype._getStyleSelector = function(opts) {
      var rule = this._getStyleRule(opts);
      return rule === null || rule === void 0 ? void 0 : rule.get("selectors").at(0);
    };
    Component2.prototype._idUpdated = function(m, v, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.idUpdate)
        return;
      var ccid = this.ccid;
      var id = (this.get("attributes") || {}).id;
      var idPrev = (this.previous("attributes") || {}).id || ccid;
      var list = Component2.getList(this);
      if (list[id] || !id && idPrev) {
        return this.setId(idPrev, { idUpdate: true });
      }
      delete list[idPrev];
      list[id] = this;
      this.ccid = id;
      var selector = this._getStyleSelector({ id: idPrev });
      selector && selector.set({ name: id, label: id });
    };
    Component2.getDefaults = function() {
      return (0, index_all.result)(this.prototype, "defaults");
    };
    Component2.isComponent = function(el, opts) {
      return { tagName: (0, mixins.toLowerCase)(el.tagName) };
    };
    Component2.ensureInList = function(model) {
      var list = Component2.getList(model);
      var id = model.getId();
      var current = list[id];
      if (!current) {
        list[id] = model;
      } else if (current !== model) {
        var nextId = Component2.getIncrementId(id, list);
        model.setId(nextId);
        list[nextId] = model;
      }
      model.components().forEach(function(i) {
        return Component2.ensureInList(i);
      });
    };
    Component2.createId = function(model, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var list = Component2.getList(model);
      var _a2 = opts.idMap, idMap = _a2 === void 0 ? {} : _a2;
      var id = model.get("attributes").id;
      var nextId;
      if (id) {
        nextId = Component2.getIncrementId(id, list, opts);
        model.setId(nextId);
        if (id !== nextId)
          idMap[id] = nextId;
      } else {
        nextId = Component2.getNewId(list);
      }
      list[nextId] = model;
      return nextId;
    };
    Component2.getNewId = function(list) {
      var count = Object.keys(list).length;
      var ilen = count.toString().length + 2;
      var uid = (Math.random() + 1.1).toString(36).slice(-ilen);
      var newId = "i".concat(uid);
      while (list[newId]) {
        newId = Component2.getNewId(list);
      }
      return newId;
    };
    Component2.getIncrementId = function(id, list, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = opts.keepIds, keepIds = _a2 === void 0 ? [] : _a2;
      var counter = 1;
      var newId = id;
      if (keepIds.indexOf(id) < 0) {
        while (list[newId]) {
          counter++;
          newId = "".concat(id, "-").concat(counter);
        }
      }
      return newId;
    };
    Component2.getList = function(model) {
      var _a2;
      var em = model.em;
      var dm = em === null || em === void 0 ? void 0 : em.Components;
      return (_a2 = dm === null || dm === void 0 ? void 0 : dm.componentsById) !== null && _a2 !== void 0 ? _a2 : {};
    };
    Component2.checkId = function(components, styles, list, opts) {
      if (styles === void 0) {
        styles = [];
      }
      if (list === void 0) {
        list = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var comps = (0, index_all.isArray)(components) ? components : [components];
      var _a2 = opts.keepIds, keepIds = _a2 === void 0 ? [] : _a2, _b = opts.idMap, idMap = _b === void 0 ? {} : _b;
      comps.forEach(function(comp) {
        comp.attributes;
        var _a3 = comp.attributes, attributes = _a3 === void 0 ? {} : _a3, components2 = comp.components;
        var id = attributes.id;
        if (id && list[id] && keepIds.indexOf(id) < 0) {
          var newId_1 = Component2.getIncrementId(id, list);
          idMap[id] = newId_1;
          attributes.id = newId_1;
          (0, index_all.isArray)(styles) && styles.forEach(function(style) {
            var selectors = style.selectors;
            selectors.forEach(function(sel, idx) {
              if (sel === "#".concat(id))
                selectors[idx] = "#".concat(newId_1);
            });
          });
        }
        components2 && Component2.checkId(components2, styles, list, opts);
      });
    };
    Component2.typeExtends = /* @__PURE__ */ new Set();
    return Component2;
  }(model_StyleableModel)
);
var model_Component = Component;
var ComponentHead_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentHead_assign = function() {
  ComponentHead_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentHead_assign.apply(this, arguments);
};
var type = "head";
var droppable = ["title", "style", "base", "link", "meta", "script", "noscript"];
var ComponentHead = (
  /** @class */
  function(_super) {
    ComponentHead_extends(ComponentHead2, _super);
    function ComponentHead2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentHead2.prototype, "defaults", {
      get: function() {
        return ComponentHead_assign(ComponentHead_assign({}, _super.prototype.defaults), { type, tagName: type, draggable: false, highlightable: false, droppable: function(_a2) {
          var tagName2 = _a2.tagName;
          return !tagName2 || droppable.includes((0, mixins.toLowerCase)(tagName2));
        } });
      },
      enumerable: false,
      configurable: true
    });
    ComponentHead2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === type;
    };
    return ComponentHead2;
  }(model_Component)
);
var model_ComponentHead = ComponentHead;
var Droppable_assign = function() {
  Droppable_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Droppable_assign.apply(this, arguments);
};
var Droppable = (
  /** @class */
  function() {
    function Droppable2(em, rootEl) {
      var _this = this;
      this.em = em;
      this.canvas = em.Canvas;
      var el = rootEl || this.canvas.getFrames().map(function(frame) {
        return frame.getComponent().getEl();
      });
      var els = Array.isArray(el) ? el : [el];
      this.el = els[0];
      this.counter = 0;
      (0, index_all.bindAll)(this, "handleDragEnter", "handleDragOver", "handleDrop", "handleDragLeave");
      els.forEach(function(el2) {
        return _this.toggleEffects(el2, true);
      });
    }
    Droppable2.prototype.toggleEffects = function(el, enable) {
      var methods = { on: dom.on, off: dom.AU };
      var method = enable ? "on" : "off";
      methods[method](el, "dragenter", this.handleDragEnter);
      methods[method](el, "dragover", this.handleDragOver);
      methods[method](el, "drop", this.handleDrop);
      methods[method](el, "dragleave", this.handleDragLeave);
    };
    Droppable2.prototype.__customTglEff = function(enable) {
      var _a2;
      var method = enable ? dom.on : dom.AU;
      var doc = this.el.ownerDocument;
      var frameEl = (_a2 = doc.defaultView) === null || _a2 === void 0 ? void 0 : _a2.frameElement;
      this.sortOpts = enable ? {
        onStart: function(_a3) {
          var sorter = _a3.sorter;
          (0, dom.on)(frameEl, "pointermove", sorter.onMove);
        },
        onEnd: function(_a3) {
          var sorter = _a3.sorter;
          (0, dom.AU)(frameEl, "pointermove", sorter.onMove);
        },
        customTarget: function(_a3) {
          var event = _a3.event;
          return doc.elementFromPoint(event.clientX, event.clientY);
        }
      } : null;
      method(frameEl, "pointerenter", this.handleDragEnter);
      method(frameEl, "pointermove", this.handleDragOver);
      method(document, "pointerup", this.handleDrop);
      method(frameEl, "pointerout", this.handleDragLeave);
    };
    Droppable2.prototype.startCustom = function() {
      this.__customTglEff(true);
    };
    Droppable2.prototype.endCustom = function(cancel) {
      this.over ? this.endDrop(cancel) : this.__customTglEff(false);
    };
    Droppable2.prototype.endDrop = function(cancel, ev) {
      var _a2 = this, em = _a2.em, dragStop = _a2.dragStop;
      this.counter = 0;
      dragStop && dragStop(cancel || !this.over);
      this.__customTglEff(false);
      em.trigger("canvas:dragend", ev);
    };
    Droppable2.prototype.handleDragLeave = function(ev) {
      this.updateCounter(-1, ev);
    };
    Droppable2.prototype.updateCounter = function(value, ev) {
      this.counter += value;
      this.counter === 0 && this.endDrop(true, ev);
    };
    Droppable2.prototype.handleDragEnter = function(ev) {
      var _this = this;
      var _a2 = this, em = _a2.em, canvas2 = _a2.canvas;
      var dt = ev.dataTransfer;
      var dragContentOrigin = em.get("dragContent");
      if (!dragContentOrigin && !canvas2.getConfig().allowExternalDrop) {
        return;
      }
      this.updateCounter(1, ev);
      if (this.over)
        return;
      this.over = true;
      var utils2 = em.Utils;
      var content = dragContentOrigin || "<br>";
      var dragStop;
      var dragContent;
      em.stopDefault();
      if (em.inAbsoluteMode()) {
        var wrapper_1 = em.Components.getWrapper();
        var target_1 = wrapper_1.append({})[0];
        var dragger_1 = em.Commands.run("core:component-drag", {
          event: ev,
          guidesInfo: 1,
          center: 1,
          target: target_1,
          onEnd: function(ev2, dragger, _a3) {
            var cancelled = _a3.cancelled;
            var comp;
            if (!cancelled) {
              comp = wrapper_1.append(content)[0];
              var canvasOffset = canvas2.getOffset();
              var _b = target_1.getStyle(), top_1 = _b.top, left = _b.left, position = _b.position;
              var scroll_1 = (0, dom.Xy)(ev2.target);
              var postLeft = parseInt("".concat(parseFloat(left) + scroll_1.x - canvasOffset.left), 10);
              var posTop = parseInt("".concat(parseFloat(top_1) + scroll_1.y - canvasOffset.top), 10);
              comp.addStyle({
                left: postLeft + "px",
                top: posTop + "px",
                position
              });
            }
            _this.handleDragEnd(comp, dt);
            target_1.remove();
          }
        });
        dragStop = function(cancel) {
          return dragger_1.stop(ev, { cancel });
        };
        dragContent = function(cnt) {
          return content = cnt;
        };
      } else {
        var sorter_1 = new utils2.Sorter(Droppable_assign({
          // @ts-ignore
          em,
          wmargin: 1,
          nested: 1,
          canvasRelative: 1,
          direction: "a",
          container: this.el,
          placer: canvas2.getPlacerEl(),
          containerSel: "*",
          itemSel: "*",
          pfx: "gjs-",
          onEndMove: function(model) {
            return _this.handleDragEnd(model, dt);
          },
          document: this.el.ownerDocument
        }, this.sortOpts || {}));
        sorter_1.setDropContent(content);
        sorter_1.startSort();
        this.sorter = sorter_1;
        dragStop = function(cancel) {
          cancel && (sorter_1.moved = false);
          sorter_1.endMove();
        };
        dragContent = function(content2) {
          return sorter_1.setDropContent(content2);
        };
      }
      this.dragStop = dragStop;
      this.dragContent = dragContent;
      em.trigger("canvas:dragenter", dt, content);
    };
    Droppable2.prototype.handleDragEnd = function(model, dt) {
      var em = this.em;
      this.over = false;
      if (model) {
        em.set("dragResult", model);
        em.trigger("canvas:drop", dt, model);
      }
      em.runDefault({ preserveSelected: 1 });
    };
    Droppable2.prototype.handleDragOver = function(ev) {
      ev.preventDefault();
      this.em.trigger("canvas:dragover", ev);
    };
    Droppable2.prototype.handleDrop = function(ev) {
      ev.preventDefault();
      var dragContent = this.dragContent;
      var dt = ev.dataTransfer;
      var content = this.getContentByData(dt).content;
      content && dragContent && dragContent(content);
      this.endDrop(!content, ev);
    };
    Droppable2.prototype.getContentByData = function(dt) {
      var em = this.em;
      var types2 = dt && dt.types;
      var files = dt && dt.files || [];
      var dragContent = em.get("dragContent");
      var content = dt && dt.getData("text");
      if (files.length) {
        content = [];
        for (var i = 0; i < files.length; i++) {
          var file = files[i];
          var type2 = file.type.split("/")[0];
          if (type2 == "image") {
            content.push({
              type: type2,
              file,
              attributes: { alt: file.name }
            });
          }
        }
      } else if (dragContent) {
        content = dragContent;
      } else if ((0, index_all.indexOf)(types2, "text/html") >= 0) {
        content = dt && dt.getData("text/html").replace(/<\/?meta[^>]*>/g, "");
      } else if ((0, index_all.indexOf)(types2, "text/uri-list") >= 0) {
        content = {
          type: "link",
          attributes: { href: content },
          content
        };
      } else if ((0, index_all.indexOf)(types2, "text/json") >= 0) {
        var json = dt && dt.getData("text/json");
        json && (content = JSON.parse(json));
      } else if (types2.length === 1 && types2[0] === "text/plain") {
        content = "<div>".concat(content, "</div>");
      }
      var result = { content };
      em.trigger("canvas:dragdata", dt, result);
      return result;
    };
    return Droppable2;
  }()
);
var utils_Droppable = Droppable;
var FrameView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var FrameView_assign = function() {
  FrameView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return FrameView_assign.apply(this, arguments);
};
var FrameView_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var FrameView = (
  /** @class */
  function(_super) {
    FrameView_extends(FrameView2, _super);
    function FrameView2(model, view) {
      var _this = _super.call(this, { model }) || this;
      _this.dragging = false;
      _this.loaded = false;
      _this.lastMaxHeight = 0;
      _this.tools = {};
      (0, index_all.bindAll)(_this, "updateClientY", "stopAutoscroll", "autoscroll", "_emitUpdate");
      var el = _this.el;
      _this.module._config = FrameView_assign(FrameView_assign({}, _this.config || {}), {
        //@ts-ignore
        frameView: _this
      });
      _this.frameWrapView = view;
      _this.showGlobalTools = (0, index_all.debounce)(_this.showGlobalTools.bind(_this), 50);
      var cvModel = _this.getCanvasModel();
      _this.listenTo(model, "change:head", _this.updateHead);
      _this.listenTo(cvModel, "change:styles", _this.renderStyles);
      model.view = _this;
      (0, mixins.setViewEl)(el, _this);
      return _this;
    }
    Object.defineProperty(FrameView2.prototype, "tagName", {
      /** @ts-ignore */
      get: function() {
        return "iframe";
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(FrameView2.prototype, "attributes", {
      /** @ts-ignore */
      get: function() {
        return { allowfullscreen: "allowfullscreen" };
      },
      enumerable: false,
      configurable: true
    });
    FrameView2.prototype.getBoxRect = function() {
      var _a2 = this, el = _a2.el, module = _a2.module;
      var canvasView = module.getCanvasView();
      var coords = module.getCoords();
      var frameRect = el.getBoundingClientRect();
      var canvasRect = canvasView.getCanvasOffset();
      var vwDelta = canvasView.getViewportDelta();
      var zoomM = module.getZoomMultiplier();
      var x = (frameRect.x - canvasRect.left - vwDelta.x - coords.x) * zoomM;
      var y = (frameRect.y - canvasRect.top - vwDelta.y - coords.y) * zoomM;
      var width = frameRect.width * zoomM;
      var height = frameRect.height * zoomM;
      return {
        x,
        y,
        width,
        height
      };
    };
    FrameView2.prototype.updateHead = function() {
      var model = this.model;
      var headEl = this.getHead();
      var toRemove = [];
      var toAdd = [];
      var current = model.head;
      var prev = model.previous("head");
      var attrStr = function(attr) {
        if (attr === void 0) {
          attr = {};
        }
        return Object.keys(attr).sort().map(function(i) {
          return "[".concat(i, '="').concat(attr[i], '"]');
        }).join("");
      };
      var find = function(items, stack, res) {
        items.forEach(function(item) {
          var tag = item.tag, attributes = item.attributes;
          var has = stack.some(function(s) {
            return s.tag === tag && attrStr(s.attributes) === attrStr(attributes);
          });
          !has && res.push(item);
        });
      };
      find(current, prev, toAdd);
      find(prev, current, toRemove);
      toRemove.forEach(function(stl) {
        var _a2;
        var el = headEl.querySelector("".concat(stl.tag).concat(attrStr(stl.attributes)));
        (_a2 = el === null || el === void 0 ? void 0 : el.parentNode) === null || _a2 === void 0 ? void 0 : _a2.removeChild(el);
      });
      (0, dom.af)(headEl, toAdd);
    };
    FrameView2.prototype.getEl = function() {
      return this.el;
    };
    FrameView2.prototype.getCanvasModel = function() {
      var _a2;
      return (_a2 = this === null || this === void 0 ? void 0 : this.em.Canvas) === null || _a2 === void 0 ? void 0 : _a2.getModel();
    };
    FrameView2.prototype.getWindow = function() {
      return this.getEl().contentWindow;
    };
    FrameView2.prototype.getDoc = function() {
      return this.getEl().contentDocument;
    };
    FrameView2.prototype.getHead = function() {
      return this.getDoc().querySelector("head");
    };
    FrameView2.prototype.getBody = function() {
      return this.getDoc().querySelector("body");
    };
    FrameView2.prototype.getWrapper = function() {
      return this.getBody().querySelector("[data-gjs-type=wrapper]");
    };
    FrameView2.prototype.getJsContainer = function() {
      if (!this.jsContainer) {
        this.jsContainer = (0, dom.a_)("div", { class: "".concat(this.ppfx, "js-cont") });
      }
      return this.jsContainer;
    };
    FrameView2.prototype.getToolsEl = function() {
      var _a2;
      return (_a2 = this.frameWrapView) === null || _a2 === void 0 ? void 0 : _a2.elTools;
    };
    FrameView2.prototype.getGlobalToolsEl = function() {
      return this.em.Canvas.getGlobalToolsEl();
    };
    FrameView2.prototype.getHighlighter = function() {
      return this._getTool("[data-hl]");
    };
    FrameView2.prototype.getBadgeEl = function() {
      return this._getTool("[data-badge]");
    };
    FrameView2.prototype.getOffsetViewerEl = function() {
      return this._getTool("[data-offset]");
    };
    FrameView2.prototype.getRect = function() {
      if (!this.rect) {
        this.rect = this.el.getBoundingClientRect();
      }
      return this.rect;
    };
    FrameView2.prototype.getOffsetRect = function() {
      var el = this.el;
      var _a2 = this.getBody(), scrollTop = _a2.scrollTop, scrollLeft = _a2.scrollLeft;
      var height = el.offsetHeight;
      var width = el.offsetWidth;
      return {
        top: el.offsetTop,
        left: el.offsetLeft,
        height,
        width,
        scrollTop,
        scrollLeft,
        scrollBottom: scrollTop + height,
        scrollRight: scrollLeft + width
      };
    };
    FrameView2.prototype._getTool = function(name) {
      var tools = this.tools;
      var toolsEl = this.getToolsEl();
      if (!tools[name]) {
        tools[name] = toolsEl.querySelector(name);
      }
      return tools[name];
    };
    FrameView2.prototype.remove = function() {
      var _a2;
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      this._toggleEffects(false);
      this.tools = {};
      (_a2 = this.wrapper) === null || _a2 === void 0 ? void 0 : _a2.remove();
      abstract_ModuleView.prototype.remove.apply(this, args);
      return this;
    };
    FrameView2.prototype.startAutoscroll = function() {
      var _this = this;
      this.lastMaxHeight = this.getWrapper().offsetHeight - this.el.offsetHeight;
      setTimeout(function() {
        _this._toggleAutoscrollFx(true);
        requestAnimationFrame(_this.autoscroll);
      }, 0);
    };
    FrameView2.prototype.autoscroll = function() {
      if (this.dragging) {
        var lastClientY = this.lastClientY;
        var canvas2 = this.em.Canvas;
        var win = this.getWindow();
        var actualTop = win.pageYOffset;
        var clientY = lastClientY || 0;
        var limitTop = canvas2.getConfig().autoscrollLimit;
        var limitBottom = this.getRect().height - limitTop;
        var nextTop = actualTop;
        if (clientY < limitTop) {
          nextTop -= limitTop - clientY;
        }
        if (clientY > limitBottom) {
          nextTop += clientY - limitBottom;
        }
        if (!(0, index_all.isUndefined)(lastClientY) && // Fixes #3134
        nextTop !== actualTop && nextTop > 0 && nextTop < this.lastMaxHeight) {
          var toolsEl = this.getGlobalToolsEl();
          toolsEl.style.opacity = "0";
          this.showGlobalTools();
          win.scrollTo(0, nextTop);
          canvas2.spots.refreshDbn();
        }
        requestAnimationFrame(this.autoscroll);
      }
    };
    FrameView2.prototype.updateClientY = function(ev) {
      ev.preventDefault();
      this.lastClientY = (0, dom.G2)(ev).clientY * this.em.getZoomDecimal();
    };
    FrameView2.prototype.showGlobalTools = function() {
      this.getGlobalToolsEl().style.opacity = "";
    };
    FrameView2.prototype.stopAutoscroll = function() {
      this.dragging && this._toggleAutoscrollFx(false);
    };
    FrameView2.prototype._toggleAutoscrollFx = function(enable) {
      this.dragging = enable;
      var win = this.getWindow();
      var method = enable ? "on" : "off";
      var mt = { on: dom.on, off: dom.AU };
      mt[method](win, "mousemove dragover", this.updateClientY);
      mt[method](win, "mouseup", this.stopAutoscroll);
    };
    FrameView2.prototype.render = function() {
      var _a2 = this, $el = _a2.$el, ppfx = _a2.ppfx, em = _a2.em;
      $el.attr({ class: "".concat(ppfx, "frame") });
      this.renderScripts();
      em.trigger("frame:render", this);
      return this;
    };
    FrameView2.prototype.renderScripts = function() {
      var _this = this;
      var _a2 = this, el = _a2.el, model = _a2.model, em = _a2.em;
      var evLoad = "frame:load";
      var evOpts = { el, model, view: this };
      var canvas2 = this.getCanvasModel();
      var appendScript = function(scripts) {
        var _a3;
        if (scripts.length > 0) {
          var src2 = scripts.shift();
          var scriptEl = (0, dom.a_)("script", FrameView_assign({ type: "text/javascript" }, (0, index_all.isString)(src2) ? { src: src2 } : src2));
          (_a3 = el.contentDocument) === null || _a3 === void 0 ? void 0 : _a3.head.appendChild(scriptEl);
          if (scriptEl.hasAttribute("nomodule") && "noModule" in HTMLScriptElement.prototype) {
            appendScript(scripts);
          } else {
            scriptEl.onerror = scriptEl.onload = appendScript.bind(null, scripts);
          }
        } else {
          em === null || em === void 0 ? void 0 : em.trigger(canvas_types.frameLoadHead, evOpts);
          _this.renderBody();
          em === null || em === void 0 ? void 0 : em.trigger(canvas_types.frameLoadBody, evOpts);
          em === null || em === void 0 ? void 0 : em.trigger(evLoad, evOpts);
        }
      };
      el.onload = function() {
        var frameContent = _this.config.frameContent;
        if (frameContent) {
          var doc = _this.getDoc();
          doc.open();
          doc.write(frameContent);
          doc.close();
        }
        evOpts.window = _this.getWindow();
        em === null || em === void 0 ? void 0 : em.trigger("".concat(evLoad, ":before"), evOpts);
        em === null || em === void 0 ? void 0 : em.trigger(canvas_types.frameLoad, evOpts);
        _this.renderHead();
        appendScript(FrameView_spreadArray([], canvas2.get("scripts"), true));
      };
    };
    FrameView2.prototype.renderStyles = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var head = this.getHead();
      var canvas2 = this.getCanvasModel();
      var normalize = function(stls) {
        if (stls === void 0) {
          stls = [];
        }
        return stls.map(function(href) {
          return {
            tag: "link",
            attributes: FrameView_assign({ rel: "stylesheet" }, (0, index_all.isString)(href) ? { href } : href)
          };
        });
      };
      var prevStyles = normalize(opts.prev || canvas2.previous("styles"));
      var styles = normalize(canvas2 === null || canvas2 === void 0 ? void 0 : canvas2.get("styles"));
      var toRemove = [];
      var toAdd = [];
      var find = function(items, stack, res) {
        items.forEach(function(item) {
          var href = item.attributes.href;
          var has = stack.some(function(s) {
            return s.attributes.href === href;
          });
          !has && res.push(item);
        });
      };
      find(styles, prevStyles, toAdd);
      find(prevStyles, styles, toRemove);
      toRemove.forEach(function(stl) {
        var _a2;
        var el = head.querySelector('link[href="'.concat(stl.attributes.href, '"]'));
        (_a2 = el === null || el === void 0 ? void 0 : el.parentNode) === null || _a2 === void 0 ? void 0 : _a2.removeChild(el);
      });
      (0, dom.af)(head, toAdd);
    };
    FrameView2.prototype.renderHead = function() {
      var _a2;
      var _b = this, model = _b.model, em = _b.em;
      var root = model.root;
      var HeadView = (_a2 = em === null || em === void 0 ? void 0 : em.Components) === null || _a2 === void 0 ? void 0 : _a2.getType(type).view;
      if (!HeadView)
        return;
      this.headView = new HeadView({
        el: this.getHead(),
        model: root.head,
        config: FrameView_assign(FrameView_assign({}, root.config), { frameView: this })
      }).render();
    };
    FrameView2.prototype.renderBody = function() {
      var _this = this;
      var _a2, _b, _c;
      var _d = this, config2 = _d.config, em = _d.em, model = _d.model, ppfx = _d.ppfx;
      var doc = this.getDoc();
      var body = this.getBody();
      var win = this.getWindow();
      var hasAutoHeight = model.hasAutoHeight();
      var conf = em.config;
      win._isEditor = true;
      this.renderStyles({ prev: [] });
      var colorWarn = "#ffca6f";
      (0, dom.BC)(body, "<style>\n      ".concat(conf.baseCss || config2.frameStyle || "", "\n\n      ").concat(hasAutoHeight ? "body { overflow: hidden }" : "", '\n\n      [data-gjs-type="wrapper"] {\n        ').concat(!hasAutoHeight ? "min-height: 100vh;" : "", "\n        padding-top: 0.001em;\n      }\n\n      .").concat(ppfx, "dashed *[data-gjs-highlightable] {\n        outline: 1px dashed rgba(170,170,170,0.7);\n        outline-offset: -2px;\n      }\n\n      .").concat(ppfx, "selected {\n        outline: 2px solid #3b97e3 !important;\n        outline-offset: -2px;\n      }\n\n      .").concat(ppfx, "selected-parent {\n        outline: 2px solid ").concat(colorWarn, " !important\n      }\n\n      .").concat(ppfx, "no-select {\n        user-select: none;\n        -webkit-user-select:none;\n        -moz-user-select: none;\n      }\n\n      .").concat(ppfx, "freezed {\n        opacity: 0.5;\n        pointer-events: none;\n      }\n\n      .").concat(ppfx, "no-pointer {\n        pointer-events: none;\n      }\n\n      .").concat(ppfx, "pointer-init {\n        pointer-events: initial;\n      }\n\n      .").concat(ppfx, "plh-image {\n        background: #f5f5f5;\n        border: none;\n        height: 100px;\n        width: 100px;\n        display: block;\n        outline: 3px solid #ffca6f;\n        cursor: pointer;\n        outline-offset: -2px\n      }\n\n      .").concat(ppfx, "grabbing {\n        cursor: grabbing;\n        cursor: -webkit-grabbing;\n      }\n\n      .").concat(ppfx, "is__grabbing {\n        overflow-x: hidden;\n      }\n\n      .").concat(ppfx, "is__grabbing,\n      .").concat(ppfx, "is__grabbing * {\n        cursor: grabbing !important;\n      }\n\n      ").concat(conf.canvasCss || "", "\n      ").concat(conf.protectedCss || "", "\n    </style>"));
      var root = model.root;
      var view = (((_a2 = em === null || em === void 0 ? void 0 : em.Components) === null || _a2 === void 0 ? void 0 : _a2.getType("wrapper")) || {}).view;
      if (!view)
        return;
      this.wrapper = new view({
        model: root,
        config: FrameView_assign(FrameView_assign({}, root.config), { em, frameView: this })
      }).render();
      (0, dom.BC)(body, (_b = this.wrapper) === null || _b === void 0 ? void 0 : _b.el);
      (0, dom.BC)(body, new view_CssRulesView({
        collection: model.getStyles(),
        //@ts-ignore
        config: FrameView_assign(FrameView_assign({}, em.Css.getConfig()), { frameView: this })
      }).render().el);
      (0, dom.BC)(body, this.getJsContainer());
      (0, dom.on)(body, "click", function(ev) {
        var _a3;
        return ev && ((_a3 = ev.target) === null || _a3 === void 0 ? void 0 : _a3.tagName) == "A" && ev.preventDefault();
      });
      (0, dom.on)(body, "submit", function(ev) {
        return ev && ev.preventDefault();
      });
      [
        { event: "keydown keyup keypress", class: "KeyboardEvent" },
        { event: "mousedown mousemove mouseup", class: "MouseEvent" },
        { event: "pointerdown pointermove pointerup", class: "PointerEvent" },
        { event: "wheel", class: "WheelEvent", opts: { passive: !config2.infiniteCanvas } }
      ].forEach(function(obj) {
        return obj.event.split(" ").forEach(function(event) {
          doc.addEventListener(event, function(ev) {
            return _this.el.dispatchEvent((0, dom.yL)(ev, obj.class));
          }, obj.opts);
        });
      });
      this._toggleEffects(true);
      if ((0, mixins.hasDnd)(em)) {
        this.droppable = new utils_Droppable(em, (_c = this.wrapper) === null || _c === void 0 ? void 0 : _c.el);
      }
      this.loaded = true;
      model.trigger("loaded");
    };
    FrameView2.prototype._toggleEffects = function(enable) {
      var method = enable ? dom.on : dom.AU;
      var win = this.getWindow();
      win && method(win, "".concat(dom.D8, " resize"), this._emitUpdate);
    };
    FrameView2.prototype._emitUpdate = function() {
      this.model._emitUpdated();
    };
    return FrameView2;
  }(abstract_ModuleView)
);
var view_FrameView = FrameView;
var Dragger = __webpack_require__(14);
var FrameWrapView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var FrameWrapView_assign = function() {
  FrameWrapView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return FrameWrapView_assign.apply(this, arguments);
};
var FrameWrapView = (
  /** @class */
  function(_super) {
    FrameWrapView_extends(FrameWrapView2, _super);
    function FrameWrapView2(model, canvasView) {
      var _this = _super.call(this, { model }) || this;
      (0, index_all.bindAll)(_this, "onScroll", "frameLoaded", "updateOffset", "remove", "startDrag");
      var config2 = FrameWrapView_assign(FrameWrapView_assign({}, model.config), { frameWrapView: _this });
      _this.cv = canvasView;
      _this.frame = new view_FrameView(model, _this);
      _this.classAnim = "".concat(_this.ppfx, "frame-wrapper--anim");
      _this.updateOffset = (0, index_all.debounce)(_this.updateOffset.bind(_this), 0);
      _this.updateSize = (0, index_all.debounce)(_this.updateSize.bind(_this), 0);
      _this.listenTo(model, "loaded", _this.frameLoaded);
      _this.listenTo(model, "change:x change:y", _this.updatePos);
      _this.listenTo(model, "change:width change:height", _this.updateSize);
      _this.listenTo(model, "destroy remove", _this.remove);
      _this.updatePos();
      _this.setupDragger();
      return _this;
    }
    FrameWrapView2.prototype.events = function() {
      return {
        "click [data-action-remove]": "remove",
        "mousedown [data-action-move]": "startDrag"
      };
    };
    FrameWrapView2.prototype.setupDragger = function() {
      var _this = this;
      var _a2 = this, module = _a2.module, model = _a2.model;
      var dragX, dragY, zoom;
      var toggleEffects = function(on) {
        module.toggleFramesEvents(on);
      };
      this.dragger = new Dragger.A({
        onStart: function() {
          var _a3 = model.attributes, x = _a3.x, y = _a3.y;
          zoom = _this.em.getZoomMultiplier();
          dragX = x;
          dragY = y;
          toggleEffects(false);
        },
        onEnd: function() {
          return toggleEffects(true);
        },
        setPosition: function(posOpts) {
          model.set({
            x: dragX + posOpts.x * zoom,
            y: dragY + posOpts.y * zoom
          });
        }
      });
    };
    FrameWrapView2.prototype.startDrag = function(ev) {
      var _a2;
      ev && ((_a2 = this.dragger) === null || _a2 === void 0 ? void 0 : _a2.start(ev));
    };
    FrameWrapView2.prototype.__clear = function(opts) {
      var frame = this.frame;
      frame && frame.remove(opts);
      (0, dom.YZ)(this.elTools);
    };
    FrameWrapView2.prototype.remove = function(opts) {
      var _this = this;
      this.__clear(opts);
      abstract_ModuleView.prototype.remove.apply(this, opts);
      ["frame", "dragger", "cv", "elTools"].forEach(function(i) {
        return _this[i] = 0;
      });
      return this;
    };
    FrameWrapView2.prototype.updateOffset = function() {
      var _a2;
      var _b = this, em = _b.em, $el = _b.$el, frame = _b.frame;
      if (!em || em.destroyed)
        return;
      em.runDefault({ preserveSelected: 1 });
      $el.removeClass(this.classAnim);
      (_a2 = frame === null || frame === void 0 ? void 0 : frame.model) === null || _a2 === void 0 ? void 0 : _a2._emitUpdated();
    };
    FrameWrapView2.prototype.updatePos = function(md) {
      var _a2 = this, model = _a2.model, el = _a2.el;
      var _b = model.attributes, x = _b.x, y = _b.y;
      var style = el.style;
      this.frame.rect = void 0;
      style.left = isNaN(x) ? x : "".concat(x, "px");
      style.top = isNaN(y) ? y : "".concat(y, "px");
      md && this.updateOffset();
    };
    FrameWrapView2.prototype.updateSize = function() {
      this.updateDim();
    };
    FrameWrapView2.prototype.updateDim = function() {
      var _a2 = this, em = _a2.em, el = _a2.el, $el = _a2.$el, model = _a2.model, classAnim = _a2.classAnim, frame = _a2.frame;
      if (!frame)
        return;
      frame.rect = void 0;
      $el.addClass(classAnim);
      var _b = this.__handleSize(), noChanges = _b.noChanges, width = _b.width, height = _b.height;
      if ((0, index_all.isNull)(width) || (0, index_all.isNull)(height)) {
        model.set(FrameWrapView_assign(FrameWrapView_assign({}, !width ? { width: el.offsetWidth } : {}), !height ? { height: el.offsetHeight } : {}), { silent: 1 });
      }
      em.stopDefault({ preserveSelected: 1 });
      noChanges ? this.updateOffset() : setTimeout(this.updateOffset, 350);
    };
    FrameWrapView2.prototype.onScroll = function() {
      var _a2 = this, frame = _a2.frame, em = _a2.em;
      em.trigger("frame:scroll", {
        frame,
        body: frame.getBody(),
        target: frame.getWindow()
      });
    };
    FrameWrapView2.prototype.frameLoaded = function() {
      var _a2 = this, frame = _a2.frame, config2 = _a2.config;
      frame.getWindow().onscroll = this.onScroll;
      this.updateDim();
    };
    FrameWrapView2.prototype.__handleSize = function() {
      var _a2, _b;
      var un = "px";
      var _c = this, model = _c.model, el = _c.el;
      var style = el.style;
      var _d = model.attributes, width = _d.width, height = _d.height;
      var currW = style.width || "";
      var currH = style.height || "";
      var newW = width || "";
      var newH = height || "";
      var noChanges = currW == newW && currH == newH;
      var newWidth = (0, index_all.isNumber)(newW) ? "".concat(newW).concat(un) : newW;
      var newHeight = (0, index_all.isNumber)(newH) ? "".concat(newH).concat(un) : newH;
      style.width = newWidth;
      if (model.hasAutoHeight()) {
        var iframe = this.frame.el;
        if (iframe.contentDocument) {
          var contentDocument_1 = iframe.contentDocument;
          var observer = new ResizeObserver(function() {
            style.height = "".concat(contentDocument_1.body.scrollHeight, "px");
          });
          observer.observe(contentDocument_1.body);
          (_a2 = this.sizeObserver) === null || _a2 === void 0 ? void 0 : _a2.disconnect();
          this.sizeObserver = observer;
        }
      } else {
        style.height = newHeight;
        (_b = this.sizeObserver) === null || _b === void 0 ? void 0 : _b.disconnect();
        delete this.sizeObserver;
      }
      return { noChanges, width, height, newW, newH };
    };
    FrameWrapView2.prototype.render = function() {
      var _a2 = this, frame = _a2.frame, $el = _a2.$el, ppfx = _a2.ppfx, cv = _a2.cv, model = _a2.model, el = _a2.el;
      var onRender = model.attributes.onRender;
      this.__clear();
      this.__handleSize();
      frame.render();
      $el.empty().attr({ class: "".concat(ppfx, "frame-wrapper") }).append('\n      <div class="'.concat(ppfx, 'frame-wrapper__top gjs-two-color" data-frame-top>\n        <div class="').concat(ppfx, 'frame-wrapper__name" data-action-move>\n          ').concat(model.get("name") || "", '\n        </div>\n        <div class="').concat(ppfx, 'frame-wrapper__top-r">\n          <div class="').concat(ppfx, 'frame-wrapper__icon" data-action-remove style="display: none">\n            <svg viewBox="0 0 24 24"><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"></path></svg>\n          </div>\n        </div>\n      </div>\n      <div class="').concat(ppfx, 'frame-wrapper__right" data-frame-right></div>\n      <div class="').concat(ppfx, 'frame-wrapper__left" data-frame-left></div>\n      <div class="').concat(ppfx, 'frame-wrapper__bottom" data-frame-bottom></div>\n      ')).append(frame.el);
      var elTools = (0, dom.a_)("div", {
        class: "".concat(ppfx, "tools"),
        style: "pointer-events:none; display: none"
      }, '\n      <div class="'.concat(ppfx, 'highlighter" data-hl></div>\n      <div class="').concat(ppfx, 'badge" data-badge></div>\n      <div class="').concat(ppfx, 'placeholder">\n        <div class="').concat(ppfx, 'placeholder-int"></div>\n      </div>\n      <div class="').concat(ppfx, 'ghost"></div>\n      <div class="').concat(ppfx, 'toolbar" style="pointer-events:all"></div>\n      <div class="').concat(ppfx, 'resizer"></div>\n      <div class="').concat(ppfx, 'offset-v" data-offset>\n        <div class="gjs-marginName" data-offset-m>\n          <div class="gjs-margin-v-el gjs-margin-v-top" data-offset-m-t></div>\n          <div class="gjs-margin-v-el gjs-margin-v-bottom" data-offset-m-b></div>\n          <div class="gjs-margin-v-el gjs-margin-v-left" data-offset-m-l></div>\n          <div class="gjs-margin-v-el gjs-margin-v-right" data-offset-m-r></div>\n        </div>\n        <div class="gjs-paddingName" data-offset-m>\n          <div class="gjs-padding-v-el gjs-padding-v-top" data-offset-p-t></div>\n          <div class="gjs-padding-v-el gjs-padding-v-bottom" data-offset-p-b></div>\n          <div class="gjs-padding-v-el gjs-padding-v-left" data-offset-p-l></div>\n          <div class="gjs-padding-v-el gjs-padding-v-right" data-offset-p-r></div>\n        </div>\n      </div>\n      <div class="').concat(ppfx, 'offset-fixed-v"></div>\n    '));
      this.elTools = elTools;
      var twrp = cv === null || cv === void 0 ? void 0 : cv.toolsWrapper;
      twrp && twrp.appendChild(elTools);
      onRender && onRender({
        el,
        elTop: el.querySelector("[data-frame-top]"),
        elRight: el.querySelector("[data-frame-right]"),
        elBottom: el.querySelector("[data-frame-bottom]"),
        elLeft: el.querySelector("[data-frame-left]"),
        frame: model,
        frameWrapperView: this,
        remove: this.remove,
        startDrag: this.startDrag
      });
      return this;
    };
    return FrameWrapView2;
  }(abstract_ModuleView)
);
var view_FrameWrapView = FrameWrapView;
var FramesView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var FramesView = (
  /** @class */
  function(_super) {
    FramesView_extends(FramesView2, _super);
    function FramesView2(opts, config2) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, opts, true) || this;
      _this.listenTo(_this.collection, "reset", _this.render);
      _this.canvasView = config2.canvasView;
      _this._module = config2.module;
      return _this;
    }
    FramesView2.prototype.onRemoveBefore = function(items, opts) {
      if (opts === void 0) {
        opts = {};
      }
      items.forEach(function(item) {
        return item.remove(opts);
      });
    };
    FramesView2.prototype.onRender = function() {
      var _a2 = this, $el = _a2.$el, ppfx = _a2.ppfx;
      $el.attr({ class: "".concat(ppfx, "frames") });
    };
    FramesView2.prototype.clearItems = function() {
      var items = this.viewCollection || [];
      items.forEach(function(item) {
        return item.remove();
      });
      this.viewCollection = [];
    };
    FramesView2.prototype.renderView = function(item, type2) {
      return new view_FrameWrapView(item, this.canvasView);
    };
    return FramesView2;
  }(abstract_ModuleDomainViews)
);
var view_FramesView = FramesView;
var CanvasView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CanvasView_assign = function() {
  CanvasView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return CanvasView_assign.apply(this, arguments);
};
var CanvasView = (
  /** @class */
  function(_super) {
    CanvasView_extends(CanvasView2, _super);
    function CanvasView2(model) {
      var _this = _super.call(this, { model }) || this;
      _this.ready = false;
      (0, index_all.bindAll)(_this, "clearOff", "onKeyPress", "onWheel", "onPointer");
      var _a2 = _this, em = _a2.em, pfx = _a2.pfx, ppfx = _a2.ppfx;
      var events2 = _this.module.events;
      _this.className = "".concat(pfx, "canvas ").concat(ppfx, "no-touch-actions").concat(!em.config.customUI ? " ".concat(pfx, "canvas-bg") : "");
      _this.clsUnscale = "".concat(pfx, "unscale");
      _this._initFrames();
      _this.listenTo(em, events2.refresh, _this.clearOff);
      _this.listenTo(em, "component:selected", _this.checkSelected);
      _this.listenTo(em, "".concat(events2.coords, " ").concat(events2.zoom), _this.updateFrames);
      _this.listenTo(model, "change:frames", _this._onFramesUpdate);
      _this.toggleListeners(true);
      return _this;
    }
    CanvasView2.prototype.template = function() {
      var pfx = this.pfx;
      return '\n      <div class="'.concat(pfx, 'canvas__frames" data-frames>\n        <div class="').concat(pfx, 'canvas__spots" data-spots></div>\n      </div>\n      <div id="').concat(pfx, 'tools" class="').concat(pfx, 'canvas__tools" data-tools></div>\n      <style data-canvas-style></style>\n    ');
    };
    CanvasView2.prototype._onFramesUpdate = function() {
      this._initFrames();
      this._renderFrames();
    };
    CanvasView2.prototype._initFrames = function() {
      var _a2 = this, frames = _a2.frames, model = _a2.model, config2 = _a2.config, em = _a2.em;
      var collection = model.frames;
      em.set("readyCanvas", 0);
      collection.once("loaded:all", function() {
        return em.set("readyCanvas", 1);
      });
      frames === null || frames === void 0 ? void 0 : frames.remove();
      this.frames = new view_FramesView({ collection }, CanvasView_assign(CanvasView_assign({}, config2), { canvasView: this }));
    };
    CanvasView2.prototype.checkSelected = function(component, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var scroll = opts.scroll;
      var currFrame = this.em.getCurrentFrame();
      scroll && ((_a2 = component.views) === null || _a2 === void 0 ? void 0 : _a2.forEach(function(view) {
        view.frameView === currFrame && view.scrollIntoView(scroll);
      }));
    };
    CanvasView2.prototype.remove = function() {
      var _a2;
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      (_a2 = this.frames) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.frames = void 0;
      abstract_ModuleView.prototype.remove.apply(this, args);
      this.toggleListeners(false);
      return this;
    };
    CanvasView2.prototype.preventDefault = function(ev) {
      var _a2;
      if (ev) {
        ev.preventDefault();
        (_a2 = ev._parentEvent) === null || _a2 === void 0 ? void 0 : _a2.preventDefault();
      }
    };
    CanvasView2.prototype.toggleListeners = function(enable) {
      var _a2 = this, el = _a2.el, config2 = _a2.config;
      var fn = enable ? dom.on : dom.AU;
      fn(document, "keypress", this.onKeyPress);
      fn(window, "scroll resize", this.clearOff);
      fn(el, "wheel", this.onWheel, { passive: !config2.infiniteCanvas });
      fn(el, "pointermove", this.onPointer);
    };
    CanvasView2.prototype.screenToWorld = function(x, y) {
      var module = this.module;
      var coords = module.getCoords();
      var zoom = module.getZoomMultiplier();
      var vwDelta = this.getViewportDelta();
      return {
        x: (x - coords.x - vwDelta.x) * zoom,
        y: (y - coords.y - vwDelta.y) * zoom
      };
    };
    CanvasView2.prototype.onPointer = function(ev) {
      if (!this.config.infiniteCanvas)
        return;
      var canvasRect = this.getCanvasOffset();
      var docScroll = (0, dom.Xy)();
      var screenCoords = {
        x: ev.clientX - canvasRect.left + docScroll.x,
        y: ev.clientY - canvasRect.top + docScroll.y
      };
      if (ev._parentEvent) {
        var frameRect = ev.target.getBoundingClientRect();
        var zoom = this.module.getZoomDecimal();
        screenCoords.x = frameRect.left - canvasRect.left + docScroll.x + ev.clientX * zoom;
        screenCoords.y = frameRect.top - canvasRect.top + docScroll.y + ev.clientY * zoom;
      }
      this.model.set({
        pointerScreen: screenCoords,
        pointer: this.screenToWorld(screenCoords.x, screenCoords.y)
      });
    };
    CanvasView2.prototype.onKeyPress = function(ev) {
      var em = this.em;
      var key = (0, dom.Ch)(ev);
      if (key === " " && em.getZoomDecimal() !== 1 && !em.Canvas.isInputFocused()) {
        this.preventDefault(ev);
        em.Editor.runCommand("core:canvas-move");
      }
    };
    CanvasView2.prototype.onWheel = function(ev) {
      var _a2 = this, module = _a2.module, config2 = _a2.config;
      if (config2.infiniteCanvas) {
        this.preventDefault(ev);
        var deltaX = ev.deltaX, deltaY = ev.deltaY;
        var zoom = module.getZoomDecimal();
        var isZooming = (0, dom.rp)(ev);
        var coords = module.getCoords();
        if (isZooming) {
          var newZoom = zoom - deltaY * zoom * 0.01;
          module.setZoom(newZoom * 100);
          var pointer = this.model.getPointerCoords(common.x2.Screen);
          var canvasRect = this.getCanvasOffset();
          var pointerX = pointer.x - canvasRect.width / 2;
          var pointerY = pointer.y - canvasRect.height / 2;
          var zoomDelta = newZoom / zoom;
          var x = pointerX - (pointerX - coords.x) * zoomDelta;
          var y = pointerY - (pointerY - coords.y) * zoomDelta;
          module.setCoords(x, y);
        } else {
          this.onPointer(ev);
          module.setCoords(coords.x - deltaX, coords.y - deltaY);
        }
      }
    };
    CanvasView2.prototype.updateFrames = function(ev) {
      var em = this.em;
      var toolsWrpEl = this.toolsWrapper;
      var defOpts = { preserveSelected: 1 };
      this.updateFramesArea();
      this.clearOff();
      toolsWrpEl.style.display = "none";
      em.trigger("canvas:update", ev);
      this.timerZoom && clearTimeout(this.timerZoom);
      this.timerZoom = setTimeout(function() {
        em.stopDefault(defOpts);
        em.runDefault(defOpts);
        toolsWrpEl.style.display = "";
      }, 300);
    };
    CanvasView2.prototype.updateFramesArea = function() {
      var _a2 = this, framesArea = _a2.framesArea, model = _a2.model, module = _a2.module, cvStyle = _a2.cvStyle, clsUnscale = _a2.clsUnscale;
      var mpl = module.getZoomMultiplier();
      if (framesArea) {
        var _b = model.attributes, x = _b.x, y = _b.y;
        var zoomDc = module.getZoomDecimal();
        framesArea.style.transform = "scale(".concat(zoomDc, ") translate(").concat(x * mpl, "px, ").concat(y * mpl, "px)");
      }
      if (cvStyle) {
        cvStyle.innerHTML = "\n        .".concat(clsUnscale, " { scale: ").concat(mpl, " }\n      ");
      }
    };
    CanvasView2.prototype.fitViewport = function(opts) {
      var _a2, _b;
      if (opts === void 0) {
        opts = {};
      }
      var _c = this, em = _c.em, module = _c.module, model = _c.model;
      var canvasRect = this.getCanvasOffset();
      var el = opts.el;
      var elFrame = el && ((_a2 = (0, mixins.getComponentView)(el)) === null || _a2 === void 0 ? void 0 : _a2.frameView);
      var frame = elFrame ? elFrame.model : opts.frame || em.getCurrentFrameModel() || model.frames.at(0);
      var _d = frame.attributes, x = _d.x, y = _d.y;
      var boxRect = {
        x: x !== null && x !== void 0 ? x : 0,
        y: y !== null && y !== void 0 ? y : 0,
        width: frame.width,
        height: frame.height
      };
      if (el) {
        var elRect = this.getElBoxRect(el);
        boxRect.x = boxRect.x + elRect.x;
        boxRect.y = boxRect.y + elRect.y;
        boxRect.width = elRect.width;
        boxRect.height = elRect.height;
      }
      var noHeight = opts.ignoreHeight;
      var gap = (_b = opts.gap) !== null && _b !== void 0 ? _b : 0;
      var gapIsNum = (0, index_all.isNumber)(gap);
      var gapX = gapIsNum ? gap : gap.x;
      var gapY = gapIsNum ? gap : gap.y;
      var boxWidth = boxRect.width + gapX * 2;
      var boxHeight = boxRect.height + gapY * 2;
      var canvasWidth = canvasRect.width;
      var canvasHeight = canvasRect.height;
      var widthRatio = canvasWidth / boxWidth;
      var heightRatio = canvasHeight / boxHeight;
      var zoomRatio = noHeight ? widthRatio : Math.min(widthRatio, heightRatio);
      var zoom = zoomRatio * 100;
      module.setZoom(zoom);
      var coordX = -boxRect.x + (frame.width >= canvasWidth ? canvasWidth / 2 - boxWidth / 2 : -gapX);
      var coordY = -boxRect.y + canvasHeight / 2 - boxHeight / 2;
      var coords = {
        x: (coordX + gapX) * zoomRatio,
        y: (coordY + gapY) * zoomRatio
      };
      if (noHeight) {
        var zoomMltp = module.getZoomMultiplier();
        var canvasWorldHeight = canvasHeight * zoomMltp;
        var canvasHeightDiff = canvasWorldHeight - canvasHeight;
        var yDelta = canvasHeightDiff / 2;
        coords.y = (-boxRect.y + gapY) * zoomRatio - yDelta / zoomMltp;
      }
      module.setCoords(coords.x, coords.y);
    };
    CanvasView2.prototype.isElInViewport = function(el) {
      var elem = (0, mixins.getElement)(el);
      var rect = (0, dom.C8)(elem);
      var frameRect = this.getFrameOffset(elem);
      var rTop = rect.top;
      var rLeft = rect.left;
      return rTop >= 0 && rLeft >= 0 && rTop <= frameRect.height && rLeft <= frameRect.width;
    };
    CanvasView2.prototype.offset = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var noScroll = opts.noScroll;
      var rect = (0, dom.C8)(el);
      var scroll = noScroll ? { x: 0, y: 0 } : (0, dom.Xy)(el);
      return {
        top: rect.top + scroll.y,
        left: rect.left + scroll.x,
        width: rect.width,
        height: rect.height
      };
    };
    CanvasView2.prototype.getRectToScreen = function(boxRect) {
      var _a2, _b, _c, _d;
      var zoom = this.module.getZoomDecimal();
      var coords = this.module.getCoords();
      var vwDelta = this.getViewportDelta();
      var x = ((_a2 = boxRect.x) !== null && _a2 !== void 0 ? _a2 : 0) * zoom + coords.x + vwDelta.x || 0;
      var y = ((_b = boxRect.y) !== null && _b !== void 0 ? _b : 0) * zoom + coords.y + vwDelta.y || 0;
      return {
        x,
        y,
        width: ((_c = boxRect.width) !== null && _c !== void 0 ? _c : 0) * zoom,
        height: ((_d = boxRect.height) !== null && _d !== void 0 ? _d : 0) * zoom
      };
    };
    CanvasView2.prototype.getElBoxRect = function(el, opts) {
      var _a2, _b, _c;
      if (opts === void 0) {
        opts = {};
      }
      var module = this.module;
      var _d = (0, dom.C8)(el), width = _d.width, height = _d.height, left = _d.left, top = _d.top;
      var frameView = (_a2 = (0, mixins.getComponentView)(el)) === null || _a2 === void 0 ? void 0 : _a2.frameView;
      var frameRect = frameView === null || frameView === void 0 ? void 0 : frameView.getBoxRect();
      var zoomMlt = module.getZoomMultiplier();
      var frameX = (_b = frameRect === null || frameRect === void 0 ? void 0 : frameRect.x) !== null && _b !== void 0 ? _b : 0;
      var frameY = (_c = frameRect === null || frameRect === void 0 ? void 0 : frameRect.y) !== null && _c !== void 0 ? _c : 0;
      var canvasEl = this.el;
      var docScroll = (0, dom.Xy)();
      var xWithFrame = left + frameX + (canvasEl.scrollLeft + docScroll.x) * zoomMlt;
      var yWithFrame = top + frameY + (canvasEl.scrollTop + docScroll.y) * zoomMlt;
      var boxRect = {
        x: xWithFrame,
        y: yWithFrame,
        width,
        height
      };
      if (opts.local) {
        boxRect.x = left;
        boxRect.y = top;
      }
      return opts.toScreen ? this.getRectToScreen(boxRect) : boxRect;
    };
    CanvasView2.prototype.getViewportRect = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this.getCanvasOffset(), top = _a2.top, left = _a2.left, width = _a2.width, height = _a2.height;
      var module = this.module;
      if (opts.toWorld) {
        var zoom = module.getZoomMultiplier();
        var coords = module.getCoords();
        var vwDelta = this.getViewportDelta();
        var x = -coords.x - vwDelta.x || 0;
        var y = -coords.y - vwDelta.y || 0;
        return {
          x: x * zoom,
          y: y * zoom,
          width: width * zoom,
          height: height * zoom
        };
      } else {
        return {
          x: left,
          y: top,
          width,
          height
        };
      }
    };
    CanvasView2.prototype.getViewportDelta = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var zoom = this.module.getZoomMultiplier();
      var _a2 = this.getCanvasOffset(), width = _a2.width, height = _a2.height;
      var worldWidth = width * zoom;
      var worldHeight = height * zoom;
      var widthDelta = worldWidth - width;
      var heightDelta = worldHeight - height;
      return {
        x: widthDelta / 2 / zoom,
        y: heightDelta / 2 / zoom
      };
    };
    CanvasView2.prototype.clearOff = function() {
      this.frmOff = void 0;
      this.cvsOff = void 0;
    };
    CanvasView2.prototype.getFrameOffset = function(el) {
      var _a2;
      if (!this.frmOff || el) {
        var frame = (_a2 = this.frame) === null || _a2 === void 0 ? void 0 : _a2.el;
        var winEl = el === null || el === void 0 ? void 0 : el.ownerDocument.defaultView;
        var frEl = winEl ? winEl.frameElement : frame;
        this.frmOff = this.offset(frEl || frame);
      }
      return this.frmOff;
    };
    CanvasView2.prototype.getCanvasOffset = function() {
      if (!this.cvsOff)
        this.cvsOff = this.offset(this.el);
      return this.cvsOff;
    };
    CanvasView2.prototype.getElementPos = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var zoom = this.module.getZoomDecimal();
      var frameOffset = this.getFrameOffset(el);
      var canvasEl = this.el;
      var canvasOffset = this.getCanvasOffset();
      var elRect = this.offset(el, opts);
      var frameTop = opts.avoidFrameOffset ? 0 : frameOffset.top;
      var frameLeft = opts.avoidFrameOffset ? 0 : frameOffset.left;
      var elTop = opts.avoidFrameZoom ? elRect.top : elRect.top * zoom;
      var elLeft = opts.avoidFrameZoom ? elRect.left : elRect.left * zoom;
      var top = opts.avoidFrameOffset ? elTop : elTop + frameTop - canvasOffset.top + canvasEl.scrollTop;
      var left = opts.avoidFrameOffset ? elLeft : elLeft + frameLeft - canvasOffset.left + canvasEl.scrollLeft;
      var height = opts.avoidFrameZoom ? elRect.height : elRect.height * zoom;
      var width = opts.avoidFrameZoom ? elRect.width : elRect.width * zoom;
      return { top, left, height, width, zoom, rect: elRect };
    };
    CanvasView2.prototype.getElementOffsets = function(el) {
      if (!el || (0, dom.ir)(el))
        return {};
      var result = {};
      var styles = window.getComputedStyle(el);
      var zoom = this.module.getZoomDecimal();
      var marginPaddingOffsets = [
        "marginTop",
        "marginRight",
        "marginBottom",
        "marginLeft",
        "paddingTop",
        "paddingRight",
        "paddingBottom",
        "paddingLeft",
        "borderTopWidth",
        "borderRightWidth",
        "borderBottomWidth",
        "borderLeftWidth"
      ];
      marginPaddingOffsets.forEach(function(offset) {
        result[offset] = parseFloat(styles[offset]) * zoom;
      });
      return result;
    };
    CanvasView2.prototype.getPosition = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var doc = (_a2 = this.frame) === null || _a2 === void 0 ? void 0 : _a2.el.contentDocument;
      if (!doc) {
        return {
          top: 0,
          left: 0,
          width: 0,
          height: 0
        };
      }
      var bEl = doc.body;
      var zoom = this.module.getZoomDecimal();
      var fo = this.getFrameOffset();
      var co = this.getCanvasOffset();
      var noScroll = opts.noScroll;
      return {
        top: fo.top + (noScroll ? 0 : bEl.scrollTop) * zoom - co.top,
        left: fo.left + (noScroll ? 0 : bEl.scrollLeft) * zoom - co.left,
        width: co.width,
        height: co.height
      };
    };
    CanvasView2.prototype.updateScript = function(view) {
      var model = view.model;
      var id = model.getId();
      if (!view.scriptContainer) {
        view.scriptContainer = (0, dom.a_)("div", { "data-id": id });
        var jsEl = this.getJsContainer();
        jsEl === null || jsEl === void 0 ? void 0 : jsEl.appendChild(view.scriptContainer);
      }
      view.el.id = id;
      view.scriptContainer.innerHTML = "";
      var script = document.createElement("script");
      var scriptFn = model.getScriptString();
      var scriptFnStr = model.get("script-props") ? scriptFn : "function(){\n".concat(scriptFn, "\n;}");
      var scriptProps = JSON.stringify(model.__getScriptProps());
      script.innerHTML = "\n      setTimeout(function() {\n        var item = document.getElementById('".concat(id, "');\n        if (!item) return;\n        (").concat(scriptFnStr, ".bind(item))(").concat(scriptProps, ")\n      }, 1);");
      setTimeout(function() {
        var scr = view.scriptContainer;
        scr === null || scr === void 0 ? void 0 : scr.appendChild(script);
      }, 0);
    };
    CanvasView2.prototype.getJsContainer = function(view) {
      var frameView = this.getFrameView(view);
      return frameView === null || frameView === void 0 ? void 0 : frameView.getJsContainer();
    };
    CanvasView2.prototype.getFrameView = function(view) {
      return (view === null || view === void 0 ? void 0 : view.frameView) || this.em.getCurrentFrame();
    };
    CanvasView2.prototype._renderFrames = function() {
      if (!this.ready)
        return;
      var _a2 = this, model = _a2.model, frames = _a2.frames, em = _a2.em, framesArea = _a2.framesArea;
      var frms = model.frames;
      frms.listenToLoad();
      frames.render();
      var mainFrame = frms.at(0);
      var currFrame = mainFrame === null || mainFrame === void 0 ? void 0 : mainFrame.view;
      em.setCurrentFrame(currFrame);
      framesArea === null || framesArea === void 0 ? void 0 : framesArea.appendChild(frames.el);
      this.frame = currFrame;
      this.updateFramesArea();
    };
    CanvasView2.prototype.renderFrames = function() {
      this._renderFrames();
    };
    CanvasView2.prototype.render = function() {
      var _a2 = this, el = _a2.el, $el = _a2.$el, ppfx = _a2.ppfx, config2 = _a2.config, em = _a2.em;
      $el.html(this.template());
      var $frames = $el.find("[data-frames]");
      this.framesArea = $frames.get(0);
      var toolsWrp = $el.find("[data-tools]");
      this.toolsWrapper = toolsWrp.get(0);
      toolsWrp.append('\n      <div class="'.concat(ppfx, "tools ").concat(ppfx, 'tools-gl" style="pointer-events:none">\n        <div class="').concat(ppfx, 'placeholder">\n          <div class="').concat(ppfx, 'placeholder-int"></div>\n        </div>\n      </div>\n      <div id="').concat(ppfx, 'tools" style="pointer-events:none">\n        ').concat(config2.extHl ? '<div class="'.concat(ppfx, 'highlighter-sel"></div>') : "", '\n        <div class="').concat(ppfx, 'badge"></div>\n        <div class="').concat(ppfx, 'ghost"></div>\n        <div class="').concat(ppfx, 'toolbar" style="pointer-events:all"></div>\n        <div class="').concat(ppfx, 'resizer"></div>\n        <div class="').concat(ppfx, 'offset-v"></div>\n        <div class="').concat(ppfx, 'offset-fixed-v"></div>\n      </div>\n    '));
      this.toolsEl = el.querySelector("#".concat(ppfx, "tools"));
      this.hlEl = el.querySelector(".".concat(ppfx, "highlighter"));
      this.badgeEl = el.querySelector(".".concat(ppfx, "badge"));
      this.placerEl = el.querySelector(".".concat(ppfx, "placeholder"));
      this.ghostEl = el.querySelector(".".concat(ppfx, "ghost"));
      this.toolbarEl = el.querySelector(".".concat(ppfx, "toolbar"));
      this.resizerEl = el.querySelector(".".concat(ppfx, "resizer"));
      this.offsetEl = el.querySelector(".".concat(ppfx, "offset-v"));
      this.fixedOffsetEl = el.querySelector(".".concat(ppfx, "offset-fixed-v"));
      this.toolsGlobEl = el.querySelector(".".concat(ppfx, "tools-gl"));
      this.spotsEl = el.querySelector("[data-spots]");
      this.cvStyle = el.querySelector("[data-canvas-style]");
      this.el.className = (0, mixins.getUiClass)(em, this.className);
      this.ready = true;
      this._renderFrames();
      return this;
    };
    return CanvasView2;
  }(abstract_ModuleView)
);
var view_CanvasView = CanvasView;
var canvas_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var canvas_assign = function() {
  canvas_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return canvas_assign.apply(this, arguments);
};
var canvas_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var CanvasModule = (
  /** @class */
  function(_super) {
    canvas_extends(CanvasModule2, _super);
    function CanvasModule2(em) {
      var _this = _super.call(this, em, "Canvas", canvas_config_config) || this;
      _this.events = CanvasEvents;
      _this.framesById = {};
      _this.canvas = new model_Canvas(_this);
      _this.spots = new model_CanvasSpots(_this);
      _this.model = _this.canvas;
      _this.startAutoscroll = _this.startAutoscroll.bind(_this);
      _this.stopAutoscroll = _this.stopAutoscroll.bind(_this);
      return _this;
    }
    CanvasModule2.prototype.getCanvasView = function() {
      return this.canvasView;
    };
    CanvasModule2.prototype.postLoad = function() {
      this.model.init();
    };
    CanvasModule2.prototype.getModel = function() {
      return this.canvas;
    };
    CanvasModule2.prototype.getElement = function() {
      return this.getCanvasView().el;
    };
    CanvasModule2.prototype.getFrame = function(index2) {
      return this.getFrames()[index2 || 0];
    };
    CanvasModule2.prototype.getFrameEl = function() {
      var frame = (this.canvasView || {}).frame;
      return frame === null || frame === void 0 ? void 0 : frame.el;
    };
    CanvasModule2.prototype.getFramesEl = function() {
      var _a2;
      return (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.framesArea;
    };
    CanvasModule2.prototype.getWindow = function() {
      var frame = (this.canvasView || {}).frame;
      return frame === null || frame === void 0 ? void 0 : frame.getWindow();
    };
    CanvasModule2.prototype.getDocument = function() {
      var frame = this.getFrameEl();
      return frame === null || frame === void 0 ? void 0 : frame.contentDocument;
    };
    CanvasModule2.prototype.getBody = function() {
      var doc = this.getDocument();
      return doc === null || doc === void 0 ? void 0 : doc.body;
    };
    CanvasModule2.prototype._getLocalEl = function(globalEl, compView, method) {
      var result = globalEl;
      var frameView = compView === null || compView === void 0 ? void 0 : compView.frameView;
      result = frameView ? frameView[method]() : result;
      return result;
    };
    CanvasModule2.prototype.getGlobalToolsEl = function() {
      var _a2;
      return (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.toolsGlobEl;
    };
    CanvasModule2.prototype.getToolsEl = function(compView) {
      return this._getLocalEl(this.getCanvasView().toolsEl, compView, "getToolsEl");
    };
    CanvasModule2.prototype.getHighlighter = function(compView) {
      return this._getLocalEl(this.getCanvasView().hlEl, compView, "getHighlighter");
    };
    CanvasModule2.prototype.getBadgeEl = function(compView) {
      return this._getLocalEl(this.getCanvasView().badgeEl, compView, "getBadgeEl");
    };
    CanvasModule2.prototype.getPlacerEl = function() {
      return this.getCanvasView().placerEl;
    };
    CanvasModule2.prototype.getGhostEl = function() {
      return this.getCanvasView().ghostEl;
    };
    CanvasModule2.prototype.getToolbarEl = function() {
      return this.getCanvasView().toolbarEl;
    };
    CanvasModule2.prototype.getResizerEl = function() {
      return this.getCanvasView().resizerEl;
    };
    CanvasModule2.prototype.getOffsetViewerEl = function(compView) {
      return this._getLocalEl(this.getCanvasView().offsetEl, compView, "getOffsetViewerEl");
    };
    CanvasModule2.prototype.getFixedOffsetViewerEl = function() {
      return this.getCanvasView().fixedOffsetEl;
    };
    CanvasModule2.prototype.getSpotsEl = function() {
      var _a2;
      return (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.spotsEl;
    };
    CanvasModule2.prototype.render = function() {
      var _a2;
      (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.canvasView = new view_CanvasView(this.canvas);
      return this.canvasView.render().el;
    };
    CanvasModule2.prototype.getOffset = function() {
      var frameOff = this.offset(this.getFrameEl());
      var canvasOff = this.offset(this.getElement());
      return {
        top: frameOff.top - canvasOff.top,
        left: frameOff.left - canvasOff.left
      };
    };
    CanvasModule2.prototype.offset = function(el) {
      return this.getCanvasView().offset(el);
    };
    CanvasModule2.prototype.setCustomBadgeLabel = function(f) {
      this.config.customBadgeLabel = f;
    };
    CanvasModule2.prototype.getElementPos = function(el, opts) {
      return this.getCanvasView().getElementPos(el, opts);
    };
    CanvasModule2.prototype.getElementOffsets = function(el) {
      return this.getCanvasView().getElementOffsets(el);
    };
    CanvasModule2.prototype.getRect = function() {
      var _a2;
      var _b = (_a2 = this.getCanvasView().getPosition()) !== null && _a2 !== void 0 ? _a2 : {}, _c = _b.top, top = _c === void 0 ? 0 : _c, _d = _b.left, left = _d === void 0 ? 0 : _d;
      return canvas_assign(canvas_assign({}, this.getCanvasView().getCanvasOffset()), { topScroll: top, leftScroll: left });
    };
    CanvasModule2.prototype.getTargetToElementDim = function(target, element, options) {
      if (options === void 0) {
        options = {};
      }
      var opts = options || {};
      var canvasPos = this.getCanvasView().getPosition();
      if (!canvasPos)
        return;
      var pos = opts.elPos || this.getCanvasView().getElementPos(element);
      var toRight = options.toRight || 0;
      var targetHeight = opts.targetHeight || target.offsetHeight;
      var targetWidth = opts.targetWidth || target.offsetWidth;
      var eventToTrigger = opts.event || null;
      var elTop = pos.top - targetHeight;
      var elLeft = pos.left;
      elLeft += toRight ? pos.width : 0;
      elLeft = toRight ? elLeft - targetWidth : elLeft;
      var leftPos = elLeft < canvasPos.left ? canvasPos.left : elLeft;
      var topPos = elTop < canvasPos.top ? canvasPos.top : elTop;
      topPos = topPos > pos.top + pos.height ? pos.top + pos.height : topPos;
      var result = {
        top: topPos,
        left: leftPos,
        elementTop: pos.top,
        elementLeft: pos.left,
        elementWidth: pos.width,
        elementHeight: pos.height,
        targetWidth: target.offsetWidth,
        targetHeight: target.offsetHeight,
        canvasTop: canvasPos.top,
        canvasLeft: canvasPos.left,
        canvasWidth: canvasPos.width,
        canvasHeight: canvasPos.height
      };
      if (eventToTrigger && this.em) {
        this.em.trigger(eventToTrigger, result);
      }
      return result;
    };
    CanvasModule2.prototype.canvasRectOffset = function(el, pos, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var getFrameElFromDoc = function(doc) {
        var defaultView = doc.defaultView;
        return defaultView === null || defaultView === void 0 ? void 0 : defaultView.frameElement;
      };
      var rectOff = function(el2, top, pos2) {
        if (top === void 0) {
          top = 1;
        }
        var zoom = _this.em.getZoomDecimal();
        var side = top ? "top" : "left";
        var doc = el2.ownerDocument;
        var _a2 = opts.offset ? getFrameElFromDoc(doc) : {}, _b = _a2.offsetTop, offsetTop = _b === void 0 ? 0 : _b, _c = _a2.offsetLeft, offsetLeft = _c === void 0 ? 0 : _c;
        var _d = doc.body || {}, _e = _d.scrollTop, scrollTop = _e === void 0 ? 0 : _e, _f = _d.scrollLeft, scrollLeft = _f === void 0 ? 0 : _f;
        var scroll = top ? scrollTop : scrollLeft;
        var offset = top ? offsetTop : offsetLeft;
        return pos2[side] - (scroll - offset) * zoom;
      };
      return {
        top: rectOff(el, 1, pos),
        left: rectOff(el, 0, pos)
      };
    };
    CanvasModule2.prototype.getTargetToElementFixed = function(el, targetEl, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var elRect = opts.pos || this.getElementPos(el, { noScroll: true });
      var canvasOffset = opts.canvasOff || this.canvasRectOffset(el, elRect);
      var targetHeight = targetEl.offsetHeight || 0;
      var targetWidth = targetEl.offsetWidth || 0;
      var elRight = elRect.left + elRect.width;
      var canvasView = this.getCanvasView();
      var canvasRect = canvasView.getPosition();
      var frameOffset = canvasView.getFrameOffset(el);
      var event = opts.event;
      var top = -targetHeight;
      var left = !(0, index_all.isUndefined)(opts.left) ? opts.left : elRect.width - targetWidth;
      left = elRect.left < -left ? -elRect.left : left;
      left = elRight > canvasRect.width ? left - (elRight - canvasRect.width) : left;
      if (canvasOffset.top < targetHeight) {
        var fullHeight = elRect.height + targetHeight;
        var elIsShort = fullHeight < frameOffset.height;
        if (elIsShort) {
          top = top + fullHeight;
        } else {
          top = -canvasOffset.top < elRect.height ? -canvasOffset.top : elRect.height;
        }
      }
      var result = {
        top,
        left,
        canvasOffsetTop: canvasOffset.top,
        canvasOffsetLeft: canvasOffset.left,
        elRect,
        canvasOffset,
        canvasRect,
        targetWidth,
        targetHeight
      };
      event && this.em.trigger(event, result);
      return result;
    };
    CanvasModule2.prototype.getMouseRelativePos = function(e, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var subWinOffset = opts.subWinOffset;
      var doc = e.target.ownerDocument;
      var win = doc.defaultView || doc.parentWindow;
      var frame = win.frameElement;
      var yOffset = subWinOffset ? win.pageYOffset : 0;
      var xOffset = subWinOffset ? win.pageXOffset : 0;
      var zoomMlt = this.getZoomMultiplier();
      var addTop = 0;
      var addLeft = 0;
      if (frame) {
        var frameRect = frame.getBoundingClientRect();
        addTop = frameRect.top || 0;
        addLeft = frameRect.left || 0;
      }
      return {
        y: (e.clientY + addTop - yOffset) * zoomMlt,
        x: (e.clientX + addLeft - xOffset) * zoomMlt
      };
    };
    CanvasModule2.prototype.getMouseRelativeCanvas = function(ev, opts) {
      var _a2;
      var zoom = this.getZoomDecimal();
      var _b = (_a2 = this.getCanvasView().getPosition(opts)) !== null && _a2 !== void 0 ? _a2 : {}, _c = _b.top, top = _c === void 0 ? 0 : _c, _d = _b.left, left = _d === void 0 ? 0 : _d;
      return {
        y: ev.clientY * zoom + top,
        x: ev.clientX * zoom + left
      };
    };
    CanvasModule2.prototype.hasFocus = function() {
      return this.getDocument().hasFocus();
    };
    CanvasModule2.prototype.isInputFocused = function() {
      var doc = this.getDocument();
      var frame = this.getFrameEl();
      var toIgnore = canvas_spreadArray(["body"], this.config.notTextable, true);
      var docActive = frame && document.activeElement === frame;
      var focused = docActive ? doc && doc.activeElement : document.activeElement;
      return focused && !toIgnore.some(function(item) {
        return focused.matches(item);
      });
    };
    CanvasModule2.prototype.scrollTo = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var elem = (0, mixins.getElement)(el);
      var view = elem && (0, mixins.getViewEl)(elem);
      view && view.scrollIntoView(opts);
    };
    CanvasModule2.prototype.startAutoscroll = function(frame) {
      var fr = frame && frame.view || this.em.getCurrentFrame();
      fr && fr.startAutoscroll();
    };
    CanvasModule2.prototype.stopAutoscroll = function(frame) {
      var fr = frame && frame.view || this.em.getCurrentFrame();
      fr && fr.stopAutoscroll();
    };
    CanvasModule2.prototype.setZoom = function(value) {
      this.canvas.set("zoom", typeof value === "string" ? parseFloat(value) : value);
      return this;
    };
    CanvasModule2.prototype.getZoom = function() {
      return parseFloat(this.canvas.get("zoom"));
    };
    CanvasModule2.prototype.setCoords = function(x, y, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var hasX = x || x === 0;
      var hasY = y || y === 0;
      var coords = {
        x: this.canvas.get("x"),
        y: this.canvas.get("y")
      };
      if (hasX)
        coords.x = parseFloat("".concat(x));
      if (hasY)
        coords.y = parseFloat("".concat(y));
      if (opts.toWorld) {
        var delta = (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.getViewportDelta();
        if (delta) {
          if (hasX)
            coords.x = coords.x - delta.x;
          if (hasY)
            coords.y = coords.y - delta.y;
        }
      }
      this.canvas.set(coords);
      return this;
    };
    CanvasModule2.prototype.getCoords = function() {
      var _a2 = this.canvas.attributes, x = _a2.x, y = _a2.y;
      return { x, y };
    };
    CanvasModule2.prototype.getPointer = function(screen2) {
      var _a2 = this.canvas.attributes, pointer = _a2.pointer, pointerScreen = _a2.pointerScreen;
      return screen2 ? pointerScreen : pointer;
    };
    CanvasModule2.prototype.getZoomDecimal = function() {
      return this.getZoom() / 100;
    };
    CanvasModule2.prototype.getZoomMultiplier = function() {
      var zoom = this.getZoomDecimal();
      return zoom ? 1 / zoom : 1;
    };
    CanvasModule2.prototype.fitViewport = function(opts) {
      var _a2;
      (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.fitViewport(opts);
    };
    CanvasModule2.prototype.toggleFramesEvents = function(on) {
      var style = this.getFramesEl().style;
      style.pointerEvents = on ? "" : "none";
    };
    CanvasModule2.prototype.getFrames = function() {
      return this.canvas.frames.map(function(item) {
        return item;
      });
    };
    CanvasModule2.prototype.addFrame = function(props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      return this.canvas.frames.add(new model_Frame(this, canvas_assign({}, props)), opts);
    };
    CanvasModule2.prototype.getLastDragResult = function() {
      return this.em.get("dragResult");
    };
    CanvasModule2.prototype.addSpot = function(props, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var spotProps = props;
      var spots = this.getSpots(spotProps);
      if (spots.length) {
        var spot_1 = spots[0];
        spot_1.set(spotProps);
        return spot_1;
      }
      var cmpView = spotProps.componentView || ((_a2 = spotProps.component) === null || _a2 === void 0 ? void 0 : _a2.view);
      var spot = new CanvasSpot.A(this, canvas_assign(canvas_assign({}, spotProps), { id: spotProps.id || "cs_".concat(spotProps.type, "_").concat(cmpView === null || cmpView === void 0 ? void 0 : cmpView.cid), type: spotProps.type || "" }));
      this.spots.add(spot, opts);
      return spot;
    };
    CanvasModule2.prototype.getSpots = function(spotProps) {
      if (spotProps === void 0) {
        spotProps = {};
      }
      return this.spots.where(spotProps.id ? { id: spotProps.id } : spotProps);
    };
    CanvasModule2.prototype.removeSpots = function(spotProps) {
      if (spotProps === void 0) {
        spotProps = {};
      }
      var spots = (0, index_all.isArray)(spotProps) ? spotProps : this.getSpots(spotProps);
      var removed = this.spots.remove(spots);
      return removed;
    };
    CanvasModule2.prototype.hasCustomSpot = function(type2) {
      var customSpots = this.config.customSpots;
      if (customSpots === true || customSpots && type2 && customSpots[type2]) {
        return true;
      }
      return false;
    };
    CanvasModule2.prototype.getWorldRectToScreen = function(boxRect) {
      var _a2;
      return (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.getRectToScreen(boxRect);
    };
    CanvasModule2.prototype.refresh = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, events2 = _a2.events, canvasView = _a2.canvasView;
      canvasView === null || canvasView === void 0 ? void 0 : canvasView.clearOff();
      if (opts.spots || opts.all) {
        this.refreshSpots();
        em.trigger("canvas:updateTools");
      }
      em.set("canvasOffset", this.getOffset());
      em.trigger(events2.refresh, opts);
    };
    CanvasModule2.prototype.refreshSpots = function() {
      this.spots.refresh();
    };
    CanvasModule2.prototype.destroy = function() {
      var _this = this;
      var _a2;
      this.canvas.stopListening();
      (_a2 = this.canvasView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      ["model", "droppable"].forEach(function(i) {
        return _this[i] = {};
      });
    };
    return CanvasModule2;
  }(abstract_Module)
);
var canvas = CanvasModule;
var dom_components_config_config = {
  stylePrefix: "comp-",
  components: [],
  draggableComponents: true,
  disableTextInnerChilds: false,
  processor: void 0,
  useFrameDoc: false,
  voidElements: [
    "area",
    "base",
    "br",
    "col",
    "embed",
    "hr",
    "img",
    "input",
    "keygen",
    "link",
    "menuitem",
    "meta",
    "param",
    "source",
    "track",
    "wbr"
  ]
};
var ComponentTextNode_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTextNode_assign = function() {
  ComponentTextNode_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTextNode_assign.apply(this, arguments);
};
var ComponentTextNode = (
  /** @class */
  function(_super) {
    ComponentTextNode_extends(ComponentTextNode2, _super);
    function ComponentTextNode2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentTextNode2.prototype, "defaults", {
      get: function() {
        return ComponentTextNode_assign(ComponentTextNode_assign({}, _super.prototype.defaults), { tagName: "", droppable: false, layerable: false, selectable: false, editable: true });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTextNode2.prototype.toHTML = function() {
      var content = this.content;
      var parent = this.parent();
      return (parent === null || parent === void 0 ? void 0 : parent.is("script")) ? content : this.__escapeContent(content);
    };
    ComponentTextNode2.prototype.__escapeContent = function(content) {
      return (0, mixins.escapeNodeContent)(content);
    };
    ComponentTextNode2.isComponent = function(el) {
      var _a2;
      if (el.nodeType === 3) {
        return {
          type: "textnode",
          content: (_a2 = el.textContent) !== null && _a2 !== void 0 ? _a2 : ""
        };
      }
    };
    return ComponentTextNode2;
  }(model_Component)
);
var model_ComponentTextNode = ComponentTextNode;
var ComponentComment_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentComment_assign = function() {
  ComponentComment_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentComment_assign.apply(this, arguments);
};
var ComponentComment = (
  /** @class */
  function(_super) {
    ComponentComment_extends(ComponentComment2, _super);
    function ComponentComment2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentComment2.prototype, "defaults", {
      get: function() {
        return ComponentComment_assign({}, _super.prototype.defaults);
      },
      enumerable: false,
      configurable: true
    });
    ComponentComment2.prototype.toHTML = function() {
      return "<!--".concat(this.content, "-->");
    };
    ComponentComment2.isComponent = function(el) {
      var _a2;
      if (el.nodeType == 8) {
        return {
          type: "comment",
          content: (_a2 = el.textContent) !== null && _a2 !== void 0 ? _a2 : ""
        };
      }
    };
    return ComponentComment2;
  }(model_ComponentTextNode)
);
var model_ComponentComment = ComponentComment;
var ComponentFrame_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentFrame_assign = function() {
  ComponentFrame_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentFrame_assign.apply(this, arguments);
};
var ComponentFrame_type = "iframe";
var ComponentFrame = (
  /** @class */
  function(_super) {
    ComponentFrame_extends(ComponentFrame2, _super);
    function ComponentFrame2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentFrame2.prototype, "defaults", {
      get: function() {
        return ComponentFrame_assign(ComponentFrame_assign({}, _super.prototype.defaults), { type: ComponentFrame_type, tagName: ComponentFrame_type, droppable: false, resizable: true, traits: ["id", "title", "src"], attributes: { frameborder: "0" } });
      },
      enumerable: false,
      configurable: true
    });
    ComponentFrame2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentFrame_type;
    };
    return ComponentFrame2;
  }(model_Component)
);
var model_ComponentFrame = ComponentFrame;
var ComponentImage_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentImage_assign = function() {
  ComponentImage_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentImage_assign.apply(this, arguments);
};
var svgAttrs = 'xmlns="http://www.w3.org/2000/svg" width="100" viewBox="0 0 24 24" style="fill: rgba(0,0,0,0.15); transform: scale(0.75)"';
var ComponentImage = (
  /** @class */
  function(_super) {
    ComponentImage_extends(ComponentImage2, _super);
    function ComponentImage2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      var src2 = _this.get("attributes").src;
      if (src2 && (0, mixins.buildBase64UrlFromSvg)((0, index_all.result)(_this, "defaults").src) !== src2) {
        _this.set("src", src2, { silent: true });
      }
      return _this;
    }
    Object.defineProperty(ComponentImage2.prototype, "defaults", {
      get: function() {
        return ComponentImage_assign(ComponentImage_assign({}, _super.prototype.defaults), {
          type: "image",
          tagName: "img",
          void: true,
          droppable: 0,
          editable: 1,
          highlightable: 0,
          resizable: { ratioDefault: 1 },
          traits: ["alt"],
          src: "<svg ".concat(svgAttrs, '>\n        <path d="M8.5 13.5l2.5 3 3.5-4.5 4.5 6H5m16 1V5a2 2 0 0 0-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2z"></path>\n      </svg>'),
          // Fallback image in case the src can't be loaded
          // If you use SVG, xmlns="http://www.w3.org/2000/svg" is required
          fallback: "<svg ".concat(svgAttrs, '>\n        <path d="M2.28 3L1 4.27l2 2V19c0 1.1.9 2 2 2h12.73l2 2L21 21.72 2.28 3m2.55 0L21 19.17V5a2 2 0 0 0-2-2H4.83M8.5 13.5l2.5 3 1-1.25L14.73 18H5l3.5-4.5z"></path>\n      </svg>'),
          // File to load asynchronously once the model is rendered
          file: ""
        });
      },
      enumerable: false,
      configurable: true
    });
    ComponentImage2.prototype.initToolbar = function() {
      _super.prototype.initToolbar.call(this);
      var em = this.em;
      if (em) {
        var cmd = em.Commands;
        var cmdName = "image-editor";
        if (cmd.has(cmdName)) {
          var hasButtonBool = false;
          var tb = this.get("toolbar");
          for (var i = 0; i < tb.length; i++) {
            if (tb[i].command === "image-editor") {
              hasButtonBool = true;
              break;
            }
          }
          if (!hasButtonBool) {
            tb.push({
              attributes: { class: "fa fa-pencil" },
              command: cmdName
            });
            this.set("toolbar", tb);
          }
        }
      }
    };
    ComponentImage2.prototype.getAttrToHTML = function() {
      var attr = _super.prototype.getAttrToHTML.call(this);
      var src2 = this.getSrcResult();
      if (src2)
        attr.src = src2;
      return attr;
    };
    ComponentImage2.prototype.getSrcResult = function(opt) {
      if (opt === void 0) {
        opt = {};
      }
      var src2 = this.get(opt.fallback ? "fallback" : "src") || "";
      var result = src2;
      if (src2 && src2.substr(0, 4) === "<svg") {
        result = (0, mixins.buildBase64UrlFromSvg)(src2);
      }
      return result;
    };
    ComponentImage2.prototype.isDefaultSrc = function() {
      var src2 = this.get("src");
      var srcDef = (0, index_all.result)(this, "defaults").src;
      return src2 === srcDef || src2 === (0, mixins.buildBase64UrlFromSvg)(srcDef);
    };
    ComponentImage2.prototype.toJSON = function(opts) {
      var obj = _super.prototype.toJSON.call(this, opts);
      var attributes = obj.attributes;
      if (attributes && obj.src === attributes.src) {
        delete obj.src;
      }
      return obj;
    };
    ComponentImage2.prototype.parseUri = function(uri) {
      var result = {};
      var getQueryObject = function(search) {
        if (search === void 0) {
          search = "";
        }
        var query = {};
        var qrs = search.substring(1).split("&");
        for (var i = 0; i < qrs.length; i++) {
          var pair = qrs[i].split("=");
          var name_1 = decodeURIComponent(pair[0]);
          if (name_1)
            query[name_1] = decodeURIComponent(pair[1] || "");
        }
        return query;
      };
      if ((0, mixins.hasWin)()) {
        result = document.createElement("a");
        result.href = uri;
      } else if (typeof URL !== "undefined") {
        try {
          result = new URL(uri);
        } catch (e) {
        }
      }
      return {
        hostname: result.hostname || "",
        pathname: result.pathname || "",
        protocol: result.protocol || "",
        search: result.search || "",
        hash: result.hash || "",
        port: result.port || "",
        query: getQueryObject(result.search)
      };
    };
    ComponentImage2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === "img";
    };
    return ComponentImage2;
  }(model_Component)
);
var model_ComponentImage = ComponentImage;
var ComponentText_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentText_assign = function() {
  ComponentText_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentText_assign.apply(this, arguments);
};
var ComponentText = (
  /** @class */
  function(_super) {
    ComponentText_extends(ComponentText2, _super);
    function ComponentText2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      _this.__checkInnerChilds();
      return _this;
    }
    Object.defineProperty(ComponentText2.prototype, "defaults", {
      get: function() {
        return ComponentText_assign(ComponentText_assign({}, _super.prototype.defaults), { type: "text", droppable: false, editable: true });
      },
      enumerable: false,
      configurable: true
    });
    ComponentText2.prototype.__checkInnerChilds = function() {
      var disableTextInnerChilds = this.em.Components.config.disableTextInnerChilds;
      if (disableTextInnerChilds) {
        var disableChild_1 = function(child) {
          if (!child.isInstanceOf("textnode")) {
            child.set({
              locked: true,
              layerable: false
            });
          }
        };
        if ((0, index_all.isFunction)(disableTextInnerChilds)) {
          this.forEachChild(function(child) {
            disableTextInnerChilds(child) && disableChild_1(child);
          });
        } else {
          this.forEachChild(disableChild_1);
        }
      }
    };
    return ComponentText2;
  }(model_Component)
);
var model_ComponentText = ComponentText;
var ComponentLabel_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentLabel_assign = function() {
  ComponentLabel_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentLabel_assign.apply(this, arguments);
};
var ComponentLabel_type = "label";
var ComponentLabel = (
  /** @class */
  function(_super) {
    ComponentLabel_extends(ComponentLabel2, _super);
    function ComponentLabel2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentLabel2.prototype, "defaults", {
      get: function() {
        return ComponentLabel_assign(ComponentLabel_assign({}, _super.prototype.defaults), { type: ComponentLabel_type, tagName: ComponentLabel_type, traits: ["id", "title", "for"] });
      },
      enumerable: false,
      configurable: true
    });
    ComponentLabel2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentLabel_type;
    };
    return ComponentLabel2;
  }(model_ComponentText)
);
var model_ComponentLabel = ComponentLabel;
var ComponentLink_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentLink_assign = function() {
  ComponentLink_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentLink_assign.apply(this, arguments);
};
var ComponentLink_type = "link";
var ComponentLink = (
  /** @class */
  function(_super) {
    ComponentLink_extends(ComponentLink2, _super);
    function ComponentLink2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentLink2.prototype, "defaults", {
      get: function() {
        return ComponentLink_assign(ComponentLink_assign({}, _super.prototype.defaults), { type: ComponentLink_type, tagName: "a", traits: ["title", "href", "target"] });
      },
      enumerable: false,
      configurable: true
    });
    ComponentLink2.isComponent = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result;
      if ((0, mixins.toLowerCase)(el.tagName) === "a") {
        var textTags_1 = opts.textTags || [];
        result = { type: ComponentLink_type, editable: false };
        var children = el.childNodes;
        var len = children.length;
        if (!len)
          delete result.editable;
        (0, index_all.forEach)(children, function(child) {
          var tagName2 = child.tagName;
          if (child.nodeType == 3 && child.textContent.trim() !== "" || tagName2 && textTags_1.indexOf((0, mixins.toLowerCase)(tagName2)) >= 0) {
            delete result.editable;
          }
        });
      }
      return result;
    };
    return ComponentLink2;
  }(model_ComponentText)
);
var model_ComponentLink = ComponentLink;
var ComponentMap_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentMap_assign = function() {
  ComponentMap_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentMap_assign.apply(this, arguments);
};
var ComponentMap = (
  /** @class */
  function(_super) {
    ComponentMap_extends(ComponentMap2, _super);
    function ComponentMap2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      if (_this.get("src"))
        _this.parseFromSrc();
      else
        _this.updateSrc();
      _this.listenTo(_this, "change:address change:zoom change:mapType", _this.updateSrc);
      return _this;
    }
    Object.defineProperty(ComponentMap2.prototype, "defaults", {
      /** @ts-ignore */
      get: function() {
        var defs = _super.prototype.defaults;
        return ComponentMap_assign(ComponentMap_assign({}, defs), {
          type: "map",
          src: "",
          void: false,
          mapUrl: "https://maps.google.com/maps",
          tagName: "iframe",
          mapType: "q",
          address: "",
          zoom: "1",
          attributes: { frameborder: 0 },
          // @ts-ignore
          toolbar: defs.toolbar,
          traits: [
            {
              label: "Address",
              name: "address",
              placeholder: "eg. London, UK",
              changeProp: true
            },
            {
              type: "select",
              label: "Map type",
              name: "mapType",
              changeProp: true,
              options: [
                { id: "q", label: "Roadmap" },
                { id: "w", label: "Satellite" }
              ]
            },
            {
              label: "Zoom",
              name: "zoom",
              type: "range",
              min: 1,
              max: 20,
              changeProp: true
            }
          ]
        });
      },
      enumerable: false,
      configurable: true
    });
    ComponentMap2.prototype.updateSrc = function() {
      this.set("src", this.getMapUrl());
    };
    ComponentMap2.prototype.getMapUrl = function() {
      var addr = this.get("address");
      var zoom = this.get("zoom");
      var type2 = this.get("mapType");
      addr = addr ? "&q=" + addr : "";
      zoom = zoom ? "&z=" + zoom : "";
      type2 = type2 ? "&t=" + type2 : "";
      var result = this.get("mapUrl") + "?" + addr + zoom + type2;
      result += "&output=embed";
      return result;
    };
    ComponentMap2.prototype.parseFromSrc = function() {
      var uri = this.parseUri(this.get("src"));
      var qr = uri.query;
      if (qr.q)
        this.set("address", qr.q);
      if (qr.z)
        this.set("zoom", qr.z);
      if (qr.t)
        this.set("mapType", qr.t);
    };
    ComponentMap2.isComponent = function(el) {
      if ((0, mixins.toLowerCase)(el.tagName) == "iframe" && /maps\.google\.com/.test(el.src)) {
        return { type: "map", src: el.src };
      }
    };
    return ComponentMap2;
  }(model_ComponentImage)
);
var model_ComponentMap = ComponentMap;
var ComponentScript_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentScript_assign = function() {
  ComponentScript_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentScript_assign.apply(this, arguments);
};
var ComponentScript_type = "script";
var ComponentScript = (
  /** @class */
  function(_super) {
    ComponentScript_extends(ComponentScript2, _super);
    function ComponentScript2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentScript2.prototype, "defaults", {
      get: function() {
        return ComponentScript_assign(ComponentScript_assign({}, _super.prototype.defaults), { type: ComponentScript_type, tagName: ComponentScript_type, droppable: false, draggable: false, layerable: false, highlightable: false });
      },
      enumerable: false,
      configurable: true
    });
    ComponentScript2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentScript_type;
    };
    return ComponentScript2;
  }(model_Component)
);
var model_ComponentScript = ComponentScript;
var ComponentSvg_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentSvg_assign = function() {
  ComponentSvg_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentSvg_assign.apply(this, arguments);
};
var ComponentSvg_type = "svg";
var ComponentSvg = (
  /** @class */
  function(_super) {
    ComponentSvg_extends(ComponentSvg2, _super);
    function ComponentSvg2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentSvg2.prototype, "defaults", {
      get: function() {
        return ComponentSvg_assign(ComponentSvg_assign({}, _super.prototype.defaults), { type: ComponentSvg_type, tagName: ComponentSvg_type, highlightable: false, resizable: { ratioDefault: true } });
      },
      enumerable: false,
      configurable: true
    });
    ComponentSvg2.prototype.getName = function() {
      var name = this.get("tagName");
      var customName = this.get("custom-name");
      name = name.charAt(0).toUpperCase() + name.slice(1);
      return customName || name;
    };
    ComponentSvg2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentSvg_type;
    };
    return ComponentSvg2;
  }(model_Component)
);
var model_ComponentSvg = ComponentSvg;
var ComponentSvgIn_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentSvgIn_assign = function() {
  ComponentSvgIn_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentSvgIn_assign.apply(this, arguments);
};
var ComponentSvgIn = (
  /** @class */
  function(_super) {
    ComponentSvgIn_extends(ComponentSvgIn2, _super);
    function ComponentSvgIn2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentSvgIn2.prototype, "defaults", {
      get: function() {
        return ComponentSvgIn_assign(ComponentSvgIn_assign({}, _super.prototype.defaults), { selectable: false, hoverable: false, layerable: false });
      },
      enumerable: false,
      configurable: true
    });
    ComponentSvgIn2.isComponent = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      return !!opts.inSvg;
    };
    return ComponentSvgIn2;
  }(model_ComponentSvg)
);
var model_ComponentSvgIn = ComponentSvgIn;
var ComponentTable_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTable_assign = function() {
  ComponentTable_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTable_assign.apply(this, arguments);
};
var ComponentTable_type = "table";
var ComponentTable = (
  /** @class */
  function(_super) {
    ComponentTable_extends(ComponentTable2, _super);
    function ComponentTable2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      var components = _this.get("components");
      !components.length && components.add({ type: "tbody" });
      return _this;
    }
    Object.defineProperty(ComponentTable2.prototype, "defaults", {
      get: function() {
        return ComponentTable_assign(ComponentTable_assign({}, _super.prototype.defaults), { type: ComponentTable_type, tagName: ComponentTable_type, droppable: ["tbody", "thead", "tfoot"] });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTable2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentTable_type;
    };
    return ComponentTable2;
  }(model_Component)
);
var model_ComponentTable = ComponentTable;
var ComponentTableBody_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableBody_assign = function() {
  ComponentTableBody_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTableBody_assign.apply(this, arguments);
};
var ComponentTableBody_type = "tbody";
var ComponentTableBody = (
  /** @class */
  function(_super) {
    ComponentTableBody_extends(ComponentTableBody2, _super);
    function ComponentTableBody2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      var components = _this.get("components");
      var columns = _this.get("columns");
      var rows = _this.get("rows");
      if (!components.length) {
        var rowsToAdd = [];
        while (rows--) {
          var columnsToAdd = [];
          var clm = columns;
          while (clm--) {
            columnsToAdd.push({
              type: "cell",
              classes: ["cell"]
            });
          }
          rowsToAdd.push({
            type: "row",
            classes: ["row"],
            components: columnsToAdd
          });
        }
        components.add(rowsToAdd);
      }
      return _this;
    }
    Object.defineProperty(ComponentTableBody2.prototype, "defaults", {
      get: function() {
        return ComponentTableBody_assign(ComponentTableBody_assign({}, _super.prototype.defaults), { type: ComponentTableBody_type, tagName: ComponentTableBody_type, draggable: ["table"], droppable: ["tr"], columns: 1, rows: 1 });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTableBody2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentTableBody_type;
    };
    return ComponentTableBody2;
  }(model_Component)
);
var model_ComponentTableBody = ComponentTableBody;
var ComponentTableCell_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableCell_assign = function() {
  ComponentTableCell_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTableCell_assign.apply(this, arguments);
};
var ComponentTableCell = (
  /** @class */
  function(_super) {
    ComponentTableCell_extends(ComponentTableCell2, _super);
    function ComponentTableCell2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentTableCell2.prototype, "defaults", {
      get: function() {
        return ComponentTableCell_assign(ComponentTableCell_assign({}, _super.prototype.defaults), { type: "cell", tagName: "td", draggable: ["tr"] });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTableCell2.isComponent = function(el) {
      return ["td", "th"].indexOf((0, mixins.toLowerCase)(el.tagName)) >= 0;
    };
    return ComponentTableCell2;
  }(model_Component)
);
var model_ComponentTableCell = ComponentTableCell;
var ComponentTableFoot_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableFoot_assign = function() {
  ComponentTableFoot_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTableFoot_assign.apply(this, arguments);
};
var ComponentTableFoot_type = "tfoot";
var ComponentTableFoot = (
  /** @class */
  function(_super) {
    ComponentTableFoot_extends(ComponentTableFoot2, _super);
    function ComponentTableFoot2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentTableFoot2.prototype, "defaults", {
      get: function() {
        return ComponentTableFoot_assign(ComponentTableFoot_assign({}, _super.prototype.defaults), { type: ComponentTableFoot_type, tagName: ComponentTableFoot_type });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTableFoot2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentTableFoot_type;
    };
    return ComponentTableFoot2;
  }(model_ComponentTableBody)
);
var model_ComponentTableFoot = ComponentTableFoot;
var ComponentTableHead_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableHead_assign = function() {
  ComponentTableHead_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTableHead_assign.apply(this, arguments);
};
var ComponentTableHead_type = "thead";
var ComponentTableHead = (
  /** @class */
  function(_super) {
    ComponentTableHead_extends(ComponentTableHead2, _super);
    function ComponentTableHead2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentTableHead2.prototype, "defaults", {
      get: function() {
        return ComponentTableHead_assign(ComponentTableHead_assign({}, _super.prototype.defaults), { type: ComponentTableHead_type, tagName: ComponentTableHead_type });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTableHead2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === ComponentTableHead_type;
    };
    return ComponentTableHead2;
  }(model_ComponentTableBody)
);
var model_ComponentTableHead = ComponentTableHead;
var ComponentTableRow_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableRow_assign = function() {
  ComponentTableRow_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTableRow_assign.apply(this, arguments);
};
var tagName = "tr";
var ComponentTableRow = (
  /** @class */
  function(_super) {
    ComponentTableRow_extends(ComponentTableRow2, _super);
    function ComponentTableRow2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Object.defineProperty(ComponentTableRow2.prototype, "defaults", {
      get: function() {
        return ComponentTableRow_assign(ComponentTableRow_assign({}, _super.prototype.defaults), { tagName, draggable: ["thead", "tbody", "tfoot"], droppable: ["th", "td"] });
      },
      enumerable: false,
      configurable: true
    });
    ComponentTableRow2.isComponent = function(el) {
      return (0, mixins.toLowerCase)(el.tagName) === tagName;
    };
    return ComponentTableRow2;
  }(model_Component)
);
var model_ComponentTableRow = ComponentTableRow;
var ComponentVideo_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentVideo_assign = function() {
  ComponentVideo_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentVideo_assign.apply(this, arguments);
};
var ComponentVideo_type = "video";
var yt = "yt";
var vi = "vi";
var ytnc = "ytnc";
var defProvider = "so";
var hasParam = function(value) {
  return value && value !== "0";
};
var ComponentVideo = (
  /** @class */
  function(_super) {
    ComponentVideo_extends(ComponentVideo2, _super);
    function ComponentVideo2(props, opt) {
      if (props === void 0) {
        props = {};
      }
      var _this = _super.call(this, props, opt) || this;
      if (_this.get("src"))
        _this.parseFromSrc();
      _this.updatePropsFromAttr();
      _this.updateTraits();
      _this.on("change:provider", _this.updateTraits);
      _this.on("change:videoId change:provider", _this.updateSrc);
      return _this;
    }
    Object.defineProperty(ComponentVideo2.prototype, "defaults", {
      get: function() {
        return ComponentVideo_assign(ComponentVideo_assign({}, _super.prototype.defaults), { type: ComponentVideo_type, tagName: ComponentVideo_type, videoId: "", void: false, provider: defProvider, ytUrl: "https://www.youtube.com/embed/", ytncUrl: "https://www.youtube-nocookie.com/embed/", viUrl: "https://player.vimeo.com/video/", loop: false, poster: "", muted: 0, autoplay: false, controls: true, color: "", list: "", src: "", rel: 1, modestbranding: 0, sources: [], attributes: { allowfullscreen: "allowfullscreen" } });
      },
      enumerable: false,
      configurable: true
    });
    ComponentVideo2.prototype.updatePropsFromAttr = function() {
      if (this.get("provider") === defProvider) {
        var _a2 = this.get("attributes"), controls = _a2.controls, autoplay = _a2.autoplay, loop = _a2.loop;
        var toUp = {};
        if ((0, mixins.isDef)(controls))
          toUp.controls = !!controls;
        if ((0, mixins.isDef)(autoplay))
          toUp.autoplay = !!autoplay;
        if ((0, mixins.isDef)(loop))
          toUp.loop = !!loop;
        if (!(0, mixins.isEmptyObj)(toUp)) {
          this.set(toUp);
        }
      }
    };
    ComponentVideo2.prototype.updateTraits = function() {
      var em = this.em;
      var prov = this.get("provider");
      var tagName2 = "iframe";
      var traits;
      switch (prov) {
        case yt:
        case ytnc:
          traits = this.getYoutubeTraits();
          break;
        case vi:
          traits = this.getVimeoTraits();
          break;
        default:
          tagName2 = "video";
          traits = this.getSourceTraits();
      }
      this.set({ tagName: tagName2 }, { silent: true });
      this.set({ traits });
      em.get("ready") && em.trigger("component:toggled");
    };
    ComponentVideo2.prototype.parseFromSrc = function() {
      var prov = this.get("provider");
      var uri = this.parseUri(this.get("src"));
      var qr = uri.query;
      switch (prov) {
        case yt:
        case ytnc:
        case vi:
          this.set("videoId", uri.pathname.split("/").pop());
          qr.list && this.set("list", qr.list);
          hasParam(qr.autoplay) && this.set("autoplay", true);
          hasParam(qr.loop) && this.set("loop", true);
          parseInt(qr.controls) === 0 && this.set("controls", false);
          hasParam(qr.color) && this.set("color", qr.color);
          qr.rel === "0" && this.set("rel", 0);
          qr.modestbranding === "1" && this.set("modestbranding", 1);
          break;
        default:
      }
    };
    ComponentVideo2.prototype.updateSrc = function() {
      var prov = this.get("provider");
      var src2 = "";
      switch (prov) {
        case yt:
          src2 = this.getYoutubeSrc();
          break;
        case ytnc:
          src2 = this.getYoutubeNoCookieSrc();
          break;
        case vi:
          src2 = this.getVimeoSrc();
          break;
      }
      this.set({ src: src2 });
    };
    ComponentVideo2.prototype.getAttrToHTML = function() {
      var attr = _super.prototype.getAttrToHTML.call(this);
      var prov = this.get("provider");
      switch (prov) {
        case yt:
        case ytnc:
        case vi:
          break;
        default:
          attr.loop = !!this.get("loop");
          attr.autoplay = !!this.get("autoplay");
          attr.controls = !!this.get("controls");
      }
      return attr;
    };
    ComponentVideo2.prototype.getProviderTrait = function() {
      return {
        type: "select",
        label: "Provider",
        name: "provider",
        changeProp: true,
        options: [
          { value: "so", name: "HTML5 Source" },
          { value: yt, name: "Youtube" },
          { value: ytnc, name: "Youtube (no cookie)" },
          { value: vi, name: "Vimeo" }
        ]
      };
    };
    ComponentVideo2.prototype.getSourceTraits = function() {
      return [
        this.getProviderTrait(),
        {
          label: "Source",
          name: "src",
          placeholder: "eg. ./media/video.mp4",
          changeProp: true
        },
        {
          label: "Poster",
          name: "poster",
          placeholder: "eg. ./media/image.jpg"
        },
        this.getAutoplayTrait(),
        this.getLoopTrait(),
        this.getControlsTrait()
      ];
    };
    ComponentVideo2.prototype.getYoutubeTraits = function() {
      return [
        this.getProviderTrait(),
        {
          label: "Video ID",
          name: "videoId",
          placeholder: "eg. jNQXAC9IVRw",
          changeProp: true
        },
        this.getAutoplayTrait(),
        this.getLoopTrait(),
        this.getControlsTrait(),
        {
          type: "checkbox",
          label: "Related",
          name: "rel",
          changeProp: true
        },
        {
          type: "checkbox",
          label: "Modest",
          name: "modestbranding",
          changeProp: true
        }
      ];
    };
    ComponentVideo2.prototype.getVimeoTraits = function() {
      return [
        this.getProviderTrait(),
        {
          label: "Video ID",
          name: "videoId",
          placeholder: "eg. 123456789",
          changeProp: true
        },
        {
          label: "Color",
          name: "color",
          placeholder: "eg. FF0000",
          changeProp: true
        },
        this.getAutoplayTrait(),
        this.getLoopTrait()
      ];
    };
    ComponentVideo2.prototype.getAutoplayTrait = function() {
      return {
        type: "checkbox",
        label: "Autoplay",
        name: "autoplay",
        changeProp: true
      };
    };
    ComponentVideo2.prototype.getLoopTrait = function() {
      return {
        type: "checkbox",
        label: "Loop",
        name: "loop",
        changeProp: true
      };
    };
    ComponentVideo2.prototype.getControlsTrait = function() {
      return {
        type: "checkbox",
        label: "Controls",
        name: "controls",
        changeProp: true
      };
    };
    ComponentVideo2.prototype.getYoutubeSrc = function() {
      var id = this.get("videoId");
      var url = this.get("ytUrl");
      var list = this.get("list");
      url += id + (id.indexOf("?") < 0 ? "?" : "");
      url += list ? "&list=".concat(list) : "";
      url += this.get("autoplay") ? "&autoplay=1&mute=1" : "";
      url += !this.get("controls") ? "&controls=0&showinfo=0" : "";
      url += this.get("loop") ? "&loop=1&playlist=".concat(id) : "";
      url += this.get("rel") ? "" : "&rel=0";
      url += this.get("modestbranding") ? "&modestbranding=1" : "";
      return url;
    };
    ComponentVideo2.prototype.getYoutubeNoCookieSrc = function() {
      var url = this.getYoutubeSrc();
      url = url.replace(this.get("ytUrl"), this.get("ytncUrl"));
      return url;
    };
    ComponentVideo2.prototype.getVimeoSrc = function() {
      var url = this.get("viUrl");
      url += this.get("videoId") + "?";
      url += this.get("autoplay") ? "&autoplay=1&muted=1" : "";
      url += this.get("loop") ? "&loop=1" : "";
      url += !this.get("controls") ? "&title=0&portrait=0&badge=0" : "";
      url += this.get("color") ? "&color=" + this.get("color") : "";
      return url;
    };
    ComponentVideo2.isComponent = function(el) {
      var tagName2 = el.tagName, src2 = el.src;
      var isYtProv = /youtube\.com\/embed/.test(src2);
      var isYtncProv = /youtube-nocookie\.com\/embed/.test(src2);
      var isViProv = /player\.vimeo\.com\/video/.test(src2);
      var isExtProv = isYtProv || isYtncProv || isViProv;
      if ((0, mixins.toLowerCase)(tagName2) == ComponentVideo_type || (0, mixins.toLowerCase)(tagName2) == "iframe" && isExtProv) {
        var result = { type: "video" };
        if (src2)
          result.src = src2;
        if (isExtProv) {
          if (isYtProv)
            result.provider = yt;
          else if (isYtncProv)
            result.provider = ytnc;
          else if (isViProv)
            result.provider = vi;
        }
        return result;
      }
    };
    return ComponentVideo2;
  }(model_ComponentImage)
);
var model_ComponentVideo = ComponentVideo;
var ComponentWrapper_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentWrapper_assign = function() {
  ComponentWrapper_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentWrapper_assign.apply(this, arguments);
};
var ComponentWrapper = (
  /** @class */
  function(_super) {
    ComponentWrapper_extends(ComponentWrapper2, _super);
    function ComponentWrapper2() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      var _a2, _b;
      var _this = _super.apply(this, args) || this;
      var opts = args[1];
      var cmp = (_a2 = opts === null || opts === void 0 ? void 0 : opts.em) === null || _a2 === void 0 ? void 0 : _a2.Components;
      var CmpHead = (_b = cmp === null || cmp === void 0 ? void 0 : cmp.getType(type)) === null || _b === void 0 ? void 0 : _b.model;
      var CmpDef = cmp === null || cmp === void 0 ? void 0 : cmp.getType("default").model;
      if (CmpHead) {
        _this.set({
          head: new CmpHead({}, opts),
          docEl: new CmpDef({ tagName: "html" }, opts)
        }, { silent: true });
      }
      return _this;
    }
    Object.defineProperty(ComponentWrapper2.prototype, "defaults", {
      get: function() {
        return ComponentWrapper_assign(ComponentWrapper_assign({}, _super.prototype.defaults), { tagName: "body", removable: false, copyable: false, draggable: false, components: [], traits: [], doctype: "", head: null, docEl: null, stylable: [
          "background",
          "background-color",
          "background-image",
          "background-repeat",
          "background-attachment",
          "background-position",
          "background-size"
        ] });
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ComponentWrapper2.prototype, "head", {
      get: function() {
        return this.get("head");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ComponentWrapper2.prototype, "docEl", {
      get: function() {
        return this.get("docEl");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ComponentWrapper2.prototype, "doctype", {
      get: function() {
        return this.attributes.doctype || "";
      },
      enumerable: false,
      configurable: true
    });
    ComponentWrapper2.prototype.toHTML = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var doctype = this.doctype;
      var asDoc = !(0, index_all.isUndefined)(opts.asDocument) ? opts.asDocument : !!doctype;
      var _a2 = this, head = _a2.head, docEl = _a2.docEl;
      var body = _super.prototype.toHTML.call(this, opts);
      var headStr = asDoc && (head === null || head === void 0 ? void 0 : head.toHTML(opts)) || "";
      var docElAttr = asDoc && (0, dom.kk)(docEl === null || docEl === void 0 ? void 0 : docEl.getAttrToHTML()) || "";
      var docElAttrStr = docElAttr ? " ".concat(docElAttr) : "";
      return asDoc ? "".concat(doctype, "<html").concat(docElAttrStr, ">").concat(headStr).concat(body, "</html>") : body;
    };
    ComponentWrapper2.prototype.__postAdd = function() {
      var _a2;
      var um = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.UndoManager;
      !this.__hasUm && (um === null || um === void 0 ? void 0 : um.add(this));
      return _super.prototype.__postAdd.call(this);
    };
    ComponentWrapper2.prototype.__postRemove = function() {
      var _a2;
      var um = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.UndoManager;
      um === null || um === void 0 ? void 0 : um.remove(this);
      return _super.prototype.__postRemove.call(this);
    };
    ComponentWrapper2.isComponent = function() {
      return false;
    };
    return ComponentWrapper2;
  }(model_Component)
);
var model_ComponentWrapper = ComponentWrapper;
var ComponentsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentsView = (
  /** @class */
  function(_super) {
    ComponentsView_extends(ComponentsView2, _super);
    function ComponentsView2() {
      var _this = _super !== null && _super.apply(this, arguments) || this;
      _this.compView = view_ComponentView;
      return _this;
    }
    ComponentsView2.prototype.initialize = function(o) {
      this.opts = o || {};
      this.config = o.config || {};
      this.em = this.config.em;
      var coll = this.collection;
      this.listenTo(coll, "add", this.addTo);
      this.listenTo(coll, "reset", this.resetChildren);
      this.listenTo(coll, "remove", this.removeChildren);
    };
    ComponentsView2.prototype.removeChildren = function(removed, coll, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      removed.views.forEach(function(view) {
        if (!view)
          return;
        var childrenView = view.childrenView, scriptContainer = view.scriptContainer;
        childrenView && childrenView.stopListening();
        (0, dom.YZ)(scriptContainer);
        view.remove.apply(view);
      });
      var inner = removed.components();
      inner.forEach(function(it) {
        return _this.removeChildren(it, coll, opts);
      });
    };
    ComponentsView2.prototype.addTo = function(model) {
      this.addToCollection(model, null, this.collection.indexOf(model));
    };
    ComponentsView2.prototype.addToCollection = function(model, fragment, index2) {
      var _a2 = this, config2 = _a2.config, opts = _a2.opts, em = _a2.em;
      var frameView = config2.frameView;
      var sameFrameView = (frameView === null || frameView === void 0 ? void 0 : frameView.model) && model.getView(frameView.model);
      var dt = opts.componentTypes || (em === null || em === void 0 ? void 0 : em.Components.getTypes());
      var type2 = model.get("type") || "default";
      var viewObject = this.compView;
      for (var it_1 = 0; it_1 < dt.length; it_1++) {
        if (dt[it_1].id == type2) {
          viewObject = dt[it_1].view;
          break;
        }
      }
      var view = sameFrameView || new viewObject({
        model,
        // @ts-ignore
        config: config2,
        componentTypes: dt
      });
      var rendered;
      try {
        rendered = view.render().el;
      } catch (error) {
        rendered = document.createTextNode("");
        em.logError(error);
      }
      if (fragment) {
        fragment.appendChild(rendered);
      } else {
        var parent_1 = this.parentEl;
        var children = parent_1.childNodes;
        if (!(0, index_all.isUndefined)(index2)) {
          var lastIndex = children.length == index2;
          if (lastIndex) {
            index2--;
          }
          if (lastIndex || !children.length) {
            parent_1.appendChild(rendered);
          } else {
            parent_1.insertBefore(rendered, children[index2]);
          }
        } else {
          parent_1.appendChild(rendered);
        }
      }
      if (!model.opt.temporary) {
        em === null || em === void 0 ? void 0 : em.trigger("component:mount", model);
      }
      return rendered;
    };
    ComponentsView2.prototype.resetChildren = function(models, _a2) {
      var _this = this;
      var _b = _a2 === void 0 ? {} : _a2, _c = _b.previousModels, previousModels = _c === void 0 ? [] : _c;
      this.parentEl.innerHTML = "";
      previousModels.forEach(function(md) {
        return _this.removeChildren(md, _this.collection);
      });
      models.each(function(model) {
        return _this.addToCollection(model);
      });
    };
    ComponentsView2.prototype.render = function(parent) {
      var _this = this;
      var el = this.el;
      var frag = document.createDocumentFragment();
      this.parentEl = parent || this.el;
      this.collection.each(function(model) {
        return _this.addToCollection(model, frag);
      });
      el.innerHTML = "";
      el.appendChild(frag);
      return this;
    };
    return ComponentsView2;
  }(common.Ss)
);
var view_ComponentsView = ComponentsView;
var ComponentView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentView_assign = function() {
  ComponentView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentView_assign.apply(this, arguments);
};
var ComponentView = (
  /** @class */
  function(_super) {
    ComponentView_extends(ComponentView2, _super);
    function ComponentView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentView2.prototype.className = function() {
      return this.getClasses();
    };
    ComponentView2.prototype.tagName = function() {
      return this.model.get("tagName");
    };
    ComponentView2.prototype.preinitialize = function(opt) {
      if (opt === void 0) {
        opt = {};
      }
      this.opts = opt;
    };
    ComponentView2.prototype.initialize = function(opt) {
      if (opt === void 0) {
        opt = {};
      }
      var model = this.model;
      var config2 = opt.config || {};
      var em = config2.em;
      var modelOpt = model.opt || {};
      var _a2 = this, $el = _a2.$el, el = _a2.el;
      this.opts = opt;
      this.modelOpt = modelOpt;
      this.config = config2;
      this.em = em;
      this.pfx = config2.stylePrefix || "";
      this.ppfx = config2.pStylePrefix || "";
      this.attr = model.get("attributes");
      this.classe = this.attr.class || [];
      this.listenTo(model, "change:style", this.updateStyle);
      this.listenTo(model, "change:attributes", this.renderAttributes);
      this.listenTo(model, "change:highlightable", this.updateHighlight);
      this.listenTo(model, "change:status change:locked", this.updateStatus);
      this.listenTo(model, "change:script rerender", this.reset);
      this.listenTo(model, "change:content", this.updateContent);
      this.listenTo(model, "change", this.handleChange);
      this.listenTo(model, "active", this.onActive);
      this.listenTo(model, "disable", this.onDisable);
      $el.data("model", model);
      (0, mixins.setViewEl)(el, this);
      model.view = this;
      this.frameView && model.views.push(this);
      this.initClasses();
      this.initComponents({ avoidRender: true });
      this.events = ComponentView_assign(ComponentView_assign({}, this.constructor.getEvents()), { dragstart: "handleDragStart" });
      this.delegateEvents();
      !modelOpt.temporary && this.init(this._clbObj());
    };
    Object.defineProperty(ComponentView2.prototype, "__cmpStyleOpts", {
      get: function() {
        return { state: "", mediaText: "" };
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ComponentView2.prototype, "frameView", {
      get: function() {
        return this.opts.config.frameView;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ComponentView2.prototype, "createDoc", {
      get: function() {
        var _a2, _b;
        var doc = ((_a2 = this.frameView) === null || _a2 === void 0 ? void 0 : _a2.getDoc()) || document;
        return ((_b = this.opts.config) === null || _b === void 0 ? void 0 : _b.useFrameDoc) ? doc : document;
      },
      enumerable: false,
      configurable: true
    });
    ComponentView2.prototype.__isDraggable = function() {
      var _a2 = this, model = _a2.model, config2 = _a2.config;
      var draggable = model.attributes.draggable;
      return config2.draggableComponents && draggable;
    };
    ComponentView2.prototype._clbObj = function() {
      var _a2 = this, em = _a2.em, model = _a2.model, el = _a2.el;
      return {
        editor: em === null || em === void 0 ? void 0 : em.getEditor(),
        model,
        el
      };
    };
    ComponentView2.prototype.init = function(opts) {
    };
    ComponentView2.prototype.removed = function(opts) {
    };
    ComponentView2.prototype.onRender = function(opts) {
    };
    ComponentView2.prototype.onActive = function(ev) {
    };
    ComponentView2.prototype.onDisable = function(opts) {
    };
    ComponentView2.prototype.remove = function() {
      var _a2;
      _super.prototype.remove.call(this);
      var _b = this, model = _b.model, $el = _b.$el;
      var views = model.views;
      var frame = this.frameView || {};
      model.components().forEach(function(comp) {
        var view = comp.getView(frame.model);
        view === null || view === void 0 ? void 0 : view.remove();
      });
      (_a2 = this.childrenView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      views.splice(views.indexOf(this), 1);
      this.removed(this._clbObj());
      $el.data({ model: "", collection: "", view: "" });
      return this;
    };
    ComponentView2.prototype.handleDragStart = function(event) {
      if (!this.__isDraggable())
        return false;
      event.stopPropagation();
      event.preventDefault();
      this.em.Commands.run("tlb-move", {
        target: this.model,
        event
      });
    };
    ComponentView2.prototype.initClasses = function() {
      var model = this.model;
      var classes = model.classes;
      var event = "change:classes";
      if (classes instanceof model_Selectors) {
        this.stopListening(model, event, this.initClasses);
        this.listenTo(model, event, this.initClasses);
        this.listenTo(classes, "add remove change reset", this.updateClasses);
        classes.length && this.importClasses();
      }
    };
    ComponentView2.prototype.initComponents = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, model = _a2.model, $el = _a2.$el, childrenView = _a2.childrenView;
      var event = "change:components";
      var comps = model.get("components");
      var toListen = [model, event, this.initComponents];
      if (comps instanceof model_Components) {
        $el.data("collection", comps);
        childrenView && childrenView.remove();
        this.stopListening.apply(this, toListen);
        !opts.avoidRender && this.renderChildren();
        this.listenTo.apply(this, toListen);
      }
    };
    ComponentView2.prototype.handleChange = function() {
      var model = this.model;
      var chgArr = (0, index_all.keys)(model.changed);
      if (chgArr.length === 1 && chgArr[0] === "status")
        return;
      model.emitUpdate();
      for (var prop in model.changed) {
        model.emitUpdate(prop);
      }
    };
    ComponentView2.prototype.importClasses = function() {
      var _a2 = this, em = _a2.em, model = _a2.model;
      var sm = em.Selectors;
      sm && model.classes.forEach(function(s) {
        return sm.add(s.getName());
      });
    };
    ComponentView2.prototype.updateStatus = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, el = _a2.el, ppfx = _a2.ppfx, model = _a2.model;
      var canvas2 = em === null || em === void 0 ? void 0 : em.Canvas;
      var extHl = canvas2 === null || canvas2 === void 0 ? void 0 : canvas2.config.extHl;
      var status = model.get("status");
      var selectedCls = "".concat(ppfx, "selected");
      var selectedParentCls = "".concat(selectedCls, "-parent");
      var freezedCls = "".concat(ppfx, "freezed");
      var hoveredCls = "".concat(ppfx, "hovered");
      var noPointerCls = "".concat(ppfx, "no-pointer");
      var pointerInitCls = "".concat(ppfx, "pointer-init");
      var toRemove = [selectedCls, selectedParentCls, freezedCls, hoveredCls, noPointerCls];
      var selCls = extHl && !opts.noExtHl ? "" : selectedCls;
      this.$el.removeClass(toRemove.join(" "));
      var actualCls = el.getAttribute("class") || "";
      var cls = [actualCls];
      var noCustomSpotSelect = !(canvas2 === null || canvas2 === void 0 ? void 0 : canvas2.hasCustomSpot(CanvasSpot.F.Select));
      var noCustomSpotTarget = !(canvas2 === null || canvas2 === void 0 ? void 0 : canvas2.hasCustomSpot(CanvasSpot.F.Target));
      switch (status) {
        case "selected":
          noCustomSpotSelect && cls.push(selCls);
          break;
        case "selected-parent":
          noCustomSpotTarget && cls.push(selectedParentCls);
          break;
        case "freezed":
          cls.push(freezedCls);
          break;
        case "freezed-selected":
          cls.push(freezedCls);
          noCustomSpotSelect && cls.push(selCls);
          break;
        case "hovered":
          !opts.avoidHover && cls.push(hoveredCls);
          break;
      }
      if ((0, index_all.isBoolean)(model.locked)) {
        cls.push(model.locked ? noPointerCls : pointerInitCls);
      }
      var clsStr = cls.filter(Boolean).join(" ");
      clsStr && el.setAttribute("class", clsStr);
    };
    ComponentView2.prototype.updateHighlight = function() {
      var model = this.model;
      var isTextable = model.get("textable");
      var hl = model.get("highlightable") && (isTextable || !model.isChildOf("text"));
      this.setAttribute("data-gjs-highlightable", hl ? true : "");
    };
    ComponentView2.prototype.updateStyle = function(m, v, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, model = _a2.model, em = _a2.em;
      if (avoidInline(em) && !opts.inline) {
        var styleOpts2 = this.__cmpStyleOpts;
        var style = model.getStyle(ComponentView_assign({ inline: true }, styleOpts2));
        !(0, index_all.isEmpty)(style) && model.setStyle(style, styleOpts2);
      } else {
        this.setAttribute("style", model.styleToString(opts));
      }
    };
    ComponentView2.prototype.updateClasses = function() {
      var str = this.model.classes.pluck("name").join(" ");
      this.setAttribute("class", str);
      this.updateStatus();
      this.onAttrUpdate();
    };
    ComponentView2.prototype.setAttribute = function(name, value) {
      var el = this.$el;
      value ? el.attr(name, value) : el.removeAttr(name);
    };
    ComponentView2.prototype.getClasses = function() {
      return this.model.getClasses().join(" ");
    };
    ComponentView2.prototype.updateAttributes = function() {
      var attrs = [];
      var _a2 = this, model = _a2.model, $el = _a2.$el, el = _a2.el;
      var _b = model.attributes, textable = _b.textable, type2 = _b.type;
      var defaultAttr = ComponentView_assign(ComponentView_assign({ id: model.getId(), "data-gjs-type": type2 || "default" }, this.__isDraggable() && { draggable: true }), textable && { contenteditable: "false" });
      (0, index_all.each)(el.attributes, function(attr2) {
        return attrs.push(attr2.nodeName);
      });
      attrs.forEach(function(attr2) {
        return $el.removeAttr(attr2);
      });
      this.updateStyle();
      this.updateHighlight();
      var attr = ComponentView_assign(ComponentView_assign({}, defaultAttr), model.getAttributes());
      (0, index_all.keys)(attr).forEach(function(key) {
        return attr[key] === false && delete attr[key];
      });
      $el.attr(attr);
    };
    ComponentView2.prototype.updateContent = function() {
      var content = this.model.content;
      var hasComps = this.model.components().length;
      this.getChildrenContainer().innerHTML = hasComps ? "" : content;
    };
    ComponentView2.prototype.prevDef = function(e) {
      e.preventDefault();
    };
    ComponentView2.prototype.updateScript = function() {
      var _a2 = this, model = _a2.model, em = _a2.em;
      if (!model.get("script"))
        return;
      em === null || em === void 0 ? void 0 : em.Canvas.getCanvasView().updateScript(this);
    };
    ComponentView2.prototype.getChildrenContainer = function() {
      var container = this.el;
      if (typeof this.getChildrenSelector == "function") {
        container = this.el.querySelector(this.getChildrenSelector());
      } else if (typeof this.getTemplate == "function") {
      }
      return container;
    };
    ComponentView2.prototype.getOffsetRect = function() {
      var rect = { top: 0, left: 0, bottom: 0, right: 0 };
      var target = this.el;
      var gtop = 0;
      var gleft = 0;
      var assignRect = function(el) {
        var offsetParent = el.offsetParent;
        if (offsetParent) {
          gtop += offsetParent.offsetTop;
          gleft += offsetParent.offsetLeft;
          assignRect(offsetParent);
        } else {
          rect.top = target.offsetTop + gtop;
          rect.left = target.offsetLeft + gleft;
          rect.bottom = rect.top + target.offsetHeight;
          rect.right = rect.left + target.offsetWidth;
        }
      };
      assignRect(target);
      return rect;
    };
    ComponentView2.prototype.isInViewport = function() {
      var _a2 = this, el = _a2.el, em = _a2.em, frameView = _a2.frameView;
      var canvasView = em.Canvas.getCanvasView();
      var elRect = canvasView.getElBoxRect(el, { local: true });
      var frameEl = frameView.el;
      var frameH = frameEl.clientHeight;
      var frameW = frameEl.clientWidth;
      var elTop = elRect.y;
      var elRight = elRect.x;
      var elBottom = elTop + elRect.height;
      var elLeft = elRight + elRect.width;
      var isTopInside = elTop >= 0 && elTop < frameH;
      var isBottomInside = elBottom > 0 && elBottom < frameH;
      var isLeftInside = elLeft >= 0 && elLeft < frameW;
      var isRightInside = elRight > 0 && elRight <= frameW;
      var partiallyIn = (isTopInside || isBottomInside) && (isLeftInside || isRightInside);
      return partiallyIn;
    };
    ComponentView2.prototype.scrollIntoView = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var isInViewport = this.isInViewport();
      if (!isInViewport || opts.force) {
        var el = this.el;
        if (opts.behavior !== "smooth") {
          var rect = this.getOffsetRect();
          (_a2 = el.ownerDocument.defaultView) === null || _a2 === void 0 ? void 0 : _a2.scrollTo(0, rect.top);
        } else {
          el.scrollIntoView(ComponentView_assign({ behavior: "smooth", block: "nearest" }, opts));
        }
      }
    };
    ComponentView2.prototype.reset = function() {
      var el = this.el;
      this.el = "";
      this._ensureElement();
      this._setData();
      (0, dom.bG)(el, this.el);
      this.render();
    };
    ComponentView2.prototype._setData = function() {
      var model = this.model;
      var collection = model.components();
      var view = this;
      this.$el.data({ model, collection, view });
    };
    ComponentView2.prototype._createElement = function(tagName2) {
      return this.createDoc.createElement(tagName2);
    };
    ComponentView2.prototype.renderChildren = function() {
      this.updateContent();
      var container = this.getChildrenContainer();
      var view = this.childrenView || new view_ComponentsView({
        // @ts-ignore
        collection: this.model.get("components"),
        config: this.config,
        componentTypes: this.opts.componentTypes
      });
      view.render(container);
      this.childrenView = view;
      var childNodes = Array.prototype.slice.call(view.el.childNodes);
      for (var i = 0, len = childNodes.length; i < len; i++) {
        container.appendChild(childNodes.shift());
      }
    };
    ComponentView2.prototype.renderAttributes = function() {
      this.updateAttributes();
      this.updateClasses();
    };
    ComponentView2.prototype.onAttrUpdate = function() {
    };
    ComponentView2.prototype.render = function() {
      this.renderAttributes();
      if (this.modelOpt.temporary)
        return this;
      this.renderChildren();
      this.updateScript();
      (0, mixins.setViewEl)(this.el, this);
      this.postRender();
      return this;
    };
    ComponentView2.prototype.postRender = function() {
      if (!this.modelOpt.temporary) {
        this.onRender(this._clbObj());
      }
    };
    ComponentView2.getEvents = function() {
      return (0, index_all.result)(this.prototype, "events");
    };
    return ComponentView2;
  }(common.Ss)
);
var view_ComponentView = ComponentView;
var ComponentTextNodeView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTextNodeView = (
  /** @class */
  function(_super) {
    ComponentTextNodeView_extends(ComponentTextNodeView2, _super);
    function ComponentTextNodeView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentTextNodeView2.prototype._setAttributes = function() {
    };
    ComponentTextNodeView2.prototype.renderAttributes = function() {
    };
    ComponentTextNodeView2.prototype.updateStatus = function() {
    };
    ComponentTextNodeView2.prototype.updateClasses = function() {
    };
    ComponentTextNodeView2.prototype.setAttribute = function() {
    };
    ComponentTextNodeView2.prototype.updateAttributes = function() {
    };
    ComponentTextNodeView2.prototype.initClasses = function() {
    };
    ComponentTextNodeView2.prototype.initComponents = function() {
    };
    ComponentTextNodeView2.prototype.delegateEvents = function() {
      return this;
    };
    ComponentTextNodeView2.prototype._createElement = function() {
      return document.createTextNode("");
    };
    ComponentTextNodeView2.prototype.render = function() {
      var _a2 = this, model = _a2.model, el = _a2.el;
      if (model.opt.temporary)
        return this;
      el.textContent = model.content;
      return this;
    };
    return ComponentTextNodeView2;
  }(view_ComponentView)
);
var view_ComponentTextNodeView = ComponentTextNodeView;
var ComponentCommentView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentCommentView = (
  /** @class */
  function(_super) {
    ComponentCommentView_extends(ComponentCommentView2, _super);
    function ComponentCommentView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentCommentView2.prototype._createElement = function() {
      return document.createComment(this.model.content);
    };
    return ComponentCommentView2;
  }(view_ComponentTextNodeView)
);
var view_ComponentCommentView = ComponentCommentView;
var ComponentFrameView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentFrameView = (
  /** @class */
  function(_super) {
    ComponentFrameView_extends(ComponentFrameView2, _super);
    function ComponentFrameView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentFrameView2.prototype.tagName = function() {
      return "div";
    };
    ComponentFrameView2.prototype.initialize = function(props) {
      _super.prototype.initialize.call(this, props);
      this.listenTo(this.model, "change:attributes:src", this.updateSrc);
    };
    ComponentFrameView2.prototype.updateSrc = function() {
      var frame = (0, dom.I6)(this.el, "iframe")[0];
      frame && (0, dom.X6)(frame, { src: this.__getSrc() });
    };
    ComponentFrameView2.prototype.render = function() {
      _super.prototype.render.call(this);
      var frame = (0, dom.a_)("iframe", {
        class: "".concat(this.ppfx, "no-pointer"),
        style: "width: 100%; height: 100%; border: none",
        src: this.__getSrc()
      });
      this.el.appendChild(frame);
      return this;
    };
    ComponentFrameView2.prototype.__getSrc = function() {
      return this.model.getAttributes().src || "";
    };
    return ComponentFrameView2;
  }(view_ComponentView)
);
var view_ComponentFrameView = ComponentFrameView;
var ComponentImageView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentImageView = (
  /** @class */
  function(_super) {
    ComponentImageView_extends(ComponentImageView2, _super);
    function ComponentImageView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentImageView2.prototype.tagName = function() {
      return "img";
    };
    ComponentImageView2.prototype.events = function() {
      return {
        dblclick: "onActive",
        click: "initResize",
        error: "onError",
        load: "onLoad",
        dragstart: "noDrag"
      };
    };
    ComponentImageView2.prototype.initialize = function(props) {
      _super.prototype.initialize.call(this, props);
      this.listenTo(this.model, "change:src", this.updateSrc);
      this.classEmpty = "".concat(this.ppfx, "plh-image");
      this.fetchFile();
    };
    ComponentImageView2.prototype.fetchFile = function() {
      if (this.modelOpt.temporary)
        return;
      var _a2 = this, model = _a2.model, em = _a2.em;
      var file = model.get("file");
      if (file && em) {
        var fu = em.Assets.FileUploader();
        fu === null || fu === void 0 ? void 0 : fu.uploadFile({
          // @ts-ignore
          dataTransfer: { files: [file] }
        }, function(res) {
          var obj = res && res.data && res.data[0];
          var src2 = obj && ((0, index_all.isString)(obj) ? obj : obj.src);
          src2 && model.set({ src: src2 });
        });
        model.set("file", "");
      }
    };
    ComponentImageView2.prototype.updateSrc = function() {
      var model = this.model;
      model.addAttributes({ src: model.getSrcResult() });
      this.updateClasses();
    };
    ComponentImageView2.prototype.updateClasses = function() {
      _super.prototype.updateClasses.call(this);
      var _a2 = this, el = _a2.el, classEmpty = _a2.classEmpty, model = _a2.model;
      var srcExists = model.getSrcResult() && !model.isDefaultSrc();
      var method = srcExists ? "remove" : "add";
      el.classList[method](classEmpty);
    };
    ComponentImageView2.prototype.onActive = function(ev) {
      ev === null || ev === void 0 ? void 0 : ev.stopPropagation();
      var _a2 = this, em = _a2.em, model = _a2.model;
      var am = em === null || em === void 0 ? void 0 : em.Assets;
      if (am && model.get("editable")) {
        am.open({
          select: function(asset, complete) {
            model.set({ src: asset.getSrc() });
            complete && am.close();
          },
          target: model,
          types: ["image"],
          accept: "image/*"
        });
      }
    };
    ComponentImageView2.prototype.onError = function() {
      var fallback = this.model.getSrcResult({ fallback: true });
      if (fallback) {
        this.el.src = fallback;
      }
    };
    ComponentImageView2.prototype.onLoad = function() {
      this.em.Canvas.refresh({ all: true });
    };
    ComponentImageView2.prototype.noDrag = function(ev) {
      ev.preventDefault();
      return false;
    };
    ComponentImageView2.prototype.render = function() {
      this.renderAttributes();
      if (this.modelOpt.temporary)
        return this;
      this.updateSrc();
      var _a2 = this, $el = _a2.$el, model = _a2.model;
      var cls = $el.attr("class") || "";
      !model.get("src") && $el.attr("class", "".concat(cls, " ").concat(this.classEmpty).trim());
      this.postRender();
      return this;
    };
    return ComponentImageView2;
  }(view_ComponentView)
);
var view_ComponentImageView = ComponentImageView;
var ComponentTextView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTextView_assign = function() {
  ComponentTextView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ComponentTextView_assign.apply(this, arguments);
};
var __awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var __generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var ComponentTextView = (
  /** @class */
  function(_super) {
    ComponentTextView_extends(ComponentTextView2, _super);
    function ComponentTextView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentTextView2.prototype.events = function() {
      return {
        dblclick: "onActive",
        input: "onInput"
      };
    };
    ComponentTextView2.prototype.initialize = function(props) {
      _super.prototype.initialize.call(this, props);
      (0, index_all.bindAll)(this, "disableEditing", "onDisable");
      var model = this.model;
      var em = this.em;
      this.listenTo(model, "focus", this.onActive);
      this.listenTo(model, "change:content", this.updateContentText);
      this.listenTo(model, "sync:content", this.syncContent);
      this.rte = em === null || em === void 0 ? void 0 : em.RichTextEditor;
    };
    ComponentTextView2.prototype.updateContentText = function(m, v, opts) {
      if (opts === void 0) {
        opts = {};
      }
      !opts.fromDisable && this.disableEditing();
    };
    ComponentTextView2.prototype.canActivate = function() {
      var _a2 = this, model = _a2.model, rteEnabled = _a2.rteEnabled, em = _a2.em;
      var modelInEdit = em === null || em === void 0 ? void 0 : em.getEditing();
      var sameInEdit = modelInEdit === model;
      var result = true;
      var isInnerText = false;
      var delegate;
      if (rteEnabled || !model.get("editable") || sameInEdit || (isInnerText = model.isChildOf("text"))) {
        result = false;
        if (isInnerText && !model.get("textable")) {
          var parent_1 = model.parent();
          while (parent_1 && !parent_1.isInstanceOf("text")) {
            parent_1 = parent_1.parent();
          }
          if (parent_1 && parent_1.get("editable")) {
            delegate = parent_1;
          } else {
            result = true;
          }
        }
      }
      return { result, delegate };
    };
    ComponentTextView2.prototype.onActive = function(ev) {
      return __awaiter(this, void 0, void 0, function() {
        var _a2, rte, em, _b, result, delegate, _c, _d, err_1;
        var _e, _f;
        return __generator(this, function(_g) {
          switch (_g.label) {
            case 0:
              _a2 = this, rte = _a2.rte, em = _a2.em;
              _b = this.canActivate(), result = _b.result, delegate = _b.delegate;
              if (!result) {
                if (delegate) {
                  (_e = ev === null || ev === void 0 ? void 0 : ev.stopPropagation) === null || _e === void 0 ? void 0 : _e.call(ev);
                  em.setSelected(delegate);
                  delegate.trigger("active", ev);
                }
                return [
                  2
                  /*return*/
                ];
              }
              (_f = ev === null || ev === void 0 ? void 0 : ev.stopPropagation) === null || _f === void 0 ? void 0 : _f.call(ev);
              _c = this;
              return [4, this.getContent()];
            case 1:
              _c.lastContent = _g.sent();
              if (!rte)
                return [3, 5];
              _g.label = 2;
            case 2:
              _g.trys.push([2, 4, , 5]);
              _d = this;
              return [4, rte.enable(this, this.activeRte, { event: ev })];
            case 3:
              _d.activeRte = _g.sent();
              return [3, 5];
            case 4:
              err_1 = _g.sent();
              em.logError(err_1);
              return [3, 5];
            case 5:
              this.toggleEvents(true);
              return [
                2
                /*return*/
              ];
          }
        });
      });
    };
    ComponentTextView2.prototype.onDisable = function(opts) {
      this.disableEditing(opts);
    };
    ComponentTextView2.prototype.disableEditing = function() {
      return __awaiter(this, arguments, void 0, function(opts) {
        var _a2, model, rte, activeRte, em, editable, err_2, _b;
        if (opts === void 0) {
          opts = {};
        }
        return __generator(this, function(_c) {
          switch (_c.label) {
            case 0:
              _a2 = this, model = _a2.model, rte = _a2.rte, activeRte = _a2.activeRte, em = _a2.em;
              editable = model && model.get("editable");
              if (!rte)
                return [3, 8];
              _c.label = 1;
            case 1:
              _c.trys.push([1, 3, , 4]);
              return [4, rte.disable(this, activeRte, opts)];
            case 2:
              _c.sent();
              return [3, 4];
            case 3:
              err_2 = _c.sent();
              em.logError(err_2);
              return [3, 4];
            case 4:
              _b = editable;
              if (!_b)
                return [3, 6];
              return [4, this.getContent()];
            case 5:
              _b = _c.sent() !== this.lastContent;
              _c.label = 6;
            case 6:
              if (!_b)
                return [3, 8];
              return [4, this.syncContent(opts)];
            case 7:
              _c.sent();
              this.lastContent = "";
              _c.label = 8;
            case 8:
              this.toggleEvents();
              return [
                2
                /*return*/
              ];
          }
        });
      });
    };
    ComponentTextView2.prototype.getContent = function() {
      return __awaiter(this, void 0, void 0, function() {
        var _a2, rte, activeRte, result;
        return __generator(this, function(_b) {
          switch (_b.label) {
            case 0:
              _a2 = this, rte = _a2.rte, activeRte = _a2.activeRte;
              result = "";
              if (!rte)
                return [3, 2];
              return [4, rte.getContent(this, activeRte)];
            case 1:
              result = _b.sent();
              _b.label = 2;
            case 2:
              return [2, result];
          }
        });
      });
    };
    ComponentTextView2.prototype.syncContent = function() {
      return __awaiter(this, arguments, void 0, function(opts) {
        var _a2, model, rte, rteEnabled, content, comps, contentOpt;
        if (opts === void 0) {
          opts = {};
        }
        return __generator(this, function(_b) {
          switch (_b.label) {
            case 0:
              _a2 = this, model = _a2.model, rte = _a2.rte, rteEnabled = _a2.rteEnabled;
              if (!rteEnabled && !opts.force)
                return [
                  2
                  /*return*/
                ];
              return [4, this.getContent()];
            case 1:
              content = _b.sent();
              comps = model.components();
              contentOpt = ComponentTextView_assign({ fromDisable: 1 }, opts);
              model.set("content", "", contentOpt);
              if ((rte === null || rte === void 0 ? void 0 : rte.customRte) && !rte.customRte.parseContent) {
                comps.length && comps.reset(void 0, ComponentTextView_assign(ComponentTextView_assign({}, opts), {
                  // @ts-ignore
                  keepIds: getComponentIds(comps)
                }));
                model.set("content", content, contentOpt);
              } else {
                comps.resetFromString(content, opts);
              }
              return [
                2
                /*return*/
              ];
          }
        });
      });
    };
    ComponentTextView2.prototype.insertComponent = function(content, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = this, model = _b.model, el = _b.el;
      var doc = el.ownerDocument;
      var selection = doc.getSelection();
      if (selection === null || selection === void 0 ? void 0 : selection.rangeCount) {
        var range = selection.getRangeAt(0);
        var textNode_1 = range.startContainer;
        var offset_1 = range.startOffset;
        var textModel_1 = (0, mixins.getComponentModel)(textNode_1);
        var newCmps_1 = [];
        if (textModel_1 && ((_a2 = textModel_1.is) === null || _a2 === void 0 ? void 0 : _a2.call(textModel_1, "textnode"))) {
          var cmps = textModel_1.collection;
          cmps.forEach(function(cmp) {
            if (cmp === textModel_1) {
              var type2 = "textnode";
              var cnt = opts.useDomContent ? textNode_1.textContent || "" : cmp.content;
              newCmps_1.push({ type: type2, content: cnt.slice(0, offset_1) });
              newCmps_1.push(content);
              newCmps_1.push({ type: type2, content: cnt.slice(offset_1) });
            } else {
              newCmps_1.push(cmp);
            }
          });
          var result = newCmps_1.filter(Boolean);
          var index2 = result.indexOf(content);
          cmps.reset(result, opts);
          return cmps.at(index2);
        }
      }
      return model.append(content, opts);
    };
    ComponentTextView2.prototype.onInput = function() {
      var em = this.em;
      var evPfx2 = "component";
      var ev = ["".concat(evPfx2, ":update"), "".concat(evPfx2, ":input")].join(" ");
      em && em.trigger(ev, this.model);
    };
    ComponentTextView2.prototype.disablePropagation = function(e) {
      e.stopPropagation();
    };
    ComponentTextView2.prototype.toggleEvents = function(enable) {
      var _a2 = this, em = _a2.em, model = _a2.model, $el = _a2.$el;
      var mixins2 = { on: dom.on, off: dom.AU };
      var method = enable ? "on" : "off";
      em.setEditing(enable ? this : false);
      this.rteEnabled = !!enable;
      var elDocs = [this.el.ownerDocument, document];
      mixins2.off(elDocs, "mousedown", this.onDisable);
      mixins2[method](elDocs, "mousedown", this.onDisable);
      em[method]("toolbar:run:before", this.onDisable);
      if (model) {
        model[method]("removed", this.onDisable);
        model.trigger("rte:".concat(enable ? "enable" : "disable"));
      }
      $el === null || $el === void 0 ? void 0 : $el.off("mousedown", this.disablePropagation);
      $el && $el[method]("mousedown", this.disablePropagation);
      if (this.config.draggableComponents) {
        var el = this.el;
        while (el) {
          el.draggable = enable ? false : true;
          el = el.parentNode;
          if (el && el.tagName == "BODY") {
            el = 0;
          }
        }
      }
    };
    return ComponentTextView2;
  }(view_ComponentView)
);
var view_ComponentTextView = ComponentTextView;
var ComponentLinkView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentLinkView = (
  /** @class */
  function(_super) {
    ComponentLinkView_extends(ComponentLinkView2, _super);
    function ComponentLinkView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentLinkView2.prototype.render = function() {
      _super.prototype.render.call(this);
      this.el.addEventListener("click", this.prevDef, true);
      return this;
    };
    return ComponentLinkView2;
  }(view_ComponentTextView)
);
var view_ComponentLinkView = ComponentLinkView;
var ComponentLabelView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentLabelView = (
  /** @class */
  function(_super) {
    ComponentLabelView_extends(ComponentLabelView2, _super);
    function ComponentLabelView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return ComponentLabelView2;
  }(view_ComponentLinkView)
);
var view_ComponentLabelView = ComponentLabelView;
var ComponentMapView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentMapView = (
  /** @class */
  function(_super) {
    ComponentMapView_extends(ComponentMapView2, _super);
    function ComponentMapView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentMapView2.prototype.tagName = function() {
      return "div";
    };
    ComponentMapView2.prototype.events = function() {
      return {};
    };
    ComponentMapView2.prototype.initialize = function(props) {
      _super.prototype.initialize.call(this, props);
      this.classEmpty = this.ppfx + "plh-map";
    };
    ComponentMapView2.prototype.updateSrc = function() {
      this.getIframe().src = this.model.get("src");
    };
    ComponentMapView2.prototype.getIframe = function() {
      if (!this.iframe) {
        var ifrm = document.createElement("iframe");
        ifrm.src = this.model.get("src");
        ifrm.frameBorder = "0";
        ifrm.style.height = "100%";
        ifrm.style.width = "100%";
        ifrm.className = this.ppfx + "no-pointer";
        this.iframe = ifrm;
      }
      return this.iframe;
    };
    ComponentMapView2.prototype.render = function() {
      _super.prototype.render.call(this);
      this.updateClasses();
      this.el.appendChild(this.getIframe());
      return this;
    };
    return ComponentMapView2;
  }(view_ComponentImageView)
);
var view_ComponentMapView = ComponentMapView;
var ComponentScriptView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentScriptView = (
  /** @class */
  function(_super) {
    ComponentScriptView_extends(ComponentScriptView2, _super);
    function ComponentScriptView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentScriptView2.prototype.tagName = function() {
      return "script";
    };
    ComponentScriptView2.prototype.events = function() {
      return {};
    };
    return ComponentScriptView2;
  }(view_ComponentView)
);
var view_ComponentScriptView = ComponentScriptView;
var ComponentSvgView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentSvgView = (
  /** @class */
  function(_super) {
    ComponentSvgView_extends(ComponentSvgView2, _super);
    function ComponentSvgView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentSvgView2.prototype._createElement = function(tagName2) {
      return document.createElementNS("http://www.w3.org/2000/svg", tagName2);
    };
    return ComponentSvgView2;
  }(view_ComponentView)
);
var view_ComponentSvgView = ComponentSvgView;
var ComponentTableBodyView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableBodyView = (
  /** @class */
  function(_super) {
    ComponentTableBodyView_extends(ComponentTableBodyView2, _super);
    function ComponentTableBodyView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return ComponentTableBodyView2;
  }(view_ComponentView)
);
var view_ComponentTableBodyView = ComponentTableBodyView;
var ComponentTableCellView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableCellView = (
  /** @class */
  function(_super) {
    ComponentTableCellView_extends(ComponentTableCellView2, _super);
    function ComponentTableCellView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return ComponentTableCellView2;
  }(view_ComponentView)
);
var view_ComponentTableCellView = ComponentTableCellView;
var ComponentTableFootView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableFootView = (
  /** @class */
  function(_super) {
    ComponentTableFootView_extends(ComponentTableFootView2, _super);
    function ComponentTableFootView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return ComponentTableFootView2;
  }(view_ComponentView)
);
var view_ComponentTableFootView = ComponentTableFootView;
var ComponentTableHeadView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableHeadView = (
  /** @class */
  function(_super) {
    ComponentTableHeadView_extends(ComponentTableHeadView2, _super);
    function ComponentTableHeadView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return ComponentTableHeadView2;
  }(view_ComponentView)
);
var view_ComponentTableHeadView = ComponentTableHeadView;
var ComponentTableRowView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableRowView = (
  /** @class */
  function(_super) {
    ComponentTableRowView_extends(ComponentTableRowView2, _super);
    function ComponentTableRowView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return ComponentTableRowView2;
  }(view_ComponentView)
);
var view_ComponentTableRowView = ComponentTableRowView;
var ComponentTableView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentTableView = (
  /** @class */
  function(_super) {
    ComponentTableView_extends(ComponentTableView2, _super);
    function ComponentTableView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentTableView2.prototype.events = function() {
      return {};
    };
    return ComponentTableView2;
  }(view_ComponentView)
);
var view_ComponentTableView = ComponentTableView;
var ComponentVideoView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentVideoView = (
  /** @class */
  function(_super) {
    ComponentVideoView_extends(ComponentVideoView2, _super);
    function ComponentVideoView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentVideoView2.prototype.tagName = function() {
      return "div";
    };
    ComponentVideoView2.prototype.events = function() {
      return {};
    };
    ComponentVideoView2.prototype.initialize = function() {
      view_ComponentView.prototype.initialize.apply(this, arguments);
      var model = this.model;
      var props = ["loop", "autoplay", "controls", "color", "rel", "modestbranding", "poster"];
      var events2 = props.map(function(p) {
        return "change:".concat(p);
      }).join(" ");
      this.listenTo(model, "change:provider", this.updateProvider);
      this.listenTo(model, "change:src", this.updateSrc);
      this.listenTo(model, events2, this.updateVideo);
    };
    ComponentVideoView2.prototype.updateProvider = function() {
      var prov = this.model.get("provider");
      this.el.innerHTML = "";
      this.el.appendChild(this.renderByProvider(prov));
    };
    ComponentVideoView2.prototype.updateSrc = function() {
      var _a2 = this, model = _a2.model, videoEl = _a2.videoEl;
      if (!videoEl)
        return;
      var prov = model.get("provider");
      var src2 = model.get("src");
      switch (prov) {
        case "yt":
          src2 = model.getYoutubeSrc();
          break;
        case "ytnc":
          src2 = model.getYoutubeNoCookieSrc();
          break;
        case "vi":
          src2 = model.getVimeoSrc();
          break;
      }
      videoEl.src = src2;
    };
    ComponentVideoView2.prototype.updateVideo = function() {
      var _a2 = this, model = _a2.model, videoEl = _a2.videoEl;
      var prov = model.get("provider");
      switch (prov) {
        case "yt":
        case "ytnc":
        case "vi":
          model.trigger("change:videoId");
          break;
        default: {
          if (videoEl) {
            var el = videoEl;
            el.loop = model.get("loop");
            el.autoplay = model.get("autoplay");
            el.controls = model.get("controls");
            el.poster = model.get("poster");
          }
        }
      }
    };
    ComponentVideoView2.prototype.renderByProvider = function(prov) {
      var videoEl;
      switch (prov) {
        case "yt":
          videoEl = this.renderYoutube();
          break;
        case "ytnc":
          videoEl = this.renderYoutubeNoCookie();
          break;
        case "vi":
          videoEl = this.renderVimeo();
          break;
        default:
          videoEl = this.renderSource();
      }
      this.videoEl = videoEl;
      return videoEl;
    };
    ComponentVideoView2.prototype.renderSource = function() {
      var el = document.createElement("video");
      el.src = this.model.get("src");
      this.initVideoEl(el);
      return el;
    };
    ComponentVideoView2.prototype.renderYoutube = function() {
      var el = document.createElement("iframe");
      el.src = this.model.getYoutubeSrc();
      el.frameBorder = "0";
      el.setAttribute("allowfullscreen", "true");
      this.initVideoEl(el);
      return el;
    };
    ComponentVideoView2.prototype.renderYoutubeNoCookie = function() {
      var el = document.createElement("iframe");
      el.src = this.model.getYoutubeNoCookieSrc();
      el.frameBorder = "0";
      el.setAttribute("allowfullscreen", "true");
      this.initVideoEl(el);
      return el;
    };
    ComponentVideoView2.prototype.renderVimeo = function() {
      var el = document.createElement("iframe");
      el.src = this.model.getVimeoSrc();
      el.frameBorder = "0";
      el.setAttribute("allowfullscreen", "true");
      this.initVideoEl(el);
      return el;
    };
    ComponentVideoView2.prototype.initVideoEl = function(el) {
      el.className = this.ppfx + "no-pointer";
      el.style.height = "100%";
      el.style.width = "100%";
    };
    ComponentVideoView2.prototype.render = function() {
      view_ComponentView.prototype.render.apply(this);
      this.updateClasses();
      var prov = this.model.get("provider");
      this.el.appendChild(this.renderByProvider(prov));
      this.updateVideo();
      return this;
    };
    return ComponentVideoView2;
  }(view_ComponentImageView)
);
var view_ComponentVideoView = ComponentVideoView;
var ComponentWrapperView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ComponentWrapperView = (
  /** @class */
  function(_super) {
    ComponentWrapperView_extends(ComponentWrapperView2, _super);
    function ComponentWrapperView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    ComponentWrapperView2.prototype.tagName = function() {
      return "div";
    };
    return ComponentWrapperView2;
  }(view_ComponentView)
);
var view_ComponentWrapperView = ComponentWrapperView;
var Symbols_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Symbols_assign = function() {
  Symbols_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Symbols_assign.apply(this, arguments);
};
var Symbols = (
  /** @class */
  function(_super) {
    Symbols_extends(Symbols2, _super);
    function Symbols2() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      var _this = _super.apply(this, args) || this;
      _this.refreshDbn = (0, index_all.debounce)(function() {
        return _this.refresh();
      }, 0);
      var events2 = _this.events;
      _this.on(events2.update, _this.onUpdate);
      _this.on(events2.updateInside, _this.onUpdateDeep);
      return _this;
    }
    Symbols2.prototype.removeChildren = function(component, coll, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      _super.prototype.removeChildren.call(this, component, coll, opts);
      (_a2 = getSymbolInstances(component)) === null || _a2 === void 0 ? void 0 : _a2.forEach(function(i) {
        return detachSymbolInstance(i, { skipRefs: true });
      });
      this.__trgEvent(this.events.symbolMainRemove, { component });
    };
    Symbols2.prototype.onAdd = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      _super.prototype.onAdd.apply(this, args);
      var component = args[0];
      this.__trgEvent(this.events.symbolMainAdd, { component });
    };
    Symbols2.prototype.onUpdate = function(props) {
      this.__trgEvent(this.events.symbolMainUpdate, props);
    };
    Symbols2.prototype.onUpdateDeep = function(props) {
      this.__trgEvent(this.events.symbolMainUpdateDeep, props);
    };
    Symbols2.prototype.refresh = function() {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      em.trigger(events2.symbol);
    };
    Symbols2.prototype.__trgEvent = function(event, props, isInstance) {
      if (isInstance === void 0) {
        isInstance = false;
      }
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      var eventType = isInstance ? events2.symbolInstance : events2.symbolMain;
      em.trigger(event, props);
      em.trigger(eventType, Symbols_assign(Symbols_assign({}, props), { event }));
      this.refreshDbn();
    };
    return Symbols2;
  }(model_Components)
);
var model_Symbols = Symbols;
var dom_components_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var dom_components_assign = function() {
  dom_components_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return dom_components_assign.apply(this, arguments);
};
var dom_components_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var dom_components_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var CanMoveReason;
(function(CanMoveReason2) {
  CanMoveReason2[CanMoveReason2["InvalidSource"] = 0] = "InvalidSource";
  CanMoveReason2[CanMoveReason2["SourceReject"] = 1] = "SourceReject";
  CanMoveReason2[CanMoveReason2["TargetReject"] = 2] = "TargetReject";
})(CanMoveReason || (CanMoveReason = {}));
var ComponentManager = (
  /** @class */
  function(_super) {
    dom_components_extends(ComponentManager2, _super);
    function ComponentManager2(em) {
      var _this = _super.call(this, em, "DomComponents", new model_Components(void 0, { em })) || this;
      _this.componentTypes = [
        {
          id: "cell",
          model: model_ComponentTableCell,
          view: view_ComponentTableCellView
        },
        {
          id: "row",
          model: model_ComponentTableRow,
          view: view_ComponentTableRowView
        },
        {
          id: "table",
          model: model_ComponentTable,
          view: view_ComponentTableView
        },
        {
          id: "thead",
          model: model_ComponentTableHead,
          view: view_ComponentTableHeadView
        },
        {
          id: "tbody",
          model: model_ComponentTableBody,
          view: view_ComponentTableBodyView
        },
        {
          id: "tfoot",
          model: model_ComponentTableFoot,
          view: view_ComponentTableFootView
        },
        {
          id: "map",
          model: model_ComponentMap,
          view: view_ComponentMapView
        },
        {
          id: "link",
          model: model_ComponentLink,
          view: view_ComponentLinkView
        },
        {
          id: "label",
          model: model_ComponentLabel,
          view: view_ComponentLabelView
        },
        {
          id: "video",
          model: model_ComponentVideo,
          view: view_ComponentVideoView
        },
        {
          id: "image",
          model: model_ComponentImage,
          view: view_ComponentImageView
        },
        {
          id: "script",
          model: model_ComponentScript,
          view: view_ComponentScriptView
        },
        {
          id: "svg-in",
          model: model_ComponentSvgIn,
          view: view_ComponentSvgView
        },
        {
          id: "svg",
          model: model_ComponentSvg,
          view: view_ComponentSvgView
        },
        {
          id: "iframe",
          model: model_ComponentFrame,
          view: view_ComponentFrameView
        },
        {
          id: "comment",
          model: model_ComponentComment,
          view: view_ComponentCommentView
        },
        {
          id: "textnode",
          model: model_ComponentTextNode,
          view: view_ComponentTextNodeView
        },
        {
          id: type,
          model: model_ComponentHead,
          view: view_ComponentView
        },
        {
          id: "wrapper",
          model: model_ComponentWrapper,
          view: view_ComponentWrapperView
        },
        {
          id: "text",
          model: model_ComponentText,
          view: view_ComponentTextView
        },
        {
          id: "default",
          model: model_Component,
          view: view_ComponentView
        }
      ];
      _this.componentsById = {};
      _this.Component = model_Component;
      _this.Components = model_Components;
      _this.ComponentView = view_ComponentView;
      _this.ComponentsView = view_ComponentsView;
      _this.storageKey = "components";
      _this.keySymbols = "symbols";
      _this.events = dom_components_types.I;
      var config2 = _this.config;
      _this.symbols = new model_Symbols([], { em, config: config2, domc: _this });
      if (em) {
        _this.config.components = em.config.components || _this.config.components;
      }
      for (var name_1 in dom_components_config_config) {
        if (!(name_1 in _this.config))
          _this.config[name_1] = dom_components_config_config[name_1];
      }
      var ppfx = _this.config.pStylePrefix;
      if (ppfx)
        _this.config.stylePrefix = ppfx + _this.config.stylePrefix;
      if (em) {
        em.get("Parser").compTypes = _this.componentTypes;
        em.on("change:componentHovered", _this.componentHovered, _this);
        var selected_1 = em.get("selected");
        em.listenTo(selected_1, "add", function(sel, c, opts) {
          return _this.selectAdd(selected_1.getComponent(sel), opts);
        });
        em.listenTo(selected_1, "remove", function(sel, c, opts) {
          return _this.selectRemove(selected_1.getComponent(sel), opts);
        });
      }
      return _this;
    }
    ComponentManager2.prototype.postLoad = function() {
      var _a2 = this, em = _a2.em, symbols = _a2.symbols;
      var UndoManager = em.UndoManager;
      UndoManager.add(symbols);
    };
    ComponentManager2.prototype.load = function(data) {
      var _this = this;
      var result = this.loadProjectData(data, {
        onResult: function(result2) {
          var wrapper = _this.getWrapper();
          if (!wrapper) {
            _this.em.Pages.add({}, { select: true });
            wrapper = _this.getWrapper();
          }
          if ((0, index_all.isArray)(result2)) {
            result2.length && wrapper.components(result2);
          } else {
            var _a2 = result2.components, components = _a2 === void 0 ? [] : _a2, rest = dom_components_rest(result2, ["components"]);
            wrapper.set(rest);
            wrapper.components(components);
          }
        }
      });
      this.symbols.reset(data[this.keySymbols] || []);
      return result;
    };
    ComponentManager2.prototype.store = function() {
      var _a2;
      return _a2 = {}, _a2[this.keySymbols] = this.symbols, _a2;
    };
    ComponentManager2.prototype.getComponent = function() {
      var sel = this.em.Pages.getSelected();
      var frame = sel === null || sel === void 0 ? void 0 : sel.getMainFrame();
      return frame === null || frame === void 0 ? void 0 : frame.getComponent();
    };
    ComponentManager2.prototype.getWrapper = function() {
      return this.getComponent();
    };
    ComponentManager2.prototype.getComponents = function() {
      var wrp = this.getWrapper();
      return wrp === null || wrp === void 0 ? void 0 : wrp.components();
    };
    ComponentManager2.prototype.addComponent = function(component, opt) {
      if (opt === void 0) {
        opt = {};
      }
      return this.getComponents().add(component, opt);
    };
    ComponentManager2.prototype.render = function() {
      var _a2;
      return (_a2 = this.componentView) === null || _a2 === void 0 ? void 0 : _a2.render().el;
    };
    ComponentManager2.prototype.clear = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var components = this.getComponents();
      components === null || components === void 0 ? void 0 : components.filter(Boolean).forEach(function(i) {
        return i.remove(opts);
      });
      return this;
    };
    ComponentManager2.prototype.setComponents = function(components, opt) {
      if (opt === void 0) {
        opt = {};
      }
      this.clear(opt).addComponent(components, opt);
    };
    ComponentManager2.prototype.addType = function(type2, methods) {
      var em = this.em;
      var _a2 = methods.model, model = _a2 === void 0 ? {} : _a2, _b = methods.view, view = _b === void 0 ? {} : _b, isComponent = methods.isComponent, extend = methods.extend, extendView = methods.extendView, _c = methods.extendFn, extendFn = _c === void 0 ? [] : _c, _d = methods.extendFnView, extendFnView = _d === void 0 ? [] : _d, block = methods.block;
      var compType = this.getType(type2);
      var extendType = this.getType(extend);
      var extendViewType = this.getType(extendView);
      var typeToExtend = extendType ? extendType : compType ? compType : this.getType("default");
      var modelToExt = typeToExtend.model;
      var viewToExt = extendViewType ? extendViewType.view : typeToExtend.view;
      var getExtendedObj = function(fns, target, srcToExt) {
        return fns.reduce(function(res, next) {
          var fn = target[next];
          var parentFn = srcToExt.prototype[next];
          if (fn && parentFn) {
            res[next] = function() {
              var args = [];
              for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
              }
              parentFn.bind(this).apply(void 0, args);
              fn.bind(this).apply(void 0, args);
            };
          }
          return res;
        }, {});
      };
      if (typeof model === "object") {
        var modelDefaults_1 = { defaults: model.defaults };
        delete model.defaults;
        var typeExtends = new Set(modelToExt.typeExtends);
        typeExtends.add(modelToExt.getDefaults().type);
        methods.model = modelToExt.extend(dom_components_assign(dom_components_assign({}, model), getExtendedObj(extendFn, model, modelToExt)), {
          typeExtends,
          isComponent: compType && !extendType && !isComponent ? modelToExt.isComponent : isComponent || function() {
            return 0;
          }
        });
        Object.defineProperty(methods.model.prototype, "defaults", {
          get: function() {
            return dom_components_assign(dom_components_assign({}, (0, index_all.result)(modelToExt.prototype, "defaults") || {}), (0, index_all.result)(modelDefaults_1, "defaults") || {});
          }
        });
      }
      if (typeof view === "object") {
        methods.view = viewToExt.extend(dom_components_assign(dom_components_assign({}, view), getExtendedObj(extendFnView, view, viewToExt)));
      }
      if (compType) {
        compType.model = methods.model;
        compType.view = methods.view;
      } else {
        methods.id = type2;
        this.componentTypes.unshift(methods);
      }
      if (block) {
        var defBlockProps = {
          id: type2,
          label: type2,
          content: { type: type2 }
        };
        var blockProps = block === true ? defBlockProps : dom_components_assign(dom_components_assign({}, defBlockProps), block);
        em.Blocks.add(blockProps.id || type2, blockProps);
      }
      var event = "component:type:".concat(compType ? "update" : "add");
      em === null || em === void 0 ? void 0 : em.trigger(event, compType || methods);
      return this;
    };
    ComponentManager2.prototype.getType = function(type2) {
      var df = this.componentTypes;
      for (var it = 0; it < df.length; it++) {
        var dfId = df[it].id;
        if (dfId == type2) {
          return df[it];
        }
      }
      return;
    };
    ComponentManager2.prototype.removeType = function(id) {
      var df = this.componentTypes;
      var type2 = this.getType(id);
      if (!type2)
        return;
      var index2 = df.indexOf(type2);
      df.splice(index2, 1);
      return type2;
    };
    ComponentManager2.prototype.getTypes = function() {
      return this.componentTypes;
    };
    ComponentManager2.prototype.selectAdd = function(component, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      if (component) {
        component.set({
          status: "selected"
        });
        ["component:selected", "component:toggled"].forEach(function(event) {
          return _this.em.trigger(event, component, opts);
        });
      }
    };
    ComponentManager2.prototype.selectRemove = function(component, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      if (component) {
        var em = this.em;
        component.set({
          status: "",
          state: ""
        });
        ["component:deselected", "component:toggled"].forEach(function(event) {
          return _this.em.trigger(event, component, opts);
        });
      }
    };
    ComponentManager2.prototype.componentHovered = function() {
      var em = this.em;
      var model = em.get("componentHovered");
      var previous = em.previous("componentHovered");
      var state = "hovered";
      previous && previous.get("status") == state && previous.set({
        status: "",
        state: ""
      });
      model && (0, index_all.isEmpty)(model.get("status")) && model.set("status", state);
    };
    ComponentManager2.prototype.getShallowWrapper = function() {
      var _a2 = this, shallow = _a2.shallow, em = _a2.em;
      if (!shallow && em) {
        var shallowEm = em.shallow;
        if (!shallowEm)
          return;
        var domc = shallowEm.Components;
        domc.componentTypes = this.componentTypes;
        shallow = domc.getWrapper();
        if (shallow) {
          var events2 = [keyUpdate, keyUpdateInside].join(" ");
          shallow.on(events2, (0, index_all.debounce)(function() {
            return shallow === null || shallow === void 0 ? void 0 : shallow.components("");
          }, 100));
        }
        this.shallow = shallow;
      }
      return shallow;
    };
    ComponentManager2.prototype.isComponent = function(obj) {
      return (0, mixins.isComponent)(obj);
    };
    ComponentManager2.prototype.addSymbol = function(component) {
      if ((0, index_all.isSymbol)(component) && !isSymbolRoot(component)) {
        return;
      }
      var symbol = component.clone({ symbol: true });
      isSymbolMain(symbol) && this.symbols.add(symbol);
      this.em.trigger("component:toggled");
      return symbol;
    };
    ComponentManager2.prototype.getSymbols = function() {
      return dom_components_spreadArray([], this.symbols.models, true);
    };
    ComponentManager2.prototype.detachSymbol = function(component) {
      if (isSymbolInstance(component)) {
        detachSymbolInstance(component);
      }
    };
    ComponentManager2.prototype.getSymbolInfo = function(component, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var isMain = isSymbolMain(component);
      var mainRef = getSymbolMain(component);
      var isInstance = !!mainRef;
      var instances = (isMain ? getSymbolInstances(component) : getSymbolInstances(mainRef)) || [];
      var main = mainRef || (isMain ? component : void 0);
      var relatives = getSymbolsToUpdate(component, { changed: opts.withChanges });
      var isSymbol2 = isMain || isInstance;
      var isRoot = isSymbol2 && isSymbolRoot(component);
      return {
        isSymbol: isSymbol2,
        isMain,
        isInstance,
        isRoot,
        main,
        instances,
        relatives: relatives || []
      };
    };
    ComponentManager2.prototype.canMove = function(target, source, index2) {
      var result = {
        result: false,
        reason: CanMoveReason.InvalidSource,
        target,
        source: null
      };
      if (!source || !target)
        return result;
      var srcModel = (0, mixins.isComponent)(source) ? source : null;
      if (!srcModel) {
        var wrapper = this.getShallowWrapper();
        srcModel = (wrapper === null || wrapper === void 0 ? void 0 : wrapper.append(source)[0]) || null;
      }
      result.source = srcModel;
      if (!srcModel)
        return result;
      var draggable = srcModel.get("draggable");
      if ((0, index_all.isFunction)(draggable)) {
        draggable = !!draggable(srcModel, target, index2);
      } else {
        var el = target.getEl();
        draggable = (0, index_all.isArray)(draggable) ? draggable.join(",") : draggable;
        draggable = (0, index_all.isString)(draggable) ? el === null || el === void 0 ? void 0 : el.matches(draggable) : draggable;
      }
      if (!draggable)
        return dom_components_assign(dom_components_assign({}, result), { reason: CanMoveReason.SourceReject });
      var droppable2 = target.get("droppable");
      if ((0, index_all.isFunction)(droppable2)) {
        droppable2 = !!droppable2(srcModel, target, index2);
      } else {
        if (droppable2 === false && target.isInstanceOf("text") && srcModel.get("textable")) {
          droppable2 = true;
        } else {
          var el = srcModel.getEl();
          droppable2 = (0, index_all.isArray)(droppable2) ? droppable2.join(",") : droppable2;
          droppable2 = (0, index_all.isString)(droppable2) ? el === null || el === void 0 ? void 0 : el.matches(droppable2) : droppable2;
        }
      }
      var isTargetInside = [target].concat(target.parents()).indexOf(srcModel) > -1;
      if (!droppable2 || isTargetInside)
        return dom_components_assign(dom_components_assign({}, result), { reason: CanMoveReason.TargetReject });
      return dom_components_assign(dom_components_assign({}, result), { result: true });
    };
    ComponentManager2.prototype.allById = function() {
      return this.componentsById;
    };
    ComponentManager2.prototype.getById = function(id) {
      return this.componentsById[id] || null;
    };
    ComponentManager2.prototype.destroy = function() {
      var _a2;
      var all = this.allById();
      Object.keys(all).forEach(function(id) {
        return all[id] && all[id].remove();
      });
      (_a2 = this.componentView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      [this.em, this.componentsById, this.componentView].forEach(function(i) {
        return i = {};
      });
    };
    return ComponentManager2;
  }(ItemManagerModule)
);
var dom_components = ComponentManager;
var css_composer_config_config_config = {
  stylePrefix: "css-",
  rules: []
};
var css_composer_config_config = css_composer_config_config_config;
var CssGenerator_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var maxValue = Number.MAX_VALUE;
var getMediaLength = function(mediaQuery) {
  var length = /(-?\d*\.?\d+)\w{0,}/.exec(mediaQuery);
  return !length ? "" : length[0];
};
var CssGenerator = (
  /** @class */
  function(_super) {
    CssGenerator_extends(CssGenerator2, _super);
    function CssGenerator2() {
      var _this = _super.call(this) || this;
      (0, index_all.bindAll)(_this, "sortRules");
      _this.compCls = [];
      _this.ids = [];
      return _this;
    }
    CssGenerator2.prototype.buildFromModel = function(model, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var code2 = "";
      var em = this.em;
      var avoidInline2 = em && em.getConfig().avoidInlineStyle;
      var style = model.styleToString();
      var classes = model.classes;
      this.ids.push("#".concat(model.getId()));
      classes.forEach(function(model2) {
        return _this.compCls.push(model2.getFullName());
      });
      if (!avoidInline2 && style) {
        code2 = "#".concat(model.getId(), "{").concat(style, "}");
      }
      var components = model.components();
      components.forEach(function(model2) {
        return code2 += _this.buildFromModel(model2, opts);
      });
      return code2;
    };
    CssGenerator2.prototype.build = function(model, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var json = opts.json;
      var em = opts.em;
      var cssc = opts.cssc || (em === null || em === void 0 ? void 0 : em.Css);
      this.em = em;
      this.compCls = [];
      this.ids = [];
      this.model = model;
      var codeJson = [];
      var code2 = model ? this.buildFromModel(model, opts) : "";
      var clearStyles = (0, index_all.isUndefined)(opts.clearStyles) && em ? em.getConfig().clearStyles : opts.clearStyles;
      if (cssc) {
        var rules = opts.rules || cssc.getAll();
        var atRules_1 = {};
        var dump_1 = [];
        if (opts.onlyMatched && model && (0, mixins.hasWin)()) {
          rules = this.matchedRules(model, rules);
        }
        rules.forEach(function(rule) {
          var atRule = rule.getAtRule();
          if (atRule) {
            var mRules = atRules_1[atRule];
            if (mRules) {
              mRules.push(rule);
            } else {
              atRules_1[atRule] = [rule];
            }
            return;
          }
          var res = _this.buildFromRule(rule, dump_1, opts);
          if (json) {
            codeJson.push(res);
          } else {
            code2 += res;
          }
        });
        this.sortMediaObject(atRules_1).forEach(function(item) {
          var rulesStr = "";
          var atRule = item.key;
          var mRules = item.value;
          mRules.forEach(function(rule) {
            var ruleStr = _this.buildFromRule(rule, dump_1, opts);
            if (rule.get("singleAtRule")) {
              code2 += "".concat(atRule, "{").concat(ruleStr, "}");
            } else {
              rulesStr += ruleStr;
            }
            json && codeJson.push(ruleStr);
          });
          if (rulesStr) {
            code2 += "".concat(atRule, "{").concat(rulesStr, "}");
          }
        });
        em && clearStyles && rules.remove && rules.remove(dump_1);
      }
      return json ? codeJson.filter(function(r) {
        return r;
      }) : code2;
    };
    CssGenerator2.prototype.buildFromRule = function(rule, dump, opts) {
      var _this = this;
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var result = "";
      var model = this.model;
      var selectorStrNoAdd = rule.selectorsToString({ skipAdd: 1 });
      var selectorsAdd = rule.get("selectorsAdd");
      var singleAtRule = rule.get("singleAtRule");
      var found;
      (_a2 = rule.get("selectors")) === null || _a2 === void 0 ? void 0 : _a2.forEach(function(selector) {
        var name = selector.getFullName();
        if (_this.compCls.indexOf(name) >= 0 || _this.ids.indexOf(name) >= 0 || opts.keepUnusedStyles) {
          found = 1;
        }
      });
      if (selectorStrNoAdd && found || selectorsAdd || singleAtRule || !model) {
        var block = rule.getDeclaration({ body: 1 });
        block && (opts.json ? result = rule : result += block);
      } else {
        dump.push(rule);
      }
      return result;
    };
    CssGenerator2.prototype.matchedRules = function(component, rules) {
      var _this = this;
      var el = component.getEl();
      var result = [];
      rules.forEach(function(rule) {
        try {
          if (rule.selectorsToString().split(",").some(function(selector) {
            return el === null || el === void 0 ? void 0 : el.matches(_this.__cleanSelector(selector));
          })) {
            result.push(rule);
          }
        } catch (err) {
        }
      });
      component.components().forEach(function(component2) {
        result = result.concat(_this.matchedRules(component2, rules));
      });
      result = result.filter(function(rule, i) {
        return result.indexOf(rule) === i;
      });
      return result;
    };
    CssGenerator2.prototype.getQueryLength = function(mediaQuery) {
      var length = /(-?\d*\.?\d+)\w{0,}/.exec(mediaQuery);
      if (!length)
        return maxValue;
      return parseFloat(length[1]);
    };
    CssGenerator2.prototype.sortMediaObject = function(items) {
      var _this = this;
      if (items === void 0) {
        items = {};
      }
      var itemsArr = [];
      (0, index_all.each)(items, function(value, key) {
        return itemsArr.push({ key, value });
      });
      return itemsArr.sort(function(a, b) {
        var isMobFirst = [a.key, b.key].every(function(mquery) {
          return mquery.indexOf("min-width") !== -1;
        });
        var left = isMobFirst ? a.key : b.key;
        var right = isMobFirst ? b.key : a.key;
        return _this.getQueryLength(left) - _this.getQueryLength(right);
      });
    };
    CssGenerator2.prototype.sortRules = function(a, b) {
      var getKey = function(rule) {
        return rule.get("mediaText") || "";
      };
      var isMobFirst = [getKey(a), getKey(b)].every(function(q) {
        return q.indexOf("min-width") !== -1;
      });
      var left = isMobFirst ? getKey(a) : getKey(b);
      var right = isMobFirst ? getKey(b) : getKey(a);
      return this.getQueryLength(left) - this.getQueryLength(right);
    };
    CssGenerator2.prototype.__cleanSelector = function(selector) {
      return selector.split(" ").map(function(item) {
        return item.split(":")[0];
      }).join(" ");
    };
    return CssGenerator2;
  }(common.Kx)
);
var model_CssGenerator = CssGenerator;
var CssRule_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CssRule_assign = function() {
  CssRule_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return CssRule_assign.apply(this, arguments);
};
var CssRule_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var CSS = ((0, mixins.hasWin)() ? window : {}).CSS;
var CssRule = (
  /** @class */
  function(_super) {
    CssRule_extends(CssRule2, _super);
    function CssRule2(props, opt) {
      if (opt === void 0) {
        opt = {};
      }
      var _this = _super.call(this, props) || this;
      _this.config = props || {};
      _this.opt = opt;
      _this.em = opt.em;
      _this.ensureSelectors(null, null, {});
      _this.on("change", _this.__onChange);
      return _this;
    }
    CssRule2.prototype.defaults = function() {
      return {
        selectors: [],
        selectorsAdd: "",
        style: {},
        mediaText: "",
        state: "",
        stylable: true,
        atRuleType: "",
        singleAtRule: false,
        important: false,
        group: "",
        shallow: false,
        _undo: true
      };
    };
    CssRule2.prototype.__onChange = function(m, opts) {
      var em = this.em;
      var changed = this.changedAttributes();
      changed && !(0, mixins.isEmptyObj)(changed) && (em === null || em === void 0 ? void 0 : em.changesUp(opts));
    };
    CssRule2.prototype.clone = function() {
      var opts = CssRule_assign({}, this.opt);
      var attr = CssRule_assign({}, this.attributes);
      attr.selectors = this.get("selectors").map(function(s) {
        return s.clone();
      });
      return new this.constructor(attr, opts);
    };
    CssRule2.prototype.ensureSelectors = function(m, c, opts) {
      var em = this.em;
      var sm = em === null || em === void 0 ? void 0 : em.Selectors;
      var toListen = [this, "change:selectors", this.ensureSelectors];
      var sels = this.getSelectors();
      this.stopListening.apply(this, toListen);
      if (sels.models) {
        sels = CssRule_spreadArray([], sels.models, true);
      }
      sels = (0, index_all.isString)(sels) ? [sels] : sels;
      if (Array.isArray(sels)) {
        var res = sels.filter(function(i) {
          return i;
        }).map(function(i) {
          return sm ? sm.add(i) : i;
        });
        sels = new model_Selectors(res);
      }
      this.set("selectors", sels, opts);
      this.listenTo.apply(this, toListen);
    };
    CssRule2.prototype.getAtRule = function() {
      var type2 = this.get("atRuleType");
      var condition = this.get("mediaText");
      var typeStr = type2 ? "@".concat(type2) : condition ? "@media" : "";
      return typeStr + (condition && typeStr ? " ".concat(condition) : "");
    };
    CssRule2.prototype.selectorsToString = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = [];
      var state = this.get("state");
      var addSelector = this.get("selectorsAdd");
      var selOpts = {
        escape: function(str) {
          return CSS && CSS.escape ? CSS.escape(str) : str;
        }
      };
      var selectors = this.getSelectors().getFullString(0, selOpts);
      var stateStr = state && !opts.skipState ? ":".concat(state) : "";
      selectors && result.push("".concat(selectors).concat(stateStr));
      addSelector && !opts.skipAdd && result.push(addSelector);
      return result.join(", ");
    };
    CssRule2.prototype.getDeclaration = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = "";
      var important = this.attributes.important;
      var selectors = this.selectorsToString(opts);
      var style = this.styleToString(CssRule_assign({ important }, opts));
      var singleAtRule = this.get("singleAtRule");
      if ((selectors || singleAtRule) && (style || opts.allowEmpty)) {
        result = singleAtRule ? style : "".concat(selectors, "{").concat(style, "}");
      }
      return result;
    };
    CssRule2.prototype.getDevice = function() {
      var em = this.em;
      var _a2 = this.attributes, atRuleType = _a2.atRuleType, mediaText = _a2.mediaText;
      var devices = (em === null || em === void 0 ? void 0 : em.Devices.getDevices()) || [];
      var deviceDefault = devices.filter(function(d) {
        return d.getWidthMedia() === "";
      })[0];
      if (atRuleType !== "media" || !mediaText) {
        return deviceDefault || null;
      }
      return devices.filter(function(d) {
        return d.getWidthMedia() === getMediaLength(mediaText);
      })[0] || null;
    };
    CssRule2.prototype.getState = function() {
      var em = this.em;
      var stateValue = this.get("state");
      var states = (em === null || em === void 0 ? void 0 : em.Selectors.getStates()) || [];
      return states.filter(function(s) {
        return s.getName() === stateValue;
      })[0] || null;
    };
    CssRule2.prototype.getComponent = function() {
      var _a2;
      var sel = this.getSelectors();
      var sngl = sel.length == 1 && sel.at(0);
      var cmpId = sngl && sngl.isId() && sngl.get("name");
      return cmpId && ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.Components.getById(cmpId)) || null;
    };
    CssRule2.prototype.toCSS = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = "";
      var atRule = this.getAtRule();
      var block = this.getDeclaration(opts);
      if (block || opts.allowEmpty) {
        result = block;
      }
      if (atRule && result) {
        result = "".concat(atRule, "{").concat(result, "}");
      }
      return result;
    };
    CssRule2.prototype.toJSON = function() {
      var _a2;
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      var obj = common.Kx.prototype.toJSON.apply(this, args);
      if ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.getConfig().avoidDefaults) {
        var defaults = this.defaults();
        (0, index_all.forEach)(defaults, function(value, key) {
          if (obj[key] === value) {
            delete obj[key];
          }
        });
        delete obj.style.__p;
        if ((0, index_all.isEmpty)(obj.selectors))
          delete obj.selectors;
        if ((0, index_all.isEmpty)(obj.style))
          delete obj.style;
      }
      return obj;
    };
    CssRule2.prototype.compare = function(selectors, state, width, ruleProps) {
      var _a2;
      if (ruleProps === void 0) {
        ruleProps = {};
      }
      var st = state || "";
      var wd = width || "";
      var selAdd = ruleProps.selectorsAdd || "";
      var atRule = ruleProps.atRuleType || "";
      var sel = !(0, index_all.isArray)(selectors) && !selectors.models ? [selectors] : selectors.models || selectors;
      if (wd && !atRule)
        atRule = "media";
      var a1 = sel.map(function(model) {
        return model.getFullName();
      });
      var a2 = (_a2 = this.get("selectors")) === null || _a2 === void 0 ? void 0 : _a2.map(function(model) {
        return model.getFullName();
      });
      var a1S = a1.slice().sort();
      var a2S = a2.slice().sort();
      if (a1.length !== a2.length || !a1S.every(function(v, i) {
        return v === a2S[i];
      })) {
        return false;
      }
      if (this.get("state") !== st || this.get("mediaText") !== wd || this.get("selectorsAdd") !== selAdd || this.get("atRuleType") !== atRule) {
        return false;
      }
      return true;
    };
    return CssRule2;
  }(model_StyleableModel)
);
var model_CssRule = CssRule;
var CssRules_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CssRules = (
  /** @class */
  function(_super) {
    CssRules_extends(CssRules2, _super);
    function CssRules2(props, opt) {
      var _this = _super.call(this, props) || this;
      _this.editor = opt === null || opt === void 0 ? void 0 : opt.em;
      setTimeout(function() {
        _this.on("remove", _this.onRemove);
        _this.on("add", _this.onAdd);
      });
      return _this;
    }
    CssRules2.prototype.toJSON = function(opts) {
      var result = common.pM.prototype.toJSON.call(this, opts);
      return result.filter(function(rule) {
        return rule.style && !rule.shallow;
      });
    };
    CssRules2.prototype.onAdd = function(model, c, o) {
      model.ensureSelectors(model, c, o);
    };
    CssRules2.prototype.onRemove = function(removed) {
      var em = this.editor;
      em.stopListening(removed);
      em.UndoManager.remove(removed);
    };
    CssRules2.prototype.add = function(models, opt) {
      if (opt === void 0) {
        opt = {};
      }
      if (typeof models === "string") {
        models = this.editor.get("Parser").parseCss(models);
      }
      opt.em = this.editor;
      return common.pM.prototype.add.apply(this, [models, opt]);
    };
    return CssRules2;
  }(common.pM)
);
var model_CssRules = CssRules;
CssRules.prototype.model = model_CssRule;
var css_composer_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var css_composer_assign = function() {
  css_composer_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return css_composer_assign.apply(this, arguments);
};
var css_composer_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var CssComposer = (
  /** @class */
  function(_super) {
    css_composer_extends(CssComposer2, _super);
    function CssComposer2(em) {
      var _this = _super.call(this, em, "CssComposer", null, {}, css_composer_config_config) || this;
      _this.Selectors = model_Selectors;
      _this.storageKey = "styles";
      var config2 = _this.config;
      var ppfx = config2.pStylePrefix;
      if (ppfx)
        config2.stylePrefix = ppfx + config2.stylePrefix;
      config2.rules = _this.em.config.style || config2.rules || "";
      _this.rules = new model_CssRules([], config2);
      return _this;
    }
    CssComposer2.prototype.onLoad = function() {
      this.rules.add(this.config.rules, { silent: true });
    };
    CssComposer2.prototype.postLoad = function() {
      var _a2;
      var um = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.get("UndoManager");
      um && um.add(this.getAll());
    };
    CssComposer2.prototype.store = function() {
      return this.getProjectData();
    };
    CssComposer2.prototype.load = function(data) {
      return this.loadProjectData(data, {
        // @ts-ignore Fix add() first in CssRules
        all: this.rules
      });
    };
    CssComposer2.prototype.add = function(selectors, state, width, opts, addOpts) {
      if (opts === void 0) {
        opts = {};
      }
      if (addOpts === void 0) {
        addOpts = {};
      }
      var s = state || "";
      var w = width || "";
      var opt = css_composer_assign({}, opts);
      var rule = this.get(selectors, s, w, opt);
      if (rule && rule.config && !rule.config.singleAtRule) {
        return rule;
      } else {
        opt.state = s;
        opt.mediaText = w;
        opt.selectors = [];
        if (w && !opt.atRuleType) {
          opt.atRuleType = "media";
        }
        rule = new model_CssRule(opt, this.config);
        rule.get("selectors").add(selectors, addOpts);
        this.rules.add(rule, addOpts);
        return rule;
      }
    };
    CssComposer2.prototype.get = function(selectors, state, width, ruleProps) {
      var slc = selectors;
      if ((0, index_all.isString)(selectors)) {
        var sm = this.em.Selectors;
        var singleSel = selectors.split(",")[0].trim();
        var node = this.em.Parser.parserCss.checkNode({ selectors: singleSel })[0];
        slc = sm.get(node.selectors);
      }
      return this.rules.find(function(rule) {
        return rule.compare(slc, state, width, ruleProps);
      }) || null;
    };
    CssComposer2.prototype.getAll = function() {
      return this.rules;
    };
    CssComposer2.prototype.addCollection = function(data, opts, props) {
      if (opts === void 0) {
        opts = {};
      }
      if (props === void 0) {
        props = {};
      }
      var em = this.em;
      var result = [];
      if ((0, index_all.isString)(data)) {
        data = em.Parser.parseCss(data);
      }
      var d = data instanceof Array ? data : [data];
      for (var i = 0, l = d.length; i < l; i++) {
        var rule = d[i] || {};
        if (!rule.selectors)
          continue;
        var sm = em === null || em === void 0 ? void 0 : em.Selectors;
        if (!sm)
          console.warn("Selector Manager not found");
        var sl = rule.selectors;
        var sels = sl instanceof Array ? sl : [sl];
        var newSels = [];
        for (var j = 0, le = sels.length; j < le; j++) {
          var selec = sm.add(sels[j]);
          newSels.push(selec);
        }
        var modelExists = this.get(newSels, rule.state, rule.mediaText, rule);
        var model = this.add(newSels, rule.state, rule.mediaText, rule, opts);
        var updateStyle = !modelExists || !opts.avoidUpdateStyle;
        var style = rule.style || {};
        (0, mixins.isObject)(props) && model.set(props, opts);
        if (updateStyle) {
          var styleUpdate = opts.extend ? css_composer_assign(css_composer_assign({}, model.get("style")), style) : style;
          model.set("style", styleUpdate, opts);
        }
        result.push(model);
      }
      return result;
    };
    CssComposer2.prototype.addRules = function(css) {
      return this.addCollection(css);
    };
    CssComposer2.prototype.setRule = function(selectors, style, opts) {
      if (style === void 0) {
        style = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var atRuleType = opts.atRuleType, atRuleParams = opts.atRuleParams;
      var node = this.em.Parser.parserCss.checkNode({
        selectors,
        style
      })[0];
      var state = node.state, selectorsAdd = node.selectorsAdd;
      var sm = this.em.Selectors;
      var selector = sm.add(node.selectors);
      var rule = this.add(selector, state, atRuleParams, {
        selectorsAdd,
        atRule: atRuleType
      });
      if (opts.addStyles) {
        rule.addStyle(style, opts);
      } else {
        rule.setStyle(style, opts);
      }
      return rule;
    };
    CssComposer2.prototype.getRule = function(selectors, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var sm = em.Selectors;
      var node = em.Parser.parserCss.checkNode({ selectors })[0];
      var selector = sm.get(node.selectors);
      var state = node.state, selectorsAdd = node.selectorsAdd;
      var atRuleType = opts.atRuleType, atRuleParams = opts.atRuleParams;
      return selector ? this.get(selector, state, atRuleParams, {
        selectorsAdd,
        atRuleType
      }) : void 0;
    };
    CssComposer2.prototype.getRules = function(selector) {
      var rules = this.getAll();
      if (!selector)
        return css_composer_spreadArray([], rules.models, true);
      var optRuleSel = { sort: true };
      var sels = (0, index_all.isString)(selector) ? selector.split(",").map(function(s) {
        return s.trim();
      }) : selector;
      var result = rules.filter(function(r) {
        return sels.indexOf(r.getSelectors().getFullString(null, optRuleSel)) >= 0;
      });
      return result;
    };
    CssComposer2.prototype.setIdRule = function(name, style, opts) {
      if (style === void 0) {
        style = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = opts.addOpts, addOpts = _a2 === void 0 ? {} : _a2, mediaText = opts.mediaText;
      var state = opts.state || "";
      var media = !(0, index_all.isUndefined)(mediaText) ? mediaText : this.em.getCurrentMedia();
      var sm = this.em.Selectors;
      var selector = sm.add({ name, type: model_Selector.TYPE_ID }, addOpts);
      var rule = this.add(selector, state, media, {}, addOpts);
      rule.setStyle(style, css_composer_assign(css_composer_assign({}, opts), addOpts));
      return rule;
    };
    CssComposer2.prototype.getIdRule = function(name, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var mediaText = opts.mediaText;
      var state = opts.state || "";
      var media = !(0, index_all.isUndefined)(mediaText) ? mediaText : this.em.getCurrentMedia();
      var selector = this.em.Selectors.get(name, model_Selector.TYPE_ID);
      return selector && this.get(selector, state, media);
    };
    CssComposer2.prototype.setClassRule = function(name, style, opts) {
      if (style === void 0) {
        style = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var state = opts.state || "";
      var media = opts.mediaText || this.em.getCurrentMedia();
      var sm = this.em.Selectors;
      var selector = sm.add({ name, type: model_Selector.TYPE_CLASS });
      var rule = this.add(selector, state, media);
      rule.setStyle(style, opts);
      return rule;
    };
    CssComposer2.prototype.getClassRule = function(name, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var state = opts.state || "";
      var media = opts.mediaText || this.em.getCurrentMedia();
      var selector = this.em.Selectors.get(name, model_Selector.TYPE_CLASS);
      return selector && this.get(selector, state, media);
    };
    CssComposer2.prototype.remove = function(rule, opts) {
      var toRemove = (0, index_all.isString)(rule) ? this.getRules(rule) : rule;
      var result = this.getAll().remove(toRemove, opts);
      return (0, index_all.isArray)(result) ? result : [result];
    };
    CssComposer2.prototype.clear = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.getAll().reset([], opts);
      return this;
    };
    CssComposer2.prototype.getComponentRules = function(cmp, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var state = opts.state, mediaText = opts.mediaText, current = opts.current;
      if (current) {
        state = this.em.get("state") || "";
        mediaText = this.em.getCurrentMedia();
      }
      var id = cmp.getId();
      var rules = this.getAll().filter(function(r) {
        if (!(0, index_all.isUndefined)(state) && r.get("state") !== state)
          return false;
        if (!(0, index_all.isUndefined)(mediaText) && r.get("mediaText") !== mediaText)
          return false;
        return r.getSelectorsString() === "#".concat(id);
      });
      return rules;
    };
    CssComposer2.prototype.render = function() {
      var _a2;
      (_a2 = this.rulesView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.rulesView = new view_CssRulesView({
        collection: this.rules,
        config: this.config
      });
      return this.rulesView.render().el;
    };
    CssComposer2.prototype.checkId = function(rule, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = opts.idMap, idMap = _a2 === void 0 ? {} : _a2;
      var changed = [];
      if (!Object.keys(idMap).length)
        return changed;
      var rules = Array.isArray(rule) ? rule : [rule];
      rules.forEach(function(rule2) {
        var sel = rule2.selectors;
        if (sel && sel.length == 1) {
          var sSel = sel[0];
          if ((0, index_all.isString)(sSel)) {
            if (sSel[0] === "#") {
              var prevId = sSel.substring(1);
              var newId = idMap[prevId];
              if (prevId && newId) {
                sel[0] = "#".concat(newId);
                changed.push(rule2);
              }
            }
          } else if (sSel.name && sSel.type === model_Selector.TYPE_ID) {
            var newId = idMap[sSel.name];
            if (newId) {
              sSel.name = newId;
              changed.push(rule2);
            }
          }
        }
      });
      return changed;
    };
    CssComposer2.prototype.destroy = function() {
      var _a2;
      this.rules.reset();
      this.rules.stopListening();
      (_a2 = this.rulesView) === null || _a2 === void 0 ? void 0 : _a2.remove();
    };
    return CssComposer2;
  }(ItemManagerModule)
);
var css_composer = CssComposer;
var block_manager_config_config_config = {
  appendTo: "",
  blocks: [],
  appendOnClick: false,
  custom: false
};
var block_manager_config_config = block_manager_config_config_config;
var Block_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Block = (
  /** @class */
  function(_super) {
    Block_extends(Block2, _super);
    function Block2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Block2.prototype.defaults = function() {
      return {
        label: "",
        content: "",
        media: "",
        category: "",
        activate: false,
        select: void 0,
        resetId: false,
        disable: false,
        onClick: void 0,
        attributes: {}
      };
    };
    Object.defineProperty(Block2.prototype, "category", {
      get: function() {
        var cat = this.get("category");
        return cat instanceof ModuleCategory ? cat : void 0;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Block2.prototype, "parent", {
      get: function() {
        return this.collection;
      },
      enumerable: false,
      configurable: true
    });
    Block2.prototype.getId = function() {
      return this.id;
    };
    Block2.prototype.getLabel = function() {
      return this.get("label");
    };
    Block2.prototype.getMedia = function() {
      return this.get("media");
    };
    Block2.prototype.getContent = function() {
      return this.get("content");
    };
    Block2.prototype.getCategoryLabel = function() {
      var ctg = this.get("category");
      return (0, index_all.isFunction)(ctg === null || ctg === void 0 ? void 0 : ctg.get) ? ctg.get("label") : (ctg === null || ctg === void 0 ? void 0 : ctg.label) ? ctg === null || ctg === void 0 ? void 0 : ctg.label : ctg;
    };
    return Block2;
  }(common.Kx)
);
var model_Block = Block;
var Blocks_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Blocks = (
  /** @class */
  function(_super) {
    Blocks_extends(Blocks2, _super);
    function Blocks2(coll, options) {
      var _this = _super.call(this, coll) || this;
      _this.em = options.em;
      _this.on("add", _this.handleAdd);
      return _this;
    }
    Blocks2.prototype.getCategories = function() {
      return this.em.Blocks.getCategories();
    };
    Blocks2.prototype.handleAdd = function(model) {
      this.initCategory(model);
    };
    return Blocks2;
  }(CollectionWithCategories)
);
var model_Blocks = Blocks;
Blocks.prototype.model = model_Block;
var BlocksEvents;
(function(BlocksEvents2) {
  BlocksEvents2["add"] = "block:add";
  BlocksEvents2["remove"] = "block:remove";
  BlocksEvents2["removeBefore"] = "block:remove:before";
  BlocksEvents2["update"] = "block:update";
  BlocksEvents2["dragStart"] = "block:drag:start";
  BlocksEvents2["drag"] = "block:drag";
  BlocksEvents2["dragEnd"] = "block:drag:stop";
  BlocksEvents2["categoryUpdate"] = "block:category:update";
  BlocksEvents2["custom"] = "block:custom";
  BlocksEvents2["all"] = "block";
})(BlocksEvents || (BlocksEvents = {}));
var BlockView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var BlockView = (
  /** @class */
  function(_super) {
    BlockView_extends(BlockView2, _super);
    function BlockView2(o, config2) {
      if (config2 === void 0) {
        config2 = {};
      }
      var _this = _super.call(this, o) || this;
      var model = _this.model;
      _this.em = config2.em;
      _this.config = config2;
      _this.endDrag = _this.endDrag.bind(_this);
      _this.ppfx = config2.pStylePrefix || "";
      _this.listenTo(model, "destroy remove", _this.remove);
      _this.listenTo(model, "change", _this.render);
      return _this;
    }
    BlockView2.prototype.events = function() {
      return {
        click: "handleClick",
        mousedown: "startDrag",
        dragstart: "handleDragStart",
        drag: "handleDrag",
        dragend: "handleDragEnd"
      };
    };
    BlockView2.prototype.__getModule = function() {
      return this.em.Blocks;
    };
    BlockView2.prototype.handleClick = function(ev) {
      var _a2 = this, config2 = _a2.config, model = _a2.model, em = _a2.em;
      var onClick = model.get("onClick") || config2.appendOnClick;
      em.trigger("block:click", model, ev);
      if (!onClick) {
        return;
      } else if ((0, index_all.isFunction)(onClick)) {
        return onClick(model, em === null || em === void 0 ? void 0 : em.getEditor(), { event: ev });
      }
      var sorter = config2.getSorter();
      var content = model.get("content");
      var selected = em.getSelected();
      sorter.setDropContent(content);
      var target, valid, insertAt;
      if (selected) {
        valid = sorter.validTarget(selected.getEl(), content);
        if (valid.valid) {
          target = selected;
        } else {
          var parent_1 = selected.parent();
          if (parent_1) {
            valid = sorter.validTarget(parent_1.getEl(), content);
            if (valid.valid) {
              target = parent_1;
              insertAt = parent_1.components().indexOf(selected) + 1;
            }
          }
        }
      }
      if (!target) {
        var wrapper = em.getWrapper();
        valid = sorter.validTarget(wrapper.getEl(), content);
        if (valid.valid)
          target = wrapper;
      }
      var result = target && target.append(content, { at: insertAt })[0];
      result && em.setSelected(result, { scroll: 1 });
    };
    BlockView2.prototype.startDrag = function(e) {
      var _a2 = this, config2 = _a2.config, em = _a2.em, model = _a2.model;
      var disable = model.get("disable");
      if (e.button !== 0 || !config2.getSorter || this.el.draggable || disable)
        return;
      em.refreshCanvas();
      var sorter = config2.getSorter();
      sorter.__currentBlock = model;
      sorter.setDragHelper(this.el, e);
      sorter.setDropContent(this.model.get("content"));
      sorter.startSort(this.el);
      (0, dom.on)(document, "mouseup", this.endDrag);
    };
    BlockView2.prototype.handleDragStart = function(ev) {
      this.__getModule().__startDrag(this.model, ev);
    };
    BlockView2.prototype.handleDrag = function(ev) {
      this.__getModule().__drag(ev);
    };
    BlockView2.prototype.handleDragEnd = function() {
      this.__getModule().__endDrag();
    };
    BlockView2.prototype.endDrag = function() {
      (0, dom.AU)(document, "mouseup", this.endDrag);
      var sorter = this.config.getSorter();
      sorter.moved = 0;
      sorter.endMove();
    };
    BlockView2.prototype.render = function() {
      var _a2;
      var _b = this, em = _b.em, el = _b.el, $el = _b.$el, ppfx = _b.ppfx, model = _b.model;
      var disable = model.get("disable");
      var attr = model.get("attributes") || {};
      var cls = attr.class || "";
      var className = "".concat(ppfx, "block");
      var label = em && em.t("blockManager.labels.".concat(model.id)) || model.get("label");
      var render = model.get("render");
      var media = model.get("media");
      var clsAdd = disable ? "".concat(className, "--disable") : "".concat(ppfx, "four-color-h");
      $el.attr(attr);
      el.className = "".concat(cls, " ").concat(className, " ").concat(ppfx, "one-bg ").concat(clsAdd).trim();
      el.innerHTML = "\n      ".concat(media ? '<div class="'.concat(className, '__media">').concat(media, "</div>") : "", '\n      <div class="').concat(className, '-label">').concat(label, "</div>\n    ");
      el.title = attr.title || ((_a2 = el.textContent) === null || _a2 === void 0 ? void 0 : _a2.trim());
      el.setAttribute("draggable", "".concat((0, mixins.hasDnd)(em) && !disable ? true : false));
      var result = render && render({ el, model, className, prefix: ppfx });
      if (result)
        el.innerHTML = result;
      return this;
    };
    return BlockView2;
  }(common.Ss)
);
var view_BlockView = BlockView;
var ModuleCategoryView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModuleCategoryView_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var CategoryView = (
  /** @class */
  function(_super) {
    ModuleCategoryView_extends(CategoryView2, _super);
    function CategoryView2(o, config2, catName) {
      var _this = _super.call(this, o) || this;
      _this.config = config2;
      var pfx = config2.pStylePrefix || "";
      _this.em = config2.em;
      _this.catName = catName;
      _this.pfx = pfx;
      _this.caretR = "fa fa-caret-right";
      _this.caretD = "fa fa-caret-down";
      _this.iconClass = "".concat(pfx, "caret-icon");
      _this.activeClass = "".concat(pfx, "open");
      _this.className = "".concat(pfx).concat(catName, "-category");
      _this.listenTo(_this.model, "change:open", _this.updateVisibility);
      _this.model.view = _this;
      return _this;
    }
    CategoryView2.prototype.events = function() {
      return {
        "click [data-title]": "toggle"
      };
    };
    CategoryView2.prototype.template = function(_a2) {
      var pfx = _a2.pfx, label = _a2.label, catName = _a2.catName;
      return html(ModuleCategoryView_templateObject_1 || (ModuleCategoryView_templateObject_1 = ModuleCategoryView_makeTemplateObject(['\n      <div class="', 'title" data-title>\n        <i class="', 'caret-icon"></i>\n        ', '\n      </div>\n      <div class="', "", 's-c"></div>\n    '], ['\n      <div class="', 'title" data-title>\n        <i class="', 'caret-icon"></i>\n        ', '\n      </div>\n      <div class="', "", 's-c"></div>\n    '])), pfx, pfx, label, pfx, catName);
    };
    CategoryView2.prototype.attributes = function() {
      return this.model.get("attributes") || {};
    };
    CategoryView2.prototype.updateVisibility = function() {
      if (this.model.get("open"))
        this.open();
      else
        this.close();
    };
    CategoryView2.prototype.open = function() {
      this.$el.addClass(this.activeClass);
      this.getIconEl().className = "".concat(this.iconClass, " ").concat(this.caretD);
      this.getTypeEl().style.display = "";
    };
    CategoryView2.prototype.close = function() {
      this.$el.removeClass(this.activeClass);
      this.getIconEl().className = "".concat(this.iconClass, " ").concat(this.caretR);
      this.getTypeEl().style.display = "none";
    };
    CategoryView2.prototype.toggle = function() {
      var model = this.model;
      model.set("open", !model.get("open"));
    };
    CategoryView2.prototype.getIconEl = function() {
      if (!this.iconEl) {
        this.iconEl = this.el.querySelector(".".concat(this.iconClass));
      }
      return this.iconEl;
    };
    CategoryView2.prototype.getTypeEl = function() {
      if (!this.typeEl) {
        this.typeEl = this.el.querySelector(".".concat(this.pfx).concat(this.catName, "s-c"));
      }
      return this.typeEl;
    };
    CategoryView2.prototype.append = function(el) {
      this.getTypeEl().appendChild(el);
    };
    CategoryView2.prototype.render = function() {
      var _a2 = this, em = _a2.em, el = _a2.el, $el = _a2.$el, model = _a2.model, pfx = _a2.pfx, catName = _a2.catName;
      var label = em.t("".concat(catName, "Manager.categories.").concat(model.id)) || model.get("label");
      el.innerHTML = this.template({ pfx, label, catName });
      $el.addClass(this.className);
      $el.css({ order: model.get("order") });
      this.updateVisibility();
      return this;
    };
    return CategoryView2;
  }(common.Ss)
);
var ModuleCategoryView = CategoryView;
var ModuleCategoryView_templateObject_1;
var BlocksView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var BlocksView_assign = function() {
  BlocksView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return BlocksView_assign.apply(this, arguments);
};
var BlocksView = (
  /** @class */
  function(_super) {
    BlocksView_extends(BlocksView2, _super);
    function BlocksView2(opts, config2) {
      var _this = _super.call(this, opts) || this;
      _this.renderedCategories = /* @__PURE__ */ new Map();
      (0, index_all.bindAll)(_this, "getSorter", "onDrag", "onDrop", "onMove");
      _this.config = config2 || {};
      _this.categories = opts.categories || "";
      var ppfx = _this.config.pStylePrefix || "";
      _this.ppfx = ppfx;
      _this.noCatClass = "".concat(ppfx, "blocks-no-cat");
      _this.blockContClass = "".concat(ppfx, "blocks-c");
      _this.catsClass = "".concat(ppfx, "block-categories");
      var coll = _this.collection;
      _this.listenTo(coll, "add", _this.addTo);
      _this.listenTo(coll, "reset", _this.render);
      _this.em = _this.config.em;
      if (_this.em) {
        _this.config.getSorter = _this.getSorter;
      }
      return _this;
    }
    BlocksView2.prototype.__getModule = function() {
      return this.em.Blocks;
    };
    BlocksView2.prototype.updateConfig = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.config = BlocksView_assign(BlocksView_assign({}, this.config), opts);
    };
    BlocksView2.prototype.getSorter = function() {
      var em = this.em;
      if (!em)
        return;
      if (!this.sorter) {
        var utils2 = em.Utils;
        var canvas2 = em.Canvas;
        this.sorter = new utils2.Sorter({
          // @ts-ignore
          container: canvas2.getBody(),
          placer: canvas2.getPlacerEl(),
          containerSel: "*",
          itemSel: "*",
          pfx: this.ppfx,
          onStart: this.onDrag,
          onEndMove: this.onDrop,
          onMove: this.onMove,
          document: canvas2.getFrameEl().contentDocument,
          direction: "a",
          wmargin: 1,
          nested: 1,
          em,
          canvasRelative: 1
        });
      }
      return this.sorter;
    };
    BlocksView2.prototype.onDrag = function(ev) {
      this.em.stopDefault();
      this.__getModule().__startDrag(this.sorter.__currentBlock, ev);
    };
    BlocksView2.prototype.onMove = function(ev) {
      this.__getModule().__drag(ev);
    };
    BlocksView2.prototype.onDrop = function(component) {
      this.em.runDefault();
      this.__getModule().__endDrag({ component });
      delete this.sorter.__currentBlock;
    };
    BlocksView2.prototype.addTo = function(model) {
      this.add(model);
    };
    BlocksView2.prototype.add = function(model, fragment) {
      var _a2 = this, config2 = _a2.config, renderedCategories = _a2.renderedCategories;
      var attributes = model.get("attributes");
      var view = new view_BlockView({ model, attributes }, config2);
      var rendered = view.render().el;
      var category = model.parent.initCategory(model);
      if (category && this.categories && !config2.ignoreCategories) {
        var catId = category.getId();
        var categories = this.getCategoriesEl();
        var catView = renderedCategories.get(catId);
        if (!catView && categories) {
          catView = new ModuleCategoryView({ model: category }, config2, "block").render();
          renderedCategories.set(catId, catView);
          categories.appendChild(catView.el);
        }
        catView === null || catView === void 0 ? void 0 : catView.append(rendered);
        return;
      }
      fragment ? fragment.appendChild(rendered) : this.append(rendered);
    };
    BlocksView2.prototype.getCategoriesEl = function() {
      if (!this.catsEl) {
        this.catsEl = this.el.querySelector(".".concat(this.catsClass));
      }
      return this.catsEl;
    };
    BlocksView2.prototype.getBlocksEl = function() {
      if (!this.blocksEl) {
        this.blocksEl = this.el.querySelector(".".concat(this.noCatClass, " .").concat(this.blockContClass));
      }
      return this.blocksEl;
    };
    BlocksView2.prototype.append = function(el) {
      var blocks = this.getBlocksEl();
      blocks && blocks.appendChild(el);
    };
    BlocksView2.prototype.render = function() {
      var _this = this;
      var ppfx = this.ppfx;
      var frag = document.createDocumentFragment();
      delete this.catsEl;
      delete this.blocksEl;
      this.renderedCategories = /* @__PURE__ */ new Map();
      this.el.innerHTML = '\n      <div class="'.concat(this.catsClass, '"></div>\n      <div class="').concat(this.noCatClass, '">\n        <div class="').concat(this.blockContClass, '"></div>\n      </div>\n    ');
      this.collection.each(function(model) {
        return _this.add(model, frag);
      });
      this.append(frag);
      var cls = "".concat(this.blockContClass, "s ").concat(ppfx, "one-bg ").concat(ppfx, "two-color");
      this.$el.addClass(cls);
      this.rendered = true;
      return this;
    };
    return BlocksView2;
  }(common.Ss)
);
var view_BlocksView = BlocksView;
var block_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var block_manager_assign = function() {
  block_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return block_manager_assign.apply(this, arguments);
};
var BlockManager = (
  /** @class */
  function(_super) {
    block_manager_extends(BlockManager2, _super);
    function BlockManager2(em) {
      var _a2;
      var _this = _super.call(this, em, "BlockManager", new model_Blocks(((_a2 = em.config.blockManager) === null || _a2 === void 0 ? void 0 : _a2.blocks) || [], { em }), BlocksEvents, block_manager_config_config) || this;
      _this.events = BlocksEvents;
      _this.Block = model_Block;
      _this.Blocks = model_Blocks;
      _this.Category = ModuleCategory;
      _this.Categories = ModuleCategories;
      _this.storageKey = "";
      _this.blocks = _this.all;
      _this.blocksVisible = new model_Blocks(_this.blocks.models, { em });
      _this.categories = new ModuleCategories([], {
        em,
        events: { update: BlocksEvents.categoryUpdate }
      });
      _this.blocks.on("add", function(model) {
        return _this.blocksVisible.add(model);
      });
      _this.blocks.on("remove", function(model) {
        return _this.blocksVisible.remove(model);
      });
      _this.blocks.on("reset", function(coll) {
        return _this.blocksVisible.reset(coll.models);
      });
      _this.__onAllEvent = (0, index_all.debounce)(function() {
        return _this.__trgCustom();
      }, 0);
      return _this;
    }
    BlockManager2.prototype.__trgCustom = function() {
      this.em.trigger(this.events.custom, this.__customData());
    };
    BlockManager2.prototype.__customData = function() {
      var _this = this;
      var bhv = this.__getBehaviour();
      return {
        bm: this,
        blocks: this.getAll().models,
        container: bhv.container,
        dragStart: function(block, ev) {
          return _this.startDrag(block, ev);
        },
        drag: function(ev) {
          return _this.__drag(ev);
        },
        dragStop: function(cancel) {
          return _this.endDrag(cancel);
        }
      };
    };
    BlockManager2.prototype.__startDrag = function(block, ev) {
      var _a2 = this, em = _a2.em, events2 = _a2.events, blocks = _a2.blocks;
      var content = block.getContent ? block.getContent() : block;
      this._dragBlock = block;
      em.set({ dragResult: null, dragContent: content });
      [em, blocks].map(function(i) {
        return i.trigger(events2.dragStart, block, ev);
      });
    };
    BlockManager2.prototype.__drag = function(ev) {
      var _a2 = this, em = _a2.em, events2 = _a2.events, blocks = _a2.blocks;
      var block = this._dragBlock;
      [em, blocks].map(function(i) {
        return i.trigger(events2.drag, block, ev);
      });
    };
    BlockManager2.prototype.__endDrag = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, events2 = _a2.events, blocks = _a2.blocks;
      var block = this._dragBlock;
      var cmp = opts.component || em.get("dragResult");
      delete this._dragBlock;
      if (cmp && block) {
        var oldKey = "activeOnRender";
        var oldActive = cmp.get && cmp.get(oldKey);
        var toActive = block.get("activate") || oldActive;
        var toSelect = block.get("select");
        var first = (0, index_all.isArray)(cmp) ? cmp[0] : cmp;
        if (toSelect || toActive && toSelect !== false) {
          em.setSelected(first);
        }
        if (toActive) {
          first.trigger("active");
          oldActive && first.unset(oldKey);
        }
        if (block.get("resetId")) {
          first.onAll(function(cmp2) {
            return cmp2.resetId();
          });
        }
      }
      em.set({ dragResult: null, dragContent: null });
      if (block) {
        [em, blocks].map(function(i) {
          return i.trigger(events2.dragEnd, cmp, block);
        });
      }
    };
    BlockManager2.prototype.__getFrameViews = function() {
      return this.em.Canvas.getFrames().map(function(frame) {
        return frame.view;
      }).filter(Boolean);
    };
    BlockManager2.prototype.__behaviour = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this._bhv = block_manager_assign(block_manager_assign({}, this._bhv || {}), opts);
    };
    BlockManager2.prototype.__getBehaviour = function() {
      return this._bhv || {};
    };
    BlockManager2.prototype.startDrag = function(block, ev) {
      this.__startDrag(block, ev);
      this.__getFrameViews().forEach(function(fv) {
        var _a2;
        return (_a2 = fv.droppable) === null || _a2 === void 0 ? void 0 : _a2.startCustom();
      });
    };
    BlockManager2.prototype.endDrag = function(cancel) {
      this.__getFrameViews().forEach(function(fv) {
        var _a2;
        return (_a2 = fv.droppable) === null || _a2 === void 0 ? void 0 : _a2.endCustom(cancel);
      });
      this.__endDrag();
    };
    BlockManager2.prototype.postRender = function() {
      var _a2 = this, categories = _a2.categories, config2 = _a2.config, em = _a2.em;
      var collection = this.blocksVisible;
      this.blocksView = new view_BlocksView({ collection, categories }, block_manager_assign(block_manager_assign({}, config2), { em }));
      this.__appendTo(collection.models);
      this.__trgCustom();
    };
    BlockManager2.prototype.add = function(id, props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var prp = props || {};
      prp.id = id;
      return this.blocks.add(prp, opts);
    };
    BlockManager2.prototype.get = function(id) {
      return this.blocks.get(id);
    };
    BlockManager2.prototype.getAll = function() {
      return this.blocks;
    };
    BlockManager2.prototype.getAllVisible = function() {
      return this.blocksVisible;
    };
    BlockManager2.prototype.remove = function(block, opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this.__remove(block, opts);
    };
    BlockManager2.prototype.getCategories = function() {
      return this.categories;
    };
    BlockManager2.prototype.getContainer = function() {
      var _a2;
      return (_a2 = this.blocksView) === null || _a2 === void 0 ? void 0 : _a2.el;
    };
    BlockManager2.prototype.getDragBlock = function() {
      return this._dragBlock;
    };
    BlockManager2.prototype.getBlocksByCategory = function(blocks) {
      return getItemsByCategory(blocks || this.getAll().models);
    };
    BlockManager2.prototype.render = function(blocks, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, categories = _a2.categories, config2 = _a2.config, em = _a2.em;
      var toRender = blocks || this.getAll().models;
      if (opts.external) {
        var collection = new model_Blocks(toRender, { em });
        return new view_BlocksView({ collection, categories }, block_manager_assign(block_manager_assign({ em }, config2), opts)).render().el;
      }
      if (this.blocksView) {
        this.blocksView.updateConfig(opts);
        this.blocksView.collection.reset(toRender);
        if (!this.blocksView.rendered) {
          this.blocksView.render();
          this.blocksView.rendered = true;
        }
      }
      return this.getContainer();
    };
    BlockManager2.prototype.destroy = function() {
      var _a2;
      var colls = [this.blocks, this.blocksVisible, this.categories];
      colls.map(function(c) {
        return c.stopListening();
      });
      colls.map(function(c) {
        return c.reset();
      });
      (_a2 = this.blocksView) === null || _a2 === void 0 ? void 0 : _a2.remove();
    };
    return BlockManager2;
  }(ItemManagerModule)
);
var block_manager = BlockManager;
var selector_manager_config_config_config = {
  stylePrefix: "clm-",
  appendTo: "",
  selectors: [],
  states: [{ name: "hover" }, { name: "active" }, { name: "nth-of-type(2n)" }],
  iconAdd: '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>',
  iconSync: '<svg viewBox="0 0 24 24"><path d="M12 18c-3.31 0-6-2.69-6-6 0-1 .25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 0 0 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4m0-11V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0 0 20 12c0-4.42-3.58-8-8-8z"></path></svg>',
  iconTagOn: '<svg viewBox="0 0 24 24"><path d="M19 19H5V5h10V3H5c-1.11 0-2 .89-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-8h-2m-11.09-.92L6.5 11.5 11 16 21 6l-1.41-1.42L11 13.17l-3.09-3.09z"></path></svg>',
  iconTagOff: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.11 0-2 .89-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5a2 2 0 0 0-2-2m0 2v14H5V5h14z"></path></svg>',
  iconTagRemove: '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>',
  componentFirst: false,
  custom: false
};
var selector_manager_config_config = selector_manager_config_config_config;
var State_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var State = (
  /** @class */
  function(_super) {
    State_extends(State2, _super);
    function State2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    State2.prototype.defaults = function() {
      return {
        name: "",
        label: ""
      };
    };
    State2.prototype.getName = function() {
      return this.get("name");
    };
    State2.prototype.getLabel = function() {
      return this.get("label") || this.getName();
    };
    return State2;
  }(common.Kx)
);
var model_State = State;
State.prototype.idAttribute = "name";
var ClassTagView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ClassTagView_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var inputProp = "contentEditable";
var ClassTagView = (
  /** @class */
  function(_super) {
    ClassTagView_extends(ClassTagView2, _super);
    function ClassTagView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      var config2 = o.config || {};
      _this.config = config2;
      _this.module = o.module;
      _this.coll = o.coll || null;
      _this.pfx = config2.stylePrefix || "";
      _this.ppfx = config2.pStylePrefix || "";
      _this.em = config2.em;
      _this.listenTo(_this.model, "change:active", _this.updateStatus);
      return _this;
    }
    ClassTagView2.prototype.template = function() {
      var _a2 = this, pfx = _a2.pfx, model = _a2.model, config2 = _a2.config;
      var label = model.get("label") || "";
      return html(ClassTagView_templateObject_1 || (ClassTagView_templateObject_1 = ClassTagView_makeTemplateObject(['\n      <span id="', 'checkbox" class="', 'tag-status" data-tag-status></span>\n      <span id="', 'tag-label" data-tag-name>', '</span>\n      <span id="', 'close" class="', 'tag-close" data-tag-remove> $', " </span>\n    "], ['\n      <span id="', 'checkbox" class="', 'tag-status" data-tag-status></span>\n      <span id="', 'tag-label" data-tag-name>', '</span>\n      <span id="', 'close" class="', 'tag-close" data-tag-remove> $', " </span>\n    "])), pfx, pfx, pfx, label, pfx, pfx, config2.iconTagRemove);
    };
    ClassTagView2.prototype.events = function() {
      return {
        "click [data-tag-remove]": "removeTag",
        "click [data-tag-status]": "changeStatus",
        "dblclick [data-tag-name]": "startEditTag",
        "focusout [data-tag-name]": "endEditTag"
      };
    };
    ClassTagView2.prototype.getInputEl = function() {
      if (!this.inputEl) {
        this.inputEl = this.el.querySelector("[data-tag-name]");
      }
      return this.inputEl;
    };
    ClassTagView2.prototype.startEditTag = function() {
      var em = this.em;
      var inputEl = this.getInputEl();
      inputEl[inputProp] = "true";
      inputEl.focus();
      em === null || em === void 0 ? void 0 : em.setEditing(true);
    };
    ClassTagView2.prototype.endEditTag = function() {
      var _a2 = this, model = _a2.model, em = _a2.em;
      var inputEl = this.getInputEl();
      var label = inputEl.textContent || "";
      var sm = em === null || em === void 0 ? void 0 : em.Selectors;
      inputEl[inputProp] = "false";
      em === null || em === void 0 ? void 0 : em.setEditing(false);
      if (sm && sm.rename(model, label) !== model) {
        inputEl.innerText = model.getLabel();
      }
    };
    ClassTagView2.prototype.changeStatus = function() {
      var model = this.model;
      model.set("active", !model.getActive());
    };
    ClassTagView2.prototype.removeTag = function() {
      this.module.removeSelected(this.model);
    };
    ClassTagView2.prototype.updateStatus = function() {
      var _a2 = this, model = _a2.model, $el = _a2.$el, config2 = _a2.config;
      var iconTagOn = config2.iconTagOn, iconTagOff = config2.iconTagOff;
      var $chk = $el.find("[data-tag-status]");
      if (model.get("active")) {
        $chk.html(iconTagOn);
        $el.removeClass("opac50");
      } else {
        $chk.html(iconTagOff);
        $el.addClass("opac50");
      }
    };
    ClassTagView2.prototype.render = function() {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx, $el = _a2.$el, model = _a2.model;
      var mainCls = "".concat(pfx, "tag");
      var classes = ["".concat(mainCls, " ").concat(ppfx, "three-bg")];
      model.get("protected") && classes.push("".concat(mainCls, "-protected"));
      $el.html(this.template());
      $el.attr("class", classes.join(" "));
      this.updateStatus();
      return this;
    };
    return ClassTagView2;
  }(common.Ss)
);
var view_ClassTagView = ClassTagView;
var ClassTagView_templateObject_1;
var ClassTagsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ClassTagsView_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var ClassTagsView = (
  /** @class */
  function(_super) {
    ClassTagsView_extends(ClassTagsView2, _super);
    function ClassTagsView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      _this.config = o.config || {};
      _this.pfx = _this.config.stylePrefix || "";
      _this.ppfx = _this.config.pStylePrefix || "";
      _this.className = _this.pfx + "tags";
      _this.stateInputId = _this.pfx + "states";
      _this.stateInputC = _this.pfx + "input-c";
      _this.states = _this.config.states || [];
      var em = _this.config.em;
      var coll = _this.collection;
      _this.target = em;
      var md = em.Selectors;
      _this.module = md;
      _this.em = em;
      _this.componentChanged = (0, index_all.debounce)(_this.componentChanged.bind(_this), 0);
      _this.checkSync = (0, index_all.debounce)(_this.checkSync.bind(_this), 0);
      var eventCmpUpdate = dom_components_types.I.update;
      var evClsUp = "".concat(eventCmpUpdate, ":classes");
      var toList = "component:toggled ".concat(evClsUp);
      var toListCls = "".concat(evClsUp, " ").concat(eventCmpUpdate, ":attributes:id change:state");
      _this.listenTo(em, toList, _this.componentChanged);
      _this.listenTo(em, "styleManager:update", _this.componentChanged);
      _this.listenTo(em, toListCls, _this.__handleStateChange);
      _this.listenTo(em, "styleable:change change:device", _this.checkSync);
      _this.listenTo(coll, "add", _this.addNew);
      _this.listenTo(coll, "reset", _this.renderClasses);
      _this.listenTo(coll, "remove", _this.tagRemoved);
      _this.listenTo(md.getAll(), md.events.state, (0, index_all.debounce)(function() {
        return _this.renderStates();
      }, 0));
      _this.delegateEvents();
      return _this;
    }
    ClassTagsView2.prototype.template = function(_a2) {
      var labelInfo = _a2.labelInfo, labelHead = _a2.labelHead, iconSync = _a2.iconSync, iconAdd = _a2.iconAdd, pfx = _a2.pfx, ppfx = _a2.ppfx;
      return html(ClassTagsView_templateObject_1 || (ClassTagsView_templateObject_1 = ClassTagsView_makeTemplateObject([' <div id="', 'up" class="', 'header">\n        <div id="', 'label" class="', 'header-label">', '</div>\n        <div id="', 'status-c" class="', 'header-status">\n          <span id="', 'input-c" data-states-c>\n            <div class="', "field ", 'select">\n              <span id="', 'input-holder">\n                <select id="', 'states" data-states></select>\n              </span>\n              <div class="', 'sel-arrow">\n                <div class="', 'd-s-arrow"></div>\n              </div>\n            </div>\n          </span>\n        </div>\n      </div>\n      <div id="', 'tags-field" class="', 'field">\n        <div id="', 'tags-c" data-selectors></div>\n        <input id="', 'new" data-input />\n        <span id="', 'add-tag" class="', "tags-btn ", 'tags-btn__add" data-add> $', ' </span>\n        <span class="', "tags-btn ", 'tags-btn__sync" style="display: none" data-sync-style> $', ' </span>\n      </div>\n      <div class="', 'sels-info">\n        <div class="', 'label-sel">', ':</div>\n        <div class="', 'sels" data-selected></div>\n      </div>'], [' <div id="', 'up" class="', 'header">\n        <div id="', 'label" class="', 'header-label">', '</div>\n        <div id="', 'status-c" class="', 'header-status">\n          <span id="', 'input-c" data-states-c>\n            <div class="', "field ", 'select">\n              <span id="', 'input-holder">\n                <select id="', 'states" data-states></select>\n              </span>\n              <div class="', 'sel-arrow">\n                <div class="', 'd-s-arrow"></div>\n              </div>\n            </div>\n          </span>\n        </div>\n      </div>\n      <div id="', 'tags-field" class="', 'field">\n        <div id="', 'tags-c" data-selectors></div>\n        <input id="', 'new" data-input />\n        <span id="', 'add-tag" class="', "tags-btn ", 'tags-btn__add" data-add> $', ' </span>\n        <span class="', "tags-btn ", 'tags-btn__sync" style="display: none" data-sync-style> $', ' </span>\n      </div>\n      <div class="', 'sels-info">\n        <div class="', 'label-sel">', ':</div>\n        <div class="', 'sels" data-selected></div>\n      </div>'])), pfx, pfx, pfx, pfx, labelHead, pfx, pfx, pfx, ppfx, ppfx, ppfx, pfx, ppfx, ppfx, pfx, ppfx, pfx, pfx, pfx, pfx, pfx, iconAdd, pfx, pfx, iconSync, pfx, pfx, labelInfo, pfx);
    };
    ClassTagsView2.prototype.events = function() {
      return {
        "change [data-states]": "stateChanged",
        "click [data-add]": "startNewTag",
        "focusout [data-input]": "endNewTag",
        "keyup [data-input]": "onInputKeyUp",
        "click [data-sync-style]": "syncStyle"
      };
    };
    ClassTagsView2.prototype.syncStyle = function() {
      var em = this.em;
      var target = this.getTarget();
      var cssC = em.Css;
      var opts = { noDisabled: 1 };
      var selectors = this.getCommonSelectors({ opts });
      var state = em.get("state");
      var mediaText = em.getCurrentMedia();
      var ruleComponents = [];
      var rule = cssC.get(selectors, state, mediaText) || cssC.add(selectors, state, mediaText);
      var style;
      this.getTargets().forEach(function(target2) {
        var ruleComponent = cssC.getIdRule(target2.getId(), {
          state,
          mediaText
        });
        style = ruleComponent.getStyle();
        ruleComponent.setStyle({});
        ruleComponents.push(ruleComponent);
      });
      style && rule.addStyle(style);
      em.trigger("component:toggled");
      em.trigger("component:sync-style", {
        component: target,
        selectors,
        mediaText,
        rule,
        ruleComponents,
        state
      });
    };
    ClassTagsView2.prototype.tagRemoved = function(model) {
      this.updateStateVis();
    };
    ClassTagsView2.prototype.addNew = function(model) {
      this.addToClasses(model);
    };
    ClassTagsView2.prototype.startNewTag = function() {
      var _a2, _b;
      (_a2 = this.$addBtn) === null || _a2 === void 0 ? void 0 : _a2.css({ display: "none" });
      (_b = this.$input) === null || _b === void 0 ? void 0 : _b.show().focus();
    };
    ClassTagsView2.prototype.endNewTag = function() {
      var _a2, _b;
      (_a2 = this.$addBtn) === null || _a2 === void 0 ? void 0 : _a2.css({ display: "" });
      (_b = this.$input) === null || _b === void 0 ? void 0 : _b.hide().val("");
    };
    ClassTagsView2.prototype.onInputKeyUp = function(e) {
      var _a2;
      if (e.keyCode === 13) {
        e.preventDefault();
        this.addNewTag((_a2 = this.$input) === null || _a2 === void 0 ? void 0 : _a2.val());
      } else if (e.keyCode === 27) {
        this.endNewTag();
      }
    };
    ClassTagsView2.prototype.checkStates = function() {
      var state = this.em.getState();
      var statesEl = this.getStates();
      statesEl && statesEl.val(state);
    };
    ClassTagsView2.prototype.componentChanged = function(_a2) {
      var _b = _a2 === void 0 ? {} : _a2, targets = _b.targets;
      this.updateSelection(targets);
    };
    ClassTagsView2.prototype.updateSelection = function(targets) {
      var trgs = targets || this.getTargets();
      trgs = (0, index_all.isArray)(trgs) ? trgs : [trgs];
      var selectors = [];
      if (trgs && trgs.length) {
        selectors = this.getCommonSelectors({ targets: trgs });
        this.checkSync({ validSelectors: selectors });
      }
      this.collection.reset(selectors);
      this.updateStateVis(trgs);
      this.module.__trgCustom();
      return selectors;
    };
    ClassTagsView2.prototype.getCommonSelectors = function(_a2) {
      var _b = _a2 === void 0 ? {} : _a2, targets = _b.targets, _c = _b.opts, opts = _c === void 0 ? {} : _c;
      var trgs = targets || this.getTargets();
      return this.module.__getCommonSelectors(trgs, opts);
    };
    ClassTagsView2.prototype._commonSelectors = function() {
      var _a2;
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      return (_a2 = this.module).__common.apply(_a2, args);
    };
    ClassTagsView2.prototype.checkSync = function() {
      var _a2 = this, $btnSyncEl = _a2.$btnSyncEl, config2 = _a2.config, collection = _a2.collection;
      var target = this.getTarget();
      var hasStyle;
      if (target && config2.componentFirst && collection.length) {
        var style = target.getStyle();
        hasStyle = !(0, index_all.isEmpty)(style);
      }
      $btnSyncEl && $btnSyncEl[hasStyle ? "show" : "hide"]();
    };
    ClassTagsView2.prototype.getTarget = function() {
      return this.target.getSelected();
    };
    ClassTagsView2.prototype.getTargets = function() {
      return this.target.getSelectedAll();
    };
    ClassTagsView2.prototype.updateStateVis = function(targets) {
      var em = this.em;
      var avoidInline2 = em && em.getConfig().avoidInlineStyle;
      var display = this.collection.length || avoidInline2 ? "" : "none";
      this.getStatesC().css("display", display);
      this.updateSelector(targets);
    };
    ClassTagsView2.prototype.__handleStateChange = function() {
      this.updateSelector(this.getTargets());
    };
    ClassTagsView2.prototype.updateSelector = function(targets) {
      var _this = this;
      var elSel = this.el.querySelector("[data-selected]");
      var result = [];
      var trgs = targets || this.getTargets();
      trgs = (0, index_all.isArray)(trgs) ? trgs : [trgs];
      trgs.forEach(function(target) {
        return result.push(_this.__getName(target));
      });
      elSel && (elSel.innerHTML = result.join(", "));
      this.checkStates();
    };
    ClassTagsView2.prototype.__getName = function(target) {
      var _a2 = this, pfx = _a2.pfx, config2 = _a2.config, em = _a2.em;
      var selectedName = config2.selectedName, componentFirst = config2.componentFirst;
      var result;
      if ((0, index_all.isString)(target)) {
        result = html(templateObject_2 || (templateObject_2 = ClassTagsView_makeTemplateObject(['<span class="', 'sel-gen">', "</span>"], ['<span class="', 'sel-gen">', "</span>"])), pfx, target);
      } else {
        var sel = target === null || target === void 0 ? void 0 : target.getSelectors();
        if (!sel)
          return "";
        var selectors = sel.getStyleable();
        var state = em.get("state");
        var idRes = target.getId ? html(templateObject_3 || (templateObject_3 = ClassTagsView_makeTemplateObject(['<span class="', 'sel-cmp">', '</span>\n            <span class="', 'sel-id">#', "</span>"], ['<span class="', 'sel-cmp">', '</span>\n            <span class="', 'sel-id">#', "</span>"])), pfx, target.getName(), pfx, target.getId()) : "";
        result = this.collection.getFullString(selectors);
        result = result ? html(templateObject_4 || (templateObject_4 = ClassTagsView_makeTemplateObject(['<span class="', 'sel-rule">', "</span>"], ['<span class="', 'sel-rule">', "</span>"])), pfx, result) : target.get("selectorsAdd") || idRes;
        result = componentFirst && idRes ? idRes : result;
        result += state ? html(templateObject_5 || (templateObject_5 = ClassTagsView_makeTemplateObject(['<span class="', 'sel-state">:', "</span>"], ['<span class="', 'sel-state">:', "</span>"])), pfx, state) : "";
        result = selectedName ? selectedName({ result, state, target }) : result;
      }
      return result && '<span class="'.concat(pfx, 'sel">').concat(result, "</span>");
    };
    ClassTagsView2.prototype.stateChanged = function(ev) {
      var em = this.em;
      var value = ev.target.value;
      em.set("state", value);
    };
    ClassTagsView2.prototype.addNewTag = function(value) {
      var label = value.trim();
      if (!label)
        return;
      this.module.addSelected({ label });
      this.endNewTag();
    };
    ClassTagsView2.prototype.addToClasses = function(model, fragmentEl) {
      var fragment = fragmentEl;
      var classes = this.getClasses();
      var rendered = new view_ClassTagView({
        model,
        config: this.config,
        coll: this.collection,
        module: this.module
      }).render().el;
      fragment ? fragment.appendChild(rendered) : classes.append(rendered);
      return rendered;
    };
    ClassTagsView2.prototype.renderClasses = function() {
      var _this = this;
      var frag = document.createDocumentFragment();
      var classes = this.getClasses();
      classes.empty();
      this.collection.each(function(model) {
        return _this.addToClasses(model, frag);
      });
      classes.append(frag);
    };
    ClassTagsView2.prototype.getClasses = function() {
      return this.$el.find("[data-selectors]");
    };
    ClassTagsView2.prototype.getStates = function() {
      if (!this.$states) {
        var el = this.$el.find("[data-states]");
        this.$states = el[0] && el;
      }
      return this.$states;
    };
    ClassTagsView2.prototype.getStatesC = function() {
      if (!this.$statesC)
        this.$statesC = this.$el.find("#" + this.stateInputC);
      return this.$statesC;
    };
    ClassTagsView2.prototype.renderStates = function() {
      var _a2 = this, module = _a2.module, em = _a2.em;
      var labelStates = em.t("selectorManager.emptyState");
      var options = module.getStates().map(function(state) {
        var label = em.t("selectorManager.states.".concat(state.id)) || state.getLabel() || state.id;
        return '<option value="'.concat(state.id, '">').concat(label, "</option>");
      }).join("");
      var statesEl = this.getStates();
      statesEl && statesEl.html('<option value="">'.concat(labelStates, "</option>").concat(options));
      this.checkStates();
    };
    ClassTagsView2.prototype.render = function() {
      var _a2 = this, em = _a2.em, pfx = _a2.pfx, ppfx = _a2.ppfx, config2 = _a2.config, $el = _a2.$el, el = _a2.el;
      var render = config2.render, iconSync = config2.iconSync, iconAdd = config2.iconAdd;
      var tmpOpts = {
        iconSync,
        iconAdd,
        labelHead: em.t("selectorManager.label"),
        labelInfo: em.t("selectorManager.selected"),
        ppfx,
        pfx,
        el
      };
      $el.html(this.template(tmpOpts));
      var renderRes = render && render(tmpOpts);
      renderRes && renderRes !== el && $el.empty().append(renderRes);
      this.$input = $el.find("[data-input]");
      this.$addBtn = $el.find("[data-add]");
      this.$classes = $el.find("#" + pfx + "tags-c");
      this.$btnSyncEl = $el.find("[data-sync-style]");
      this.$input.hide();
      this.renderStates();
      this.renderClasses();
      $el.attr("class", "".concat(this.className, " ").concat(ppfx, "one-bg ").concat(ppfx, "two-color"));
      return this;
    };
    return ClassTagsView2;
  }(common.Ss)
);
var view_ClassTagsView = ClassTagsView;
var ClassTagsView_templateObject_1;
var templateObject_2;
var templateObject_3;
var templateObject_4;
var templateObject_5;
var selector_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var selector_manager_assign = function() {
  selector_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return selector_manager_assign.apply(this, arguments);
};
var selector_manager_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var isId = function(str) {
  return (0, index_all.isString)(str) && str[0] == "#";
};
var isClass = function(str) {
  return (0, index_all.isString)(str) && str[0] == ".";
};
var selector_manager_evAll = "selector";
var selector_manager_evPfx = "".concat(selector_manager_evAll, ":");
var selector_manager_evAdd = "".concat(selector_manager_evPfx, "add");
var selector_manager_evUpdate = "".concat(selector_manager_evPfx, "update");
var selector_manager_evRemove = "".concat(selector_manager_evPfx, "remove");
var selector_manager_evRemoveBefore = "".concat(selector_manager_evRemove, ":before");
var evCustom = "".concat(selector_manager_evPfx, "custom");
var evState = "".concat(selector_manager_evPfx, "state");
var selectorEvents = {
  all: selector_manager_evAll,
  update: selector_manager_evUpdate,
  add: selector_manager_evAdd,
  remove: selector_manager_evRemove,
  removeBefore: selector_manager_evRemoveBefore,
  state: evState,
  custom: evCustom
};
var SelectorManager = (
  /** @class */
  function(_super) {
    selector_manager_extends(SelectorManager2, _super);
    function SelectorManager2(em) {
      var _this = _super.call(this, em, "SelectorManager", new model_Selectors([]), selectorEvents, selector_manager_config_config, { skipListen: true }) || this;
      _this.Selector = model_Selector;
      _this.Selectors = model_Selectors;
      _this.storageKey = "";
      (0, index_all.bindAll)(_this, "__updateSelectedByComponents");
      var config2 = _this.config;
      var ppfx = config2.pStylePrefix;
      if (ppfx)
        config2.stylePrefix = ppfx + config2.stylePrefix;
      _this.all = new model_Selectors(config2.selectors);
      _this.selected = new model_Selectors([], { em, config: config2 });
      _this.states = new common.pM(config2.states.map(function(state) {
        return new model_State(state);
      }), { model: model_State });
      _this.model = new common.Kx({ cFirst: config2.componentFirst, _undo: true });
      _this.__update = (0, index_all.debounce)(function() {
        return _this.__trgCustom();
      }, 0);
      _this.__initListen({
        collections: [_this.states, _this.selected],
        propagate: [{ entity: _this.states, event: _this.events.state }]
      });
      em.on("change:state", function(m, value) {
        return em.trigger(evState, value);
      });
      _this.model.on("change:cFirst", function(m, value) {
        return em.trigger("selector:type", value);
      });
      var eventCmpUpdateCls = "".concat(dom_components_types.I.update, ":classes");
      em.on("component:toggled ".concat(eventCmpUpdateCls), _this.__updateSelectedByComponents);
      var listenTo = "component:toggled ".concat(eventCmpUpdateCls, " change:device styleManager:update selector:state selector:type style:target");
      _this.model.listenTo(em, listenTo, function() {
        return _this.__update();
      });
      return _this;
    }
    SelectorManager2.prototype.__trgCustom = function(opts) {
      this.em.trigger(this.events.custom, this.__customData(opts));
    };
    SelectorManager2.prototype.getAll = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this.all ? opts.array ? selector_manager_spreadArray([], this.all.models, true) : this.all : [];
    };
    SelectorManager2.prototype.__customData = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.__ctn = this.__ctn || opts.container;
      return {
        states: this.getStates(),
        selected: this.getSelected(),
        container: this.__ctn
      };
    };
    SelectorManager2.prototype.postRender = function() {
      this.__appendTo();
      this.__trgCustom();
    };
    SelectorManager2.prototype.select = function(value, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var targets = Array.isArray(value) ? value : [value];
      var toSelect = this.em.Styles.select(targets, opts);
      this.selected.reset(this.__getCommonSelectors(toSelect));
      var selTags = this.selectorTags;
      var res = toSelect.filter(function(i) {
        return i;
      }).map(function(sel) {
        return (0, mixins.isComponent)(sel) ? sel : (0, mixins.isRule)(sel) && !sel.get("selectorsAdd") ? sel : sel.getSelectorsString();
      });
      selTags && selTags.componentChanged({ targets: res });
      return this;
    };
    SelectorManager2.prototype.addSelector = function(name, opts, cOpts) {
      if (opts === void 0) {
        opts = {};
      }
      if (cOpts === void 0) {
        cOpts = {};
      }
      var props = selector_manager_assign({}, opts);
      if ((0, index_all.isObject)(name)) {
        props = name;
      } else {
        props.name = name;
      }
      if (isId(props.name)) {
        props.name = props.name.substr(1);
        props.type = model_Selector.TYPE_ID;
      } else if (isClass(props.name)) {
        props.name = props.name.substr(1);
      }
      if (props.label && !props.name) {
        props.name = this.escapeName(props.label);
      }
      var cname = props.name;
      var config2 = this.getConfig();
      var _a2 = this, all = _a2.all, em = _a2.em;
      var selector = cname ? this.get(cname, props.type) : all.where(props)[0];
      if (!selector) {
        var selModel = props instanceof model_Selector ? props : new model_Selector(props, selector_manager_assign(selector_manager_assign({}, cOpts), { config: config2, em }));
        return all.add(selModel, cOpts);
      }
      return selector;
    };
    SelectorManager2.prototype.getSelector = function(name, type2) {
      if (type2 === void 0) {
        type2 = model_Selector.TYPE_CLASS;
      }
      if (isId(name)) {
        name = name.substr(1);
        type2 = model_Selector.TYPE_ID;
      } else if (isClass(name)) {
        name = name.substr(1);
      }
      return this.all.where({ name, type: type2 })[0];
    };
    SelectorManager2.prototype.add = function(props, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var cOpts = (0, index_all.isString)(props) ? {} : opts;
      if ((0, index_all.isArray)(props)) {
        return props.map(function(item) {
          return _this.addSelector(item, opts, cOpts);
        });
      } else {
        return this.addSelector(props, opts, cOpts);
      }
    };
    SelectorManager2.prototype.addClass = function(classes) {
      var _this = this;
      var added = [];
      if ((0, index_all.isString)(classes)) {
        classes = classes.trim().split(" ");
      }
      classes.forEach(function(name) {
        return added.push(_this.addSelector(name));
      });
      return added;
    };
    SelectorManager2.prototype.get = function(name, type2) {
      var _this = this;
      if ((0, index_all.isArray)(name)) {
        var result_1 = [];
        var selectors = name.map(function(item) {
          return _this.getSelector(item);
        }).filter(Boolean);
        selectors.forEach(function(item) {
          return result_1.indexOf(item) < 0 && result_1.push(item);
        });
        return result_1;
      } else {
        return this.getSelector(name, type2);
      }
    };
    SelectorManager2.prototype.remove = function(selector, opts) {
      return this.__remove(selector, opts);
    };
    SelectorManager2.prototype.rename = function(selector, name, opts) {
      var newName = this.escapeName(name);
      var result = this.get(newName);
      return result || selector.set({ name: newName, label: name }, opts);
    };
    SelectorManager2.prototype.setState = function(value) {
      this.em.setState(value);
      return this;
    };
    SelectorManager2.prototype.getState = function() {
      return this.em.getState();
    };
    SelectorManager2.prototype.getStates = function() {
      return selector_manager_spreadArray([], this.states.models, true);
    };
    SelectorManager2.prototype.setStates = function(states, opts) {
      return this.states.reset(states.map(function(state) {
        return new model_State(state);
      }), opts);
    };
    SelectorManager2.prototype.getSelected = function() {
      return this.__getCommon();
    };
    SelectorManager2.prototype.getSelectedAll = function() {
      return selector_manager_spreadArray([], this.selected.models, true);
    };
    SelectorManager2.prototype.addSelected = function(props) {
      var added = this.add(props);
      this.em.getSelectedAll().forEach(function(target) {
        target.getSelectors().add(added);
      });
    };
    SelectorManager2.prototype.removeSelected = function(selector) {
      this.em.getSelectedAll().forEach(function(trg) {
        !selector.get("protected") && trg && trg.getSelectors().remove(selector);
      });
    };
    SelectorManager2.prototype.duplicateSelected = function(selector, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var commonSelectors = this.getSelected();
      if (commonSelectors.indexOf(selector) < 0)
        return;
      var state = this.getState();
      var media = em.getCurrentMedia();
      var rule = em.Css.get(commonSelectors, state, media);
      var styleToApply = rule === null || rule === void 0 ? void 0 : rule.getStyle();
      em.getSelectedAll().forEach(function(component) {
        var selectors = component.getSelectors();
        if (selectors.includes(selector)) {
          var suffix = opts.suffix || " copy";
          var label = selector.getLabel();
          var newSelector = _this.addSelector("".concat(label).concat(suffix));
          var at = selectors.indexOf(selector);
          selectors.remove(selector);
          selectors.add(newSelector, { at });
        }
      });
      if (styleToApply) {
        var newRule = em.Css.add(this.getSelected(), state, media);
        newRule.setStyle(styleToApply);
      }
    };
    SelectorManager2.prototype.getSelectedTargets = function() {
      return this.em.Styles.getSelectedAll();
    };
    SelectorManager2.prototype.setComponentFirst = function(value) {
      this.getConfig().componentFirst = value;
      this.model.set({ cFirst: value });
    };
    SelectorManager2.prototype.getComponentFirst = function() {
      return this.getConfig().componentFirst;
    };
    SelectorManager2.prototype.escapeName = function(name) {
      var escapeName = this.getConfig().escapeName;
      return escapeName ? escapeName(name) : model_Selector.escapeName(name);
    };
    SelectorManager2.prototype.render = function(selectors) {
      var selectorTags = this.selectorTags;
      var config2 = this.getConfig();
      var el = selectorTags === null || selectorTags === void 0 ? void 0 : selectorTags.el;
      this.selected.reset(selectors);
      this.selectorTags = new view_ClassTagsView({
        el,
        collection: this.selected,
        //@ts-ignore
        module: this,
        config: config2
      });
      return this.selectorTags.render().el;
    };
    SelectorManager2.prototype.destroy = function() {
      var _a2 = this, selectorTags = _a2.selectorTags, model = _a2.model;
      model.stopListening();
      this.__update.cancel();
      this.__destroy();
      selectorTags === null || selectorTags === void 0 ? void 0 : selectorTags.remove();
      this.selectorTags = void 0;
    };
    SelectorManager2.prototype.__getCommon = function() {
      return this.__getCommonSelectors(this.em.getSelectedAll());
    };
    SelectorManager2.prototype.__getCommonSelectors = function(components, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var selectors = components.map(function(cmp) {
        return cmp.getSelectors && cmp.getSelectors().getValid(opts);
      }).filter(Boolean);
      return this.__common.apply(this, selectors);
    };
    SelectorManager2.prototype.__common = function() {
      var _this = this;
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      if (!args.length)
        return [];
      if (args.length === 1)
        return args[0];
      if (args.length === 2)
        return args[0].filter(function(item) {
          return args[1].indexOf(item) >= 0;
        });
      return args.slice(1).reduce(function(acc, item) {
        return _this.__common(acc, item);
      }, args[0]);
    };
    SelectorManager2.prototype.__updateSelectedByComponents = function() {
      this.selected.reset(this.__getCommon());
    };
    return SelectorManager2;
  }(ItemManagerModule)
);
var selector_manager = SelectorManager;
var parser_config_config_config = {
  textTags: ["br", "b", "i", "u", "a", "ul", "ol"],
  textTypes: ["text", "textnode", "comment"],
  parserCss: void 0,
  parserHtml: void 0,
  optionsHtml: {
    htmlType: "text/html",
    allowScripts: false,
    allowUnsafeAttr: false,
    allowUnsafeAttrValue: false,
    keepEmptyTextNodes: false
  }
};
var parser_config_config = parser_config_config_config;
var _a;
var CSS_RULE_TYPES = {
  STYLE_RULE: 1,
  CHARSET_RULE: 2,
  IMPORT_RULE: 3,
  MEDIA_RULE: 4,
  FONT_FACE_RULE: 5,
  PAGE_RULE: 6,
  KEYFRAMES_RULE: 7,
  KEYFRAME_RULE: 8,
  NAMESPACE_RULE: 10,
  COUNTER_STYLE_RULE: 11,
  SUPPORTS_RULE: 12,
  DOCUMENT_RULE: 13,
  FONT_FEATURE_VALUES_RULE: 14,
  VIEWPORT_RULE: 15,
  REGION_STYLE_RULE: 16
};
var AT_RULE_NAMES = (_a = {}, _a[CSS_RULE_TYPES.MEDIA_RULE] = "media", _a[CSS_RULE_TYPES.FONT_FACE_RULE] = "font-face", _a[CSS_RULE_TYPES.PAGE_RULE] = "page", _a[CSS_RULE_TYPES.KEYFRAMES_RULE] = "keyframes", _a[CSS_RULE_TYPES.COUNTER_STYLE_RULE] = "counter-style", _a[CSS_RULE_TYPES.SUPPORTS_RULE] = "supports", _a[CSS_RULE_TYPES.DOCUMENT_RULE] = "document", _a[CSS_RULE_TYPES.FONT_FEATURE_VALUES_RULE] = "font-feature-values", _a[CSS_RULE_TYPES.VIEWPORT_RULE] = "viewport", _a);
var AT_RULE_KEYS = (0, index_all.keys)(AT_RULE_NAMES);
var SINGLE_AT_RULE_TYPES = [
  CSS_RULE_TYPES.FONT_FACE_RULE,
  CSS_RULE_TYPES.PAGE_RULE,
  CSS_RULE_TYPES.COUNTER_STYLE_RULE,
  CSS_RULE_TYPES.VIEWPORT_RULE
];
var NESTABLE_AT_RULE_NAMES = AT_RULE_KEYS.filter(function(i) {
  return SINGLE_AT_RULE_TYPES.indexOf(Number(i)) < 0;
}).map(function(i) {
  return AT_RULE_NAMES[i];
}).concat(["container", "layer"]);
var SINGLE_AT_RULE_NAMES = SINGLE_AT_RULE_TYPES.map(function(n) {
  return AT_RULE_NAMES[n];
});
var parseSelector = function(str) {
  if (str === void 0) {
    str = "";
  }
  var add = [];
  var result = [];
  var sels = str.split(",");
  for (var i = 0, len = sels.length; i < len; i++) {
    var sel = sels[i].trim();
    if (/^(\.{1}[\w\-]+)+(:{1,2}[\w\-()]+)?$/gi.test(sel) || /^(#{1}[\w\-]+){1}(:{1,2}[\w\-()]+)?$/gi.test(sel)) {
      var cls = sel.split(".").filter(Boolean);
      result.push(cls);
    } else {
      add.push(sel);
    }
  }
  return {
    result,
    add
  };
};
var parseStyle = function(node) {
  var stl = node.style;
  var style = {};
  for (var i = 0, len = stl.length; i < len; i++) {
    var propName = stl[i];
    var propValue = stl.getPropertyValue(propName);
    var important = stl.getPropertyPriority(propName);
    style[propName] = "".concat(propValue).concat(important ? " !".concat(important) : "");
  }
  return style;
};
var parseCondition = function(node) {
  var condition = node.conditionText || node.media && node.media.mediaText || node.name || node.selectorText || "";
  return condition.trim();
};
var createNode = function(selectors, style, opts) {
  if (style === void 0) {
    style = {};
  }
  if (opts === void 0) {
    opts = {};
  }
  var node = {};
  var selLen = selectors.length;
  var lastClass = selectors[selLen - 1];
  var stateArr = lastClass ? lastClass.split(/:(.+)/) : [];
  var state = stateArr[1];
  var atRule = opts.atRule, selectorsAdd = opts.selectorsAdd, mediaText = opts.mediaText;
  var singleAtRule = SINGLE_AT_RULE_NAMES.indexOf(atRule) >= 0;
  singleAtRule && (node.singleAtRule = true);
  atRule && (node.atRuleType = atRule);
  selectorsAdd && (node.selectorsAdd = selectorsAdd);
  mediaText && (node.mediaText = mediaText);
  if (state) {
    selectors[selLen - 1] = stateArr[0];
    node.state = state;
    stateArr.splice(stateArr.length - 1, 1);
  }
  node.selectors = selectors;
  node.style = style;
  return node;
};
var getNestableAtRule = function(node) {
  var _a2 = node.cssText, cssText = _a2 === void 0 ? "" : _a2;
  return NESTABLE_AT_RULE_NAMES.find(function(name) {
    return cssText.indexOf("@".concat(name)) === 0;
  });
};
var parseNode = function(el) {
  var result = [];
  var nodes = el.cssRules || [];
  for (var i = 0, len = nodes.length; i < len; i++) {
    var node = nodes[i];
    var type2 = node.type;
    var singleAtRule = false;
    var atRuleType = "";
    var condition = "";
    var sels = node.selectorText || node.keyText || "";
    var isSingleAtRule = SINGLE_AT_RULE_TYPES.indexOf(type2) >= 0;
    if (isSingleAtRule) {
      singleAtRule = true;
      atRuleType = AT_RULE_NAMES[type2];
      condition = parseCondition(node);
    } else if (AT_RULE_KEYS.indexOf("".concat(type2)) >= 0 || !type2 && getNestableAtRule(node)) {
      var subRules = parseNode(node);
      var subAtRuleType = AT_RULE_NAMES[type2] || getNestableAtRule(node);
      condition = parseCondition(node);
      for (var s = 0, lens = subRules.length; s < lens; s++) {
        var subRule = subRules[s];
        condition && (subRule.mediaText = condition);
        subRule.atRuleType = subAtRuleType;
      }
      result = result.concat(subRules);
    }
    if (!sels && !isSingleAtRule)
      continue;
    var style = parseStyle(node);
    var selsParsed = parseSelector(sels);
    var selsAdd = selsParsed.add;
    var selsArr = selsParsed.result;
    var lastRule = void 0;
    for (var k2 = 0, len3 = selsArr.length; k2 < len3; k2++) {
      var model = createNode(selsArr[k2], style, {
        atRule: AT_RULE_NAMES[type2]
      });
      result.push(model);
      lastRule = model;
    }
    if (selsAdd.length) {
      var selsAddStr = selsAdd.join(", ");
      if (lastRule) {
        lastRule.selectorsAdd = selsAddStr;
      } else {
        var model = {
          selectors: [],
          selectorsAdd: selsAddStr,
          style
        };
        singleAtRule && (model.singleAtRule = singleAtRule);
        atRuleType && (model.atRuleType = atRuleType);
        condition && (model.mediaText = condition);
        result.push(model);
      }
    }
  }
  return result;
};
var BrowserParserCss = function(str) {
  var el = document.createElement("style");
  el.innerHTML = str;
  document.head.appendChild(el);
  var sheet = el.sheet;
  document.head.removeChild(el);
  return sheet ? parseNode(sheet) : [];
};
var ParserCss = function(em, config2) {
  if (config2 === void 0) {
    config2 = {};
  }
  return {
    /**
     * Parse CSS string to a desired model object
     * @param  {String} input CSS string
     * @return {Array<Object>}
     */
    parse: function(input) {
      var _this = this;
      var output = [];
      var parserCss = config2.parserCss;
      var editor = em === null || em === void 0 ? void 0 : em.Editor;
      var nodes = parserCss ? parserCss(input, editor) : BrowserParserCss(input);
      nodes.forEach(function(node) {
        return output = output.concat(_this.checkNode(node));
      });
      em === null || em === void 0 ? void 0 : em.trigger("parse:css", { input, output, nodes });
      return output;
    },
    /**
     * Check the returned node from a custom parser and transforms it to
     * a valid object for the CSS composer
     * @return {[type]}
     */
    checkNode: function(node) {
      var selectors = node.selectors, style = node.style;
      var result = [node];
      if ((0, index_all.isString)(selectors)) {
        var nodes_1 = [];
        var parsedNode = node;
        var selsParsed = parseSelector(selectors);
        var classSets = selsParsed.result;
        var selectorsAdd = selsParsed.add.join(", ");
        var opts_1 = { atRule: parsedNode.atRule, mediaText: parsedNode.params };
        if (classSets.length) {
          classSets.forEach(function(classSet) {
            nodes_1.push(createNode(classSet, style, opts_1));
          });
        } else {
          nodes_1.push(createNode([], style, opts_1));
        }
        if (selectorsAdd) {
          var lastNode = nodes_1[nodes_1.length - 1];
          lastNode.selectorsAdd = selectorsAdd;
        }
        result = nodes_1;
      }
      return result;
    }
  };
};
var model_ParserCss = ParserCss;
var parser_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ParserModule = (
  /** @class */
  function(_super) {
    parser_extends(ParserModule2, _super);
    function ParserModule2(em) {
      var _this = _super.call(this, em, "Parser", parser_config_config) || this;
      var config2 = _this.config;
      _this.parserCss = model_ParserCss(em, config2);
      _this.parserHtml = model_ParserHtml(em, config2);
      return _this;
    }
    ParserModule2.prototype.parseHtml = function(input, options) {
      if (options === void 0) {
        options = {};
      }
      var _a2 = this, em = _a2.em, parserHtml2 = _a2.parserHtml;
      parserHtml2.compTypes = em.Components.getTypes() || [];
      return parserHtml2.parse(input, this.parserCss, options);
    };
    ParserModule2.prototype.parseCss = function(input) {
      return this.parserCss.parse(input);
    };
    ParserModule2.prototype.destroy = function() {
    };
    return ParserModule2;
  }(abstract_Module)
);
var parser = ParserModule;
var storage_manager_config_config_config = {
  id: "gjs-",
  type: "local",
  autosave: true,
  autoload: true,
  stepsBeforeSave: 1,
  recovery: false,
  onStore: function(data) {
    return data;
  },
  onLoad: function(data) {
    return data;
  },
  options: {
    local: {
      key: "gjsProject",
      checkLocal: true
    },
    remote: {
      headers: {},
      urlStore: "",
      urlLoad: "",
      contentTypeJson: true,
      fetchOptions: "",
      credentials: "include",
      onStore: function(data) {
        return data;
      },
      onLoad: function(result) {
        return result;
      }
    }
  }
};
var storage_manager_config_config = storage_manager_config_config_config;
var LocalStorage_awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var LocalStorage_generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var LocalStorage = (
  /** @class */
  function() {
    function LocalStorage2() {
    }
    LocalStorage2.prototype.store = function(data_1) {
      return LocalStorage_awaiter(this, arguments, void 0, function(data, opts) {
        if (opts === void 0) {
          opts = {};
        }
        return LocalStorage_generator(this, function(_a2) {
          if (this.hasLocal(opts, true)) {
            localStorage.setItem(opts.key, JSON.stringify(data));
          }
          return [2, data];
        });
      });
    };
    LocalStorage2.prototype.load = function() {
      return LocalStorage_awaiter(this, arguments, void 0, function(opts) {
        var result;
        if (opts === void 0) {
          opts = {};
        }
        return LocalStorage_generator(this, function(_a2) {
          result = {};
          if (this.hasLocal(opts, true)) {
            result = JSON.parse(localStorage.getItem(opts.key) || "{}");
          }
          return [2, result];
        });
      });
    };
    LocalStorage2.prototype.hasLocal = function(opts, thr) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.checkLocal && (!(0, mixins.hasWin)() || !localStorage)) {
        if (thr)
          throw new Error("localStorage not available");
        return false;
      }
      return true;
    };
    return LocalStorage2;
  }()
);
var model_LocalStorage = LocalStorage;
function _typeof(o) {
  "@babel/helpers - typeof";
  return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function(o2) {
    return typeof o2;
  } : function(o2) {
    return o2 && "function" == typeof Symbol && o2.constructor === Symbol && o2 !== Symbol.prototype ? "symbol" : typeof o2;
  }, _typeof(o);
}
function finallyConstructor(callback) {
  var constructor = this.constructor;
  return this.then(function(value) {
    return constructor.resolve(callback()).then(function() {
      return value;
    });
  }, function(reason) {
    return constructor.resolve(callback()).then(function() {
      return constructor.reject(reason);
    });
  });
}
var src_finally = finallyConstructor;
var setTimeoutFunc = setTimeout;
function isArray(x) {
  return Boolean(x && typeof x.length !== "undefined");
}
function noop() {
}
function bind(fn, thisArg) {
  return function() {
    fn.apply(thisArg, arguments);
  };
}
function src_Promise(fn) {
  if (!(this instanceof src_Promise))
    throw new TypeError("Promises must be constructed via new");
  if (typeof fn !== "function")
    throw new TypeError("not a function");
  this._state = 0;
  this._handled = false;
  this._value = void 0;
  this._deferreds = [];
  doResolve(fn, this);
}
function handle(self2, deferred) {
  while (self2._state === 3) {
    self2 = self2._value;
  }
  if (self2._state === 0) {
    self2._deferreds.push(deferred);
    return;
  }
  self2._handled = true;
  src_Promise._immediateFn(function() {
    var cb = self2._state === 1 ? deferred.onFulfilled : deferred.onRejected;
    if (cb === null) {
      (self2._state === 1 ? resolve : reject)(deferred.promise, self2._value);
      return;
    }
    var ret;
    try {
      ret = cb(self2._value);
    } catch (e) {
      reject(deferred.promise, e);
      return;
    }
    resolve(deferred.promise, ret);
  });
}
function resolve(self2, newValue) {
  try {
    if (newValue === self2)
      throw new TypeError("A promise cannot be resolved with itself.");
    if (newValue && (_typeof(newValue) === "object" || typeof newValue === "function")) {
      var then = newValue.then;
      if (newValue instanceof src_Promise) {
        self2._state = 3;
        self2._value = newValue;
        finale(self2);
        return;
      } else if (typeof then === "function") {
        doResolve(bind(then, newValue), self2);
        return;
      }
    }
    self2._state = 1;
    self2._value = newValue;
    finale(self2);
  } catch (e) {
    reject(self2, e);
  }
}
function reject(self2, newValue) {
  self2._state = 2;
  self2._value = newValue;
  finale(self2);
}
function finale(self2) {
  if (self2._state === 2 && self2._deferreds.length === 0) {
    src_Promise._immediateFn(function() {
      if (!self2._handled) {
        src_Promise._unhandledRejectionFn(self2._value);
      }
    });
  }
  for (var i = 0, len = self2._deferreds.length; i < len; i++) {
    handle(self2, self2._deferreds[i]);
  }
  self2._deferreds = null;
}
function Handler(onFulfilled, onRejected, promise) {
  this.onFulfilled = typeof onFulfilled === "function" ? onFulfilled : null;
  this.onRejected = typeof onRejected === "function" ? onRejected : null;
  this.promise = promise;
}
function doResolve(fn, self2) {
  var done = false;
  try {
    fn(function(value) {
      if (done)
        return;
      done = true;
      resolve(self2, value);
    }, function(reason) {
      if (done)
        return;
      done = true;
      reject(self2, reason);
    });
  } catch (ex) {
    if (done)
      return;
    done = true;
    reject(self2, ex);
  }
}
src_Promise.prototype["catch"] = function(onRejected) {
  return this.then(null, onRejected);
};
src_Promise.prototype.then = function(onFulfilled, onRejected) {
  var prom = new this.constructor(noop);
  handle(this, new Handler(onFulfilled, onRejected, prom));
  return prom;
};
src_Promise.prototype["finally"] = src_finally;
src_Promise.all = function(arr) {
  return new src_Promise(function(resolve2, reject2) {
    if (!isArray(arr)) {
      return reject2(new TypeError("Promise.all accepts an array"));
    }
    var args = Array.prototype.slice.call(arr);
    if (args.length === 0)
      return resolve2([]);
    var remaining = args.length;
    function res(i2, val) {
      try {
        if (val && (_typeof(val) === "object" || typeof val === "function")) {
          var then = val.then;
          if (typeof then === "function") {
            then.call(val, function(val2) {
              res(i2, val2);
            }, reject2);
            return;
          }
        }
        args[i2] = val;
        if (--remaining === 0) {
          resolve2(args);
        }
      } catch (ex) {
        reject2(ex);
      }
    }
    for (var i = 0; i < args.length; i++) {
      res(i, args[i]);
    }
  });
};
src_Promise.resolve = function(value) {
  if (value && _typeof(value) === "object" && value.constructor === src_Promise) {
    return value;
  }
  return new src_Promise(function(resolve2) {
    resolve2(value);
  });
};
src_Promise.reject = function(value) {
  return new src_Promise(function(resolve2, reject2) {
    reject2(value);
  });
};
src_Promise.race = function(arr) {
  return new src_Promise(function(resolve2, reject2) {
    if (!isArray(arr)) {
      return reject2(new TypeError("Promise.race accepts an array"));
    }
    for (var i = 0, len = arr.length; i < len; i++) {
      src_Promise.resolve(arr[i]).then(resolve2, reject2);
    }
  });
};
src_Promise._immediateFn = // @ts-ignore
typeof setImmediate === "function" && function(fn) {
  setImmediate(fn);
} || function(fn) {
  setTimeoutFunc(fn, 0);
};
src_Promise._unhandledRejectionFn = function _unhandledRejectionFn(err) {
  if (typeof console !== "undefined" && console) {
    console.warn("Possible Unhandled Promise Rejection:", err);
  }
};
var src = src_Promise;
if ((0, mixins.hasWin)()) {
  window.Promise = window.Promise || src;
}
var utils_fetch = typeof fetch == "function" ? (
  // @ts-ignore
  fetch.bind()
) : function(url, options) {
  return new src(function(res, rej) {
    var req = new XMLHttpRequest();
    req.open(options.method || "get", url);
    req.withCredentials = options.credentials == "include";
    for (var k2 in options.headers || {}) {
      req.setRequestHeader(k2, options.headers[k2]);
    }
    req.onload = function(e) {
      return res({
        status: req.status,
        statusText: req.statusText,
        text: function() {
          return src.resolve(req.responseText);
        }
      });
    };
    req.onerror = rej;
    if (req.upload && options.onProgress) {
      req.upload.onprogress = options.onProgress;
    }
    options.body ? req.send(options.body) : req.send();
  });
};
var RemoteStorage_assign = function() {
  RemoteStorage_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return RemoteStorage_assign.apply(this, arguments);
};
var RemoteStorage_awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var RemoteStorage_generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var RemoteStorage = (
  /** @class */
  function() {
    function RemoteStorage2() {
    }
    RemoteStorage2.prototype.store = function(data_1) {
      return RemoteStorage_awaiter(this, arguments, void 0, function(data, opts) {
        if (opts === void 0) {
          opts = {};
        }
        return RemoteStorage_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              return [4, this.request(opts.urlStore, this.__props(opts, data), opts)];
            case 1:
              return [2, _a2.sent()];
          }
        });
      });
    };
    RemoteStorage2.prototype.load = function() {
      return RemoteStorage_awaiter(this, arguments, void 0, function(opts) {
        if (opts === void 0) {
          opts = {};
        }
        return RemoteStorage_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              return [4, this.request(opts.urlLoad, this.__props(opts), opts)];
            case 1:
              return [2, _a2.sent()];
          }
        });
      });
    };
    RemoteStorage2.prototype.request = function(url, props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      return utils_fetch(url, props).then(function(res) {
        var result = res.text();
        var isOk = (res.status / 200 | 0) === 1;
        return isOk ? result : result.then(Promise.reject);
      }).then(function(text) {
        var parsable = text && (0, index_all.isString)(text);
        return opts.contentTypeJson && parsable ? JSON.parse(text) : text;
      });
    };
    RemoteStorage2.prototype.__props = function(opts, data) {
      if (opts === void 0) {
        opts = {};
      }
      var typeJson = opts.contentTypeJson;
      var headers = opts.headers || {};
      var fetchOpts = opts.fetchOptions || {};
      var reqHead = "X-Requested-With";
      var typeHead = "Content-Type";
      var body;
      if ((0, index_all.isUndefined)(headers[reqHead])) {
        headers[reqHead] = "XMLHttpRequest";
      }
      if ((0, index_all.isUndefined)(headers[typeHead]) && typeJson) {
        headers[typeHead] = "application/json; charset=utf-8";
      }
      if (data) {
        if (typeJson) {
          body = JSON.stringify(data);
        } else {
          body = new FormData();
          for (var key in data) {
            body.append(key, data[key]);
          }
        }
      }
      var result = {
        method: body ? "POST" : "GET",
        credentials: opts.credentials,
        headers,
        body
      };
      return RemoteStorage_assign(RemoteStorage_assign({}, result), (0, index_all.isFunction)(fetchOpts) ? fetchOpts(result) : fetchOpts);
    };
    return RemoteStorage2;
  }()
);
var model_RemoteStorage = RemoteStorage;
var StorageEvents;
(function(StorageEvents2) {
  StorageEvents2["start"] = "storage:start";
  StorageEvents2["startStore"] = "storage:start:store";
  StorageEvents2["startLoad"] = "storage:start:load";
  StorageEvents2["load"] = "storage:load";
  StorageEvents2["store"] = "storage:store";
  StorageEvents2["after"] = "storage:after";
  StorageEvents2["afterStore"] = "storage:after:store";
  StorageEvents2["afterLoad"] = "storage:after:load";
  StorageEvents2["end"] = "storage:end";
  StorageEvents2["endStore"] = "storage:end:store";
  StorageEvents2["endLoad"] = "storage:end:load";
  StorageEvents2["error"] = "storage:error";
  StorageEvents2["errorStore"] = "storage:error:store";
  StorageEvents2["errorLoad"] = "storage:error:load";
})(StorageEvents || (StorageEvents = {}));
var storage_manager_types = StorageEvents;
var storage_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var storage_manager_assign = function() {
  storage_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return storage_manager_assign.apply(this, arguments);
};
var storage_manager_awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var storage_manager_generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var STORAGE_LOCAL = "local";
var STORAGE_REMOTE = "remote";
var StorageManager = (
  /** @class */
  function(_super) {
    storage_manager_extends(StorageManager2, _super);
    function StorageManager2(em) {
      var _this = _super.call(this, em, "StorageManager", storage_manager_config_config) || this;
      _this.storages = {};
      _this.events = storage_manager_types;
      var config2 = _this.config;
      if (config2._disable)
        config2.type = void 0;
      _this.storages = {};
      _this.add(STORAGE_LOCAL, new model_LocalStorage());
      _this.add(STORAGE_REMOTE, new model_RemoteStorage());
      _this.setCurrent(config2.type);
      return _this;
    }
    StorageManager2.prototype.isAutosave = function() {
      return !!this.config.autosave;
    };
    StorageManager2.prototype.setAutosave = function(value) {
      this.config.autosave = !!value;
      return this;
    };
    StorageManager2.prototype.getStepsBeforeSave = function() {
      return this.config.stepsBeforeSave;
    };
    StorageManager2.prototype.setStepsBeforeSave = function(value) {
      this.config.stepsBeforeSave = value;
      return this;
    };
    StorageManager2.prototype.add = function(type2, storage) {
      this.storages[type2] = storage;
      return this;
    };
    StorageManager2.prototype.get = function(type2) {
      return this.storages[type2];
    };
    StorageManager2.prototype.getStorages = function() {
      return this.storages;
    };
    StorageManager2.prototype.getCurrent = function() {
      return this.config.currentStorage;
    };
    StorageManager2.prototype.setCurrent = function(type2) {
      this.getConfig().currentStorage = type2;
      return this;
    };
    StorageManager2.prototype.getCurrentStorage = function() {
      return this.get(this.getCurrent());
    };
    StorageManager2.prototype.getStorageOptions = function(type2) {
      return this.getCurrentOptions(type2);
    };
    StorageManager2.prototype.store = function(data_1) {
      return storage_manager_awaiter(this, arguments, void 0, function(data, options) {
        var st, opts, recovery, recoveryOpts, _a2, error_1;
        if (options === void 0) {
          options = {};
        }
        return storage_manager_generator(this, function(_b) {
          switch (_b.label) {
            case 0:
              st = this.getCurrentStorage();
              opts = storage_manager_assign(storage_manager_assign({}, this.getCurrentOptions()), options);
              recovery = this.getRecoveryStorage();
              recoveryOpts = this.getCurrentOptions(STORAGE_LOCAL);
              _b.label = 1;
            case 1:
              _b.trys.push([1, 5, , 9]);
              return [4, this.__exec(st, opts, data)];
            case 2:
              _b.sent();
              _a2 = recovery;
              if (!_a2)
                return [3, 4];
              return [4, this.__exec(recovery, recoveryOpts, {})];
            case 3:
              _a2 = _b.sent();
              _b.label = 4;
            case 4:
              _a2;
              return [3, 9];
            case 5:
              error_1 = _b.sent();
              if (!recovery)
                return [3, 7];
              return [4, this.__exec(recovery, recoveryOpts, data)];
            case 6:
              _b.sent();
              return [3, 8];
            case 7:
              throw error_1;
            case 8:
              return [3, 9];
            case 9:
              return [2, data];
          }
        });
      });
    };
    StorageManager2.prototype.load = function() {
      return storage_manager_awaiter(this, arguments, void 0, function(options) {
        var st, opts, recoveryStorage, result, recoveryData, error_2;
        if (options === void 0) {
          options = {};
        }
        return storage_manager_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              st = this.getCurrentStorage();
              opts = storage_manager_assign(storage_manager_assign({}, this.getCurrentOptions()), options);
              recoveryStorage = this.getRecoveryStorage();
              if (!recoveryStorage)
                return [3, 5];
              return [4, this.__exec(recoveryStorage, this.getCurrentOptions(STORAGE_LOCAL))];
            case 1:
              recoveryData = _a2.sent();
              if (!!(0, index_all.isEmpty)(recoveryData))
                return [3, 5];
              _a2.label = 2;
            case 2:
              _a2.trys.push([2, 4, , 5]);
              return [4, this.__askRecovery()];
            case 3:
              _a2.sent();
              result = recoveryData;
              return [3, 5];
            case 4:
              error_2 = _a2.sent();
              return [3, 5];
            case 5:
              if (!!result)
                return [3, 7];
              return [4, this.__exec(st, opts)];
            case 6:
              result = _a2.sent();
              _a2.label = 7;
            case 7:
              return [2, result || {}];
          }
        });
      });
    };
    StorageManager2.prototype.__askRecovery = function() {
      var em = this.em;
      var recovery = this.getRecovery();
      return new Promise(function(res, rej) {
        if ((0, index_all.isFunction)(recovery)) {
          recovery(res, rej, em === null || em === void 0 ? void 0 : em.getEditor());
        } else {
          confirm(em === null || em === void 0 ? void 0 : em.t("storageManager.recover")) ? res(null) : rej();
        }
      });
    };
    StorageManager2.prototype.getRecovery = function() {
      return this.config.recovery;
    };
    StorageManager2.prototype.getRecoveryStorage = function() {
      var recovery = this.getRecovery();
      return recovery && this.getCurrent() === STORAGE_REMOTE && this.get(STORAGE_LOCAL);
    };
    StorageManager2.prototype.__exec = function(storage, opts, data) {
      return storage_manager_awaiter(this, void 0, void 0, function() {
        var ev, _a2, onStore, onLoad, result, editor, response, toStore, _b, _c, _d, _e, error_3;
        var _f;
        return storage_manager_generator(this, function(_g) {
          switch (_g.label) {
            case 0:
              ev = data ? "store" : "load";
              _a2 = this.getConfig(), onStore = _a2.onStore, onLoad = _a2.onLoad;
              if (!storage) {
                return [2, data || {}];
              }
              this.onStart(ev, data);
              _g.label = 1;
            case 1:
              _g.trys.push([1, 14, , 15]);
              editor = (_f = this.em) === null || _f === void 0 ? void 0 : _f.getEditor();
              response = void 0;
              if (!data)
                return [3, 7];
              _b = onStore;
              if (!_b)
                return [3, 3];
              return [4, onStore(data, editor)];
            case 2:
              _b = _g.sent();
              _g.label = 3;
            case 3:
              toStore = _b || data;
              _c = opts.onStore;
              if (!_c)
                return [3, 5];
              return [4, opts.onStore(toStore, editor)];
            case 4:
              _c = _g.sent();
              _g.label = 5;
            case 5:
              toStore = _c || toStore;
              return [4, storage.store(toStore, opts)];
            case 6:
              response = _g.sent();
              result = data;
              return [3, 13];
            case 7:
              return [4, storage.load(opts)];
            case 8:
              response = _g.sent();
              result = this.__clearKeys(response);
              _d = opts.onLoad;
              if (!_d)
                return [3, 10];
              return [4, opts.onLoad(result, editor)];
            case 9:
              _d = _g.sent();
              _g.label = 10;
            case 10:
              result = _d || result;
              _e = onLoad;
              if (!_e)
                return [3, 12];
              return [4, onLoad(result, editor)];
            case 11:
              _e = _g.sent();
              _g.label = 12;
            case 12:
              result = _e || result;
              _g.label = 13;
            case 13:
              this.onAfter(ev, result, response);
              this.onEnd(ev, result, response);
              return [3, 15];
            case 14:
              error_3 = _g.sent();
              this.onError(ev, error_3);
              throw error_3;
            case 15:
              return [2, result];
          }
        });
      });
    };
    StorageManager2.prototype.__clearKeys = function(data) {
      if (data === void 0) {
        data = {};
      }
      var config2 = this.getConfig();
      var reg = new RegExp("^".concat(config2.id));
      var result = {};
      for (var itemKey in data) {
        var itemKeyR = itemKey.replace(reg, "");
        result[itemKeyR] = data[itemKey];
      }
      return result;
    };
    StorageManager2.prototype.getCurrentOptions = function(type2) {
      var config2 = this.getConfig();
      var current = type2 || this.getCurrent();
      return config2.options[current] || {};
    };
    StorageManager2.prototype.onStart = function(type2, data) {
      var em = this.em;
      if (em) {
        var ev = type2 === "load" ? storage_manager_types.startLoad : storage_manager_types.startStore;
        em.trigger(storage_manager_types.start, type2, data);
        em.trigger(ev, data);
      }
    };
    StorageManager2.prototype.onAfter = function(type2, data, response) {
      var em = this.em;
      if (em) {
        var evAfter = type2 === "load" ? storage_manager_types.afterLoad : storage_manager_types.afterStore;
        em.trigger(storage_manager_types.after);
        em.trigger(evAfter, data, response);
        var ev = type2 === "load" ? storage_manager_types.load : storage_manager_types.store;
        em.trigger(ev, data, response);
      }
    };
    StorageManager2.prototype.onEnd = function(type2, data, response) {
      var em = this.em;
      if (em) {
        var ev = type2 === "load" ? storage_manager_types.endLoad : storage_manager_types.endStore;
        em.trigger(storage_manager_types.end, type2, data, response);
        em.trigger(ev, data, response);
      }
    };
    StorageManager2.prototype.onError = function(type2, error) {
      var em = this.em;
      if (em) {
        var ev = type2 === "load" ? storage_manager_types.errorLoad : storage_manager_types.errorStore;
        em.trigger(storage_manager_types.error, error, type2);
        em.trigger(ev, error);
        this.onEnd(type2, error);
      }
    };
    StorageManager2.prototype.canAutoload = function() {
      var storage = this.getCurrentStorage();
      return !!storage && !!this.config.autoload;
    };
    StorageManager2.prototype.destroy = function() {
      this.storages = {};
    };
    return StorageManager2;
  }(abstract_Module)
);
var storage_manager = StorageManager;
var trait_manager_config_config_config = {
  stylePrefix: "trt-",
  appendTo: "",
  optionsTarget: [{ value: false }, { value: "_blank" }],
  custom: false
};
var trait_manager_config_config = trait_manager_config_config_config;
var TraitView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TraitView_assign = function() {
  TraitView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return TraitView_assign.apply(this, arguments);
};
var TraitView = (
  /** @class */
  function(_super) {
    TraitView_extends(TraitView2, _super);
    function TraitView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      _this.events = {};
      _this.appendInput = true;
      var _a2 = o.config, config2 = _a2 === void 0 ? {} : _a2;
      var _b = _this, model = _b.model, eventCapture = _b.eventCapture;
      var target = model.target;
      var type2 = model.attributes.type;
      _this.config = config2;
      _this.em = config2.em;
      _this.pfx = config2.stylePrefix || "";
      _this.ppfx = config2.pStylePrefix || "";
      _this.target = target;
      _this.className = _this.pfx + "trait";
      _this.clsField = "".concat(_this.ppfx, "field ").concat(_this.ppfx, "field-").concat(type2);
      var evToListen = [
        ["change:value", _this.onValueChange],
        ["remove", _this.removeView]
      ];
      evToListen.forEach(function(_a3) {
        var event = _a3[0], clb = _a3[1];
        model.off(event, clb);
        _this.listenTo(model, event, clb);
      });
      model.view = _this;
      _this.listenTo(model, "change:label", _this.render);
      _this.listenTo(model, "change:placeholder", _this.rerender);
      _this.events = {};
      eventCapture.forEach(function(event) {
        return _this.events[event] = "onChange";
      });
      _this.delegateEvents();
      _this.init();
      return _this;
    }
    TraitView2.prototype.attributes = function() {
      return this.model.get("attributes") || {};
    };
    TraitView2.prototype.templateLabel = function(cmp) {
      var ppfx = this.ppfx;
      var label = this.getLabel();
      return '<div class="'.concat(ppfx, 'label" title="').concat(label, '">').concat(label, "</div>");
    };
    TraitView2.prototype.templateInput = function(data) {
      var clsField = this.clsField;
      return '<div class="'.concat(clsField, '" data-input></div>');
    };
    TraitView2.prototype.getClbOpts = function() {
      return {
        component: this.target,
        trait: this.model,
        elInput: this.getInputElem()
      };
    };
    TraitView2.prototype.removeView = function() {
      this.remove();
      this.removed();
    };
    TraitView2.prototype.init = function() {
    };
    TraitView2.prototype.removed = function() {
    };
    TraitView2.prototype.onRender = function(props) {
    };
    TraitView2.prototype.onUpdate = function(props) {
    };
    TraitView2.prototype.onEvent = function(props) {
    };
    TraitView2.prototype.onChange = function(event) {
      var el = this.getInputElem();
      if (el && !(0, index_all.isUndefined)(el.value)) {
        this.model.set("value", el.value);
      }
      this.onEvent(TraitView_assign(TraitView_assign({}, this.getClbOpts()), { event }));
    };
    TraitView2.prototype.getValueForTarget = function() {
      return this.model.get("value");
    };
    TraitView2.prototype.setInputValue = function(value) {
      var el = this.getInputElem();
      el && (el.value = value);
    };
    TraitView2.prototype.onValueChange = function(model, value, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.fromTarget) {
        this.setInputValue(model.get("value"));
        this.postUpdate();
      } else {
        var val = this.getValueForTarget();
        model.setTargetValue(val, opts);
      }
    };
    TraitView2.prototype.renderLabel = function() {
      var _a2 = this, $el = _a2.$el, target = _a2.target;
      var label = this.getLabel();
      var tpl = this.templateLabel(target);
      if (this.createLabel) {
        tpl = this.createLabel({
          label,
          component: target,
          trait: this
        }) || "";
      }
      $el.find("[data-label]").append(tpl);
    };
    TraitView2.prototype.getLabel = function() {
      var em = this.em;
      var _a2 = this.model.attributes, label = _a2.label, name = _a2.name;
      return em.t("traitManager.traits.labels.".concat(name)) || (0, mixins.capitalize)(label || name).replace(/-/g, " ");
    };
    TraitView2.prototype.getComponent = function() {
      return this.target;
    };
    TraitView2.prototype.getInputEl = function() {
      if (!this.$input) {
        var _a2 = this, em = _a2.em, model = _a2.model;
        var md = model;
        var name_1 = model.attributes.name;
        var placeholder = md.get("placeholder") || md.get("default") || "";
        var type2 = md.get("type") || "text";
        var min = md.get("min");
        var max = md.get("max");
        var value = this.getModelValue();
        var input = (0, cash_dom["default"])('<input type="'.concat(type2, '">'));
        var i18nAttr = em.t("traitManager.traits.attributes.".concat(name_1)) || {};
        input.attr(TraitView_assign({ placeholder }, i18nAttr));
        if (!(0, index_all.isUndefined)(value)) {
          md.set({ value }, { silent: true });
          input.prop("value", value);
        }
        if (min) {
          input.prop("min", min);
        }
        if (max) {
          input.prop("max", max);
        }
        this.$input = input;
      }
      return this.$input.get(0);
    };
    TraitView2.prototype.getInputElem = function() {
      var _a2 = this, input = _a2.input, $input = _a2.$input;
      return input || $input && $input.get && $input.get(0) || this.getElInput();
    };
    TraitView2.prototype.getModelValue = function() {
      return this.model.getValue();
    };
    TraitView2.prototype.getElInput = function() {
      return this.elInput;
    };
    TraitView2.prototype.renderField = function() {
      var _a2 = this, $el = _a2.$el, appendInput = _a2.appendInput, model = _a2.model;
      var inputs = $el.find("[data-input]");
      var el = inputs[inputs.length - 1];
      var tpl = model.el;
      if (!tpl) {
        tpl = this.createInput ? this.createInput(this.getClbOpts()) : this.getInputEl();
      }
      if ((0, index_all.isString)(tpl)) {
        el.innerHTML = tpl;
        this.elInput = el.firstChild;
      } else {
        appendInput ? el.appendChild(tpl) : el.insertBefore(tpl, el.firstChild);
        this.elInput = tpl;
      }
      model.el = this.elInput;
    };
    TraitView2.prototype.hasLabel = function() {
      var label = this.model.attributes.label;
      return !this.noLabel && label !== false;
    };
    TraitView2.prototype.rerender = function() {
      delete this.model.el;
      this.render();
    };
    TraitView2.prototype.postUpdate = function() {
      this.onUpdate(this.getClbOpts());
    };
    TraitView2.prototype.render = function() {
      var _a2 = this, $el = _a2.$el, pfx = _a2.pfx, ppfx = _a2.ppfx, model = _a2.model;
      var _b = model.attributes, type2 = _b.type, id = _b.id;
      var hasLabel = this.hasLabel && this.hasLabel();
      var cls = "".concat(pfx, "trait");
      delete this.$input;
      var tmpl = '<div class="'.concat(cls, " ").concat(cls, "--").concat(type2, '">\n      ').concat(hasLabel ? '<div class="'.concat(ppfx, 'label-wrp" data-label></div>') : "", '\n      <div class="').concat(ppfx, "field-wrp ").concat(ppfx, "field-wrp--").concat(type2, '" data-input>\n        ').concat(this.templateInput ? (0, index_all.isFunction)(this.templateInput) ? this.templateInput(this.getClbOpts()) : this.templateInput : "", "\n      </div>\n    </div>");
      $el.empty().append(tmpl);
      hasLabel && this.renderLabel();
      this.renderField();
      this.el.className = "".concat(cls, "__wrp ").concat(cls, "__wrp-").concat(id);
      this.postUpdate();
      this.onRender(this.getClbOpts());
      return this;
    };
    return TraitView2;
  }(common.Ss)
);
var view_TraitView = TraitView;
TraitView.prototype.eventCapture = ["change"];
var TraitButtonView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TraitButtonView = (
  /** @class */
  function(_super) {
    TraitButtonView_extends(TraitButtonView2, _super);
    function TraitButtonView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    TraitButtonView2.prototype.templateInput = function() {
      return "";
    };
    TraitButtonView2.prototype.onChange = function() {
      this.handleClick();
    };
    TraitButtonView2.prototype.handleClick = function() {
      this.model.runCommand();
    };
    TraitButtonView2.prototype.renderLabel = function() {
      if (this.model.get("label")) {
        view_TraitView.prototype.renderLabel.apply(this);
      }
    };
    TraitButtonView2.prototype.getInputEl = function() {
      var _a2 = this, model = _a2.model, ppfx = _a2.ppfx;
      var _b = model.props(), labelButton = _b.labelButton, text = _b.text, full = _b.full;
      var label = labelButton || text;
      var className = "".concat(ppfx, "btn");
      var input = '<button type="button" class="'.concat(className, "-prim").concat(full ? " ".concat(className, "--full") : "", '">').concat(label, "</button>");
      return input;
    };
    return TraitButtonView2;
  }(view_TraitView)
);
var view_TraitButtonView = TraitButtonView;
TraitButtonView.prototype.eventCapture = ["click button"];
var TraitCheckboxView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TraitCheckboxView = (
  /** @class */
  function(_super) {
    TraitCheckboxView_extends(TraitCheckboxView2, _super);
    function TraitCheckboxView2() {
      var _this = _super !== null && _super.apply(this, arguments) || this;
      _this.appendInput = false;
      return _this;
    }
    TraitCheckboxView2.prototype.templateInput = function() {
      var _a2 = this, ppfx = _a2.ppfx, clsField = _a2.clsField;
      return '<label class="'.concat(clsField, '" data-input>\n    <i class="').concat(ppfx, 'chk-icon"></i>\n  </label>');
    };
    TraitCheckboxView2.prototype.onChange = function() {
      this.model.set("value", this.getInputElem().checked);
    };
    TraitCheckboxView2.prototype.setInputValue = function(value) {
      var el = this.getInputElem();
      el && (el.checked = !!value);
    };
    TraitCheckboxView2.prototype.getInputEl = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      var toInit = !this.$input;
      var el = view_TraitView.prototype.getInputEl.apply(this, args);
      if (toInit) {
        var checked = void 0, targetValue = void 0;
        var _a2 = this, model = _a2.model, target = _a2.target;
        var valueFalse = model.attributes.valueFalse;
        var name_1 = model.getName();
        if (model.changeProp) {
          checked = target.get(name_1);
          targetValue = checked;
        } else {
          targetValue = target.get("attributes")[name_1];
          checked = targetValue || targetValue === "" ? true : false;
        }
        if (!(0, index_all.isUndefined)(valueFalse) && targetValue === valueFalse) {
          checked = false;
        }
        el.checked = checked;
      }
      return el;
    };
    return TraitCheckboxView2;
  }(view_TraitView)
);
var view_TraitCheckboxView = TraitCheckboxView;
function ColorPicker($, undefined2) {
  "use strict";
  if (!(0, mixins.hasWin)())
    return;
  var defaultOpts = {
    // Callbacks
    beforeShow: noop2,
    move: noop2,
    change: noop2,
    show: noop2,
    hide: noop2,
    // Options
    color: false,
    flat: false,
    showInput: false,
    allowEmpty: false,
    showButtons: true,
    clickoutFiresChange: true,
    showInitial: false,
    showPalette: false,
    showPaletteOnly: false,
    hideAfterPaletteSelect: false,
    togglePaletteOnly: false,
    showSelectionPalette: true,
    localStorageKey: false,
    appendTo: "body",
    maxSelectionSize: 7,
    cancelText: "cancel",
    chooseText: "choose",
    togglePaletteMoreText: "more",
    togglePaletteLessText: "less",
    clearText: "Clear Color Selection",
    noColorSelectedText: "No Color Selected",
    preferredFormat: false,
    className: "",
    // Deprecated - use containerClassName and replacerClassName instead.
    containerClassName: "",
    replacerClassName: "",
    showAlpha: false,
    theme: "sp-light",
    palette: [["#ffffff", "#000000", "#ff0000", "#ff8000", "#ffff00", "#008000", "#0000ff", "#4b0082", "#9400d3"]],
    selectionPalette: [],
    disabled: false,
    offset: null
  }, spectrums = [], IE = !!/msie/i.exec(window.navigator.userAgent), rgbaSupport = function() {
    function contains(str, substr) {
      return !!~("" + str).indexOf(substr);
    }
    var elem = document.createElement("div");
    var style = elem.style;
    style.cssText = "background-color:rgba(0,0,0,.5)";
    return contains(style.backgroundColor, "rgba") || contains(style.backgroundColor, "hsla");
  }(), replaceInput = [
    "<div class='sp-replacer'>",
    "<div class='sp-preview'><div class='sp-preview-inner'></div></div>",
    "<div class='sp-dd'>&#9660;</div>",
    "</div>"
  ].join(""), markup = function() {
    var gradientFix = "";
    if (IE) {
      for (var i = 1; i <= 6; i++) {
        gradientFix += "<div class='sp-" + i + "'></div>";
      }
    }
    return [
      "<div class='sp-container sp-hidden'>",
      "<div class='sp-palette-container'>",
      "<div class='sp-palette sp-thumb sp-cf'></div>",
      "<div class='sp-palette-button-container sp-cf'>",
      "<button type='button' class='sp-palette-toggle'></button>",
      "</div>",
      "</div>",
      "<div class='sp-picker-container'>",
      "<div class='sp-top sp-cf'>",
      "<div class='sp-fill'></div>",
      "<div class='sp-top-inner'>",
      "<div class='sp-color'>",
      "<div class='sp-sat'>",
      "<div class='sp-val'>",
      "<div class='sp-dragger'></div>",
      "</div>",
      "</div>",
      "</div>",
      "<div class='sp-clear sp-clear-display'>",
      "</div>",
      "<div class='sp-hue'>",
      "<div class='sp-slider'></div>",
      gradientFix,
      "</div>",
      "</div>",
      "<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>",
      "</div>",
      "<div class='sp-input-container sp-cf'>",
      "<input class='sp-input' type='text' spellcheck='false'  />",
      "</div>",
      "<div class='sp-initial sp-thumb sp-cf'></div>",
      "<div class='sp-button-container sp-cf'>",
      "<a class='sp-cancel' href='#'></a>",
      "<button type='button' class='sp-choose'></button>",
      "</div>",
      "</div>",
      "</div>"
    ].join("");
  }();
  function paletteTemplate(p, color, className, opts) {
    var html2 = [];
    for (var i = 0; i < p.length; i++) {
      var current = p[i];
      if (current) {
        var tiny = tinycolor(current);
        var c = tiny.toHsl().l < 0.5 ? "sp-thumb-el sp-thumb-dark" : "sp-thumb-el sp-thumb-light";
        c += tinycolor.equals(color, current) ? " sp-thumb-active" : "";
        var formattedString = tiny.toString(opts.preferredFormat || "rgb");
        var swatchStyle = rgbaSupport ? "background-color:" + tiny.toRgbString() : "filter:" + tiny.toFilter();
        html2.push('<span title="' + formattedString + '" data-color="' + tiny.toRgbString() + '" class="' + c + '"><span class="sp-thumb-inner" style="' + swatchStyle + ';"></span></span>');
      } else {
        var cls = "sp-clear-display";
        html2.push($("<div />").append($('<span data-color="" style="background-color:transparent;" class="' + cls + '"></span>').attr("title", opts.noColorSelectedText)).html());
      }
    }
    return "<div class='sp-cf " + className + "'>" + html2.join("") + "</div>";
  }
  function hideAll() {
    for (var i = 0; i < spectrums.length; i++) {
      if (spectrums[i]) {
        spectrums[i].hide();
      }
    }
  }
  function instanceOptions(o, callbackContext) {
    var opts = $.extend({}, defaultOpts, o);
    opts.callbacks = {
      move: bind2(opts.move, callbackContext),
      change: bind2(opts.change, callbackContext),
      show: bind2(opts.show, callbackContext),
      hide: bind2(opts.hide, callbackContext),
      beforeShow: bind2(opts.beforeShow, callbackContext)
    };
    return opts;
  }
  function spectrum(element, o) {
    var opts = instanceOptions(o, element), flat = opts.flat, showSelectionPalette = opts.showSelectionPalette, localStorageKey = opts.localStorageKey, theme = opts.theme, callbacks = opts.callbacks, resize = throttle(reflow, 10), visible = false, isDragging = false, isDefault = true, dragWidth = 0, dragHeight = 0, dragHelperHeight = 0, slideHeight = 0, slideWidth = 0, alphaWidth = 0, alphaSlideHelperWidth = 0, slideHelperHeight = 0, currentHue = 0, currentSaturation = 0, currentValue = 0, currentAlpha = 1, palette = [], paletteArray = [], paletteLookup = {}, selectionPalette = opts.selectionPalette.slice(0), maxSelectionSize = opts.maxSelectionSize, draggingClass = "sp-dragging", shiftMovementDirection = null;
    var doc = element.ownerDocument, body = doc.body, boundElement = $(element), disabled = false, container = $(markup, doc).addClass(theme), pickerContainer = container.find(".sp-picker-container"), dragger = container.find(".sp-color"), dragHelper = container.find(".sp-dragger"), slider = container.find(".sp-hue"), slideHelper = container.find(".sp-slider"), alphaSliderInner = container.find(".sp-alpha-inner"), alphaSlider = container.find(".sp-alpha"), alphaSlideHelper = container.find(".sp-alpha-handle"), textInput = container.find(".sp-input"), paletteContainer = container.find(".sp-palette"), initialColorContainer = container.find(".sp-initial"), cancelButton = container.find(".sp-cancel"), clearButton = container.find(".sp-clear"), chooseButton = container.find(".sp-choose"), toggleButton = container.find(".sp-palette-toggle"), isInput = boundElement.is("input"), isInputTypeColor = isInput && boundElement.attr("type") === "color" && inputTypeColorSupport(), shouldReplace = isInput && !flat, replacer = shouldReplace ? $(replaceInput).addClass(theme).addClass(opts.className).addClass(opts.replacerClassName) : $([]), offsetElement = shouldReplace ? replacer : boundElement, previewElement = replacer.find(".sp-preview-inner"), initialColor = opts.color || isInput && boundElement.val(), colorOnShow = false, currentPreferredFormat = opts.preferredFormat, clickoutFiresChange = !opts.showButtons || opts.clickoutFiresChange, isEmpty = !initialColor, allowEmpty = opts.allowEmpty && !isInputTypeColor;
    function applyOptions() {
      if (opts.showPaletteOnly) {
        opts.showPalette = true;
      }
      toggleButton.text(opts.showPaletteOnly ? opts.togglePaletteMoreText : opts.togglePaletteLessText);
      if (opts.palette) {
        palette = opts.palette.slice(0);
        paletteArray = $.isArray(palette[0]) ? palette : [palette];
        paletteLookup = {};
        for (var i = 0; i < paletteArray.length; i++) {
          for (var j = 0; j < paletteArray[i].length; j++) {
            var rgb = tinycolor(paletteArray[i][j]).toRgbString();
            paletteLookup[rgb] = true;
          }
        }
      }
      container.toggleClass("sp-flat", flat);
      container.toggleClass("sp-input-disabled", !opts.showInput);
      container.toggleClass("sp-alpha-enabled", opts.showAlpha);
      container.toggleClass("sp-clear-enabled", allowEmpty);
      container.toggleClass("sp-buttons-disabled", !opts.showButtons);
      container.toggleClass("sp-palette-buttons-disabled", !opts.togglePaletteOnly);
      container.toggleClass("sp-palette-disabled", !opts.showPalette);
      container.toggleClass("sp-palette-only", opts.showPaletteOnly);
      container.toggleClass("sp-initial-disabled", !opts.showInitial);
      container.addClass(opts.className).addClass(opts.containerClassName);
      reflow();
    }
    function initialize() {
      if (IE) {
        container.find("*:not(input)").attr("unselectable", "on");
      }
      applyOptions();
      if (shouldReplace) {
        boundElement.after(replacer).hide();
      }
      if (!allowEmpty) {
        clearButton.hide();
      }
      if (flat) {
        boundElement.after(container).hide();
      } else {
        var appendTo = opts.appendTo === "parent" ? boundElement.parent() : $(opts.appendTo);
        if (appendTo.length !== 1) {
          appendTo = $("body");
        }
        appendTo.append(container);
      }
      updateSelectionPaletteFromStorage();
      offsetElement.bind("click.spectrum touchstart.spectrum", function(e) {
        if (!disabled) {
          toggle();
        }
        e.stopPropagation();
        if (!$(e.target).is("input")) {
          e.preventDefault();
        }
      });
      if (boundElement.is(":disabled") || opts.disabled === true) {
        disable();
      }
      container.click(stopPropagation);
      textInput.change(setFromTextInput);
      textInput.bind("paste", function() {
        setTimeout(setFromTextInput, 1);
      });
      textInput.keydown(function(e) {
        if (e.keyCode == 13) {
          setFromTextInput();
        }
      });
      cancelButton.text(opts.cancelText);
      cancelButton.bind("click.spectrum", function(e) {
        e.stopPropagation();
        e.preventDefault();
        revert();
        hide();
      });
      clearButton.attr("title", opts.clearText);
      clearButton.bind("click.spectrum", function(e) {
        e.stopPropagation();
        e.preventDefault();
        isEmpty = true;
        move();
        if (flat) {
          updateOriginalInput(true);
        }
      });
      chooseButton.text(opts.chooseText);
      chooseButton.bind("click.spectrum", function(e) {
        e.stopPropagation();
        e.preventDefault();
        if (IE && textInput.is(":focus")) {
          textInput.trigger("change");
        }
        if (isValid()) {
          updateOriginalInput(true);
          hide();
        }
      });
      toggleButton.text(opts.showPaletteOnly ? opts.togglePaletteMoreText : opts.togglePaletteLessText);
      toggleButton.bind("click.spectrum", function(e) {
        e.stopPropagation();
        e.preventDefault();
        opts.showPaletteOnly = !opts.showPaletteOnly;
        if (!opts.showPaletteOnly && !flat) {
          container.css("left", "-=" + (pickerContainer.outerWidth(true) + 5));
        }
        applyOptions();
      });
      draggable(alphaSlider, function(dragX, dragY, e) {
        currentAlpha = dragX / alphaWidth;
        isEmpty = false;
        if (e.shiftKey) {
          currentAlpha = Math.round(currentAlpha * 10) / 10;
        }
        move();
      }, dragStart, dragStop);
      draggable(slider, function(dragX, dragY) {
        currentHue = parseFloat(dragY / slideHeight);
        isEmpty = false;
        if (!opts.showAlpha) {
          currentAlpha = 1;
        }
        move();
      }, dragStart, dragStop);
      draggable(dragger, function(dragX, dragY, e) {
        if (!e.shiftKey) {
          shiftMovementDirection = null;
        } else if (!shiftMovementDirection) {
          var oldDragX = currentSaturation * dragWidth;
          var oldDragY = dragHeight - currentValue * dragHeight;
          var furtherFromX = Math.abs(dragX - oldDragX) > Math.abs(dragY - oldDragY);
          shiftMovementDirection = furtherFromX ? "x" : "y";
        }
        var setSaturation = !shiftMovementDirection || shiftMovementDirection === "x";
        var setValue = !shiftMovementDirection || shiftMovementDirection === "y";
        if (setSaturation) {
          currentSaturation = parseFloat(dragX / dragWidth);
        }
        if (setValue) {
          currentValue = parseFloat((dragHeight - dragY) / dragHeight);
        }
        isEmpty = false;
        if (!opts.showAlpha) {
          currentAlpha = 1;
        }
        move();
      }, dragStart, dragStop);
      if (!!initialColor) {
        set(initialColor);
        updateUI();
        currentPreferredFormat = opts.preferredFormat || tinycolor(initialColor).getFormat();
        addColorToSelectionPalette(initialColor);
      } else {
        updateUI();
      }
      if (flat) {
        show();
      }
      function paletteElementClick(e) {
        if (e.data && e.data.ignore) {
          set($(e.target).closest(".sp-thumb-el").data("color"));
          move();
        } else {
          set($(e.target).closest(".sp-thumb-el").data("color"));
          move();
          if (opts.hideAfterPaletteSelect) {
            updateOriginalInput(true);
            hide();
          }
        }
        return false;
      }
      var paletteEvent = IE ? "mousedown.spectrum" : "click.spectrum touchstart.spectrum";
      paletteContainer.delegate(".sp-thumb-el", paletteEvent, paletteElementClick);
      initialColorContainer.delegate(".sp-thumb-el:nth-child(1)", paletteEvent, { ignore: true }, paletteElementClick);
    }
    function updateSelectionPaletteFromStorage() {
      if (localStorageKey && window.localStorage) {
        try {
          var oldPalette = window.localStorage[localStorageKey].split(",#");
          if (oldPalette.length > 1) {
            delete window.localStorage[localStorageKey];
            $.each(oldPalette, function(i, c) {
              addColorToSelectionPalette(c);
            });
          }
        } catch (e) {
        }
        try {
          selectionPalette = window.localStorage[localStorageKey].split(";");
        } catch (e) {
        }
      }
    }
    function addColorToSelectionPalette(color) {
      if (showSelectionPalette) {
        var rgb = tinycolor(color).toRgbString();
        if (!paletteLookup[rgb] && $.inArray(rgb, selectionPalette) === -1) {
          selectionPalette.push(rgb);
          while (selectionPalette.length > maxSelectionSize) {
            selectionPalette.shift();
          }
        }
        if (localStorageKey && window.localStorage) {
          try {
            window.localStorage[localStorageKey] = selectionPalette.join(";");
          } catch (e) {
          }
        }
      }
    }
    function getUniqueSelectionPalette() {
      var unique = [];
      if (opts.showPalette) {
        for (var i = 0; i < selectionPalette.length; i++) {
          var rgb = tinycolor(selectionPalette[i]).toRgbString();
          if (!paletteLookup[rgb]) {
            unique.push(selectionPalette[i]);
          }
        }
      }
      return unique.reverse().slice(0, opts.maxSelectionSize);
    }
    function drawPalette() {
      var currentColor = get();
      var html2 = $.map(paletteArray, function(palette2, i) {
        return paletteTemplate(palette2, currentColor, "sp-palette-row sp-palette-row-" + i, opts);
      });
      updateSelectionPaletteFromStorage();
      if (selectionPalette) {
        html2.push(paletteTemplate(getUniqueSelectionPalette(), currentColor, "sp-palette-row sp-palette-row-selection", opts));
      }
      paletteContainer.html(html2.join(""));
    }
    function drawInitial() {
      if (opts.showInitial) {
        var initial = colorOnShow;
        var current = get();
        initialColorContainer.html(paletteTemplate([initial, current], current, "sp-palette-row-initial", opts));
      }
    }
    function dragStart() {
      if (dragHeight <= 0 || dragWidth <= 0 || slideHeight <= 0) {
        reflow();
      }
      isDragging = true;
      container.addClass(draggingClass);
      shiftMovementDirection = null;
      boundElement.trigger("dragstart.spectrum", [get()]);
    }
    function dragStop() {
      isDragging = false;
      container.removeClass(draggingClass);
      boundElement.trigger("dragstop.spectrum", [get()]);
    }
    function setFromTextInput() {
      var value = textInput.val();
      if ((value === null || value === "") && allowEmpty) {
        set(null);
        updateOriginalInput(true);
      } else {
        var tiny = tinycolor(value);
        if (tiny.isValid()) {
          set(tiny);
          updateOriginalInput(true);
        } else {
          textInput.addClass("sp-validation-error");
        }
      }
    }
    function toggle() {
      if (visible) {
        hide();
      } else {
        show();
      }
    }
    function show() {
      var event = $.Event("beforeShow.spectrum");
      if (visible) {
        reflow();
        return;
      }
      boundElement.trigger("beforeShow.spectrum", [get()]);
      if (callbacks.beforeShow(get()) === false || event.isDefaultPrevented()) {
        return;
      }
      hideAll();
      visible = true;
      var $doc = $(doc);
      $doc.bind("keydown.spectrum", onkeydown);
      $doc.bind("click.spectrum", clickout);
      $(window).bind("resize.spectrum", resize);
      replacer.addClass("sp-active");
      container.removeClass("sp-hidden");
      reflow();
      updateUI();
      colorOnShow = get();
      drawInitial();
      callbacks.show(colorOnShow);
      boundElement.trigger("show.spectrum", [colorOnShow]);
    }
    function onkeydown(e) {
      if (e.keyCode === 27) {
        hide();
      }
    }
    function clickout(e) {
      if (e.button == 2) {
        return;
      }
      if (isDragging) {
        return;
      }
      if (clickoutFiresChange) {
        updateOriginalInput(true);
      } else {
        revert();
      }
      hide();
    }
    function hide() {
      if (!visible || flat) {
        return;
      }
      visible = false;
      $(doc).unbind("keydown.spectrum", onkeydown);
      $(doc).unbind("click.spectrum", clickout);
      $(window).unbind("resize.spectrum", resize);
      replacer.removeClass("sp-active");
      container.addClass("sp-hidden");
      callbacks.hide(get());
      boundElement.trigger("hide.spectrum", [get()]);
    }
    function revert() {
      set(colorOnShow, true);
    }
    function set(color, ignoreFormatChange) {
      if (tinycolor.equals(color, get())) {
        updateUI();
        return;
      }
      var newColor, newHsv;
      if (!color && allowEmpty) {
        isEmpty = true;
      } else {
        isEmpty = false;
        isDefault = !color;
        newColor = tinycolor(color);
        newHsv = newColor.toHsv();
        currentHue = newHsv.h % 360 / 360;
        currentSaturation = newHsv.s;
        currentValue = newHsv.v;
        currentAlpha = newHsv.a;
      }
      updateUI();
      if (newColor && newColor.isValid() && !ignoreFormatChange) {
        currentPreferredFormat = opts.preferredFormat || newColor.getFormat();
      }
    }
    function get(opts2) {
      opts2 = opts2 || {};
      if (allowEmpty && isEmpty) {
        return null;
      }
      return tinycolor.fromRatio({
        h: currentHue,
        s: currentSaturation,
        v: currentValue,
        a: Math.round(currentAlpha * 100) / 100
      }, { format: opts2.format || currentPreferredFormat });
    }
    function isValid() {
      return !textInput.hasClass("sp-validation-error");
    }
    function move() {
      updateUI();
      callbacks.move(get());
      boundElement.trigger("move.spectrum", [get()]);
    }
    function updateUI() {
      textInput.removeClass("sp-validation-error");
      updateHelperLocations();
      var flatColor = tinycolor.fromRatio({ h: currentHue, s: 1, v: 1 });
      dragger.css("background-color", flatColor.toHexString());
      var format = currentPreferredFormat;
      if (currentAlpha < 1 && !(currentAlpha === 0 && format === "name")) {
        if (format === "hex" || format === "hex3" || format === "hex6" || format === "name") {
          format = "rgb";
        }
      }
      var realColor = get({ format }), displayColor = "";
      previewElement.removeClass("sp-clear-display");
      previewElement.css("background-color", "transparent");
      if (!realColor && allowEmpty) {
        previewElement.addClass("sp-clear-display");
      } else {
        var realHex = realColor.toHexString(), realRgb = realColor.toRgbString();
        if (rgbaSupport || realColor.alpha === 1) {
          previewElement.css("background-color", realRgb);
        } else {
          previewElement.css("background-color", "transparent");
          previewElement.css("filter", realColor.toFilter());
        }
        if (opts.showAlpha) {
          var rgb = realColor.toRgb();
          rgb.a = 0;
          var realAlpha = tinycolor(rgb).toRgbString();
          var gradient = "linear-gradient(left, " + realAlpha + ", " + realHex + ")";
          if (IE) {
            alphaSliderInner.css("filter", tinycolor(realAlpha).toFilter({ gradientType: 1 }, realHex));
          } else {
            alphaSliderInner.css("background", "-webkit-" + gradient);
            alphaSliderInner.css("background", "-moz-" + gradient);
            alphaSliderInner.css("background", "-ms-" + gradient);
            alphaSliderInner.css("background", "linear-gradient(to right, " + realAlpha + ", " + realHex + ")");
          }
        }
        displayColor = realColor.toString(format);
      }
      if (opts.showInput) {
        textInput.val(displayColor);
      }
      if (opts.showPalette) {
        drawPalette();
      }
      drawInitial();
    }
    function updateHelperLocations() {
      var s = currentSaturation;
      var v = currentValue;
      if (allowEmpty && isEmpty) {
        alphaSlideHelper.hide();
        slideHelper.hide();
        dragHelper.hide();
      } else {
        alphaSlideHelper.show();
        slideHelper.show();
        dragHelper.show();
        var dragX = s * dragWidth;
        var dragY = dragHeight - v * dragHeight;
        dragX = Math.max(-dragHelperHeight, Math.min(dragWidth - dragHelperHeight, dragX - dragHelperHeight));
        dragY = Math.max(-dragHelperHeight, Math.min(dragHeight - dragHelperHeight, dragY - dragHelperHeight));
        dragHelper.css({
          top: dragY + "px",
          left: dragX + "px"
        });
        var alphaX = currentAlpha * alphaWidth;
        alphaSlideHelper.css({
          left: alphaX - alphaSlideHelperWidth / 2 + "px"
        });
        var slideY = currentHue * slideHeight;
        slideHelper.css({
          top: slideY - slideHelperHeight + "px"
        });
      }
    }
    function updateOriginalInput(fireCallback) {
      var color = get(), displayColor = "", hasChanged = isDefault ? true : !tinycolor.equals(color, colorOnShow);
      if (color) {
        displayColor = color.toString(currentPreferredFormat);
        !visible && addColorToSelectionPalette(color);
      }
      if (isInput) {
        boundElement.val(displayColor);
      }
      if (fireCallback && hasChanged) {
        callbacks.change(color);
        boundElement.trigger("change", [color]);
      }
    }
    function reflow() {
      if (!visible) {
        return;
      }
      dragWidth = dragger.width();
      dragHeight = dragger.height();
      dragHelperHeight = dragHelper.height();
      slideWidth = slider.width();
      slideHeight = slider.height();
      slideHelperHeight = slideHelper.height();
      alphaWidth = alphaSlider.width();
      alphaSlideHelperWidth = alphaSlideHelper.width();
      if (!flat) {
        container.css("position", "absolute");
        if (opts.offset) {
          container.offset(opts.offset);
        } else {
          container.offset(getOffset(container, offsetElement));
        }
      }
      updateHelperLocations();
      if (opts.showPalette) {
        drawPalette();
      }
      boundElement.trigger("reflow.spectrum");
    }
    function destroy() {
      boundElement.show();
      offsetElement.unbind("click.spectrum touchstart.spectrum");
      container.remove();
      replacer.remove();
      spectrums[spect.id] = null;
    }
    function option(optionName, optionValue) {
      if (optionName === undefined2) {
        return $.extend({}, opts);
      }
      if (optionValue === undefined2) {
        return opts[optionName];
      }
      opts[optionName] = optionValue;
      if (optionName === "preferredFormat") {
        currentPreferredFormat = opts.preferredFormat;
      }
      applyOptions();
    }
    function enable() {
      disabled = false;
      boundElement.attr("disabled", false);
      offsetElement.removeClass("sp-disabled");
    }
    function disable() {
      hide();
      disabled = true;
      boundElement.attr("disabled", true);
      offsetElement.addClass("sp-disabled");
    }
    function setOffset(coord) {
      opts.offset = coord;
      reflow();
    }
    initialize();
    var spect = {
      show,
      hide,
      toggle,
      reflow,
      option,
      enable,
      disable,
      offset: setOffset,
      set: function(c) {
        set(c);
        updateOriginalInput();
      },
      get,
      destroy,
      container
    };
    spect.id = spectrums.push(spect) - 1;
    return spect;
  }
  function getOffset(picker, input) {
    var offsetElm = input[0];
    var pickerEl = picker[0];
    var rootElm = pickerEl.parentElement;
    var inputRect = offsetElm.getBoundingClientRect();
    var pickerW = pickerEl.offsetWidth;
    var pickerH = pickerEl.offsetHeight;
    var offset = {
      top: 0,
      left: 0,
      width: offsetElm.offsetWidth,
      height: offsetElm.offsetHeight
    };
    while (offsetElm) {
      offset.top += offsetElm.offsetTop - offsetElm.scrollTop;
      offset.left += offsetElm.offsetLeft - offsetElm.scrollLeft;
      if (offsetElm === rootElm || !rootElm.contains(offsetElm.offsetParent)) {
        break;
      }
      offsetElm = offsetElm.offsetParent;
    }
    if (inputRect.right + pickerW > window.innerWidth - window.scrollX && inputRect.right - pickerW > 0) {
      offset.left -= pickerW - offset.width;
    }
    if (inputRect.bottom + pickerH < window.innerHeight - window.scrollY) {
      offset.top += offset.height;
    } else {
      offset.top -= pickerH;
    }
    return offset;
  }
  function noop2() {
  }
  function stopPropagation(e) {
    e.stopPropagation();
  }
  function bind2(func, obj) {
    var slice = Array.prototype.slice;
    var args = slice.call(arguments, 2);
    return function() {
      return func.apply(obj, args.concat(slice.call(arguments)));
    };
  }
  function draggable(element, onmove, onstart, onstop) {
    onmove = onmove || function() {
    };
    onstart = onstart || function() {
    };
    onstop = onstop || function() {
    };
    var doc = document;
    var dragging = false;
    var offset = {};
    var maxHeight = 0;
    var maxWidth = 0;
    var hasTouch = "ontouchstart" in window;
    var duringDragEvents = {};
    duringDragEvents["selectstart"] = prevent;
    duringDragEvents["dragstart"] = prevent;
    duringDragEvents["touchmove mousemove"] = move;
    duringDragEvents["touchend mouseup"] = stop;
    function prevent(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.returnValue = false;
    }
    function move(e) {
      if (dragging) {
        if (IE && doc.documentMode < 9 && !e.button) {
          return stop();
        }
        var t0 = e && e.touches && e.touches[0];
        var pageX = t0 && t0.pageX || e.pageX;
        var pageY = t0 && t0.pageY || e.pageY;
        var dragX = Math.max(0, Math.min(pageX - offset.left, maxWidth));
        var dragY = Math.max(0, Math.min(pageY - offset.top, maxHeight));
        if (hasTouch) {
          prevent(e);
        }
        onmove.apply(element, [dragX, dragY, e]);
      }
    }
    function start(e) {
      var rightclick = e.which ? e.which == 3 : e.button == 2;
      if (!rightclick && !dragging) {
        if (onstart.apply(element, arguments) !== false) {
          dragging = true;
          maxHeight = $(element).height();
          maxWidth = $(element).width();
          offset = $(element).offset();
          $(doc).bind(duringDragEvents);
          $(doc.body).addClass("sp-dragging");
          move(e);
          prevent(e);
        }
      }
    }
    function stop() {
      if (dragging) {
        $(doc).unbind(duringDragEvents);
        $(doc.body).removeClass("sp-dragging");
        setTimeout(function() {
          onstop.apply(element, arguments);
        }, 0);
      }
      dragging = false;
    }
    $(element).bind("touchstart mousedown", start);
  }
  function throttle(func, wait, debounce) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      var throttler = function() {
        timeout = null;
        func.apply(context, args);
      };
      if (debounce)
        clearTimeout(timeout);
      if (debounce || !timeout)
        timeout = setTimeout(throttler, wait);
    };
  }
  function inputTypeColorSupport() {
    return $.fn.spectrum.inputTypeColorSupport();
  }
  var dataID = "spectrum.id";
  $.fn.spectrum = function(opts, extra) {
    if (typeof opts == "string") {
      var returnValue = this;
      var args = Array.prototype.slice.call(arguments, 1);
      this.each(function() {
        var spect = spectrums[$(this).data(dataID)];
        if (spect) {
          var method = spect[opts];
          if (!method) {
            throw new Error("Spectrum: no such method: '" + opts + "'");
          }
          if (opts == "get") {
            returnValue = spect.get();
          } else if (opts == "container") {
            returnValue = spect.container;
          } else if (opts == "option") {
            returnValue = spect.option.apply(spect, args);
          } else if (opts == "destroy") {
            spect.destroy();
            $(this).removeData(dataID);
          } else {
            method.apply(spect, args);
          }
        }
      });
      return returnValue;
    }
    return this.spectrum("destroy").each(function() {
      var options = $.extend({}, opts, $(this).data());
      var spect = spectrum(this, options);
      $(this).data(dataID, spect.id);
    });
  };
  $.fn.spectrum.load = true;
  $.fn.spectrum.loadOpts = {};
  $.fn.spectrum.draggable = draggable;
  $.fn.spectrum.defaults = defaultOpts;
  $.fn.spectrum.inputTypeColorSupport = function inputTypeColorSupport2() {
    if (typeof inputTypeColorSupport2._cachedResult === "undefined") {
      var colorInput = $("<input type='color'/>")[0];
      inputTypeColorSupport2._cachedResult = colorInput.type === "color" && colorInput.value !== "";
    }
    return inputTypeColorSupport2._cachedResult;
  };
  $.spectrum = {};
  $.spectrum.localization = {};
  $.spectrum.palettes = {};
  $.fn.spectrum.processNativeColorInputs = function() {
    var colorInputs = $("input[type=color]");
    if (colorInputs.length && !inputTypeColorSupport()) {
      colorInputs.spectrum({
        preferredFormat: "hex6"
      });
    }
  };
  var trimLeft = /^[\s,#]+/, trimRight = /\s+$/, tinyCounter = 0, math = Math, mathRound = math.round, mathMin = math.min, mathMax = math.max, mathRandom = math.random;
  var tinycolor = function(color, opts) {
    color = color ? color : "";
    opts = opts || {};
    if (color instanceof tinycolor) {
      return color;
    }
    if (!(this instanceof tinycolor)) {
      return new tinycolor(color, opts);
    }
    var rgb = inputToRGB(color);
    this._originalInput = color, this._r = rgb.r, this._g = rgb.g, this._b = rgb.b, this._a = rgb.a, this._roundA = mathRound(100 * this._a) / 100, this._format = opts.format || rgb.format;
    this._gradientType = opts.gradientType;
    if (this._r < 1) {
      this._r = mathRound(this._r);
    }
    if (this._g < 1) {
      this._g = mathRound(this._g);
    }
    if (this._b < 1) {
      this._b = mathRound(this._b);
    }
    this._ok = rgb.ok;
    this._tc_id = tinyCounter++;
  };
  tinycolor.prototype = {
    isDark: function() {
      return this.getBrightness() < 128;
    },
    isLight: function() {
      return !this.isDark();
    },
    isValid: function() {
      return this._ok;
    },
    getOriginalInput: function() {
      return this._originalInput;
    },
    getFormat: function() {
      return this._format;
    },
    getAlpha: function() {
      return this._a;
    },
    getBrightness: function() {
      var rgb = this.toRgb();
      return (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1e3;
    },
    setAlpha: function(value) {
      this._a = boundAlpha(value);
      this._roundA = mathRound(100 * this._a) / 100;
      return this;
    },
    toHsv: function() {
      var hsv = rgbToHsv(this._r, this._g, this._b);
      return { h: hsv.h * 360, s: hsv.s, v: hsv.v, a: this._a };
    },
    toHsvString: function() {
      var hsv = rgbToHsv(this._r, this._g, this._b);
      var h = mathRound(hsv.h * 360), s = mathRound(hsv.s * 100), v = mathRound(hsv.v * 100);
      return this._a == 1 ? "hsv(" + h + ", " + s + "%, " + v + "%)" : "hsva(" + h + ", " + s + "%, " + v + "%, " + this._roundA + ")";
    },
    toHsl: function() {
      var hsl = rgbToHsl(this._r, this._g, this._b);
      return { h: hsl.h * 360, s: hsl.s, l: hsl.l, a: this._a };
    },
    toHslString: function() {
      var hsl = rgbToHsl(this._r, this._g, this._b);
      var h = mathRound(hsl.h * 360), s = mathRound(hsl.s * 100), l = mathRound(hsl.l * 100);
      return this._a == 1 ? "hsl(" + h + ", " + s + "%, " + l + "%)" : "hsla(" + h + ", " + s + "%, " + l + "%, " + this._roundA + ")";
    },
    toHex: function(allow3Char) {
      return rgbToHex(this._r, this._g, this._b, allow3Char);
    },
    toHexString: function(allow3Char) {
      return "#" + this.toHex(allow3Char);
    },
    toHex8: function() {
      return rgbaToHex(this._r, this._g, this._b, this._a);
    },
    toHex8String: function() {
      return "#" + this.toHex8();
    },
    toRgb: function() {
      return {
        r: mathRound(this._r),
        g: mathRound(this._g),
        b: mathRound(this._b),
        a: this._a
      };
    },
    toRgbString: function() {
      return this._a == 1 ? "rgb(" + mathRound(this._r) + ", " + mathRound(this._g) + ", " + mathRound(this._b) + ")" : "rgba(" + mathRound(this._r) + ", " + mathRound(this._g) + ", " + mathRound(this._b) + ", " + this._roundA + ")";
    },
    toPercentageRgb: function() {
      return {
        r: mathRound(bound01(this._r, 255) * 100) + "%",
        g: mathRound(bound01(this._g, 255) * 100) + "%",
        b: mathRound(bound01(this._b, 255) * 100) + "%",
        a: this._a
      };
    },
    toPercentageRgbString: function() {
      return this._a == 1 ? "rgb(" + mathRound(bound01(this._r, 255) * 100) + "%, " + mathRound(bound01(this._g, 255) * 100) + "%, " + mathRound(bound01(this._b, 255) * 100) + "%)" : "rgba(" + mathRound(bound01(this._r, 255) * 100) + "%, " + mathRound(bound01(this._g, 255) * 100) + "%, " + mathRound(bound01(this._b, 255) * 100) + "%, " + this._roundA + ")";
    },
    toName: function() {
      if (this._a === 0) {
        return "transparent";
      }
      if (this._a < 1) {
        return false;
      }
      return hexNames[rgbToHex(this._r, this._g, this._b, true)] || false;
    },
    toFilter: function(secondColor) {
      var hex8String = "#" + rgbaToHex(this._r, this._g, this._b, this._a);
      var secondHex8String = hex8String;
      var gradientType = this._gradientType ? "GradientType = 1, " : "";
      if (secondColor) {
        var s = tinycolor(secondColor);
        secondHex8String = s.toHex8String();
      }
      return "progid:DXImageTransform.Microsoft.gradient(" + gradientType + "startColorstr=" + hex8String + ",endColorstr=" + secondHex8String + ")";
    },
    toString: function(format) {
      var formatSet = !!format;
      format = format || this._format;
      var formattedString = false;
      var hasAlpha = this._a < 1 && this._a >= 0;
      var needsAlphaFormat = !formatSet && hasAlpha && (format === "hex" || format === "hex6" || format === "hex3" || format === "name");
      if (needsAlphaFormat) {
        if (format === "name" && this._a === 0) {
          return this.toName();
        }
        return this.toRgbString();
      }
      if (format === "rgb") {
        formattedString = this.toRgbString();
      }
      if (format === "prgb") {
        formattedString = this.toPercentageRgbString();
      }
      if (format === "hex" || format === "hex6") {
        formattedString = this.toHexString();
      }
      if (format === "hex3") {
        formattedString = this.toHexString(true);
      }
      if (format === "hex8") {
        formattedString = this.toHex8String();
      }
      if (format === "name") {
        formattedString = this.toName();
      }
      if (format === "hsl") {
        formattedString = this.toHslString();
      }
      if (format === "hsv") {
        formattedString = this.toHsvString();
      }
      return formattedString || this.toHexString();
    },
    _applyModification: function(fn, args) {
      var color = fn.apply(null, [this].concat([].slice.call(args)));
      this._r = color._r;
      this._g = color._g;
      this._b = color._b;
      this.setAlpha(color._a);
      return this;
    },
    lighten: function() {
      return this._applyModification(lighten, arguments);
    },
    brighten: function() {
      return this._applyModification(brighten, arguments);
    },
    darken: function() {
      return this._applyModification(darken, arguments);
    },
    desaturate: function() {
      return this._applyModification(desaturate, arguments);
    },
    saturate: function() {
      return this._applyModification(saturate, arguments);
    },
    greyscale: function() {
      return this._applyModification(greyscale, arguments);
    },
    spin: function() {
      return this._applyModification(spin, arguments);
    },
    _applyCombination: function(fn, args) {
      return fn.apply(null, [this].concat([].slice.call(args)));
    },
    analogous: function() {
      return this._applyCombination(analogous, arguments);
    },
    complement: function() {
      return this._applyCombination(complement, arguments);
    },
    monochromatic: function() {
      return this._applyCombination(monochromatic, arguments);
    },
    splitcomplement: function() {
      return this._applyCombination(splitcomplement, arguments);
    },
    triad: function() {
      return this._applyCombination(triad, arguments);
    },
    tetrad: function() {
      return this._applyCombination(tetrad, arguments);
    }
  };
  tinycolor.fromRatio = function(color, opts) {
    if (typeof color == "object") {
      var newColor = {};
      for (var i in color) {
        if (color.hasOwnProperty(i)) {
          if (i === "a") {
            newColor[i] = color[i];
          } else {
            newColor[i] = convertToPercentage(color[i]);
          }
        }
      }
      color = newColor;
    }
    return tinycolor(color, opts);
  };
  function inputToRGB(color) {
    var rgb = { r: 0, g: 0, b: 0 };
    var a = 1;
    var ok = false;
    var format = false;
    if (typeof color == "string") {
      color = stringInputToObject(color);
    }
    if (typeof color == "object") {
      if (color.hasOwnProperty("r") && color.hasOwnProperty("g") && color.hasOwnProperty("b")) {
        rgb = rgbToRgb(color.r, color.g, color.b);
        ok = true;
        format = String(color.r).substr(-1) === "%" ? "prgb" : "rgb";
      } else if (color.hasOwnProperty("h") && color.hasOwnProperty("s") && color.hasOwnProperty("v")) {
        color.s = convertToPercentage(color.s);
        color.v = convertToPercentage(color.v);
        rgb = hsvToRgb(color.h, color.s, color.v);
        ok = true;
        format = "hsv";
      } else if (color.hasOwnProperty("h") && color.hasOwnProperty("s") && color.hasOwnProperty("l")) {
        color.s = convertToPercentage(color.s);
        color.l = convertToPercentage(color.l);
        rgb = hslToRgb(color.h, color.s, color.l);
        ok = true;
        format = "hsl";
      }
      if (color.hasOwnProperty("a")) {
        a = color.a;
      }
    }
    a = boundAlpha(a);
    return {
      ok,
      format: color.format || format,
      r: mathMin(255, mathMax(rgb.r, 0)),
      g: mathMin(255, mathMax(rgb.g, 0)),
      b: mathMin(255, mathMax(rgb.b, 0)),
      a
    };
  }
  function rgbToRgb(r, g, b) {
    return {
      r: bound01(r, 255) * 255,
      g: bound01(g, 255) * 255,
      b: bound01(b, 255) * 255
    };
  }
  function rgbToHsl(r, g, b) {
    r = bound01(r, 255);
    g = bound01(g, 255);
    b = bound01(b, 255);
    var max = mathMax(r, g, b), min = mathMin(r, g, b);
    var h, s, l = (max + min) / 2;
    if (max == min) {
      h = s = 0;
    } else {
      var d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r:
          h = (g - b) / d + (g < b ? 6 : 0);
          break;
        case g:
          h = (b - r) / d + 2;
          break;
        case b:
          h = (r - g) / d + 4;
          break;
      }
      h /= 6;
    }
    return { h, s, l };
  }
  function hslToRgb(h, s, l) {
    var r, g, b;
    h = bound01(h, 360);
    s = bound01(s, 100);
    l = bound01(l, 100);
    function hue2rgb(p2, q2, t) {
      if (t < 0)
        t += 1;
      if (t > 1)
        t -= 1;
      if (t < 1 / 6)
        return p2 + (q2 - p2) * 6 * t;
      if (t < 1 / 2)
        return q2;
      if (t < 2 / 3)
        return p2 + (q2 - p2) * (2 / 3 - t) * 6;
      return p2;
    }
    if (s === 0) {
      r = g = b = l;
    } else {
      var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      var p = 2 * l - q;
      r = hue2rgb(p, q, h + 1 / 3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1 / 3);
    }
    return { r: r * 255, g: g * 255, b: b * 255 };
  }
  function rgbToHsv(r, g, b) {
    r = bound01(r, 255);
    g = bound01(g, 255);
    b = bound01(b, 255);
    var max = mathMax(r, g, b), min = mathMin(r, g, b);
    var h, s, v = max;
    var d = max - min;
    s = max === 0 ? 0 : d / max;
    if (max == min) {
      h = 0;
    } else {
      switch (max) {
        case r:
          h = (g - b) / d + (g < b ? 6 : 0);
          break;
        case g:
          h = (b - r) / d + 2;
          break;
        case b:
          h = (r - g) / d + 4;
          break;
      }
      h /= 6;
    }
    return { h, s, v };
  }
  function hsvToRgb(h, s, v) {
    h = bound01(h, 360) * 6;
    s = bound01(s, 100);
    v = bound01(v, 100);
    var i = math.floor(h), f = h - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s), mod = i % 6, r = [v, q, p, p, t, v][mod], g = [t, v, v, q, p, p][mod], b = [p, p, t, v, v, q][mod];
    return { r: r * 255, g: g * 255, b: b * 255 };
  }
  function rgbToHex(r, g, b, allow3Char) {
    var hex = [pad2(mathRound(r).toString(16)), pad2(mathRound(g).toString(16)), pad2(mathRound(b).toString(16))];
    if (allow3Char && hex[0].charAt(0) == hex[0].charAt(1) && hex[1].charAt(0) == hex[1].charAt(1) && hex[2].charAt(0) == hex[2].charAt(1)) {
      return hex[0].charAt(0) + hex[1].charAt(0) + hex[2].charAt(0);
    }
    return hex.join("");
  }
  function rgbaToHex(r, g, b, a) {
    var hex = [
      pad2(convertDecimalToHex(a)),
      pad2(mathRound(r).toString(16)),
      pad2(mathRound(g).toString(16)),
      pad2(mathRound(b).toString(16))
    ];
    return hex.join("");
  }
  tinycolor.equals = function(color1, color2) {
    if (!color1 || !color2) {
      return false;
    }
    return tinycolor(color1).toRgbString() == tinycolor(color2).toRgbString();
  };
  tinycolor.random = function() {
    return tinycolor.fromRatio({
      r: mathRandom(),
      g: mathRandom(),
      b: mathRandom()
    });
  };
  function desaturate(color, amount) {
    amount = amount === 0 ? 0 : amount || 10;
    var hsl = tinycolor(color).toHsl();
    hsl.s -= amount / 100;
    hsl.s = clamp01(hsl.s);
    return tinycolor(hsl);
  }
  function saturate(color, amount) {
    amount = amount === 0 ? 0 : amount || 10;
    var hsl = tinycolor(color).toHsl();
    hsl.s += amount / 100;
    hsl.s = clamp01(hsl.s);
    return tinycolor(hsl);
  }
  function greyscale(color) {
    return tinycolor(color).desaturate(100);
  }
  function lighten(color, amount) {
    amount = amount === 0 ? 0 : amount || 10;
    var hsl = tinycolor(color).toHsl();
    hsl.l += amount / 100;
    hsl.l = clamp01(hsl.l);
    return tinycolor(hsl);
  }
  function brighten(color, amount) {
    amount = amount === 0 ? 0 : amount || 10;
    var rgb = tinycolor(color).toRgb();
    rgb.r = mathMax(0, mathMin(255, rgb.r - mathRound(255 * -(amount / 100))));
    rgb.g = mathMax(0, mathMin(255, rgb.g - mathRound(255 * -(amount / 100))));
    rgb.b = mathMax(0, mathMin(255, rgb.b - mathRound(255 * -(amount / 100))));
    return tinycolor(rgb);
  }
  function darken(color, amount) {
    amount = amount === 0 ? 0 : amount || 10;
    var hsl = tinycolor(color).toHsl();
    hsl.l -= amount / 100;
    hsl.l = clamp01(hsl.l);
    return tinycolor(hsl);
  }
  function spin(color, amount) {
    var hsl = tinycolor(color).toHsl();
    var hue = (mathRound(hsl.h) + amount) % 360;
    hsl.h = hue < 0 ? 360 + hue : hue;
    return tinycolor(hsl);
  }
  function complement(color) {
    var hsl = tinycolor(color).toHsl();
    hsl.h = (hsl.h + 180) % 360;
    return tinycolor(hsl);
  }
  function triad(color) {
    var hsl = tinycolor(color).toHsl();
    var h = hsl.h;
    return [
      tinycolor(color),
      tinycolor({ h: (h + 120) % 360, s: hsl.s, l: hsl.l }),
      tinycolor({ h: (h + 240) % 360, s: hsl.s, l: hsl.l })
    ];
  }
  function tetrad(color) {
    var hsl = tinycolor(color).toHsl();
    var h = hsl.h;
    return [
      tinycolor(color),
      tinycolor({ h: (h + 90) % 360, s: hsl.s, l: hsl.l }),
      tinycolor({ h: (h + 180) % 360, s: hsl.s, l: hsl.l }),
      tinycolor({ h: (h + 270) % 360, s: hsl.s, l: hsl.l })
    ];
  }
  function splitcomplement(color) {
    var hsl = tinycolor(color).toHsl();
    var h = hsl.h;
    return [
      tinycolor(color),
      tinycolor({ h: (h + 72) % 360, s: hsl.s, l: hsl.l }),
      tinycolor({ h: (h + 216) % 360, s: hsl.s, l: hsl.l })
    ];
  }
  function analogous(color, results, slices) {
    results = results || 6;
    slices = slices || 30;
    var hsl = tinycolor(color).toHsl();
    var part = 360 / slices;
    var ret = [tinycolor(color)];
    for (hsl.h = (hsl.h - (part * results >> 1) + 720) % 360; --results; ) {
      hsl.h = (hsl.h + part) % 360;
      ret.push(tinycolor(hsl));
    }
    return ret;
  }
  function monochromatic(color, results) {
    results = results || 6;
    var hsv = tinycolor(color).toHsv();
    var h = hsv.h, s = hsv.s, v = hsv.v;
    var ret = [];
    var modification = 1 / results;
    while (results--) {
      ret.push(tinycolor({ h, s, v }));
      v = (v + modification) % 1;
    }
    return ret;
  }
  tinycolor.mix = function(color1, color2, amount) {
    amount = amount === 0 ? 0 : amount || 50;
    var rgb1 = tinycolor(color1).toRgb();
    var rgb2 = tinycolor(color2).toRgb();
    var p = amount / 100;
    var w = p * 2 - 1;
    var a = rgb2.a - rgb1.a;
    var w1;
    if (w * a == -1) {
      w1 = w;
    } else {
      w1 = (w + a) / (1 + w * a);
    }
    w1 = (w1 + 1) / 2;
    var w2 = 1 - w1;
    var rgba = {
      r: rgb2.r * w1 + rgb1.r * w2,
      g: rgb2.g * w1 + rgb1.g * w2,
      b: rgb2.b * w1 + rgb1.b * w2,
      a: rgb2.a * p + rgb1.a * (1 - p)
    };
    return tinycolor(rgba);
  };
  tinycolor.readability = function(color1, color2) {
    var c1 = tinycolor(color1);
    var c2 = tinycolor(color2);
    var rgb1 = c1.toRgb();
    var rgb2 = c2.toRgb();
    var brightnessA = c1.getBrightness();
    var brightnessB = c2.getBrightness();
    var colorDiff = Math.max(rgb1.r, rgb2.r) - Math.min(rgb1.r, rgb2.r) + Math.max(rgb1.g, rgb2.g) - Math.min(rgb1.g, rgb2.g) + Math.max(rgb1.b, rgb2.b) - Math.min(rgb1.b, rgb2.b);
    return {
      brightness: Math.abs(brightnessA - brightnessB),
      color: colorDiff
    };
  };
  tinycolor.isReadable = function(color1, color2) {
    var readability = tinycolor.readability(color1, color2);
    return readability.brightness > 125 && readability.color > 500;
  };
  tinycolor.mostReadable = function(baseColor, colorList) {
    var bestColor = null;
    var bestScore = 0;
    var bestIsReadable = false;
    for (var i = 0; i < colorList.length; i++) {
      var readability = tinycolor.readability(baseColor, colorList[i]);
      var readable = readability.brightness > 125 && readability.color > 500;
      var score = 3 * (readability.brightness / 125) + readability.color / 500;
      if (readable && !bestIsReadable || readable && bestIsReadable && score > bestScore || !readable && !bestIsReadable && score > bestScore) {
        bestIsReadable = readable;
        bestScore = score;
        bestColor = tinycolor(colorList[i]);
      }
    }
    return bestColor;
  };
  var names = tinycolor.names = {
    aliceblue: "f0f8ff",
    antiquewhite: "faebd7",
    aqua: "0ff",
    aquamarine: "7fffd4",
    azure: "f0ffff",
    beige: "f5f5dc",
    bisque: "ffe4c4",
    black: "000",
    blanchedalmond: "ffebcd",
    blue: "00f",
    blueviolet: "8a2be2",
    brown: "a52a2a",
    burlywood: "deb887",
    burntsienna: "ea7e5d",
    cadetblue: "5f9ea0",
    chartreuse: "7fff00",
    chocolate: "d2691e",
    coral: "ff7f50",
    cornflowerblue: "6495ed",
    cornsilk: "fff8dc",
    crimson: "dc143c",
    cyan: "0ff",
    darkblue: "00008b",
    darkcyan: "008b8b",
    darkgoldenrod: "b8860b",
    darkgray: "a9a9a9",
    darkgreen: "006400",
    darkgrey: "a9a9a9",
    darkkhaki: "bdb76b",
    darkmagenta: "8b008b",
    darkolivegreen: "556b2f",
    darkorange: "ff8c00",
    darkorchid: "9932cc",
    darkred: "8b0000",
    darksalmon: "e9967a",
    darkseagreen: "8fbc8f",
    darkslateblue: "483d8b",
    darkslategray: "2f4f4f",
    darkslategrey: "2f4f4f",
    darkturquoise: "00ced1",
    darkviolet: "9400d3",
    deeppink: "ff1493",
    deepskyblue: "00bfff",
    dimgray: "696969",
    dimgrey: "696969",
    dodgerblue: "1e90ff",
    firebrick: "b22222",
    floralwhite: "fffaf0",
    forestgreen: "228b22",
    fuchsia: "f0f",
    gainsboro: "dcdcdc",
    ghostwhite: "f8f8ff",
    gold: "ffd700",
    goldenrod: "daa520",
    gray: "808080",
    green: "008000",
    greenyellow: "adff2f",
    grey: "808080",
    honeydew: "f0fff0",
    hotpink: "ff69b4",
    indianred: "cd5c5c",
    indigo: "4b0082",
    ivory: "fffff0",
    khaki: "f0e68c",
    lavender: "e6e6fa",
    lavenderblush: "fff0f5",
    lawngreen: "7cfc00",
    lemonchiffon: "fffacd",
    lightblue: "add8e6",
    lightcoral: "f08080",
    lightcyan: "e0ffff",
    lightgoldenrodyellow: "fafad2",
    lightgray: "d3d3d3",
    lightgreen: "90ee90",
    lightgrey: "d3d3d3",
    lightpink: "ffb6c1",
    lightsalmon: "ffa07a",
    lightseagreen: "20b2aa",
    lightskyblue: "87cefa",
    lightslategray: "789",
    lightslategrey: "789",
    lightsteelblue: "b0c4de",
    lightyellow: "ffffe0",
    lime: "0f0",
    limegreen: "32cd32",
    linen: "faf0e6",
    magenta: "f0f",
    maroon: "800000",
    mediumaquamarine: "66cdaa",
    mediumblue: "0000cd",
    mediumorchid: "ba55d3",
    mediumpurple: "9370db",
    mediumseagreen: "3cb371",
    mediumslateblue: "7b68ee",
    mediumspringgreen: "00fa9a",
    mediumturquoise: "48d1cc",
    mediumvioletred: "c71585",
    midnightblue: "191970",
    mintcream: "f5fffa",
    mistyrose: "ffe4e1",
    moccasin: "ffe4b5",
    navajowhite: "ffdead",
    navy: "000080",
    oldlace: "fdf5e6",
    olive: "808000",
    olivedrab: "6b8e23",
    orange: "ffa500",
    orangered: "ff4500",
    orchid: "da70d6",
    palegoldenrod: "eee8aa",
    palegreen: "98fb98",
    paleturquoise: "afeeee",
    palevioletred: "db7093",
    papayawhip: "ffefd5",
    peachpuff: "ffdab9",
    peru: "cd853f",
    pink: "ffc0cb",
    plum: "dda0dd",
    powderblue: "b0e0e6",
    purple: "800080",
    rebeccapurple: "663399",
    red: "f00",
    rosybrown: "bc8f8f",
    royalblue: "4169e1",
    saddlebrown: "8b4513",
    salmon: "fa8072",
    sandybrown: "f4a460",
    seagreen: "2e8b57",
    seashell: "fff5ee",
    sienna: "a0522d",
    silver: "c0c0c0",
    skyblue: "87ceeb",
    slateblue: "6a5acd",
    slategray: "708090",
    slategrey: "708090",
    snow: "fffafa",
    springgreen: "00ff7f",
    steelblue: "4682b4",
    tan: "d2b48c",
    teal: "008080",
    thistle: "d8bfd8",
    tomato: "ff6347",
    turquoise: "40e0d0",
    violet: "ee82ee",
    wheat: "f5deb3",
    white: "fff",
    whitesmoke: "f5f5f5",
    yellow: "ff0",
    yellowgreen: "9acd32"
  };
  var hexNames = tinycolor.hexNames = flip(names);
  function flip(o) {
    var flipped = {};
    for (var i in o) {
      if (o.hasOwnProperty(i)) {
        flipped[o[i]] = i;
      }
    }
    return flipped;
  }
  function boundAlpha(a) {
    a = parseFloat(a);
    if (isNaN(a) || a < 0 || a > 1) {
      a = 1;
    }
    return a;
  }
  function bound01(n, max) {
    if (isOnePointZero(n)) {
      n = "100%";
    }
    var processPercent = isPercentage(n);
    n = mathMin(max, mathMax(0, parseFloat(n)));
    if (processPercent) {
      n = parseInt(n * max, 10) / 100;
    }
    if (math.abs(n - max) < 1e-6) {
      return 1;
    }
    return n % max / parseFloat(max);
  }
  function clamp01(val) {
    return mathMin(1, mathMax(0, val));
  }
  function parseIntFromHex(val) {
    return parseInt(val, 16);
  }
  function isOnePointZero(n) {
    return typeof n == "string" && n.indexOf(".") != -1 && parseFloat(n) === 1;
  }
  function isPercentage(n) {
    return typeof n === "string" && n.indexOf("%") != -1;
  }
  function pad2(c) {
    return c.length == 1 ? "0" + c : "" + c;
  }
  function convertToPercentage(n) {
    if (n <= 1) {
      n = n * 100 + "%";
    }
    return n;
  }
  function convertDecimalToHex(d) {
    return Math.round(parseFloat(d) * 255).toString(16);
  }
  function convertHexToDecimal(h) {
    return parseIntFromHex(h) / 255;
  }
  var matchers = function() {
    var CSS_INTEGER = "[-\\+]?\\d+%?";
    var CSS_NUMBER = "[-\\+]?\\d*\\.\\d+%?";
    var CSS_UNIT = "(?:" + CSS_NUMBER + ")|(?:" + CSS_INTEGER + ")";
    var PERMISSIVE_MATCH3 = "[\\s|\\(]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")\\s*\\)?";
    var PERMISSIVE_MATCH4 = "[\\s|\\(]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")\\s*\\)?";
    return {
      rgb: new RegExp("rgb" + PERMISSIVE_MATCH3),
      rgba: new RegExp("rgba" + PERMISSIVE_MATCH4),
      hsl: new RegExp("hsl" + PERMISSIVE_MATCH3),
      hsla: new RegExp("hsla" + PERMISSIVE_MATCH4),
      hsv: new RegExp("hsv" + PERMISSIVE_MATCH3),
      hsva: new RegExp("hsva" + PERMISSIVE_MATCH4),
      hex3: /^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,
      hex6: /^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,
      hex8: /^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/
    };
  }();
  function stringInputToObject(color) {
    color = color.replace(trimLeft, "").replace(trimRight, "").toLowerCase();
    var named = false;
    if (names[color]) {
      color = names[color];
      named = true;
    } else if (color == "transparent") {
      return { r: 0, g: 0, b: 0, a: 0, format: "name" };
    }
    var match;
    if (match = matchers.rgb.exec(color)) {
      return { r: match[1], g: match[2], b: match[3] };
    }
    if (match = matchers.rgba.exec(color)) {
      return { r: match[1], g: match[2], b: match[3], a: match[4] };
    }
    if (match = matchers.hsl.exec(color)) {
      return { h: match[1], s: match[2], l: match[3] };
    }
    if (match = matchers.hsla.exec(color)) {
      return { h: match[1], s: match[2], l: match[3], a: match[4] };
    }
    if (match = matchers.hsv.exec(color)) {
      return { h: match[1], s: match[2], v: match[3] };
    }
    if (match = matchers.hsva.exec(color)) {
      return { h: match[1], s: match[2], v: match[3], a: match[4] };
    }
    if (match = matchers.hex8.exec(color)) {
      return {
        a: convertHexToDecimal(match[1]),
        r: parseIntFromHex(match[2]),
        g: parseIntFromHex(match[3]),
        b: parseIntFromHex(match[4]),
        format: named ? "name" : "hex8"
      };
    }
    if (match = matchers.hex6.exec(color)) {
      return {
        r: parseIntFromHex(match[1]),
        g: parseIntFromHex(match[2]),
        b: parseIntFromHex(match[3]),
        format: named ? "name" : "hex"
      };
    }
    if (match = matchers.hex3.exec(color)) {
      return {
        r: parseIntFromHex(match[1] + "" + match[1]),
        g: parseIntFromHex(match[2] + "" + match[2]),
        b: parseIntFromHex(match[3] + "" + match[3]),
        format: named ? "name" : "hex"
      };
    }
    return false;
  }
  window.tinycolor = tinycolor;
  $(function() {
    if ($.fn.spectrum.load) {
      $.fn.spectrum.processNativeColorInputs();
    }
  });
}
var Input_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Input = (
  /** @class */
  function(_super) {
    Input_extends(Input2, _super);
    function Input2(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, opts) || this;
      var ppfx = opts.ppfx || "";
      _this.opts = opts;
      _this.ppfx = ppfx;
      _this.em = opts.target || {};
      !opts.onChange && _this.listenTo(_this.model, "change:value", _this.handleModelChange);
      return _this;
    }
    Input2.prototype.template = function() {
      return '<span class="'.concat(this.holderClass(), '"></span>');
    };
    Input2.prototype.inputClass = function() {
      return "".concat(this.ppfx, "field");
    };
    Input2.prototype.holderClass = function() {
      return "".concat(this.ppfx, "input-holder");
    };
    Input2.prototype.elementUpdated = function() {
      this.model.trigger("el:change");
    };
    Input2.prototype.setValue = function(value, opts) {
      var model = this.model;
      var val = value || model.get("defaults");
      var input = this.getInputEl();
      input && (input.value = val);
    };
    Input2.prototype.handleModelChange = function(model, value, opts) {
      this.setValue(value, opts);
    };
    Input2.prototype.handleChange = function(e) {
      e.stopPropagation();
      var value = this.getInputEl().value;
      this.__onInputChange(value);
      this.elementUpdated();
    };
    Input2.prototype.__onInputChange = function(value) {
      this.model.set({ value }, { fromInput: 1 });
    };
    Input2.prototype.getInputEl = function() {
      if (!this.inputEl) {
        var _a2 = this, model = _a2.model, opts = _a2.opts;
        var type2 = opts.type || "text";
        var plh = model.get("placeholder") || model.get("defaults") || model.get("default") || "";
        this.inputEl = (0, cash_dom["default"])('<input type="'.concat(type2, '" placeholder="').concat(plh, '">'));
      }
      return this.inputEl.get(0);
    };
    Input2.prototype.render = function() {
      this.inputEl = null;
      var el = this.$el;
      el.addClass(this.inputClass());
      el.html(this.template());
      el.find(".".concat(this.holderClass())).append(this.getInputEl());
      return this;
    };
    return Input2;
  }(common.Ss)
);
var ui_Input = Input;
Input.prototype.events = {
  // @ts-ignore
  change: "handleChange"
};
var InputColor_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var InputColor_assign = function() {
  InputColor_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return InputColor_assign.apply(this, arguments);
};
cash_dom["default"] && ColorPicker(cash_dom["default"]);
var getColor = function(color) {
  var name = color.getFormat() === "name" && color.toName();
  var cl = color.getAlpha() == 1 ? color.toHexString() : color.toRgbString();
  return name || cl.replace(/ /g, "");
};
var InputColor = (
  /** @class */
  function(_super) {
    InputColor_extends(InputColor2, _super);
    function InputColor2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    InputColor2.prototype.template = function() {
      var ppfx = this.ppfx;
      return '\n      <div class="'.concat(this.holderClass(), '"></div>\n      <div class="').concat(ppfx, 'field-colorp">\n        <div class="').concat(ppfx, 'field-colorp-c" data-colorp-c>\n          <div class="').concat(ppfx, 'checker-bg"></div>\n        </div>\n      </div>\n    ');
    };
    InputColor2.prototype.inputClass = function() {
      var ppfx = this.ppfx;
      return "".concat(ppfx, "field ").concat(ppfx, "field-color");
    };
    InputColor2.prototype.holderClass = function() {
      return "".concat(this.ppfx, "input-holder");
    };
    InputColor2.prototype.remove = function() {
      _super.prototype.remove.call(this);
      this.colorEl.spectrum("destroy");
      return this;
    };
    InputColor2.prototype.handleChange = function(e) {
      e.stopPropagation();
      var value = e.target.value;
      if ((0, index_all.isUndefined)(value))
        return;
      this.__onInputChange(value);
    };
    InputColor2.prototype.__onInputChange = function(val) {
      var _a2 = this, model = _a2.model, opts = _a2.opts;
      var onChange = opts.onChange;
      var value = val;
      var colorEl = this.getColorEl();
      if (colorEl) {
        colorEl.spectrum("set", value);
        var tc = colorEl.spectrum("get");
        var color = value && getColor(tc);
        color && (value = color);
      }
      onChange ? onChange(value) : model.set({ value }, { fromInput: 1 });
    };
    InputColor2.prototype.setValue = function(val, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var model = this.model;
      var def = !(0, index_all.isUndefined)(opts.def) ? opts.def : model.get("defaults");
      var value = !(0, index_all.isUndefined)(val) ? val : !(0, index_all.isUndefined)(def) ? def : "";
      var inputEl = this.getInputEl();
      var colorEl = this.getColorEl();
      var valueClr = value != "none" ? value : "";
      inputEl.value = value;
      colorEl.get(0).style.backgroundColor = valueClr;
      if (opts.fromTarget || opts.fromInput && !opts.avoidStore) {
        colorEl.spectrum("set", valueClr);
        this.noneColor = value == "none";
        this.movedColor = valueClr;
      }
    };
    InputColor2.prototype.getColorEl = function() {
      var _this = this;
      if (!this.colorEl) {
        var _a2 = this, em = _a2.em, model_1 = _a2.model, opts = _a2.opts;
        var ppfx = this.ppfx;
        var onChange_1 = opts.onChange;
        var colorEl_1 = (0, cash_dom["default"])('<div class="'.concat(this.ppfx, 'field-color-picker"></div>'));
        var cpStyle_1 = colorEl_1.get(0).style;
        var colorPickerConfig = em && em.getConfig && em.getConfig().colorPicker || {};
        this.movedColor = "";
        var changed_1 = false;
        var previousColor_1;
        this.$el.find("[data-colorp-c]").append(colorEl_1);
        var handleChange_1 = function(value, complete) {
          if (complete === void 0) {
            complete = true;
          }
          if (onChange_1) {
            onChange_1(value, !complete);
          } else {
            complete && model_1.setValueFromInput(0, false);
            model_1.setValueFromInput(value, complete);
          }
        };
        colorEl_1.spectrum(InputColor_assign(InputColor_assign(InputColor_assign({ color: model_1.getValue() || false, containerClassName: "".concat(ppfx, "one-bg ").concat(ppfx, "two-color ").concat(ppfx, "editor-sp"), maxSelectionSize: 8, showPalette: true, showAlpha: true, chooseText: "Ok", cancelText: "⨯", palette: [] }, colorPickerConfig), model_1.get("colorPicker") || {}), { move: function(color) {
          var cl = getColor(color);
          _this.movedColor = cl;
          cpStyle_1.backgroundColor = cl;
          handleChange_1(cl, false);
        }, change: function(color) {
          changed_1 = true;
          var cl = getColor(color);
          cpStyle_1.backgroundColor = cl;
          handleChange_1(cl);
          _this.noneColor = false;
        }, show: function(color) {
          changed_1 = false;
          _this.movedColor = "";
          previousColor_1 = onChange_1 ? model_1.getValue({ noDefault: true }) : getColor(color);
        }, hide: function() {
          if (!changed_1 && (previousColor_1 || onChange_1)) {
            if (_this.noneColor) {
              previousColor_1 = "";
            }
            cpStyle_1.backgroundColor = previousColor_1;
            colorEl_1.spectrum("set", previousColor_1);
            handleChange_1(previousColor_1, false);
          }
        } }));
        if (em && em.on) {
          this.listenTo(em, "component:selected", function() {
            _this.movedColor && handleChange_1(_this.movedColor);
            changed_1 = true;
            _this.movedColor = "";
            colorEl_1.spectrum("hide");
          });
        }
        this.colorEl = colorEl_1;
      }
      return this.colorEl;
    };
    InputColor2.prototype.render = function() {
      ui_Input.prototype.render.call(this);
      this.getColorEl();
      return this;
    };
    return InputColor2;
  }(ui_Input)
);
var ui_InputColor = InputColor;
var TraitColorView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TraitColorView = (
  /** @class */
  function(_super) {
    TraitColorView_extends(TraitColorView2, _super);
    function TraitColorView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    TraitColorView2.prototype.templateInput = function() {
      return "";
    };
    TraitColorView2.prototype.getInputEl = function() {
      if (!this.input) {
        var model = this.model;
        var value = this.getModelValue();
        var inputColor = new ui_InputColor({
          model,
          target: this.config.em,
          contClass: this.ppfx + "field-color",
          ppfx: this.ppfx
        });
        var input = inputColor.render();
        input.setValue(value, { fromTarget: 1 });
        this.input = input.el;
      }
      return this.input;
    };
    return TraitColorView2;
  }(view_TraitView)
);
var view_TraitColorView = TraitColorView;
var InputNumber_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var InputNumber = (
  /** @class */
  function(_super) {
    InputNumber_extends(InputNumber2, _super);
    function InputNumber2(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, opts) || this;
      (0, index_all.bindAll)(_this, "moveIncrement", "upIncrement");
      _this.doc = document;
      _this.listenTo(_this.model, "change:unit", _this.handleModelChange);
      return _this;
    }
    InputNumber2.prototype.template = function() {
      var ppfx = this.ppfx;
      return '\n      <span class="'.concat(ppfx, 'input-holder"></span>\n      <span class="').concat(ppfx, 'field-units"></span>\n      <div class="').concat(ppfx, 'field-arrows" data-arrows>\n        <div class="').concat(ppfx, 'field-arrow-u" data-arrow-up></div>\n        <div class="').concat(ppfx, 'field-arrow-d" data-arrow-down></div>\n      </div>\n    ');
    };
    InputNumber2.prototype.inputClass = function() {
      var ppfx = this.ppfx;
      return this.opts.contClass || "".concat(ppfx, "field ").concat(ppfx, "field-integer");
    };
    InputNumber2.prototype.setValue = function(value, opts) {
      var opt = opts || {};
      var valid = this.validateInputValue(value, { deepCheck: 1 });
      var validObj = { value: valid.value, unit: "" };
      if (valid.unit || valid.force) {
        validObj.unit = valid.unit;
      }
      this.model.set(validObj, opt);
      if (opt.silent) {
        this.handleModelChange();
      }
    };
    InputNumber2.prototype.handleChange = function(e) {
      e.stopPropagation();
      this.setValue(this.getInputEl().value);
      this.elementUpdated();
    };
    InputNumber2.prototype.handleUnitChange = function(e) {
      e.stopPropagation();
      var value = this.getUnitEl().value;
      this.model.set("unit", value);
      this.elementUpdated();
    };
    InputNumber2.prototype.handleKeyDown = function(e) {
      if (e.key === "ArrowUp") {
        e.preventDefault();
        this.upArrowClick();
      }
      if (e.key === "ArrowDown") {
        e.preventDefault();
        this.downArrowClick();
      }
    };
    InputNumber2.prototype.elementUpdated = function() {
      this.model.trigger("el:change");
    };
    InputNumber2.prototype.handleModelChange = function() {
      var model = this.model;
      this.getInputEl().value = model.get("value");
      var unitEl = this.getUnitEl();
      unitEl && (unitEl.value = model.get("unit") || "");
    };
    InputNumber2.prototype.getUnitEl = function() {
      if (!this.unitEl) {
        var model_1 = this.model;
        var units = model_1.get("units") || [];
        if (units.length) {
          var options_1 = ['<option value="" disabled hidden>-</option>'];
          units.forEach(function(unit) {
            var selected = unit == model_1.get("unit") ? "selected" : "";
            options_1.push("<option ".concat(selected, ">").concat(unit, "</option>"));
          });
          var temp = document.createElement("div");
          temp.innerHTML = '<select class="'.concat(this.ppfx, 'input-unit">').concat(options_1.join(""), "</select>");
          this.unitEl = temp.firstChild;
        }
      }
      return this.unitEl;
    };
    InputNumber2.prototype.upArrowClick = function() {
      var model = this.model;
      var step = model.get("step");
      var value = parseFloat(this.getInputEl().value);
      this.setValue(this.normalizeValue(value + step));
      this.elementUpdated();
    };
    InputNumber2.prototype.downArrowClick = function() {
      var model = this.model;
      var step = model.get("step");
      var value = parseFloat(this.getInputEl().value);
      this.setValue(this.normalizeValue(value - step));
      this.elementUpdated();
    };
    InputNumber2.prototype.downIncrement = function(e) {
      e.preventDefault();
      this.moved = false;
      var value = this.model.get("value") || 0;
      value = this.normalizeValue(value);
      this.current = { y: e.pageY, val: value };
      (0, dom.on)(this.doc, "mousemove", this.moveIncrement);
      (0, dom.on)(this.doc, "mouseup", this.upIncrement);
    };
    InputNumber2.prototype.moveIncrement = function(ev) {
      this.moved = true;
      var model = this.model;
      var step = model.get("step");
      var data = this.current;
      var pos = this.normalizeValue(data.val + (data.y - ev.pageY) * step);
      var _a2 = this.validateInputValue(pos), value = _a2.value, unit = _a2.unit;
      this.prValue = value;
      model.set({ value, unit }, { avoidStore: 1 });
      return false;
    };
    InputNumber2.prototype.upIncrement = function() {
      var model = this.model;
      var step = model.get("step");
      (0, dom.AU)(this.doc, "mouseup", this.upIncrement);
      (0, dom.AU)(this.doc, "mousemove", this.moveIncrement);
      if (this.prValue && this.moved) {
        var value = this.prValue - step;
        model.set("value", value, { avoidStore: 1 }).set("value", value + step);
        this.elementUpdated();
      }
    };
    InputNumber2.prototype.normalizeValue = function(value, defValue) {
      if (defValue === void 0) {
        defValue = 0;
      }
      var model = this.model;
      var step = model.get("step");
      var stepDecimals = 0;
      if (isNaN(value)) {
        return defValue;
      }
      value = parseFloat(value);
      if (Math.floor(value) !== value) {
        var side = step.toString().split(".")[1];
        stepDecimals = side ? side.length : 0;
      }
      return stepDecimals ? parseFloat(value.toFixed(stepDecimals)) : value;
    };
    InputNumber2.prototype.validateInputValue = function(value, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var force = 0;
      var opt = opts || {};
      var model = this.model;
      var defValue = "";
      var val = !(0, index_all.isUndefined)(value) ? value : defValue;
      var units = opts.units || model.get("units") || [];
      var unit = model.get("unit") || units.length && units[0] || "";
      var max = !(0, index_all.isUndefined)(opts.max) ? opts.max : model.get("max");
      var min = !(0, index_all.isUndefined)(opts.min) ? opts.min : model.get("min");
      var limitlessMax = !!model.get("limitlessMax");
      var limitlessMin = !!model.get("limitlessMin");
      if (opt.deepCheck) {
        var fixed = model.get("fixedValues") || [];
        if (val === "")
          unit = "";
        if (val) {
          var regFixed = new RegExp("^" + fixed.join("|"), "g");
          if (fixed.length && regFixed.test(val)) {
            val = val.match(regFixed)[0];
            unit = "";
            force = 1;
          } else {
            var valCopy = val + "";
            val += "";
            val = parseFloat(val.replace(",", "."));
            val = !isNaN(val) ? val : defValue;
            var uN = valCopy.replace(val, "");
            if ((0, index_all.indexOf)(units, uN) >= 0)
              unit = uN;
          }
        }
      }
      if (!limitlessMax && !(0, index_all.isUndefined)(max) && max !== "")
        val = val > max ? max : val;
      if (!limitlessMin && !(0, index_all.isUndefined)(min) && min !== "")
        val = val < min ? min : val;
      return {
        force,
        value: val,
        unit
      };
    };
    InputNumber2.prototype.render = function() {
      ui_Input.prototype.render.call(this);
      this.unitEl = null;
      var unit = this.getUnitEl();
      unit && this.$el.find(".".concat(this.ppfx, "field-units")).get(0).appendChild(unit);
      return this;
    };
    return InputNumber2;
  }(ui_Input)
);
var ui_InputNumber = InputNumber;
InputNumber.prototype.events = {
  // @ts-ignore
  "change input": "handleChange",
  "change select": "handleUnitChange",
  "click [data-arrow-up]": "upArrowClick",
  "click [data-arrow-down]": "downArrowClick",
  "mousedown [data-arrows]": "downIncrement",
  keydown: "handleKeyDown"
};
var TraitNumberView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TraitNumberView = (
  /** @class */
  function(_super) {
    TraitNumberView_extends(TraitNumberView2, _super);
    function TraitNumberView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    TraitNumberView2.prototype.getValueForTarget = function() {
      var model = this.model;
      var _a2 = model.attributes, value = _a2.value, unit = _a2.unit;
      return !(0, index_all.isUndefined)(value) && value !== "" ? value + unit : model.get("default");
    };
    TraitNumberView2.prototype.getInputEl = function() {
      if (!this.input) {
        var _a2 = this, ppfx = _a2.ppfx, model = _a2.model;
        var value = this.getModelValue();
        var inputNumber = new ui_InputNumber({
          contClass: "".concat(ppfx, "field-int"),
          type: "number",
          model,
          ppfx
        });
        inputNumber.render();
        this.$input = inputNumber.inputEl;
        this.$unit = inputNumber.unitEl;
        model.set("value", value, { fromTarget: true });
        this.$input.val(value);
        this.input = inputNumber.el;
      }
      return this.input;
    };
    return TraitNumberView2;
  }(view_TraitView)
);
var view_TraitNumberView = TraitNumberView;
var TraitSelectView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TraitSelectView = (
  /** @class */
  function(_super) {
    TraitSelectView_extends(TraitSelectView2, _super);
    function TraitSelectView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      _this.listenTo(_this.model, "change:options", _this.rerender);
      return _this;
    }
    TraitSelectView2.prototype.templateInput = function() {
      var _a2 = this, ppfx = _a2.ppfx, clsField = _a2.clsField;
      return '<div class="'.concat(clsField, '">\n      <div data-input></div>\n      <div class="').concat(ppfx, 'sel-arrow">\n        <div class="').concat(ppfx, 'd-s-arrow"></div>\n      </div>\n    </div>');
    };
    TraitSelectView2.prototype.getInputEl = function() {
      if (!this.$input) {
        var _a2 = this, model = _a2.model, em_1 = _a2.em;
        var propName_1 = model.get("name");
        var opts = model.get("options") || [];
        var values_1 = [];
        var input_1 = "<select>";
        opts.forEach(function(el) {
          var attrs = "";
          var name, value, style;
          if ((0, index_all.isString)(el)) {
            name = el;
            value = el;
          } else {
            name = el.name || el.label || el.value;
            value = "".concat((0, index_all.isUndefined)(el.value) ? el.id : el.value).replace(/"/g, "&quot;");
            style = el.style ? el.style.replace(/"/g, "&quot;") : "";
            attrs += style ? ' style="'.concat(style, '"') : "";
          }
          var resultName = em_1.t("traitManager.traits.options.".concat(propName_1, ".").concat(value)) || name;
          input_1 += '<option value="'.concat(value, '"').concat(attrs, ">").concat(resultName, "</option>");
          values_1.push(value);
        });
        input_1 += "</select>";
        this.$input = (0, cash_dom["default"])(input_1);
        var val = model.getTargetValue();
        var valResult = values_1.indexOf(val) >= 0 ? val : model.get("default");
        !(0, index_all.isUndefined)(valResult) && this.$input.val(valResult);
      }
      return this.$input.get(0);
    };
    return TraitSelectView2;
  }(view_TraitView)
);
var view_TraitSelectView = TraitSelectView;
var DomainViews = __webpack_require__(754);
var TraitsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ATTR_CATEGORIES = "data-categories";
var ATTR_NO_CATEGORIES = "data-no-categories";
var TraitsView = (
  /** @class */
  function(_super) {
    TraitsView_extends(TraitsView2, _super);
    function TraitsView2(props, itemsView) {
      var _this = _super.call(this, props) || this;
      _this.reuseView = true;
      _this.renderedCategories = /* @__PURE__ */ new Map();
      _this.itemsView = itemsView;
      var config2 = props.config || {};
      _this.config = config2;
      var em = props.editor;
      _this.em = em;
      var ppfx = config2.pStylePrefix || "";
      _this.ppfx = ppfx;
      _this.pfx = ppfx + config2.stylePrefix || "";
      _this.className = "".concat(_this.pfx, "traits");
      _this.traitContClass = "".concat(ppfx, "traits-c");
      _this.classNoCat = "".concat(ppfx, "traits-empty-c");
      _this.catsClass = "".concat(ppfx, "trait-categories");
      _this.collection = new model_Traits([], { em });
      _this.listenTo(em, "component:toggled", _this.updatedCollection);
      _this.updatedCollection();
      return _this;
    }
    TraitsView2.prototype.updatedCollection = function() {
      var _a2 = this, ppfx = _a2.ppfx, em = _a2.em;
      var comp = em.getSelected();
      this.el.className = "".concat(this.traitContClass, "s ").concat(ppfx, "one-bg ").concat(ppfx, "two-color");
      this.collection = (comp === null || comp === void 0 ? void 0 : comp.traits) || new model_Traits([], { em });
      this.render();
    };
    TraitsView2.prototype.add = function(model, fragment) {
      var _a2 = this, config2 = _a2.config, renderedCategories = _a2.renderedCategories;
      var itemView = this.itemView;
      var typeField = model.get(this.itemType);
      if (this.itemsView && this.itemsView[typeField]) {
        itemView = this.itemsView[typeField];
      }
      var view = new itemView({
        config: config2,
        model,
        attributes: model.get("attributes")
      });
      var rendered = view.render().el;
      var category = model.parent.initCategory(model);
      if (category) {
        var catId = category.getId();
        var categories = this.getCategoriesEl();
        var catView = renderedCategories.get(catId);
        if (!catView && categories) {
          catView = new ModuleCategoryView({ model: category }, config2, "trait").render();
          renderedCategories.set(catId, catView);
          categories.appendChild(catView.el);
        }
        catView === null || catView === void 0 ? void 0 : catView.append(rendered);
        return;
      }
      fragment ? fragment.appendChild(rendered) : this.append(rendered);
    };
    TraitsView2.prototype.getCategoriesEl = function() {
      if (!this.catsEl) {
        this.catsEl = this.el.querySelector("[".concat(ATTR_CATEGORIES, "]"));
      }
      return this.catsEl;
    };
    TraitsView2.prototype.getTraitsEl = function() {
      if (!this.traitsEl) {
        this.traitsEl = this.el.querySelector("[".concat(ATTR_NO_CATEGORIES, "]"));
      }
      return this.traitsEl;
    };
    TraitsView2.prototype.append = function(el) {
      var traits = this.getTraitsEl();
      traits === null || traits === void 0 ? void 0 : traits.appendChild(el);
    };
    TraitsView2.prototype.render = function() {
      var _this = this;
      var _a2 = this, el = _a2.el, ppfx = _a2.ppfx, catsClass = _a2.catsClass, traitContClass = _a2.traitContClass, classNoCat = _a2.classNoCat;
      var frag = document.createDocumentFragment();
      delete this.catsEl;
      delete this.traitsEl;
      this.renderedCategories = /* @__PURE__ */ new Map();
      el.innerHTML = '\n      <div class="'.concat(catsClass, '" ').concat(ATTR_CATEGORIES, '></div>\n      <div class="').concat(classNoCat, " ").concat(traitContClass, '" ').concat(ATTR_NO_CATEGORIES, "></div>\n    ");
      this.collection.forEach(function(model) {
        return _this.add(model, frag);
      });
      this.append(frag);
      var cls = "".concat(traitContClass, "s ").concat(ppfx, "one-bg ").concat(ppfx, "two-color");
      this.$el.addClass(cls);
      this.rendered = true;
      return this;
    };
    return TraitsView2;
  }(DomainViews.A)
);
var view_TraitsView = TraitsView;
TraitsView.prototype.itemView = view_TraitView;
var trait_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var trait_manager_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var TraitManager = (
  /** @class */
  function(_super) {
    trait_manager_extends(TraitManager2, _super);
    function TraitManager2(em) {
      var _this = _super.call(this, em, "TraitManager", trait_manager_config_config) || this;
      _this.TraitsView = view_TraitsView;
      _this.events = TraitsEvents;
      _this.state = new common.Kx({ traits: [] });
      _this.types = {
        text: view_TraitView,
        number: view_TraitNumberView,
        select: view_TraitSelectView,
        checkbox: view_TraitCheckboxView,
        color: view_TraitColorView,
        button: view_TraitButtonView
      };
      var _a2 = _this, state = _a2.state, config2 = _a2.config, events2 = _a2.events;
      var ppfx = config2.pStylePrefix;
      ppfx && (config2.stylePrefix = "".concat(ppfx).concat(config2.stylePrefix));
      (0, index_all.bindAll)(_this, "__onSelect");
      var upAll = (0, index_all.debounce)(function() {
        return _this.__upSel();
      }, 0);
      var update = (0, index_all.debounce)(function() {
        return _this.__onUp();
      }, 0);
      state.listenTo(em, "component:toggled", upAll);
      state.listenTo(em, events2.value, update);
      state.on("change:traits", _this.__onSelect);
      _this.debounced = [upAll, update];
      return _this;
    }
    TraitManager2.prototype.select = function(component) {
      var traits = (component === null || component === void 0 ? void 0 : component.getTraits()) || [];
      this.state.set({ component, traits });
      this.__trgCustom();
    };
    TraitManager2.prototype.getCategories = function() {
      var _a2;
      var cmp = this.getComponent();
      var categories = ((_a2 = cmp === null || cmp === void 0 ? void 0 : cmp.traits.categories) === null || _a2 === void 0 ? void 0 : _a2.models) || [];
      return trait_manager_spreadArray([], categories, true);
    };
    TraitManager2.prototype.getTraits = function() {
      return this.getCurrent();
    };
    TraitManager2.prototype.getTraitsByCategory = function(traits) {
      return getItemsByCategory(traits || this.getTraits());
    };
    TraitManager2.prototype.getComponent = function() {
      return this.state.attributes.component;
    };
    TraitManager2.prototype.addType = function(name, methods) {
      var baseView = this.getType("text");
      this.types[name] = baseView.extend(methods);
    };
    TraitManager2.prototype.getType = function(name) {
      return this.getTypes()[name];
    };
    TraitManager2.prototype.getTypes = function() {
      return this.types;
    };
    TraitManager2.prototype.getTraitsViewer = function() {
      return this.view;
    };
    TraitManager2.prototype.getCurrent = function() {
      return this.state.get("traits") || [];
    };
    TraitManager2.prototype.render = function() {
      var view = this.view;
      var em = this.em;
      view = new view_TraitsView({
        el: view === null || view === void 0 ? void 0 : view.el,
        collection: [],
        editor: em,
        config: this.getConfig()
      }, this.getTypes());
      this.view = view;
      return view.el;
    };
    TraitManager2.prototype.postRender = function() {
      this.__appendTo();
    };
    TraitManager2.prototype.__onSelect = function() {
      var _a2 = this, em = _a2.em, events2 = _a2.events, state = _a2.state;
      var _b = state.attributes, component = _b.component, traits = _b.traits;
      em.trigger(events2.select, { component, traits });
    };
    TraitManager2.prototype.__trgCustom = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, events2 = _a2.events, __ctn = _a2.__ctn;
      this.__ctn = __ctn || opts.container;
      em.trigger(events2.custom, this.__customData());
    };
    TraitManager2.prototype.__customData = function() {
      return { container: this.__ctn };
    };
    TraitManager2.prototype.__upSel = function() {
      this.select(this.em.getSelected());
    };
    TraitManager2.prototype.__onUp = function() {
      this.select(this.getComponent());
    };
    return TraitManager2;
  }(abstract_Module)
);
var trait_manager = TraitManager;
var navigator_config_config_config = {
  stylePrefix: "",
  appendTo: "",
  sortable: true,
  hidable: true,
  hideTextnode: true,
  root: "",
  showWrapper: true,
  showHover: true,
  scrollCanvas: { behavior: "smooth", block: "nearest" },
  scrollLayers: { behavior: "auto", block: "nearest" },
  highlightHover: true,
  custom: false,
  onInit: function() {
  },
  onRender: function() {
  },
  extend: {}
};
var navigator_config_config = navigator_config_config_config;
var ItemsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ItemsView = (
  /** @class */
  function(_super) {
    ItemsView_extends(ItemsView2, _super);
    function ItemsView2(opt) {
      if (opt === void 0) {
        opt = {};
      }
      var _this = _super.call(this, opt) || this;
      _this.items = [];
      _this.opt = opt;
      var config2 = opt.config || {};
      _this.config = config2;
      _this.module = opt.module;
      _this.parentView = opt.parentView;
      var pfx = config2.stylePrefix || "";
      var ppfx = config2.pStylePrefix || "";
      var coll = _this.collection;
      _this.listenTo(coll, "add", _this.addTo);
      _this.listenTo(coll, "reset resetNavigator", _this.render);
      _this.listenTo(coll, "remove", _this.removeChildren);
      _this.className = "".concat(pfx, "layers");
      var em = config2.em;
      if (config2.sortable && !_this.opt.sorter) {
        var utils2 = em.Utils;
        _this.opt.sorter = new utils2.Sorter({
          // @ts-ignore
          container: config2.sortContainer || _this.el,
          containerSel: ".".concat(_this.className),
          itemSel: ".".concat(pfx, "layer"),
          ignoreViewChildren: 1,
          avoidSelectOnEnd: 1,
          nested: 1,
          ppfx,
          pfx,
          em
        });
      }
      _this.$el.data("collection", coll);
      opt.parent && _this.$el.data("model", opt.parent);
      return _this;
    }
    ItemsView2.prototype.removeChildren = function(removed) {
      var view = removed.viewLayer;
      if (!view)
        return;
      view.remove();
      delete removed.viewLayer;
    };
    ItemsView2.prototype.addTo = function(model) {
      this.addToCollection(model, null, this.collection.indexOf(model));
    };
    ItemsView2.prototype.addToCollection = function(model, fragment, index2) {
      var _a2 = this, parentView = _a2.parentView, opt = _a2.opt, config2 = _a2.config, el = _a2.el;
      var ItemView2 = opt.ItemView, opened = opt.opened, module = opt.module, level = opt.level, sorter = opt.sorter;
      var item = model.viewLayer || new ItemView2({
        ItemView: ItemView2,
        level,
        model,
        parentView,
        config: config2,
        sorter,
        opened,
        module
      });
      var rendered = item.render().el;
      if (fragment) {
        fragment.appendChild(rendered);
      } else {
        var parent_1 = el;
        var children = parent_1.childNodes;
        if (!(0, index_all.isUndefined)(index2)) {
          var lastIndex = children.length == index2;
          if (lastIndex) {
            index2--;
          }
          if (lastIndex || !children.length) {
            parent_1.appendChild(rendered);
          } else {
            parent_1.insertBefore(rendered, children[index2]);
          }
        } else {
          parent_1.appendChild(rendered);
        }
      }
      this.items.push(item);
      return rendered;
    };
    ItemsView2.prototype.remove = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      common.Ss.prototype.remove.apply(this, args);
      this.items.map(function(i) {
        return i.remove();
      });
      return this;
    };
    ItemsView2.prototype.render = function() {
      var _this = this;
      var _a2 = this, el = _a2.el, module = _a2.module;
      var frag = document.createDocumentFragment();
      el.innerHTML = "";
      this.collection.map(function(cmp) {
        return module.__getLayerFromComponent(cmp);
      }).forEach(function(model) {
        return _this.addToCollection(model, frag);
      });
      el.appendChild(frag);
      el.className = this.className;
      return this;
    };
    return ItemsView2;
  }(common.Ss)
);
var view_ItemsView = ItemsView;
var CommandAbstract = __webpack_require__(570);
var commands_config_config_config = {
  stylePrefix: "com-",
  defaults: {},
  strict: true
};
var commands_config_config = commands_config_config_config;
var commands_types = __webpack_require__(242);
var commands_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var commands_assign = function() {
  commands_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return commands_assign.apply(this, arguments);
};
var commands_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var commandsDef = [
  ["preview", "Preview", "preview"],
  ["resize", "Resize", "resize"],
  ["fullscreen", "Fullscreen", "fullscreen"],
  ["copy", "CopyComponent"],
  ["paste", "PasteComponent"],
  ["canvas-move", "CanvasMove"],
  ["canvas-clear", "CanvasClear"],
  ["open-code", "ExportTemplate", "export-template"],
  ["open-layers", "OpenLayers", "open-layers"],
  ["open-styles", "OpenStyleManager", "open-sm"],
  ["open-traits", "OpenTraitManager", "open-tm"],
  ["open-blocks", "OpenBlocks", "open-blocks"],
  ["open-assets", "OpenAssets", "open-assets"],
  ["component-select", "SelectComponent", "select-comp"],
  ["component-outline", "SwitchVisibility", "sw-visibility"],
  ["component-offset", "ShowOffset", "show-offset"],
  ["component-move", "MoveComponent", "move-comp"],
  ["component-next", "ComponentNext"],
  ["component-prev", "ComponentPrev"],
  ["component-enter", "ComponentEnter"],
  ["component-exit", "ComponentExit", "select-parent"],
  ["component-delete", "ComponentDelete"],
  ["component-style-clear", "ComponentStyleClear"],
  ["component-drag", "ComponentDrag"]
];
var defComOptions = { preserveSelected: 1 };
var getOnComponentDragStart = function(em) {
  return function(data) {
    return em.trigger("".concat(eventDrag, ":start"), data);
  };
};
var getOnComponentDrag = function(em) {
  return function(data) {
    return em.trigger(eventDrag, data);
  };
};
var getOnComponentDragEnd = function(em, targets, opts) {
  if (opts === void 0) {
    opts = {};
  }
  return function(a, b, data) {
    targets.forEach(function(trg) {
      return trg.set("status", trg.get("selectable") ? "selected" : "");
    });
    em.setSelected(targets);
    targets[0].emitUpdate();
    em.trigger("".concat(eventDrag, ":end"), data);
    setTimeout(function() {
      return em.runDefault(defComOptions);
    });
    (opts.altMode || data.cancelled) && em.set("_cmpDrag", 1);
  };
};
var CommandsModule = (
  /** @class */
  function(_super) {
    commands_extends(CommandsModule2, _super);
    function CommandsModule2(em) {
      var _this = _super.call(this, em, "Commands", commands_config_config) || this;
      _this.CommandAbstract = CommandAbstract["default"];
      _this.defaultCommands = {};
      _this.commands = {};
      _this.active = {};
      _this.events = commands_types.A;
      var config2 = _this.config;
      var ppfx = config2.pStylePrefix;
      var defaultCommands = _this.defaultCommands;
      if (ppfx) {
        config2.stylePrefix = ppfx + config2.stylePrefix;
      }
      Object.keys(config2.defaults).forEach(function(k2) {
        var obj = config2.defaults[k2];
        if (obj.id)
          _this.add(obj.id, obj);
      });
      defaultCommands["tlb-delete"] = {
        run: function(ed) {
          return ed.runCommand("core:component-delete");
        }
      };
      defaultCommands["tlb-clone"] = {
        run: function(ed) {
          ed.runCommand("core:copy");
          ed.runCommand("core:paste", { action: "clone-component" });
        }
      };
      defaultCommands["tlb-move"] = {
        run: function(ed, s, opts) {
          var _a2;
          if (opts === void 0) {
            opts = {};
          }
          var dragger;
          var em2 = ed.getModel();
          var event = opts.event;
          var trg = opts.target;
          var trgs = trg ? [trg] : commands_spreadArray([], ed.getSelectedAll(), true);
          var targets = trgs.map(function(trg2) {
            var _a3, _b;
            return ((_b = (_a3 = trg2.delegate) === null || _a3 === void 0 ? void 0 : _a3.move) === null || _b === void 0 ? void 0 : _b.call(_a3, trg2)) || trg2;
          }).filter(Boolean);
          var target = targets[targets.length - 1];
          var nativeDrag = (event === null || event === void 0 ? void 0 : event.type) === "dragstart";
          var modes = ["absolute", "translate"];
          if (!(target === null || target === void 0 ? void 0 : target.get("draggable"))) {
            return em2.logWarning("The element is not draggable");
          }
          var mode = target.get("dmode") || em2.get("dmode");
          var hideTlb = function() {
            return em2.stopDefault(defComOptions);
          };
          var altMode = (0, index_all.includes)(modes, mode);
          targets.forEach(function(trg2) {
            return trg2.trigger("disable", { fromMove: true });
          });
          nativeDrag ? setTimeout(hideTlb, 0) : hideTlb();
          var onStart = getOnComponentDragStart(em2);
          var onDrag = getOnComponentDrag(em2);
          var onEnd = getOnComponentDragEnd(em2, targets, { altMode });
          if (altMode) {
            dragger = ed.runCommand("core:component-drag", {
              guidesInfo: 1,
              mode,
              target,
              onStart,
              onDrag,
              onEnd,
              event
            });
          } else {
            if (nativeDrag) {
              event.dataTransfer.setDragImage((_a2 = target.view) === null || _a2 === void 0 ? void 0 : _a2.el, 0, 0);
            }
            var cmdMove = ed.Commands.get("move-comp");
            cmdMove.onStart = onStart;
            cmdMove.onDrag = onDrag;
            cmdMove.onEndMoveFromModel = onEnd;
            cmdMove.initSorterFromModels(targets);
          }
          targets.filter(function(sel) {
            return sel.get("selectable");
          }).forEach(function(sel) {
            return sel.set("status", "freezed-selected");
          });
        }
      };
      defaultCommands["core:undo"] = function(e) {
        return e.UndoManager.undo();
      };
      defaultCommands["core:redo"] = function(e) {
        return e.UndoManager.redo();
      };
      commandsDef.forEach(function(item) {
        var oldCmd = item[2];
        var cmd = __webpack_require__(585)("./".concat(item[1])).default;
        var cmdName = "core:".concat(item[0]);
        defaultCommands[cmdName] = cmd;
        if (oldCmd) {
          defaultCommands[oldCmd] = cmd;
          ["run", "stop"].forEach(function(name) {
            em.on("".concat(name, ":").concat(oldCmd), function() {
              var args = [];
              for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
              }
              return em.trigger.apply(em, commands_spreadArray(["".concat(name, ":").concat(cmdName)], args, false));
            });
          });
        }
      });
      config2.model = em.Canvas;
      for (var id in defaultCommands) {
        _this.add(id, defaultCommands[id]);
      }
      return _this;
    }
    CommandsModule2.prototype.add = function(id, command) {
      var result = (0, index_all.isFunction)(command) ? { run: command } : command;
      if (!result.stop) {
        result.noStop = true;
      }
      delete result.initialize;
      result.id = id;
      this.commands[id] = CommandAbstract["default"].extend(result);
      return this;
    };
    CommandsModule2.prototype.get = function(id) {
      var command = this.commands[id];
      if ((0, index_all.isFunction)(command)) {
        command = new command(this.config);
        this.commands[id] = command;
      } else if (!command) {
        this.em.logWarning("'".concat(id, "' command not found"));
      }
      return command;
    };
    CommandsModule2.prototype.extend = function(id, cmd) {
      if (cmd === void 0) {
        cmd = {};
      }
      var command = this.get(id);
      if (command) {
        var cmdObj = commands_assign(commands_assign({}, command.constructor.prototype), cmd);
        this.add(id, cmdObj);
        var oldCmd = commandsDef.filter(function(cmd2) {
          return "core:".concat(cmd2[0]) === id && cmd2[2];
        })[0];
        oldCmd && this.add(oldCmd[2], cmdObj);
      }
      return this;
    };
    CommandsModule2.prototype.has = function(id) {
      return !!this.commands[id];
    };
    CommandsModule2.prototype.getAll = function() {
      return this.commands;
    };
    CommandsModule2.prototype.run = function(id, options) {
      if (options === void 0) {
        options = {};
      }
      return this.runCommand(this.get(id), options);
    };
    CommandsModule2.prototype.stop = function(id, options) {
      if (options === void 0) {
        options = {};
      }
      return this.stopCommand(this.get(id), options);
    };
    CommandsModule2.prototype.isActive = function(id) {
      return this.getActive().hasOwnProperty(id);
    };
    CommandsModule2.prototype.getActive = function() {
      return this.active;
    };
    CommandsModule2.prototype.runCommand = function(command, options) {
      if (options === void 0) {
        options = {};
      }
      var result;
      if (command && command.run) {
        var _a2 = this, em = _a2.em, config2 = _a2.config;
        var id = command.id;
        var editor = em.Editor;
        if (!this.isActive(id) || options.force || !config2.strict) {
          result = editor && command.callRun(editor, options);
          if (id && command.stop && !command.noStop && !options.abort) {
            this.active[id] = result;
          }
        }
      }
      return result;
    };
    CommandsModule2.prototype.stopCommand = function(command, options) {
      if (options === void 0) {
        options = {};
      }
      var result;
      if (command && command.run) {
        var _a2 = this, em = _a2.em, config2 = _a2.config;
        var id = command.id;
        var editor = em.Editor;
        if (this.isActive(id) || options.force || !config2.strict) {
          if (id)
            delete this.active[id];
          result = command.callStop(editor, options);
        }
      }
      return result;
    };
    CommandsModule2.prototype.create = function(command) {
      if (!command.stop)
        command.noStop = true;
      var cmd = CommandAbstract["default"].extend(command);
      return new cmd(this.config);
    };
    CommandsModule2.prototype.__onRun = function(id, clb) {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      em.on("".concat(events2.runCommand).concat(id), clb);
    };
    CommandsModule2.prototype.__onStop = function(id, clb) {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      em.on("".concat(events2.stopCommand).concat(id), clb);
    };
    CommandsModule2.prototype.destroy = function() {
      this.defaultCommands = {};
      this.commands = {};
      this.active = {};
    };
    return CommandsModule2;
  }(abstract_Module)
);
var commands = CommandsModule;
var ItemView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ItemView_inputProp = "contentEditable";
var dataToggleMove = "data-toggle-move";
var ItemView = (
  /** @class */
  function(_super) {
    ItemView_extends(ItemView2, _super);
    function ItemView2(opt) {
      var _this = _super.call(this, opt) || this;
      (0, index_all.bindAll)(_this, "__render");
      _this.opt = opt;
      _this.module = opt.module;
      _this.config = opt.config || {};
      _this.sorter = opt.sorter || "";
      _this.parentView = opt.parentView;
      var _a2 = _this, model = _a2.model, pfx = _a2.pfx, ppfx = _a2.ppfx;
      var type2 = model.get("type") || "default";
      _this.className = "".concat(pfx, "layer ").concat(pfx, "layer__t-").concat(type2, " no-select ").concat(ppfx, "two-color");
      _this.inputNameCls = "".concat(ppfx, "layer-name");
      _this.clsTitleC = "".concat(pfx, "layer-title-c");
      _this.clsTitle = "".concat(pfx, "layer-title");
      _this.clsCaret = "".concat(pfx, "layer-caret");
      _this.clsCount = "".concat(pfx, "layer-count");
      _this.clsMove = "".concat(pfx, "layer-move");
      _this.clsChildren = "".concat(pfx, "layer-children");
      _this.clsNoChild = "".concat(pfx, "layer-no-chld");
      _this.clsEdit = "".concat(_this.inputNameCls, "--edit");
      _this.clsNoEdit = "".concat(_this.inputNameCls, "--no-edit");
      _this.initComponent();
      return _this;
    }
    ItemView2.prototype.events = function() {
      var _a2;
      return _a2 = {}, _a2["mousedown [".concat(dataToggleMove, "]")] = "startSort", _a2["touchstart [".concat(dataToggleMove, "]")] = "startSort", _a2["click [data-toggle-visible]"] = "toggleVisibility", _a2["click [data-toggle-open]"] = "toggleOpening", _a2["click [data-toggle-select]"] = "handleSelect", _a2["mouseover [data-toggle-select]"] = "handleHover", _a2["mouseout [data-toggle-select]"] = "handleHoverOut", _a2["dblclick [data-name]"] = "handleEdit", _a2["keydown [data-name]"] = "handleEditKey", _a2["focusout [data-name]"] = "handleEditEnd", _a2;
    };
    ItemView2.prototype.template = function(model) {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx, config2 = _a2.config, clsNoEdit = _a2.clsNoEdit, module = _a2.module, opt = _a2.opt, em = _a2.em;
      var hidable = config2.hidable;
      var count = module.getComponents(model).length;
      var addClass = !count ? this.clsNoChild : "";
      var clsTitle = "".concat(this.clsTitle, " ").concat(addClass);
      var clsTitleC = "".concat(this.clsTitleC);
      var clsInput = "".concat(this.inputNameCls, " ").concat(clsNoEdit, " ").concat(ppfx, "no-app");
      var level = opt.level || 0;
      var gut = "".concat(level * 10, "px");
      var name = model.getName();
      var icon = model.getIcon();
      var clsBase = "".concat(pfx, "layer");
      var icons = (em === null || em === void 0 ? void 0 : em.getConfig()).icons;
      var _b = icons, move = _b.move, eye = _b.eye, eyeOff = _b.eyeOff, chevron = _b.chevron;
      return '\n      <div class="'.concat(pfx, "layer-item ").concat(ppfx, 'one-bg" data-toggle-select>\n        <div class="').concat(pfx, 'layer-item-left">\n          ').concat(hidable ? '<i class="'.concat(pfx, 'layer-vis" data-toggle-visible>\n                <i class="').concat(pfx, 'layer-vis-on">').concat(eye, '</i>\n                <i class="').concat(pfx, 'layer-vis-off">').concat(eyeOff, "</i>\n              </i>") : "", '\n          <div class="').concat(clsTitleC, '">\n            <div class="').concat(clsTitle, '" style="padding-left: ').concat(gut, '">\n              <div class="').concat(pfx, 'layer-title-inn" title="').concat(name, '">\n                <i class="').concat(this.clsCaret, '" data-toggle-open>').concat(chevron, "</i>\n                  ").concat(icon ? '<span class="'.concat(clsBase, '__icon">').concat(icon, "</span>") : "", '\n                <span class="').concat(clsInput, '" data-name>').concat(name, '</span>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="').concat(pfx, 'layer-item-right">\n          <div class="').concat(this.clsCount, '" data-count>').concat(count || "", '</div>\n          <div class="').concat(this.clsMove, '" ').concat(dataToggleMove, ">").concat(move || "", '</div>\n        </div>\n      </div>\n      <div class="').concat(this.clsChildren, '"></div>\n    ');
    };
    Object.defineProperty(ItemView2.prototype, "em", {
      get: function() {
        return this.module.em;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ItemView2.prototype, "ppfx", {
      get: function() {
        return this.em.getConfig().stylePrefix;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(ItemView2.prototype, "pfx", {
      get: function() {
        return this.config.stylePrefix;
      },
      enumerable: false,
      configurable: true
    });
    ItemView2.prototype.initComponent = function() {
      var _this = this;
      var _a2 = this, model = _a2.model, config2 = _a2.config;
      var onInit = config2.onInit;
      var components = model.components();
      this.listenTo(components, "remove add reset", this.checkChildren);
      [
        ["change:status", this.updateStatus],
        ["change:open", this.updateOpening],
        ["change:layerable", this.updateLayerable],
        ["change:style:display", this.updateVisibility],
        ["change:draggable", this.updateMove],
        ["rerender:layer", this.render],
        ["change:name change:custom-name", this.updateName]
        // @ts-ignore
      ].forEach(function(item) {
        return _this.listenTo(model, item[0], item[1]);
      });
      this.$el.data("model", model);
      this.$el.data("collection", components);
      model.viewLayer = this;
      onInit.bind(this)({
        component: model,
        render: this.__render,
        listenTo: this.listenTo
      });
    };
    ItemView2.prototype.updateName = function() {
      this.getInputName().innerText = this.model.getName();
    };
    ItemView2.prototype.getVisibilityEl = function() {
      return this.getItemContainer().find("[data-toggle-visible]");
    };
    ItemView2.prototype.updateVisibility = function() {
      var _a2 = this, pfx = _a2.pfx, model = _a2.model, module = _a2.module;
      var hClass = "".concat(pfx, "layer-hidden");
      var hidden = !module.isVisible(model);
      var method = hidden ? "addClass" : "removeClass";
      this.$el[method](hClass);
      this.getVisibilityEl()[method]("".concat(pfx, "layer-off"));
    };
    ItemView2.prototype.updateMove = function() {
      var _a2 = this, model = _a2.model, config2 = _a2.config;
      var el = this.getItemContainer().find("[".concat(dataToggleMove, "]"))[0];
      if (el) {
        var isDraggable = model.get("draggable") && config2.sortable;
        el.style.display = isDraggable ? "" : "none";
      }
    };
    ItemView2.prototype.toggleVisibility = function(ev) {
      ev === null || ev === void 0 ? void 0 : ev.stopImmediatePropagation();
      var _a2 = this, module = _a2.module, model = _a2.model;
      module.setVisible(model, !module.isVisible(model));
    };
    ItemView2.prototype.handleEdit = function(ev) {
      ev === null || ev === void 0 ? void 0 : ev.stopPropagation();
      var _a2 = this, em = _a2.em, $el = _a2.$el, clsNoEdit = _a2.clsNoEdit, clsEdit = _a2.clsEdit;
      var inputEl = this.getInputName();
      inputEl[ItemView_inputProp] = "true";
      inputEl.focus();
      document.execCommand("selectAll", false);
      em.setEditing(true);
      $el.find(".".concat(this.inputNameCls)).removeClass(clsNoEdit).addClass(clsEdit);
    };
    ItemView2.prototype.handleEditKey = function(ev) {
      ev.stopPropagation();
      ((0, dom.v$)(ev) || (0, dom.Ci)(ev)) && this.handleEditEnd(ev);
    };
    ItemView2.prototype.handleEditEnd = function(ev) {
      ev === null || ev === void 0 ? void 0 : ev.stopPropagation();
      var _a2 = this, em = _a2.em, $el = _a2.$el, clsNoEdit = _a2.clsNoEdit, clsEdit = _a2.clsEdit, model = _a2.model;
      var inputEl = this.getInputName();
      var name = inputEl.textContent;
      inputEl.scrollLeft = 0;
      inputEl[ItemView_inputProp] = "false";
      model.setName(name);
      em.setEditing(false);
      $el.find(".".concat(this.inputNameCls)).addClass(clsNoEdit).removeClass(clsEdit);
      this.updateName();
    };
    ItemView2.prototype.getInputName = function() {
      if (!this.inputName) {
        this.inputName = this.el.querySelector(".".concat(this.inputNameCls));
      }
      return this.inputName;
    };
    ItemView2.prototype.updateOpening = function() {
      var _a2 = this, $el = _a2.$el, model = _a2.model, pfx = _a2.pfx;
      var clsOpen = "open";
      var clsChvOpen = "".concat(pfx, "layer-open");
      var caret = this.getCaret();
      if (this.module.isOpen(model)) {
        $el.addClass(clsOpen);
        caret.addClass(clsChvOpen);
      } else {
        $el.removeClass(clsOpen);
        caret.removeClass(clsChvOpen);
      }
    };
    ItemView2.prototype.toggleOpening = function(ev) {
      var _a2 = this, model = _a2.model, module = _a2.module;
      ev === null || ev === void 0 ? void 0 : ev.stopImmediatePropagation();
      if (!model.get("components").length)
        return;
      module.setOpen(model, !module.isOpen(model));
    };
    ItemView2.prototype.handleSelect = function(event) {
      event === null || event === void 0 ? void 0 : event.stopPropagation();
      var _a2 = this, module = _a2.module, model = _a2.model;
      module.setLayerData(model, { selected: true }, { event });
    };
    ItemView2.prototype.handleHover = function(ev) {
      ev === null || ev === void 0 ? void 0 : ev.stopPropagation();
      var _a2 = this, module = _a2.module, model = _a2.model;
      module.setLayerData(model, { hovered: true });
    };
    ItemView2.prototype.handleHoverOut = function(ev) {
      ev === null || ev === void 0 ? void 0 : ev.stopPropagation();
      var _a2 = this, module = _a2.module, model = _a2.model;
      module.setLayerData(model, { hovered: false });
    };
    ItemView2.prototype.startSort = function(ev) {
      var _a2, _b, _c;
      ev.stopPropagation();
      var _d = this, em = _d.em, sorter = _d.sorter, model = _d.model;
      if (ev.button && ev.button !== 0)
        return;
      if (sorter) {
        var toMove = ((_b = (_a2 = model.delegate) === null || _a2 === void 0 ? void 0 : _a2.move) === null || _b === void 0 ? void 0 : _b.call(_a2, model)) || model;
        sorter.onStart = getOnComponentDragStart(em);
        sorter.onMoveClb = getOnComponentDrag(em);
        sorter.onEndMove = getOnComponentDragEnd(em, [toMove]);
        var itemEl = ((_c = toMove.viewLayer) === null || _c === void 0 ? void 0 : _c.el) || ev.target;
        sorter.startSort(itemEl);
      }
    };
    ItemView2.prototype.updateStatus = function() {
      view_ComponentView.prototype.updateStatus.apply(this, [
        {
          avoidHover: !this.config.highlightHover,
          noExtHl: true
        }
      ]);
    };
    ItemView2.prototype.getItemContainer = function() {
      return this.$el.children("[data-toggle-select]");
    };
    ItemView2.prototype.checkChildren = function() {
      var _a2 = this, model = _a2.model, clsNoChild = _a2.clsNoChild, module = _a2.module;
      var count = module.getComponents(model).length;
      var itemEl = this.getItemContainer();
      var title = itemEl.find(".".concat(this.clsTitle));
      var countEl = itemEl.find("[data-count]");
      title[count ? "removeClass" : "addClass"](clsNoChild);
      countEl.html("".concat(count || ""));
      !count && module.setOpen(model, false);
    };
    ItemView2.prototype.getCaret = function() {
      if (!this.caret || !this.caret.length) {
        this.caret = this.getItemContainer().find(".".concat(this.clsCaret));
      }
      return this.caret;
    };
    ItemView2.prototype.setRoot = function(cmp) {
      var _a2;
      var model = (0, index_all.isString)(cmp) ? (_a2 = this.em.getWrapper()) === null || _a2 === void 0 ? void 0 : _a2.find(cmp)[0] : cmp;
      if (!model)
        return;
      this.stopListening();
      this.model = model;
      this.initComponent();
      this._rendered && this.render();
    };
    ItemView2.prototype.updateLayerable = function() {
      var parentView = this.parentView;
      var toRerender = parentView || this;
      toRerender.render();
    };
    ItemView2.prototype.__clearItems = function() {
      var _a2;
      (_a2 = this.items) === null || _a2 === void 0 ? void 0 : _a2.remove();
    };
    ItemView2.prototype.remove = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      common.Ss.prototype.remove.apply(this, args);
      delete this.model.viewLayer;
      this.__clearItems();
      return this;
    };
    ItemView2.prototype.render = function() {
      var _a2 = this, model = _a2.model, config2 = _a2.config, pfx = _a2.pfx, ppfx = _a2.ppfx, opt = _a2.opt, sorter = _a2.sorter;
      this.__clearItems();
      var opened = opt.opened, module = opt.module, ItemView3 = opt.ItemView;
      var hidden = !module.__isLayerable(model);
      var el = this.$el.empty();
      var level = opt.level + 1;
      delete this.inputName;
      this.items = new view_ItemsView({
        ItemView: ItemView3,
        collection: model.get("components"),
        config: config2,
        sorter,
        opened,
        parentView: this,
        parent: model,
        level,
        module
      });
      var children = this.items.render().$el;
      if (!config2.showWrapper && level === 1) {
        el.append(children);
      } else {
        el.html(this.template(model));
        el.find(".".concat(this.clsChildren)).append(children);
      }
      !module.isVisible(model) && (this.className += " ".concat(pfx, "hide"));
      hidden && (this.className += " ".concat(ppfx, "hidden"));
      el.attr("class", this.className);
      this.updateStatus();
      this.updateOpening();
      this.updateVisibility();
      this.updateMove();
      this.__render();
      this._rendered = true;
      return this;
    };
    ItemView2.prototype.__render = function() {
      var _a2 = this, model = _a2.model, config2 = _a2.config, el = _a2.el;
      var onRender = config2.onRender;
      var opt = { component: model, el };
      onRender.bind(this)(opt);
      this.em.trigger("layer:render", opt);
    };
    return ItemView2;
  }(common.Ss)
);
var view_ItemView = ItemView;
var navigator_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var navigator_assign = function() {
  navigator_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return navigator_assign.apply(this, arguments);
};
var navigator_evAll = "layer";
var navigator_evPfx = "".concat(navigator_evAll, ":");
var evRoot = "".concat(navigator_evPfx, "root");
var evComponent = "".concat(navigator_evPfx, "component");
var navigator_evCustom = "".concat(navigator_evPfx, "custom");
var events = {
  all: navigator_evAll,
  root: evRoot,
  component: evComponent,
  custom: navigator_evCustom
};
var styleOpts = { mediaText: "" };
var propsToListen = ["open", "status", "locked", "custom-name", "components", "classes"].map(function(p) {
  return "".concat(dom_components_types.I.update, ":").concat(p);
}).join(" ");
var isStyleHidden = function(style) {
  if (style === void 0) {
    style = {};
  }
  return (style.display || "").trim().indexOf("none") === 0;
};
var LayerManager = (
  /** @class */
  function(_super) {
    navigator_extends(LayerManager2, _super);
    function LayerManager2(em) {
      var _this = _super.call(this, em, "LayerManager", navigator_config_config) || this;
      _this.events = events;
      (0, index_all.bindAll)(_this, "componentChanged", "__onRootChange", "__onComponent");
      _this.model = new ModuleModel.A(_this, { opened: {} });
      _this.config.stylePrefix = _this.config.pStylePrefix;
      return _this;
    }
    LayerManager2.prototype.onLoad = function() {
      var _this = this;
      var _a2 = this, em = _a2.em, config2 = _a2.config, model = _a2.model;
      model.listenTo(em, "component:selected", this.componentChanged);
      model.on("change:root", this.__onRootChange);
      model.listenTo(em, propsToListen, this.__onComponent);
      this.componentChanged();
      model.listenToOnce(em, "load", function() {
        _this.setRoot(config2.root);
        _this.__appendTo();
      });
    };
    LayerManager2.prototype.setRoot = function(component) {
      var wrapper = this.em.getWrapper();
      var root = (0, mixins.isComponent)(component) ? component : wrapper;
      if (component && (0, index_all.isString)(component) && (0, mixins.hasWin)()) {
        root = wrapper.find(component)[0] || wrapper;
      }
      var result = this.__getLayerFromComponent(root);
      this.model.set("root", result);
      return result;
    };
    LayerManager2.prototype.getRoot = function() {
      return this.model.get("root");
    };
    LayerManager2.prototype.getComponents = function(component) {
      var _this = this;
      return component.components().map(function(cmp) {
        return _this.__getLayerFromComponent(cmp);
      }).filter(function(cmp) {
        return _this.__isLayerable(cmp);
      });
    };
    LayerManager2.prototype.setOpen = function(component, value) {
      component.set("open", value);
    };
    LayerManager2.prototype.isOpen = function(component) {
      return !!component.get("open");
    };
    LayerManager2.prototype.setVisible = function(component, value) {
      var prevDspKey = "__prev-display";
      var style = component.getStyle(styleOpts);
      var display = style.display;
      if (value) {
        var prevDisplay = component.get(prevDspKey);
        delete style.display;
        if (prevDisplay) {
          style.display = prevDisplay;
          component.unset(prevDspKey);
        }
      } else {
        display && component.set(prevDspKey, display);
        style.display = "none";
      }
      component.setStyle(style, styleOpts);
      this.updateLayer(component);
      this.em.trigger("component:toggled");
    };
    LayerManager2.prototype.isVisible = function(component) {
      return !isStyleHidden(component.getStyle(styleOpts));
    };
    LayerManager2.prototype.setLocked = function(component, value) {
      component.set("locked", value);
    };
    LayerManager2.prototype.isLocked = function(component) {
      return !!component.get("locked");
    };
    LayerManager2.prototype.setName = function(component, value) {
      component.set("custom-name", value);
    };
    LayerManager2.prototype.getName = function(component) {
      return component.getName();
    };
    LayerManager2.prototype.getLayerData = function(component) {
      var status = component.get("status");
      return {
        name: component.getName(),
        open: this.isOpen(component),
        selected: status === "selected",
        hovered: status === "hovered",
        // || this.em.getHovered() === component,
        visible: this.isVisible(component),
        locked: this.isLocked(component),
        components: this.getComponents(component)
      };
    };
    LayerManager2.prototype.setLayerData = function(component, data, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = this, em = _b.em, config2 = _b.config;
      var open = data.open, selected = data.selected, hovered = data.hovered, visible = data.visible, locked = data.locked, name = data.name;
      var cmpOpts = navigator_assign({ fromLayers: true }, opts);
      if ((0, mixins.isDef)(open)) {
        this.setOpen(component, open);
      }
      if ((0, mixins.isDef)(selected)) {
        if (selected) {
          em.setSelected(component, cmpOpts);
          var scroll_1 = config2.scrollCanvas;
          scroll_1 && ((_a2 = component.views) === null || _a2 === void 0 ? void 0 : _a2.forEach(function(view) {
            return view.scrollIntoView(scroll_1);
          }));
        } else {
          em.removeSelected(component, cmpOpts);
        }
      }
      if ((0, mixins.isDef)(hovered) && config2.showHover) {
        hovered ? em.setHovered(component, cmpOpts) : em.setHovered(null, cmpOpts);
      }
      if ((0, mixins.isDef)(visible)) {
        visible !== this.isVisible(component) && this.setVisible(component, visible);
      }
      if ((0, mixins.isDef)(locked)) {
        this.setLocked(component, locked);
      }
      if ((0, mixins.isDef)(name)) {
        this.setName(component, name);
      }
    };
    LayerManager2.prototype.componentChanged = function(sel, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      if (opts.fromLayers)
        return;
      var _b = this, em = _b.em, config2 = _b.config;
      var scrollLayers = config2.scrollLayers;
      var opened = this.model.get("opened");
      var selected = em.getSelected();
      var parent = selected === null || selected === void 0 ? void 0 : selected.parent();
      for (var cid in opened) {
        opened[cid].set("open", false);
        delete opened[cid];
      }
      while (parent) {
        parent.set("open", true);
        opened[parent.cid] = parent;
        parent = parent.parent();
      }
      if (selected && scrollLayers) {
        var el = (_a2 = selected.viewLayer) === null || _a2 === void 0 ? void 0 : _a2.el;
        el === null || el === void 0 ? void 0 : el.scrollIntoView(scrollLayers);
      }
    };
    LayerManager2.prototype.getAll = function() {
      return this.view;
    };
    LayerManager2.prototype.render = function() {
      var _a2, _b;
      var _c = this, config2 = _c.config, model = _c.model;
      var ItemView2 = view_ItemView.extend(config2.extend);
      this.view = new ItemView2({
        el: (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.el,
        ItemView: ItemView2,
        level: 0,
        config: config2,
        opened: model.get("opened"),
        model: this.getRoot(),
        module: this
      });
      return (_b = this.view) === null || _b === void 0 ? void 0 : _b.render().el;
    };
    LayerManager2.prototype.destroy = function() {
      var _a2;
      (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.remove();
    };
    LayerManager2.prototype.__onRootChange = function() {
      var _a2;
      var root = this.getRoot();
      (_a2 = this.view) === null || _a2 === void 0 ? void 0 : _a2.setRoot(root);
      this.em.trigger(evRoot, root);
      this.__trgCustom();
    };
    LayerManager2.prototype.__getLayerFromComponent = function(cmp) {
      var _a2, _b;
      return ((_b = (_a2 = cmp.delegate) === null || _a2 === void 0 ? void 0 : _a2.layer) === null || _b === void 0 ? void 0 : _b.call(_a2, cmp)) || cmp;
    };
    LayerManager2.prototype.__onComponent = function(component) {
      this.updateLayer(component);
    };
    LayerManager2.prototype.__isLayerable = function(cmp) {
      var tag = cmp.tagName;
      var hideText = this.config.hideTextnode;
      var isValid = !hideText || !cmp.isInstanceOf("textnode") && tag !== "br";
      return isValid && cmp.get("layerable");
    };
    LayerManager2.prototype.__trgCustom = function(opts) {
      var _a2 = this, __ctn = _a2.__ctn, em = _a2.em, events2 = _a2.events;
      this.__ctn = __ctn || (opts === null || opts === void 0 ? void 0 : opts.container);
      em.trigger(events2.custom, {
        container: this.__ctn,
        root: this.getRoot()
      });
    };
    LayerManager2.prototype.updateLayer = function(component, opts) {
      this.em.trigger(evComponent, component, opts);
    };
    return LayerManager2;
  }(abstract_Module)
);
var src_navigator = LayerManager;
var asset_manager_config_config_config = {
  assets: [],
  noAssets: "",
  stylePrefix: "am-",
  upload: "",
  uploadName: "files",
  headers: {},
  params: {},
  credentials: "include",
  multiUpload: true,
  multiUploadSuffix: "[]",
  autoAdd: true,
  customFetch: void 0,
  uploadFile: void 0,
  embedAsBase64: true,
  handleAdd: void 0,
  beforeUpload: void 0,
  showUrlInput: true,
  custom: false,
  dropzone: false,
  openAssetsOnDrop: true,
  dropzoneContent: ""
};
var asset_manager_config_config = asset_manager_config_config_config;
var Asset_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Asset = (
  /** @class */
  function(_super) {
    Asset_extends(Asset2, _super);
    function Asset2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Asset2.getDefaults = function() {
      return (0, index_all.result)(this.prototype, "defaults");
    };
    Asset2.prototype.defaults = function() {
      return {
        type: "",
        src: ""
      };
    };
    Asset2.prototype.getType = function() {
      return this.get("type");
    };
    Asset2.prototype.getSrc = function() {
      return this.get("src");
    };
    Asset2.prototype.getFilename = function() {
      return this.get("src").split("/").pop().split("?").shift();
    };
    Asset2.prototype.getExtension = function() {
      return this.getFilename().split(".").pop();
    };
    return Asset2;
  }(common.Kx)
);
var model_Asset = Asset;
Asset.prototype.idAttribute = "src";
var AssetImage_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var AssetImage_assign = function() {
  AssetImage_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return AssetImage_assign.apply(this, arguments);
};
var AssetImage = (
  /** @class */
  function(_super) {
    AssetImage_extends(AssetImage2, _super);
    function AssetImage2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    AssetImage2.prototype.defaults = function() {
      return AssetImage_assign(AssetImage_assign({}, model_Asset.getDefaults()), { type: "image", unitDim: "px", height: 0, width: 0 });
    };
    return AssetImage2;
  }(model_Asset)
);
var model_AssetImage = AssetImage;
var AssetView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var AssetView = (
  /** @class */
  function(_super) {
    AssetView_extends(AssetView2, _super);
    function AssetView2(opt) {
      var _this = _super.call(this, opt) || this;
      _this.options = opt;
      _this.collection = opt.collection;
      var config2 = opt.config || {};
      _this.config = config2;
      _this.pfx = config2.stylePrefix || "";
      _this.ppfx = config2.pStylePrefix || "";
      _this.em = config2.em;
      _this.className = _this.pfx + "asset";
      _this.listenTo(_this.model, "destroy remove", _this.remove);
      _this.model.view = _this;
      var init = _this.init && _this.init.bind(_this);
      init && init(opt);
      return _this;
    }
    AssetView2.prototype.__getBhv = function() {
      var em = this.em;
      var am = em === null || em === void 0 ? void 0 : em.Assets;
      return (am === null || am === void 0 ? void 0 : am.__getBehaviour()) || {};
    };
    AssetView2.prototype.template = function(view, asset) {
      var pfx = this.pfx;
      return '\n      <div class="'.concat(pfx, 'preview-cont">\n        ').concat(this.getPreview(), '\n      </div>\n      <div class="').concat(pfx, 'meta">\n        ').concat(this.getInfo(), '\n      </div>\n      <div class="').concat(pfx, 'close" data-toggle="asset-remove">\n        &Cross;\n      </div>\n    ');
    };
    AssetView2.prototype.updateTarget = function(target) {
      if (target && target.set) {
        target.set("attributes", (0, index_all.clone)(target.get("attributes")));
        target.set("src", this.model.get("src"));
      }
    };
    AssetView2.prototype.getPreview = function() {
      return "";
    };
    AssetView2.prototype.getInfo = function() {
      return "";
    };
    AssetView2.prototype.render = function() {
      var el = this.el;
      el.innerHTML = this.template(this, this.model);
      el.className = this.className;
      return this;
    };
    return AssetView2;
  }(common.Ss)
);
var view_AssetView = AssetView;
var AssetImageView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var AssetImageView_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var AssetImageView = (
  /** @class */
  function(_super) {
    AssetImageView_extends(AssetImageView2, _super);
    function AssetImageView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    AssetImageView2.prototype.getPreview = function() {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx, model = _a2.model;
      var src2 = model.get("src");
      return html(AssetImageView_templateObject_1 || (AssetImageView_templateObject_1 = AssetImageView_makeTemplateObject(['\n      <div class="', `preview" style="background-image: url('`, `');"></div>
      <div class="`, "preview-bg ", 'checker-bg"></div>\n    '], ['\n      <div class="', `preview" style="background-image: url('`, `');"></div>
      <div class="`, "preview-bg ", 'checker-bg"></div>\n    '])), pfx, src2, pfx, ppfx);
    };
    AssetImageView2.prototype.getInfo = function() {
      var _a2 = this, pfx = _a2.pfx, model = _a2.model;
      var name = model.get("name");
      var width = model.get("width");
      var height = model.get("height");
      var unit = model.get("unitDim");
      var dim = width && height ? "".concat(width, "x").concat(height).concat(unit) : "";
      name = name || model.getFilename();
      return html(AssetImageView_templateObject_2 || (AssetImageView_templateObject_2 = AssetImageView_makeTemplateObject(['\n      <div class="', 'name">', '</div>\n      <div class="', 'dimensions">', "</div>\n    "], ['\n      <div class="', 'name">', '</div>\n      <div class="', 'dimensions">', "</div>\n    "])), pfx, name, pfx, dim);
    };
    AssetImageView2.prototype.init = function(o) {
      var pfx = this.pfx;
      this.className += " ".concat(pfx, "asset-image");
    };
    AssetImageView2.prototype.onClick = function() {
      var _a2 = this, model = _a2.model, pfx = _a2.pfx;
      var select = this.__getBhv().select;
      var onClick = this.config.onClick;
      var coll = this.collection;
      coll.trigger("deselectAll");
      this.$el.addClass(pfx + "highlight");
      if ((0, index_all.isFunction)(select)) {
        select(model, false);
      } else if ((0, index_all.isFunction)(onClick)) {
        onClick(model);
      } else {
        this.updateTarget(coll.target);
      }
    };
    AssetImageView2.prototype.onDblClick = function() {
      var _a2 = this, em = _a2.em, model = _a2.model;
      var select = this.__getBhv().select;
      var onDblClick = this.config.onDblClick;
      var _b = this.collection, target = _b.target, onSelect = _b.onSelect;
      if ((0, index_all.isFunction)(select)) {
        select(model, true);
      } else if ((0, index_all.isFunction)(onDblClick)) {
        onDblClick(model);
      } else {
        this.updateTarget(target);
        em === null || em === void 0 ? void 0 : em.Modal.close();
      }
      (0, index_all.isFunction)(onSelect) && onSelect(model);
    };
    AssetImageView2.prototype.onRemove = function(e) {
      e.stopImmediatePropagation();
      this.model.collection.remove(this.model);
    };
    return AssetImageView2;
  }(view_AssetView)
);
var view_AssetImageView = AssetImageView;
AssetImageView.prototype.events = {
  // @ts-ignore
  "click [data-toggle=asset-remove]": "onRemove",
  click: "onClick",
  dblclick: "onDblClick"
};
var AssetImageView_templateObject_1;
var AssetImageView_templateObject_2;
var TypeableCollection_assign = function() {
  TypeableCollection_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return TypeableCollection_assign.apply(this, arguments);
};
var TypeableCollection = {
  types: [],
  initialize: function(models, opts) {
    var _this = this;
    if (opts === void 0) {
      opts = {};
    }
    var em = opts.em;
    this.em = em;
    this.opts = opts;
    this.model = function(attrs, options) {
      if (attrs === void 0) {
        attrs = {};
      }
      if (options === void 0) {
        options = {};
      }
      var Model, View, type2;
      if (attrs && attrs.type) {
        var baseType = _this.getBaseType();
        type2 = _this.getType(attrs.type);
        Model = type2 ? type2.model : baseType.model;
        View = type2 ? type2.view : baseType.view;
      } else {
        var typeFound = _this.recognizeType(attrs);
        type2 = typeFound.type;
        Model = type2.model;
        View = type2.view;
        attrs = typeFound.attributes;
      }
      var model = new Model(attrs, TypeableCollection_assign(TypeableCollection_assign({}, options), { em }));
      model.typeView = View;
      _this.model.prototype = Model.prototype;
      return model;
    };
    var init = this.init && this.init.bind(this);
    init && init();
  },
  /**
   * Recognize type by any value
   * @param  {mixed} value
   * @return {Object} Found type
   */
  recognizeType: function(value) {
    var types2 = this.getTypes();
    for (var i = 0; i < types2.length; i++) {
      var type2 = types2[i];
      var typeFound = type2.isType(value);
      typeFound = typeof typeFound == "boolean" && typeFound ? { type: type2.id } : typeFound;
      if (typeFound) {
        return {
          type: type2,
          attributes: typeFound
        };
      }
    }
    return {
      type: this.getBaseType(),
      attributes: value
    };
  },
  /**
   * Returns the base type (last object in the stack)
   * @return {Object}
   */
  getBaseType: function() {
    var types2 = this.getTypes();
    return types2[types2.length - 1];
  },
  /**
   * Get types
   * @return {Array}
   */
  getTypes: function() {
    return this.types;
  },
  /**
   * Get type
   * @param {string} id Type ID
   * @return {Object} Type definition
   */
  getType: function(id) {
    var types2 = this.getTypes();
    for (var i = 0; i < types2.length; i++) {
      var type2 = types2[i];
      if (type2.id === id) {
        return type2;
      }
    }
  },
  /**
   * Add new type
   * @param {string} id Type ID
   * @param {Object} definition Definition of the type. Each definition contains
   *                            `model` (business logic), `view` (presentation logic)
   *                            and `isType` function which recognize the type of the
   *                            passed entity
   * addType('my-type', {
   *  model: {},
   *  view: {},
   *  isType: (value) => {},
   * })
   */
  addType: function(id, definition) {
    var type2 = this.getType(id);
    var baseType = this.getBaseType();
    var ModelInst = type2 ? type2.model : baseType.model;
    var ViewInst = type2 ? type2.view : baseType.view;
    var model = definition.model, view = definition.view, isType = definition.isType;
    model = model instanceof common.Kx || (0, index_all.isFunction)(model) ? model : ModelInst.extend(model || {});
    view = view instanceof common.Ss || (0, index_all.isFunction)(view) ? view : ViewInst.extend(view || {});
    if (this.extendViewApi && !definition.model && !definition.view) {
      view = view.extend(definition);
    }
    if (type2) {
      type2.model = model;
      type2.view = view;
      type2.isType = isType || type2.isType;
    } else {
      definition.id = id;
      definition.model = model;
      definition.view = view;
      definition.isType = isType || function(value) {
        if (value && value.type == id) {
          return true;
        }
      };
      this.getTypes().unshift(definition);
    }
  }
};
var model_TypeableCollection = TypeableCollection;
var Assets_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var TypeableCollectionExt = common.pM.extend(model_TypeableCollection);
var Assets = (
  /** @class */
  function(_super) {
    Assets_extends(Assets2, _super);
    function Assets2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    return Assets2;
  }(TypeableCollectionExt)
);
var model_Assets = Assets;
Assets.prototype.types = [
  {
    id: "image",
    model: model_AssetImage,
    view: view_AssetImageView,
    isType: function(value) {
      if (typeof value == "string") {
        return {
          type: "image",
          src: value
        };
      }
      return value;
    }
  }
];
var AssetsEvents;
(function(AssetsEvents2) {
  AssetsEvents2["add"] = "asset:add";
  AssetsEvents2["remove"] = "asset:remove";
  AssetsEvents2["removeBefore"] = "asset:remove:before";
  AssetsEvents2["update"] = "asset:update";
  AssetsEvents2["open"] = "asset:open";
  AssetsEvents2["close"] = "asset:close";
  AssetsEvents2["uploadStart"] = "asset:upload:start";
  AssetsEvents2["uploadEnd"] = "asset:upload:end";
  AssetsEvents2["uploadError"] = "asset:upload:error";
  AssetsEvents2["uploadResponse"] = "asset:upload:response";
  AssetsEvents2["custom"] = "asset:custom";
  AssetsEvents2["all"] = "asset";
})(AssetsEvents || (AssetsEvents = {}));
var asset_manager_types = AssetsEvents;
var AssetsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var AssetsView = (
  /** @class */
  function(_super) {
    AssetsView_extends(AssetsView2, _super);
    function AssetsView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      _this.options = o;
      _this.config = o.config;
      _this.pfx = _this.config.stylePrefix || "";
      _this.ppfx = _this.config.pStylePrefix || "";
      _this.em = _this.config.em;
      var coll = _this.collection;
      _this.listenTo(coll, "reset", _this.renderAssets);
      _this.listenTo(coll, "add", _this.addToAsset);
      _this.listenTo(coll, "remove", _this.removedAsset);
      _this.listenTo(coll, "deselectAll", _this.deselectAll);
      return _this;
    }
    AssetsView2.prototype.template = function(_a2) {
      var pfx = _a2.pfx, ppfx = _a2.ppfx, em = _a2.em;
      var form = "";
      if (this.config.showUrlInput) {
        form = '\n          <form class="'.concat(pfx, 'add-asset">\n            <div class="').concat(ppfx, "field ").concat(pfx, 'add-field">\n              <input placeholder="').concat(em === null || em === void 0 ? void 0 : em.t("assetManager.inputPlh"), '"/>\n            </div>\n            <button class="').concat(ppfx, 'btn-prim">').concat(em === null || em === void 0 ? void 0 : em.t("assetManager.addButton"), '</button>\n            <div style="clear:both"></div>\n          </form>\n      ');
      }
      return '\n    <div class="'.concat(pfx, 'assets-cont">\n      <div class="').concat(pfx, 'assets-header">\n        ').concat(form, '\n      </div>\n      <div class="').concat(pfx, 'assets" data-el="assets"></div>\n      <div style="clear:both"></div>\n    </div>\n    ');
    };
    AssetsView2.prototype.handleSubmit = function(ev) {
      ev.preventDefault();
      var input = this.getAddInput();
      var url = input && input.value.trim();
      var handleAdd = this.config.handleAdd;
      if (!url) {
        return;
      }
      input.value = "";
      var assetsEl = this.getAssetsEl();
      if (assetsEl) {
        assetsEl.scrollTop = 0;
      }
      if (handleAdd) {
        handleAdd.bind(this)(url);
      } else {
        this.options.globalCollection.add(url, { at: 0 });
      }
    };
    AssetsView2.prototype.getAssetsEl = function() {
      return this.el.querySelector(".".concat(this.pfx, "assets"));
    };
    AssetsView2.prototype.getAddInput = function() {
      if (!this.inputUrl || !this.inputUrl.value) {
        this.inputUrl = this.el.querySelector(".".concat(this.pfx, "add-asset input"));
      }
      return this.inputUrl;
    };
    AssetsView2.prototype.removedAsset = function(model) {
      if (!this.collection.length) {
        this.toggleNoAssets();
      }
    };
    AssetsView2.prototype.addToAsset = function(model) {
      if (this.collection.length == 1) {
        this.toggleNoAssets(true);
      }
      this.addAsset(model);
    };
    AssetsView2.prototype.addAsset = function(model, fragmentEl) {
      if (fragmentEl === void 0) {
        fragmentEl = null;
      }
      var fragment = fragmentEl;
      var collection = this.collection;
      var config2 = this.config;
      var rendered = new model.typeView({
        model,
        collection,
        config: config2
      }).render().el;
      if (fragment) {
        fragment.appendChild(rendered);
      } else {
        var assetsEl = this.getAssetsEl();
        if (assetsEl) {
          assetsEl.insertBefore(rendered, assetsEl.firstChild);
        }
      }
      return rendered;
    };
    AssetsView2.prototype.toggleNoAssets = function(hide) {
      if (hide === void 0) {
        hide = false;
      }
      var assetsEl = this.$el.find(".".concat(this.pfx, "assets"));
      if (hide) {
        assetsEl.empty();
      } else {
        var noAssets = this.config.noAssets;
        noAssets && assetsEl.append(noAssets);
      }
    };
    AssetsView2.prototype.deselectAll = function() {
      var pfx = this.pfx;
      this.$el.find(".".concat(pfx, "highlight")).removeClass("".concat(pfx, "highlight"));
    };
    AssetsView2.prototype.renderAssets = function() {
      var _this = this;
      var fragment = document.createDocumentFragment();
      var assets = this.$el.find(".".concat(this.pfx, "assets"));
      assets.empty();
      this.toggleNoAssets(!!this.collection.length);
      this.collection.each(function(model) {
        return _this.addAsset(model, fragment);
      });
      assets.append(fragment);
    };
    AssetsView2.prototype.render = function() {
      var fuRendered = this.options.fu.render().el;
      this.$el.empty();
      this.$el.append(fuRendered).append(this.template(this));
      this.el.className = "".concat(this.ppfx, "asset-manager");
      this.renderAssets();
      return this;
    };
    return AssetsView2;
  }(common.Ss)
);
var view_AssetsView = AssetsView;
AssetsView.prototype.events = {
  // @ts-ignore
  submit: "handleSubmit"
};
var FileUploader_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var FileUploader_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var FileUploaderView = (
  /** @class */
  function(_super) {
    FileUploader_extends(FileUploaderView2, _super);
    function FileUploaderView2(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, opts) || this;
      _this.options = opts;
      var c = opts.config || {};
      _this.module = opts.module;
      _this.config = c;
      _this.em = _this.config.em;
      _this.pfx = c.stylePrefix || "";
      _this.ppfx = c.pStylePrefix || "";
      _this.target = _this.options.globalCollection || {};
      _this.uploadId = _this.pfx + "uploadFile";
      _this.disabled = c.disableUpload !== void 0 ? c.disableUpload : !c.upload && !c.embedAsBase64;
      _this.multiUpload = c.multiUpload !== void 0 ? c.multiUpload : true;
      var uploadFile = c.uploadFile;
      if (uploadFile) {
        _this.uploadFile = uploadFile.bind(_this);
      } else if (!c.upload && c.embedAsBase64) {
        _this.uploadFile = FileUploaderView2.embedAsBase64;
      }
      _this.delegateEvents();
      return _this;
    }
    FileUploaderView2.prototype.template = function(_a2) {
      var pfx = _a2.pfx, title = _a2.title, uploadId = _a2.uploadId, disabled = _a2.disabled, multiUpload = _a2.multiUpload;
      return html(FileUploader_templateObject_1 || (FileUploader_templateObject_1 = FileUploader_makeTemplateObject(['\n      <form>\n        <div id="', 'title">', '</div>\n        <input\n          data-input\n          type="file"\n          id="', '"\n          name="file"\n          accept="*/*"\n          ', "\n          ", '\n        />\n        <div style="clear:both;"></div>\n      </form>\n    '], ['\n      <form>\n        <div id="', 'title">', '</div>\n        <input\n          data-input\n          type="file"\n          id="', '"\n          name="file"\n          accept="*/*"\n          ', "\n          ", '\n        />\n        <div style="clear:both;"></div>\n      </form>\n    '])), pfx, title, uploadId, disabled ? "disabled" : "", multiUpload ? "multiple" : "");
    };
    FileUploaderView2.prototype.events = function() {
      return {
        "change [data-input]": "uploadFile"
      };
    };
    FileUploaderView2.prototype.onUploadStart = function() {
      var module = this.module;
      module === null || module === void 0 ? void 0 : module.__propEv(module.events.uploadStart);
    };
    FileUploaderView2.prototype.onUploadEnd = function(res) {
      var _a2 = this, $el = _a2.$el, module = _a2.module;
      module === null || module === void 0 ? void 0 : module.__propEv(module.events.uploadEnd, res);
      var input = $el.find("input");
      input && input.val("");
    };
    FileUploaderView2.prototype.onUploadError = function(err) {
      var module = this.module;
      console.error(err);
      this.onUploadEnd(err);
      module === null || module === void 0 ? void 0 : module.__propEv(module.events.uploadError, err);
    };
    FileUploaderView2.prototype.onUploadResponse = function(text, clb) {
      var _a2 = this, module = _a2.module, config2 = _a2.config, target = _a2.target;
      var json;
      try {
        json = typeof text === "string" ? JSON.parse(text) : text;
      } catch (e) {
        json = text;
      }
      module === null || module === void 0 ? void 0 : module.__propEv(module.events.uploadResponse, json);
      if (config2.autoAdd && target) {
        target.add(json.data, { at: 0 });
      }
      this.onUploadEnd(text);
      clb === null || clb === void 0 ? void 0 : clb(json);
    };
    FileUploaderView2.prototype.uploadFile = function(e, clb) {
      var _this = this;
      var files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
      var config2 = this.config;
      var beforeUpload = config2.beforeUpload;
      var beforeUploadResponse = beforeUpload && beforeUpload(files);
      if (beforeUploadResponse === false)
        return;
      var body = new FormData();
      var params = config2.params, customFetch = config2.customFetch, fetchOptions = config2.fetchOptions;
      for (var param in params) {
        body.append(param, params[param]);
      }
      if (this.multiUpload) {
        for (var i = 0; i < files.length; i++) {
          body.append("".concat(config2.uploadName).concat(config2.multiUploadSuffix), files[i]);
        }
      } else if (files.length) {
        body.append(config2.uploadName, files[0]);
      }
      var url = config2.upload;
      var headers = config2.headers;
      var reqHead = "X-Requested-With";
      if (typeof headers[reqHead] == "undefined") {
        headers[reqHead] = "XMLHttpRequest";
      }
      if (url) {
        this.onUploadStart();
        var fetchOpts = {
          method: "post",
          credentials: config2.credentials || "include",
          headers,
          body
        };
        var fetchOptsResult = (fetchOptions === null || fetchOptions === void 0 ? void 0 : fetchOptions(fetchOpts)) || fetchOpts;
        var fetchResult = customFetch ? customFetch(url, fetchOptsResult) : utils_fetch(url, fetchOptsResult).then(function(res) {
          return (res.status / 200 | 0) == 1 ? res.text() : res.text().then(function(text) {
            return Promise.reject(text);
          });
        });
        return fetchResult.then(function(text) {
          return _this.onUploadResponse(text, clb);
        }).catch(function(err) {
          return _this.onUploadError(err);
        });
      }
    };
    FileUploaderView2.prototype.initDrop = function() {
      var that = this;
      if (!this.uploadForm) {
        this.uploadForm = this.$el.find("form").get(0);
        var formEl_1 = this.uploadForm;
        if ("draggable" in formEl_1) {
          this.uploadForm.ondragover = function() {
            formEl_1.className = that.pfx + "hover";
            return false;
          };
          this.uploadForm.ondragleave = function() {
            formEl_1.className = "";
            return false;
          };
          this.uploadForm.ondrop = function(ev) {
            formEl_1.className = "";
            ev.preventDefault();
            that.uploadFile(ev);
            return;
          };
        }
      }
    };
    FileUploaderView2.prototype.initDropzone = function(ev) {
      var _this = this;
      var addedCls = 0;
      var c = this.config;
      var em = ev.model;
      var edEl = ev.el;
      var editor = em.Editor;
      var frameEl = em.Canvas.getBody();
      var ppfx = this.ppfx;
      var updatedCls = "".concat(ppfx, "dropzone-active");
      var dropzoneCls = "".concat(ppfx, "dropzone");
      var cleanEditorElCls = function() {
        edEl.className = edEl.className.replace(updatedCls, "").trim();
        addedCls = 0;
      };
      var onDragOver = function() {
        if (!addedCls) {
          edEl.className += " ".concat(updatedCls);
          addedCls = 1;
        }
        return false;
      };
      var onDragLeave = function() {
        cleanEditorElCls();
        return false;
      };
      var onDrop = function(e) {
        cleanEditorElCls();
        e.preventDefault();
        e.stopPropagation();
        _this.uploadFile(e);
        if (c.openAssetsOnDrop && editor) {
          var target = editor.getSelected();
          editor.runCommand("open-assets", {
            target,
            onSelect: function() {
              editor.Modal.close();
              editor.AssetManager.setTarget(null);
            }
          });
        }
        return false;
      };
      ev.$el.append('<div class="'.concat(dropzoneCls, '">').concat(c.dropzoneContent, "</div>"));
      cleanEditorElCls();
      if ("draggable" in edEl) {
        [edEl, frameEl].forEach(function(item) {
          item.ondragover = onDragOver;
          item.ondragleave = onDragLeave;
          item.ondrop = onDrop;
        });
      }
    };
    FileUploaderView2.prototype.render = function() {
      var _a2 = this, $el = _a2.$el, pfx = _a2.pfx, em = _a2.em;
      $el.html(this.template({
        title: em && em.t("assetManager.uploadTitle"),
        uploadId: this.uploadId,
        disabled: this.disabled,
        multiUpload: this.multiUpload,
        pfx
      }));
      this.initDrop();
      $el.attr("class", pfx + "file-uploader");
      return this;
    };
    FileUploaderView2.embedAsBase64 = function(e, clb) {
      var _this = this;
      var files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
      var response = { data: [] };
      if (!FileReader) {
        this.onUploadError(new Error("Unsupported platform, FileReader is not defined"));
        return;
      }
      var promises = [];
      var mimeTypeMatcher = /^(.+)\/(.+)$/;
      var _loop_1 = function(file2) {
        var promise = new Promise(function(resolve2, reject2) {
          var reader = new FileReader();
          reader.addEventListener("load", function(event) {
            var type2;
            var name = file2.name;
            var match = mimeTypeMatcher.exec(file2.type);
            if (match) {
              type2 = match[1];
            } else {
              type2 = file2.type;
            }
            if (type2 === "image") {
              var data_1 = {
                src: reader.result,
                name,
                type: type2,
                height: 0,
                width: 0
              };
              var image_1 = new Image();
              image_1.addEventListener("error", function(error) {
                reject2(error);
              });
              image_1.addEventListener("load", function() {
                data_1.height = image_1.height;
                data_1.width = image_1.width;
                resolve2(data_1);
              });
              image_1.src = data_1.src;
            } else if (type2) {
              resolve2({
                src: reader.result,
                name,
                type: type2
              });
            } else {
              resolve2(reader.result);
            }
          });
          reader.addEventListener("error", function(error) {
            reject2(error);
          });
          reader.addEventListener("abort", function(error) {
            reject2("Aborted");
          });
          reader.readAsDataURL(file2);
        });
        promises.push(promise);
      };
      for (var _i = 0, files_1 = files; _i < files_1.length; _i++) {
        var file = files_1[_i];
        _loop_1(file);
      }
      return Promise.all(promises).then(function(data) {
        response.data = data;
        _this.onUploadResponse(response, clb);
      }, function(error) {
        _this.onUploadError(error);
      });
    };
    return FileUploaderView2;
  }(common.Ss)
);
var FileUploader = FileUploaderView;
var FileUploader_templateObject_1;
var asset_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var asset_manager_assign = function() {
  asset_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return asset_manager_assign.apply(this, arguments);
};
var asset_manager_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var assetCmd = "open-assets";
var AssetManager = (
  /** @class */
  function(_super) {
    asset_manager_extends(AssetManager2, _super);
    function AssetManager2(em) {
      var _this = _super.call(this, em, "AssetManager", new model_Assets([], em), asset_manager_types, asset_manager_config_config) || this;
      _this.storageKey = "assets";
      _this.Asset = model_Asset;
      _this.Assets = model_Assets;
      _this.events = asset_manager_types;
      var _a2 = _this, all = _a2.all, config2 = _a2.config;
      _this.assetsVis = new model_Assets([]);
      var ppfx = config2.pStylePrefix;
      if (ppfx) {
        config2.stylePrefix = "".concat(ppfx).concat(config2.stylePrefix);
      }
      all.on("add", function(model) {
        return _this.getAllVisible().add(model);
      });
      all.on("remove", function(model) {
        return _this.getAllVisible().remove(model);
      });
      _this.__onAllEvent = (0, index_all.debounce)(function() {
        return _this.__trgCustom();
      }, 0);
      return _this;
    }
    AssetManager2.prototype.open = function(options) {
      if (options === void 0) {
        options = {};
      }
      var cmd = this.em.Commands;
      cmd.run(assetCmd, asset_manager_assign({ types: ["image"], select: function() {
      } }, options));
    };
    AssetManager2.prototype.close = function() {
      var cmd = this.em.Commands;
      cmd.stop(assetCmd);
    };
    AssetManager2.prototype.isOpen = function() {
      var cmd = this.em.Commands;
      return !!(cmd === null || cmd === void 0 ? void 0 : cmd.isActive(assetCmd));
    };
    AssetManager2.prototype.add = function(asset, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (typeof opts.at == "undefined") {
        opts.at = 0;
      }
      return this.all.add(asset, opts);
    };
    AssetManager2.prototype.get = function(src2) {
      return this.all.where({ src: src2 })[0] || null;
    };
    AssetManager2.prototype.getAll = function() {
      return this.all;
    };
    AssetManager2.prototype.getAllVisible = function() {
      return this.assetsVis;
    };
    AssetManager2.prototype.remove = function(asset, opts) {
      return this.__remove(asset, opts);
    };
    AssetManager2.prototype.store = function() {
      return this.getProjectData();
    };
    AssetManager2.prototype.load = function(data) {
      return this.loadProjectData(data);
    };
    AssetManager2.prototype.getContainer = function() {
      var _a2;
      var bhv = this.__getBehaviour();
      return bhv.container || ((_a2 = this.am) === null || _a2 === void 0 ? void 0 : _a2.el);
    };
    AssetManager2.prototype.getAssetsEl = function() {
      var _a2;
      return (_a2 = this.am) === null || _a2 === void 0 ? void 0 : _a2.el.querySelector("[data-el=assets]");
    };
    AssetManager2.prototype.render = function(assts) {
      if (this.getConfig().custom)
        return;
      var toRender = assts || this.getAll().models;
      if (!this.am) {
        var obj = this.__viewParams();
        obj.fu = this.FileUploader();
        this.am = new view_AssetsView(asset_manager_assign({}, obj));
        this.am.render();
      }
      this.assetsVis.reset(toRender);
      return this.getContainer();
    };
    AssetManager2.prototype.__viewParams = function() {
      return {
        collection: this.assetsVis,
        // Collection visible in asset manager
        globalCollection: this.all,
        config: this.config,
        module: this,
        fu: void 0
      };
    };
    AssetManager2.prototype.addType = function(id, definition) {
      this.getAll().addType(id, definition);
    };
    AssetManager2.prototype.getType = function(id) {
      return this.getAll().getType(id);
    };
    AssetManager2.prototype.getTypes = function() {
      return this.getAll().getTypes();
    };
    AssetManager2.prototype.AssetsView = function() {
      return this.am;
    };
    AssetManager2.prototype.FileUploader = function() {
      if (!this.fu) {
        this.fu = new FileUploader(this.__viewParams());
      }
      return this.fu;
    };
    AssetManager2.prototype.onLoad = function() {
      var _this = this;
      this.getAll().reset(this.config.assets);
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      em.Commands.__onRun(assetCmd, function() {
        return _this.__propEv(events2.open);
      });
      em.Commands.__onStop(assetCmd, function() {
        return _this.__propEv(events2.close);
      });
    };
    AssetManager2.prototype.postRender = function(editorView) {
      var _a2;
      this.config.dropzone && ((_a2 = this.fu) === null || _a2 === void 0 ? void 0 : _a2.initDropzone(editorView));
    };
    AssetManager2.prototype.setTarget = function(m) {
      this.assetsVis.target = m;
    };
    AssetManager2.prototype.onSelect = function(f) {
      this.assetsVis.onSelect = f;
    };
    AssetManager2.prototype.onClick = function(func) {
      this.config.onClick = func;
    };
    AssetManager2.prototype.onDblClick = function(func) {
      this.config.onDblClick = func;
    };
    AssetManager2.prototype.__propEv = function(ev) {
      var _a2, _b;
      var data = [];
      for (var _i = 1; _i < arguments.length; _i++) {
        data[_i - 1] = arguments[_i];
      }
      (_a2 = this.em).trigger.apply(_a2, asset_manager_spreadArray([ev], data, false));
      (_b = this.getAll()).trigger.apply(_b, asset_manager_spreadArray([ev], data, false));
    };
    AssetManager2.prototype.__trgCustom = function() {
      var bhv = this.__getBehaviour();
      var custom = this.getConfig().custom;
      if (!bhv.container && !custom.open) {
        return;
      }
      this.em.trigger(this.events.custom, this.__customData());
    };
    AssetManager2.prototype.__customData = function() {
      var _this = this;
      var bhv = this.__getBehaviour();
      return {
        am: this,
        open: this.isOpen(),
        assets: this.getAll().models,
        types: bhv.types || [],
        container: bhv.container,
        close: function() {
          return _this.close();
        },
        remove: function(asset, opts) {
          return _this.remove(asset, opts);
        },
        select: function(asset, complete) {
          var res = _this.add(asset);
          (0, index_all.isFunction)(bhv.select) && bhv.select(res, complete);
        },
        // extra
        options: bhv.options || {}
      };
    };
    AssetManager2.prototype.__behaviour = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this._bhv = asset_manager_assign(asset_manager_assign({}, this._bhv || {}), opts);
    };
    AssetManager2.prototype.__getBehaviour = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this._bhv || {};
    };
    AssetManager2.prototype.destroy = function() {
      var _a2, _b;
      this.all.stopListening();
      this.all.reset();
      this.assetsVis.stopListening();
      this.assetsVis.reset();
      (_a2 = this.fu) === null || _a2 === void 0 ? void 0 : _a2.remove();
      (_b = this.am) === null || _b === void 0 ? void 0 : _b.remove();
      this._bhv = {};
    };
    return AssetManager2;
  }(ItemManagerModule)
);
var asset_manager = AssetManager;
var Page_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Page = (
  /** @class */
  function(_super) {
    Page_extends(Page2, _super);
    function Page2(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, props, opts) || this;
      var em = opts.em;
      var defFrame = {};
      _this.em = em;
      if (!props.frames) {
        defFrame.component = props.component;
        defFrame.styles = props.styles;
        ["component", "styles"].map(function(i) {
          return _this.unset(i);
        });
      }
      var frms = props.frames || [defFrame];
      var frames = new model_Frames(em.Canvas, frms);
      frames.page = _this;
      _this.set("frames", frames);
      !_this.getId() && _this.set("id", em === null || em === void 0 ? void 0 : em.Pages._createId());
      em === null || em === void 0 ? void 0 : em.UndoManager.add(frames);
      return _this;
    }
    Page2.prototype.defaults = function() {
      return {
        name: "",
        frames: [],
        _undo: true
      };
    };
    Page2.prototype.onRemove = function() {
      this.getFrames().reset();
    };
    Page2.prototype.getFrames = function() {
      return this.get("frames");
    };
    Page2.prototype.getId = function() {
      return this.id;
    };
    Page2.prototype.getName = function() {
      return this.get("name");
    };
    Page2.prototype.setName = function(name) {
      return this.set({ name });
    };
    Page2.prototype.getAllFrames = function() {
      return this.getFrames().models || [];
    };
    Page2.prototype.getMainFrame = function() {
      return this.getFrames().at(0);
    };
    Page2.prototype.getMainComponent = function() {
      var frame = this.getMainFrame();
      return frame === null || frame === void 0 ? void 0 : frame.getComponent();
    };
    Page2.prototype.toJSON = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var obj = common.Kx.prototype.toJSON.call(this, opts);
      var defaults = (0, index_all.result)(this, "defaults");
      (0, index_all.forEach)(obj, function(value, key) {
        key.indexOf("_") === 0 && delete obj[key];
      });
      (0, index_all.forEach)(defaults, function(value, key) {
        if (obj[key] === value)
          delete obj[key];
      });
      return obj;
    };
    return Page2;
  }(common.Kx)
);
var model_Page = Page;
var Pages_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Pages_assign = function() {
  Pages_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Pages_assign.apply(this, arguments);
};
var Pages = (
  /** @class */
  function(_super) {
    Pages_extends(Pages2, _super);
    function Pages2(models, em) {
      var _this = _super.call(this, models) || this;
      _this.on("reset", _this.onReset);
      _this.on("remove", _this.onRemove);
      _this.model = function(props, opts) {
        if (opts === void 0) {
          opts = {};
        }
        return new model_Page(props, Pages_assign(Pages_assign({}, opts), { em }));
      };
      return _this;
    }
    Pages2.prototype.onReset = function(m, opts) {
      var _this = this;
      var _a2;
      (_a2 = opts === null || opts === void 0 ? void 0 : opts.previousModels) === null || _a2 === void 0 ? void 0 : _a2.map(function(p) {
        return _this.onRemove(p);
      });
    };
    Pages2.prototype.onRemove = function(removed) {
      removed === null || removed === void 0 ? void 0 : removed.onRemove();
    };
    return Pages2;
  }(common.pM)
);
var model_Pages = Pages;
var pages_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var pages_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var pages_chnSel = "change:selected";
var typeMain = "main";
var PageManager = (
  /** @class */
  function(_super) {
    pages_extends(PageManager2, _super);
    function PageManager2(em) {
      var _this = _super.call(this, em, "PageManager", new model_Pages([], em), types) || this;
      _this.events = types;
      _this.storageKey = "pages";
      (0, index_all.bindAll)(_this, "_onPageChange");
      var model = new ModuleModel.A({ _undo: true });
      _this.model = model;
      _this.pages.on("reset", function(coll) {
        return coll.at(0) && _this.select(coll.at(0));
      });
      _this.pages.on("all", _this.__onChange, _this);
      model.on(pages_chnSel, _this._onPageChange);
      return _this;
    }
    Object.defineProperty(PageManager2.prototype, "pages", {
      get: function() {
        return this.all;
      },
      enumerable: false,
      configurable: true
    });
    PageManager2.prototype.getAll = function() {
      return pages_spreadArray([], this.all.models, true);
    };
    PageManager2.prototype.__onChange = function(event, page, coll, opts) {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      var options = opts || coll;
      em.trigger(events2.all, { event, page, options });
    };
    PageManager2.prototype.onLoad = function() {
      var _a2;
      var _b = this, pages2 = _b.pages, config2 = _b.config, em = _b.em;
      var opt = { silent: true };
      var configPages = ((_a2 = config2.pages) === null || _a2 === void 0 ? void 0 : _a2.map(function(page) {
        return new model_Page(page, { em, config: config2 });
      })) || [];
      pages2.add(configPages, opt);
      var mainPage = !pages2.length ? this.add({ type: typeMain }, opt) : this._initPage();
      mainPage && this.select(mainPage, opt);
    };
    PageManager2.prototype._onPageChange = function(m, page, opts) {
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      var lm = em.Layers;
      var mainComp = page.getMainComponent();
      lm && mainComp && lm.setRoot(mainComp);
      em.trigger(events2.select, page, m.previous("selected"));
      this.__onChange(pages_chnSel, page, opts);
    };
    PageManager2.prototype.postLoad = function() {
      var _a2 = this, em = _a2.em, model = _a2.model, pages2 = _a2.pages;
      var um = em.UndoManager;
      um.add(model);
      um.add(pages2);
      pages2.on("add remove reset change", function(m, c, o) {
        return em.changesUp(o || c);
      });
    };
    PageManager2.prototype.add = function(props, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      props.id = props.id || this._createId();
      var add = function() {
        var page = _this.pages.add(new model_Page(props, { em: _this.em, config: _this.config }), opts);
        opts.select && _this.select(page);
        return page;
      };
      !opts.silent && em.trigger(events2.addBefore, props, add, opts);
      return !opts.abort ? add() : void 0;
    };
    PageManager2.prototype.remove = function(page, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, events2 = _a2.events;
      var pg = (0, index_all.isString)(page) ? this.get(page) : page;
      var rm = function() {
        pg && _this.pages.remove(pg, opts);
        return pg;
      };
      !opts.silent && em.trigger(events2.removeBefore, pg, rm, opts);
      return !opts.abort && rm();
    };
    PageManager2.prototype.get = function(id) {
      return this.pages.filter(function(p) {
        return p.get(p.idAttribute) === id;
      })[0];
    };
    PageManager2.prototype.getMain = function() {
      var pages2 = this.pages;
      return pages2.filter(function(p) {
        return p.get("type") === typeMain;
      })[0] || pages2.at(0);
    };
    PageManager2.prototype.getAllWrappers = function() {
      var pages2 = this.getAll();
      return (0, index_all.unique)((0, index_all.flatten)(pages2.map(function(page) {
        return page.getAllFrames().map(function(frame) {
          return frame.getComponent();
        });
      })));
    };
    PageManager2.prototype.select = function(page, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, model = _a2.model, events2 = _a2.events;
      var pg = (0, index_all.isString)(page) ? this.get(page) : page;
      if (pg) {
        em.trigger(events2.selectBefore, pg, opts);
        model.set("selected", pg, opts);
      }
      return this;
    };
    PageManager2.prototype.getSelected = function() {
      return this.model.get("selected");
    };
    PageManager2.prototype.destroy = function() {
      var _this = this;
      this.pages.off().reset();
      this.model.stopListening();
      this.model.clear({ silent: true });
      ["selected", "model"].map(function(i) {
        return _this[i] = 0;
      });
    };
    PageManager2.prototype.store = function() {
      return this.getProjectData();
    };
    PageManager2.prototype.load = function(data) {
      var result = this.loadProjectData(data, { all: this.pages, reset: true });
      this.pages.forEach(function(page) {
        return page.getFrames().initRefs();
      });
      return result;
    };
    PageManager2.prototype._initPage = function() {
      return this.get(this.config.selected) || this.getMain();
    };
    PageManager2.prototype._createId = function() {
      var pages2 = this.getAll();
      var len = pages2.length + 16;
      var pagesMap = this.getAllMap();
      var id;
      do {
        id = (0, mixins.createId)(len);
      } while (pagesMap[id]);
      return id;
    };
    return PageManager2;
  }(ItemManagerModule)
);
var pages = PageManager;
var traitInputAttr = {
  placeholder: "eg. Text here"
};
var en = {
  assetManager: {
    addButton: "Add image",
    inputPlh: "http://path/to/the/image.jpg",
    modalTitle: "Select Image",
    uploadTitle: "Drop files here or click to upload"
  },
  // Here just as a reference, GrapesJS core doesn't contain any block,
  // so this should be omitted from other local files
  blockManager: {
    labels: {
      // 'block-id': 'Block Label',
    },
    categories: {
      // 'category-id': 'Category Label',
    }
  },
  domComponents: {
    names: {
      "": "Box",
      wrapper: "Body",
      text: "Text",
      comment: "Comment",
      image: "Image",
      video: "Video",
      label: "Label",
      link: "Link",
      map: "Map",
      tfoot: "Table foot",
      tbody: "Table body",
      thead: "Table head",
      table: "Table",
      row: "Table row",
      cell: "Table cell"
    }
  },
  deviceManager: {
    device: "Device",
    devices: {
      desktop: "Desktop",
      tablet: "Tablet",
      mobileLandscape: "Mobile Landscape",
      mobilePortrait: "Mobile Portrait"
    }
  },
  panels: {
    buttons: {
      titles: {
        preview: "Preview",
        fullscreen: "Fullscreen",
        "sw-visibility": "View components",
        "export-template": "View code",
        "open-sm": "Open Style Manager",
        "open-tm": "Settings",
        "open-layers": "Open Layer Manager",
        "open-blocks": "Open Blocks"
      }
    }
  },
  selectorManager: {
    label: "Classes",
    selected: "Selected",
    emptyState: "- State -",
    states: {
      hover: "Hover",
      active: "Click",
      "nth-of-type(2n)": "Even/Odd"
    }
  },
  styleManager: {
    empty: "Select an element before using Style Manager",
    layer: "Layer",
    fileButton: "Images",
    sectors: {
      general: "General",
      layout: "Layout",
      typography: "Typography",
      decorations: "Decorations",
      extra: "Extra",
      flex: "Flex",
      dimension: "Dimension"
    },
    // Default names for sub properties in Composite and Stack types.
    // Other labels are generated directly from their property names (eg. 'font-size' will be 'Font size').
    properties: {
      "text-shadow-h": "X",
      "text-shadow-v": "Y",
      "text-shadow-blur": "Blur",
      "text-shadow-color": "Color",
      "box-shadow-h": "X",
      "box-shadow-v": "Y",
      "box-shadow-blur": "Blur",
      "box-shadow-spread": "Spread",
      "box-shadow-color": "Color",
      "box-shadow-type": "Type",
      "margin-top-sub": "Top",
      "margin-right-sub": "Right",
      "margin-bottom-sub": "Bottom",
      "margin-left-sub": "Left",
      "padding-top-sub": "Top",
      "padding-right-sub": "Right",
      "padding-bottom-sub": "Bottom",
      "padding-left-sub": "Left",
      "border-width-sub": "Width",
      "border-style-sub": "Style",
      "border-color-sub": "Color",
      "border-top-left-radius-sub": "Top Left",
      "border-top-right-radius-sub": "Top Right",
      "border-bottom-right-radius-sub": "Bottom Right",
      "border-bottom-left-radius-sub": "Bottom Left",
      "transform-rotate-x": "Rotate X",
      "transform-rotate-y": "Rotate Y",
      "transform-rotate-z": "Rotate Z",
      "transform-scale-x": "Scale X",
      "transform-scale-y": "Scale Y",
      "transform-scale-z": "Scale Z",
      "transition-property-sub": "Property",
      "transition-duration-sub": "Duration",
      "transition-timing-function-sub": "Timing",
      "background-image-sub": "Image",
      "background-repeat-sub": "Repeat",
      "background-position-sub": "Position",
      "background-attachment-sub": "Attachment",
      "background-size-sub": "Size"
    }
    // Translate options in style properties
    // options: {
    //   float: { // Id of the property
    //     ...
    //     left: 'Left', // {option id}: {Option label}
    //   }
    // }
  },
  traitManager: {
    empty: "Select an element before using Trait Manager",
    label: "Component settings",
    categories: {
      // categoryId: 'Category label',
    },
    traits: {
      // The core library generates the name by their `name` property
      labels: {
        // id: 'Id',
        // alt: 'Alt',
        // title: 'Title',
        // href: 'Href',
      },
      // In a simple trait, like text input, these are used on input attributes
      attributes: {
        id: traitInputAttr,
        alt: traitInputAttr,
        title: traitInputAttr,
        href: {
          placeholder: "eg. https://google.com"
        }
      },
      // In a trait like select, these are used to translate option names
      options: {
        target: {
          false: "This window",
          _blank: "New window"
        }
      }
    }
  },
  storageManager: {
    recover: "Do you want to recover unsaved changes?"
  }
};
var i18n_config_config = {
  locale: "en",
  localeFallback: "en",
  detectLocale: true,
  debug: false,
  messages: { en },
  messagesAdd: void 0
};
var i18n_config = i18n_config_config;
var I18nEvents;
(function(I18nEvents2) {
  I18nEvents2["add"] = "i18n:add";
  I18nEvents2["update"] = "i18n:update";
  I18nEvents2["locale"] = "i18n:locale";
})(I18nEvents || (I18nEvents = {}));
var i18n_types = I18nEvents;
var i18n_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var I18nModule = (
  /** @class */
  function(_super) {
    i18n_extends(I18nModule2, _super);
    function I18nModule2(em) {
      var _this = _super.call(this, em, "I18n", i18n_config) || this;
      _this.events = i18n_types;
      var add = _this.config.messagesAdd;
      add && _this.addMessages(add);
      if (_this.config.detectLocale) {
        _this.config.locale = _this._localLang();
      }
      return _this;
    }
    I18nModule2.prototype.setLocale = function(locale) {
      var _a2 = this, em = _a2.em, config2 = _a2.config, events2 = _a2.events;
      em.trigger(events2.locale, { value: locale, valuePrev: config2.locale });
      config2.locale = locale;
      return this;
    };
    I18nModule2.prototype.getLocale = function() {
      return this.config.locale;
    };
    I18nModule2.prototype.getMessages = function(lang, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var messages = this.config.messages;
      lang && !messages[lang] && this._debug("'".concat(lang, "' i18n lang not found"), opts);
      return lang ? messages[lang] : messages;
    };
    I18nModule2.prototype.setMessages = function(msg) {
      var _a2 = this, em = _a2.em, config2 = _a2.config, events2 = _a2.events;
      config2.messages = msg;
      em.trigger(events2.update, msg);
      return this;
    };
    I18nModule2.prototype.addMessages = function(msg) {
      var _a2 = this, em = _a2.em, events2 = _a2.events, config2 = _a2.config;
      var messages = config2.messages;
      em.trigger(events2.add, msg);
      this.setMessages((0, mixins.deepMerge)(messages, msg));
      return this;
    };
    I18nModule2.prototype.t = function(key, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var config2 = this.config;
      var param = opts.params || {};
      var locale = opts.l || this.getLocale();
      var localeFlb = opts.lFlb || config2.localeFallback;
      var result = this._getMsg(key, locale, opts);
      if (!result)
        result = this._getMsg(key, localeFlb, opts);
      !result && this._debug("'".concat(key, "' i18n key not found in '").concat(locale, "' lang"), opts);
      result = result && (0, index_all.isString)(result) ? this._addParams(result, param) : result;
      return result;
    };
    I18nModule2.prototype._localLang = function() {
      var nav = (0, mixins.hasWin)() && window.navigator || {};
      var lang = nav.language || nav.userLanguage;
      return lang ? lang.split("-")[0] : "en";
    };
    I18nModule2.prototype._addParams = function(str, params) {
      var reg = new RegExp("{([\\w\\d-]*)}", "g");
      return str.replace(reg, function(m, val) {
        return params[val] || "";
      }).trim();
    };
    I18nModule2.prototype._getMsg = function(key, locale, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var msgSet = this.getMessages(locale, opts);
      if (!msgSet)
        return;
      var result = msgSet[key];
      if (!result && key.indexOf(".") > 0) {
        result = key.split(".").reduce(function(lang, key2) {
          if ((0, index_all.isUndefined)(lang))
            return;
          return lang[key2];
        }, msgSet);
      }
      return result;
    };
    I18nModule2.prototype._debug = function(str, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, em = _a2.em, config2 = _a2.config;
      (opts.debug || config2.debug) && em && em.logWarning(str);
    };
    I18nModule2.prototype.destroy = function() {
    };
    return I18nModule2;
  }(abstract_Module)
);
var i18n = I18nModule;
var Sorter_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Sorter_assign = function() {
  Sorter_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Sorter_assign.apply(this, arguments);
};
var Sorter_noop = function() {
};
var targetSpotType = CanvasSpot.F.Target;
var spotTarget = {
  id: "sorter-target",
  type: targetSpotType
};
var Sorter = (
  /** @class */
  function(_super) {
    Sorter_extends(Sorter2, _super);
    function Sorter2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Sorter2.prototype.initialize = function(opt) {
      if (opt === void 0) {
        opt = {};
      }
      this.opt = opt || {};
      (0, index_all.bindAll)(this, "startSort", "onMove", "endMove", "rollback", "updateOffset", "moveDragHelper");
      var o = opt || {};
      this.elT = 0;
      this.elL = 0;
      this.borderOffset = o.borderOffset || 10;
      var el = o.container;
      this.el = typeof el === "string" ? document.querySelector(el) : el;
      this.$el = (0, cash_dom["default"])(this.el);
      this.containerSel = o.containerSel || "div";
      this.itemSel = o.itemSel || "div";
      this.draggable = o.draggable || true;
      this.nested = !!o.nested;
      this.pfx = o.pfx || "";
      this.ppfx = o.ppfx || "";
      this.freezeClass = o.freezeClass || this.pfx + "freezed";
      this.onStart = o.onStart || Sorter_noop;
      this.onEndMove = o.onEndMove;
      this.customTarget = o.customTarget;
      this.onEnd = o.onEnd;
      this.direction = o.direction || "v";
      this.onMoveClb = o.onMove;
      this.relative = o.relative || false;
      this.ignoreViewChildren = !!o.ignoreViewChildren;
      this.plh = o.placer;
      this.wmargin = o.wmargin || 0;
      this.offTop = o.offsetTop || 0;
      this.offLeft = o.offsetLeft || 0;
      this.document = o.document || document;
      this.em = o.em;
      this.canvasRelative = !!o.canvasRelative;
      this.selectOnEnd = !o.avoidSelectOnEnd;
      this.scale = o.scale;
      var em = this.em;
      if (em === null || em === void 0 ? void 0 : em.on) {
        em.on(em.Canvas.events.refresh, this.updateOffset);
        this.updateOffset();
      }
    };
    Sorter2.prototype.getScale = function() {
      return (0, index_all.result)(this, "scale") || 1;
    };
    Sorter2.prototype.getContainerEl = function(elem) {
      if (elem)
        this.el = elem;
      if (!this.el) {
        var el = this.opt.container;
        this.el = typeof el === "string" ? document.querySelector(el) : el;
        this.$el = (0, cash_dom["default"])(this.el);
      }
      return this.el;
    };
    Sorter2.prototype.getDocuments = function(el) {
      var em = this.em;
      var elDoc = el ? el.ownerDocument : em === null || em === void 0 ? void 0 : em.Canvas.getBody().ownerDocument;
      var docs = [document];
      elDoc && docs.push(elDoc);
      return docs;
    };
    Sorter2.prototype.updateOffset = function() {
      var _a2;
      var offset = ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.get("canvasOffset")) || {};
      this.offTop = offset.top;
      this.offLeft = offset.left;
    };
    Sorter2.prototype.setDropContent = function(content) {
      delete this.dropModel;
      this.dropContent = content;
    };
    Sorter2.prototype.updateTextViewCursorPosition = function(e) {
      var em = this.em;
      if (!em)
        return;
      var Canvas2 = em.Canvas;
      var targetDoc = Canvas2.getDocument();
      var range = null;
      if (targetDoc.caretRangeFromPoint) {
        var poiner = (0, dom.G2)(e);
        range = targetDoc.caretRangeFromPoint(poiner.clientX, poiner.clientY);
      } else if (e.rangeParent) {
        range = targetDoc.createRange();
        range.setStart(e.rangeParent, e.rangeOffset);
      }
      var sel = Canvas2.getWindow().getSelection();
      Canvas2.getFrameEl().focus();
      sel === null || sel === void 0 ? void 0 : sel.removeAllRanges();
      range && (sel === null || sel === void 0 ? void 0 : sel.addRange(range));
      this.setContentEditable(this.activeTextModel, true);
    };
    Sorter2.prototype.setContentEditable = function(model, mode) {
      if (model) {
        var el = model.getEl();
        if (el.contentEditable != mode)
          el.contentEditable = mode;
      }
    };
    Sorter2.prototype.toggleSortCursor = function(active) {
      var em = this.em;
      var cv = em === null || em === void 0 ? void 0 : em.Canvas;
      cv && (active ? cv.startAutoscroll() : cv.stopAutoscroll());
    };
    Sorter2.prototype.setDragHelper = function(el, event) {
      var ev = event || "";
      var clonedEl = el.cloneNode(true);
      var rect = el.getBoundingClientRect();
      var computed = getComputedStyle(el);
      var style = "";
      for (var i = 0; i < computed.length; i++) {
        var prop = computed[i];
        style += "".concat(prop, ":").concat(computed.getPropertyValue(prop), ";");
      }
      document.body.appendChild(clonedEl);
      clonedEl.className += " ".concat(this.pfx, "bdrag");
      clonedEl.setAttribute("style", style);
      this.dragHelper = clonedEl;
      clonedEl.style.width = "".concat(rect.width, "px");
      clonedEl.style.height = "".concat(rect.height, "px");
      ev && this.moveDragHelper(ev);
      if (this.em) {
        var $doc = (0, cash_dom["default"])(this.em.Canvas.getBody().ownerDocument);
        $doc.off("mousemove", this.moveDragHelper).on("mousemove", this.moveDragHelper);
      }
      (0, cash_dom["default"])(document).off("mousemove", this.moveDragHelper).on("mousemove", this.moveDragHelper);
    };
    Sorter2.prototype.moveDragHelper = function(e) {
      var doc = e.target.ownerDocument;
      if (!this.dragHelper || !doc) {
        return;
      }
      var posY = e.pageY;
      var posX = e.pageX;
      var addTop = 0;
      var addLeft = 0;
      var window2 = doc.defaultView || doc.parentWindow;
      var frame = window2.frameElement;
      var dragHelperStyle = this.dragHelper.style;
      if (frame) {
        var frameRect = frame.getBoundingClientRect();
        addTop = frameRect.top + document.documentElement.scrollTop;
        addLeft = frameRect.left + document.documentElement.scrollLeft;
        posY = e.clientY;
        posX = e.clientX;
      }
      dragHelperStyle.top = posY + addTop + "px";
      dragHelperStyle.left = posX + addLeft + "px";
    };
    Sorter2.prototype.matches = function(el, selector) {
      return mixins.matches.call(el, selector);
    };
    Sorter2.prototype.closest = function(el, selector) {
      if (!el)
        return;
      var elem = el.parentNode;
      while (elem && elem.nodeType === 1) {
        if (this.matches(elem, selector))
          return elem;
        elem = elem.parentNode;
      }
    };
    Sorter2.prototype.offset = function(el) {
      var rect = el.getBoundingClientRect();
      return {
        top: rect.top + document.body.scrollTop,
        left: rect.left + document.body.scrollLeft
      };
    };
    Sorter2.prototype.createPlaceholder = function() {
      var pfx = this.pfx;
      var el = document.createElement("div");
      var ins = document.createElement("div");
      el.className = pfx + "placeholder";
      el.style.display = "none";
      el.style.pointerEvents = "none";
      ins.className = pfx + "placeholder-int";
      el.appendChild(ins);
      return el;
    };
    Sorter2.prototype.startSort = function(src2, opts) {
      var _a2, _b;
      if (opts === void 0) {
        opts = {};
      }
      var _c = this, em = _c.em, itemSel = _c.itemSel, containerSel = _c.containerSel, plh = _c.plh;
      var container = this.getContainerEl(opts.container);
      var docs = this.getDocuments(src2);
      var srcModel;
      delete this.dropModel;
      delete this.target;
      delete this.prevTarget;
      this.moved = false;
      if (src2 && !this.matches(src2, "".concat(itemSel, ", ").concat(containerSel))) {
        src2 = this.closest(src2, itemSel);
      }
      this.sourceEl = src2;
      if (!plh) {
        this.plh = this.createPlaceholder();
        container.appendChild(this.plh);
      }
      if (src2) {
        srcModel = this.getSourceModel(src2);
        (srcModel === null || srcModel === void 0 ? void 0 : srcModel.set) && srcModel.set("status", "freezed");
        this.srcModel = srcModel;
      }
      (0, dom.on)(container, "mousemove dragover", this.onMove);
      (0, dom.on)(docs, "mouseup dragend touchend", this.endMove);
      (0, dom.on)(docs, "keydown", this.rollback);
      this.onStart({
        sorter: this,
        target: srcModel,
        // @ts-ignore
        parent: srcModel && ((_a2 = srcModel.parent) === null || _a2 === void 0 ? void 0 : _a2.call(srcModel)),
        // @ts-ignore
        index: srcModel && ((_b = srcModel.index) === null || _b === void 0 ? void 0 : _b.call(srcModel))
      });
      em === null || em === void 0 ? void 0 : em.clearSelection();
      this.toggleSortCursor(true);
      em === null || em === void 0 ? void 0 : em.trigger("sorter:drag:start", src2, srcModel);
    };
    Sorter2.prototype.getTargetModel = function(el) {
      var elem = el || this.target;
      return (0, cash_dom["default"])(elem).data("model");
    };
    Sorter2.prototype.getSourceModel = function(source, _a2) {
      var _this = this;
      var _b = _a2 === void 0 ? {} : _a2, target = _b.target, _c = _b.avoidChildren, avoidChildren = _c === void 0 ? 1 : _c;
      var _d = this, em = _d.em, sourceEl = _d.sourceEl;
      var src2 = source || sourceEl;
      var _e = this, dropModel = _e.dropModel, dropContent = _e.dropContent;
      var isTextable = function(src3) {
        return src3 && target && src3.opt && src3.opt.avoidChildren && _this.isTextableActive(src3, target);
      };
      if (dropContent && em) {
        if (isTextable(dropModel)) {
          dropModel = void 0;
        }
        if (!dropModel) {
          var comps = em.Components.getComponents();
          var opts = {
            avoidChildren,
            avoidStore: 1,
            avoidUpdateStyle: 1
          };
          var tempModel = comps.add(dropContent, Sorter_assign(Sorter_assign({}, opts), { temporary: true }));
          dropModel = comps.remove(tempModel, opts);
          dropModel = dropModel instanceof Array ? dropModel[0] : dropModel;
          this.dropModel = dropModel;
          if (isTextable(dropModel)) {
            return this.getSourceModel(src2, { target, avoidChildren: 0 });
          }
        }
        return dropModel;
      }
      return src2 && (0, cash_dom["default"])(src2).data("model");
    };
    Sorter2.prototype.selectTargetModel = function(model, source) {
      if (model instanceof common.pM) {
        return;
      }
      if (source && source === model)
        return;
      var targetModel = this.targetModel;
      if (targetModel && targetModel !== this.srcModel) {
        targetModel.set("status", "");
      }
      if (model === null || model === void 0 ? void 0 : model.set) {
        var cv_1 = this.em.Canvas;
        var Select = CanvasSpot.F.Select, Hover = CanvasSpot.F.Hover, Spacing = CanvasSpot.F.Spacing;
        [Select, Hover, Spacing].forEach(function(type2) {
          return cv_1.removeSpots({ type: type2 });
        });
        cv_1.addSpot(Sorter_assign(Sorter_assign({}, spotTarget), { component: model }));
        model.set("status", "selected-parent");
        this.targetModel = model;
      }
    };
    Sorter2.prototype.onMove = function(e) {
      var ev = e;
      var _a2 = this, em = _a2.em, onMoveClb = _a2.onMoveClb, plh = _a2.plh, customTarget = _a2.customTarget;
      this.moved = true;
      var dsp = plh.style.display;
      if (!dsp || dsp === "none")
        plh.style.display = "block";
      var eO = this.offset(this.el);
      this.elT = this.wmargin ? Math.abs(eO.top) : eO.top;
      this.elL = this.wmargin ? Math.abs(eO.left) : eO.left;
      var rY = e.pageY - this.elT + this.el.scrollTop;
      var rX = e.pageX - this.elL + this.el.scrollLeft;
      if (this.canvasRelative && em) {
        var mousePos = em.Canvas.getMouseRelativeCanvas(e, { noScroll: 1 });
        rX = mousePos.x;
        rY = mousePos.y;
      }
      this.rX = rX;
      this.rY = rY;
      this.eventMove = e;
      var sourceModel = this.getSourceModel();
      var targetEl = customTarget ? customTarget({ sorter: this, event: e }) : e.target;
      var dims = this.dimsFromTarget(targetEl, rX, rY);
      var target = this.target;
      var targetModel = target && this.getTargetModel(target);
      this.selectTargetModel(targetModel, sourceModel);
      if (!targetModel)
        plh.style.display = "none";
      if (!target)
        return;
      this.lastDims = dims;
      var pos = this.findPosition(dims, rX, rY);
      if (this.isTextableActive(sourceModel, targetModel)) {
        this.activeTextModel = targetModel;
        plh.style.display = "none";
        this.lastPos = pos;
        this.updateTextViewCursorPosition(ev);
      } else {
        this.disableTextable();
        delete this.activeTextModel;
        if (!this.lastPos || this.lastPos.index != pos.index || this.lastPos.method != pos.method) {
          this.movePlaceholder(this.plh, dims, pos, this.prevTargetDim);
          if (!this.$plh)
            this.$plh = (0, cash_dom["default"])(this.plh);
          if (!this.canvasRelative) {
            if (this.offTop)
              this.$plh.css("top", "+=" + this.offTop + "px");
            if (this.offLeft)
              this.$plh.css("left", "+=" + this.offLeft + "px");
          }
          this.lastPos = pos;
        }
      }
      (0, index_all.isFunction)(onMoveClb) && onMoveClb({
        event: e,
        target: sourceModel,
        parent: targetModel,
        index: pos.index + (pos.method == "after" ? 1 : 0)
      });
      em && em.trigger("sorter:drag", {
        target,
        targetModel,
        sourceModel,
        dims,
        pos,
        x: rX,
        y: rY
      });
    };
    Sorter2.prototype.isTextableActive = function(src2, trg) {
      var _a2;
      return ((_a2 = src2 === null || src2 === void 0 ? void 0 : src2.get) === null || _a2 === void 0 ? void 0 : _a2.call(src2, "textable")) && (trg === null || trg === void 0 ? void 0 : trg.isInstanceOf("text"));
    };
    Sorter2.prototype.disableTextable = function() {
      var activeTextModel = this.activeTextModel;
      activeTextModel === null || activeTextModel === void 0 ? void 0 : activeTextModel.getView().disableEditing();
      this.setContentEditable(activeTextModel, false);
    };
    Sorter2.prototype.isInFlow = function(el, parent) {
      if (!el)
        return false;
      parent = parent || document.body;
      var ch = -1, h;
      var elem = el;
      h = elem.offsetHeight;
      if (
        /*h < ch || */
        !this.styleInFlow(elem, parent)
      )
        return false;
      else
        return true;
    };
    Sorter2.prototype.styleInFlow = function(el, parent) {
      if ((0, dom.ir)(el))
        return;
      var style = el.style || {};
      var $el = (0, cash_dom["default"])(el);
      var $parent = parent && (0, cash_dom["default"])(parent);
      if (style.overflow && style.overflow !== "visible")
        return;
      var propFloat = $el.css("float");
      if (propFloat && propFloat !== "none")
        return;
      if ($parent && $parent.css("display") == "flex" && $parent.css("flex-direction") !== "column")
        return;
      switch (style.position) {
        case "static":
        case "relative":
        case "":
          break;
        default:
          return;
      }
      switch (el.tagName) {
        case "TR":
        case "TBODY":
        case "THEAD":
        case "TFOOT":
          return true;
      }
      switch ($el.css("display")) {
        case "block":
        case "list-item":
        case "table":
        case "flex":
        case "grid":
          return true;
      }
      return;
    };
    Sorter2.prototype.validTarget = function(trg, src2) {
      var _a2, _b;
      var pos = this.lastPos;
      var trgModel = this.getTargetModel(trg);
      var srcModel = this.getSourceModel(src2, { target: trgModel });
      src2 = (_a2 = srcModel === null || srcModel === void 0 ? void 0 : srcModel.view) === null || _a2 === void 0 ? void 0 : _a2.el;
      trg = (_b = trgModel === null || trgModel === void 0 ? void 0 : trgModel.view) === null || _b === void 0 ? void 0 : _b.el;
      var result = {
        valid: true,
        src: src2,
        srcModel,
        trg,
        trgModel,
        draggable: false,
        droppable: false,
        dragInfo: "",
        dropInfo: ""
      };
      if (!src2 || !trg) {
        result.valid = false;
        return result;
      }
      var index2 = pos ? pos.method === "after" ? pos.indexEl + 1 : pos.indexEl : trgModel.components().length;
      var draggable = srcModel.get("draggable");
      if ((0, index_all.isFunction)(draggable)) {
        var res = draggable(srcModel, trgModel, index2);
        result.dragInfo = res;
        result.draggable = res;
        draggable = res;
      } else {
        draggable = draggable instanceof Array ? draggable.join(", ") : draggable;
        result.dragInfo = draggable;
        draggable = (0, index_all.isString)(draggable) ? this.matches(trg, draggable) : draggable;
        result.draggable = draggable;
      }
      var droppable2 = trgModel.get("droppable");
      if ((0, index_all.isFunction)(droppable2)) {
        var res = droppable2(srcModel, trgModel, index2);
        result.droppable = res;
        result.dropInfo = res;
        droppable2 = res;
      } else {
        droppable2 = droppable2 instanceof common.pM ? 1 : droppable2;
        droppable2 = droppable2 instanceof Array ? droppable2.join(", ") : droppable2;
        result.dropInfo = droppable2;
        droppable2 = (0, index_all.isString)(droppable2) ? this.matches(src2, droppable2) : droppable2;
        droppable2 = draggable && this.isTextableActive(srcModel, trgModel) ? 1 : droppable2;
        result.droppable = droppable2;
      }
      if (!droppable2 || !draggable) {
        result.valid = false;
      }
      return result;
    };
    Sorter2.prototype.dimsFromTarget = function(target, rX, rY) {
      if (rX === void 0) {
        rX = 0;
      }
      if (rY === void 0) {
        rY = 0;
      }
      var em = this.em;
      var dims = [];
      if (!target) {
        return dims;
      }
      if (!this.matches(target, "".concat(this.itemSel, ", ").concat(this.containerSel))) {
        target = this.closest(target, this.itemSel);
      }
      if (this.draggable instanceof Array) {
        target = this.closest(target, this.draggable.join(","));
      }
      if (!target) {
        return dims;
      }
      if (this.prevTarget && this.prevTarget != target) {
        delete this.prevTarget;
      }
      if (!this.prevTarget) {
        this.targetP = this.closest(target, this.containerSel);
        var validResult = this.validTarget(target);
        em && em.trigger("sorter:drag:validation", validResult);
        if (!validResult.valid && this.targetP) {
          return this.dimsFromTarget(this.targetP, rX, rY);
        }
        this.prevTarget = target;
        this.prevTargetDim = this.getDim(target);
        this.cacheDimsP = this.getChildrenDim(this.targetP);
        this.cacheDims = this.getChildrenDim(target);
      }
      if (this.prevTarget == target)
        dims = this.cacheDims;
      this.target = this.prevTarget;
      if (this.nearBorders(this.prevTargetDim, rX, rY) || !this.nested && !this.cacheDims.length) {
        var targetParent = this.targetP;
        if (targetParent && this.validTarget(targetParent).valid) {
          dims = this.cacheDimsP;
          this.target = targetParent;
        }
      }
      delete this.lastPos;
      return dims;
    };
    Sorter2.prototype.getTargetFromEl = function(el) {
      var target = el;
      var targetParent;
      var targetPrev = this.targetPrev;
      var em = this.em;
      var containerSel = this.containerSel;
      var itemSel = this.itemSel;
      if (!this.matches(target, "".concat(itemSel, ", ").concat(containerSel))) {
        target = this.closest(target, itemSel);
      }
      if (this.draggable instanceof Array) {
        target = this.closest(target, this.draggable.join(","));
      }
      if (targetPrev && targetPrev != target) {
        delete this.targetPrev;
      }
      if (!this.targetPrev) {
        targetParent = this.closest(target, containerSel);
        var validResult = this.validTarget(target);
        em && em.trigger("sorter:drag:validation", validResult);
        if (!validResult.valid && targetParent) {
          return this.getTargetFromEl(targetParent);
        }
        this.targetPrev = target;
      }
      if (this.nearElBorders(target)) {
        targetParent = this.closest(target, containerSel);
        if (targetParent && this.validTarget(targetParent).valid) {
          target = targetParent;
        }
      }
      return target;
    };
    Sorter2.prototype.nearElBorders = function(el) {
      var off = 10;
      var rect = el.getBoundingClientRect();
      var body = el.ownerDocument.body;
      var _a2 = this.getCurrentPos(), x = _a2.x, y = _a2.y;
      var top = rect.top + body.scrollTop;
      var left = rect.left + body.scrollLeft;
      var width = rect.width;
      var height = rect.height;
      if (y < top + off || // near top edge
      y > top + height - off || // near bottom edge
      x < left + off || // near left edge
      x > left + width - off) {
        return 1;
      }
    };
    Sorter2.prototype.getCurrentPos = function() {
      var ev = this.eventMove;
      var x = (ev === null || ev === void 0 ? void 0 : ev.pageX) || 0;
      var y = (ev === null || ev === void 0 ? void 0 : ev.pageY) || 0;
      return { x, y };
    };
    Sorter2.prototype.getDim = function(el) {
      var _a2 = this, em = _a2.em, canvasRelative = _a2.canvasRelative;
      var canvas2 = em === null || em === void 0 ? void 0 : em.Canvas;
      var offsets = canvas2 ? canvas2.getElementOffsets(el) : {};
      var top, left, height, width;
      if (canvasRelative && em) {
        var pos = canvas2.getElementPos(el, { noScroll: 1 });
        top = pos.top;
        left = pos.left;
        height = pos.height;
        width = pos.width;
      } else {
        var o = this.offset(el);
        top = this.relative ? el.offsetTop : o.top - (this.wmargin ? -1 : 1) * this.elT;
        left = this.relative ? el.offsetLeft : o.left - (this.wmargin ? -1 : 1) * this.elL;
        height = el.offsetHeight;
        width = el.offsetWidth;
      }
      return { top, left, height, width, offsets };
    };
    Sorter2.prototype.getChildrenDim = function(trg) {
      var _this = this;
      var dims = [];
      if (!trg)
        return dims;
      var trgModel = this.getTargetModel(trg);
      if (trgModel && trgModel.view && !this.ignoreViewChildren) {
        var view = trgModel.getCurrentView ? trgModel.getCurrentView() : trgModel.view;
        trg = view.getChildrenContainer();
      }
      (0, index_all.each)(trg.children, function(ele, i) {
        var el = ele;
        var model = (0, mixins.getModel)(el, cash_dom["default"]);
        var elIndex = model && model.index ? model.index() : i;
        if (!(0, dom.ir)(el) && !_this.matches(el, _this.itemSel)) {
          return;
        }
        var dim = _this.getDim(el);
        var dir = _this.direction;
        var dirValue;
        if (dir == "v")
          dirValue = true;
        else if (dir == "h")
          dirValue = false;
        else
          dirValue = _this.isInFlow(el, trg);
        dim.dir = dirValue;
        dim.el = el;
        dim.indexEl = elIndex;
        dims.push(dim);
      });
      return dims;
    };
    Sorter2.prototype.nearBorders = function(dim, rX, rY) {
      var result = false;
      var off = this.borderOffset;
      var x = rX || 0;
      var y = rY || 0;
      var t = dim.top;
      var l = dim.left;
      var h = dim.height;
      var w = dim.width;
      if (t + off > y || y > t + h - off || l + off > x || x > l + w - off)
        result = true;
      return result;
    };
    Sorter2.prototype.findPosition = function(dims, posX, posY) {
      var result = { index: 0, indexEl: 0, method: "before" };
      var leftLimit = 0;
      var xLimit = 0;
      var dimRight = 0;
      var yLimit = 0;
      var xCenter = 0;
      var yCenter = 0;
      var dimDown = 0;
      var dim;
      for (var i = 0, len = dims.length; i < len; i++) {
        dim = dims[i];
        var top_1 = dim.top, left = dim.left, height = dim.height, width = dim.width;
        dimRight = left + width;
        dimDown = top_1 + height;
        xCenter = left + width / 2;
        yCenter = top_1 + height / 2;
        if (xLimit && left > xLimit || yLimit && yCenter >= yLimit || // >= avoid issue with clearfixes
        leftLimit && dimRight < leftLimit)
          continue;
        result.index = i;
        result.indexEl = dim.indexEl;
        if (!dim.dir) {
          if (posY < dimDown)
            yLimit = dimDown;
          if (posX < xCenter) {
            xLimit = xCenter;
            result.method = "before";
          } else {
            leftLimit = xCenter;
            result.method = "after";
          }
        } else {
          if (posY < yCenter) {
            result.method = "before";
            break;
          } else
            result.method = "after";
        }
      }
      return result;
    };
    Sorter2.prototype.movePlaceholder = function(plh, dims, pos, trgDim) {
      var marg = 0;
      var t = 0;
      var l = 0;
      var w = "";
      var h = "";
      var un = "px";
      var margI = 5;
      var method = pos.method;
      var elDim = dims[pos.index];
      plh.classList.remove("vertical");
      plh.classList.add("horizontal");
      if (elDim) {
        var top_2 = elDim.top, left = elDim.left, height = elDim.height, width = elDim.width;
        if (!elDim.dir) {
          w = "auto";
          h = height - marg * 2 + un;
          t = top_2 + marg;
          l = method == "before" ? left - marg : left + width - marg;
          plh.classList.remove("horizontal");
          plh.classList.add("vertical");
        } else {
          w = width + un;
          h = "auto";
          t = method == "before" ? top_2 - marg : top_2 + height - marg;
          l = left;
        }
      } else {
        if (!this.nested) {
          plh.style.display = "none";
          return;
        }
        if (trgDim) {
          var offset = trgDim.offsets || {};
          var pT = offset.paddingTop || margI;
          var pL = offset.paddingLeft || margI;
          var bT = offset.borderTopWidth || 0;
          var bL = offset.borderLeftWidth || 0;
          var bR = offset.borderRightWidth || 0;
          var bWidth = bL + bR;
          t = trgDim.top + pT + bT;
          l = trgDim.left + pL + bL;
          w = parseInt("".concat(trgDim.width)) - pL * 2 - bWidth + un;
          h = "auto";
        }
      }
      plh.style.top = t + un;
      plh.style.left = l + un;
      if (w)
        plh.style.width = w;
      if (h)
        plh.style.height = h;
    };
    Sorter2.prototype.parents = function(model) {
      return model ? [model].concat(this.parents(model.parent())) : [];
    };
    Sorter2.prototype.sort = function(obj1, obj2) {
      var ancesters = obj1.parents.filter(function(p) {
        return obj2.parents.includes(p);
      });
      var ancester = ancesters[0];
      if (!ancester) {
        return obj2.model.index() - obj1.model.index();
      }
      var s1 = obj1.parents[obj1.parents.indexOf(ancester) - 1];
      var s2 = obj2.parents[obj2.parents.indexOf(ancester) - 1];
      return s2.index() - s1.index();
    };
    Sorter2.prototype.endMove = function() {
      var _this = this;
      var _a2;
      var src2 = this.sourceEl;
      var moved = [];
      var docs = this.getDocuments();
      var container = this.getContainerEl();
      var onEndMove = this.onEndMove;
      var onEnd = this.onEnd;
      var _b = this, target = _b.target, lastPos = _b.lastPos;
      var srcModel;
      (0, dom.AU)(container, "mousemove dragover", this.onMove);
      (0, dom.AU)(docs, "mouseup dragend touchend", this.endMove);
      (0, dom.AU)(docs, "keydown", this.rollback);
      this.plh.style.display = "none";
      if (src2) {
        srcModel = this.getSourceModel();
      }
      if (this.moved && target) {
        var toMove = this.toMove;
        var toMoveArr = (0, index_all.isArray)(toMove) ? toMove : toMove ? [toMove] : [src2];
        var domPositionOffset_1 = 0;
        if (toMoveArr.length === 1) {
          moved.push(this.move(target, toMoveArr[0], lastPos));
        } else {
          toMoveArr.map(function(model) {
            return {
              model,
              parents: _this.parents(model)
            };
          }).sort(this.sort).forEach(function(_a3) {
            var model = _a3.model;
            var index2 = model.index();
            var parent = model.parent().getEl();
            moved.push(_this.move(target, model, Sorter_assign(Sorter_assign({}, lastPos), { indexEl: lastPos.indexEl - domPositionOffset_1, index: lastPos.index - domPositionOffset_1 })));
            if (parent === target && index2 <= lastPos.index) {
              domPositionOffset_1++;
            }
          });
        }
      }
      if (this.plh)
        this.plh.style.display = "none";
      var dragHelper = this.dragHelper;
      if (dragHelper) {
        dragHelper.parentNode.removeChild(dragHelper);
        delete this.dragHelper;
      }
      this.disableTextable();
      this.selectTargetModel();
      this.toggleSortCursor();
      (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.Canvas.removeSpots(spotTarget);
      delete this.toMove;
      delete this.eventMove;
      delete this.dropModel;
      if ((0, index_all.isFunction)(onEndMove)) {
        var data_1 = {
          target: srcModel,
          // @ts-ignore
          parent: srcModel && srcModel.parent(),
          // @ts-ignore
          index: srcModel && srcModel.index()
        };
        moved.length ? moved.forEach(function(m) {
          return onEndMove(m, _this, data_1);
        }) : onEndMove(null, this, Sorter_assign(Sorter_assign({}, data_1), { cancelled: 1 }));
      }
      (0, index_all.isFunction)(onEnd) && onEnd({ sorter: this });
    };
    Sorter2.prototype.move = function(dst, src2, pos) {
      var _a2 = this, em = _a2.em, dropContent = _a2.dropContent;
      var srcEl = (0, mixins.getElement)(src2);
      var warns = [];
      var index2 = pos.method === "after" ? pos.indexEl + 1 : pos.indexEl;
      var validResult = this.validTarget(dst, srcEl);
      var targetCollection = (0, cash_dom["default"])(dst).data("collection");
      var trgModel = validResult.trgModel, srcModel = validResult.srcModel, draggable = validResult.draggable;
      var droppable2 = trgModel instanceof common.pM ? 1 : validResult.droppable;
      var modelToDrop, created;
      if (targetCollection && droppable2 && draggable) {
        var opts = { at: index2, action: "move-component" };
        var isTextable = this.isTextableActive(srcModel, trgModel);
        if (!dropContent) {
          var srcIndex = srcModel.collection.indexOf(srcModel);
          var sameCollection = targetCollection === srcModel.collection;
          var sameIndex = srcIndex === index2 || srcIndex === index2 - 1;
          var canRemove = !sameCollection || !sameIndex || isTextable;
          if (canRemove) {
            modelToDrop = srcModel.collection.remove(srcModel, {
              temporary: true
            });
            if (sameCollection && index2 > srcIndex) {
              opts.at = index2 - 1;
            }
          }
        } else {
          modelToDrop = (0, index_all.isFunction)(dropContent) ? dropContent() : dropContent;
          opts.avoidUpdateStyle = true;
          opts.action = "add-component";
        }
        if (modelToDrop) {
          if (isTextable) {
            delete opts.at;
            created = trgModel.getView().insertComponent(modelToDrop, opts);
          } else {
            created = targetCollection.add(modelToDrop, opts);
          }
        }
        delete this.dropContent;
        delete this.prevTarget;
      } else if (em) {
        var dropInfo = validResult.dropInfo || (trgModel === null || trgModel === void 0 ? void 0 : trgModel.get("droppable"));
        var dragInfo = validResult.dragInfo || (srcModel === null || srcModel === void 0 ? void 0 : srcModel.get("draggable"));
        !targetCollection && warns.push("Target collection not found");
        !droppable2 && dropInfo && warns.push("Target is not droppable, accepts [".concat(dropInfo, "]"));
        !draggable && dragInfo && warns.push("Component not draggable, acceptable by [".concat(dragInfo, "]"));
        em.logWarning("Invalid target position", {
          errors: warns,
          model: srcModel,
          context: "sorter",
          target: trgModel
        });
      }
      em === null || em === void 0 ? void 0 : em.trigger("sorter:drag:end", {
        targetCollection,
        modelToDrop,
        warns,
        validResult,
        dst,
        srcEl
      });
      return created;
    };
    Sorter2.prototype.rollback = function(e) {
      (0, dom.AU)(this.getDocuments(), "keydown", this.rollback);
      var key = e.which || e.keyCode;
      if (key == 27) {
        this.moved = false;
        this.endMove();
      }
    };
    return Sorter2;
  }(common.Ss)
);
var utils_Sorter = Sorter;
var Resizer_assign = function() {
  Resizer_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Resizer_assign.apply(this, arguments);
};
var createHandler = function(name, opts) {
  if (opts === void 0) {
    opts = {};
  }
  var pfx = opts.prefix || "";
  var el = document.createElement("i");
  el.className = pfx + "resizer-h " + pfx + "resizer-h-" + name;
  el.setAttribute("data-" + pfx + "handler", name);
  return el;
};
var getBoundingRect = function(el, win) {
  var w = win || window;
  var rect = el.getBoundingClientRect();
  return {
    left: rect.left + w.pageXOffset,
    top: rect.top + w.pageYOffset,
    width: rect.width,
    height: rect.height
  };
};
var Resizer = (
  /** @class */
  function() {
    function Resizer2(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.defOpts = {
        ratioDefault: false,
        onUpdateContainer: function() {
        },
        step: 1,
        minDim: 10,
        maxDim: Infinity,
        unitHeight: "px",
        unitWidth: "px",
        keyHeight: "height",
        keyWidth: "width",
        currentUnit: true,
        silentFrames: false,
        avoidContainerUpdate: false,
        keepAutoHeight: false,
        keepAutoWidth: false,
        autoHeight: false,
        autoWidth: false,
        tl: true,
        tc: true,
        tr: true,
        cl: true,
        cr: true,
        bl: true,
        bc: true,
        br: true
      };
      this.opts = Resizer_assign({}, this.defOpts);
      this.setOptions(opts);
      (0, index_all.bindAll)(this, "handleKeyDown", "handleMouseDown", "move", "stop");
    }
    Resizer2.prototype.getConfig = function() {
      return this.opts;
    };
    Resizer2.prototype.setOptions = function(options, reset) {
      if (options === void 0) {
        options = {};
      }
      this.opts = Resizer_assign(Resizer_assign({}, reset ? this.defOpts : this.opts), options);
      this.setup();
    };
    Resizer2.prototype.setup = function() {
      var opts = this.opts;
      var pfx = opts.prefix || "";
      var appendTo = opts.appendTo || document.body;
      var container = this.container;
      if (!container) {
        container = document.createElement("div");
        container.className = "".concat(pfx, "resizer-c");
        appendTo.appendChild(container);
        this.container = container;
      }
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      var handlers = {};
      ["tl", "tc", "tr", "cl", "cr", "bl", "bc", "br"].forEach(
        // @ts-ignore
        function(hdl) {
          return handlers[hdl] = opts[hdl] ? createHandler(hdl, opts) : null;
        }
      );
      for (var n in handlers) {
        var handler = handlers[n];
        handler && container.appendChild(handler);
      }
      this.handlers = handlers;
      this.mousePosFetcher = opts.mousePosFetcher;
      this.updateTarget = opts.updateTarget;
      this.posFetcher = opts.posFetcher;
      this.onStart = opts.onStart;
      this.onMove = opts.onMove;
      this.onEnd = opts.onEnd;
      this.onUpdateContainer = opts.onUpdateContainer;
    };
    Resizer2.prototype.toggleFrames = function(silent) {
      if (this.opts.silentFrames) {
        var frames_1 = document.querySelectorAll("iframe");
        (0, index_all.each)(frames_1, function(frame) {
          return frame.style.pointerEvents = silent ? "none" : "";
        });
      }
    };
    Resizer2.prototype.isHandler = function(el) {
      var handlers = this.handlers;
      for (var n in handlers) {
        if (handlers[n] === el)
          return true;
      }
      return false;
    };
    Resizer2.prototype.getFocusedEl = function() {
      return this.el;
    };
    Resizer2.prototype.getParentEl = function() {
      var _a2;
      return (_a2 = this.el) === null || _a2 === void 0 ? void 0 : _a2.parentElement;
    };
    Resizer2.prototype.getDocumentEl = function() {
      return [this.el.ownerDocument, document];
    };
    Resizer2.prototype.getElementPos = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var posFetcher = this.posFetcher;
      return posFetcher ? posFetcher(el, opts) : getBoundingRect(el);
    };
    Resizer2.prototype.focus = function(el) {
      if (el && el === this.el) {
        return;
      }
      this.el = el;
      this.updateContainer({ forceShow: true });
      (0, dom.on)(this.getDocumentEl(), "pointerdown", this.handleMouseDown);
    };
    Resizer2.prototype.blur = function() {
      this.container.style.display = "none";
      if (this.el) {
        (0, dom.AU)(this.getDocumentEl(), "pointerdown", this.handleMouseDown);
        delete this.el;
      }
    };
    Resizer2.prototype.start = function(ev) {
      var e = ev;
      if (e.button !== 0)
        return;
      e.preventDefault();
      e.stopPropagation();
      var el = this.el;
      var parentEl = this.getParentEl();
      var resizer = this;
      var config2 = this.opts || {};
      var mouseFetch = this.mousePosFetcher;
      var attrName = "data-" + config2.prefix + "handler";
      var rect = this.getElementPos(el, { avoidFrameZoom: true, avoidFrameOffset: true });
      var parentRect = this.getElementPos(parentEl);
      var target = e.target;
      this.handlerAttr = target.getAttribute(attrName);
      this.clickedHandler = target;
      this.startDim = {
        t: rect.top,
        l: rect.left,
        w: rect.width,
        h: rect.height
      };
      this.rectDim = {
        t: rect.top,
        l: rect.left,
        w: rect.width,
        h: rect.height
      };
      this.startPos = mouseFetch ? mouseFetch(e) : {
        x: e.clientX,
        y: e.clientY
      };
      this.parentDim = {
        t: parentRect.top,
        l: parentRect.left,
        w: parentRect.width,
        h: parentRect.height
      };
      var docs = this.getDocumentEl();
      this.docs = docs;
      (0, dom.on)(docs, "pointermove", this.move);
      (0, dom.on)(docs, "keydown", this.handleKeyDown);
      (0, dom.on)(docs, "pointerup", this.stop);
      (0, index_all.isFunction)(this.onStart) && this.onStart(e, { docs, config: config2, el, resizer });
      this.toggleFrames(true);
      this.move(e);
    };
    Resizer2.prototype.move = function(ev) {
      var e = ev;
      var onMove = this.onMove;
      var mouseFetch = this.mousePosFetcher;
      var currentPos = mouseFetch ? mouseFetch(e) : {
        x: e.clientX,
        y: e.clientY
      };
      this.currentPos = currentPos;
      this.delta = {
        x: currentPos.x - this.startPos.x,
        y: currentPos.y - this.startPos.y
      };
      this.keys = {
        shift: e.shiftKey,
        ctrl: e.ctrlKey,
        alt: e.altKey
      };
      this.rectDim = this.calc(this);
      this.updateRect(false);
      onMove && onMove(e);
    };
    Resizer2.prototype.stop = function(e) {
      var el = this.el;
      var config2 = this.opts;
      var docs = this.docs || this.getDocumentEl();
      (0, dom.AU)(docs, "pointermove", this.move);
      (0, dom.AU)(docs, "keydown", this.handleKeyDown);
      (0, dom.AU)(docs, "pointerup", this.stop);
      this.updateRect(true);
      this.toggleFrames();
      (0, index_all.isFunction)(this.onEnd) && this.onEnd(e, { docs, config: config2, el, resizer: this });
      delete this.docs;
    };
    Resizer2.prototype.updateRect = function(store) {
      var el = this.el;
      var resizer = this;
      var config2 = this.opts;
      var rect = this.rectDim;
      var updateTarget = this.updateTarget;
      var selectedHandler = this.getSelectedHandler();
      var unitHeight = config2.unitHeight, unitWidth = config2.unitWidth, keyWidth = config2.keyWidth, keyHeight = config2.keyHeight;
      if ((0, index_all.isFunction)(updateTarget)) {
        updateTarget(el, rect, {
          store,
          selectedHandler,
          resizer,
          config: config2
        });
      } else {
        var elStyle = el.style;
        elStyle[keyWidth] = rect.w + unitWidth;
        elStyle[keyHeight] = rect.h + unitHeight;
      }
      this.updateContainer();
    };
    Resizer2.prototype.updateContainer = function(opt) {
      var _a2;
      if (opt === void 0) {
        opt = {};
      }
      var _b = this, opts = _b.opts, container = _b.container, el = _b.el;
      var style = container.style;
      if (!opts.avoidContainerUpdate && el) {
        if (opt.forceShow)
          style.display = "block";
      }
      (_a2 = this.onUpdateContainer) === null || _a2 === void 0 ? void 0 : _a2.call(this, {
        el: container,
        resizer: this,
        opts: Resizer_assign(Resizer_assign({}, opts), opt)
      });
    };
    Resizer2.prototype.getSelectedHandler = function() {
      var handlers = this.handlers;
      if (!this.selectedHandler) {
        return;
      }
      for (var n in handlers) {
        if (handlers[n] === this.selectedHandler)
          return n;
      }
    };
    Resizer2.prototype.handleKeyDown = function(e) {
      if (e.keyCode === 27) {
        this.rectDim = this.startDim;
        this.stop(e);
      }
    };
    Resizer2.prototype.handleMouseDown = function(e) {
      var el = e.target;
      if (this.isHandler(el)) {
        this.selectedHandler = el;
        this.start(e);
      } else if (el !== this.el) {
        delete this.selectedHandler;
        this.blur();
      }
    };
    Resizer2.prototype.calc = function(data) {
      var value;
      var opts = this.opts || {};
      var step = opts.step;
      var startDim = this.startDim;
      var minDim = opts.minDim;
      var maxDim = opts.maxDim;
      var deltaX = data.delta.x;
      var deltaY = data.delta.y;
      var parentW = this.parentDim.w;
      var parentH = this.parentDim.h;
      var unitWidth = this.opts.unitWidth;
      var unitHeight = this.opts.unitHeight;
      var startW = unitWidth === "%" ? startDim.w / 100 * parentW : startDim.w;
      var startH = unitHeight === "%" ? startDim.h / 100 * parentH : startDim.h;
      var box = {
        t: startDim.t,
        l: startDim.l,
        w: startW,
        h: startH
      };
      if (!data)
        return;
      var attr = data.handlerAttr;
      if (~attr.indexOf("r")) {
        value = unitWidth === "%" ? (0, mixins.normalizeFloat)((startW + deltaX * step) / parentW * 100, 0.01) : (0, mixins.normalizeFloat)(startW + deltaX * step, step);
        value = Math.max(minDim, value);
        maxDim && (value = Math.min(maxDim, value));
        box.w = value;
      }
      if (~attr.indexOf("b")) {
        value = unitHeight === "%" ? (0, mixins.normalizeFloat)((startH + deltaY * step) / parentH * 100, 0.01) : (0, mixins.normalizeFloat)(startH + deltaY * step, step);
        value = Math.max(minDim, value);
        maxDim && (value = Math.min(maxDim, value));
        box.h = value;
      }
      if (~attr.indexOf("l")) {
        value = unitWidth === "%" ? (0, mixins.normalizeFloat)((startW - deltaX * step) / parentW * 100, 0.01) : (0, mixins.normalizeFloat)(startW - deltaX * step, step);
        value = Math.max(minDim, value);
        maxDim && (value = Math.min(maxDim, value));
        box.w = value;
      }
      if (~attr.indexOf("t")) {
        value = unitHeight === "%" ? (0, mixins.normalizeFloat)((startH - deltaY * step) / parentH * 100, 0.01) : (0, mixins.normalizeFloat)(startH - deltaY * step, step);
        value = Math.max(minDim, value);
        maxDim && (value = Math.min(maxDim, value));
        box.h = value;
      }
      var ratioActive = opts.ratioDefault ? !data.keys.shift : data.keys.shift;
      if (attr.indexOf("c") < 0 && ratioActive) {
        var ratio = startDim.w / startDim.h;
        if (box.w / box.h > ratio) {
          box.h = Math.round(box.w / ratio);
        } else {
          box.w = Math.round(box.h * ratio);
        }
      }
      if (~attr.indexOf("l")) {
        box.l += startDim.w - box.w;
      }
      if (~attr.indexOf("t")) {
        box.t += startDim.h - box.h;
      }
      for (var key in box) {
        var i = key;
        box[i] = parseInt("".concat(box[i]), 10);
      }
      return box;
    };
    return Resizer2;
  }()
);
var utils_Resizer = Resizer;
var utils_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var utils_assign = function() {
  utils_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return utils_assign.apply(this, arguments);
};
var UtilsModule = (
  /** @class */
  function(_super) {
    utils_extends(UtilsModule2, _super);
    function UtilsModule2(em) {
      var _this = _super.call(this, em, "Utils") || this;
      _this.Sorter = utils_Sorter;
      _this.Resizer = utils_Resizer;
      _this.Dragger = Dragger.A;
      _this.helpers = utils_assign({}, mixins);
      return _this;
    }
    UtilsModule2.prototype.destroy = function() {
    };
    return UtilsModule2;
  }(abstract_Module)
);
var utils = UtilsModule;
var k;
var _handlers = {};
var _mods = {
  16: false,
  18: false,
  17: false,
  91: false
};
var _scope = "all";
var _MODIFIERS = {
  "⇧": 16,
  shift: 16,
  "⌥": 18,
  alt: 18,
  option: 18,
  "⌃": 17,
  ctrl: 17,
  control: 17,
  "⌘": 91,
  command: 91
};
var _MAP = {
  backspace: 8,
  tab: 9,
  clear: 12,
  enter: 13,
  return: 13,
  esc: 27,
  escape: 27,
  space: 32,
  left: 37,
  up: 38,
  right: 39,
  down: 40,
  del: 46,
  delete: 46,
  home: 36,
  end: 35,
  pageup: 33,
  pagedown: 34,
  ",": 188,
  ".": 190,
  "/": 191,
  "`": 192,
  "-": 189,
  "=": 187,
  ";": 186,
  "'": 222,
  "[": 219,
  "]": 221,
  "\\": 220
};
var code = function(x) {
  return _MAP[x] || x.toUpperCase().charCodeAt(0);
};
var _downKeys = [];
for (k = 1; k < 20; k++)
  _MAP["f" + k] = 111 + k;
function index(array, item) {
  var i = array.length;
  while (i--)
    if (array[i] === item)
      return i;
  return -1;
}
function compareArray(a1, a2) {
  if (a1.length != a2.length)
    return false;
  for (var i = 0; i < a1.length; i++) {
    if (a1[i] !== a2[i])
      return false;
  }
  return true;
}
var modifierMap = {
  16: "shiftKey",
  18: "altKey",
  17: "ctrlKey",
  91: "metaKey"
};
function updateModifierKey(event) {
  for (k in _mods)
    _mods[k] = event[modifierMap[k]];
}
function dispatch(event) {
  var key, handler, k2, i, modifiersMatch, scope;
  key = event.keyCode;
  if (index(_downKeys, key) == -1) {
    _downKeys.push(key);
  }
  if (key == 93 || key == 224)
    key = 91;
  if (key in _mods) {
    _mods[key] = true;
    for (k2 in _MODIFIERS)
      if (_MODIFIERS[k2] == key)
        assignKey[k2] = true;
    return;
  }
  updateModifierKey(event);
  if (!assignKey.filter.call(this, event))
    return;
  if (!(key in _handlers))
    return;
  scope = getScope();
  for (i = 0; i < _handlers[key].length; i++) {
    handler = _handlers[key][i];
    if (handler.scope == scope || handler.scope == "all") {
      modifiersMatch = handler.mods.length > 0;
      for (k2 in _mods)
        if (!_mods[k2] && index(handler.mods, +k2) > -1 || _mods[k2] && index(handler.mods, +k2) == -1)
          modifiersMatch = false;
      if (handler.mods.length == 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91] || modifiersMatch) {
        if (handler.method(event, handler) === false) {
          if (event.preventDefault)
            event.preventDefault();
          else
            event.returnValue = false;
          if (event.stopPropagation)
            event.stopPropagation();
          if (event.cancelBubble)
            event.cancelBubble = true;
        }
      }
    }
  }
}
function clearModifier(event) {
  var key = event.keyCode, k2, i = index(_downKeys, key);
  if (i >= 0) {
    _downKeys.splice(i, 1);
  }
  if (key == 93 || key == 224)
    key = 91;
  if (key in _mods) {
    _mods[key] = false;
    for (k2 in _MODIFIERS)
      if (_MODIFIERS[k2] == key)
        assignKey[k2] = false;
  }
}
function resetModifiers() {
  for (k in _mods)
    _mods[k] = false;
  for (k in _MODIFIERS)
    assignKey[k] = false;
}
function assignKey(key, scope, method) {
  var keys, mods;
  keys = getKeys(key);
  if (method === void 0) {
    method = scope;
    scope = "all";
  }
  for (var i = 0; i < keys.length; i++) {
    mods = [];
    key = keys[i].split("+");
    if (key.length > 1) {
      mods = getMods(key);
      key = [key[key.length - 1]];
    }
    key = key[0];
    key = code(key);
    if (!(key in _handlers))
      _handlers[key] = [];
    _handlers[key].push({
      shortcut: keys[i],
      scope,
      method,
      key: keys[i],
      mods
    });
  }
}
function unbindKey(key, scope) {
  var multipleKeys, keys, mods = [], i, j, obj;
  multipleKeys = getKeys(key);
  for (j = 0; j < multipleKeys.length; j++) {
    keys = multipleKeys[j].split("+");
    if (keys.length > 1) {
      mods = getMods(keys);
    }
    key = keys[keys.length - 1];
    key = code(key);
    if (scope === void 0) {
      scope = getScope();
    }
    if (!_handlers[key]) {
      return;
    }
    for (i = 0; i < _handlers[key].length; i++) {
      obj = _handlers[key][i];
      if (obj.scope === scope && compareArray(obj.mods, mods)) {
        _handlers[key][i] = {};
      }
    }
  }
}
function isPressed(keyCode) {
  if (typeof keyCode == "string") {
    keyCode = code(keyCode);
  }
  return index(_downKeys, keyCode) != -1;
}
function getPressedKeyCodes() {
  return _downKeys.slice(0);
}
function filter(event) {
  var tagName2 = (event.target || event.srcElement).tagName;
  return !(tagName2 == "INPUT" || tagName2 == "SELECT" || tagName2 == "TEXTAREA");
}
for (k in _MODIFIERS)
  assignKey[k] = false;
function setScope(scope) {
  _scope = scope || "all";
}
function getScope() {
  return _scope || "all";
}
function deleteScope(scope) {
  var key, handlers, i;
  for (key in _handlers) {
    handlers = _handlers[key];
    for (i = 0; i < handlers.length; ) {
      if (handlers[i].scope === scope)
        handlers.splice(i, 1);
      else
        i++;
    }
  }
}
function getKeys(key) {
  var keys;
  key = key.replace(/\s/g, "");
  keys = key.split(",");
  if (keys[keys.length - 1] == "") {
    keys[keys.length - 2] += ",";
  }
  return keys;
}
function getMods(key) {
  var mods = key.slice(0, key.length - 1);
  for (var mi = 0; mi < mods.length; mi++)
    mods[mi] = _MODIFIERS[mods[mi]];
  return mods;
}
function addEvent(object, event, method) {
  if (object.addEventListener)
    object.addEventListener(event, method, false);
  else if (object.attachEvent)
    object.attachEvent("on" + event, function() {
      method(window.event);
    });
}
assignKey.setScope = setScope;
assignKey.getScope = getScope;
assignKey.deleteScope = deleteScope;
assignKey.filter = filter;
assignKey.isPressed = isPressed;
assignKey.getPressedKeyCodes = getPressedKeyCodes;
assignKey.unbind = unbindKey;
assignKey.handlers = _handlers;
assignKey.init = function(win) {
  addEvent(win.document, "keydown", function(event) {
    dispatch(event);
  });
  addEvent(win.document, "keyup", clearModifier);
  addEvent(win, "focus", resetModifiers);
};
var keymaster = assignKey;
var keymaps_config_config = {
  defaults: {
    "core:undo": {
      keys: "⌘+z, ctrl+z",
      handler: "core:undo",
      opts: { prevent: true }
    },
    "core:redo": {
      keys: "⌘+shift+z, ctrl+shift+z",
      handler: "core:redo",
      opts: { prevent: true }
    },
    "core:copy": {
      keys: "⌘+c, ctrl+c",
      handler: "core:copy"
    },
    "core:paste": {
      keys: "⌘+v, ctrl+v",
      handler: "core:paste"
    },
    "core:component-next": {
      keys: "s",
      handler: "core:component-next"
    },
    "core:component-prev": {
      keys: "w",
      handler: "core:component-prev"
    },
    "core:component-enter": {
      keys: "d",
      handler: "core:component-enter"
    },
    "core:component-exit": {
      keys: "a",
      handler: "core:component-exit"
    },
    "core:component-delete": {
      keys: "backspace, delete",
      handler: "core:component-delete",
      opts: { prevent: true }
    }
  }
};
var keymaps_config = keymaps_config_config;
var keymaps_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var keymaps_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
(0, mixins.hasWin)() && keymaster.init(window);
var KeymapsModule = (
  /** @class */
  function(_super) {
    keymaps_extends(KeymapsModule2, _super);
    function KeymapsModule2(em) {
      var _this = _super.call(this, em, "Keymaps", keymaps_config) || this;
      _this.keymaster = keymaster;
      _this.keymaps = {};
      return _this;
    }
    KeymapsModule2.prototype.onLoad = function() {
      var defKeys = this.config.defaults;
      for (var id in defKeys) {
        var value = defKeys[id];
        this.add(id, value.keys, value.handler, value.opts || {});
      }
    };
    KeymapsModule2.prototype.add = function(id, keys, handler, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var cmd = em.Commands;
      var editor = em.getEditor();
      var canvas2 = em.Canvas;
      var keymap = { id, keys, handler };
      var pk = this.keymaps[id];
      pk && this.remove(id);
      this.keymaps[id] = keymap;
      keymaster(keys, function(e, h) {
        var opt = { event: e, h };
        var handlerRes = (0, index_all.isString)(handler) ? cmd.get(handler) : handler;
        var ableTorun = !em.isEditing() && !editor.Canvas.isInputFocused();
        if (ableTorun || opts.force) {
          opts.prevent && canvas2.getCanvasView().preventDefault(e);
          (0, index_all.isFunction)(handlerRes) ? handlerRes(editor, 0, opt) : cmd.runCommand(handlerRes, opt);
          var args = [id, h.shortcut, e];
          em.trigger.apply(em, keymaps_spreadArray(["keymap:emit"], args, false));
          em.trigger.apply(em, keymaps_spreadArray(["keymap:emit:".concat(id)], args, false));
        }
      }, void 0);
      em.trigger("keymap:add", keymap);
      return keymap;
    };
    KeymapsModule2.prototype.get = function(id) {
      return this.keymaps[id];
    };
    KeymapsModule2.prototype.getAll = function() {
      return this.keymaps;
    };
    KeymapsModule2.prototype.remove = function(id) {
      var em = this.em;
      var keymap = this.get(id);
      if (keymap) {
        delete this.keymaps[id];
        keymap.keys.split(", ").forEach(function(k2) {
          keymaster.unbind(k2.trim());
        });
        em === null || em === void 0 ? void 0 : em.trigger("keymap:remove", keymap);
        return keymap;
      }
    };
    KeymapsModule2.prototype.removeAll = function() {
      var _this = this;
      Object.keys(this.keymaps).forEach(function(keymap) {
        return _this.remove(keymap);
      });
      keymaster.handlers = {};
      return this;
    };
    KeymapsModule2.prototype.destroy = function() {
      this.removeAll();
      this.keymaps = {};
    };
    return KeymapsModule2;
  }(abstract_Module)
);
var keymaps = KeymapsModule;
var modal_dialog_config_config_config = {
  stylePrefix: "mdl-",
  title: "",
  content: "",
  backdrop: true,
  custom: false,
  extend: {}
};
var modal_dialog_config_config = modal_dialog_config_config_config;
var Modal_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Modal = (
  /** @class */
  function(_super) {
    Modal_extends(Modal2, _super);
    function Modal2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Modal2.prototype.defaults = function() {
      return {
        title: "",
        content: "",
        attributes: {},
        open: false
      };
    };
    Modal2.prototype.open = function() {
      this.set("open", true);
    };
    Modal2.prototype.close = function() {
      this.set("open", false);
    };
    return Modal2;
  }(ModuleModel.A)
);
var model_Modal = Modal;
var ModalView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModalView_assign = function() {
  ModalView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ModalView_assign.apply(this, arguments);
};
var ModalView = (
  /** @class */
  function(_super) {
    ModalView_extends(ModalView2, _super);
    function ModalView2(o) {
      var _this = _super.call(this, o) || this;
      var model = _this.model;
      _this.listenTo(model, "change:open", _this.updateOpen);
      _this.listenTo(model, "change:title", _this.updateTitle);
      _this.listenTo(model, "change:content", _this.updateContent);
      return _this;
    }
    ModalView2.prototype.template = function(_a2) {
      var pfx = _a2.pfx, ppfx = _a2.ppfx, content = _a2.content, title = _a2.title;
      return '<div class="'.concat(pfx, "dialog ").concat(ppfx, "one-bg ").concat(ppfx, 'two-color">\n      <div class="').concat(pfx, 'header">\n        <div class="').concat(pfx, 'title">').concat(title, '</div>\n        <div class="').concat(pfx, 'btn-close" data-close-modal>&Cross;</div>\n      </div>\n      <div class="').concat(pfx, 'content">\n        <div id="').concat(pfx, 'c">').concat(content, '</div>\n        <div style="clear:both"></div>\n      </div>\n    </div>\n    <div class="').concat(pfx, 'collector" style="display: none"></div>');
    };
    ModalView2.prototype.events = function() {
      return {
        click: "onClick",
        "click [data-close-modal]": "hide"
      };
    };
    ModalView2.prototype.onClick = function(e) {
      var bkd = this.config.backdrop;
      bkd && e.target === this.el && this.hide();
    };
    ModalView2.prototype.getCollector = function() {
      if (!this.$collector)
        this.$collector = this.$el.find("." + this.pfx + "collector");
      return this.$collector;
    };
    ModalView2.prototype.getContent = function() {
      var pfx = this.pfx;
      if (!this.$content) {
        this.$content = this.$el.find(".".concat(pfx, "content #").concat(pfx, "c"));
      }
      return this.$content;
    };
    ModalView2.prototype.getTitle = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (!this.$title)
        this.$title = this.$el.find("." + this.pfx + "title");
      return opts.$ ? this.$title : this.$title.get(0);
    };
    ModalView2.prototype.updateContent = function() {
      var content = this.getContent();
      var children = content.children();
      var coll = this.getCollector();
      var body = this.model.get("content");
      children.length && coll.append(children);
      content.empty().append(body);
    };
    ModalView2.prototype.updateTitle = function() {
      var title = this.getTitle({ $: true });
      title && title.empty().append(this.model.get("title"));
    };
    ModalView2.prototype.updateOpen = function() {
      this.el.style.display = this.model.get("open") ? "" : "none";
    };
    ModalView2.prototype.hide = function() {
      this.model.close();
    };
    ModalView2.prototype.show = function() {
      this.model.open();
    };
    ModalView2.prototype.updateAttr = function(attr) {
      var _a2 = this, pfx = _a2.pfx, $el = _a2.$el, el = _a2.el;
      var currAttr = [].slice.call(el.attributes).map(function(i) {
        return i.name;
      });
      $el.removeAttr(currAttr.join(" "));
      $el.attr(ModalView_assign(ModalView_assign({}, attr || {}), { class: "".concat(pfx, "container ").concat(attr && attr.class || "").trim() }));
    };
    ModalView2.prototype.render = function() {
      var el = this.$el;
      var obj = this.model.toJSON();
      obj.pfx = this.pfx;
      obj.ppfx = this.ppfx;
      el.html(this.template(obj));
      this.updateAttr();
      this.updateOpen();
      return this;
    };
    return ModalView2;
  }(abstract_ModuleView)
);
var view_ModalView = ModalView;
var modal_dialog_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ModalModule = (
  /** @class */
  function(_super) {
    modal_dialog_extends(ModalModule2, _super);
    function ModalModule2(em) {
      var _this = _super.call(this, em, "Modal", modal_dialog_config_config) || this;
      _this.model = new model_Modal(_this);
      _this.model.on("change:open", function(m, enable) {
        em.trigger("modal:".concat(enable ? "open" : "close"));
      });
      _this.model.on("change", (0, index_all.debounce)(function() {
        var data = _this._evData();
        var custom = _this.config.custom;
        (0, index_all.isFunction)(custom) && custom(data);
        em.trigger("modal", data);
      }, 0));
      return _this;
    }
    ModalModule2.prototype._evData = function() {
      var _this = this;
      var titl = this.getTitle();
      var cnt = this.getContent();
      var _a2 = this.model.attributes, open = _a2.open, attributes = _a2.attributes;
      return {
        open,
        attributes,
        title: (0, index_all.isString)(titl) ? (0, dom.GZ)(titl) : titl,
        //@ts-ignore
        content: (0, index_all.isString)(cnt) ? (0, dom.GZ)(cnt) : cnt.get ? cnt.get(0) : cnt,
        close: function() {
          _this.close();
        }
      };
    };
    ModalModule2.prototype.postRender = function(view) {
      var el = view.model.config.el || view.el;
      var res = this.render();
      res && (el === null || el === void 0 ? void 0 : el.appendChild(res));
    };
    ModalModule2.prototype.open = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var attr = opts.attributes || {};
      opts.title && this.setTitle(opts.title);
      opts.content && this.setContent(opts.content);
      this.model.set("attributes", attr);
      this.model.open();
      this.modal && this.modal.updateAttr(attr);
      return this;
    };
    ModalModule2.prototype.close = function() {
      this.model.close();
      return this;
    };
    ModalModule2.prototype.onceClose = function(clb) {
      this.em.once("modal:close", clb);
      return this;
    };
    ModalModule2.prototype.onceOpen = function(clb) {
      this.em.once("modal:open", clb);
      return this;
    };
    ModalModule2.prototype.isOpen = function() {
      return !!this.model.get("open");
    };
    ModalModule2.prototype.setTitle = function(title) {
      this.model.set("title", title);
      return this;
    };
    ModalModule2.prototype.getTitle = function() {
      return this.model.get("title");
    };
    ModalModule2.prototype.setContent = function(content) {
      this.model.set("content", " ");
      this.model.set("content", content);
      return this;
    };
    ModalModule2.prototype.getContent = function() {
      return this.model.get("content");
    };
    ModalModule2.prototype.getContentEl = function() {
      var _a2;
      return (_a2 = this.modal) === null || _a2 === void 0 ? void 0 : _a2.getContent().get(0);
    };
    ModalModule2.prototype.getModel = function() {
      return this.model;
    };
    ModalModule2.prototype.render = function() {
      var _a2;
      if (this.config.custom)
        return;
      var View = view_ModalView.extend(this.config.extend);
      var el = this.modal && this.modal.el;
      this.modal = new View({
        el,
        model: this.model,
        config: this.config
      });
      return (_a2 = this.modal) === null || _a2 === void 0 ? void 0 : _a2.render().el;
    };
    ModalModule2.prototype.destroy = function() {
      var _a2;
      (_a2 = this.modal) === null || _a2 === void 0 ? void 0 : _a2.remove();
    };
    return ModalModule2;
  }(abstract_Module)
);
var modal_dialog = ModalModule;
var swv = "sw-visibility";
var expt = "export-template";
var osm = "open-sm";
var otm = "open-tm";
var ola = "open-layers";
var obl = "open-blocks";
var ful = "fullscreen";
var prv = "preview";
var panels_config_config_config = {
  stylePrefix: "pn-",
  defaults: [
    {
      id: "commands",
      buttons: [{}]
    },
    {
      id: "options",
      buttons: [
        {
          active: true,
          id: swv,
          className: "fa fa-square-o",
          command: "core:component-outline",
          context: swv,
          attributes: { title: "View components" }
        },
        {
          id: prv,
          className: "fa fa-eye",
          command: prv,
          context: prv,
          attributes: { title: "Preview" }
        },
        {
          id: ful,
          className: "fa fa-arrows-alt",
          command: ful,
          context: ful,
          attributes: { title: "Fullscreen" }
        },
        {
          id: expt,
          className: "fa fa-code",
          command: expt,
          attributes: { title: "View code" }
        }
      ]
    },
    {
      id: "views",
      buttons: [
        {
          id: osm,
          className: "fa fa-paint-brush",
          command: osm,
          active: true,
          togglable: false,
          attributes: { title: "Open Style Manager" }
        },
        {
          id: otm,
          className: "fa fa-cog",
          command: otm,
          togglable: false,
          attributes: { title: "Settings" }
        },
        {
          id: ola,
          className: "fa fa-bars",
          command: ola,
          togglable: false,
          attributes: { title: "Open Layer Manager" }
        },
        {
          id: obl,
          className: "fa fa-th-large",
          command: obl,
          togglable: false,
          attributes: { title: "Open Blocks" }
        }
      ]
    }
  ]
};
var panels_config_config = panels_config_config_config;
var Button_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Button = (
  /** @class */
  function(_super) {
    Button_extends(Button2, _super);
    function Button2(module, options) {
      var _this = _super.call(this, module, options) || this;
      if (_this.get("buttons").length) {
        _this.set("buttons", new model_Buttons(_this.module, _this.get("buttons")));
      }
      return _this;
    }
    Button2.prototype.defaults = function() {
      return {
        id: "",
        label: "",
        tagName: "span",
        className: "",
        command: "",
        context: "",
        buttons: [],
        attributes: {},
        options: {},
        active: false,
        dragDrop: false,
        togglable: true,
        runDefaultCommand: true,
        stopDefaultCommand: false,
        disable: false
      };
    };
    Object.defineProperty(Button2.prototype, "className", {
      get: function() {
        return this.get("className");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Button2.prototype, "command", {
      get: function() {
        return this.get("command");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Button2.prototype, "active", {
      get: function() {
        return this.get("active");
      },
      set: function(isActive) {
        this.set("active", isActive);
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Button2.prototype, "togglable", {
      get: function() {
        return this.get("togglable");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Button2.prototype, "runDefaultCommand", {
      get: function() {
        return this.get("runDefaultCommand");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Button2.prototype, "stopDefaultCommand", {
      get: function() {
        return this.get("stopDefaultCommand");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Button2.prototype, "disable", {
      get: function() {
        return this.get("disable");
      },
      enumerable: false,
      configurable: true
    });
    return Button2;
  }(ModuleModel.A)
);
var model_Button = Button;
var Buttons_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Buttons = (
  /** @class */
  function(_super) {
    Buttons_extends(Buttons2, _super);
    function Buttons2(module, models) {
      return _super.call(this, module, models, model_Button) || this;
    }
    Buttons2.prototype.deactivateAllExceptOne = function(except, r) {
      this.forEach(function(model, index2) {
        if (model !== except) {
          model.set("active", false);
          if (r && model.get("buttons").length)
            model.get("buttons").deactivateAllExceptOne(except, r);
        }
      });
    };
    Buttons2.prototype.deactivateAll = function(ctx, sender) {
      var context = ctx || "";
      this.forEach(function(model) {
        if (model.get("context") == context && model !== sender) {
          model.set("active", false, { fromCollection: true });
        }
      });
    };
    Buttons2.prototype.disableAllButtons = function(ctx) {
      var context = ctx || "";
      this.forEach(function(model, index2) {
        if (model.get("context") == context) {
          model.set("disable", true);
        }
      });
    };
    Buttons2.prototype.disableAllButtonsExceptOne = function(except, r) {
      this.forEach(function(model, index2) {
        if (model !== except) {
          model.set("disable", true);
          if (r && model.get("buttons").length)
            model.get("buttons").disableAllButtonsExceptOne(except, r);
        }
      });
    };
    return Buttons2;
  }(abstract_ModuleCollection)
);
var model_Buttons = Buttons;
Buttons.prototype.model = model_Button;
var Panel_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Panel = (
  /** @class */
  function(_super) {
    Panel_extends(Panel2, _super);
    function Panel2(module, options) {
      var _this = _super.call(this, module, options) || this;
      var btn = _this.get("buttons") || [];
      _this.buttons = new model_Buttons(module, btn);
      return _this;
    }
    Panel2.prototype.defaults = function() {
      return {
        id: "",
        content: "",
        visible: true,
        buttons: [],
        attributes: {}
      };
    };
    Object.defineProperty(Panel2.prototype, "buttons", {
      get: function() {
        return this.get("buttons");
      },
      set: function(buttons) {
        this.set("buttons", buttons);
      },
      enumerable: false,
      configurable: true
    });
    return Panel2;
  }(ModuleModel.A)
);
var model_Panel = Panel;
var Panels_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Panels = (
  /** @class */
  function(_super) {
    Panels_extends(Panels2, _super);
    function Panels2(module, models) {
      return _super.call(this, module, models, model_Panel) || this;
    }
    return Panels2;
  }(abstract_ModuleCollection)
);
var model_Panels = Panels;
Panels.prototype.model = model_Panel;
var ButtonView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ButtonView_assign = function() {
  ButtonView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return ButtonView_assign.apply(this, arguments);
};
var ButtonView = (
  /** @class */
  function(_super) {
    ButtonView_extends(ButtonView2, _super);
    function ButtonView2(o) {
      var _this = _super.call(this, o) || this;
      var _a2 = _this, model = _a2.model, em = _a2.em, pfx = _a2.pfx, ppfx = _a2.ppfx;
      var cls = model.className;
      var _b = model.attributes, command = _b.command, listen = _b.listen;
      _this.id = pfx + model.get("id");
      _this.activeCls = "".concat(pfx, "active ").concat(ppfx, "four-color");
      _this.disableCls = "".concat(ppfx, "disabled");
      _this.btnsVisCls = "".concat(pfx, "visible");
      _this.className = pfx + "btn" + (cls ? " " + cls : "");
      _this.listenTo(model, "change", _this.render);
      _this.listenTo(model, "change:active updateActive", _this.updateActive);
      _this.listenTo(model, "checkActive", _this.checkActive);
      _this.listenTo(model, "change:bntsVis", _this.updateBtnsVis);
      _this.listenTo(model, "change:attributes", _this.updateAttributes);
      _this.listenTo(model, "change:className", _this.updateClassName);
      _this.listenTo(model, "change:disable", _this.updateDisable);
      if (em && (0, index_all.isString)(command) && listen) {
        var chnOpt_1 = { fromListen: true };
        _this.listenTo(em, "run:".concat(command), function() {
          return model.set("active", true, chnOpt_1);
        });
        _this.listenTo(em, "stop:".concat(command), function() {
          return model.set("active", false, chnOpt_1);
        });
      }
      if (em && em.get)
        _this.commands = em.get("Commands");
      return _this;
    }
    ButtonView2.prototype.tagName = function() {
      return this.model.get("tagName");
    };
    ButtonView2.prototype.events = function() {
      return {
        click: "clicked"
      };
    };
    ButtonView2.prototype.updateClassName = function() {
      var _a2 = this, model = _a2.model, pfx = _a2.pfx;
      var cls = model.className;
      var attrCls = model.get("attributes").class;
      var classStr = "".concat(attrCls ? attrCls : "", " ").concat(pfx, "btn ").concat(cls ? cls : "");
      this.$el.attr("class", classStr.trim());
    };
    ButtonView2.prototype.updateAttributes = function() {
      var _a2 = this, em = _a2.em, model = _a2.model, $el = _a2.$el;
      var attr = model.get("attributes") || {};
      var title = em && em.t && em.t("panels.buttons.titles.".concat(model.id));
      $el.attr(attr);
      title && $el.attr({ title });
      this.updateClassName();
    };
    ButtonView2.prototype.updateBtnsVis = function() {
      if (!this.$buttons)
        return;
      if (this.model.get("bntsVis"))
        this.$buttons.addClass(this.btnsVisCls);
      else
        this.$buttons.removeClass(this.btnsVisCls);
    };
    ButtonView2.prototype.updateActive = function(m, v, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = this, model = _b.model, commands2 = _b.commands, $el = _b.$el, activeCls = _b.activeCls;
      var fromCollection = opts.fromCollection, fromListen = opts.fromListen;
      var context = model.get("context");
      var options = model.get("options");
      var commandName = model.command;
      var command = {};
      if (!commandName)
        return;
      if (commands2 && (0, index_all.isString)(commandName)) {
        command = commands2.get(commandName) || {};
      } else if ((0, index_all.isFunction)(commandName)) {
        command = commands2.create({ run: commandName });
      } else if (commandName !== null && (0, index_all.isObject)(commandName)) {
        command = commands2.create(commandName);
      }
      if (model.active) {
        !fromCollection && ((_a2 = model.collection) === null || _a2 === void 0 ? void 0 : _a2.deactivateAll(context, model));
        model.set("active", true, { silent: true }).trigger("checkActive");
        !fromListen && commands2.runCommand(command, ButtonView_assign(ButtonView_assign({}, options), { sender: model }));
        command.noStop && model.set("active", false);
      } else {
        $el.removeClass(activeCls);
        !fromListen && commands2.stopCommand(command, ButtonView_assign(ButtonView_assign({}, options), { sender: model, force: 1 }));
      }
    };
    ButtonView2.prototype.updateDisable = function() {
      var _a2 = this, disableCls = _a2.disableCls, model = _a2.model;
      var disable = model.disable;
      this.$el[disable ? "addClass" : "removeClass"](disableCls);
    };
    ButtonView2.prototype.checkActive = function() {
      var _a2 = this, model = _a2.model, $el = _a2.$el, activeCls = _a2.activeCls;
      model.active ? $el.addClass(activeCls) : $el.removeClass(activeCls);
    };
    ButtonView2.prototype.clicked = function() {
      var model = this.model;
      if (model.get("bntsVis") || model.disable || !model.command)
        return;
      this.toggleActive();
    };
    ButtonView2.prototype.toggleActive = function() {
      var _a2 = this, model = _a2.model, em = _a2.em;
      var active = model.active, togglable = model.togglable;
      if (active && !togglable)
        return;
      model.active = !active;
      if (active) {
        if (model.runDefaultCommand)
          em.runDefault();
      } else {
        if (model.stopDefaultCommand)
          em.stopDefault();
      }
    };
    ButtonView2.prototype.render = function() {
      var model = this.model;
      var label = model.get("label");
      var $el = this.$el;
      !model.get("el") && $el.empty();
      this.updateAttributes();
      label && $el.append(label);
      this.checkActive();
      this.updateDisable();
      return this;
    };
    return ButtonView2;
  }(abstract_ModuleView)
);
var view_ButtonView = ButtonView;
var ButtonsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var ButtonsView = (
  /** @class */
  function(_super) {
    ButtonsView_extends(ButtonsView2, _super);
    function ButtonsView2(collection) {
      var _this = _super.call(this, { collection }) || this;
      _this.listenTo(_this.collection, "add", _this.addTo);
      _this.listenTo(_this.collection, "reset remove", _this.render);
      _this.className = _this.pfx + "buttons";
      return _this;
    }
    ButtonsView2.prototype.addTo = function(model) {
      this.addToCollection(model);
    };
    ButtonsView2.prototype.addToCollection = function(model, fragmentEl) {
      var fragment = fragmentEl || null;
      var el = model.get("el");
      var view = new view_ButtonView({
        el,
        model
      });
      var rendered = view.render().el;
      if (fragment) {
        fragment.appendChild(rendered);
      } else {
        this.$el.append(rendered);
      }
      return rendered;
    };
    ButtonsView2.prototype.render = function() {
      var _this = this;
      var fragment = document.createDocumentFragment();
      this.$el.empty();
      this.collection.each(function(model) {
        return _this.addToCollection(model, fragment);
      });
      this.$el.append(fragment);
      this.$el.attr("class", (0, index_all.result)(this, "className"));
      return this;
    };
    return ButtonsView2;
  }(abstract_ModuleView)
);
var view_ButtonsView = ButtonsView;
var PanelView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PanelView_assign = function() {
  PanelView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PanelView_assign.apply(this, arguments);
};
var PanelView = (
  /** @class */
  function(_super) {
    PanelView_extends(PanelView2, _super);
    function PanelView2(model) {
      var _this = _super.call(this, { model, el: model.get("el") }) || this;
      _this.className = _this.pfx + "panel";
      _this.id = _this.pfx + model.get("id");
      _this.listenTo(model, "change:appendContent", _this.appendContent);
      _this.listenTo(model, "change:content", _this.updateContent);
      _this.listenTo(model, "change:visible", _this.toggleVisible);
      model.view = _this;
      return _this;
    }
    PanelView2.prototype.appendContent = function() {
      this.$el.append(this.model.get("appendContent"));
    };
    PanelView2.prototype.updateContent = function() {
      this.$el.html(this.model.get("content"));
    };
    PanelView2.prototype.toggleVisible = function() {
      if (!this.model.get("visible")) {
        this.$el.addClass("".concat(this.ppfx, "hidden"));
        return;
      }
      this.$el.removeClass("".concat(this.ppfx, "hidden"));
    };
    PanelView2.prototype.attributes = function() {
      return this.model.get("attributes");
    };
    PanelView2.prototype.initResize = function() {
      var em = this.em;
      var editor = em === null || em === void 0 ? void 0 : em.Editor;
      var resizable = this.model.get("resizable");
      if (editor && resizable) {
        var resz = resizable === true ? [true, true, true, true] : resizable;
        var resLen = resz.length;
        var tc = void 0, cr = void 0, bc = void 0, cl = false;
        if (resLen == 2) {
          var resBools = resz;
          tc = resBools[0];
          bc = resBools[0];
          cr = resBools[1];
          cl = resBools[1];
        } else if (resLen == 4) {
          var resBools = resz;
          tc = resBools[0];
          cr = resBools[1];
          bc = resBools[2];
          cl = resBools[3];
        }
        var resizer_1 = new editor.Utils.Resizer(PanelView_assign({ tc, cr, bc, cl, tl: false, tr: false, bl: false, br: false, appendTo: this.el, silentFrames: true, avoidContainerUpdate: true, prefix: editor.getConfig().stylePrefix, onEnd: function() {
          em.Canvas.refresh({ all: true });
        }, posFetcher: function(el, _a2) {
          var target = _a2.target;
          var style = el.style;
          var config2 = resizer_1.getConfig();
          var keyWidth = config2.keyWidth;
          var keyHeight = config2.keyHeight;
          var rect = el.getBoundingClientRect();
          var forContainer = target == "container";
          var styleWidth = style[keyWidth];
          var styleHeight = style[keyHeight];
          var width = styleWidth && !forContainer ? parseFloat(styleWidth) : rect.width;
          var height = styleHeight && !forContainer ? parseFloat(styleHeight) : rect.height;
          return {
            left: 0,
            top: 0,
            width,
            height
          };
        } }, resizable && typeof resizable !== "boolean" ? resizable : {}));
        resizer_1.blur = function() {
        };
        resizer_1.focus(this.el);
      }
    };
    PanelView2.prototype.render = function() {
      var buttons = this.model.buttons;
      var $el = this.$el;
      var ppfx = this.ppfx;
      var cls = "".concat(this.className, " ").concat(this.id, " ").concat(ppfx, "one-bg ").concat(ppfx, "two-color");
      $el.addClass(cls);
      this.toggleVisible();
      if (buttons.length) {
        var buttonsView = new view_ButtonsView(buttons);
        $el.append(buttonsView.render().el);
      }
      $el.append(this.model.get("content"));
      return this;
    };
    return PanelView2;
  }(abstract_ModuleView)
);
var view_PanelView = PanelView;
var PanelsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PanelsView = (
  /** @class */
  function(_super) {
    PanelsView_extends(PanelsView2, _super);
    function PanelsView2(target) {
      var _this = _super.call(this, { collection: target }) || this;
      _this.listenTo(target, "add", _this.addTo);
      _this.listenTo(target, "reset", _this.render);
      _this.listenTo(target, "remove", _this.onRemove);
      _this.className = _this.pfx + "panels";
      return _this;
    }
    PanelsView2.prototype.onRemove = function(model) {
      var view = model.view;
      view && view.remove();
    };
    PanelsView2.prototype.addTo = function(model) {
      this.addToCollection(model);
    };
    PanelsView2.prototype.addToCollection = function(model, fragmentEl) {
      var fragment = fragmentEl || null;
      var el = model.get("el");
      var view = new view_PanelView(model);
      var rendered = view.render().el;
      var appendTo = model.get("appendTo");
      if (el) {
      } else if (appendTo) {
        var appendEl = document.querySelector(appendTo);
        appendEl === null || appendEl === void 0 ? void 0 : appendEl.appendChild(rendered);
      } else {
        if (fragment) {
          fragment.appendChild(rendered);
        } else {
          this.$el.append(rendered);
        }
      }
      view.initResize();
      return rendered;
    };
    PanelsView2.prototype.render = function() {
      var _this = this;
      var $el = this.$el;
      var frag = document.createDocumentFragment();
      $el.empty();
      this.collection.each(function(model) {
        return _this.addToCollection(model, frag);
      });
      $el.append(frag);
      $el.attr("class", this.className);
      return this;
    };
    return PanelsView2;
  }(abstract_ModuleView)
);
var view_PanelsView = PanelsView;
var panels_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PanelManager = (
  /** @class */
  function(_super) {
    panels_extends(PanelManager2, _super);
    function PanelManager2(em) {
      var _this = _super.call(this, em, "Panels", panels_config_config) || this;
      _this.panels = new model_Panels(_this, _this.config.defaults);
      for (var name in panels_config_config) {
        if (!(name in _this.config))
          _this.config[name] = panels_config_config[name];
      }
      return _this;
    }
    PanelManager2.prototype.getPanels = function() {
      return this.panels;
    };
    PanelManager2.prototype.getPanelsEl = function() {
      var _a2;
      return (_a2 = this.PanelsViewObj) === null || _a2 === void 0 ? void 0 : _a2.el;
    };
    PanelManager2.prototype.addPanel = function(panel) {
      return this.panels.add(panel);
    };
    PanelManager2.prototype.removePanel = function(panel) {
      return this.panels.remove(panel);
    };
    PanelManager2.prototype.getPanel = function(id) {
      var res = this.panels.where({ id });
      return res.length ? res[0] : null;
    };
    PanelManager2.prototype.addButton = function(panelId, button) {
      var pn = this.getPanel(panelId);
      return pn ? pn.buttons.add(button) : null;
    };
    PanelManager2.prototype.removeButton = function(panelId, button) {
      var pn = this.getPanel(panelId);
      return pn && pn.buttons.remove(button);
    };
    PanelManager2.prototype.getButton = function(panelId, id) {
      var pn = this.getPanel(panelId);
      if (pn) {
        var res = pn.buttons.where({ id });
        return res.length ? res[0] : null;
      }
      return null;
    };
    PanelManager2.prototype.render = function() {
      var _a2;
      (_a2 = this.PanelsViewObj) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.PanelsViewObj = new view_PanelsView(this.panels);
      return this.PanelsViewObj.render().el;
    };
    PanelManager2.prototype.active = function() {
      this.getPanels().each(function(p) {
        p.buttons.each(function(btn) {
          btn.get("active") && btn.trigger("updateActive");
        });
      });
    };
    PanelManager2.prototype.disableButtons = function() {
      this.getPanels().each(function(p) {
        p.buttons.each(function(btn) {
          if (btn.get("disable"))
            btn.trigger("change:disable");
        });
      });
    };
    PanelManager2.prototype.destroy = function() {
      this.panels.reset();
      this.panels.stopListening();
      this.PanelsViewObj && this.PanelsViewObj.remove();
    };
    return PanelManager2;
  }(abstract_Module)
);
var panels = PanelManager;
var code_manager_config_config_config = {
  stylePrefix: "cm-",
  optsCodeViewer: {}
};
var code_manager_config_config = code_manager_config_config_config;
var HtmlGenerator_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var HtmlGenerator_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var HTMLGenerator = (
  /** @class */
  function(_super) {
    HtmlGenerator_extends(HTMLGenerator2, _super);
    function HTMLGenerator2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    HTMLGenerator2.prototype.build = function(model, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = opts.em, restOpts = HtmlGenerator_rest(opts, ["em"]);
      var htmlOpts = restOpts;
      if (opts.cleanId && em) {
        var rules = em.Css.getAll();
        var idRules_1 = rules.toJSON().map(function(rule) {
          var sels = rule.selectors;
          var sel = sels && sels.length === 1 && sels.models[0];
          return sel && sel.isId() && sel.get("name");
        }).filter(Boolean);
        if (!htmlOpts.attributes) {
          htmlOpts.attributes = function(mod, attrs) {
            var id = attrs.id;
            if (id && id[0] === "i" && // all autogenerated IDs start with 'i'
            !mod.get("script") && // if the component has script, we have to leave the ID
            !mod.get("attributes").id && // id is not intentionally in attributes
            idRules_1.indexOf(id) < 0) {
              delete attrs.id;
            }
            return attrs;
          };
        }
      }
      return model.toHTML(htmlOpts);
    };
    return HTMLGenerator2;
  }(common.Kx)
);
var HtmlGenerator = HTMLGenerator;
var JsonGenerator_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var JsonGenerator = (
  /** @class */
  function(_super) {
    JsonGenerator_extends(JsonGenerator2, _super);
    function JsonGenerator2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    JsonGenerator2.prototype.build = function(model) {
      var _this = this;
      var json = model.toJSON();
      this.beforeEach(json);
      (0, index_all.each)(json, function(v, attr) {
        var obj = json[attr];
        if (obj instanceof common.Kx) {
          json[attr] = _this.build(obj);
        } else if (obj instanceof common.pM) {
          var coll = obj;
          json[attr] = [];
          if (coll.length) {
            coll.forEach(function(el, index2) {
              json[attr][index2] = _this.build(el);
            });
          }
        }
      });
      return json;
    };
    JsonGenerator2.prototype.beforeEach = function(obj) {
      delete obj.status;
    };
    return JsonGenerator2;
  }(common.Kx)
);
var model_JsonGenerator = JsonGenerator;
var JsGenerator_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
function isFunctionEmpty(fn) {
  var _a2;
  var content = ((_a2 = fn.toString().match(/\{([\s\S]*)\}/m)) === null || _a2 === void 0 ? void 0 : _a2[1]) || "";
  return content.replace(/^\s*\/\/.*$/gm, "").trim().length === 0;
}
var JsGenerator = (
  /** @class */
  function(_super) {
    JsGenerator_extends(JsGenerator2, _super);
    function JsGenerator2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    JsGenerator2.prototype.mapModel = function(model) {
      var _a2;
      var _this = this;
      var code2 = "";
      var script = model.get("script-export") || model.get("script");
      var type2 = model.get("type");
      var comps = model.get("components");
      var id = model.getId();
      if (script) {
        var attr = model.get("attributes");
        attr = (0, index_all.extend)({}, attr, { id });
        model.set("attributes", attr, { silent: true });
        var scrStr = model.getScriptString(script);
        var scrProps = model.get("script-props");
        if (model.get("scriptUpdated") && !scrProps) {
          this.mapJs[type2 + "-" + id] = { ids: [id], code: scrStr };
        } else {
          var props = void 0;
          var mapType = this.mapJs[type2];
          if (scrProps) {
            props = model.__getScriptProps();
          }
          if (mapType) {
            mapType.ids.push(id);
            if (props)
              mapType.props[id] = props;
          } else {
            var res = { ids: [id], code: scrStr };
            if (props)
              res.props = (_a2 = {}, _a2[id] = props, _a2);
            this.mapJs[type2] = res;
          }
        }
      }
      comps.forEach(function(model2) {
        code2 += _this.mapModel(model2);
      });
      return code2;
    };
    JsGenerator2.prototype.build = function(model) {
      this.mapJs = {};
      this.mapModel(model);
      var code2 = "";
      for (var type2 in this.mapJs) {
        var mapType = this.mapJs[type2];
        if (!mapType.code) {
          continue;
        }
        if (mapType.props) {
          if (isFunctionEmpty(mapType.code)) {
            continue;
          }
          code2 += "\n          var props = ".concat(JSON.stringify(mapType.props), ";\n          var ids = Object.keys(props).map(function(id) { return '#'+id }).join(',');\n          var els = document.querySelectorAll(ids);\n          for (var i = 0, len = els.length; i < len; i++) {\n            var el = els[i];\n            (").concat(mapType.code, ".bind(el))(props[el.id]);\n          }");
        } else {
          var ids = "#" + mapType.ids.join(", #");
          code2 += "\n          var items = document.querySelectorAll('".concat(ids, "');\n          for (var i = 0, len = items.length; i < len; i++) {\n            (function(){\n").concat(mapType.code, "\n}.bind(items[i]))();\n          }");
        }
      }
      return code2;
    };
    return JsGenerator2;
  }(common.Kx)
);
var model_JsGenerator = JsGenerator;
var CodeMirrorEditor_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var CodeMirrorEditor_assign = function() {
  CodeMirrorEditor_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return CodeMirrorEditor_assign.apply(this, arguments);
};
var CodeMirror;
if ((0, mixins.hasWin)()) {
  CodeMirror = __webpack_require__(237);
  __webpack_require__(520);
  __webpack_require__(656);
  __webpack_require__(862);
}
var CodeMirrorEditor = (
  /** @class */
  function(_super) {
    CodeMirrorEditor_extends(CodeMirrorEditor2, _super);
    function CodeMirrorEditor2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    CodeMirrorEditor2.prototype.defaults = function() {
      return {
        input: "",
        label: "",
        codeName: "",
        theme: "hopscotch",
        readOnly: true,
        lineNumbers: true,
        autoFormat: true
      };
    };
    CodeMirrorEditor2.prototype.init = function(el) {
      (0, index_all.bindAll)(this, "onChange");
      this.editor = CodeMirror.fromTextArea(el, CodeMirrorEditor_assign({ dragDrop: false, lineWrapping: true, mode: this.get("codeName") }, this.attributes));
      this.element = el;
      this.editor.on("change", this.onChange);
      return this;
    };
    CodeMirrorEditor2.prototype.onChange = function() {
      this.trigger("update", this);
    };
    CodeMirrorEditor2.prototype.getEditor = function() {
      return this.editor;
    };
    CodeMirrorEditor2.prototype.getElement = function() {
      return this.element;
    };
    CodeMirrorEditor2.prototype.setElement = function(el) {
      this.element = el;
      return this;
    };
    CodeMirrorEditor2.prototype.refresh = function() {
      this.getEditor().refresh();
      return this;
    };
    CodeMirrorEditor2.prototype.focus = function() {
      this.getEditor().focus();
      return this;
    };
    CodeMirrorEditor2.prototype.getContent = function() {
      var ed = this.getEditor();
      return ed && ed.getValue();
    };
    CodeMirrorEditor2.prototype.setContent = function(value, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var editor = this.editor;
      if (!editor)
        return;
      editor.setValue(value);
      var autoFormat = this.get("autoFormat");
      var canAutoFormat = editor.autoFormatRange && (autoFormat === true || Array.isArray(autoFormat) && autoFormat.includes(this.get("codeName")));
      if (canAutoFormat) {
        CodeMirror.commands.selectAll(editor);
        editor.autoFormatRange(editor.getCursor(true), editor.getCursor(false));
        CodeMirror.commands.goDocStart(editor);
      }
      !opts.noRefresh && setTimeout(function() {
        return _this.refresh();
      });
    };
    return CodeMirrorEditor2;
  }(common.Kx)
);
var model_CodeMirrorEditor = CodeMirrorEditor;
CodeMirrorEditor.prototype.CodeMirror = CodeMirror;
var EditorView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var EditorView_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var CodeEditorView = (
  /** @class */
  function(_super) {
    EditorView_extends(CodeEditorView2, _super);
    function CodeEditorView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    CodeEditorView2.prototype.template = function(_a2) {
      var pfx = _a2.pfx, codeName = _a2.codeName, label = _a2.label;
      return html(EditorView_templateObject_1 || (EditorView_templateObject_1 = EditorView_makeTemplateObject(['\n      <div class="', 'editor" id="', "", '">\n        <div id="', 'title">', '</div>\n        <div id="', 'code"></div>\n      </div>\n    '], ['\n      <div class="', 'editor" id="', "", '">\n        <div id="', 'title">', '</div>\n        <div id="', 'code"></div>\n      </div>\n    '])), pfx, pfx, codeName, pfx, label, pfx);
    };
    CodeEditorView2.prototype.initialize = function(o) {
      this.config = o.config || {};
      this.pfx = this.config.stylePrefix;
    };
    CodeEditorView2.prototype.render = function() {
      var _a2, _b;
      var _c = this, model = _c.model, pfx = _c.pfx, $el = _c.$el;
      var obj = model.toJSON();
      var toAppend = model.get("input") || ((_b = (_a2 = model).getElement) === null || _b === void 0 ? void 0 : _b.call(_a2));
      obj.pfx = pfx;
      $el.html(this.template(obj));
      $el.attr("class", "".concat(pfx, "editor-c"));
      $el.find("#".concat(pfx, "code")).append(toAppend);
      return this;
    };
    return CodeEditorView2;
  }(common.Ss)
);
var EditorView = CodeEditorView;
var EditorView_templateObject_1;
var code_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var code_manager_assign = function() {
  code_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return code_manager_assign.apply(this, arguments);
};
var defaultViewer = "CodeMirror";
var CodeManagerModule = (
  /** @class */
  function(_super) {
    code_manager_extends(CodeManagerModule2, _super);
    function CodeManagerModule2(em) {
      var _this = _super.call(this, em, "CodeManager", code_manager_config_config) || this;
      _this.EditorView = EditorView;
      var config2 = _this.config;
      var ppfx = config2.pStylePrefix;
      if (ppfx)
        config2.stylePrefix = ppfx + config2.stylePrefix;
      _this.generators = {};
      _this.viewers = {};
      _this.defGenerators = {
        html: new HtmlGenerator(),
        css: new model_CssGenerator(),
        json: new model_JsonGenerator(),
        js: new model_JsGenerator()
      };
      _this.defViewers = { CodeMirror: new model_CodeMirrorEditor() };
      _this.loadDefaultGenerators().loadDefaultViewers();
      return _this;
    }
    CodeManagerModule2.prototype.addGenerator = function(id, generator) {
      this.generators[id] = generator;
      return this;
    };
    CodeManagerModule2.prototype.getGenerator = function(id) {
      return this.generators[id];
    };
    CodeManagerModule2.prototype.getGenerators = function() {
      return this.generators;
    };
    CodeManagerModule2.prototype.addViewer = function(id, viewer) {
      this.viewers[id] = viewer;
      return this;
    };
    CodeManagerModule2.prototype.getViewer = function(id) {
      return this.viewers[id];
    };
    CodeManagerModule2.prototype.getViewers = function() {
      return this.viewers;
    };
    CodeManagerModule2.prototype.createViewer = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var type2 = !(0, index_all.isUndefined)(opts.type) ? opts.type : defaultViewer;
      var viewer = this.getViewer(type2) && this.getViewer(type2).clone();
      var cont = document.createElement("div");
      var txtarea = document.createElement("textarea");
      cont.appendChild(txtarea);
      viewer.set(code_manager_assign(code_manager_assign({}, this.config.optsCodeViewer), opts));
      viewer.init(txtarea);
      viewer.setElement(cont);
      return viewer;
    };
    CodeManagerModule2.prototype.updateViewer = function(viewer, code2) {
      viewer.setContent(code2);
    };
    CodeManagerModule2.prototype.getCode = function(model, genId, opt) {
      if (opt === void 0) {
        opt = {};
      }
      opt.em = this.em;
      var generator = this.getGenerator(genId);
      return generator ? generator.build(model, opt) : "";
    };
    CodeManagerModule2.prototype.loadDefaultGenerators = function() {
      for (var id in this.defGenerators) {
        this.addGenerator(id, this.defGenerators[id]);
      }
      return this;
    };
    CodeManagerModule2.prototype.loadDefaultViewers = function() {
      for (var id in this.defViewers) {
        this.addViewer(id, this.defViewers[id]);
      }
      return this;
    };
    CodeManagerModule2.prototype.destroy = function() {
    };
    return CodeManagerModule2;
  }(abstract_Module)
);
var code_manager = CodeManagerModule;
var Backbone_Undo = __webpack_require__(982);
var Backbone_Undo_default = __webpack_require__.n(Backbone_Undo);
var undo_manager_config_config = {
  maximumStackLength: 500,
  trackSelection: true
};
var undo_manager_config = undo_manager_config_config;
var undo_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var undo_manager_assign = function() {
  undo_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return undo_manager_assign.apply(this, arguments);
};
var undo_manager_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var hasSkip = function(opts) {
  return opts.avoidStore || opts.noUndo;
};
var getChanged = function(obj) {
  return Object.keys(obj.changedAttributes());
};
var UndoManagerModule = (
  /** @class */
  function(_super) {
    undo_manager_extends(UndoManagerModule2, _super);
    function UndoManagerModule2(em) {
      var _this = _super.call(this, em, "UndoManager", undo_manager_config) || this;
      if (_this.config._disable) {
        _this.config.maximumStackLength = 0;
      }
      var fromUndo = true;
      _this.um = new (Backbone_Undo_default())(undo_manager_assign({ track: true, register: [] }, _this.config));
      _this.um.changeUndoType("change", {
        condition: function(object) {
          var hasUndo = object.get("_undo");
          if (hasUndo) {
            var undoExc_1 = object.get("_undoexc");
            if ((0, index_all.isArray)(undoExc_1)) {
              if (getChanged(object).some(function(chn) {
                return undoExc_1.indexOf(chn) >= 0;
              }))
                return false;
            }
            if ((0, index_all.isBoolean)(hasUndo))
              return true;
            if ((0, index_all.isArray)(hasUndo)) {
              if (getChanged(object).some(function(chn) {
                return hasUndo.indexOf(chn) >= 0;
              }))
                return true;
            }
          }
          return false;
        },
        on: function(object, v, opts) {
          var _this2 = this;
          !this.beforeCache && (this.beforeCache = object.previousAttributes());
          var opt = opts || v || {};
          opt.noUndo && setTimeout(function() {
            _this2.beforeCache = null;
          });
          if (hasSkip(opt)) {
            return;
          } else {
            var after = object.toJSON({ fromUndo });
            var result = {
              object,
              before: this.beforeCache,
              after
            };
            this.beforeCache = null;
            if ((0, index_all.isEmpty)(after))
              return;
            return result;
          }
        }
      });
      _this.um.changeUndoType("add", {
        on: function(model, collection, options) {
          if (options === void 0) {
            options = {};
          }
          if (hasSkip(options) || !_this.isRegistered(collection))
            return;
          return {
            object: collection,
            before: void 0,
            after: model,
            options: undo_manager_assign(undo_manager_assign({}, options), { fromUndo })
          };
        }
      });
      _this.um.changeUndoType("remove", {
        on: function(model, collection, options) {
          if (options === void 0) {
            options = {};
          }
          if (hasSkip(options) || !_this.isRegistered(collection))
            return;
          return {
            object: collection,
            before: model,
            after: void 0,
            options: undo_manager_assign(undo_manager_assign({}, options), { fromUndo })
          };
        }
      });
      _this.um.changeUndoType("reset", {
        undo: function(collection, before) {
          collection.reset(before, { fromUndo });
        },
        redo: function(collection, b, after) {
          collection.reset(after, { fromUndo });
        },
        on: function(collection, options) {
          if (options === void 0) {
            options = {};
          }
          if (hasSkip(options) || !_this.isRegistered(collection))
            return;
          return {
            object: collection,
            before: options.previousModels,
            after: undo_manager_spreadArray([], collection.models, true),
            options: undo_manager_assign(undo_manager_assign({}, options), { fromUndo })
          };
        }
      });
      _this.um.on("undo redo", function() {
        em.getSelectedAll().map(function(c) {
          return c.trigger("rerender:layer");
        });
      });
      ["undo", "redo"].forEach(function(ev) {
        return _this.um.on(ev, function() {
          return em.trigger(ev);
        });
      });
      return _this;
    }
    UndoManagerModule2.prototype.postLoad = function() {
      var _a2 = this, config2 = _a2.config, em = _a2.em;
      config2.trackSelection && em && this.add(em.get("selected"));
    };
    UndoManagerModule2.prototype.add = function(entity) {
      this.um.register(entity);
      return this;
    };
    UndoManagerModule2.prototype.remove = function(entity) {
      this.um.unregister(entity);
      return this;
    };
    UndoManagerModule2.prototype.removeAll = function() {
      this.um.unregisterAll();
      return this;
    };
    UndoManagerModule2.prototype.start = function() {
      this.um.startTracking();
      return this;
    };
    UndoManagerModule2.prototype.stop = function() {
      this.um.stopTracking();
      return this;
    };
    UndoManagerModule2.prototype.undo = function(all) {
      if (all === void 0) {
        all = true;
      }
      var _a2 = this, em = _a2.em, um = _a2.um;
      !em.isEditing() && um.undo(all);
      return this;
    };
    UndoManagerModule2.prototype.undoAll = function() {
      this.um.undoAll();
      return this;
    };
    UndoManagerModule2.prototype.redo = function(all) {
      if (all === void 0) {
        all = true;
      }
      var _a2 = this, em = _a2.em, um = _a2.um;
      !em.isEditing() && um.redo(all);
      return this;
    };
    UndoManagerModule2.prototype.redoAll = function() {
      this.um.redoAll();
      return this;
    };
    UndoManagerModule2.prototype.hasUndo = function() {
      return !!this.um.isAvailable("undo");
    };
    UndoManagerModule2.prototype.hasRedo = function() {
      return !!this.um.isAvailable("redo");
    };
    UndoManagerModule2.prototype.isRegistered = function(obj) {
      return !!this.getInstance().objectRegistry.isRegistered(obj);
    };
    UndoManagerModule2.prototype.getStack = function() {
      return this.um.stack;
    };
    UndoManagerModule2.prototype.getStackGroup = function() {
      var result = [];
      var inserted = [];
      this.getStack().forEach(function(item) {
        var index2 = item.get("magicFusionIndex");
        if (inserted.indexOf(index2) < 0) {
          inserted.push(index2);
          result.push(item);
        }
      });
      return result;
    };
    UndoManagerModule2.prototype.skip = function(clb) {
      var isTracking = !!this.um.isTracking();
      isTracking && this.stop();
      clb();
      isTracking && this.start();
    };
    UndoManagerModule2.prototype.getGroupedStack = function() {
      var result = {};
      var stack = this.getStack();
      var createItem = function(item, index2) {
        var _a2 = item.attributes, type2 = _a2.type, after = _a2.after, before = _a2.before, object = _a2.object, _b = _a2.options, options = _b === void 0 ? {} : _b;
        return { index: index2, type: type2, after, before, object, options };
      };
      stack.forEach(function(item, i) {
        var index2 = item.get("magicFusionIndex");
        var value = createItem(item, i);
        if (!result[index2]) {
          result[index2] = [value];
        } else {
          result[index2].push(value);
        }
      });
      return Object.keys(result).map(function(index2) {
        var actions = result[index2];
        return {
          index: actions[actions.length - 1].index,
          actions,
          labels: (0, index_all.unique)(actions.reduce(function(res, item) {
            var _a2;
            var label = (_a2 = item.options) === null || _a2 === void 0 ? void 0 : _a2.action;
            label && res.push(label);
            return res;
          }, []))
        };
      });
    };
    UndoManagerModule2.prototype.goToGroup = function(group) {
      var _this = this;
      if (!group)
        return;
      var current = this.getPointer();
      var goTo = group.index - current;
      (0, index_all.times)(Math.abs(goTo), function() {
        _this[goTo < 0 ? "undo" : "redo"](false);
      });
    };
    UndoManagerModule2.prototype.getPointer = function() {
      return this.getStack().pointer;
    };
    UndoManagerModule2.prototype.clear = function() {
      this.um.clear();
      return this;
    };
    UndoManagerModule2.prototype.getInstance = function() {
      return this.um;
    };
    UndoManagerModule2.prototype.destroy = function() {
      this.clear().removeAll();
    };
    return UndoManagerModule2;
  }(abstract_Module)
);
var undo_manager = UndoManagerModule;
var rich_text_editor_config_config_config = {
  stylePrefix: "rte-",
  adjustToolbar: true,
  actions: ["bold", "italic", "underline", "strikethrough", "link", "wrap"],
  custom: false
};
var rich_text_editor_config_config = rich_text_editor_config_config_config;
var RichTextEditor_assign = function() {
  RichTextEditor_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return RichTextEditor_assign.apply(this, arguments);
};
var RichTextEditorActionState;
(function(RichTextEditorActionState2) {
  RichTextEditorActionState2[RichTextEditorActionState2["ACTIVE"] = 1] = "ACTIVE";
  RichTextEditorActionState2[RichTextEditorActionState2["INACTIVE"] = 0] = "INACTIVE";
  RichTextEditorActionState2[RichTextEditorActionState2["DISABLED"] = -1] = "DISABLED";
})(RichTextEditorActionState || (RichTextEditorActionState = {}));
var RTE_KEY = "_rte";
var btnState = {
  ACTIVE: 1,
  INACTIVE: 0,
  DISABLED: -1
};
var isValidTag = function(rte, tagName2) {
  if (tagName2 === void 0) {
    tagName2 = "A";
  }
  var _a2 = rte.selection() || {}, anchorNode = _a2.anchorNode, focusNode = _a2.focusNode;
  var parentAnchor = anchorNode === null || anchorNode === void 0 ? void 0 : anchorNode.parentNode;
  var parentFocus = focusNode === null || focusNode === void 0 ? void 0 : focusNode.parentNode;
  return (parentAnchor === null || parentAnchor === void 0 ? void 0 : parentAnchor.nodeName) == tagName2 || (parentFocus === null || parentFocus === void 0 ? void 0 : parentFocus.nodeName) == tagName2;
};
var customElAttr = "data-selectme";
var defActions = {
  bold: {
    name: "bold",
    icon: "<b>B</b>",
    attributes: { title: "Bold" },
    result: function(rte) {
      return rte.exec("bold");
    }
  },
  italic: {
    name: "italic",
    icon: "<i>I</i>",
    attributes: { title: "Italic" },
    result: function(rte) {
      return rte.exec("italic");
    }
  },
  underline: {
    name: "underline",
    icon: "<u>U</u>",
    attributes: { title: "Underline" },
    result: function(rte) {
      return rte.exec("underline");
    }
  },
  strikethrough: {
    name: "strikethrough",
    icon: "<s>S</s>",
    attributes: { title: "Strike-through" },
    result: function(rte) {
      return rte.exec("strikeThrough");
    }
  },
  link: {
    // eslint-disable-next-line max-len
    icon: '<svg viewBox="0 0 24 24">\n          <path fill="currentColor" d="M3.9,12C3.9,10.29 5.29,8.9 7,8.9H11V7H7A5,5 0 0,0 2,12A5,5 0 0,0 7,17H11V15.1H7C5.29,15.1 3.9,13.71 3.9,12M8,13H16V11H8V13M17,7H13V8.9H17C18.71,8.9 20.1,10.29 20.1,12C20.1,13.71 18.71,15.1 17,15.1H13V17H17A5,5 0 0,0 22,12A5,5 0 0,0 17,7Z" />\n        </svg>',
    name: "link",
    attributes: {
      style: "font-size:1.4rem;padding:0 4px 2px;",
      title: "Link"
    },
    state: function(rte) {
      return rte && rte.selection() && isValidTag(rte) ? btnState.ACTIVE : btnState.INACTIVE;
    },
    result: function(rte) {
      if (isValidTag(rte)) {
        rte.exec("unlink");
      } else {
        rte.insertHTML('<a href="" '.concat(customElAttr, ">").concat(rte.selection(), "</a>"), {
          select: true
        });
      }
    }
  },
  wrap: {
    name: "wrap",
    icon: '<svg viewBox="0 0 24 24">\n            <path fill="currentColor" d="M20.71,4.63L19.37,3.29C19,2.9 18.35,2.9 17.96,3.29L9,12.25L11.75,15L20.71,6.04C21.1,5.65 21.1,5 20.71,4.63M7,14A3,3 0 0,0 4,17C4,18.31 2.84,19 2,19C2.92,20.22 4.5,21 6,21A4,4 0 0,0 10,17A3,3 0 0,0 7,14Z" />\n        </svg>',
    attributes: { title: "Wrap for style" },
    state: function(rte) {
      return (rte === null || rte === void 0 ? void 0 : rte.selection()) && isValidTag(rte, "SPAN") ? btnState.DISABLED : btnState.INACTIVE;
    },
    result: function(rte) {
      !isValidTag(rte, "SPAN") && rte.insertHTML("<span ".concat(customElAttr, ">").concat(rte.selection(), "</span>"), {
        select: true
      });
    }
  }
};
var RichTextEditor = (
  /** @class */
  function() {
    function RichTextEditor2(em, el, settings) {
      if (settings === void 0) {
        settings = {};
      }
      var _this = this;
      this.em = em;
      this.settings = settings;
      if (el[RTE_KEY]) {
        return el[RTE_KEY];
      }
      el[RTE_KEY] = this;
      this.setEl(el);
      this.updateActiveActions = this.updateActiveActions.bind(this);
      this.__onKeydown = this.__onKeydown.bind(this);
      this.__onPaste = this.__onPaste.bind(this);
      var acts = (settings.actions || []).map(function(action) {
        var result = action;
        if ((0, index_all.isString)(action)) {
          result = RichTextEditor_assign({}, defActions[action]);
        } else if (defActions[action.name]) {
          result = RichTextEditor_assign(RichTextEditor_assign({}, defActions[action.name]), action);
        }
        return result;
      });
      var actions = acts.length ? acts : Object.keys(defActions).map(function(a) {
        return defActions[a];
      });
      settings.classes = RichTextEditor_assign({ actionbar: "actionbar", button: "action", active: "active", disabled: "disabled", inactive: "inactive" }, settings.classes);
      var classes = settings.classes;
      var actionbar = settings.actionbar;
      this.actionbar = actionbar;
      this.classes = classes;
      this.actions = actions;
      if (!actionbar) {
        if (!this.isCustom(settings.module)) {
          var actionbarCont = settings.actionbarContainer;
          actionbar = document.createElement("div");
          actionbar.className = classes.actionbar;
          actionbarCont === null || actionbarCont === void 0 ? void 0 : actionbarCont.appendChild(actionbar);
          this.actionbar = actionbar;
        }
        actions.forEach(function(action) {
          return _this.addAction(action);
        });
      }
      settings.styleWithCSS && this.exec("styleWithCSS");
      return this;
    }
    RichTextEditor2.prototype.isCustom = function(module) {
      var rte = module || this.em.RichTextEditor;
      return !!((rte === null || rte === void 0 ? void 0 : rte.config.custom) || (rte === null || rte === void 0 ? void 0 : rte.customRte));
    };
    RichTextEditor2.prototype.destroy = function() {
    };
    RichTextEditor2.prototype.setEl = function(el) {
      this.el = el;
      this.doc = el.ownerDocument;
    };
    RichTextEditor2.prototype.updateActiveActions = function() {
      var _this = this;
      var actions = this.getActions();
      actions.forEach(function(action) {
        var update = action.update, btn = action.btn;
        var _a2 = _this.classes, active = _a2.active, inactive = _a2.inactive, disabled = _a2.disabled;
        var state = action.state;
        var name = action.name;
        var doc = _this.doc;
        var currentState = RichTextEditorActionState.INACTIVE;
        if (btn) {
          btn.className = btn.className.replace(active, "").trim();
          btn.className = btn.className.replace(inactive, "").trim();
          btn.className = btn.className.replace(disabled, "").trim();
        }
        if (state) {
          var newState = state(_this, doc);
          currentState = newState;
          if (btn) {
            switch (newState) {
              case btnState.ACTIVE:
                btn.className += " ".concat(active);
                break;
              case btnState.INACTIVE:
                btn.className += " ".concat(inactive);
                break;
              case btnState.DISABLED:
                btn.className += " ".concat(disabled);
                break;
            }
          }
        } else {
          if (doc.queryCommandSupported(name) && doc.queryCommandState(name)) {
            btn && (btn.className += " ".concat(active));
            currentState = RichTextEditorActionState.ACTIVE;
          }
        }
        action.currentState = currentState;
        update === null || update === void 0 ? void 0 : update(_this, action);
      });
      actions.length && this.em.RichTextEditor.__dbdTrgCustom();
    };
    RichTextEditor2.prototype.enable = function(opts) {
      if (this.enabled)
        return this;
      return this.__toggleEffects(true, opts);
    };
    RichTextEditor2.prototype.disable = function() {
      return this.__toggleEffects(false);
    };
    RichTextEditor2.prototype.__toggleEffects = function(enable, opts) {
      if (enable === void 0) {
        enable = false;
      }
      if (opts === void 0) {
        opts = {};
      }
      var method = enable ? dom.on : dom.AU;
      var _a2 = this, el = _a2.el, doc = _a2.doc;
      var actionbar = this.actionbarEl();
      actionbar && (actionbar.style.display = enable ? "" : "none");
      el.contentEditable = "".concat(!!enable);
      method(el, "mouseup keyup", this.updateActiveActions);
      method(doc, "keydown", this.__onKeydown);
      method(doc, "paste", this.__onPaste);
      this.enabled = enable;
      if (enable) {
        var event_1 = opts.event;
        this.syncActions();
        this.updateActiveActions();
        if (event_1) {
          var range = null;
          if (doc.caretRangeFromPoint) {
            var poiner = (0, dom.G2)(event_1);
            range = doc.caretRangeFromPoint(poiner.clientX, poiner.clientY);
          } else if (event_1.rangeParent) {
            range = doc.createRange();
            range.setStart(event_1.rangeParent, event_1.rangeOffset);
          }
          var sel = doc.getSelection();
          sel === null || sel === void 0 ? void 0 : sel.removeAllRanges();
          range && (sel === null || sel === void 0 ? void 0 : sel.addRange(range));
        }
        el.focus();
      }
      return this;
    };
    RichTextEditor2.prototype.__onKeydown = function(ev) {
      var em = this.em;
      var onKeydown = em.RichTextEditor.getConfig().onKeydown;
      if (onKeydown) {
        return onKeydown({ ev, rte: this, editor: em.getEditor() });
      }
      var doc = this.doc;
      var cmdList = ["insertOrderedList", "insertUnorderedList"];
      if (ev.key === "Enter" && !cmdList.some(function(cmd) {
        return doc.queryCommandState(cmd);
      })) {
        doc.execCommand("insertLineBreak");
        ev.preventDefault();
      }
    };
    RichTextEditor2.prototype.__onPaste = function(ev) {
      var em = this.em;
      var onPaste = em.RichTextEditor.getConfig().onPaste;
      if (onPaste) {
        return onPaste({ ev, rte: this, editor: em.getEditor() });
      }
      var clipboardData = ev.clipboardData;
      var text = clipboardData.getData("text");
      var textHtml = clipboardData.getData("text/html");
      if (text && !textHtml) {
        ev.preventDefault();
        var html2 = text.replace(/(?:\r\n|\r|\n)/g, "<br/>");
        this.doc.execCommand("insertHTML", false, html2);
      }
    };
    RichTextEditor2.prototype.syncActions = function() {
      var _this = this;
      this.getActions().forEach(function(action) {
        if (_this.actionbar) {
          if (!action.state || action.state && action.state(_this, _this.doc) >= 0) {
            var event_2 = action.event || "click";
            var btn = action.btn;
            if (btn) {
              btn["on".concat(event_2)] = function() {
                action.result(_this, action);
                _this.updateActiveActions();
              };
            }
          }
        }
      });
    };
    RichTextEditor2.prototype.addAction = function(action, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var sync = opts.sync;
      var actionbar = this.actionbarEl();
      if (actionbar) {
        var icon = action.icon, _a2 = action.attributes, attr = _a2 === void 0 ? {} : _a2;
        var btn = document.createElement("span");
        btn.className = this.classes.button;
        action.btn = btn;
        for (var key in attr) {
          btn.setAttribute(key, attr[key]);
        }
        if (typeof icon == "string") {
          btn.innerHTML = icon;
        } else {
          btn.appendChild(icon);
        }
        actionbar.appendChild(btn);
      }
      if (sync) {
        this.actions.push(action);
        this.syncActions();
      }
    };
    RichTextEditor2.prototype.getActions = function() {
      return this.actions;
    };
    RichTextEditor2.prototype.selection = function() {
      return this.doc.getSelection();
    };
    RichTextEditor2.prototype.exec = function(command, value) {
      this.doc.execCommand(command, false, value);
    };
    RichTextEditor2.prototype.actionbarEl = function() {
      return this.actionbar;
    };
    RichTextEditor2.prototype.insertHTML = function(value, _a2) {
      var _b = _a2 === void 0 ? {} : _a2, select = _b.select;
      var _c = this, em = _c.em, doc = _c.doc, el = _c.el;
      var sel = doc.getSelection();
      if (sel && sel.rangeCount) {
        var model_1 = (0, mixins.getComponentModel)(el) || em.getSelected();
        var node = doc.createElement("div");
        var range_1 = sel.getRangeAt(0);
        range_1.deleteContents();
        if ((0, index_all.isString)(value)) {
          node.innerHTML = value;
        } else if (value) {
          node.appendChild(value);
        }
        Array.prototype.slice.call(node.childNodes).forEach(function(nd) {
          range_1.insertNode(nd);
        });
        sel.removeAllRanges();
        sel.addRange(range_1);
        el.focus();
        if (select && model_1) {
          model_1.once("rte:disable", function() {
            var toSel = model_1.find("[".concat(customElAttr, "]"))[0];
            if (!toSel)
              return;
            em.setSelected(toSel);
            toSel.removeAttributes(customElAttr);
          });
          model_1.trigger("disable");
        }
      }
    };
    return RichTextEditor2;
  }()
);
var model_RichTextEditor = RichTextEditor;
var rich_text_editor_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var rich_text_editor_awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var rich_text_editor_generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var rich_text_editor_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var eventsUp = "".concat(canvas_types.refresh, " frame:scroll ").concat(dom_components_types.I.update);
var evEnable = "rte:enable";
var evDisable = "rte:disable";
var rich_text_editor_evCustom = "rte:custom";
var rich_text_editor_events = {
  enable: evEnable,
  disable: evDisable,
  custom: rich_text_editor_evCustom
};
var RichTextEditorModule = (
  /** @class */
  function(_super) {
    rich_text_editor_extends(RichTextEditorModule2, _super);
    function RichTextEditorModule2(em) {
      var _this = _super.call(this, em, "RichTextEditor", rich_text_editor_config_config) || this;
      _this.events = rich_text_editor_events;
      var config2 = _this.config;
      var ppfx = config2.pStylePrefix;
      if (ppfx) {
        config2.stylePrefix = ppfx + config2.stylePrefix;
      }
      _this.pfx = config2.stylePrefix;
      _this.actions = config2.actions || [];
      var model = new common.Kx();
      _this.model = model;
      model.on("change:currentView", _this.__trgCustom, _this);
      _this.__dbdTrgCustom = (0, index_all.debounce)(function() {
        return _this.__trgCustom();
      }, 0);
      return _this;
    }
    RichTextEditorModule2.prototype.onLoad = function() {
      if (!(0, mixins.hasWin)())
        return;
      var config2 = this.config;
      var ppfx = config2.pStylePrefix;
      var isCustom = config2.custom;
      var toolbar = (0, dom.a_)("div", {
        class: (0, dom.cx)("".concat(ppfx, "rte-toolbar"), !isCustom && "".concat(ppfx, "one-bg ").concat(ppfx, "rte-toolbar-ui"))
      });
      this.toolbar = toolbar;
      this.initRte((0, dom.a_)("div"));
      (0, dom.on)(toolbar, "mousedown", function(e) {
        return e.stopPropagation();
      });
    };
    RichTextEditorModule2.prototype.__trgCustom = function() {
      var _a2 = this, model = _a2.model, em = _a2.em, events2 = _a2.events;
      em.trigger(events2.custom, {
        enabled: !!model.get("currentView"),
        container: this.getToolbarEl(),
        actions: this.getAll()
      });
    };
    RichTextEditorModule2.prototype.destroy = function() {
      var _a2, _b, _c;
      (_a2 = this.globalRte) === null || _a2 === void 0 ? void 0 : _a2.destroy();
      (_c = (_b = this.customRte) === null || _b === void 0 ? void 0 : _b.destroy) === null || _c === void 0 ? void 0 : _c.call(_b);
      this.model.stopListening().clear({ silent: true });
      this.__dbdTrgCustom.cancel();
      (0, dom.YZ)(this.toolbar);
    };
    RichTextEditorModule2.prototype.postRender = function(ev) {
      var canvas2 = ev.model.get("Canvas");
      this.toolbar.style.pointerEvents = "all";
      this.hideToolbar();
      canvas2.getToolsEl().appendChild(this.toolbar);
    };
    RichTextEditorModule2.prototype.initRte = function(el) {
      var globalRte = this.globalRte;
      var _a2 = this, em = _a2.em, pfx = _a2.pfx, actionbar = _a2.actionbar, config2 = _a2.config;
      var actions = this.actions || rich_text_editor_spreadArray([], config2.actions, true);
      var classes = {
        actionbar: "".concat(pfx, "actionbar"),
        button: "".concat(pfx, "action"),
        active: "".concat(pfx, "active"),
        inactive: "".concat(pfx, "inactive"),
        disabled: "".concat(pfx, "disabled")
      };
      if (!globalRte) {
        globalRte = new model_RichTextEditor(em, el, {
          classes,
          actions,
          actionbar,
          actionbarContainer: this.toolbar,
          module: this
        });
        this.globalRte = globalRte;
      } else {
        globalRte.em = em;
        globalRte.setEl(el);
      }
      if (globalRte.actionbar) {
        this.actionbar = globalRte.actionbar;
      }
      if (globalRte.actions) {
        this.actions = globalRte.actions;
      }
      return globalRte;
    };
    RichTextEditorModule2.prototype.add = function(name, action) {
      var _a2;
      if (action === void 0) {
        action = {};
      }
      action.name = name;
      (_a2 = this.globalRte) === null || _a2 === void 0 ? void 0 : _a2.addAction(action, { sync: true });
    };
    RichTextEditorModule2.prototype.get = function(name) {
      var _a2;
      var result;
      (_a2 = this.globalRte) === null || _a2 === void 0 ? void 0 : _a2.getActions().forEach(function(action) {
        if (action.name == name) {
          result = action;
        }
      });
      return result;
    };
    RichTextEditorModule2.prototype.getAll = function() {
      var _a2;
      return ((_a2 = this.globalRte) === null || _a2 === void 0 ? void 0 : _a2.getActions()) || [];
    };
    RichTextEditorModule2.prototype.remove = function(name) {
      var _a2;
      var actions = this.getAll();
      var action = this.get(name);
      if (action) {
        var btn = action.btn;
        var index2 = actions.indexOf(action);
        (_a2 = btn === null || btn === void 0 ? void 0 : btn.parentNode) === null || _a2 === void 0 ? void 0 : _a2.removeChild(btn);
        actions.splice(index2, 1);
      }
      return action;
    };
    RichTextEditorModule2.prototype.run = function(action) {
      var rte = this.globalRte;
      var actionRes = (0, index_all.isString)(action) ? this.get(action) : action;
      if (rte && actionRes) {
        actionRes.result(rte, actionRes);
        rte.updateActiveActions();
      }
    };
    RichTextEditorModule2.prototype.getToolbarEl = function() {
      return this.toolbar;
    };
    RichTextEditorModule2.prototype.updatePosition = function() {
      var _a2 = this, em = _a2.em, toolbar = _a2.toolbar;
      var un = "px";
      var canvas2 = em.Canvas;
      var style = toolbar.style;
      var pos = canvas2.getTargetToElementFixed(this.lastEl, toolbar, {
        event: "rteToolbarPosUpdate",
        left: 0
      });
      ["top", "left", "bottom", "right"].forEach(function(key) {
        var value = pos[key];
        if ((0, mixins.isDef)(value)) {
          style[key] = (0, index_all.isString)(value) ? value : (value || 0) + un;
        }
      });
    };
    RichTextEditorModule2.prototype.enable = function(view_1, rte_1) {
      return rich_text_editor_awaiter(this, arguments, void 0, function(view, rte, opts) {
        var _a2, customRte, em, el, rteInst;
        if (opts === void 0) {
          opts = {};
        }
        return rich_text_editor_generator(this, function(_b) {
          switch (_b.label) {
            case 0:
              this.lastEl = view.el;
              _a2 = this, customRte = _a2.customRte, em = _a2.em;
              el = view.getChildrenContainer();
              this.toolbar.style.display = "";
              return [4, customRte ? customRte.enable(el, rte) : this.initRte(el).enable(opts)];
            case 1:
              rteInst = _b.sent();
              if (em) {
                setTimeout(this.updatePosition.bind(this), 0);
                em.off(eventsUp, this.updatePosition, this);
                em.on(eventsUp, this.updatePosition, this);
                em.trigger("rte:enable", view, rteInst);
              }
              this.model.set({ currentView: view });
              return [2, rteInst];
          }
        });
      });
    };
    RichTextEditorModule2.prototype.getContent = function(view, rte) {
      return rich_text_editor_awaiter(this, void 0, void 0, function() {
        var customRte;
        return rich_text_editor_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              customRte = this.customRte;
              if (!(customRte && rte && (0, index_all.isFunction)(customRte.getContent)))
                return [3, 2];
              return [4, customRte.getContent(view.el, rte)];
            case 1:
              return [2, _a2.sent()];
            case 2:
              return [2, view.getChildrenContainer().innerHTML];
          }
        });
      });
    };
    RichTextEditorModule2.prototype.hideToolbar = function() {
      var style = this.toolbar.style;
      var size = "-1000px";
      style.top = size;
      style.left = size;
      style.display = "none";
    };
    RichTextEditorModule2.prototype.disable = function(view, rte, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var customRte = this.customRte;
      var el = view.getChildrenContainer();
      if (customRte) {
        customRte.disable(el, rte);
      } else {
        rte && rte.disable();
      }
      this.hideToolbar();
      if (em) {
        em.off(eventsUp, this.updatePosition, this);
        !opts.fromMove && em.trigger("rte:disable", view, rte);
      }
      this.model.unset("currentView");
    };
    return RichTextEditorModule2;
  }(abstract_Module)
);
var rich_text_editor = RichTextEditorModule;
var style_manager_config_config = {
  sectors: [
    {
      name: "General",
      open: false,
      properties: ["display", "float", "position", "top", "right", "left", "bottom"]
    },
    {
      name: "Flex",
      open: false,
      properties: [
        "flex-direction",
        "flex-wrap",
        "justify-content",
        "align-items",
        "align-content",
        "order",
        "flex-basis",
        "flex-grow",
        "flex-shrink",
        "align-self"
      ]
    },
    {
      name: "Dimension",
      open: false,
      properties: ["width", "height", "max-width", "min-height", "margin", "padding"]
    },
    {
      name: "Typography",
      open: false,
      properties: [
        "font-family",
        "font-size",
        "font-weight",
        "letter-spacing",
        "color",
        "line-height",
        "text-align",
        "text-shadow"
      ]
    },
    {
      name: "Decorations",
      open: false,
      properties: ["background-color", "border-radius", "border", "box-shadow", "background"]
    },
    {
      name: "Extra",
      open: false,
      properties: ["opacity", "transition", "transform"]
    }
  ],
  appendTo: "",
  stylePrefix: "sm-",
  custom: false,
  hideNotStylable: true,
  highlightChanged: true,
  highlightComputed: true,
  showComputed: true,
  clearProperties: true,
  avoidComputed: ["width", "height"]
};
var Property_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Property_assign = function() {
  Property_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Property_assign.apply(this, arguments);
};
var Property_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var Property_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var Property = (
  /** @class */
  function(_super) {
    Property_extends(Property2, _super);
    function Property2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Property2.getDefaults = function() {
      return (0, index_all.result)(this.prototype, "defaults");
    };
    Property2.prototype.defaults = function() {
      return {
        name: "",
        property: "",
        type: "",
        defaults: "",
        info: "",
        value: "",
        icon: "",
        functionName: "",
        status: "",
        visible: true,
        fixedValues: ["initial", "inherit"],
        full: false,
        important: false,
        toRequire: false,
        requires: void 0,
        requiresParent: null,
        parentTarget: null
      };
    };
    Property2.prototype.initialize = function(props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      this.em = opts.em;
      var id = this.getId() || "";
      var name = this.get("name") || this.get("label") || "";
      !this.get("property") && this.set("property", (name || id).replace(/ /g, "-"));
      var prop = this.get("property");
      !this.get("id") && this.set("id", prop);
      !name && this.set("name", (0, mixins.capitalize)(prop).replace(/-/g, " "));
      this.on("change", this.__upTargets);
      Property2.callInit(this, props, opts);
    };
    Property2.prototype.__getParentProp = function() {
      var _a2, _b;
      return (_b = (_a2 = this.collection) === null || _a2 === void 0 ? void 0 : _a2.opts) === null || _b === void 0 ? void 0 : _b.parentProp;
    };
    Property2.prototype.__upTargets = function(p, opts) {
      var _a2;
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var sm = em.Styles;
      var name = this.getName();
      var isClear = opts.__clear;
      var value = isClear ? "" : this.__getFullValue(opts);
      var parentProp = this.__getParentProp();
      var to = this.changedAttributes();
      var from = (0, index_all.keys)(to).reduce(function(a, i) {
        a[i] = _this.previous(i);
        return a;
      }, {});
      var kProps = Property_spreadArray(Property_spreadArray([], (0, index_all.keys)(this.__getClearProps()), true), ["__p"], false);
      var toProps = (0, index_all.keys)(to);
      var applyStyle = !opts.__up && !parentProp && (isClear || kProps.some(function(k2) {
        return toProps.indexOf(k2) >= 0;
      }));
      var onChange = this.get("onChange");
      var evOpts = { property: this, from, to, value, opts };
      sm.__trgEv(sm.events.propertyUpdate, evOpts);
      onChange && onChange(evOpts);
      applyStyle && this.__upTargetsStyle((_a2 = {}, _a2[name] = value, _a2), opts);
    };
    Property2.prototype.__upTargetsStyle = function(style, opts) {
      var _a2;
      var sm = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.get("StyleManager");
      sm === null || sm === void 0 ? void 0 : sm.addStyleTargets(Property_assign(Property_assign({}, style), { __p: !!opts.avoidStore }), opts);
    };
    Property2.prototype._up = function(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.noTarget)
        opts.__up = true;
      var partial = opts.partial, rest = Property_rest(opts, ["partial"]);
      props.__p = !!(rest.avoidStore || partial);
      return this.set(props, Property_assign(Property_assign({}, rest), { avoidStore: props.__p }));
    };
    Property2.prototype.up = function(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.set(props, Property_assign(Property_assign({}, opts), { __up: true }));
    };
    Property2.prototype.init = function() {
    };
    Property2.prototype.getId = function() {
      return this.get("id");
    };
    Property2.prototype.getType = function() {
      return this.get("type");
    };
    Property2.prototype.getName = function() {
      return this.get("property");
    };
    Property2.prototype.getLabel = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = opts.locale, locale = _b === void 0 ? true : _b;
      var id = this.getId();
      var name = this.get("name") || this.get("label");
      return locale && ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.t("styleManager.properties.".concat(id))) || name;
    };
    Property2.prototype.getValue = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var noDefault = opts.noDefault;
      var val = this.get("value");
      return !this.hasValue() && !noDefault ? this.getDefaultValue() : val;
    };
    Property2.prototype.hasValue = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var noParent = opts.noParent;
      var parentValue = noParent && this.getParentTarget();
      var val = this.get("value");
      return !(0, index_all.isUndefined)(val) && val !== "" && !parentValue;
    };
    Property2.prototype.hasValueParent = function() {
      return this.hasValue() && !this.hasValue({ noParent: true });
    };
    Property2.prototype.getStyle = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var name = this.getName();
      var key = opts.camelCase ? (0, mixins.camelCase)(name) : name;
      return _a2 = {}, _a2[key] = this.__getFullValue(opts), _a2;
    };
    Property2.prototype.getDefaultValue = function() {
      var def = this.get("default");
      return "".concat(!(0, index_all.isUndefined)(def) ? def : this.get("defaults"));
    };
    Property2.prototype.upValue = function(value, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var parsed = value === null || value === "" ? this.__getClearProps() : this.__parseValue(value, opts);
      return this._up(parsed, opts);
    };
    Property2.prototype.isVisible = function() {
      return !!this.get("visible");
    };
    Property2.prototype.clear = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this._up(this.__getClearProps(), Property_assign(Property_assign({}, opts), { __clear: true }));
      return this;
    };
    Property2.prototype.canClear = function() {
      var parent = this.getParent();
      return parent ? parent.__canClearProp(this) : this.hasValue({ noParent: true });
    };
    Property2.prototype.getParent = function() {
      return this.__getParentProp();
    };
    Property2.prototype.isFull = function() {
      return !!this.get("full");
    };
    Property2.prototype.__parseValue = function(value, opts) {
      return this.parseValue(value, opts);
    };
    Property2.prototype.__getClearProps = function() {
      return { value: "" };
    };
    Property2.prototype.setValue = function(value, complete, opts) {
      if (complete === void 0) {
        complete = true;
      }
      if (opts === void 0) {
        opts = {};
      }
      var parsed = this.parseValue(value);
      var avoidStore = !complete;
      !avoidStore && this.set({ value: void 0 }, { avoidStore, silent: true });
      this.set(parsed, Property_assign({ avoidStore }, opts));
    };
    Property2.prototype.setValueFromInput = function(value, complete, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.setValue(value, complete, Property_assign(Property_assign({}, opts), { fromInput: 1 }));
    };
    Property2.prototype.parseValue = function(value, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = { value };
      var imp = "!important";
      var fn = this.get("functionName") || "";
      if ((0, index_all.isString)(value) && value.indexOf(imp) !== -1) {
        result.value = value.replace(imp, "").trim();
        result.important = true;
      }
      if (!fn && !opts.complete) {
        return result;
      }
      var args = [];
      var valueStr = "".concat(result.value).trim();
      var start = valueStr.indexOf("(") + 1;
      var functionName = fn || valueStr.substring(0, start - 1);
      if (functionName) {
        result.functionName = functionName;
      }
      if (!fn || valueStr.indexOf("".concat(fn, "(")) === 0) {
        var end = valueStr.lastIndexOf(")");
        args.push(start);
        end >= 0 && args.push(end);
        result.value = String.prototype.substring.apply(valueStr, args);
      }
      if (opts.numeric) {
        var num = parseFloat(result.value);
        result.unit = result.value.replace(num, "");
        result.value = num;
      }
      return result;
    };
    Property2.prototype.__getFullValue = function(_a2) {
      var _b = _a2 === void 0 ? {} : _a2, withDefault = _b.withDefault;
      return !this.hasValue() && withDefault ? this.getDefaultValue() : this.getFullValue();
    };
    Property2.prototype.getFullValue = function(val, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var fn = this.get("functionName");
      var def = this.getDefaultValue();
      var value = (0, index_all.isUndefined)(val) ? this.get("value") : val;
      var hasValue = !(0, index_all.isUndefined)(value) && value !== "";
      if (value && def && value === def) {
        return def;
      }
      if (fn && hasValue) {
        var fnParameter = fn === "url" ? "'".concat(value.replace(/'|"/g, ""), "'") : value;
        value = "".concat(fn, "(").concat(fnParameter, ")");
      }
      if (hasValue && this.get("important") && !opts.skipImportant) {
        value = "".concat(value, " !important");
      }
      return value || "";
    };
    Property2.prototype.__setParentTarget = function(parentTarget) {
      this.up({ parentTarget });
    };
    Property2.prototype.getParentTarget = function() {
      return this.get("parentTarget") || null;
    };
    Property2.prototype.__parseFn = function(input) {
      if (input === void 0) {
        input = "";
      }
      var start = input.indexOf("(") + 1;
      var end = input.lastIndexOf(")");
      return {
        name: input.substring(0, start - 1).trim(),
        value: String.prototype.substring.apply(input, [start, end >= 0 ? end : void 0]).trim()
      };
    };
    Property2.prototype.__checkVisibility = function(_a2) {
      var target = _a2.target, component = _a2.component, sectors = _a2.sectors;
      var trg = component || target;
      if (!trg)
        return false;
      var id = this.getId();
      var property = this.getName();
      var toRequire = this.get("toRequire");
      var requires = this.get("requires");
      var requiresParent = this.get("requiresParent");
      var unstylable = trg.get("unstylable");
      var stylableReq = trg.get("stylable-require");
      var stylable = trg.get("stylable");
      if ((0, index_all.isArray)(stylable)) {
        stylable = stylable.indexOf(property) >= 0;
      }
      if ((0, index_all.isArray)(unstylable)) {
        stylable = unstylable.indexOf(property) < 0;
      }
      if (toRequire) {
        stylable = !target || stylableReq && (stylableReq.indexOf(id) >= 0 || stylableReq.indexOf(property) >= 0);
      }
      if (sectors && requires) {
        var properties_1 = (0, index_all.keys)(requires);
        sectors.forEach(function(sector) {
          sector.getProperties().forEach(function(model) {
            if ((0, index_all.includes)(properties_1, model.id)) {
              var values = requires[model.id];
              stylable = stylable && (0, index_all.includes)(values, model.get("value"));
            }
          });
        });
      }
      if (requiresParent) {
        var parent_1 = component && component.parent();
        var parentEl = parent_1 && parent_1.getEl();
        if (parentEl) {
          var styles_1 = (0, mixins.hasWin)() ? window.getComputedStyle(parentEl) : {};
          (0, index_all.each)(requiresParent, function(values, property2) {
            stylable = stylable && styles_1[property2] && (0, index_all.includes)(values, styles_1[property2]);
          });
        } else {
          stylable = false;
        }
      }
      return !!stylable;
    };
    return Property2;
  }(common.Kx)
);
var model_Property = Property;
Property.callParentInit = function(property, ctx, props, opts) {
  if (opts === void 0) {
    opts = {};
  }
  property.prototype.initialize.apply(ctx, [
    props,
    Property_assign(Property_assign({}, opts), { skipInit: 1 })
  ]);
};
Property.callInit = function(context, props, opts) {
  if (opts === void 0) {
    opts = {};
  }
  !opts.skipInit && context.init(props, opts);
};
var Layer_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Layer_assign = function() {
  Layer_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Layer_assign.apply(this, arguments);
};
var Layer = (
  /** @class */
  function(_super) {
    Layer_extends(Layer2, _super);
    function Layer2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Layer2.prototype.defaults = function() {
      return {
        values: {}
      };
    };
    Layer2.prototype.initialize = function() {
      var cl = this.collection;
      this.prop = cl === null || cl === void 0 ? void 0 : cl.prop;
    };
    Layer2.prototype.getId = function() {
      return this.cid;
    };
    Layer2.prototype.getIndex = function() {
      var coll = this.collection;
      return coll ? coll.indexOf(this) : -1;
    };
    Layer2.prototype.getValues = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var values = this.get("values");
      return opts.camelCase ? Object.keys(values).reduce(function(res, key) {
        res[(0, mixins.camelCase)(key)] = values[key];
        return res;
      }, {}) : values;
    };
    Layer2.prototype.getLabel = function() {
      var _a2;
      return (_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.getLayerLabel(this);
    };
    Layer2.prototype.isSelected = function() {
      var _a2;
      return ((_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.getSelectedLayer()) === this;
    };
    Layer2.prototype.select = function() {
      var _a2;
      return (_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.selectLayer(this);
    };
    Layer2.prototype.remove = function() {
      var _a2;
      return (_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.removeLayer(this);
    };
    Layer2.prototype.move = function(index2) {
      var _a2;
      return (_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.moveLayer(this, index2);
    };
    Layer2.prototype.getStylePreview = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      return (_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.getStylePreview(this, opts);
    };
    Layer2.prototype.hasPreview = function() {
      var _a2;
      return !!((_a2 = this.prop) === null || _a2 === void 0 ? void 0 : _a2.get("preview"));
    };
    Layer2.prototype.upValues = function(props) {
      if (props === void 0) {
        props = {};
      }
      return this.set("values", Layer_assign(Layer_assign({}, this.getValues()), props));
    };
    return Layer2;
  }(common.Kx)
);
var model_Layer = Layer;
var Layers_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Layers = (
  /** @class */
  function(_super) {
    Layers_extends(Layers2, _super);
    function Layers2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Layers2.prototype.initialize = function(p, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.prop = opts.prop;
    };
    return Layers2;
  }(common.pM)
);
var model_Layers = Layers;
Layers.prototype.model = model_Layer;
var PropertyComposite_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyComposite_assign = function() {
  PropertyComposite_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyComposite_assign.apply(this, arguments);
};
var PropertyComposite_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var isNumberType = function(type2) {
  return type2 === "integer" || type2 === "number";
};
var PropertyComposite = (
  /** @class */
  function(_super) {
    PropertyComposite_extends(PropertyComposite2, _super);
    function PropertyComposite2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyComposite2.prototype.defaults = function() {
      return PropertyComposite_assign(PropertyComposite_assign({}, model_Property.getDefaults()), { detached: false, properties: [], separator: " ", join: null, fromStyle: null, toStyle: null, full: true });
    };
    PropertyComposite2.prototype.initialize = function(props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      model_Property.callParentInit(model_Property, this, props, opts);
      var em = this.em;
      var properties = new model_Properties(this.get("properties") || [], {
        em,
        parentProp: this
      });
      this.set("properties", properties, { silent: true });
      this.listenTo(properties, "change", this.__upProperties);
      model_Property.callInit(this, props, opts);
    };
    Object.defineProperty(PropertyComposite2.prototype, "properties", {
      get: function() {
        return this.get("properties") || [];
      },
      enumerable: false,
      configurable: true
    });
    PropertyComposite2.prototype.getProperties = function() {
      return PropertyComposite_spreadArray([], this.get("properties").models, true);
    };
    PropertyComposite2.prototype.getProperty = function(id) {
      return this.properties.filter(function(prop) {
        return prop.getId() === id || prop.getName() === id;
      })[0];
    };
    PropertyComposite2.prototype.getPropertyAt = function(index2) {
      return this.get("properties").at(index2);
    };
    PropertyComposite2.prototype.isDetached = function() {
      return !!this.get("detached");
    };
    PropertyComposite2.prototype.getValues = function(_a2) {
      var _b = _a2 === void 0 ? {} : _a2, byName = _b.byName;
      return this.getProperties().reduce(function(res, prop) {
        var key = byName ? prop.getName() : prop.getId();
        res[key] = "".concat(prop.__getFullValue());
        return res;
      }, {});
    };
    PropertyComposite2.prototype.getSeparator = function() {
      return this.getSplitSeparator();
    };
    PropertyComposite2.prototype.getJoin = function() {
      return this.__getJoin();
    };
    PropertyComposite2.prototype.getStyleFromProps = function(opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var name = this.getName();
      var join = this.__getJoin();
      var toStyle = this.get("toStyle");
      var values = this.getValues();
      var style = {};
      if (toStyle) {
        style = toStyle(values, { join, name, property: this });
      } else {
        values = this.getValues({ byName: true });
        if (this.isDetached()) {
          style = values;
        } else {
          var value = this.getProperties().map(function(p) {
            return p.__getFullValue({ withDefault: 1 });
          }).filter(Boolean).join(join);
          style = (_a2 = {}, _a2[name] = value, _a2);
        }
      }
      if (this.isDetached()) {
        style[name] = "";
      } else {
        style[name] = style[name] || "";
        style = PropertyComposite_assign(PropertyComposite_assign({}, style), this.getProperties().reduce(function(acc, prop) {
          acc[prop.getName()] = "";
          return acc;
        }, {}));
      }
      return opts.camelCase ? Object.keys(style).reduce(function(res, key) {
        res[(0, mixins.camelCase)(key)] = style[key];
        return res;
      }, {}) : style;
    };
    PropertyComposite2.prototype.getSplitSeparator = function() {
      return new RegExp("".concat(this.get("separator"), "(?![^\\(]*\\))"));
    };
    PropertyComposite2.prototype.__upProperties = function(p, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.__up || opts.__clearIn)
        return;
      var parentProp = this.__getParentProp();
      if (parentProp)
        return parentProp.__upProperties(this, opts);
      this.__upTargetsStyleProps(opts, p);
    };
    PropertyComposite2.prototype.__upTargetsStyleProps = function(opts, prop) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var style = this.getStyleFromProps();
      if (this.isDetached() && prop) {
        var name_1 = prop.getName();
        style = (_a2 = {}, _a2[name_1] = style[name_1], _a2);
      }
      this.__upTargetsStyle(style, opts);
    };
    PropertyComposite2.prototype._up = function(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.__setProperties(this.__getSplitValue(props.value), opts);
      model_Property.prototype._up.call(this, props, opts);
      return this;
    };
    PropertyComposite2.prototype.getStyle = function(opts) {
      return this.getStyleFromProps(opts);
    };
    PropertyComposite2.prototype.__getFullValue = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (this.isDetached() || opts.__clear)
        return "";
      var result = this.getStyleFromProps()[this.getName()] || "";
      return getLastStyleValue(result);
    };
    PropertyComposite2.prototype.__getJoin = function() {
      var join = this.get("join");
      return (0, index_all.isString)(join) ? join : this.get("separator");
    };
    PropertyComposite2.prototype.__styleHasProps = function(style) {
      if (style === void 0) {
        style = {};
      }
      var name = this.getName();
      var props = this.getProperties();
      var nameProps = props.map(function(prop) {
        return prop.getName();
      });
      var allNameProps = PropertyComposite_spreadArray([name], nameProps, true);
      return allNameProps.some(function(prop) {
        return !(0, index_all.isUndefined)(style[prop]) && style[prop] !== "";
      });
    };
    PropertyComposite2.prototype.__splitValue = function(value, sep) {
      return getLastStyleValue(value).split(sep).map(function(value2) {
        return value2.trim();
      }).filter(Boolean);
    };
    PropertyComposite2.prototype.__splitStyleName = function(style, name, sep) {
      return this.__splitValue(style[name] || "", sep);
    };
    PropertyComposite2.prototype.__getSplitValue = function(value, _a2) {
      if (value === void 0) {
        value = "";
      }
      var _b = _a2 === void 0 ? {} : _a2, byName = _b.byName;
      var props = this.getProperties();
      var props4Nums = props.length === 4 && props.every(function(prop) {
        return isNumberType(prop.getType());
      });
      var values = this.__splitValue(value, this.getSplitSeparator());
      var result = {};
      props.forEach(function(prop, i) {
        var value2 = values[i];
        var res = !(0, index_all.isUndefined)(value2) ? value2 : "";
        if (props4Nums) {
          var len = values.length;
          res = values[i] || values[i % len + (len != 1 && len % 2 ? 1 : 0)] || res;
        }
        var key = byName ? prop.getName() : prop.getId();
        result[key] = res || "";
      });
      return result;
    };
    PropertyComposite2.prototype.__getPropsFromStyle = function(style, opts) {
      if (style === void 0) {
        style = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      if (!this.__styleHasProps(style))
        return null;
      var byName = opts.byName;
      var name = this.getName();
      var props = this.getProperties();
      var sep = this.getSplitSeparator();
      var fromStyle = this.get("fromStyle");
      var result = fromStyle ? fromStyle(style, { property: this, name, separator: sep }) : {};
      if (!fromStyle) {
        result = this.__getSplitValue(style[name] || "", { byName });
        props.forEach(function(prop) {
          var value = style[prop.getName()];
          var key = byName ? prop.getName() : prop.getId();
          if (!(0, index_all.isUndefined)(value) && value !== "")
            result[key] = value;
        });
      }
      return result;
    };
    PropertyComposite2.prototype.__setProperties = function(values, opts) {
      if (values === void 0) {
        values = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      this.getProperties().forEach(function(prop) {
        var value = values[prop.getId()];
        prop.__getFullValue() !== value && prop.upValue(value, opts);
      });
      var valuesStr = (0, index_all.keys)(values).map(function(k2) {
        return values[k2];
      }).join(" ");
      this.set("value", valuesStr, { silent: true });
    };
    PropertyComposite2.prototype.clear = function() {
      var _this = this;
      this.getProperties().map(function(p) {
        return p.clear({ __clearIn: !_this.isDetached() });
      });
      model_Property.prototype.clear.call(this);
      return this;
    };
    PropertyComposite2.prototype.hasValue = function(opts) {
      return this.getProperties().some(function(prop) {
        return prop.hasValue(opts);
      });
    };
    PropertyComposite2.prototype.getFullValue = function() {
      return this.__getFullValue();
    };
    PropertyComposite2.prototype.__canClearProp = function(prop) {
      return this.isDetached() && prop.hasValue({ noParent: true });
    };
    return PropertyComposite2;
  }(model_Property)
);
var model_PropertyComposite = PropertyComposite;
var PropertyStack_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyStack_assign = function() {
  PropertyStack_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyStack_assign.apply(this, arguments);
};
var PropertyStack_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var VALUES_REG = /,(?![^\(]*\))/;
var PARTS_REG = /\s(?![^(]*\))/;
var PropertyStack = (
  /** @class */
  function(_super) {
    PropertyStack_extends(PropertyStack2, _super);
    function PropertyStack2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyStack2.prototype.defaults = function() {
      return PropertyStack_assign(PropertyStack_assign({}, model_PropertyComposite.getDefaults()), { layers: [], emptyValue: "unset", layerSeparator: ", ", layerJoin: "", prepend: 0, preview: false, layerLabel: null, selectedLayer: null });
    };
    PropertyStack2.prototype.initialize = function(props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      model_PropertyComposite.callParentInit(model_PropertyComposite, this, props, opts);
      var layers = this.get("layers");
      var layersColl = new model_Layers(layers, { prop: this });
      layersColl.property = this;
      layersColl.properties = this.get("properties");
      this.set("layers", layersColl, { silent: true });
      this.on("change:selectedLayer", this.__upSelected);
      this.listenTo(layersColl, "add remove", this.__upLayers);
      model_PropertyComposite.callInit(this, props, opts);
    };
    Object.defineProperty(PropertyStack2.prototype, "layers", {
      get: function() {
        return this.get("layers");
      },
      enumerable: false,
      configurable: true
    });
    PropertyStack2.prototype.getLayers = function() {
      return this.layers.models;
    };
    PropertyStack2.prototype.hasLayers = function() {
      return this.getLayers().length > 0;
    };
    PropertyStack2.prototype.getLayer = function(index2) {
      if (index2 === void 0) {
        index2 = 0;
      }
      return this.layers.at(index2) || void 0;
    };
    PropertyStack2.prototype.getSelectedLayer = function() {
      var layer = this.get("selectedLayer");
      return layer && layer.getIndex() >= 0 ? layer : void 0;
    };
    PropertyStack2.prototype.selectLayer = function(layer) {
      return this.set("selectedLayer", layer, { __select: true });
    };
    PropertyStack2.prototype.selectLayerAt = function(index2) {
      if (index2 === void 0) {
        index2 = 0;
      }
      var layer = this.getLayer(index2);
      return layer && this.selectLayer(layer);
    };
    PropertyStack2.prototype.moveLayer = function(layer, index2) {
      if (index2 === void 0) {
        index2 = 0;
      }
      var layers = this.layers;
      var currIndex = layer ? layer.getIndex() : -1;
      if (currIndex >= 0 && (0, index_all.isNumber)(index2) && index2 >= 0 && index2 < layers.length && currIndex !== index2) {
        this.removeLayer(layer);
        layers.add(layer, { at: index2 });
      }
    };
    PropertyStack2.prototype.addLayer = function(props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var values = {};
      this.getProperties().forEach(function(prop) {
        var key = prop.getId();
        var value = props[key];
        values[key] = (0, index_all.isUndefined)(value) ? prop.getDefaultValue() : value;
      });
      var layer = this.layers.push({ values }, opts);
      return layer;
    };
    PropertyStack2.prototype.removeLayer = function(layer) {
      return this.layers.remove(layer);
    };
    PropertyStack2.prototype.removeLayerAt = function(index2) {
      if (index2 === void 0) {
        index2 = 0;
      }
      var layer = this.getLayer(index2);
      return layer ? this.removeLayer(layer) : null;
    };
    PropertyStack2.prototype.getLayerLabel = function(layer) {
      var result = "";
      if (layer) {
        var layerLabel = this.get("layerLabel");
        var values_1 = layer.getValues();
        var index2 = layer.getIndex();
        if (layerLabel) {
          result = layerLabel(layer, { index: index2, values: values_1, property: this });
        } else {
          var parts_1 = [];
          this.getProperties().map(function(prop) {
            parts_1.push(values_1[prop.getId()]);
          });
          result = parts_1.filter(Boolean).join(" ");
        }
      }
      return result;
    };
    PropertyStack2.prototype.getStyleFromLayer = function(layer, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var join = this.__getJoin();
      var joinLayers = this.__getJoinLayers();
      var toStyle = this.get("toStyle");
      var name = this.getName();
      var values = layer.getValues();
      var style;
      if (toStyle) {
        style = toStyle(values, {
          join,
          joinLayers,
          name,
          layer,
          property: this
        });
      } else {
        var result = this.getProperties().map(function(prop) {
          var name2 = prop.getName();
          var val = values[prop.getId()];
          var value = (0, index_all.isUndefined)(val) ? prop.getDefaultValue() : val;
          if (opts.number && isNumberType(prop.getType())) {
            var newVal = prop.parseValue(val, opts.number);
            value = "".concat(newVal.value).concat(newVal.unit);
          }
          return { name: name2, value };
        });
        style = this.isDetached() ? result.reduce(function(acc, item) {
          acc[item.name] = item.value;
          return acc;
        }, {}) : (_a2 = {}, _a2[this.getName()] = result.map(function(r) {
          return r.value;
        }).join(join), _a2);
      }
      return opts.camelCase ? Object.keys(style).reduce(function(res, key) {
        res[(0, mixins.camelCase)(key)] = style[key];
        return res;
      }, {}) : style;
    };
    PropertyStack2.prototype.getStylePreview = function(layer, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var result = {};
      var preview = this.get("preview");
      if (preview) {
        result = this.getStyleFromLayer(layer, opts);
      }
      return result;
    };
    PropertyStack2.prototype.getLayerSeparator = function() {
      var sep = this.get("layerSeparator");
      return (0, index_all.isString)(sep) ? new RegExp("".concat(sep, "(?![^\\(]*\\))")) : sep;
    };
    PropertyStack2.prototype.hasEmptyValue = function() {
      return !this.hasLayers() && !!this.attributes.isEmptyValue;
    };
    PropertyStack2.prototype.__upProperties = function(prop, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var layer = this.getSelectedLayer();
      if (!layer)
        return;
      layer.upValues((_a2 = {}, _a2[prop.getId()] = prop.__getFullValue(), _a2));
      if (opts.__up)
        return;
      this.__upTargetsStyleProps(opts);
    };
    PropertyStack2.prototype.__upLayers = function(m, c, o) {
      this.__upTargetsStyleProps(o || c);
    };
    PropertyStack2.prototype.__upTargets = function(p, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (opts.__select)
        return;
      return model_Property.prototype.__upTargets.call(this, p, opts);
    };
    PropertyStack2.prototype.__upTargetsStyleProps = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.__upTargetsStyle(this.getStyleFromLayers(opts), opts);
    };
    PropertyStack2.prototype.__upTargetsStyle = function(style, opts) {
      return model_Property.prototype.__upTargetsStyle.call(this, style, opts);
    };
    PropertyStack2.prototype.__upSelected = function(_a2, opts) {
      var _b = _a2 === void 0 ? {} : _a2, noEvent = _b.noEvent;
      if (opts === void 0) {
        opts = {};
      }
      var sm = this.em.Styles;
      var selected = this.getSelectedLayer();
      var values = selected === null || selected === void 0 ? void 0 : selected.getValues();
      values && this.getProperties().forEach(function(prop) {
        var _a3;
        var value = (_a3 = values[prop.getId()]) !== null && _a3 !== void 0 ? _a3 : "";
        prop.__getFullValue() !== value && prop.upValue(value, PropertyStack_assign(PropertyStack_assign({}, opts), { __up: true }));
      });
      !noEvent && sm.__trgEv(sm.events.layerSelect, { property: this });
    };
    PropertyStack2.prototype._up = function(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = props.__layers, __layers = _a2 === void 0 ? [] : _a2, rest = PropertyStack_rest(props, ["__layers"]);
      !this.isDetached() && this.__setLayers(__layers);
      this.__upSelected({ noEvent: true }, opts);
      model_Property.prototype._up.call(this, rest, opts);
      return this;
    };
    PropertyStack2.prototype.__setLayers = function(newLayers, opts) {
      if (newLayers === void 0) {
        newLayers = [];
      }
      if (opts === void 0) {
        opts = {};
      }
      var layers = this.layers;
      var layersNew = newLayers.map(function(values) {
        return { values };
      });
      if (layers.length === layersNew.length) {
        layersNew.map(function(layer, n) {
          var _a2;
          return (_a2 = layers.at(n)) === null || _a2 === void 0 ? void 0 : _a2.upValues(layer.values);
        });
      } else {
        layers.reset(layersNew);
      }
      this.set({ isEmptyValue: !!opts.isEmptyValue });
      this.__upSelected({ noEvent: true });
    };
    PropertyStack2.prototype.__parseValue = function(value) {
      var _this = this;
      var result = this.parseValue(value);
      result.__layers = value.split(VALUES_REG).map(function(v) {
        return v.trim();
      }).map(function(v) {
        return _this.__parseLayer(v);
      }).filter(Boolean);
      return result;
    };
    PropertyStack2.prototype.__parseLayer = function(value) {
      var parseFn = this.get("parseLayer");
      var values = value.split(PARTS_REG);
      var properties = this.getProperties();
      return parseFn ? parseFn({ value, values }) : properties.reduce(function(acc, prop, i) {
        var value2 = values[i];
        acc[prop.getId()] = !(0, index_all.isUndefined)(value2) ? value2 : prop.getDefaultValue();
        return acc;
      }, {});
    };
    PropertyStack2.prototype.__getLayersFromStyle = function(style) {
      var _this = this;
      if (style === void 0) {
        style = {};
      }
      if (!this.__styleHasProps(style))
        return null;
      if (this.isEmptyValueStyle(style))
        return [];
      var name = this.getName();
      var props = this.getProperties();
      var sep = this.getLayerSeparator();
      var fromStyle = this.attributes.fromStyle;
      var result = fromStyle ? fromStyle(style, { property: this, name, separatorLayers: sep }) : [];
      if (!fromStyle) {
        var layers_1 = this.__splitStyleName(style, name, sep).map(function(value) {
          return value.split(_this.getSplitSeparator());
        }).map(function(parts) {
          var result2 = {};
          props.forEach(function(prop, i) {
            var value = parts[i];
            result2[prop.getId()] = !(0, index_all.isUndefined)(value) ? value : prop.getDefaultValue();
          });
          return result2;
        });
        props.forEach(function(prop) {
          var id = prop.getId();
          _this.__splitStyleName(style, prop.getName(), sep).map(function(value) {
            var _a2;
            return _a2 = {}, _a2[id] = value || prop.getDefaultValue(), _a2;
          }).forEach(function(inLayer, i) {
            layers_1[i] = layers_1[i] ? PropertyStack_assign(PropertyStack_assign({}, layers_1[i]), inLayer) : inLayer;
          });
        });
        result = layers_1;
      }
      return (0, index_all.isArray)(result) ? result : [result];
    };
    PropertyStack2.prototype.getStyle = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this.getStyleFromLayers(opts);
    };
    PropertyStack2.prototype.getStyleFromLayers = function(opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var result = {};
      var name = this.getName();
      var layers = this.getLayers();
      var props = this.getProperties();
      var styles = layers.map(function(l) {
        return _this.getStyleFromLayer(l, opts);
      });
      styles.forEach(function(style2) {
        (0, index_all.keys)(style2).map(function(key) {
          if (!result[key]) {
            result[key] = [];
          }
          result[key].push(style2[key]);
        });
      });
      (0, index_all.keys)(result).map(function(key) {
        result[key] = result[key].join(_this.__getJoinLayers());
      });
      if (this.isDetached()) {
        result[name] = "";
        !layers.length && props.map(function(prop) {
          result[prop.getName()] = "";
        });
      } else {
        var style = props.reduce(function(acc, prop) {
          acc[prop.getName()] = "";
          return acc;
        }, {});
        result[name] = result[name] || "";
        result = PropertyStack_assign(PropertyStack_assign({}, result), style);
      }
      return PropertyStack_assign(PropertyStack_assign({}, result), opts.__clear ? {} : this.getEmptyValueStyle());
    };
    PropertyStack2.prototype.isEmptyValueStyle = function(style) {
      if (style === void 0) {
        style = {};
      }
      var emptyStyle = this.getEmptyValueStyle({ force: true });
      var props = (0, index_all.keys)(emptyStyle);
      return !!props.length && props.every(function(prop) {
        return emptyStyle[prop] === style[prop];
      });
    };
    PropertyStack2.prototype.getEmptyValueStyle = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var emptyValue = this.attributes.emptyValue;
      if (emptyValue && (!this.hasLayers() || opts.force)) {
        var name_1 = this.getName();
        var props = this.getProperties();
        var result_1 = (0, index_all.isString)(emptyValue) ? emptyValue : emptyValue({ property: this });
        if ((0, index_all.isString)(result_1)) {
          var style_1 = {};
          if (this.isDetached()) {
            props.map(function(prop) {
              style_1[prop.getName()] = result_1;
            });
          } else {
            style_1[name_1] = result_1;
          }
          return style_1;
        } else {
          return result_1;
        }
      } else {
        return {};
      }
    };
    PropertyStack2.prototype.__getJoinLayers = function() {
      var join = this.get("layerJoin");
      var sep = this.get("layerSeparator");
      return join || ((0, index_all.isString)(sep) ? sep : join);
    };
    PropertyStack2.prototype.__getFullValue = function() {
      if (this.get("detached"))
        return "";
      var style = this.getStyleFromLayers();
      return getLastStyleValue(style[this.getName()]);
    };
    PropertyStack2.prototype.hasValue = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var noParent = opts.noParent;
      var parentValue = noParent && this.getParentTarget();
      return (this.hasLayers() || this.hasEmptyValue()) && !parentValue;
    };
    PropertyStack2.prototype.clear = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.layers.reset();
      this.__upTargetsStyleProps(PropertyStack_assign(PropertyStack_assign({}, opts), { __clear: true }));
      model_Property.prototype.clear.call(this);
      return this;
    };
    PropertyStack2.prototype.__canClearProp = function() {
      return false;
    };
    PropertyStack2.prototype.__getLayers = function() {
      return this.layers;
    };
    return PropertyStack2;
  }(model_PropertyComposite)
);
var model_PropertyStack = PropertyStack;
var PropertyView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyView_assign = function() {
  PropertyView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyView_assign.apply(this, arguments);
};
var PropertyView_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var PropertyView_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var clearProp = "data-clear-style";
var PropertyView = (
  /** @class */
  function(_super) {
    PropertyView_extends(PropertyView2, _super);
    function PropertyView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      (0, index_all.bindAll)(_this, "__change", "__updateStyle");
      var config2 = o.config || {};
      var em = config2.em;
      _this.config = config2;
      _this.em = em;
      _this.pfx = config2.stylePrefix || "";
      _this.ppfx = config2.pStylePrefix || "";
      _this.__destroyFn = _this.destroy ? _this.destroy.bind(_this) : function() {
      };
      var model = _this.model;
      model.view = _this;
      _this.onValueChange = (0, index_all.debounce)(_this.onValueChange.bind(_this), 10);
      _this.updateStatus = (0, index_all.debounce)(_this.updateStatus.bind(_this), 0);
      _this.listenTo(model, "destroy remove", _this.remove);
      _this.listenTo(model, "change:visible", _this.updateVisibility);
      _this.listenTo(model, "change:name change:className change:full", _this.render);
      _this.listenTo(model, "change:value", _this.onValueChange);
      _this.listenTo(model, "change:parentTarget", _this.updateStatus);
      _this.listenTo(em, "change:device", _this.onValueChange);
      var init = _this.init && _this.init.bind(_this);
      init && init();
      return _this;
    }
    PropertyView2.prototype.events = function() {
      var _a2;
      return _a2 = {
        change: "inputValueChanged"
      }, _a2["click [".concat(clearProp, "]")] = "clear", _a2;
    };
    PropertyView2.prototype.template = function(model) {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx;
      return '\n      <div class="'.concat(pfx, 'label" data-sm-label></div>\n      <div class="').concat(ppfx, 'fields" data-sm-fields></div>\n    ');
    };
    PropertyView2.prototype.templateLabel = function(model) {
      var _a2 = this, pfx = _a2.pfx, em = _a2.em;
      var parent = model.parent;
      var _b = model.attributes, _c = _b.icon, icon = _c === void 0 ? "" : _c, _d = _b.info, info = _d === void 0 ? "" : _d;
      var icons = em === null || em === void 0 ? void 0 : em.getConfig().icons;
      var iconClose = (icons === null || icons === void 0 ? void 0 : icons.close) || "";
      return '\n      <span class="'.concat(pfx, "icon ").concat(icon, '" title="').concat(info, '">\n        ').concat(model.getLabel(), "\n      </span>\n      ").concat(!parent ? '<div class="'.concat(pfx, 'clear" style="display: none" ').concat(clearProp, ">").concat(iconClose, "</div>") : "", "\n    ");
    };
    PropertyView2.prototype.templateInput = function(model) {
      return '\n      <div class="'.concat(this.ppfx, 'field">\n        <input placeholder="').concat(model.getDefaultValue(), '"/>\n      </div>\n    ');
    };
    PropertyView2.prototype.remove = function() {
      var _this = this;
      common.Ss.prototype.remove.apply(this, arguments);
      ["em", "input", "$input", "view"].forEach(function(i) {
        return _this[i] = null;
      });
      this.__destroyFn(this._getClbOpts());
      return this;
    };
    PropertyView2.prototype.updateStatus = function() {
      var _a2;
      var _b = this, model = _b.model, pfx = _b.pfx, ppfx = _b.ppfx, config2 = _b.config;
      var updatedCls = "".concat(ppfx, "four-color");
      var computedCls = "".concat(ppfx, "color-warn");
      var labelEl = this.$el.children(".".concat(pfx, "label"));
      var clearStyleEl = this.getClearEl();
      var clearStyle = clearStyleEl ? clearStyleEl.style : {};
      labelEl.removeClass("".concat(updatedCls, " ").concat(computedCls));
      clearStyle.display = "none";
      if (model.hasValue({ noParent: true }) && config2.highlightChanged) {
        labelEl.addClass(updatedCls);
        config2.clearProperties && (clearStyle.display = "");
      } else if (model.hasValue() && config2.highlightComputed) {
        labelEl.addClass(computedCls);
      }
      (_a2 = this.parent) === null || _a2 === void 0 ? void 0 : _a2.updateStatus();
    };
    PropertyView2.prototype.clear = function(ev) {
      ev && ev.stopPropagation();
      this.model.clear();
    };
    PropertyView2.prototype.getClearEl = function() {
      if (!this.clearEl) {
        this.clearEl = this.el.querySelector("[".concat(clearProp, "]"));
      }
      return this.clearEl;
    };
    PropertyView2.prototype.inputValueChanged = function(ev) {
      ev && ev.stopPropagation();
      if (this.emit)
        return;
      this.model.upValue(ev.target.value);
    };
    PropertyView2.prototype.onValueChange = function(m, val, opt) {
      if (opt === void 0) {
        opt = {};
      }
      this.setValue(this.model.getFullValue(void 0, { skipImportant: true }));
      this.updateStatus();
    };
    PropertyView2.prototype.setValue = function(value) {
      var model = this.model;
      var result = (0, index_all.isUndefined)(value) || value === "" ? model.getDefaultValue() : value;
      if (this.update)
        return this.__update(result);
      this.__setValueInput(result);
    };
    PropertyView2.prototype.__setValueInput = function(value) {
      var input = this.getInputEl();
      input && (input.value = value);
    };
    PropertyView2.prototype.getInputEl = function() {
      if (!this.input) {
        this.input = this.el.querySelector("input");
      }
      return this.input;
    };
    PropertyView2.prototype.updateVisibility = function() {
      this.el.style.display = this.model.isVisible() ? "" : "none";
    };
    PropertyView2.prototype.clearCached = function() {
      delete this.clearEl;
      delete this.input;
      delete this.$input;
    };
    PropertyView2.prototype.__unset = function() {
      var unset = this.unset && this.unset.bind(this);
      unset && unset(this._getClbOpts());
    };
    PropertyView2.prototype.__update = function(value) {
      var update = this.update && this.update.bind(this);
      update && update(PropertyView_assign(PropertyView_assign({}, this._getClbOpts()), { value }));
    };
    PropertyView2.prototype.__change = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      var emit = this.emit && this.emit.bind(this);
      emit && emit.apply(void 0, PropertyView_spreadArray([this._getClbOpts()], args, false));
    };
    PropertyView2.prototype.__updateStyle = function(value, _a2) {
      if (_a2 === void 0) {
        _a2 = {};
      }
      var complete = _a2.complete, partial = _a2.partial, opts = PropertyView_rest(_a2, ["complete", "partial"]);
      var model = this.model;
      var final = complete !== false && partial !== true;
      if ((0, mixins.isObject)(value)) {
        model.__upTargetsStyle(value, { avoidStore: !final });
      } else {
        model.upValue(value, { partial: !final });
      }
    };
    PropertyView2.prototype._getClbOpts = function() {
      var _a2 = this, model = _a2.model, el = _a2.el, createdEl = _a2.createdEl;
      return {
        el,
        createdEl,
        property: model,
        props: model.attributes,
        change: this.__change,
        updateStyle: this.__updateStyle
      };
    };
    PropertyView2.prototype.render = function() {
      this.clearCached();
      var _a2 = this, pfx = _a2.pfx, model = _a2.model, el = _a2.el, $el = _a2.$el;
      var name = model.getName();
      var type2 = model.getType();
      var cls = model.get("className") || "";
      var className = "".concat(pfx, "property");
      var clsType = type2 === "number" ? "".concat(pfx).concat(type2, " ").concat(pfx, "integer") : "".concat(pfx).concat(type2);
      this.createdEl && this.__destroyFn(this._getClbOpts());
      $el.empty().append(this.template(model));
      $el.find("[data-sm-label]").append(this.templateLabel(model));
      var create = this.create && this.create.bind(this);
      this.createdEl = create && create(this._getClbOpts());
      $el.find("[data-sm-fields]").append(this.createdEl || this.templateInput(model));
      el.className = "".concat(className, " ").concat(clsType, " ").concat(className, "__").concat(name, " ").concat(cls).trim();
      el.className += model.isFull() ? " ".concat(className, "--full") : "";
      var onRender = this.onRender && this.onRender.bind(this);
      onRender && onRender();
      this.setValue(model.getValue());
      return this;
    };
    PropertyView2.prototype.onRender = function() {
    };
    return PropertyView2;
  }(common.Ss)
);
var view_PropertyView = PropertyView;
var PropertiesView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertiesView = (
  /** @class */
  function(_super) {
    PropertiesView_extends(PropertiesView2, _super);
    function PropertiesView2(o) {
      var _this = _super.call(this, o) || this;
      _this.config = o.config || {};
      _this.pfx = _this.config.stylePrefix || "";
      _this.properties = [];
      _this.parent = o.parent;
      var coll = _this.collection;
      _this.listenTo(coll, "add", _this.addTo);
      _this.listenTo(coll, "reset", _this.render);
      return _this;
    }
    PropertiesView2.prototype.addTo = function(model, coll, opts) {
      this.add(model, null, opts);
    };
    PropertiesView2.prototype.add = function(model, frag, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, parent = _a2.parent, config2 = _a2.config;
      var appendTo = frag || this.el;
      var view = new model.typeView({ model, config: config2 });
      parent && (view.parent = parent);
      view.render();
      var rendered = view.el;
      this.properties.push(view);
      (0, dom.Sc)(appendTo, rendered, opts.at);
    };
    PropertiesView2.prototype.remove = function() {
      common.Ss.prototype.remove.apply(this, arguments);
      this.clearItems();
      return this;
    };
    PropertiesView2.prototype.clearItems = function() {
      this.properties.forEach(function(item) {
        return item.remove();
      });
      this.properties = [];
    };
    PropertiesView2.prototype.render = function() {
      var _this = this;
      var _a2 = this, $el = _a2.$el, pfx = _a2.pfx;
      this.clearItems();
      var fragment = document.createDocumentFragment();
      this.collection.forEach(function(model) {
        return _this.add(model, fragment);
      });
      $el.empty();
      $el.append(fragment);
      $el.attr("class", "".concat(pfx, "properties"));
      return this;
    };
    return PropertiesView2;
  }(common.Ss)
);
var view_PropertiesView = PropertiesView;
var PropertyCompositeView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyCompositeView_assign = function() {
  PropertyCompositeView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyCompositeView_assign.apply(this, arguments);
};
var PropertyCompositeView = (
  /** @class */
  function(_super) {
    PropertyCompositeView_extends(PropertyCompositeView2, _super);
    function PropertyCompositeView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyCompositeView2.prototype.templateInput = function() {
      var pfx = this.pfx;
      return '\n      <div class="'.concat(pfx, "field ").concat(pfx, 'composite">\n        <span id="').concat(pfx, 'input-holder"></span>\n      </div>\n    ');
    };
    PropertyCompositeView2.prototype.remove = function() {
      var _a2;
      (_a2 = this.props) === null || _a2 === void 0 ? void 0 : _a2.remove();
      view_PropertyView.prototype.remove.apply(this, arguments);
      return this;
    };
    PropertyCompositeView2.prototype.onValueChange = function() {
    };
    PropertyCompositeView2.prototype.onRender = function() {
      var pfx = this.pfx;
      var model = this.model;
      var props = model.get("properties");
      if (props.length && !this.props) {
        var detached = model.isDetached();
        var propsView = new view_PropertiesView({
          config: PropertyCompositeView_assign(PropertyCompositeView_assign({}, this.config), { highlightComputed: detached, highlightChanged: detached }),
          // @ts-ignore
          collection: props,
          parent: this
        });
        propsView.render();
        this.$el.find("#".concat(pfx, "input-holder")).append(propsView.el);
        this.props = propsView;
      }
    };
    PropertyCompositeView2.prototype.clearCached = function() {
      view_PropertyView.prototype.clearCached.apply(this, arguments);
      delete this.props;
    };
    return PropertyCompositeView2;
  }(view_PropertyView)
);
var view_PropertyCompositeView = PropertyCompositeView;
var LayerView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var LayerView = (
  /** @class */
  function(_super) {
    LayerView_extends(LayerView2, _super);
    function LayerView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    LayerView2.prototype.events = function() {
      return {
        click: "select",
        "click [data-close-layer]": "removeItem",
        "mousedown [data-move-layer]": "initSorter",
        "touchstart [data-move-layer]": "initSorter"
      };
    };
    LayerView2.prototype.template = function() {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx, em = _a2.em;
      var icons = em === null || em === void 0 ? void 0 : em.getConfig().icons;
      var iconClose = (icons === null || icons === void 0 ? void 0 : icons.close) || "";
      var iconMove = (icons === null || icons === void 0 ? void 0 : icons.move) || "";
      return '\n      <div class="'.concat(pfx, 'label-wrp">\n        <div id="').concat(pfx, 'move" class="').concat(ppfx, 'no-touch-actions" data-move-layer>\n          ').concat(iconMove, '\n        </div>\n        <div id="').concat(pfx, 'label" data-label></div>\n        <div id="').concat(pfx, 'preview-box" class="').concat(pfx, 'layer-preview" style="display: none" data-preview-box>\n          <div id="').concat(pfx, 'preview" class="').concat(pfx, 'layer-preview-cnt" data-preview></div>\n        </div>\n        <div id="').concat(pfx, 'close-layer" class="').concat(pfx, 'btn-close" data-close-layer>\n          ').concat(iconClose, '\n        </div>\n      </div>\n      <div id="').concat(pfx, 'inputs" data-properties></div>\n    ');
    };
    LayerView2.prototype.initialize = function(o) {
      if (o === void 0) {
        o = {};
      }
      var model = this.model;
      var config2 = o.config || {};
      this.em = config2.em;
      this.config = config2;
      this.sorter = o.sorter;
      this.pfx = config2.stylePrefix || "";
      this.ppfx = config2.pStylePrefix || "";
      this.propertyView = o.propertyView;
      var pModel = this.propertyView.model;
      this.listenTo(model, "destroy remove", this.remove);
      this.listenTo(model, "change:values", this.updateLabel);
      this.listenTo(pModel, "change:selectedLayer", this.updateVisibility);
      model.view = this;
      model.set({ droppable: 0, draggable: 1 });
      this.$el.data("model", model);
    };
    LayerView2.prototype.initSorter = function() {
      var _a2;
      (_a2 = this.sorter) === null || _a2 === void 0 ? void 0 : _a2.startSort(this.el);
    };
    LayerView2.prototype.removeItem = function(ev) {
      ev && ev.stopPropagation();
      this.model.remove();
    };
    LayerView2.prototype.select = function() {
      this.model.select();
    };
    LayerView2.prototype.getPropertiesWrapper = function() {
      if (!this.propsWrapEl)
        this.propsWrapEl = this.el.querySelector("[data-properties]");
      return this.propsWrapEl;
    };
    LayerView2.prototype.getPreviewEl = function() {
      if (!this.previewEl)
        this.previewEl = this.el.querySelector("[data-preview]");
      return this.previewEl;
    };
    LayerView2.prototype.getLabelEl = function() {
      if (!this.labelEl)
        this.labelEl = this.el.querySelector("[data-label]");
      return this.labelEl;
    };
    LayerView2.prototype.updateLabel = function() {
      var model = this.model;
      var label = model.getLabel();
      this.getLabelEl().innerHTML = label;
      if (model.hasPreview()) {
        var prvEl = this.getPreviewEl();
        var style_1 = model.getStylePreview({ number: { min: -3, max: 3 } });
        var styleStr = (0, index_all.keys)(style_1).map(function(k2) {
          return "".concat(k2, ":").concat(style_1[k2]);
        }).join(";");
        prvEl.setAttribute("style", styleStr);
      }
    };
    LayerView2.prototype.updateVisibility = function() {
      var _a2;
      var _b = this, pfx = _b.pfx, model = _b.model, propertyView = _b.propertyView;
      var wrapEl = this.getPropertiesWrapper();
      var isSelected = model.isSelected();
      wrapEl.style.display = isSelected ? "" : "none";
      this.$el[isSelected ? "addClass" : "removeClass"]("".concat(pfx, "active"));
      isSelected && wrapEl.appendChild((_a2 = propertyView.props) === null || _a2 === void 0 ? void 0 : _a2.el);
    };
    LayerView2.prototype.render = function() {
      var _a2 = this, el = _a2.el, pfx = _a2.pfx, model = _a2.model;
      el.innerHTML = this.template();
      el.className = "".concat(pfx, "layer");
      if (model.hasPreview()) {
        el.querySelector("[data-preview-box]").style.display = "";
      }
      this.updateLabel();
      this.updateVisibility();
      return this;
    };
    return LayerView2;
  }(common.Ss)
);
var view_LayerView = LayerView;
var LayersView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var LayersView = (
  /** @class */
  function(_super) {
    LayersView_extends(LayersView2, _super);
    function LayersView2(o) {
      var _this = _super.call(this, o) || this;
      var coll = _this.collection;
      var config2 = o.config || {};
      var em = config2.em;
      var pfx = config2.stylePrefix || "";
      var ppfx = config2.pStylePrefix || "";
      _this.config = config2;
      _this.pfx = pfx;
      _this.ppfx = ppfx;
      _this.propertyView = o.propertyView;
      _this.className = "".concat(pfx, "layers ").concat(ppfx, "field");
      _this.listenTo(coll, "add", _this.addTo);
      _this.listenTo(coll, "reset", _this.reset);
      _this.items = [];
      var utils2 = em === null || em === void 0 ? void 0 : em.Utils;
      _this.sorter = utils2 ? new utils2.Sorter({
        // @ts-ignore
        container: _this.el,
        ignoreViewChildren: 1,
        containerSel: ".".concat(pfx, "layers"),
        itemSel: ".".concat(pfx, "layer"),
        pfx: config2.pStylePrefix,
        em
      }) : "";
      coll.view = _this;
      _this.$el.data("model", coll);
      _this.$el.data("collection", coll);
      return _this;
    }
    LayersView2.prototype.addTo = function(model) {
      var i = this.collection.indexOf(model);
      this.addToCollection(model, null, i);
    };
    LayersView2.prototype.addToCollection = function(model, fragmentEl, index2) {
      var fragment = fragmentEl || null;
      var _a2 = this, propertyView = _a2.propertyView, config2 = _a2.config, sorter = _a2.sorter, $el = _a2.$el;
      var view = new view_LayerView({
        model,
        // @ts-ignore
        config: config2,
        sorter,
        propertyView
      });
      var rendered = view.render().el;
      this.items.push(view);
      if (fragment) {
        fragment.appendChild(rendered);
      } else {
        if (typeof index2 != "undefined") {
          var method = "before";
          if ($el.children().length === index2) {
            index2--;
            method = "after";
          }
          if (index2 < 0) {
            $el.append(rendered);
          } else {
            $el.children().eq(index2)[method](rendered);
          }
        } else {
          $el.append(rendered);
        }
      }
      return rendered;
    };
    LayersView2.prototype.reset = function(coll, opts) {
      this.clearItems();
      this.render();
    };
    LayersView2.prototype.remove = function() {
      this.clearItems();
      common.Ss.prototype.remove.apply(this, arguments);
      return this;
    };
    LayersView2.prototype.clearItems = function() {
      this.items.forEach(function(item) {
        return item.remove();
      });
      this.items = [];
    };
    LayersView2.prototype.render = function() {
      var _this = this;
      var _a2 = this, $el = _a2.$el, sorter = _a2.sorter;
      var frag = document.createDocumentFragment();
      $el.empty();
      this.collection.forEach(function(m) {
        return _this.addToCollection(m, frag);
      });
      $el.append(frag);
      $el.attr("class", this.className);
      if (sorter)
        sorter.plh = null;
      return this;
    };
    return LayersView2;
  }(common.Ss)
);
var view_LayersView = LayersView;
var PropertyStackView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyStackView_assign = function() {
  PropertyStackView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyStackView_assign.apply(this, arguments);
};
var PropertyStackView = (
  /** @class */
  function(_super) {
    PropertyStackView_extends(PropertyStackView2, _super);
    function PropertyStackView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyStackView2.prototype.events = function() {
      return PropertyStackView_assign(PropertyStackView_assign({}, view_PropertyCompositeView.prototype.events()), { "click [data-add-layer]": "addLayer", change: "" });
    };
    PropertyStackView2.prototype.templateInput = function() {
      var _a2 = this, pfx = _a2.pfx, em = _a2.em;
      var icons = em === null || em === void 0 ? void 0 : em.getConfig().icons;
      var iconPlus = (icons === null || icons === void 0 ? void 0 : icons.plus) || "+";
      return '\n      <div class="'.concat(pfx, "field ").concat(pfx, 'stack">\n        <button type="button" id="').concat(pfx, 'add" data-add-layer>\n          ').concat(iconPlus, "\n        </button>\n        <div data-layers-wrapper></div>\n      </div>\n    ");
    };
    PropertyStackView2.prototype.init = function() {
      var model = this.model;
      this.listenTo(model.layers, "change reset", this.updateStatus);
      this.listenTo(model, "change:isEmptyValue", this.updateStatus);
    };
    PropertyStackView2.prototype.addLayer = function() {
      this.model.addLayer({}, { at: 0 });
    };
    PropertyStackView2.prototype.setValue = function() {
    };
    PropertyStackView2.prototype.remove = function() {
      var _a2;
      (_a2 = this.layersView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      view_PropertyCompositeView.prototype.remove.apply(this, arguments);
      return this;
    };
    PropertyStackView2.prototype.clearCached = function() {
      view_PropertyCompositeView.prototype.clearCached.apply(this, arguments);
      delete this.layersView;
    };
    PropertyStackView2.prototype.onRender = function() {
      var _a2 = this, model = _a2.model, el = _a2.el, config2 = _a2.config;
      var props = model.get("properties");
      if (props.length && !this.props) {
        var propsView = new view_PropertiesView({
          config: PropertyStackView_assign(PropertyStackView_assign({}, config2), { highlightComputed: false, highlightChanged: false }),
          // @ts-ignore
          collection: props,
          parent: this
        });
        propsView.render();
        var layersView = new view_LayersView({
          collection: model.layers,
          // @ts-ignore
          config: config2,
          propertyView: this
        });
        layersView.render();
        var fieldEl = el.querySelector("[data-layers-wrapper]");
        fieldEl.appendChild(layersView.el);
        this.props = propsView;
        this.layersView = layersView;
      }
    };
    return PropertyStackView2;
  }(view_PropertyCompositeView)
);
var view_PropertyStackView = PropertyStackView;
var PropertyFileView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyFileView_assign = function() {
  PropertyFileView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyFileView_assign.apply(this, arguments);
};
var PropertyFileView = (
  /** @class */
  function(_super) {
    PropertyFileView_extends(PropertyFileView2, _super);
    function PropertyFileView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyFileView2.prototype.events = function() {
      return PropertyFileView_assign(PropertyFileView_assign({}, view_PropertyView.prototype.events()), { "click [data-clear-asset]": "clear", "click [data-open-assets]": "openAssetManager" });
    };
    PropertyFileView2.prototype.templateInput = function() {
      var _a2;
      var _b = this, pfx = _b.pfx, em = _b.em;
      var icons = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.getConfig().icons;
      var iconClose = icons === null || icons === void 0 ? void 0 : icons.close;
      return '\n      <div class="'.concat(pfx, "field ").concat(pfx, `file">
        <div id='`).concat(pfx, `input-holder'>
          <div class="`).concat(pfx, 'btn-c">\n            <button class="').concat(pfx, 'btn" id="').concat(pfx, 'images" type="button" data-open-assets>\n              ').concat(em.t("styleManager.fileButton"), '\n            </button>\n          </div>\n          <div style="clear:both;"></div>\n        </div>\n        <div id="').concat(pfx, 'preview-box" class="').concat(pfx, 'preview-file" data-preview-box>\n          <div id="').concat(pfx, 'preview-file" class="').concat(pfx, 'preview-file-cnt" data-preview></div>\n          <div id="').concat(pfx, 'close" class="').concat(pfx, 'preview-file-close" data-clear-asset>').concat(iconClose, "</div>\n        </div>\n      </div>\n    ");
    };
    PropertyFileView2.prototype.__setValueInput = function(value) {
      var _a2 = this, model = _a2.model, el = _a2.el;
      var valueDef = model.getDefaultValue();
      var prvBoxEl = el.querySelector("[data-preview-box]");
      var prvEl = el.querySelector("[data-preview]");
      prvBoxEl.style.display = !value || value === valueDef ? "none" : "";
      prvEl.style.backgroundImage = value || model.getDefaultValue();
    };
    PropertyFileView2.prototype.openAssetManager = function() {
      var _this = this;
      var _a2;
      var am = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.Assets;
      am === null || am === void 0 ? void 0 : am.open({
        select: function(asset, complete) {
          var url = (0, index_all.isString)(asset) ? asset : asset.get("src");
          _this.model.upValue(url, { partial: !complete });
          complete && am.close();
        },
        types: ["image"],
        accept: "image/*"
      });
    };
    return PropertyFileView2;
  }(view_PropertyView)
);
var view_PropertyFileView = PropertyFileView;
var PropertyNumberView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyNumberView = (
  /** @class */
  function(_super) {
    PropertyNumberView_extends(PropertyNumberView2, _super);
    function PropertyNumberView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyNumberView2.prototype.templateInput = function(m) {
      return "";
    };
    PropertyNumberView2.prototype.init = function() {
      var model = this.model;
      this.listenTo(model, "change:unit", this.onValueChange);
      this.listenTo(model, "change:units", this.render);
    };
    PropertyNumberView2.prototype.setValue = function(v) {
    };
    PropertyNumberView2.prototype.onRender = function() {
      var _a2 = this, ppfx = _a2.ppfx, model = _a2.model, el = _a2.el;
      if (!this.inputInst) {
        var input = model.input;
        input.ppfx = ppfx;
        input.render();
        var fields = el.querySelector(".".concat(ppfx, "fields"));
        fields.appendChild(input.el);
        this.input = input.inputEl.get(0);
        this.inputInst = input;
      }
    };
    PropertyNumberView2.prototype.clearCached = function() {
      view_PropertyView.prototype.clearCached.apply(this, arguments);
      this.inputInst = null;
    };
    return PropertyNumberView2;
  }(view_PropertyView)
);
var view_PropertyNumberView = PropertyNumberView;
var PropertyColorView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyColorView = (
  /** @class */
  function(_super) {
    PropertyColorView_extends(PropertyColorView2, _super);
    function PropertyColorView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyColorView2.prototype.setValue = function(value) {
      var _a2;
      (_a2 = this.inputInst) === null || _a2 === void 0 ? void 0 : _a2.setValue(value, {
        fromTarget: 1,
        def: this.model.getDefaultValue()
      });
    };
    PropertyColorView2.prototype.remove = function() {
      var _this = this;
      view_PropertyNumberView.prototype.remove.apply(this, arguments);
      var inp = this.inputInst;
      inp && inp.remove && inp.remove();
      ["inputInst", "$color"].forEach(function(i) {
        return _this[i] = null;
      });
      return this;
    };
    PropertyColorView2.prototype.__handleChange = function(value, partial) {
      this.model.upValue(value, { partial });
    };
    PropertyColorView2.prototype.onRender = function() {
      var _a2;
      if (!this.inputInst) {
        this.__handleChange = this.__handleChange.bind(this);
        var _b = this, ppfx = _b.ppfx, model = _b.model, em = _b.em, el = _b.el;
        var inputColor = new ui_InputColor({
          target: em,
          model,
          ppfx,
          onChange: this.__handleChange
        });
        var input = inputColor.render();
        el.querySelector(".".concat(ppfx, "fields")).appendChild(input.el);
        this.input = (_a2 = input.inputEl) === null || _a2 === void 0 ? void 0 : _a2.get(0);
        this.inputInst = input;
      }
    };
    return PropertyColorView2;
  }(view_PropertyNumberView)
);
var view_PropertyColorView = PropertyColorView;
var PropertySelect_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertySelect_assign = function() {
  PropertySelect_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertySelect_assign.apply(this, arguments);
};
var PropertySelect_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var PropertySelect = (
  /** @class */
  function(_super) {
    PropertySelect_extends(PropertySelect2, _super);
    function PropertySelect2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertySelect2.prototype.defaults = function() {
      return PropertySelect_assign(PropertySelect_assign({}, model_Property.getDefaults()), { options: [], full: 0 });
    };
    PropertySelect2.prototype.getOptions = function() {
      var _a2 = this.attributes, options = _a2.options, list = _a2.list;
      return (options && options.length ? options : list) || [];
    };
    PropertySelect2.prototype.getOption = function(id) {
      var _this = this;
      var idSel = (0, mixins.isDef)(id) ? id : this.getValue();
      return this.getOptions().filter(function(o) {
        return _this.getOptionId(o) === idSel;
      })[0] || null;
    };
    PropertySelect2.prototype.setOptions = function(value) {
      if (value === void 0) {
        value = [];
      }
      this.set("options", value);
      return this;
    };
    PropertySelect2.prototype.addOption = function(value) {
      if (value) {
        var opts = this.getOptions();
        this.setOptions(PropertySelect_spreadArray(PropertySelect_spreadArray([], opts, true), [value], false));
      }
      return this;
    };
    PropertySelect2.prototype.getOptionId = function(option) {
      return (0, mixins.isDef)(option.id) ? option.id : option.value;
    };
    PropertySelect2.prototype.getOptionLabel = function(id, opts) {
      var _a2;
      if (opts === void 0) {
        opts = {};
      }
      var _b = opts.locale, locale = _b === void 0 ? true : _b;
      var option = ((0, index_all.isString)(id) ? this.getOption(id) : id) || {};
      var optId = this.getOptionId(option);
      var label = option.label || option.name || optId;
      var propId = opts.property || this.getId();
      return locale && ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.t("styleManager.options.".concat(propId, ".").concat(optId))) || label;
    };
    PropertySelect2.prototype.initialize = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      model_Property.prototype.initialize.apply(this, args);
      this.listenTo(this, "change:options", this.__onOptionChange);
    };
    PropertySelect2.prototype.__onOptionChange = function() {
      this.set("list", this.get("options"));
    };
    return PropertySelect2;
  }(model_Property)
);
var model_PropertySelect = PropertySelect;
var PropertySelectView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertySelectView = (
  /** @class */
  function(_super) {
    PropertySelectView_extends(PropertySelectView2, _super);
    function PropertySelectView2(o) {
      var _this = _super.call(this, o) || this;
      _this.listenTo(_this.model, "change:options", _this.updateOptions);
      return _this;
    }
    PropertySelectView2.prototype.templateInput = function() {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx;
      return '\n      <div class="'.concat(ppfx, "field ").concat(ppfx, 'select">\n        <span id="').concat(pfx, 'input-holder"></span>\n        <div class="').concat(ppfx, 'sel-arrow">\n          <div class="').concat(ppfx, 'd-s-arrow"></div>\n        </div>\n      </div>\n    ');
    };
    PropertySelectView2.prototype.updateOptions = function() {
      delete this.input;
      this.onRender();
    };
    PropertySelectView2.prototype.onRender = function() {
      var pfx = this.pfx;
      var model = this.model;
      var options = model.getOptions();
      if (!this.input) {
        var optionsRes_1 = [];
        options.forEach(function(option) {
          var id = model.getOptionId(option);
          var name = model.getOptionLabel(id);
          var style = option.style ? option.style.replace(/"/g, "&quot;") : "";
          var styleAttr = style ? 'style="'.concat(style, '"') : "";
          var value = id.replace(/"/g, "&quot;");
          optionsRes_1.push('<option value="'.concat(value, '" ').concat(styleAttr, ">").concat(name, "</option>"));
        });
        var inputH = this.el.querySelector("#".concat(pfx, "input-holder"));
        inputH.innerHTML = "<select>".concat(optionsRes_1.join(""), "</select>");
        this.input = inputH.firstChild;
      }
    };
    PropertySelectView2.prototype.__setValueInput = function(value) {
      var model = this.model;
      var input = this.getInputEl();
      var firstOpt = model.getOptions()[0];
      var firstId = firstOpt ? model.getOptionId(firstOpt) : "";
      input && (input.value = value || firstId);
    };
    return PropertySelectView2;
  }(view_PropertyView)
);
var view_PropertySelectView = PropertySelectView;
var PropertyRadio_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyRadio_assign = function() {
  PropertyRadio_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyRadio_assign.apply(this, arguments);
};
var PropertyRadio = (
  /** @class */
  function(_super) {
    PropertyRadio_extends(PropertyRadio2, _super);
    function PropertyRadio2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyRadio2.prototype.defaults = function() {
      return PropertyRadio_assign(PropertyRadio_assign({}, model_PropertySelect.getDefaults()), { full: 1 });
    };
    return PropertyRadio2;
  }(model_PropertySelect)
);
var model_PropertyRadio = PropertyRadio;
var PropertyRadioView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyRadioView = (
  /** @class */
  function(_super) {
    PropertyRadioView_extends(PropertyRadioView2, _super);
    function PropertyRadioView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyRadioView2.prototype.templateInput = function() {
      var ppfx = this.ppfx;
      return '<div class="'.concat(ppfx, "field ").concat(ppfx, 'field-radio"></div>');
    };
    PropertyRadioView2.prototype.onRender = function() {
      var _a2 = this, pfx = _a2.pfx, ppfx = _a2.ppfx;
      var model = this.model;
      var itemCls = "".concat(ppfx, "radio-item-label");
      var prop = model.getName();
      var options = model.getOptions();
      var clsInput = "".concat(pfx, "radio ").concat(pfx, "radio-").concat(prop);
      var cid = model.cid;
      if (!this.input) {
        var optionsRes_1 = [];
        options.forEach(function(opt) {
          var cls = opt.className ? "".concat(opt.className, " ").concat(pfx, "icon ").concat(itemCls) : "";
          var id = model.getOptionId(opt);
          var elId = "".concat(prop, "-").concat(id, "-").concat(cid);
          var labelEl = cls ? "" : model.getOptionLabel(id);
          var titleAttr = opt.title ? 'title="'.concat(opt.title, '"') : "";
          var checked = model.getValue() === id ? "checked" : "";
          optionsRes_1.push('\n          <div class="'.concat(ppfx, 'radio-item">\n            <input type="radio" class="').concat(clsInput, '" id="').concat(elId, '" name="').concat(prop, "-").concat(cid, '" value="').concat(id, '" ').concat(checked, '/>\n            <label class="').concat(cls || itemCls, '" ').concat(titleAttr, ' for="').concat(elId, '">').concat(labelEl, "</label>\n          </div>\n        "));
        });
        var inputHld = this.el.querySelector(".".concat(ppfx, "field"));
        inputHld.innerHTML = '<div class="'.concat(ppfx, 'radio-items">').concat(optionsRes_1.join(""), "</div>");
        this.input = inputHld.firstChild;
      }
    };
    PropertyRadioView2.prototype.__setValueInput = function(value) {
      var _a2;
      var model = this.model;
      var id = value || model.getDefaultValue();
      var inputIn = (_a2 = this.getInputEl()) === null || _a2 === void 0 ? void 0 : _a2.querySelector('[value="'.concat(id, '"]'));
      inputIn && (inputIn.checked = true);
    };
    return PropertyRadioView2;
  }(view_PropertySelectView)
);
var view_PropertyRadioView = PropertyRadioView;
var PropertyNumber_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertyNumber_assign = function() {
  PropertyNumber_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyNumber_assign.apply(this, arguments);
};
var PropertyNumber = (
  /** @class */
  function(_super) {
    PropertyNumber_extends(PropertyNumber2, _super);
    function PropertyNumber2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertyNumber2.prototype.defaults = function() {
      return PropertyNumber_assign(PropertyNumber_assign({}, model_Property.getDefaults()), { units: [], unit: "", min: "", max: "", step: 1 });
    };
    PropertyNumber2.prototype.getUnits = function() {
      return this.get("units") || [];
    };
    PropertyNumber2.prototype.getUnit = function() {
      return this.get("unit");
    };
    PropertyNumber2.prototype.getMin = function() {
      return this.get("min");
    };
    PropertyNumber2.prototype.getMax = function() {
      return this.get("max");
    };
    PropertyNumber2.prototype.getStep = function() {
      return this.get("step");
    };
    PropertyNumber2.prototype.upUnit = function(unit, opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this._up({ unit }, opts);
    };
    PropertyNumber2.prototype.initialize = function(props, opts) {
      if (props === void 0) {
        props = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      model_Property.callParentInit(model_Property, this, props, opts);
      var unit = this.get("unit");
      var units = this.getUnits();
      this.input = (0, mixins.hasWin)() ? new ui_InputNumber({ model: this }) : void 0;
      if (units.length && !unit) {
        this.set("unit", units[0], { silent: true });
      }
      model_Property.callInit(this, props, opts);
    };
    PropertyNumber2.prototype.__getClearProps = function() {
      return PropertyNumber_assign(PropertyNumber_assign({}, model_Property.prototype.__getClearProps()), { unit: "" });
    };
    PropertyNumber2.prototype.parseValue = function(val, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var parsed = model_Property.prototype.parseValue.apply(this, arguments);
      var _a2 = this.input.validateInputValue(parsed.value, PropertyNumber_assign({ deepCheck: 1 }, opts)), value = _a2.value, unit = _a2.unit;
      parsed.value = value;
      parsed.unit = unit;
      return parsed;
    };
    PropertyNumber2.prototype.getFullValue = function() {
      var valueProp = this.get("value");
      var unitProp = this.get("unit");
      var value = !(0, index_all.isUndefined)(valueProp) ? "".concat(valueProp) : "";
      var unit = !(0, index_all.isUndefined)(unitProp) && value ? unitProp : "";
      var result = "".concat(value).concat(unit);
      return model_Property.prototype.getFullValue.apply(this, [result]);
    };
    return PropertyNumber2;
  }(model_Property)
);
var model_PropertyNumber = PropertyNumber;
var PropertySlider_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertySlider_assign = function() {
  PropertySlider_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertySlider_assign.apply(this, arguments);
};
var PropertySlider = (
  /** @class */
  function(_super) {
    PropertySlider_extends(PropertySlider2, _super);
    function PropertySlider2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertySlider2.prototype.defaults = function() {
      return PropertySlider_assign(PropertySlider_assign({}, model_PropertyNumber.getDefaults()), { showInput: 1 });
    };
    return PropertySlider2;
  }(model_PropertyNumber)
);
var model_PropertySlider = PropertySlider;
var PropertySliderView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var PropertySliderView_assign = function() {
  PropertySliderView_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertySliderView_assign.apply(this, arguments);
};
var PropertySliderView = (
  /** @class */
  function(_super) {
    PropertySliderView_extends(PropertySliderView2, _super);
    function PropertySliderView2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    PropertySliderView2.prototype.events = function() {
      return PropertySliderView_assign(PropertySliderView_assign({}, view_PropertyNumberView.prototype.events()), { "change [type=range]": "inputValueChanged", "input [type=range]": "inputValueChangedSoft", change: "" });
    };
    PropertySliderView2.prototype.templateInput = function(model) {
      var ppfx = this.ppfx;
      return '\n      <div class="'.concat(ppfx, "field ").concat(ppfx, 'field-range">\n        <input type="range" min="').concat(model.get("min"), '" max="').concat(model.get("max"), '" step="').concat(model.get("step"), '"/>\n      </div>\n    ');
    };
    PropertySliderView2.prototype.getSliderEl = function() {
      if (!this.slider) {
        this.slider = this.el.querySelector("input[type=range]");
      }
      return this.slider;
    };
    PropertySliderView2.prototype.inputValueChanged = function(ev) {
      ev.stopPropagation();
      this.model.upValue(this.getSliderEl().value);
    };
    PropertySliderView2.prototype.inputValueChangedSoft = function(ev) {
      ev.stopPropagation();
      this.model.upValue(this.getSliderEl().value, { partial: true });
    };
    PropertySliderView2.prototype.setValue = function(value) {
      var model = this.model;
      var parsed = model.parseValue(value);
      this.getSliderEl().value = value === "" ? model.getDefaultValue() : parseFloat(parsed.value);
      view_PropertyNumberView.prototype.setValue.apply(this, arguments);
    };
    PropertySliderView2.prototype.onRender = function() {
      view_PropertyNumberView.prototype.onRender.apply(this, arguments);
      if (!this.model.get("showInput")) {
        this.inputInst.el.style.display = "none";
      }
    };
    PropertySliderView2.prototype.clearCached = function() {
      view_PropertyNumberView.prototype.clearCached.apply(this, arguments);
      delete this.slider;
    };
    return PropertySliderView2;
  }(view_PropertyNumberView)
);
var view_PropertySliderView = PropertySliderView;
var Properties_TypeableCollectionExt = common.pM.extend(model_TypeableCollection);
var Properties = Properties_TypeableCollectionExt.extend({
  extendViewApi: 1,
  init: function() {
    var _a2 = this, opts = _a2.opts, em = _a2.em;
    var sm = opts.module || (em === null || em === void 0 ? void 0 : em.get("StyleManager"));
    if (sm) {
      sm.__listenAdd(this, sm.events.propertyAdd);
      sm.__listenRemove(this, sm.events.propertyRemove);
    }
  },
  types: [
    {
      id: "stack",
      model: model_PropertyStack,
      view: view_PropertyStackView,
      isType: function(value) {
        if (value && value.type == "stack") {
          return value;
        }
      }
    },
    {
      id: "composite",
      model: model_PropertyComposite,
      view: view_PropertyCompositeView,
      isType: function(value) {
        if (value && value.type == "composite") {
          return value;
        }
      }
    },
    {
      id: "file",
      model: model_Property,
      view: view_PropertyFileView,
      isType: function(value) {
        if (value && value.type == "file") {
          return value;
        }
      }
    },
    {
      id: "color",
      model: model_Property,
      view: view_PropertyColorView,
      isType: function(value) {
        if (value && value.type == "color") {
          return value;
        }
      }
    },
    {
      id: "select",
      model: model_PropertySelect,
      view: view_PropertySelectView,
      isType: function(value) {
        if (value && value.type == "select") {
          return value;
        }
      }
    },
    {
      id: "radio",
      model: model_PropertyRadio,
      view: view_PropertyRadioView,
      isType: function(value) {
        if (value && value.type == "radio") {
          return value;
        }
      }
    },
    {
      id: "slider",
      model: model_PropertySlider,
      view: view_PropertySliderView,
      isType: function(value) {
        if (value && value.type == "slider") {
          return value;
        }
      }
    },
    {
      id: "integer",
      model: model_PropertyNumber,
      view: view_PropertyNumberView,
      isType: function(value) {
        if (value && value.type == "integer") {
          return value;
        }
      }
    },
    {
      id: "number",
      model: model_PropertyNumber,
      view: view_PropertyNumberView,
      isType: function(value) {
        if (value && value.type == "number") {
          return value;
        }
      }
    },
    {
      id: "base",
      model: model_Property,
      view: view_PropertyView,
      isType: function(value) {
        value.type = "base";
        return value;
      }
    }
  ]
});
var model_Properties = Properties;
var Sector_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Sector_assign = function() {
  Sector_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Sector_assign.apply(this, arguments);
};
var Sector_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var Sector_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var Sector = (
  /** @class */
  function(_super) {
    Sector_extends(Sector2, _super);
    function Sector2(prp, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _this = _super.call(this, prp) || this;
      var em = opts.em;
      _this.em = em;
      var o = prp || {};
      var builded = _this.buildProperties(o.buildProps);
      var name = _this.get("name") || "";
      var props = [];
      !_this.get("id") && _this.set("id", name.replace(/ /g, "_").toLowerCase());
      if (!builded) {
        props = _this.get("properties").map(function(prop) {
          return (0, index_all.isString)(prop) ? _this.buildProperties(prop)[0] : prop;
        }).filter(Boolean);
      } else {
        props = _this.extendProperties(builded);
      }
      props = props.map(function(prop) {
        return _this.checkExtend(prop);
      });
      var propsModel = new model_Properties(props, { em });
      propsModel.sector = _this;
      _this.set("properties", propsModel);
      return _this;
    }
    Sector2.prototype.defaults = function() {
      return {
        id: "",
        name: "",
        open: true,
        visible: true,
        extendBuilded: true,
        properties: []
      };
    };
    Object.defineProperty(Sector2.prototype, "properties", {
      get: function() {
        return this.get("properties");
      },
      enumerable: false,
      configurable: true
    });
    Sector2.prototype.getId = function() {
      return this.get("id");
    };
    Sector2.prototype.getName = function() {
      var _a2;
      var id = this.getId();
      return ((_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.t("styleManager.sectors.".concat(id))) || this.get("name");
    };
    Sector2.prototype.setName = function(value) {
      return this.set("name", value);
    };
    Sector2.prototype.isOpen = function() {
      return !!this.get("open");
    };
    Sector2.prototype.setOpen = function(value) {
      return this.set("open", value);
    };
    Sector2.prototype.isVisible = function() {
      return !!this.get("visible");
    };
    Sector2.prototype.getProperties = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var props = this.properties;
      var res = props.models ? Sector_spreadArray([], props.models, true) : props;
      return res.filter(function(prop) {
        var result = true;
        if (opts.withValue) {
          result = prop.hasValue({ noParent: true });
        }
        if (opts.withParentValue) {
          var hasVal = prop.hasValue({ noParent: true });
          result = !hasVal && prop.hasValue();
        }
        return result;
      });
    };
    Sector2.prototype.getProperty = function(id) {
      return this.getProperties().filter(function(prop) {
        return prop.get("id") === id;
      })[0] || void 0;
    };
    Sector2.prototype.addProperty = function(property, opts) {
      return this.properties.add(this.checkExtend(property), opts);
    };
    Sector2.prototype.extendProperties = function(props, moProps, ex) {
      if (ex === void 0) {
        ex = false;
      }
      var pLen = props.length;
      var mProps = moProps || this.get("properties");
      var ext = this.get("extendBuilded");
      var isolated = [];
      for (var i = 0, len = mProps.length; i < len; i++) {
        var mProp = mProps[i];
        var found = 0;
        for (var j = 0; j < pLen; j++) {
          var prop = props[j];
          if (mProp.property == prop.property || mProp.id == prop.property) {
            var mPProps = mProp.properties;
            if (mPProps && mPProps.length) {
              mProp.properties = this.extendProperties(prop.properties || [], mPProps, 1);
            }
            props[j] = ext ? (0, index_all.extend)(prop, mProp) : mProp;
            isolated[j] = props[j];
            found = 1;
            continue;
          }
        }
        if (!found) {
          props.push(mProp);
          isolated.push(mProp);
        }
      }
      return ex ? isolated.filter(function(i2) {
        return i2;
      }) : props;
    };
    Sector2.prototype.checkExtend = function(prop) {
      var _a2 = ((0, index_all.isString)(prop) ? { extend: prop } : prop) || {}, extend = _a2.extend, rest = Sector_rest(_a2, ["extend"]);
      if (extend) {
        return Sector_assign(Sector_assign({}, this.buildProperties([extend])[0] || {}), rest);
      } else {
        return prop;
      }
    };
    Sector2.prototype.buildProperties = function(props) {
      var _a2;
      var buildP = props || [];
      if (!buildP.length)
        return [];
      var builtIn = (_a2 = this.em) === null || _a2 === void 0 ? void 0 : _a2.Styles.builtIn;
      return builtIn === null || builtIn === void 0 ? void 0 : builtIn.build(buildP);
    };
    return Sector2;
  }(common.Kx)
);
var model_Sector = Sector;
var Sectors_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Sectors_assign = function() {
  Sectors_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Sectors_assign.apply(this, arguments);
};
var Sectors = (
  /** @class */
  function(_super) {
    Sectors_extends(Sectors2, _super);
    function Sectors2() {
      return _super !== null && _super.apply(this, arguments) || this;
    }
    Sectors2.prototype.initialize = function(prop, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var module = opts.module, em = opts.em;
      this.em = em;
      this.module = module;
      this.listenTo(this, "reset", this.onReset);
    };
    Sectors2.prototype.model = function(props, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = opts.collection.em;
      return new model_Sector(props, Sectors_assign(Sectors_assign({}, opts), { em }));
    };
    Sectors2.prototype.onReset = function(models, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var prev = opts.previousModels || [];
      prev.forEach(function(sect) {
        return sect.get("properties").reset();
      });
    };
    return Sectors2;
  }(common.pM)
);
var model_Sectors = Sectors;
var PropertyFactory_assign = function() {
  PropertyFactory_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return PropertyFactory_assign.apply(this, arguments);
};
var PropertyFactory_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var PropertyFactory_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var getOptions = function(items) {
  return items.map(function(item) {
    return { id: item };
  });
};
var PropertyFactory = (
  /** @class */
  function() {
    function PropertyFactory2() {
      this.props = {};
      this.typeNumber = "number";
      this.typeColor = "color";
      this.typeRadio = "radio";
      this.typeSelect = "select";
      this.typeFile = "file";
      this.typeSlider = "slider";
      this.typeComposite = "composite";
      this.typeStack = "stack";
      this.unitsSize = ["px", "%", "em", "rem", "vh", "vw"];
      this.unitsSizeNoPerc = ["px", "em", "rem", "vh", "vw"];
      this.unitsTime = ["s", "ms"];
      this.unitsAngle = ["deg", "rad", "grad"];
      this.fixedValues = ["initial", "inherit", "auto"];
      var ss = ", sans-serif";
      var optsFlex = ["flex-start", "flex-end", "center"];
      var optsFlexAlign = PropertyFactory_spreadArray(PropertyFactory_spreadArray([], optsFlex, true), ["baseline", "stretch"], false);
      this.optsBgSize = getOptions(["auto", "cover", "contain"]);
      this.optsBgAttach = getOptions(["scroll", "fixed", "local"]);
      this.optsBgRepeat = getOptions(["repeat", "repeat-x", "repeat-y", "no-repeat"]);
      this.optsWrap = getOptions(["nowrap", "wrap", "wrap-reverse"]);
      this.optsOverflow = getOptions(["visible", "hidden", "scroll", "auto"]);
      this.optsDir = getOptions(["row", "row-reverse", "column", "column-reverse"]);
      this.opstDisplay = getOptions(["block", "inline", "inline-block", "flex", "none"]);
      this.optsTransitFn = getOptions(["linear", "ease", "ease-in", "ease-out", "ease-in-out"]);
      this.optsCursor = getOptions(["auto", "pointer", "copy", "crosshair", "grab", "grabbing", "help", "move", "text"]);
      this.optsFloat = getOptions(["none", "left", "right"]);
      this.optsPos = getOptions(["static", "relative", "absolute", "fixed"]);
      this.optsTextAlign = getOptions(["left", "center", "right", "justify"]);
      this.optsFlexAlign = getOptions(optsFlexAlign);
      this.optsJustCont = getOptions(PropertyFactory_spreadArray(PropertyFactory_spreadArray([], optsFlex, true), ["space-between", "space-around", "space-evenly"], false));
      this.optsAlignCont = getOptions(PropertyFactory_spreadArray(PropertyFactory_spreadArray([], optsFlex, true), ["space-between", "space-around", "stretch"], false));
      this.optsAlignSelf = getOptions(PropertyFactory_spreadArray(["auto"], optsFlexAlign, true));
      this.optsTransitProp = getOptions([
        "all",
        "width",
        "height",
        "background-color",
        "transform",
        "box-shadow",
        "opacity"
      ]);
      this.optsBorderStyle = getOptions([
        "none",
        "solid",
        "dotted",
        "dashed",
        "double",
        "groove",
        "ridge",
        "inset",
        "outset"
      ]);
      this.optsBgPos = getOptions([
        "left top",
        "left center",
        "left bottom",
        "right top",
        "right center",
        "right bottom",
        "center top",
        "center center",
        "center bottom"
      ]);
      this.optsWeight = [
        { id: "100", label: "Thin" },
        { id: "200", label: "Extra-Light" },
        { id: "300", label: "Light" },
        { id: "400", label: "Normal" },
        { id: "500", label: "Medium" },
        { id: "600", label: "Semi-Bold" },
        { id: "700", label: "Bold" },
        { id: "800", label: "Extra-Bold" },
        { id: "900", label: "Ultra-Bold" }
      ];
      this.optsShadowType = [
        { id: "", label: "Outside" },
        { id: "inset", label: "Inside" }
      ];
      this.optsFonts = [
        "Arial, Helvetica" + ss,
        "Arial Black, Gadget" + ss,
        "Brush Script MT" + ss,
        "Comic Sans MS, cursive" + ss,
        "Courier New, Courier, monospace",
        "Georgia, serif",
        "Helvetica" + ss,
        "Impact, Charcoal" + ss,
        "Lucida Sans Unicode, Lucida Grande" + ss,
        "Tahoma, Geneva" + ss,
        "Times New Roman, Times, serif",
        "Trebuchet MS, Helvetica" + ss,
        "Verdana, Geneva" + ss
      ].map(function(font) {
        return { id: font, label: font.split(",")[0] };
      });
      this.fixedFontSizes = [
        "medium",
        "xx-small",
        "x-small",
        "small",
        "large",
        "x-large",
        "xx-large",
        "smaller",
        "larger",
        "length",
        "initial",
        "inherit"
      ];
      this.fixedLetSpace = ["normal", "initial", "inherit"];
      this.requireFlex = { display: ["flex"] };
      this.init();
    }
    PropertyFactory2.prototype.__sub = function(items) {
      var _this = this;
      return function() {
        return items.map(function(p) {
          if ((0, index_all.isString)(p))
            return _this.get(p);
          var extend = p.extend, rest = PropertyFactory_rest(p, ["extend"]);
          return PropertyFactory_assign(PropertyFactory_assign({}, _this.get(extend)), rest);
        });
      };
    };
    PropertyFactory2.prototype.init = function() {
      var _this = this;
      var _a2 = this, fixedValues = _a2.fixedValues, requireFlex = _a2.requireFlex, typeNumber = _a2.typeNumber;
      this.props = {};
      var propsToCreate = [
        // Number types
        ["text-shadow-h", { type: typeNumber, default: "0", units: this.unitsSizeNoPerc }],
        ["top", { default: "auto", units: this.unitsSize, fixedValues }, "text-shadow-h"],
        ["right", {}, "top"],
        ["bottom", {}, "top"],
        ["left", {}, "top"],
        ["margin-top", { default: "0" }, "top"],
        ["margin-right", {}, "margin-top"],
        ["margin-bottom", {}, "margin-top"],
        ["margin-left", {}, "margin-top"],
        ["padding-top", { min: 0 }, "margin-top"],
        ["padding-right", {}, "padding-top"],
        ["padding-bottom", {}, "padding-top"],
        ["padding-left", {}, "padding-top"],
        ["width", { min: 0 }, "top"],
        ["min-width", {}, "width"],
        ["max-width", {}, "width"],
        ["height", {}, "width"],
        ["min-height", {}, "width"],
        ["max-height", {}, "width"],
        ["flex-basis", { requiresParent: requireFlex }, "width"],
        ["font-size", { default: "medium", fixedValues: this.fixedFontSizes }, "width"],
        ["letter-spacing", { default: "normal", fixedValues: this.fixedLetSpace }, "top"],
        ["line-height", {}, "letter-spacing"],
        ["text-shadow-v", {}, "text-shadow-h"],
        ["text-shadow-blur", { min: 0 }, "text-shadow-h"],
        ["border-radius-c", { property: "border-radius", fixedValues: void 0 }, "padding-top"],
        ["border-top-left-radius", {}, "border-radius-c"],
        ["border-top-right-radius", {}, "border-radius-c"],
        ["border-bottom-left-radius", {}, "border-radius-c"],
        ["border-bottom-right-radius", {}, "border-radius-c"],
        ["border-width", { units: this.unitsSizeNoPerc }, "border-radius-c"],
        ["box-shadow-h", {}, "text-shadow-h"],
        ["box-shadow-v", {}, "text-shadow-h"],
        ["box-shadow-blur", { default: "5px" }, "text-shadow-blur"],
        ["box-shadow-spread", {}, "text-shadow-h"],
        ["transition-duration", { default: "2s", units: this.unitsTime }, "border-radius-c"],
        ["perspective", {}, "border-radius-c"],
        ["order", { type: typeNumber, default: "0", requiresParent: requireFlex }],
        ["flex-grow", {}, "order"],
        ["flex-shrink", { default: "1" }, "order"],
        // Radio types
        ["float", { type: this.typeRadio, default: "none", options: this.optsFloat }],
        ["position", { default: "static", options: this.optsPos }, "float"],
        ["text-align", { default: "left", options: this.optsTextAlign }, "float"],
        // Color types
        ["color", { type: this.typeColor, default: "black", full: true }],
        ["text-shadow-color", {}, "color"],
        ["border-color", {}, "color"],
        ["box-shadow-color", {}, "color"],
        ["background-color", { default: "none" }, "color"],
        // File type
        [
          "background-image",
          {
            type: this.typeFile,
            functionName: "url",
            default: "none",
            full: true
          }
        ],
        // Slider type
        ["opacity", { type: this.typeSlider, default: "1", min: 0, max: 1, step: 0.01, full: true }],
        // Select types
        ["display", { type: this.typeSelect, default: "block", options: this.opstDisplay }],
        ["flex-direction", { default: "row", options: this.optsDir, requires: requireFlex }, "display"],
        ["flex-wrap", { default: "nowrap", options: this.optsWrap }, "flex-direction"],
        ["justify-content", { default: "flex-start", options: this.optsJustCont }, "flex-wrap"],
        ["align-items", { default: "stretch", options: this.optsFlexAlign }, "flex-wrap"],
        ["align-content", { options: this.optsAlignCont }, "align-items"],
        [
          "align-self",
          {
            default: "auto",
            options: this.optsAlignSelf,
            requiresParent: requireFlex
          },
          "display"
        ],
        ["font-family", { default: "Arial, Helvetica, sans-serif", options: this.optsFonts }, "display"],
        ["font-weight", { default: "400", options: this.optsWeight }, "display"],
        ["border-style", { default: "solid", options: this.optsBorderStyle }, "display"],
        ["box-shadow-type", { default: "", options: this.optsShadowType }, "display"],
        ["background-repeat", { default: "repeat", options: this.optsBgRepeat }, "display"],
        ["background-position", { default: "left top", options: this.optsBgPos }, "display"],
        ["background-attachment", { default: "scroll", options: this.optsBgAttach }, "display"],
        ["background-size", { default: "auto", options: this.optsBgSize }, "display"],
        ["transition-property", { default: "width", options: this.optsTransitProp }, "display"],
        ["transition-timing-function", { default: "ease", options: this.optsTransitFn }, "display"],
        ["cursor", { default: "auto", options: this.optsCursor }, "display"],
        ["overflow", { default: "visible", options: this.optsOverflow }, "display"],
        ["overflow-x", {}, "overflow"],
        ["overflow-y", {}, "overflow"],
        // Composite types
        [
          "margin",
          {
            type: this.typeComposite,
            properties: this.__sub([
              { extend: "margin-top", id: "margin-top-sub" },
              { extend: "margin-right", id: "margin-right-sub" },
              { extend: "margin-bottom", id: "margin-bottom-sub" },
              { extend: "margin-left", id: "margin-left-sub" }
            ])
          }
        ],
        [
          "padding",
          {
            properties: this.__sub([
              { extend: "padding-top", id: "padding-top-sub" },
              { extend: "padding-right", id: "padding-right-sub" },
              { extend: "padding-bottom", id: "padding-bottom-sub" },
              { extend: "padding-left", id: "padding-left-sub" }
            ])
          },
          "margin"
        ],
        [
          "border",
          {
            properties: this.__sub([
              { extend: "border-width", id: "border-width-sub" },
              { extend: "border-style", id: "border-style-sub" },
              { extend: "border-color", id: "border-color-sub" }
            ])
          },
          "margin"
        ],
        [
          "border-radius",
          {
            properties: this.__sub([
              {
                extend: "border-top-left-radius",
                id: "border-top-left-radius-sub"
              },
              {
                extend: "border-top-right-radius",
                id: "border-top-right-radius-sub"
              },
              {
                extend: "border-bottom-right-radius",
                id: "border-bottom-right-radius-sub"
              },
              {
                extend: "border-bottom-left-radius",
                id: "border-bottom-left-radius-sub"
              }
            ])
          },
          "margin"
        ],
        // Stack types
        [
          "transition",
          {
            type: this.typeStack,
            properties: this.__sub([
              { extend: "transition-property", id: "transition-property-sub" },
              { extend: "transition-duration", id: "transition-duration-sub" },
              {
                extend: "transition-timing-function",
                id: "transition-timing-function-sub"
              }
            ])
          }
        ],
        [
          "box-shadow",
          {
            preview: true,
            layerLabel: function(l, _a3) {
              var values = _a3.values;
              var x = values["box-shadow-h"];
              var y = values["box-shadow-v"];
              var blur = values["box-shadow-blur"];
              var spread = values["box-shadow-spread"];
              return "".concat(x, " ").concat(y, " ").concat(blur, " ").concat(spread);
            },
            properties: this.__sub([
              "box-shadow-h",
              "box-shadow-v",
              "box-shadow-blur",
              "box-shadow-spread",
              "box-shadow-color",
              "box-shadow-type"
            ])
          },
          "transition"
        ],
        [
          "text-shadow",
          {
            default: "none",
            layerLabel: function(l, _a3) {
              var values = _a3.values;
              var x = values["text-shadow-h"];
              var y = values["text-shadow-v"];
              var blur = values["text-shadow-blur"];
              return "".concat(x, " ").concat(y, " ").concat(blur);
            },
            properties: this.__sub(["text-shadow-h", "text-shadow-v", "text-shadow-blur", "text-shadow-color"])
          },
          "box-shadow"
        ],
        [
          "background",
          {
            detached: true,
            layerLabel: function(l, _a3) {
              var values = _a3.values;
              var repeat = values["background-repeat-sub"] || "";
              var pos = values["background-position-sub"] || "";
              var att = values["background-attachment-sub"] || "";
              var size = values["background-size-sub"] || "";
              return [repeat, pos, att, size].join(" ");
            },
            properties: this.__sub([
              { extend: "background-image", id: "background-image-sub" },
              { extend: "background-repeat", id: "background-repeat-sub" },
              { extend: "background-position", id: "background-position-sub" },
              {
                extend: "background-attachment",
                id: "background-attachment-sub"
              },
              { extend: "background-size", id: "background-size-sub" }
            ])
          },
          "box-shadow"
        ],
        [
          "transform",
          {
            type: "stack",
            layerSeparator: " ",
            fromStyle: function(style, _a3) {
              var property = _a3.property, name = _a3.name;
              var filter2 = style[name] || "";
              var sep = property.getLayerSeparator();
              return filter2 ? filter2.split(sep).map(function(input) {
                var _a4 = property.__parseFn(input), name2 = _a4.name, value = _a4.value;
                return {
                  "transform-type": name2,
                  "transform-value": value
                };
              }) : [];
            },
            toStyle: function(values, _a3) {
              var _b;
              var name = _a3.name;
              return _b = {}, _b[name] = "".concat(values["transform-type"], "(").concat(values["transform-value"], ")"), _b;
            },
            properties: [
              {
                property: "transform-type",
                name: "Type",
                type: this.typeSelect,
                default: "rotateZ",
                full: true,
                options: [
                  { id: "scaleX", propValue: { units: [""], step: 0.01 } },
                  { id: "scaleY", propValue: { units: [""], step: 0.01 } },
                  { id: "scaleZ", propValue: { units: [""], step: 0.01 } },
                  {
                    id: "rotateX",
                    propValue: { units: this.unitsAngle, step: 1 }
                  },
                  {
                    id: "rotateY",
                    propValue: { units: this.unitsAngle, step: 1 }
                  },
                  {
                    id: "rotateZ",
                    propValue: { units: this.unitsAngle, step: 1 }
                  },
                  {
                    id: "translateX",
                    propValue: { units: this.unitsSize, step: 1 }
                  },
                  {
                    id: "translateY",
                    propValue: { units: this.unitsSize, step: 1 }
                  }
                ],
                onChange: function(_a3) {
                  var property = _a3.property, to = _a3.to;
                  if (to.value) {
                    var option = property.getOption();
                    var props = PropertyFactory_assign({}, option.propValue || {});
                    var propToUp = property.getParent().getProperty("transform-value");
                    var unit = propToUp.getUnit();
                    if (!unit || (props === null || props === void 0 ? void 0 : props.units.indexOf(unit)) < 0) {
                      props.unit = (props === null || props === void 0 ? void 0 : props.units[0]) || "";
                    }
                    propToUp.up(props);
                  }
                }
              },
              {
                property: "transform-value",
                type: this.typeNumber,
                default: "0",
                full: true
              }
            ]
          }
        ]
      ];
      propsToCreate.forEach(function(_a3) {
        var prop = _a3[0], def = _a3[1], from = _a3[2];
        _this.add(prop, def || {}, { from });
      });
      return this;
    };
    PropertyFactory2.prototype.add = function(property, def, opts) {
      if (def === void 0) {
        def = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var from = opts.from || "";
      var fromRes = this.props[from || property] || {};
      var result = PropertyFactory_assign(PropertyFactory_assign(PropertyFactory_assign({}, fromRes), { property }), def);
      if (result.properties && (0, index_all.isFunction)(result.properties)) {
        result.properties = result.properties();
      }
      this.props[property] = result;
      return result;
    };
    PropertyFactory2.prototype.get = function(prop) {
      return this.props[prop];
    };
    PropertyFactory2.prototype.build = function(props) {
      var _this = this;
      var result = [];
      var propsArr = (0, index_all.isString)(props) ? [props] : props;
      propsArr.forEach(function(prop) {
        result.push(_this.get(prop) || { property: prop });
      });
      return result;
    };
    return PropertyFactory2;
  }()
);
var model_PropertyFactory = PropertyFactory;
var SectorView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var SectorView_makeTemplateObject = function(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", { value: raw });
  } else {
    cooked.raw = raw;
  }
  return cooked;
};
var SectorView = (
  /** @class */
  function(_super) {
    SectorView_extends(SectorView2, _super);
    function SectorView2(o) {
      var _this = _super.call(this, o) || this;
      var config2 = o.config || {};
      var model = _this.model;
      var em = config2.em;
      _this.config = config2;
      _this.em = em;
      _this.pfx = config2.stylePrefix || "";
      _this.listenTo(model, "destroy remove", _this.remove);
      _this.listenTo(model, "change:open", _this.updateOpen);
      _this.listenTo(model, "change:visible", _this.updateVisibility);
      return _this;
    }
    SectorView2.prototype.template = function(_a2) {
      var _b;
      var pfx = _a2.pfx, label = _a2.label;
      var icons = (_b = this.em) === null || _b === void 0 ? void 0 : _b.getConfig().icons;
      var iconCaret = (icons === null || icons === void 0 ? void 0 : icons.caret) || "";
      var clsPfx = "".concat(pfx, "sector-");
      return html(SectorView_templateObject_1 || (SectorView_templateObject_1 = SectorView_makeTemplateObject(['\n      <div class="', 'title" data-sector-title>\n        <div class="', 'caret">$', '</div>\n        <div class="', 'label">', "</div>\n      </div>\n    "], ['\n      <div class="', 'title" data-sector-title>\n        <div class="', 'caret">$', '</div>\n        <div class="', 'label">', "</div>\n      </div>\n    "])), clsPfx, clsPfx, iconCaret, clsPfx, label);
    };
    SectorView2.prototype.events = function() {
      return {
        "click [data-sector-title]": "toggle"
      };
    };
    SectorView2.prototype.updateOpen = function() {
      var _a2 = this, $el = _a2.$el, model = _a2.model, pfx = _a2.pfx;
      var isOpen = model.isOpen();
      $el[isOpen ? "addClass" : "removeClass"]("".concat(pfx, "open"));
      this.getPropertiesEl().style.display = isOpen ? "" : "none";
    };
    SectorView2.prototype.updateVisibility = function() {
      this.el.style.display = this.model.isVisible() ? "" : "none";
    };
    SectorView2.prototype.getPropertiesEl = function() {
      var _a2 = this, $el = _a2.$el, pfx = _a2.pfx;
      return $el.find(".".concat(pfx, "properties")).get(0);
    };
    SectorView2.prototype.toggle = function() {
      var model = this.model;
      model.setOpen(!model.get("open"));
    };
    SectorView2.prototype.renderProperties = function() {
      var _a2 = this, model = _a2.model, config2 = _a2.config;
      var objs = model.get("properties");
      if (objs) {
        var view = new view_PropertiesView({ collection: objs, config: config2 });
        this.$el.append(view.render().el);
      }
    };
    SectorView2.prototype.render = function() {
      var _a2 = this, pfx = _a2.pfx, model = _a2.model, $el = _a2.$el;
      var id = model.getId();
      var label = model.getName();
      $el.html(this.template({ pfx, label }));
      this.renderProperties();
      $el.attr("class", "".concat(pfx, "sector ").concat(pfx, "sector__").concat(id, " no-select"));
      this.updateOpen();
      return this;
    };
    return SectorView2;
  }(common.Ss)
);
var view_SectorView = SectorView;
var SectorView_templateObject_1;
var SectorsView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var SectorsView = (
  /** @class */
  function(_super) {
    SectorsView_extends(SectorsView2, _super);
    function SectorsView2(o) {
      if (o === void 0) {
        o = {};
      }
      var _this = _super.call(this, o) || this;
      var module = o.module, config2 = o.config;
      var coll = _this.collection;
      _this.pfx = (config2 === null || config2 === void 0 ? void 0 : config2.stylePrefix) || "";
      _this.ppfx = (config2 === null || config2 === void 0 ? void 0 : config2.pStylePrefix) || "";
      _this.config = config2;
      _this.module = module;
      _this.listenTo(coll, "add", _this.addTo);
      _this.listenTo(coll, "reset", _this.render);
      return _this;
    }
    SectorsView2.prototype.remove = function() {
      var _this = this;
      common.Ss.prototype.remove.apply(this, arguments);
      ["config", "module", "em"].forEach(function(i) {
        return _this[i] = {};
      });
      return this;
    };
    SectorsView2.prototype.addTo = function(model, c, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.addToCollection(model, null, opts);
    };
    SectorsView2.prototype.addToCollection = function(model, fragmentEl, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var _a2 = this, config2 = _a2.config, el = _a2.el;
      var appendTo = fragmentEl || el;
      var rendered = new view_SectorView({ model, config: config2 }).render().el;
      (0, dom.Sc)(appendTo, rendered, opts.at);
      return rendered;
    };
    SectorsView2.prototype.render = function() {
      var _this = this;
      var _a2 = this, $el = _a2.$el, pfx = _a2.pfx, ppfx = _a2.ppfx;
      $el.empty();
      var frag = document.createDocumentFragment();
      this.collection.each(function(model) {
        return _this.addToCollection(model, frag);
      });
      $el.append(frag);
      $el.addClass("".concat(pfx, "sectors ").concat(ppfx, "one-bg ").concat(ppfx, "two-color"));
      return this;
    };
    return SectorsView2;
  }(common.Ss)
);
var view_SectorsView = SectorsView;
var style_manager_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var style_manager_assign = function() {
  style_manager_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return style_manager_assign.apply(this, arguments);
};
var style_manager_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var style_manager_evAll = "style";
var style_manager_evPfx = "".concat(style_manager_evAll, ":");
var evSector = "".concat(style_manager_evPfx, "sector");
var evSectorAdd = "".concat(evSector, ":add");
var evSectorRemove = "".concat(evSector, ":remove");
var evSectorUpdate = "".concat(evSector, ":update");
var evProp = "".concat(style_manager_evPfx, "property");
var evPropAdd = "".concat(evProp, ":add");
var evPropRemove = "".concat(evProp, ":remove");
var evPropUp = "".concat(evProp, ":update");
var evLayerSelect = "".concat(style_manager_evPfx, "layer:select");
var evTarget = "".concat(style_manager_evPfx, "target");
var style_manager_evCustom = "".concat(style_manager_evPfx, "custom");
var propDef = function(value) {
  return value || value === 0;
};
var stylesEvents = {
  all: style_manager_evAll,
  sectorAdd: evSectorAdd,
  sectorRemove: evSectorRemove,
  sectorUpdate: evSectorUpdate,
  propertyAdd: evPropAdd,
  propertyRemove: evPropRemove,
  propertyUpdate: evPropUp,
  layerSelect: evLayerSelect,
  target: evTarget,
  custom: style_manager_evCustom
};
var StyleManager = (
  /** @class */
  function(_super) {
    style_manager_extends(StyleManager2, _super);
    function StyleManager2(em) {
      var _this = _super.call(this, em, "StyleManager", new model_Sectors([], { em }), stylesEvents, style_manager_config_config) || this;
      _this.Sector = model_Sector;
      _this.storageKey = "";
      (0, index_all.bindAll)(_this, "__clearStateTarget");
      var c = _this.config;
      var ppfx = c.pStylePrefix;
      if (ppfx)
        c.stylePrefix = ppfx + c.stylePrefix;
      _this.builtIn = new model_PropertyFactory();
      _this.properties = new model_Properties([], { em, module: _this });
      _this.sectors = _this.all;
      var model = new common.Kx({ targets: [] });
      _this.model = model;
      var eventCmpUpdate = dom_components_types.I.update;
      var ev = "component:toggled ".concat(eventCmpUpdate, ":classes change:state change:device frame:resized selector:type");
      _this.upAll = (0, index_all.debounce)(function() {
        return _this.__upSel();
      }, 0);
      model.listenTo(em, ev, _this.upAll);
      model.listenTo(em, "component:toggled", _this.__clearStateTarget);
      var upProps = (0, index_all.debounce)(function() {
        _this.__upProps();
        _this.__trgCustom();
      }, 0);
      model.listenTo(em, "styleable:change undo redo", upProps);
      var trgCustom = (0, index_all.debounce)(function() {
        return _this.__trgCustom();
      }, 0);
      model.listenTo(em, "".concat(evLayerSelect, " ").concat(evTarget), trgCustom);
      model.on("change:lastTarget", function() {
        return em.trigger(evTarget, _this.getSelected());
      });
      return _this;
    }
    StyleManager2.prototype.__upSel = function() {
      this.select(this.em.getSelectedAll());
    };
    StyleManager2.prototype.__trgCustom = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.__ctn = this.__ctn || opts.container;
      this.em.trigger(this.events.custom, { container: this.__ctn });
    };
    StyleManager2.prototype.__trgEv = function(event) {
      var _a2;
      var data = [];
      for (var _i = 1; _i < arguments.length; _i++) {
        data[_i - 1] = arguments[_i];
      }
      (_a2 = this.em).trigger.apply(_a2, style_manager_spreadArray([event], data, false));
    };
    StyleManager2.prototype.__clearStateTarget = function() {
      var _this = this;
      var em = this.em;
      var stateTarget = this.__getStateTarget();
      stateTarget && (em === null || em === void 0 ? void 0 : em.skip(function() {
        em.Css.remove(stateTarget);
        _this.model.set({ stateTarget: null });
      }));
    };
    StyleManager2.prototype.onLoad = function() {
      this.sectors.add(this.config.sectors, { silent: true });
    };
    StyleManager2.prototype.postRender = function() {
      this.__appendTo();
    };
    StyleManager2.prototype.addSector = function(id, sector, options) {
      if (options === void 0) {
        options = {};
      }
      var result = this.getSector(id);
      if (!result) {
        sector.id = id;
        result = this.sectors.add(sector, options);
      }
      return result;
    };
    StyleManager2.prototype.getSector = function(id, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var res = this.sectors.where({ id })[0];
      !res && opts.warn && this._logNoSector(id);
      return res || null;
    };
    StyleManager2.prototype.getSectors = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var sectors = this.sectors;
      var res = sectors && sectors.models ? opts.array ? style_manager_spreadArray([], sectors.models, true) : sectors : [];
      return opts.visible ? res.filter(function(s) {
        return s.isVisible();
      }) : res;
    };
    StyleManager2.prototype.removeSector = function(id) {
      return this.getSectors().remove(this.getSector(id, { warn: true }));
    };
    StyleManager2.prototype.addProperty = function(sectorId, property, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var sector = this.getSector(sectorId, { warn: true });
      var prop;
      if (sector)
        prop = sector.addProperty(property, opts);
      return prop;
    };
    StyleManager2.prototype.getProperty = function(sectorId, id) {
      var sector = this.getSector(sectorId, { warn: true });
      var prop;
      if (sector) {
        prop = sector.properties.filter(function(prop2) {
          return prop2.get("property") === id || prop2.get("id") === id;
        })[0];
      }
      return prop;
    };
    StyleManager2.prototype.getProperties = function(sectorId) {
      var props;
      var sector = this.getSector(sectorId, { warn: true });
      if (sector)
        props = sector.properties;
      return props;
    };
    StyleManager2.prototype.removeProperty = function(sectorId, id) {
      var props = this.getProperties(sectorId);
      return props ? props.remove(this.getProperty(sectorId, id)) : null;
    };
    StyleManager2.prototype.select = function(target, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      var trgs = (0, index_all.isArray)(target) ? target : [target];
      var stylable = opts.stylable;
      var cssc = em.Css;
      var targets = [];
      trgs.filter(Boolean).forEach(function(target2) {
        var model = target2;
        if ((0, index_all.isString)(target2)) {
          var rule = cssc.getRule(target2) || cssc.setRule(target2);
          !(0, index_all.isUndefined)(stylable) && rule.set({ stylable });
          model = rule;
        }
        targets.push(model);
      });
      var component = opts.component || targets.filter(function(t) {
        return (0, mixins.isComponent)(t);
      }).reverse()[0];
      targets = targets.map(function(t) {
        return _this.getModelToStyle(t);
      });
      var state = em.getState();
      var lastTarget = targets.slice().reverse()[0];
      var lastTargetParents = this.getParentRules(lastTarget, {
        state,
        // @ts-ignore
        component
      });
      var stateTarget = this.__getStateTarget();
      em.skip(function() {
        var _a2;
        if (state && ((_a2 = lastTarget === null || lastTarget === void 0 ? void 0 : lastTarget.getState) === null || _a2 === void 0 ? void 0 : _a2.call(lastTarget))) {
          var style = lastTarget.getStyle();
          if (!stateTarget) {
            stateTarget = cssc.getAll().add({
              selectors: "gjs-selected",
              style,
              shallow: true,
              important: true
            });
          } else {
            stateTarget.setStyle(style);
          }
        } else if (stateTarget) {
          cssc.remove(stateTarget);
          stateTarget = void 0;
        }
      });
      this.model.set({
        targets,
        lastTarget,
        lastTargetParents,
        stateTarget,
        component
      });
      this.__upProps(opts);
      return targets;
    };
    StyleManager2.prototype.getSelected = function() {
      return this.model.get("lastTarget");
    };
    StyleManager2.prototype.getSelectedAll = function() {
      return this.model.get("targets");
    };
    StyleManager2.prototype.getSelectedParents = function() {
      return this.model.get("lastTargetParents") || [];
    };
    StyleManager2.prototype.__getStateTarget = function() {
      return this.model.get("stateTarget");
    };
    StyleManager2.prototype.addStyleTargets = function(style, opts) {
      this.getSelectedAll().map(function(t) {
        return t.addStyle(style, opts);
      });
      var target = this.getSelected();
      target && this.__emitCmpStyleUpdate(style);
      var targetState = this.__getStateTarget();
      target && (targetState === null || targetState === void 0 ? void 0 : targetState.setStyle(target.getStyle(), opts));
    };
    StyleManager2.prototype.getBuiltIn = function(prop) {
      return this.builtIn.get(prop);
    };
    StyleManager2.prototype.getBuiltInAll = function() {
      return this.builtIn.props;
    };
    StyleManager2.prototype.addBuiltIn = function(prop, definition) {
      return this.builtIn.add(prop, definition);
    };
    StyleManager2.prototype.getModelToStyle = function(model, options) {
      if (options === void 0) {
        options = {};
      }
      var em = this.em;
      var skipAdd = options.skipAdd;
      if (em && (model === null || model === void 0 ? void 0 : model.toHTML)) {
        var config_1 = em.getConfig();
        var um = em.UndoManager;
        var cssC_1 = em.Css;
        var sm = em.Selectors;
        var smConf = sm ? sm.getConfig() : {};
        var state_1 = !config_1.devicePreviewMode ? em.get("state") : "";
        var classes = model.get("classes");
        var valid_1 = classes.getStyleable();
        var hasClasses_1 = valid_1.length;
        var useClasses_1 = !smConf.componentFirst || options.useClasses;
        var addOpts_1 = { noCount: 1 };
        var opts_1 = { state: state_1, addOpts: addOpts_1 };
        um.skip(function() {
          var rule;
          if (hasClasses_1 && useClasses_1) {
            var deviceW = em.getCurrentMedia();
            rule = cssC_1.get(valid_1, state_1, deviceW);
            if (!rule && !skipAdd) {
              rule = cssC_1.add(valid_1, state_1, deviceW, {}, addOpts_1);
            }
          } else if (config_1.avoidInlineStyle) {
            var id = model.getId();
            rule = cssC_1.getIdRule(id, opts_1);
            !rule && !skipAdd && (rule = cssC_1.setIdRule(id, {}, opts_1));
            if (model.is("wrapper")) {
              rule.set("wrapper", 1, addOpts_1);
            }
          }
          rule && (model = rule);
        });
      }
      return model;
    };
    StyleManager2.prototype.getParentRules = function(target, _a2) {
      var _b = _a2 === void 0 ? {} : _a2, state = _b.state, component = _b.component;
      var em = this.em;
      var result = [];
      if (em && target) {
        var sel = component;
        var cssC_2 = em.Css;
        var cssGen = em.CodeManager.getGenerator("css");
        var cmp = target.toHTML ? target : target.getComponent();
        var optsSel_1 = { array: true };
        var cmpRules = [];
        var tagNameRules = [];
        var invisibleAndOtherRules = [];
        var otherRules = [];
        var rules = [];
        var rulesBySelectors = function(values) {
          return !values.length ? [] : cssC_2.getRules().filter(function(rule) {
            var rSels = rule.getSelectors().map(function(s) {
              return s.getFullName();
            });
            if (rSels.length === 0) {
              return false;
            }
            return rSels.every(function(rSel) {
              return values.indexOf(rSel) >= 0;
            });
          });
        };
        var rulesByTagName = function(tagName2) {
          return !tagName2 ? [] : cssC_2.getRules().filter(function(rule) {
            return rule.selectorsToString() === tagName2;
          });
        };
        if (cmp) {
          cmpRules = cssC_2.getRules("#".concat(cmp.getId()));
          tagNameRules = rulesByTagName(cmp.get("tagName"));
          otherRules = sel ? rulesBySelectors(sel.getSelectors().getFullName(optsSel_1)) : [];
          rules = otherRules.concat(tagNameRules).concat(cmpRules);
        } else {
          cmpRules = sel ? cssC_2.getRules("#".concat(sel.getId())) : [];
          tagNameRules = rulesByTagName((sel === null || sel === void 0 ? void 0 : sel.get("tagName")) || "");
          var allCmpClasses = (sel === null || sel === void 0 ? void 0 : sel.getSelectors().getFullName(optsSel_1)) || [];
          var invisibleSel = allCmpClasses.filter(function(item) {
            return target.getSelectors().getFullName(optsSel_1).findIndex(function(sel2) {
              return sel2 === item;
            }) === -1;
          });
          invisibleAndOtherRules = rulesBySelectors(invisibleSel.concat(target.getSelectors().getFullName(optsSel_1)));
          rules = tagNameRules.concat(cmpRules).concat(invisibleAndOtherRules);
        }
        var all = rules.filter(function(rule) {
          return !(0, index_all.isUndefined)(state) ? rule.get("state") === state : 1;
        }).sort(cssGen.sortRules).reverse();
        result = all.slice(all.indexOf(target) + 1);
      }
      return result;
    };
    StyleManager2.prototype.addType = function(id, definition) {
      this.properties.addType(id, definition);
    };
    StyleManager2.prototype.getType = function(id) {
      return this.properties.getType(id);
    };
    StyleManager2.prototype.getTypes = function() {
      return this.properties.getTypes();
    };
    StyleManager2.prototype.createType = function(id, _a2) {
      var _b = _a2 === void 0 ? {} : _a2, _c = _b.model, model = _c === void 0 ? {} : _c, _d = _b.view, view = _d === void 0 ? {} : _d;
      var config2 = this.config;
      var type2 = this.getType(id);
      if (type2) {
        return new type2.view(style_manager_assign({ model: new type2.model(model), config: config2 }, view));
      }
    };
    StyleManager2.prototype.render = function() {
      var _a2 = this, config2 = _a2.config, em = _a2.em, SectView = _a2.SectView;
      var el = SectView && SectView.el;
      this.SectView = new view_SectorsView({
        el,
        em,
        config: config2,
        module: this,
        collection: this.sectors
      });
      return this.SectView.render().el;
    };
    StyleManager2.prototype._logNoSector = function(sectorId) {
      var em = this.em;
      em && em.logWarning("'".concat(sectorId, "' sector not found"));
    };
    StyleManager2.prototype.__emitCmpStyleUpdate = function(style, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var em = this.em;
      if (!style.__p) {
        var allSel_1 = this.getSelectedAll();
        var cmp = opts.components || em.getSelectedAll();
        var cmps = Array.isArray(cmp) ? cmp : [cmp];
        var newStyles_1 = style_manager_assign({}, style);
        delete newStyles_1.__p;
        cmps.forEach(function(cmp2) {
          return !allSel_1.includes(cmp2) && cmp2.__onStyleChange(newStyles_1);
        });
      }
    };
    StyleManager2.prototype.__upProps = function(opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var lastTarget = this.getSelected();
      if (!lastTarget)
        return;
      var sectors = this.sectors;
      var component = this.model.get("component");
      var lastTargetParents = this.getSelectedParents();
      var style = lastTarget.getStyle();
      var parentStyles = lastTargetParents.map(function(p) {
        return {
          target: p,
          style: p.getStyle()
        };
      });
      sectors.map(function(sector) {
        sector.getProperties().map(function(prop) {
          _this.__upProp(prop, style, parentStyles, opts);
        });
      });
      sectors.forEach(function(sector) {
        var props = sector.getProperties();
        props.forEach(function(prop) {
          var isVisible = prop.__checkVisibility({
            target: lastTarget,
            component,
            // @ts-ignore
            sectors
          });
          prop.set("visible", isVisible);
        });
        var sectorVisible = props.some(function(p) {
          return p.isVisible();
        });
        sector.set("visible", sectorVisible);
      });
    };
    StyleManager2.prototype.__upProp = function(prop, style, parentStyles, opts) {
      var _this = this;
      var name = prop.getName();
      var value = style[name];
      var hasVal = propDef(value);
      var isStack = prop.getType() === "stack";
      var isComposite = prop.getType() === "composite";
      var opt = style_manager_assign(style_manager_assign({}, opts), { __up: true });
      var canUpdate = !isComposite && !isStack;
      var propStack = prop;
      var propComp = prop;
      var newLayers = isStack ? propStack.__getLayersFromStyle(style) : [];
      var newProps = isComposite ? propComp.__getPropsFromStyle(style) : {};
      var newValue = hasVal ? value : null;
      var parentTarget = null;
      if (isStack && newLayers === null || isComposite && newProps === null) {
        var method_1 = isStack ? "__getLayersFromStyle" : "__getPropsFromStyle";
        var parentItem = parentStyles.filter(function(p) {
          return propStack[method_1](p.style) !== null;
        })[0];
        if (parentItem) {
          newValue = parentItem.style[name];
          parentTarget = parentItem.target;
          var val = propStack[method_1](parentItem.style);
          if (isStack) {
            newLayers = val;
          } else {
            newProps = val;
          }
        }
      } else if (!hasVal) {
        newValue = null;
        var parentItem = parentStyles.filter(function(p) {
          return propDef(p.style[name]);
        })[0];
        if (parentItem) {
          newValue = parentItem.style[name];
          parentTarget = parentItem.target;
        }
      }
      prop.__setParentTarget(parentTarget);
      canUpdate && prop.__getFullValue() !== newValue && prop.upValue(newValue, opt);
      if (isStack) {
        propStack.__setLayers(newLayers || [], {
          isEmptyValue: propStack.isEmptyValueStyle(style)
        });
      }
      if (isComposite) {
        var props = propComp.getProperties();
        if (propComp.isDetached()) {
          var newStyle_1 = propComp.__getPropsFromStyle(style, { byName: true }) || {};
          var newParentStyles_1 = parentStyles.map(function(p) {
            return style_manager_assign(style_manager_assign({}, p), { style: propComp.__getPropsFromStyle(p.style, { byName: true }) || {} });
          });
          props.map(function(pr) {
            return _this.__upProp(pr, newStyle_1, newParentStyles_1, opts);
          });
        } else {
          propComp.__setProperties(newProps || {}, opt);
          propComp.getProperties().map(function(pr) {
            return pr.__setParentTarget(parentTarget);
          });
        }
      }
    };
    StyleManager2.prototype.destroy = function() {
      var _a2;
      [this.properties, this.sectors].forEach(function(coll) {
        coll.reset();
        coll.stopListening();
      });
      (_a2 = this.SectView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.model.stopListening();
      this.upAll.cancel();
    };
    return StyleManager2;
  }(ItemManagerModule)
);
var style_manager = StyleManager;
var Editor_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var Editor_assign = function() {
  Editor_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return Editor_assign.apply(this, arguments);
};
var Editor_awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var Editor_generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var Editor_rest = function(s, e) {
  var t = {};
  for (var p in s)
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
      t[p] = s[p];
  if (s != null && typeof Object.getOwnPropertySymbols === "function")
    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
      if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
        t[p[i]] = s[p[i]];
    }
  return t;
};
var Editor_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
backbone_default().$ = cash_dom["default"];
var deps = [
  utils,
  i18n,
  keymaps,
  undo_manager,
  storage_manager,
  device_manager,
  parser,
  style_manager,
  selector_manager,
  modal_dialog,
  code_manager,
  panels,
  rich_text_editor,
  trait_manager,
  src_navigator,
  canvas,
  commands,
  block_manager
];
var storableDeps = [
  asset_manager,
  css_composer,
  pages,
  dom_components
];
extender({ $: cash_dom["default"] });
var logs = {
  debug: console.log,
  info: console.info,
  warning: console.warn,
  error: console.error
};
var EditorModel = (
  /** @class */
  function(_super) {
    Editor_extends(EditorModel2, _super);
    function EditorModel2(conf) {
      if (conf === void 0) {
        conf = {};
      }
      var _this = _super.call(this) || this;
      _this.__skip = false;
      _this.defaultRunning = false;
      _this.destroyed = false;
      _this._config = conf;
      var config2 = _this.config;
      _this.set("Config", conf);
      _this.set("modules", []);
      _this.set("toLoad", []);
      _this.set("storables", []);
      _this.set("selected", new model_Selected());
      _this.set("dmode", config2.dragMode);
      var el = config2.el, log = config2.log;
      var toLog = log === true ? (0, index_all.keys)(logs) : (0, index_all.isArray)(log) ? log : [];
      (0, index_all.bindAll)(_this, "initBaseColorPicker");
      if (el && config2.fromElement) {
        config2.components = el.innerHTML;
      }
      _this.attrsOrig = el ? (0, index_all.toArray)(el.attributes).reduce(function(res, next) {
        res[next.nodeName] = next.nodeValue;
        return res;
      }, {}) : "";
      if (config2.components && !config2.pageManager) {
        config2.pageManager = { pages: [{ component: config2.components }] };
      }
      deps.forEach(function(constr) {
        return _this.loadModule(constr);
      });
      storableDeps.forEach(function(constr) {
        return _this.loadStorableModule(constr);
      });
      _this.on("change:componentHovered", _this.componentHovered, _this);
      _this.on("change:changesCount", _this.updateChanges, _this);
      _this.on("change:readyLoad change:readyCanvas", _this._checkReady, _this);
      toLog.forEach(function(e) {
        return _this.listenLog(e);
      });
      [{ from: "change:selectedComponent", to: "component:toggled" }].forEach(function(event) {
        var eventFrom = event.from;
        var eventTo = event.to;
        _this.listenTo(_this, eventFrom, function() {
          var args = [];
          for (var _i = 0; _i < arguments.length; _i++) {
            args[_i] = arguments[_i];
          }
          _this.trigger.apply(_this, Editor_spreadArray([eventTo], args, false));
          _this.logWarning("The event '".concat(eventFrom, "' is deprecated, replace it with '").concat(eventTo, "'"));
        });
      });
      return _this;
    }
    EditorModel2.prototype.defaults = function() {
      return {
        editing: 0,
        selected: 0,
        clipboard: null,
        dmode: 0,
        componentHovered: null,
        previousModel: null,
        changesCount: 0,
        storables: [],
        modules: [],
        toLoad: [],
        opened: {},
        device: ""
      };
    };
    Object.defineProperty(EditorModel2.prototype, "storables", {
      get: function() {
        return this.get("storables");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "modules", {
      get: function() {
        return this.get("modules");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "toLoad", {
      get: function() {
        return this.get("toLoad");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "selected", {
      get: function() {
        return this.get("selected");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "shallow", {
      get: function() {
        return this.get("shallow");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "I18n", {
      get: function() {
        return this.get("I18n");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Utils", {
      get: function() {
        return this.get("Utils");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Commands", {
      get: function() {
        return this.get("Commands");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Keymaps", {
      get: function() {
        return this.get("Keymaps");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Modal", {
      get: function() {
        return this.get("Modal");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Panels", {
      get: function() {
        return this.get("Panels");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "CodeManager", {
      get: function() {
        return this.get("CodeManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "UndoManager", {
      get: function() {
        return this.get("UndoManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "RichTextEditor", {
      get: function() {
        return this.get("RichTextEditor");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Canvas", {
      get: function() {
        return this.get("Canvas");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Editor", {
      get: function() {
        return this.get("Editor");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Components", {
      get: function() {
        return this.get("DomComponents");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Css", {
      get: function() {
        return this.get("CssComposer");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Blocks", {
      get: function() {
        return this.get("BlockManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Selectors", {
      get: function() {
        return this.get("SelectorManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Storage", {
      get: function() {
        return this.get("StorageManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Traits", {
      get: function() {
        return this.get("TraitManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Parser", {
      get: function() {
        return this.get("Parser");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Layers", {
      get: function() {
        return this.get("LayerManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Assets", {
      get: function() {
        return this.get("AssetManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Devices", {
      get: function() {
        return this.get("DeviceManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Pages", {
      get: function() {
        return this.get("PageManager");
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(EditorModel2.prototype, "Styles", {
      get: function() {
        return this.get("StyleManager");
      },
      enumerable: false,
      configurable: true
    });
    EditorModel2.prototype._checkReady = function() {
      if (this.get("readyLoad") && this.get("readyCanvas") && !this.get("ready")) {
        this.set("ready", true);
      }
    };
    EditorModel2.prototype.getContainer = function() {
      return this.config.el;
    };
    EditorModel2.prototype.listenLog = function(event) {
      this.listenTo(this, "log:".concat(event), logs[event]);
    };
    Object.defineProperty(EditorModel2.prototype, "config", {
      get: function() {
        return this._config;
      },
      enumerable: false,
      configurable: true
    });
    EditorModel2.prototype.getConfig = function(prop) {
      var config2 = this.config;
      return (0, index_all.isUndefined)(prop) ? config2 : config2[prop];
    };
    EditorModel2.prototype.loadOnStart = function() {
      var _this = this;
      var _a2 = this.config, projectData = _a2.projectData, headless = _a2.headless;
      var sm = this.Storage;
      this.toLoad.reverse().forEach(function(mdl) {
        return mdl.onLoad();
      });
      var postLoad = function() {
        _this.modules.forEach(function(mdl) {
          return mdl.postLoad && mdl.postLoad(_this);
        });
        _this.set("readyLoad", 1);
      };
      if (headless) {
        projectData && this.loadData(projectData);
        postLoad();
      } else {
        this._storageTimeout = setTimeout(function() {
          return Editor_awaiter(_this, void 0, void 0, function() {
            var error_1;
            return Editor_generator(this, function(_a3) {
              switch (_a3.label) {
                case 0:
                  if (!projectData)
                    return [3, 1];
                  this.loadData(projectData);
                  return [3, 5];
                case 1:
                  if (!(sm === null || sm === void 0 ? void 0 : sm.canAutoload()))
                    return [3, 5];
                  _a3.label = 2;
                case 2:
                  _a3.trys.push([2, 4, , 5]);
                  return [4, this.load()];
                case 3:
                  _a3.sent();
                  return [3, 5];
                case 4:
                  error_1 = _a3.sent();
                  this.logError(error_1);
                  return [3, 5];
                case 5:
                  postLoad();
                  return [
                    2
                    /*return*/
                  ];
              }
            });
          });
        });
      }
      var shallow = new EditorModel2({
        noticeOnUnload: false,
        storageManager: false,
        undoManager: false
      });
      shallow.Pages.onLoad();
      shallow.Canvas.postLoad();
      this.set("shallow", shallow);
    };
    EditorModel2.prototype.updateChanges = function(m, v, opts) {
      var _this = this;
      var stm = this.Storage;
      var changes = this.getDirtyCount();
      if (!opts.isClear) {
        this.updateItr && clearTimeout(this.updateItr);
        this.updateItr = setTimeout(function() {
          return _this.trigger("update");
        });
      }
      if (this.config.noticeOnUnload) {
        window.onbeforeunload = changes ? function() {
          return true;
        } : null;
      }
      if (stm.isAutosave() && changes >= stm.getStepsBeforeSave()) {
        this.store().catch(function(err) {
          return _this.logError(err);
        });
      }
    };
    EditorModel2.prototype.loadModule = function(InitModule) {
      var Mod = new InitModule(this);
      this.set(Mod.name, Mod);
      Mod.onLoad && this.toLoad.push(Mod);
      this.modules.push(Mod);
      return Mod;
    };
    EditorModel2.prototype.loadStorableModule = function(InitModule) {
      var Mod = this.loadModule(InitModule);
      this.storables.push(Mod);
      return Mod;
    };
    EditorModel2.prototype.init = function(editor, opts) {
      if (opts === void 0) {
        opts = {};
      }
      if (this.destroyed) {
        this.initialize(opts);
        this.destroyed = false;
      }
      this.set("Editor", editor);
    };
    EditorModel2.prototype.getEditor = function() {
      return this.get("Editor");
    };
    EditorModel2.prototype.handleUpdates = function(model, val, opt) {
      var _this = this;
      if (opt === void 0) {
        opt = {};
      }
      if (this.__skip || opt.temporary || opt.noCount || opt.avoidStore || !this.get("ready")) {
        return;
      }
      this.timedInterval && clearTimeout(this.timedInterval);
      this.timedInterval = setTimeout(function() {
        var curr = _this.getDirtyCount() || 0;
        var unset = opt.unset, opts = Editor_rest(opt, ["unset"]);
        _this.set("changesCount", curr + 1, opts);
      }, 0);
    };
    EditorModel2.prototype.changesUp = function(opts) {
      this.handleUpdates(0, 0, opts);
    };
    EditorModel2.prototype.componentHovered = function(editor, component, options) {
      var prev = this.previous("componentHovered");
      prev && this.trigger("component:unhovered", prev, options);
      component && this.trigger("component:hovered", component, options);
    };
    EditorModel2.prototype.getSelected = function() {
      return this.selected.lastComponent();
    };
    EditorModel2.prototype.getSelectedAll = function() {
      return this.selected.allComponents();
    };
    EditorModel2.prototype.setSelected = function(el, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var event = opts.event;
      var ctrlKey = event && (event.ctrlKey || event.metaKey);
      var shiftKey = (event || {}).shiftKey;
      var models = ((0, index_all.isArray)(el) ? el : [el]).map(function(cmp) {
        var _a2, _b;
        return ((_b = (_a2 = cmp === null || cmp === void 0 ? void 0 : cmp.delegate) === null || _a2 === void 0 ? void 0 : _a2.select) === null || _b === void 0 ? void 0 : _b.call(_a2, cmp)) || cmp;
      }).filter(Boolean);
      var selected = this.getSelectedAll();
      var mltSel = this.getConfig().multipleSelection;
      var multiple = (0, index_all.isArray)(el);
      if (multiple || !el) {
        this.removeSelected(selected.filter(function(s) {
          return !(0, index_all.contains)(models, s);
        }));
      }
      models.forEach(function(model) {
        if (model) {
          _this.trigger("component:select:before", model, opts);
          if (!model.get("selectable") || opts.abort) {
            if (opts.useValid) {
              var parent_1 = model.parent();
              while (parent_1 && !parent_1.get("selectable"))
                parent_1 = parent_1.parent();
              model = parent_1;
            } else {
              return;
            }
          }
        }
        if (ctrlKey && mltSel) {
          return _this.toggleSelected(model);
        } else if (shiftKey && mltSel) {
          _this.clearSelection(_this.Canvas.getWindow());
          var coll_1 = model.collection;
          var index_1 = model.index();
          var min_1, max_1;
          _this.getSelectedAll().forEach(function(sel) {
            var selColl = sel.collection;
            var selIndex = sel.index();
            if (selColl === coll_1) {
              if (selIndex < index_1) {
                min_1 = (0, index_all.isUndefined)(min_1) ? selIndex : Math.max(min_1, selIndex);
              } else if (selIndex > index_1) {
                max_1 = (0, index_all.isUndefined)(max_1) ? selIndex : Math.min(max_1, selIndex);
              }
            }
          });
          if (!(0, index_all.isUndefined)(min_1)) {
            while (min_1 !== index_1) {
              _this.addSelected(coll_1.at(min_1));
              min_1++;
            }
          }
          if (!(0, index_all.isUndefined)(max_1)) {
            while (max_1 !== index_1) {
              _this.addSelected(coll_1.at(max_1));
              max_1--;
            }
          }
          return _this.addSelected(model);
        }
        !multiple && _this.removeSelected(selected.filter(function(s) {
          return s !== model;
        }));
        _this.addSelected(model, opts);
      });
    };
    EditorModel2.prototype.addSelected = function(component, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var models = (0, index_all.isArray)(component) ? component : [component];
      models.forEach(function(model) {
        var selected = _this.selected;
        if (!model || !model.get("selectable") || // Avoid selecting children of selected components
        model.parents().some(function(parent) {
          return selected.hasComponent(parent);
        })) {
          return;
        }
        opts.forceChange && _this.removeSelected(model, opts);
        var toDeselect = selected.allComponents().filter(function(cmp) {
          return (0, index_all.contains)(cmp.parents(), model);
        });
        toDeselect.forEach(function(cmp) {
          return _this.removeSelected(cmp, opts);
        });
        selected.addComponent(model, opts);
        _this.trigger("component:select", model, opts);
        _this.Canvas.addSpot({
          type: CanvasSpot.F.Select,
          component: model
        });
      });
    };
    EditorModel2.prototype.removeSelected = function(component, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      this.selected.removeComponent(component, opts);
      var cmps = (0, index_all.isArray)(component) ? component : [component];
      cmps.forEach(function(component2) {
        return _this.Canvas.removeSpots({
          type: CanvasSpot.F.Select,
          component: component2
        });
      });
    };
    EditorModel2.prototype.toggleSelected = function(component, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var models = (0, index_all.isArray)(component) ? component : [component];
      models.forEach(function(model) {
        if (_this.selected.hasComponent(model)) {
          _this.removeSelected(model, opts);
        } else {
          _this.addSelected(model, opts);
        }
      });
    };
    EditorModel2.prototype.setHovered = function(cmp, opts) {
      var _this = this;
      if (opts === void 0) {
        opts = {};
      }
      var upHovered = function(cmp2, opts2) {
        var _a2 = _this, config2 = _a2.config, Canvas2 = _a2.Canvas;
        var current = _this.getHovered();
        var selectedAll = _this.getSelectedAll();
        var typeHover = CanvasSpot.F.Hover;
        var typeSpacing = CanvasSpot.F.Spacing;
        _this.set("componentHovered", cmp2 || null, opts2);
        if (current) {
          Canvas2.removeSpots({ type: typeHover, component: current });
          Canvas2.removeSpots({ type: typeSpacing, component: current });
        }
        if (cmp2) {
          Canvas2.addSpot({ type: typeHover, component: cmp2 });
          if (!selectedAll.includes(cmp2) || config2.showOffsetsSelected) {
            Canvas2.addSpot({ type: typeSpacing, component: cmp2 });
          }
        }
      };
      if (!cmp) {
        return upHovered();
      }
      var ev = "component:hover";
      opts.forceChange && upHovered();
      this.trigger("".concat(ev, ":before"), cmp, opts);
      if (!cmp.get("hoverable")) {
        if (opts.useValid && !opts.abort) {
          var parent_2 = cmp.parent();
          while (parent_2 && !parent_2.get("hoverable"))
            parent_2 = parent_2.parent();
          cmp = parent_2;
        } else {
          return;
        }
      }
      if (!opts.abort) {
        upHovered(cmp, opts);
        this.trigger(ev, cmp, opts);
      }
    };
    EditorModel2.prototype.getHovered = function() {
      return this.get("componentHovered");
    };
    EditorModel2.prototype.setComponents = function(components, opt) {
      if (opt === void 0) {
        opt = {};
      }
      return this.Components.setComponents(components, opt);
    };
    EditorModel2.prototype.getComponents = function() {
      var cmp = this.Components;
      var cm = this.CodeManager;
      if (!cmp || !cm)
        return;
      var wrp = cmp.getComponents();
      return cm.getCode(wrp, "json");
    };
    EditorModel2.prototype.setStyle = function(style, opt) {
      if (opt === void 0) {
        opt = {};
      }
      var cssc = this.Css;
      cssc.clear(opt);
      cssc.getAll().add(style, opt);
      return this;
    };
    EditorModel2.prototype.addStyle = function(style, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var res = this.getStyle().add(style, opts);
      return (0, index_all.isArray)(res) ? res : [res];
    };
    EditorModel2.prototype.getStyle = function() {
      return this.Css.getAll();
    };
    EditorModel2.prototype.setState = function(value) {
      this.set("state", value);
      return this;
    };
    EditorModel2.prototype.getState = function() {
      return this.get("state") || "";
    };
    EditorModel2.prototype.getHtml = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var config2 = this.config;
      var optsHtml = config2.optsHtml;
      var js = config2.jsInHtml ? this.getJs(opts) : "";
      var cmp = opts.component || this.Components.getComponent();
      var html2 = cmp ? this.CodeManager.getCode(cmp, "html", Editor_assign(Editor_assign({}, optsHtml), opts)) : "";
      html2 += js ? "<script>".concat(js, "<\/script>") : "";
      return html2;
    };
    EditorModel2.prototype.getCss = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var config2 = this.config;
      var optsCss = config2.optsCss;
      var avoidProt = opts.avoidProtected;
      var keepUnusedStyles = !(0, index_all.isUndefined)(opts.keepUnusedStyles) ? opts.keepUnusedStyles : config2.keepUnusedStyles;
      var cssc = this.Css;
      var wrp = opts.component || this.Components.getComponent();
      var protCss = !avoidProt ? config2.protectedCss : "";
      var css = wrp && this.CodeManager.getCode(wrp, "css", Editor_assign(Editor_assign({ cssc, keepUnusedStyles }, optsCss), opts));
      return wrp ? opts.json ? css : protCss + css : "";
    };
    EditorModel2.prototype.getJs = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var wrp = opts.component || this.Components.getWrapper();
      return wrp ? this.CodeManager.getCode(wrp, "js").trim() : "";
    };
    EditorModel2.prototype.store = function(options) {
      return Editor_awaiter(this, void 0, void 0, function() {
        var data;
        return Editor_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              data = this.storeData();
              return [4, this.Storage.store(data, options)];
            case 1:
              _a2.sent();
              this.clearDirtyCount();
              return [2, data];
          }
        });
      });
    };
    EditorModel2.prototype.load = function(options_1) {
      return Editor_awaiter(this, arguments, void 0, function(options, loadOptions) {
        var result;
        if (loadOptions === void 0) {
          loadOptions = {};
        }
        return Editor_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              return [4, this.Storage.load(options)];
            case 1:
              result = _a2.sent();
              this.loadData(result);
              return [4, (0, mixins.wait)()];
            case 2:
              _a2.sent();
              if (loadOptions.clear) {
                this.UndoManager.clear();
                this.clearDirtyCount();
              }
              return [2, result];
          }
        });
      });
    };
    EditorModel2.prototype.storeData = function() {
      var result = {};
      var editingCmp = this.getEditing();
      editingCmp && editingCmp.trigger("sync:content", { noCount: true });
      this.storables.forEach(function(m) {
        result = Editor_assign(Editor_assign({}, result), m.store(1));
      });
      return JSON.parse(JSON.stringify(result));
    };
    EditorModel2.prototype.loadData = function(data) {
      if (data === void 0) {
        data = {};
      }
      if (!(0, mixins.isEmptyObj)(data)) {
        this.storables.forEach(function(module) {
          return module.clear();
        });
        this.storables.forEach(function(module) {
          return module.load(data);
        });
      }
      return data;
    };
    EditorModel2.prototype.getDeviceModel = function() {
      var name = this.get("device");
      return this.Devices.get(name);
    };
    EditorModel2.prototype.runDefault = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var command = this.get("Commands").get(this.config.defaultCommand);
      if (!command || this.defaultRunning)
        return;
      command.stop(this, this, opts);
      command.run(this, this, opts);
      this.defaultRunning = true;
    };
    EditorModel2.prototype.stopDefault = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      var commands2 = this.get("Commands");
      if (!commands2)
        return;
      var command = commands2.get(this.config.defaultCommand);
      if (!command || !this.defaultRunning)
        return;
      command.stop(this, this, opts);
      this.defaultRunning = false;
    };
    EditorModel2.prototype.refreshCanvas = function(opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.Canvas.refresh({ spots: opts.tools });
    };
    EditorModel2.prototype.clearSelection = function(win) {
      var _a2;
      var w = win || window;
      (_a2 = w.getSelection()) === null || _a2 === void 0 ? void 0 : _a2.removeAllRanges();
    };
    EditorModel2.prototype.getCurrentMedia = function() {
      var config2 = this.config;
      var device = this.getDeviceModel();
      var condition = config2.mediaCondition;
      var preview = config2.devicePreviewMode;
      var width = device && device.get("widthMedia");
      return device && width && !preview ? "(".concat(condition, ": ").concat(width, ")") : "";
    };
    EditorModel2.prototype.getWrapper = function() {
      return this.Components.getWrapper();
    };
    EditorModel2.prototype.setCurrentFrame = function(frameView) {
      return this.set("currentFrame", frameView);
    };
    EditorModel2.prototype.getCurrentFrame = function() {
      return this.get("currentFrame");
    };
    EditorModel2.prototype.getCurrentFrameModel = function() {
      var _a2;
      return (_a2 = this.getCurrentFrame() || {}) === null || _a2 === void 0 ? void 0 : _a2.model;
    };
    EditorModel2.prototype.getIcon = function(icon) {
      var icons = this.config.icons || {};
      return icons[icon] || "";
    };
    EditorModel2.prototype.getDirtyCount = function() {
      return this.get("changesCount");
    };
    EditorModel2.prototype.clearDirtyCount = function() {
      return this.set({ changesCount: 0 }, { isClear: true });
    };
    EditorModel2.prototype.getZoomDecimal = function() {
      return this.Canvas.getZoomDecimal();
    };
    EditorModel2.prototype.getZoomMultiplier = function() {
      return this.Canvas.getZoomMultiplier();
    };
    EditorModel2.prototype.setDragMode = function(value) {
      return this.set("dmode", value);
    };
    EditorModel2.prototype.getDragMode = function(component) {
      var mode = (component === null || component === void 0 ? void 0 : component.getDragMode()) || this.get("dmode");
      return mode || "";
    };
    EditorModel2.prototype.t = function() {
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      var i18n2 = this.get("I18n");
      return i18n2 === null || i18n2 === void 0 ? void 0 : i18n2.t.apply(i18n2, args);
    };
    EditorModel2.prototype.inAbsoluteMode = function(component) {
      return this.getDragMode(component) === "absolute";
    };
    EditorModel2.prototype.destroyAll = function() {
      var _this = this;
      var _a2 = this, config2 = _a2.config, view = _a2.view;
      var editor = this.getEditor();
      var _b = (config2.grapesjs || {}).editors, editors2 = _b === void 0 ? [] : _b;
      var shallow = this.get("shallow");
      this._storageTimeout && clearTimeout(this._storageTimeout);
      shallow === null || shallow === void 0 ? void 0 : shallow.destroyAll();
      this.stopListening();
      this.stopDefault();
      (this.modules || []).slice().reverse().forEach(function(mod) {
        return mod.destroy();
      });
      (view === null || view === void 0 ? void 0 : view.remove) && view.remove();
      this.clear({ silent: true });
      this.destroyed = true;
      ["_config", "view", "_previousAttributes", "_events", "_listeners"].forEach(
        //@ts-ignore
        function(i) {
          return _this[i] = {};
        }
      );
      editors2.splice(editors2.indexOf(editor), 1);
      (0, mixins.hasWin)() && (0, cash_dom["default"])(config2.el).empty().attr(this.attrsOrig);
    };
    EditorModel2.prototype.getEditing = function() {
      var res = this.get("editing");
      return res && res.model || void 0;
    };
    EditorModel2.prototype.setEditing = function(value) {
      this.set("editing", value);
      return this;
    };
    EditorModel2.prototype.isEditing = function() {
      return !!this.get("editing");
    };
    EditorModel2.prototype.log = function(msg, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var ns = opts.ns, _a2 = opts.level, level = _a2 === void 0 ? "debug" : _a2;
      this.trigger("log", msg, opts);
      level && this.trigger("log:".concat(level), msg, opts);
      if (ns) {
        var logNs = "log-".concat(ns);
        this.trigger(logNs, msg, opts);
        level && this.trigger("".concat(logNs, ":").concat(level), msg, opts);
      }
    };
    EditorModel2.prototype.logInfo = function(msg, opts) {
      this.log(msg, Editor_assign(Editor_assign({}, opts), { level: "info" }));
    };
    EditorModel2.prototype.logWarning = function(msg, opts) {
      this.log(msg, Editor_assign(Editor_assign({}, opts), { level: "warning" }));
    };
    EditorModel2.prototype.logError = function(msg, opts) {
      this.log(msg, Editor_assign(Editor_assign({}, opts), { level: "error" }));
    };
    EditorModel2.prototype.initBaseColorPicker = function(el, opts) {
      if (opts === void 0) {
        opts = {};
      }
      var config2 = this.config;
      var _a2 = config2.colorPicker, colorPicker = _a2 === void 0 ? {} : _a2;
      var elToAppend = config2.el;
      var ppfx = config2.stylePrefix;
      return (0, cash_dom["default"])(el).spectrum(Editor_assign(Editor_assign({ containerClassName: "".concat(ppfx, "one-bg ").concat(ppfx, "two-color"), appendTo: elToAppend || "body", maxSelectionSize: 8, showPalette: true, palette: [], showAlpha: true, chooseText: "Ok", cancelText: "⨯" }, opts), colorPicker));
    };
    EditorModel2.prototype.skip = function(clb) {
      this.__skip = true;
      var um = this.UndoManager;
      um ? um.skip(clb) : clb();
      this.__skip = false;
    };
    EditorModel2.prototype.data = function(el, name, value) {
      var varName = "_gjs-data";
      if (!el[varName]) {
        el[varName] = {};
      }
      if ((0, index_all.isUndefined)(value)) {
        return el[varName][name];
      } else {
        el[varName][name] = value;
      }
    };
    return EditorModel2;
  }(common.Kx)
);
var model_Editor = EditorModel;
var view_EditorView_extends = /* @__PURE__ */ function() {
  var extendStatics = function(d, b) {
    extendStatics = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function(d2, b2) {
      d2.__proto__ = b2;
    } || function(d2, b2) {
      for (var p in b2)
        if (Object.prototype.hasOwnProperty.call(b2, p))
          d2[p] = b2[p];
    };
    return extendStatics(d, b);
  };
  return function(d, b) {
    if (typeof b !== "function" && b !== null)
      throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
    extendStatics(d, b);
    function __() {
      this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
  };
}();
var EditorView_EditorView = (
  /** @class */
  function(_super) {
    view_EditorView_extends(EditorView2, _super);
    function EditorView2(model) {
      var _this = _super.call(this, { model }) || this;
      var Panels2 = model.Panels, UndoManager = model.UndoManager;
      model.view = _this;
      model.once("change:ready", function() {
        Panels2.active();
        Panels2.disableButtons();
        UndoManager.clear();
        setTimeout(function() {
          model.trigger("load", model.Editor);
          model.clearDirtyCount();
        });
      });
      return _this;
    }
    EditorView2.prototype.render = function() {
      var _this = this;
      var _a2 = this, $el = _a2.$el, model = _a2.model;
      var Panels2 = model.Panels, Canvas2 = model.Canvas, config2 = model.config, modules = model.modules;
      var pfx = config2.stylePrefix;
      var classNames = ["".concat(pfx, "editor")];
      !config2.customUI && classNames.push("".concat(pfx, "one-bg ").concat(pfx, "two-color"));
      var contEl = (0, cash_dom["default"])(config2.el || "body ".concat(config2.container));
      config2.cssIcons && (0, mixins.appendStyles)(config2.cssIcons, { unique: true, prepand: true });
      $el.empty();
      config2.width && contEl.css("width", config2.width);
      config2.height && contEl.css("height", config2.height);
      $el.append(Canvas2.render());
      $el.append(Panels2.render());
      var shallow = model.shallow;
      var shallowCanvasEl = shallow.Canvas.render();
      shallowCanvasEl.style.display = "none";
      $el.append(shallowCanvasEl);
      $el.attr("class", classNames.join(" "));
      contEl.addClass("".concat(pfx, "editor-cont")).empty().append($el);
      modules.forEach(function(md) {
        var _a3;
        return (_a3 = md.postRender) === null || _a3 === void 0 ? void 0 : _a3.call(md, _this);
      });
      return this;
    };
    return EditorView2;
  }(common.Ss)
);
var view_EditorView = EditorView_EditorView;
var editor_assign = function() {
  editor_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return editor_assign.apply(this, arguments);
};
var editor_awaiter = function(thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function(resolve2) {
      resolve2(value);
    });
  }
  return new (P || (P = Promise))(function(resolve2, reject2) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject2(e);
      }
    }
    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject2(e);
      }
    }
    function step(result) {
      result.done ? resolve2(result.value) : adopt(result.value).then(fulfilled, rejected);
    }
    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};
var editor_generator = function(thisArg, body) {
  var _ = { label: 0, sent: function() {
    if (t[0] & 1)
      throw t[1];
    return t[1];
  }, trys: [], ops: [] }, f, y, t, g;
  return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() {
    return this;
  }), g;
  function verb(n) {
    return function(v) {
      return step([n, v]);
    };
  }
  function step(op) {
    if (f)
      throw new TypeError("Generator is already executing.");
    while (g && (g = 0, op[0] && (_ = 0)), _)
      try {
        if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done)
          return t;
        if (y = 0, t)
          op = [op[0] & 2, t.value];
        switch (op[0]) {
          case 0:
          case 1:
            t = op;
            break;
          case 4:
            _.label++;
            return { value: op[1], done: false };
          case 5:
            _.label++;
            y = op[1];
            op = [0];
            continue;
          case 7:
            op = _.ops.pop();
            _.trys.pop();
            continue;
          default:
            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
              _ = 0;
              continue;
            }
            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
              _.label = op[1];
              break;
            }
            if (op[0] === 6 && _.label < t[1]) {
              _.label = t[1];
              t = op;
              break;
            }
            if (t && _.label < t[2]) {
              _.label = t[2];
              _.ops.push(op);
              break;
            }
            if (t[2])
              _.ops.pop();
            _.trys.pop();
            continue;
        }
        op = body.call(thisArg, _);
      } catch (e) {
        op = [6, e];
        y = 0;
      } finally {
        f = t = 0;
      }
    if (op[0] & 5)
      throw op[1];
    return { value: op[0] ? op[1] : void 0, done: true };
  }
};
var editor_spreadArray = function(to, from, pack) {
  if (pack || arguments.length === 2)
    for (var i = 0, l = from.length, ar; i < l; i++) {
      if (ar || !(i in from)) {
        if (!ar)
          ar = Array.prototype.slice.call(from, 0, i);
        ar[i] = from[i];
      }
    }
  return to.concat(ar || Array.prototype.slice.call(from));
};
var Editor = (
  /** @class */
  function() {
    function Editor2(config2, opts) {
      if (config2 === void 0) {
        config2 = {};
      }
      if (opts === void 0) {
        opts = {};
      }
      var _a2;
      this.html = html;
      this.config = editor_assign(editor_assign(editor_assign({}, config_config), config2), { pStylePrefix: (_a2 = config2.stylePrefix) !== null && _a2 !== void 0 ? _a2 : config_config.stylePrefix });
      this.em = new model_Editor(this.config);
      this.$ = opts.$;
      this.em.init(this);
      this.editor = this.em;
    }
    Object.defineProperty(Editor2.prototype, "Config", {
      get: function() {
        return this.em.config;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "I18n", {
      get: function() {
        return this.em.I18n;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Utils", {
      get: function() {
        return this.em.Utils;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Commands", {
      get: function() {
        return this.em.Commands;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Keymaps", {
      get: function() {
        return this.em.Keymaps;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Modal", {
      get: function() {
        return this.em.Modal;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Panels", {
      get: function() {
        return this.em.Panels;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Canvas", {
      get: function() {
        return this.em.Canvas;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Parser", {
      get: function() {
        return this.em.Parser;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "CodeManager", {
      get: function() {
        return this.em.CodeManager;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "UndoManager", {
      get: function() {
        return this.em.UndoManager;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "RichTextEditor", {
      get: function() {
        return this.em.RichTextEditor;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Pages", {
      get: function() {
        return this.em.Pages;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Components", {
      get: function() {
        return this.em.Components;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "DomComponents", {
      get: function() {
        return this.em.Components;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Layers", {
      get: function() {
        return this.em.Layers;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "LayerManager", {
      get: function() {
        return this.em.Layers;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Css", {
      get: function() {
        return this.em.Css;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "CssComposer", {
      get: function() {
        return this.em.Css;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Storage", {
      get: function() {
        return this.em.Storage;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "StorageManager", {
      get: function() {
        return this.em.Storage;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Assets", {
      get: function() {
        return this.em.Assets;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "AssetManager", {
      get: function() {
        return this.em.Assets;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Blocks", {
      get: function() {
        return this.em.Blocks;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "BlockManager", {
      get: function() {
        return this.em.Blocks;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Traits", {
      get: function() {
        return this.em.Traits;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "TraitManager", {
      get: function() {
        return this.em.Traits;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Selectors", {
      get: function() {
        return this.em.Selectors;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "SelectorManager", {
      get: function() {
        return this.em.Selectors;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Styles", {
      get: function() {
        return this.em.Styles;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "StyleManager", {
      get: function() {
        return this.em.Styles;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "Devices", {
      get: function() {
        return this.em.Devices;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "DeviceManager", {
      get: function() {
        return this.em.Devices;
      },
      enumerable: false,
      configurable: true
    });
    Object.defineProperty(Editor2.prototype, "EditorModel", {
      get: function() {
        return this.em;
      },
      enumerable: false,
      configurable: true
    });
    Editor2.prototype.getConfig = function(prop) {
      return this.em.getConfig(prop);
    };
    Editor2.prototype.getHtml = function(opts) {
      return this.em.getHtml(opts);
    };
    Editor2.prototype.getCss = function(opts) {
      return this.em.getCss(opts);
    };
    Editor2.prototype.getJs = function(opts) {
      return this.em.getJs(opts);
    };
    Editor2.prototype.getComponents = function() {
      return this.Components.getComponents();
    };
    Editor2.prototype.getWrapper = function() {
      return this.Components.getWrapper();
    };
    Editor2.prototype.setComponents = function(components, opt) {
      if (opt === void 0) {
        opt = {};
      }
      this.em.setComponents(components, opt);
      return this;
    };
    Editor2.prototype.addComponents = function(components, opts) {
      return this.getWrapper().append(components, opts);
    };
    Editor2.prototype.getStyle = function() {
      return this.em.Css.getAll();
    };
    Editor2.prototype.setStyle = function(style, opt) {
      if (opt === void 0) {
        opt = {};
      }
      this.em.setStyle(style, opt);
      return this;
    };
    Editor2.prototype.addStyle = function(style, opts) {
      if (opts === void 0) {
        opts = {};
      }
      return this.em.addStyle(style, opts);
    };
    Editor2.prototype.getSelected = function() {
      return this.em.getSelected();
    };
    Editor2.prototype.getSelectedAll = function() {
      return this.em.getSelectedAll();
    };
    Editor2.prototype.getSelectedToStyle = function() {
      var selected = this.em.getSelected();
      if (selected) {
        return this.StyleManager.getModelToStyle(selected);
      }
    };
    Editor2.prototype.select = function(el, opts) {
      this.em.setSelected(el, opts);
      return this;
    };
    Editor2.prototype.selectAdd = function(el) {
      this.em.addSelected(el);
      return this;
    };
    Editor2.prototype.selectRemove = function(el) {
      this.em.removeSelected(el);
      return this;
    };
    Editor2.prototype.selectToggle = function(el) {
      this.em.toggleSelected(el);
      return this;
    };
    Editor2.prototype.getEditing = function() {
      return this.em.getEditing();
    };
    Editor2.prototype.setDevice = function(name) {
      this.em.set("device", name);
      return this;
    };
    Editor2.prototype.getDevice = function() {
      return this.em.get("device");
    };
    Editor2.prototype.runCommand = function(id, options) {
      if (options === void 0) {
        options = {};
      }
      return this.Commands.run(id, options);
    };
    Editor2.prototype.stopCommand = function(id, options) {
      if (options === void 0) {
        options = {};
      }
      return this.Commands.stop(id, options);
    };
    Editor2.prototype.store = function(options) {
      return editor_awaiter(this, void 0, void 0, function() {
        return editor_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              return [4, this.em.store(options)];
            case 1:
              return [2, _a2.sent()];
          }
        });
      });
    };
    Editor2.prototype.load = function(options_1) {
      return editor_awaiter(this, arguments, void 0, function(options, loadOptions) {
        if (loadOptions === void 0) {
          loadOptions = {};
        }
        return editor_generator(this, function(_a2) {
          switch (_a2.label) {
            case 0:
              return [4, this.em.load(options, loadOptions)];
            case 1:
              return [2, _a2.sent()];
          }
        });
      });
    };
    Editor2.prototype.getProjectData = function() {
      return this.em.storeData();
    };
    Editor2.prototype.loadProjectData = function(data) {
      return this.em.loadData(data);
    };
    Editor2.prototype.storeData = function() {
      return this.em.storeData();
    };
    Editor2.prototype.loadData = function(data) {
      return this.em.loadData(data);
    };
    Editor2.prototype.getContainer = function() {
      return this.config.el;
    };
    Editor2.prototype.getDirtyCount = function() {
      return this.em.getDirtyCount();
    };
    Editor2.prototype.clearDirtyCount = function() {
      return this.em.clearDirtyCount();
    };
    Editor2.prototype.refresh = function(opts) {
      this.em.refreshCanvas(opts);
    };
    Editor2.prototype.setCustomRte = function(obj) {
      this.RichTextEditor.customRte = obj;
    };
    Editor2.prototype.setCustomParserCss = function(parser2) {
      this.Parser.getConfig().parserCss = parser2;
      return this;
    };
    Editor2.prototype.setDragMode = function(value) {
      this.em.setDragMode(value);
      return this;
    };
    Editor2.prototype.log = function(msg, opts) {
      if (opts === void 0) {
        opts = {};
      }
      this.em.log(msg, opts);
      return this;
    };
    Editor2.prototype.t = function() {
      var _a2;
      var args = [];
      for (var _i = 0; _i < arguments.length; _i++) {
        args[_i] = arguments[_i];
      }
      return (_a2 = this.em).t.apply(_a2, args);
    };
    Editor2.prototype.on = function(event, callback) {
      this.em.on(event, callback);
      return this;
    };
    Editor2.prototype.once = function(event, callback) {
      this.em.once(event, callback);
      return this;
    };
    Editor2.prototype.off = function(event, callback) {
      this.em.off(event, callback);
      return this;
    };
    Editor2.prototype.trigger = function(event) {
      var args = [];
      for (var _i = 1; _i < arguments.length; _i++) {
        args[_i - 1] = arguments[_i];
      }
      this.em.trigger.apply(this.em, editor_spreadArray([event], args, true));
      return this;
    };
    Editor2.prototype.destroy = function() {
      if (!this.em)
        return;
      this.em.destroyAll();
      this.editorView = void 0;
    };
    Editor2.prototype.getEl = function() {
      var _a2;
      return (_a2 = this.editorView) === null || _a2 === void 0 ? void 0 : _a2.el;
    };
    Editor2.prototype.getModel = function() {
      return this.em;
    };
    Editor2.prototype.render = function() {
      var _a2;
      (_a2 = this.editorView) === null || _a2 === void 0 ? void 0 : _a2.remove();
      this.editorView = new view_EditorView(this.em);
      return this.editorView.render().el;
    };
    Editor2.prototype.onReady = function(clb) {
      this.em.get("ready") ? clb(this) : this.em.on("load", clb);
    };
    return Editor2;
  }()
);
var src_editor = Editor;
var getPluginById = function(pluginId, plugins2) {
  var result = plugins2.get(pluginId);
  if (!result) {
    var wplg = (0, mixins.getGlobal)()[pluginId];
    result = (wplg === null || wplg === void 0 ? void 0 : wplg.default) || wplg;
  }
  return result;
};
var getPlugin = function(plugin, plugins2) {
  return (0, index_all.isString)(plugin) ? getPluginById(plugin, plugins2) : (plugin === null || plugin === void 0 ? void 0 : plugin.default) || plugin;
};
var logPluginWarn = function(editor, plugin) {
  editor.getModel().logWarning("Plugin ".concat(plugin, " not found"), {
    context: "plugins",
    plugin
  });
};
var PluginManager = (
  /** @class */
  function() {
    function PluginManager2() {
      this.plugins = {};
    }
    PluginManager2.prototype.add = function(id, plugin) {
      var plg = this.get(id);
      if (plg) {
        return plg;
      }
      this.plugins[id] = plugin;
      return plugin;
    };
    PluginManager2.prototype.get = function(id) {
      return this.plugins[id];
    };
    PluginManager2.prototype.getAll = function() {
      return this.plugins;
    };
    return PluginManager2;
  }()
);
var plugin_manager = PluginManager;
var polyfills = function() {
  var isIE = function() {
    var match;
    var agent = window.navigator.userAgent;
    var rules = [
      ["edge", /Edge\/([0-9\._]+)/],
      ["ie", /MSIE\s(7\.0)/],
      ["ie", /MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],
      ["ie", /Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/]
    ];
    for (var i = 0; i < rules.length; i++) {
      var rule = rules[i];
      match = rule[1].exec(agent);
      if (match)
        break;
    }
    return !!match;
  };
  if ((0, mixins.hasWin)() && isIE()) {
    var originalCreateHTMLDocument_1 = DOMImplementation.prototype.createHTMLDocument;
    DOMImplementation.prototype.createHTMLDocument = function(title) {
      if (!title)
        title = "";
      return originalCreateHTMLDocument_1.apply(document.implementation, [title]);
    };
  }
};
var src_assign = function() {
  src_assign = Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];
      for (var p in s)
        if (Object.prototype.hasOwnProperty.call(s, p))
          t[p] = s[p];
    }
    return t;
  };
  return src_assign.apply(this, arguments);
};
polyfills();
var plugins = new plugin_manager();
var editors = [];
var usePlugin = function(plugin, opts) {
  var pluginResult = getPlugin(plugin, plugins);
  return function(editor) {
    if (pluginResult) {
      pluginResult(editor, opts || {});
    } else {
      logPluginWarn(editor, plugin);
    }
  };
};
var grapesjs = {
  $: cash_dom["default"],
  editors,
  plugins,
  usePlugin,
  // @ts-ignore Will be replaced on build
  version: "0.21.13",
  /**
   * Initialize the editor with passed options
   * @param {Object} config Configuration object
   * @param {string|HTMLElement} config.container Selector which indicates where render the editor
   * @param {Boolean} [config.autorender=true] If true, auto-render the content
   * @param {Array} [config.plugins=[]] Array of plugins to execute on start
   * @param {Object} [config.pluginsOpts={}] Custom options for plugins
   * @param {Boolean} [config.headless=false] Init headless editor
   * @return {Editor} Editor instance
   * @example
   * var editor = grapesjs.init({
   *   container: '#myeditor',
   *   components: '<article class="hello">Hello world</article>',
   *   style: '.hello{color: red}',
   * })
   */
  init: function(config2) {
    if (config2 === void 0) {
      config2 = {};
    }
    var headless = config2.headless;
    var els = config2.container;
    if (!els && !headless)
      throw new Error("'container' is required");
    var initConfig = src_assign(src_assign({ autorender: true, plugins: [], pluginsOpts: {} }, config2), { grapesjs: this, el: headless ? void 0 : (0, index_all.isElement)(els) ? els : document.querySelector(els) });
    var editor = new src_editor(initConfig, { $: cash_dom["default"] });
    var em = editor.getModel();
    initConfig.plugins.forEach(function(pluginId) {
      var plugin = getPlugin(pluginId, plugins);
      var plgOptions = initConfig.pluginsOpts[pluginId] || {};
      if (plugin) {
        plugin(editor, plgOptions);
      } else {
        logPluginWarn(editor, pluginId);
      }
    });
    em.loadOnStart();
    initConfig.autorender && !headless && editor.render();
    editors.push(editor);
    return editor;
  }
};
var src_0 = grapesjs;
var __webpack_exports__default = __webpack_exports__.Ay;
var __webpack_exports__grapesjs = __webpack_exports__.I0;
var __webpack_exports__usePlugin = __webpack_exports__.nu;
export {
  __webpack_exports__default as default,
  __webpack_exports__grapesjs as grapesjs,
  __webpack_exports__usePlugin as usePlugin
};
/*! Bundled license information:

grapesjs/dist/grapes.mjs:
  (*!
  * Backbone.Undo.js v0.2
  * 
  * Copyright (c)2013 Oliver Sartun
  * Released under the MIT License
  *
  * Documentation and full license available at
  * https://github.com/osartun/Backbone.Undo.js
  *)
*/
//# sourceMappingURL=grapesjs.js.map
